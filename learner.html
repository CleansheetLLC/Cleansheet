<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learner - Cleansheet Platform</title>
    <link rel="icon" type="image/png" href="assets/high-resolution-logo-files/white-on-transparent.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300&family=Questrial&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Shared Infrastructure -->
    <script src="shared/cleansheet-core.js"></script>
    <script src="shared/data-service.js"></script>
    <script src="shared/library-data.js"></script>

    <style>
        /* Cleansheet Design System */
        :root {
            --color-primary-blue: #0066CC;
            --color-accent-blue: #004C99;
            --color-highlight: #11304f;
            --color-dark: #1a1a1a;
            --color-neutral-text: #333333;
            --color-neutral-text-light: #666666;
            --color-neutral-text-muted: #999999;
            --color-neutral-background: #f5f5f7;
            --color-neutral-background-secondary: #f8f8f8;
            --color-neutral-border: #e5e5e7;
            --color-neutral-white: #ffffff;
            --font-family-ui: 'Questrial', sans-serif;
            --font-family-body: 'Barlow', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-body);
            background: var(--color-neutral-background);
            color: var(--color-neutral-text);
        }

        /* Header */
        .header {
            background: var(--color-dark);
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo img {
            height: 32px;
        }

        .logo h1 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            font-weight: 600;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--color-highlight);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: white;
            border-bottom: 1px solid var(--color-neutral-border);
            display: flex;
            padding: 0 24px;
        }

        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: transparent;
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-neutral-text-light);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: var(--color-neutral-text);
            background: var(--color-neutral-background);
        }

        .tab-btn.active {
            color: var(--color-highlight);
            border-bottom-color: var(--color-highlight);
        }

        .tab-btn i {
            font-size: 20px;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 68px);
        }

        .tab-content-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .tab-panel {
            display: none;
            width: 100%;
            height: 100%;
        }

        .tab-panel.active {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--color-neutral-border);
            overflow-y: auto;
            padding: 24px;
        }

        .sidebar h2 {
            font-family: var(--font-family-ui);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--color-dark);
        }

        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-neutral-border);
            border-radius: 6px;
            font-family: var(--font-family-body);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--color-primary-blue);
        }

        .filter-section {
            margin-bottom: 24px;
        }

        .filter-section h3 {
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-neutral-text-light);
            margin-bottom: 12px;
        }

        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .pill {
            padding: 6px 12px;
            border: 1px solid var(--color-neutral-border);
            border-radius: 16px;
            font-size: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pill:hover {
            border-color: var(--color-primary-blue);
            color: var(--color-primary-blue);
        }

        .pill.active {
            background: var(--color-highlight);
            border-color: var(--color-highlight);
            color: white;
        }

        .pill:hover {
            border-color: var(--color-highlight);
            color: var(--color-highlight);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .content-header {
            margin-bottom: 24px;
        }

        .content-header h2 {
            font-family: var(--font-family-ui);
            font-size: 24px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 8px;
        }

        .content-header p {
            font-size: 14px;
            color: var(--color-neutral-text-light);
        }

        /* Article Grid */
        .article-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .article-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--color-neutral-border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .article-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .article-card h3 {
            font-family: var(--font-family-ui);
            font-size: 18px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 8px;
        }

        .article-card .subtitle {
            font-size: 14px;
            color: var(--color-neutral-text-light);
            margin-bottom: 12px;
        }

        .article-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
            font-size: 12px;
            color: var(--color-neutral-text-muted);
        }

        .article-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .tag {
            padding: 4px 8px;
            background: var(--color-neutral-background);
            border-radius: 4px;
            font-size: 11px;
            color: var(--color-neutral-text);
        }

        .level-badge {
            padding: 4px 10px;
            background: var(--color-highlight);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--color-neutral-background);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-highlight);
            transition: width 0.3s;
        }

        /* Reading View */
        .reading-view {
            display: none;
            background: white;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .reading-view.active {
            display: block;
        }

        .reading-header {
            margin-bottom: 32px;
        }

        .reading-header h1 {
            font-family: var(--font-family-ui);
            font-size: 32px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 12px;
        }

        .reading-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-accent-blue);
        }

        .btn-secondary {
            background: white;
            color: var(--color-highlight);
            border: 1px solid var(--color-highlight);
        }

        .btn-secondary:hover {
            background: var(--color-highlight);
            color: white;
        }

        .reading-content {
            font-size: 16px;
            line-height: 1.8;
            color: var(--color-neutral-text);
        }

        .reading-content h2 {
            font-family: var(--font-family-ui);
            font-size: 24px;
            font-weight: 600;
            margin: 32px 0 16px 0;
        }

        .reading-content p {
            margin-bottom: 16px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 64px;
            color: var(--color-neutral-text-muted);
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            font-weight: 600;
            color: var(--color-neutral-text);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            color: var(--color-neutral-text-light);
        }

        /* Spinner animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Corpus content styling - preserve article styles */
        .corpus-content {
            line-height: 1.6;
        }

        .corpus-content h2 {
            font-family: var(--font-family-ui);
            color: var(--color-primary-blue);
            font-size: 24px;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .corpus-content h3 {
            font-family: var(--font-family-ui);
            color: var(--color-accent-blue);
            font-size: 20px;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        .corpus-content h4 {
            font-family: var(--font-family-ui);
            color: var(--color-neutral-text);
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .corpus-content p {
            margin-bottom: 15px;
        }

        .corpus-content ul, .corpus-content ol {
            margin-bottom: 15px;
            padding-left: 25px;
        }

        .corpus-content li {
            margin-bottom: 8px;
        }

        .corpus-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: var(--font-family-mono);
            font-size: 14px;
        }

        .corpus-content pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 20px 0;
        }

        .corpus-content pre code {
            background: none;
            padding: 0;
            color: #f8f8f2;
        }

        .corpus-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .corpus-content th, .corpus-content td {
            padding: 12px;
            border: 1px solid var(--color-neutral-border);
            text-align: left;
        }

        .corpus-content th {
            background: var(--color-neutral-background);
            font-weight: 600;
        }

        .corpus-content blockquote {
            border-left: 4px solid var(--color-primary-blue);
            padding-left: 20px;
            margin: 20px 0;
            color: var(--color-neutral-text-light);
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .article-grid {
                grid-template-columns: 1fr;
            }

            .reading-view {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <img src="assets/high-resolution-logo-files/white-on-transparent.png" alt="Cleansheet">
            <h1>Cleansheet Learner</h1>
        </div>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar">AM</div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('home')">
                <i class="ph ph-house"></i>
                Home
            </button>
            <button class="tab-btn" onclick="switchTab('library')">
                <i class="ph ph-books"></i>
                Library
            </button>
        </nav>

        <!-- Tab Content Container -->
        <div class="tab-content-container">
            <!-- Home Tab Panel -->
            <div id="homePanel" class="tab-panel active">
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 40px;">
                    <i class="ph ph-house" style="font-size: 64px; color: var(--color-neutral-text-muted); margin-bottom: 16px;"></i>
                    <h2 style="font-family: var(--font-family-ui); font-size: 24px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Welcome to Cleansheet Learner</h2>
                    <p style="font-size: 14px; color: var(--color-neutral-text-light); max-width: 500px; text-align: center;">
                        Your personalized learning dashboard. Explore the Library to access 189 curated technical articles.
                    </p>
                </div>
            </div>

            <!-- Library Tab Panel -->
            <div id="libraryPanel" class="tab-panel">
                <!-- Sidebar -->
                <aside class="sidebar">
            <h2>Library</h2>
            <input type="text" class="search-box" id="searchInput" placeholder="Search articles...">

            <div class="filter-section">
                <h3>Expertise Level</h3>
                <div class="filter-pills" id="levelFilters">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="filter-section">
                <h3>Topics</h3>
                <div class="filter-pills" id="tagFilters">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="filter-section">
                <h3>Career Paths</h3>
                <div class="filter-pills" id="pathFilters">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="content-area">
            <!-- Library View -->
            <div id="libraryView">
                <div class="content-header">
                    <h2>Learning Library</h2>
                    <p id="librarySubtitle">Curated technical content to support your career development</p>
                </div>

                <div class="article-grid" id="articleGrid">
                    <!-- Articles populated by JavaScript -->
                </div>
            </div>

            <!-- Reading View -->
            <div class="reading-view" id="readingView">
                <div class="reading-header">
                    <h1 id="articleTitle"></h1>
                    <p class="subtitle" id="articleSubtitle"></p>
                    <div class="reading-actions">
                        <button class="btn btn-secondary" onclick="closeArticle()">
                            <i class="ph ph-arrow-left"></i>
                            Back to Library
                        </button>
                        <button class="btn btn-secondary" id="bookmarkBtn" onclick="toggleBookmark()">
                            <i class="ph ph-bookmark"></i>
                            Bookmark
                        </button>
                    </div>
                </div>
                <div class="reading-content" id="articleContent">
                    <!-- Article content loaded here -->
                </div>
            </div>
        </main>
            </div>
        </div>
    </div>

    <script>
        // Tab switching function
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.tab-btn').classList.add('active');

            // Update tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            if (tabName === 'home') {
                document.getElementById('homePanel').classList.add('active');
            } else if (tabName === 'library') {
                document.getElementById('libraryPanel').classList.add('active');
            }
        }
    </script>

    <script>
        // Initialize data service
        const dataService = new DataService('localStorage');
        let currentArticleId = null;
        let selectedLevel = null;
        let selectedTags = [];
        let selectedPath = null;
        let searchQuery = '';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize filters
            initializeFilters();

            // Load articles
            await loadArticles();

            // Setup search
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', CleansheetCore.utils.debounce(async (e) => {
                searchQuery = e.target.value;
                await loadArticles();
            }, 300));
        });

        function initializeFilters() {
            // Level filters
            const levelFilters = document.getElementById('levelFilters');
            CleansheetCore.expertiseLevels.forEach(level => {
                const pill = document.createElement('div');
                pill.className = 'pill';
                pill.textContent = level;
                pill.onclick = () => toggleLevel(level, pill);
                levelFilters.appendChild(pill);
            });

            // Tag filters
            const tagFilters = document.getElementById('tagFilters');
            CleansheetCore.tags.slice(0, 8).forEach(tag => {
                const pill = document.createElement('div');
                pill.className = 'pill';
                pill.textContent = tag;
                pill.onclick = () => toggleTag(tag, pill);
                tagFilters.appendChild(pill);
            });

            // Path filters
            const pathFilters = document.getElementById('pathFilters');
            CleansheetCore.careerPaths.slice(0, 6).forEach(path => {
                const pill = document.createElement('div');
                pill.className = 'pill';
                pill.textContent = path;
                pill.onclick = () => togglePath(path, pill);
                pathFilters.appendChild(pill);
            });
        }

        function toggleLevel(level, element) {
            if (selectedLevel === level) {
                selectedLevel = null;
                element.classList.remove('active');
            } else {
                document.querySelectorAll('#levelFilters .pill').forEach(p => p.classList.remove('active'));
                selectedLevel = level;
                element.classList.add('active');
            }
            loadArticles();
        }

        function toggleTag(tag, element) {
            if (selectedTags.includes(tag)) {
                selectedTags = selectedTags.filter(t => t !== tag);
                element.classList.remove('active');
            } else {
                selectedTags.push(tag);
                element.classList.add('active');
            }
            loadArticles();
        }

        function togglePath(path, element) {
            if (selectedPath === path) {
                selectedPath = null;
                element.classList.remove('active');
            } else {
                document.querySelectorAll('#pathFilters .pill').forEach(p => p.classList.remove('active'));
                selectedPath = path;
                element.classList.add('active');
            }
            loadArticles();
        }

        async function loadArticles() {
            const filters = {
                search: searchQuery,
                level: selectedLevel,
                tags: selectedTags,
                careerPath: selectedPath
            };

            const result = await dataService.getArticles(filters);
            const articleGrid = document.getElementById('articleGrid');

            // Update subtitle with article count
            const subtitle = document.getElementById('librarySubtitle');
            const filterCount = (selectedLevel ? 1 : 0) + selectedTags.length + (selectedPath ? 1 : 0);
            if (filterCount > 0 || searchQuery) {
                subtitle.textContent = `Showing ${result.articles.length} of 189 articles`;
            } else {
                subtitle.textContent = `189 curated technical articles`;
            }

            if (result.articles.length === 0) {
                articleGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="ph ph-books"></i>
                        <h3>No articles found</h3>
                        <p>Try adjusting your filters or search query</p>
                    </div>
                `;
                return;
            }

            articleGrid.innerHTML = result.articles.map(article => {
                const progress = 0; // TODO: Load actual progress
                const summary = article.executiveSummary || article.overviewSummary || article.subtitle || '';
                const readingTime = article.readingTime || CleansheetCore.utils.calculateReadingTime(article.content || '');
                const wordCount = article.wordCount || 0;

                return `
                    <div class="article-card" onclick="openArticle('${article.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <h3>${CleansheetCore.utils.sanitizeHTML(article.title)}</h3>
                            <span class="level-badge">${article.level || 'Operator'}</span>
                        </div>
                        <p class="subtitle">${CleansheetCore.utils.sanitizeHTML(CleansheetCore.utils.truncate(summary, 150))}</p>
                        <div class="article-tags">
                            ${(article.tags || []).slice(0, 3).map(tag => `<span class="tag">${CleansheetCore.utils.sanitizeHTML(tag)}</span>`).join('')}
                        </div>
                        ${progress > 0 ? `
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        ` : ''}
                        <div class="article-meta">
                            <span><i class="ph ph-clock"></i> ${readingTime} min read</span>
                            ${wordCount > 0 ? `
                                <span><i class="ph ph-text-align-left"></i> ${wordCount.toLocaleString()} words</span>
                            ` : ''}
                            ${article.careerPaths && article.careerPaths.length > 0 ? `
                                <span><i class="ph ph-path"></i> ${article.careerPaths[0]}</span>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function openArticle(articleId) {
            currentArticleId = articleId;
            const article = await dataService.getArticle(articleId);

            if (!article) {
                CleansheetCore.utils.showToast('Article not found', 'error');
                return;
            }

            document.getElementById('articleTitle').textContent = article.title;
            document.getElementById('articleSubtitle').textContent = article.subtitle || '';

            // Build article content
            let contentHtml = '';

            // Article metadata
            const readingTime = article.readingTime || CleansheetCore.utils.calculateReadingTime(article.content || '');
            const wordCount = article.wordCount || 0;
            const publishDate = article.publishDate ? CleansheetCore.utils.formatDate(article.publishDate) : null;

            contentHtml += `
                <div style="display: flex; gap: 20px; padding: 16px 0; border-bottom: 1px solid var(--color-neutral-border); margin-bottom: 24px; font-size: 14px; color: var(--color-neutral-text-light); flex-wrap: wrap;">
                    <span><i class="ph ph-clock"></i> ${readingTime} min read</span>
                    ${wordCount > 0 ? `<span><i class="ph ph-text-align-left"></i> ${wordCount.toLocaleString()} words</span>` : ''}
                    <span><i class="ph ph-graduation-cap"></i> ${article.level || 'Operator'}</span>
                    ${publishDate ? `<span><i class="ph ph-calendar"></i> ${publishDate}</span>` : ''}
                </div>
            `;

            // Check if corpus file exists and embed full article
            if (article.fileKey && article.corpusFileExists !== false) {
                // Use iframe to embed the full corpus article (avoids CORS issues with file:// protocol)
                contentHtml += `
                    <iframe
                        src="corpus/${article.fileKey}"
                        style="width: 100%; border: none; min-height: 2000px; background: white;"
                        onload="this.style.height = (this.contentWindow.document.body.scrollHeight + 40) + 'px';"
                        title="${CleansheetCore.utils.sanitizeHTML(article.title)}">
                    </iframe>
                `;

                // Add metadata footer
                contentHtml += `<div style="margin-top: 48px; padding-top: 24px; border-top: 1px solid var(--color-neutral-border);">`;

                if (article.tags && article.tags.length > 0) {
                    contentHtml += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 14px; text-transform: uppercase; color: var(--color-neutral-text-muted); margin-bottom: 12px;">Topics</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${article.tags.map(tag => `<span class="tag">${CleansheetCore.utils.sanitizeHTML(tag)}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                if (article.keywords && article.keywords.length > 0) {
                    contentHtml += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 14px; text-transform: uppercase; color: var(--color-neutral-text-muted); margin-bottom: 12px;">Keywords</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${article.keywords.map(kw => `<span class="tag" style="background: #f0f0f0; color: #666;">${CleansheetCore.utils.sanitizeHTML(kw)}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                if (article.careerPaths && article.careerPaths.length > 0) {
                    contentHtml += `
                        <div>
                            <h3 style="font-size: 14px; text-transform: uppercase; color: var(--color-neutral-text-muted); margin-bottom: 12px;">Relevant Career Paths</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${article.careerPaths.map(path => `<span class="tag">${CleansheetCore.utils.sanitizeHTML(path)}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                contentHtml += `</div>`;

                document.getElementById('articleContent').innerHTML = contentHtml;
                document.getElementById('libraryView').style.display = 'none';
                document.getElementById('readingView').classList.add('active');
            } else {
                // No corpus file, show summary content
                if (article.executiveSummary) {
                    contentHtml += `
                        <div style="margin-bottom: 32px;">
                            <h2 style="color: var(--color-highlight); margin-bottom: 16px;">Summary</h2>
                            <p style="line-height: 1.8;">${article.executiveSummary}</p>
                        </div>
                    `;
                }

                if (article.detailedSummary) {
                    contentHtml += `
                        <div style="margin-bottom: 32px;">
                            <h2 style="color: var(--color-primary-blue); margin-bottom: 16px;">Overview</h2>
                            <p style="line-height: 1.8;">${article.detailedSummary}</p>
                        </div>
                    `;
                }

                document.getElementById('articleContent').innerHTML = contentHtml || '<p>Content not available.</p>';
                document.getElementById('libraryView').style.display = 'none';
                document.getElementById('readingView').classList.add('active');
            }

            // Update bookmark button
            const bookmarks = await dataService.getBookmarks();
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            if (bookmarks.includes(articleId)) {
                bookmarkBtn.innerHTML = '<i class="ph-fill ph-bookmark"></i> Bookmarked';
            } else {
                bookmarkBtn.innerHTML = '<i class="ph ph-bookmark"></i> Bookmark';
            }
        }

        function closeArticle() {
            document.getElementById('libraryView').style.display = 'block';
            document.getElementById('readingView').classList.remove('active');
            currentArticleId = null;
        }

        async function toggleBookmark() {
            if (!currentArticleId) return;

            const bookmarks = await dataService.getBookmarks();
            const isBookmarked = bookmarks.includes(currentArticleId);

            if (isBookmarked) {
                await dataService.unbookmarkArticle(currentArticleId);
                document.getElementById('bookmarkBtn').innerHTML = '<i class="ph ph-bookmark"></i> Bookmark';
                CleansheetCore.utils.showToast('Bookmark removed', 'info');
            } else {
                await dataService.bookmarkArticle(currentArticleId);
                document.getElementById('bookmarkBtn').innerHTML = '<i class="ph-fill ph-bookmark"></i> Bookmarked';
                CleansheetCore.utils.showToast('Article bookmarked', 'success');
            }
        }
    </script>
</body>
</html>
