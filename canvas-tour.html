<!DOCTYPE html>
<html lang="en">
<head>
<!-- Azure Application Insights -->
<script type="text/javascript">
!function(T,l,y){var S=T.location,k="script",D="instrumentationKey",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w="crossOrigin",N="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"5",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,u,p,l;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][b]()]=i[1])}if(!e[C]){var r=e.endpointsuffix,o=r?e.location:null;e[C]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[D]||d[D]||"",u=s[C],p=u?u+"/v2/track":d.endpointUrl,(l=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=p,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),l.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,p)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:N,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(N,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(l,p))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(k);n.src=h;var e=y[w];return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(k)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[I]&&!0!==s[I]){var c="onerror";t(["_"+c]);var u=T[c];T[c]=function(e,t,n,a,i){var r=u&&u(e,t,n,a,i);return!0!==r&&m["_"+c]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);function a(){y.onInit&&y.onInit(n)}(T[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js",
crossOrigin: "anonymous",
cfg: {
connectionString: "InstrumentationKey=104926d6-679a-4baa-919e-665bea6facac;IngestionEndpoint=https://eastus-8.in.applicationinsights.azure.com/;LiveEndpoint=https://eastus.livediagnostics.monitor.azure.com/;ApplicationId=2e7de093-fa39-4859-a48b-515db3520828"
}
});
</script>
<!-- End Application Insights -->

<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleansheet Canvas Tour</title>
    <link rel="icon" type="image/png" href="assets/high-resolution-logo-files/white-on-transparent.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300&family=Questrial&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Mermaid.js for Diagram Rendering -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });
        window.mermaid = mermaid;
    </script>

    <!-- KaTeX for LaTeX Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>

    <!-- Driver.js for UI Tour -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css">
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.iife.js"></script>

    <style>
        /* Cleansheet Design System - Corporate Professional */
        :root {
            /* Brand Colors */
            --color-primary-blue: #0066CC;
            --color-accent-blue: #004C99;
            --color-dark: #1a1a1a;

            /* Neutral Colors */
            --color-neutral-text: #333333;
            --color-neutral-text-light: #666666;
            --color-neutral-text-muted: #999999;
            --color-neutral-background: #f5f5f7;
            --color-neutral-background-secondary: #f8f8f8;
            --color-neutral-border: #e5e5e7;
            --color-neutral-white: #ffffff;

            /* Typography */
            --font-family-ui: 'Questrial', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-family-body: 'Barlow', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-size-h1: clamp(28px, 4vw, 32px);
            --font-size-h2: clamp(24px, 3.5vw, 36px);
            --font-size-h3: clamp(18px, 3vw, 24px);
            --font-size-body: clamp(14px, 2.5vw, 16px);
            --font-size-small: clamp(12px, 2.2vw, 14px);

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-xxl: 24px;
            --spacing-xxxl: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-body);
            font-weight: 300;
            background: var(--color-neutral-background);
            color: var(--color-neutral-text);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-family-ui);
        }

        /* Canvas Full Window */
        .canvas-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
        }

        .canvas-modal.active {
            display: flex;
        }

        .canvas-modal-content {
            background: white;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .canvas-modal-header {
            padding: 24px 32px;
            border-bottom: 2px solid var(--color-neutral-border);
            background: var(--color-dark);
        }

        .canvas-modal-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 16px;
            margin-bottom: 0;
            gap: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .canvas-modal-header h2 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            color: white;
            margin: 0;
            white-space: nowrap;
        }

        /* Main Menu */
        .main-menu {
            display: flex;
            gap: 4px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .main-menu-item {
            padding: 8px 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .main-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .main-menu-item.active {
            background: rgba(0, 102, 204, 0.3);
            color: white;
        }

        .main-menu-item i {
            font-size: 16px;
        }

        /* Profile Circle */
        .profile-circle {
            position: relative;
            display: inline-block;
        }

        .profile-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 102, 204, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: var(--font-family-ui);
            font-size: 16px;
            font-weight: 400;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            user-select: none;
        }

        .profile-avatar:hover {
            background: rgba(0, 102, 204, 0.4);
        }

        .profile-dropdown {
            position: absolute;
            top: 52px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
        }

        .profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown-header {
            padding: 16px;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .profile-dropdown-name {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
        }

        .profile-dropdown-role {
            font-family: var(--font-family-body);
            font-size: 12px;
            color: var(--color-neutral-text-light);
            margin: 0;
        }

        .profile-dropdown-menu {
            padding: 8px 0;
        }

        .profile-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            color: var(--color-neutral-text);
            cursor: pointer;
            transition: all 0.15s;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
        }

        .profile-dropdown-item:hover {
            background: var(--color-neutral-background);
        }

        .profile-dropdown-item i {
            font-size: 18px;
            color: var(--color-primary-blue);
        }

        .canvas-modal-body {
            flex: 1;
            padding: 24px;
            overflow: hidden;
            background: var(--color-neutral-background);
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
            transition: grid-template-columns 0.3s ease;
            min-height: 0;
            position: relative;
        }

        .canvas-modal-body.collapsed {
            grid-template-columns: 0px 1fr;
            gap: 0;
        }

        #canvas-mindmap {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: auto;
            position: relative;
        }

        #canvas-mindmap svg {
            display: block;
            min-width: 100%;
            min-height: 100%;
        }

        .canvas-right-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            overflow-x: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .canvas-modal-body.collapsed .canvas-right-panel {
            opacity: 0;
            transform: translateX(-20px);
            pointer-events: none;
        }

        .panel-collapse-toggle {
            position: absolute;
            top: 50%;
            left: 374px;
            transform: translateY(-50%);
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 0 8px 8px 0;
            padding: 12px 8px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            color: var(--color-dark);
            font-size: 20px;
            display: flex;
            align-items: center;
        }

        .canvas-modal-body.collapsed .panel-collapse-toggle {
            left: 0;
        }

        .panel-collapse-toggle:hover {
            background: var(--color-primary-blue);
            color: white;
            border-color: var(--color-primary-blue);
        }

        .calendar-widget, .ai-assistant-widget {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-widget {
            flex-shrink: 0;
            max-height: 280px;
        }

        .ai-assistant-widget {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 450px;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-neutral-border);
        }

        .widget-header h3 {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .widget-header h3 i {
            font-size: 18px;
        }

        .sync-btn {
            padding: 6px 12px;
            background: white;
            border: 2px solid var(--color-primary-blue);
            color: var(--color-primary-blue);
            font-family: var(--font-family-ui);
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-btn:hover {
            background: var(--color-primary-blue);
            color: white;
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .calendar-event {
            padding: 10px 12px;
            background: var(--color-neutral-background);
            border-radius: 6px;
            border-left: 3px solid var(--color-primary-blue);
        }

        .event-time {
            font-size: 10px;
            font-weight: 600;
            color: var(--color-primary-blue);
            margin-bottom: 3px;
        }

        .event-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 2px;
        }

        .event-details {
            font-size: 10px;
            color: var(--color-neutral-text-light);
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-message {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
        }

        .ai-message.assistant {
            background: var(--color-neutral-background);
            color: var(--color-dark);
            align-self: flex-start;
            max-width: 85%;
        }

        .ai-message.user {
            background: var(--color-primary-blue);
            color: white;
            align-self: flex-end;
            max-width: 85%;
        }

        .ai-input-area {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--color-neutral-border);
        }

        .ai-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid var(--color-neutral-border);
            border-radius: 8px;
            font-family: var(--font-family-body);
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .ai-input:focus {
            border-color: var(--color-primary-blue);
        }

        .ai-send-btn {
            padding: 10px 16px;
            background: var(--color-primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-send-btn:hover {
            background: var(--color-accent-blue);
        }

        /* Interview Prep Slideout (60% width) - Inside Canvas Modal */
        .interview-slideout {
            position: absolute;
            top: 0;
            right: -60%;
            width: 60%;
            height: 100%;
            background: white;
            box-shadow: -4px 0 16px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: right 0.4s ease;
            display: flex;
            flex-direction: column;
        }

        .interview-slideout.active {
            right: 0;
        }

        /* Canvas modal needs to be position relative for slideout */
        .canvas-modal-content {
            position: relative;
            overflow: hidden;
        }

        .slideout-header {
            padding: 24px;
            background: var(--color-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .slideout-header h2 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            margin: 0;
        }

        .slideout-close {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .slideout-close:hover {
            opacity: 0.7;
        }

        .slideout-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--color-neutral-background);
            display: flex;
            flex-direction: column;
        }

        .add-story-btn {
            padding: 8px 16px;
            background: var(--color-primary-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 16px;
        }

        .add-story-btn:hover {
            background: var(--color-accent-blue);
            box-shadow: 0 2px 8px rgba(0,102,204,0.3);
        }

        .calendar-view-btn {
            padding: 8px 16px;
            background: white;
            color: var(--color-neutral-text);
            border: 1px solid var(--color-neutral-border);
            border-radius: 6px;
            font-family: var(--font-family-heading);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-view-btn.active {
            background: var(--color-primary-blue);
            color: white;
            border-color: var(--color-primary-blue);
        }

        .calendar-view-btn:hover:not(.active) {
            background: var(--color-neutral-background-secondary);
            border-color: var(--color-primary-blue);
        }

        .calendar-view-btn-green.active {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }

        .calendar-view-btn-green:hover:not(.active) {
            background: var(--color-neutral-background-secondary);
            border-color: #16a34a;
        }

        .linkedin-connect-btn {
            padding: 8px 16px;
            background: #0077B5;
            color: white;
            border: none;
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .linkedin-connect-btn:hover {
            background: #005E93;
            box-shadow: 0 2px 8px rgba(0,119,181,0.3);
        }

        .upload-resume-btn {
            padding: 8px 16px;
            background: var(--color-accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .upload-resume-btn:hover {
            background: var(--color-dark);
            box-shadow: 0 2px 8px rgba(0,70,153,0.3);
        }

        .data-source-btn {
            padding: 12px 16px;
            background: white;
            color: var(--color-dark);
            border: 2px solid var(--color-neutral-border);
            border-radius: 8px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .data-source-btn:hover {
            border-color: var(--color-primary-blue);
            background: var(--color-neutral-background);
            color: var(--color-primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 102, 204, 0.15);
        }

        .data-source-btn i {
            font-size: 18px;
        }

        /* Export Menu Styles */
        #exportMenu button:hover {
            background: var(--color-neutral-background) !important;
        }

        #exportMenu button:first-child {
            border-radius: 8px 8px 0 0;
        }

        #exportMenu button:last-child {
            border-radius: 0 0 8px 8px;
        }

        .stories-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .story-card {
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 8px;
            padding: 14px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .story-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .story-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .story-title {
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .story-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .story-action-btn {
            background: none;
            border: none;
            color: var(--color-primary-blue);
            font-size: 16px;
            cursor: pointer;
            padding: 2px;
            transition: all 0.2s;
        }

        .story-action-btn:hover {
            color: var(--color-accent-blue);
            transform: scale(1.1);
        }

        .block-btn:hover {
            background: #e3f2fd !important;
            border-color: var(--color-primary-blue) !important;
        }

        .story-action-btn.delete:hover {
            color: #dc3545;
        }

        /* Quill Editor Styles */
        #quillEditor .ql-container {
            flex: 1;
            overflow-y: auto;
            font-family: var(--font-family-body);
            font-size: 14px;
            line-height: 1.8;
        }

        #quillEditor .ql-editor {
            padding: 40px;
            min-height: 100%;
        }

        #quillEditor .ql-toolbar {
            border-top: none;
            border-left: none;
            border-right: none;
            border-bottom: 1px solid var(--color-neutral-border);
            background: var(--color-neutral-background-secondary);
            padding: 12px;
        }

        #quillEditor .ql-editor h1,
        #quillEditor .ql-editor h2,
        #quillEditor .ql-editor h3,
        #quillEditor .ql-editor h4 {
            font-family: var(--font-family-ui);
            font-weight: 600;
            color: var(--color-dark);
            margin-top: 24px;
            margin-bottom: 12px;
        }

        #quillEditor .ql-editor h1 {
            font-size: 32px;
        }

        #quillEditor .ql-editor h2 {
            font-size: 26px;
        }

        #quillEditor .ql-editor h3 {
            font-size: 20px;
        }

        #quillEditor .ql-editor h4 {
            font-size: 16px;
        }

        #quillEditor .ql-editor p {
            margin-bottom: 12px;
            color: var(--color-neutral-text);
        }

        .story-experience {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            margin-bottom: 8px;
            font-style: italic;
            line-height: 1.3;
        }

        .story-section {
            margin-bottom: 8px;
        }

        .story-section-label {
            font-family: var(--font-family-ui);
            font-size: 10px;
            font-weight: 600;
            color: var(--color-primary-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .story-section-text {
            font-family: var(--font-family-body);
            font-size: 12px;
            line-height: 1.4;
            color: var(--color-neutral-text);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .story-competencies {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .competency-tag {
            background: #e3f2fd;
            color: #1a1a1a;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Story Form Modal - Inside Slideout */
        .story-form-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .story-form-modal.active {
            display: flex;
        }

        .story-form-content {
            width: 100%;
            max-width: 500px;
            max-height: calc(100% - 40px);
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .story-form-header {
            padding: 14px 18px;
            background: var(--color-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .story-form-header h3 {
            font-family: var(--font-family-ui);
            font-size: 15px;
            margin: 0;
        }

        .story-form-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .story-form-close:hover {
            opacity: 0.7;
        }

        .story-form-body {
            flex: 1;
            overflow-y: auto;
            padding: 18px;
            min-height: 0;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-family: var(--font-family-ui);
            font-size: 11px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--color-neutral-border);
            border-radius: 4px;
            font-family: var(--font-family-body);
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--color-primary-blue);
        }

        .form-group small {
            display: block;
            margin-top: 3px;
            font-size: 10px;
            color: var(--color-neutral-text-light);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px;
            padding-top: 14px;
            border-top: 1px solid var(--color-neutral-border);
            flex-shrink: 0;
        }

        .btn-cancel,
        .btn-save {
            padding: 8px 18px;
            border: none;
            border-radius: 4px;
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel {
            background: var(--color-neutral-background);
            color: var(--color-neutral-text);
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .btn-save {
            background: var(--color-primary-blue);
            color: white;
        }

        .btn-save:hover {
            background: var(--color-accent-blue);
        }

        /* Pipeline Management Modal */
        .pipeline-mgmt-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .pipeline-mgmt-modal.active {
            display: flex;
        }

        .pipeline-mgmt-content {
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .pipeline-mgmt-header {
            padding: 16px 24px;
            background: var(--color-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .pipeline-mgmt-header h3 {
            font-family: var(--font-family-ui);
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .pipeline-mgmt-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            border-radius: 6px;
        }

        .pipeline-mgmt-close:hover {
            opacity: 0.7;
            background: rgba(255, 255, 255, 0.1);
        }

        .pipeline-mgmt-body {
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        /* Pipeline Wizard Modal */
        .pipeline-wizard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .pipeline-wizard-modal.active {
            display: flex;
        }

        .pipeline-wizard-content {
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .pipeline-wizard-header {
            padding: 20px 24px;
            background: var(--color-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .pipeline-wizard-header h3 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .pipeline-wizard-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            border-radius: 6px;
        }

        .pipeline-wizard-close:hover {
            opacity: 0.7;
            background: rgba(255, 255, 255, 0.1);
        }

        .wizard-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px 24px 16px 24px;
            background: white;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-neutral-background);
            border: 2px solid var(--color-neutral-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-family-ui);
            font-size: 16px;
            font-weight: 600;
            color: var(--color-neutral-text);
            transition: all 0.3s;
        }

        .wizard-step.active .step-number {
            background: var(--color-primary-blue);
            border-color: var(--color-primary-blue);
            color: white;
        }

        .wizard-step.completed .step-number {
            background: var(--color-primary-blue);
            border-color: var(--color-primary-blue);
            color: white;
        }

        .step-label {
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            color: var(--color-neutral-text);
            transition: color 0.3s;
        }

        .wizard-step.active .step-label {
            color: var(--color-primary-blue);
        }

        .wizard-step-line {
            width: 60px;
            height: 2px;
            background: var(--color-neutral-border);
            margin: 0 8px 20px 8px;
        }

        .wizard-step.completed + .wizard-step-line {
            background: var(--color-primary-blue);
        }

        .pipeline-wizard-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px 24px;
            background: white;
            min-height: 0;
        }

        .wizard-step-content {
            display: none;
        }

        .wizard-step-content.active {
            display: block;
        }

        .pipeline-wizard-footer {
            padding: 16px 24px;
            background: var(--color-neutral-background);
            border-top: 1px solid var(--color-neutral-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .source-option:hover {
            border-color: var(--color-primary-blue);
            background: var(--color-neutral-background);
        }

        .source-option.selected {
            border-color: var(--color-primary-blue);
            background: rgba(0, 102, 204, 0.05);
        }

        /* Simple Pipeline Wizard Modal */
        .simple-pipeline-wizard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .simple-pipeline-wizard-modal.active {
            display: flex;
        }

        .simple-pipeline-wizard-content {
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            background: white;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .simple-pipeline-wizard-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--color-primary-blue) 0%, var(--color-accent-blue) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .simple-pipeline-wizard-header h3 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .simple-pipeline-wizard-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            border-radius: 6px;
        }

        .simple-pipeline-wizard-close:hover {
            opacity: 0.7;
            background: rgba(255, 255, 255, 0.15);
        }

        .simple-wizard-progress {
            padding: 20px 24px 16px 24px;
            background: white;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .simple-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-neutral-background);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .simple-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary-blue) 0%, var(--color-accent-blue) 100%);
            border-radius: 4px;
            transition: width 0.4s ease;
            width: 25%;
        }

        .simple-progress-text {
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            color: var(--color-neutral-text);
            text-align: center;
        }

        .simple-pipeline-wizard-body {
            flex: 1;
            overflow-y: auto;
            padding: 40px 32px;
            background: white;
            min-height: 0;
        }

        .simple-wizard-step-content {
            display: none;
        }

        .simple-wizard-step-content.active {
            display: block !important;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideOutDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        .wizard-welcome {
            text-align: center;
            margin-bottom: 32px;
        }

        .template-card {
            padding: 20px;
            border: 2px solid var(--color-neutral-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .template-card:hover {
            border-color: var(--color-primary-blue);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.1);
            transform: translateY(-2px);
        }

        .template-card.selected {
            border-color: var(--color-primary-blue);
            background: rgba(0, 102, 204, 0.02);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
        }

        .template-card.selected .template-check {
            display: block !important;
        }

        .frequency-card {
            padding: 16px;
            border: 2px solid var(--color-neutral-border);
            border-radius: 10px;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }

        .frequency-option:hover .frequency-card {
            border-color: var(--color-primary-blue);
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
        }

        .frequency-option input:checked + .frequency-card {
            border-color: var(--color-primary-blue);
            background: rgba(0, 102, 204, 0.05);
        }

        .simple-source-card {
            position: relative;
            padding: 24px;
            border: 2px solid var(--color-neutral-border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .simple-source-card:hover {
            border-color: var(--color-primary-blue);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.1);
            transform: translateY(-2px);
        }

        .simple-source-card.selected {
            border-color: var(--color-primary-blue);
            background: rgba(0, 102, 204, 0.05);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
        }

        .simple-source-card.selected .simple-source-check {
            display: block !important;
        }

        .simple-pipeline-wizard-footer {
            padding: 16px 24px;
            background: var(--color-neutral-background);
            border-top: 1px solid var(--color-neutral-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #simplePipelineName:focus {
            outline: none;
            border-color: var(--color-primary-blue);
        }

        /* Technical Prep Tabs */
        .tech-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--color-neutral-border);
            margin-bottom: 20px;
        }

        .tech-tab {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-neutral-text-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tech-tab:hover {
            color: var(--color-primary-blue);
            background: var(--color-neutral-background);
        }

        .tech-tab.active {
            color: var(--color-primary-blue);
            border-bottom-color: var(--color-primary-blue);
        }

        .tech-tab-content {
            display: none;
        }

        .tech-items-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* Job Opportunity Cards */
        .job-card {
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 8px;
            padding: 14px;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 4px solid var(--color-primary-blue);
        }

        .job-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .job-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .job-title {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .job-company {
            font-size: 12px;
            color: var(--color-primary-blue);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .job-location {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            margin-bottom: 8px;
        }

        .job-salary {
            font-size: 12px;
            color: var(--color-neutral-text);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .job-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .job-status.applied {
            background: #e3f2fd;
            color: #1976d2;
        }

        .job-status.interviewing {
            background: #fff3e0;
            color: #f57c00;
        }

        .job-status.offer {
            background: #e8f5e9;
            color: #388e3c;
        }

        .job-status.rejected {
            background: #ffebee;
            color: #d32f2f;
        }

        .job-status.interested {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .job-status.not-interested {
            background: #f5f5f5;
            color: #666666;
        }

        .job-details {
            font-size: 11px;
            color: var(--color-neutral-text);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Job View Toggle Buttons */
        .job-view-toggle {
            display: flex;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--color-neutral-border);
        }

        .view-toggle-btn {
            padding: 6px 12px;
            background: white;
            border: none;
            border-right: 1px solid var(--color-neutral-border);
            color: var(--color-neutral-text);
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .view-toggle-btn:last-child {
            border-right: none;
        }

        .view-toggle-btn:hover {
            background: var(--color-neutral-background);
        }

        .view-toggle-btn.active {
            background: var(--color-primary-blue);
            color: white;
        }

        /* Jobs Table */
        .jobs-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .jobs-table thead {
            background: var(--color-dark);
            color: white;
        }

        .jobs-table th {
            padding: 12px 16px;
            text-align: left;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .jobs-table th:last-child {
            border-right: none;
        }

        .jobs-table tbody tr {
            border-bottom: 1px solid var(--color-neutral-border);
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .jobs-table tbody tr:last-child {
            border-bottom: none;
        }

        .jobs-table tbody tr:hover {
            background: var(--color-neutral-background);
        }

        .jobs-table td {
            padding: 12px 16px;
            font-family: var(--font-family-body);
            font-size: 13px;
            vertical-align: top;
        }

        .job-table-position {
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 2px;
        }

        .job-table-location {
            font-size: 11px;
            color: var(--color-neutral-text-light);
        }

        .job-table-company {
            font-weight: 500;
            color: var(--color-dark);
        }

        .job-table-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .job-table-next-action {
            font-size: 12px;
            line-height: 1.3;
        }

        .job-table-next-action-task {
            font-weight: 500;
            color: var(--color-dark);
            margin-bottom: 2px;
        }

        .job-table-next-action-date {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .job-table-next-action-date.overdue {
            color: #dc2626;
            font-weight: 600;
        }

        .job-table-next-action-date.due-soon {
            color: #f59e0b;
            font-weight: 600;
        }

        .job-table-alerts {
            text-align: center;
        }

        .job-alert-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
        }

        .job-alert-indicator.overdue {
            background: #fef2f2;
            color: #dc2626;
            border: 2px solid #dc2626;
        }

        .job-alert-indicator.due-soon {
            background: #fffbeb;
            color: #f59e0b;
            border: 2px solid #f59e0b;
        }

        .job-alert-indicator.normal {
            background: #f0f9ff;
            color: #0369a1;
            border: 2px solid #e0e7ff;
        }

        .job-alert-indicator.none {
            background: var(--color-neutral-background);
            color: var(--color-neutral-text-muted);
            border: 2px solid var(--color-neutral-border);
        }

        /* Job Table Action Buttons */
        .job-table-action-btn:hover {
            background: var(--color-neutral-background) !important;
            color: var(--color-dark) !important;
        }

        .job-table-action-btn.delete:hover {
            background: #fef2f2 !important;
            color: #dc2626 !important;
        }

        /* Job Detail Modal */
        .job-detail-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .job-detail-modal.active {
            display: flex;
        }

        .job-detail-content {
            width: 100%;
            max-width: 700px;
            max-height: calc(100% - 40px);
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .job-detail-header {
            padding: 24px;
            background: var(--color-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .job-detail-header h3 {
            font-family: var(--font-family-ui);
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .job-detail-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .job-detail-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .job-detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--color-neutral-background);
        }

        .job-detail-section {
            margin-bottom: 24px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--color-neutral-border);
        }

        .job-detail-section h4 {
            font-family: var(--font-family-ui);
            font-size: 16px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .job-detail-section h4 i {
            font-size: 18px;
            color: var(--color-primary-blue);
        }

        .job-status-editor {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .job-status-select {
            padding: 8px 12px;
            border: 1px solid var(--color-neutral-border);
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .skills-competencies-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .skill-comp-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .skill-comp-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--color-neutral-background);
            border-radius: 6px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .skill-comp-item:hover {
            border-color: var(--color-primary-blue);
            background: #e3f2fd;
        }

        .fit-analysis-section {
            background: var(--color-neutral-background);
        }

        .fit-score {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 2px solid var(--color-primary-blue);
        }

        .fit-score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: var(--font-family-ui);
            font-size: 18px;
            font-weight: 600;
        }

        .fit-score-details h5 {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
        }

        .fit-score-details p {
            font-size: 12px;
            color: var(--color-neutral-text-light);
            margin: 0;
        }

        .fit-dimensions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fit-dimension {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--color-neutral-border);
        }

        .dimension-info {
            flex: 1;
        }

        .dimension-name {
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 2px 0;
        }

        .dimension-details {
            font-size: 11px;
            color: var(--color-neutral-text-light);
        }

        .dimension-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-bar {
            width: 80px;
            height: 6px;
            background: var(--color-neutral-border);
            border-radius: 3px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .score-text {
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            min-width: 35px;
            text-align: right;
        }

        /* Application Material Items */
        .app-material-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: var(--color-neutral-background);
            border-radius: 6px;
            border: 1px solid var(--color-neutral-border);
            transition: all 0.2s;
        }

        .app-material-item:hover {
            border-color: var(--color-primary-blue);
            background: #e3f2fd;
        }

        .app-material-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .app-material-icon.resume {
            background: #0066CC;
        }

        .app-material-icon.cover-letter {
            background: #004C99;
        }

        .app-material-icon.email {
            background: #1a1a1a;
        }

        .app-material-info {
            flex: 1;
            min-width: 0;
        }

        .app-material-title {
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .app-material-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .app-material-tag {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .app-material-tag.format {
            background: #f5f5f7;
            color: #666;
        }

        .app-material-tag.ats {
            background: #e8f5e9;
            color: #388e3c;
        }

        .app-material-tag.date {
            background: #fff3e0;
            color: #f57c00;
        }

        .app-material-preview {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .app-material-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .app-material-item:hover .app-material-actions {
            opacity: 1;
        }

        .app-material-action-btn {
            padding: 4px 8px;
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .app-material-action-btn:hover {
            border-color: var(--color-primary-blue);
            background: #e3f2fd;
        }

        .app-material-action-btn.delete:hover {
            border-color: #d32f2f;
            background: #ffebee;
            color: #d32f2f;
        }

        /* Job Todo Checklist Items */
        .job-todo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--color-neutral-border);
            transition: all 0.2s;
        }

        .job-todo-item:hover {
            border-color: var(--color-primary-blue);
            box-shadow: 0 2px 4px rgba(0, 102, 204, 0.1);
        }

        .job-todo-item.completed {
            background: #f8f9fa;
            opacity: 0.8;
        }

        .job-todo-item.completed .job-todo-text {
            text-decoration: line-through;
            color: var(--color-neutral-text-muted);
        }

        .job-todo-item.overdue {
            border-left: 4px solid #dc2626;
            background: #fef2f2;
        }

        .job-todo-item.due-soon {
            border-left: 4px solid #f59e0b;
            background: #fffbeb;
        }

        .job-todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-primary-blue);
        }

        .job-todo-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .job-todo-text {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 500;
            color: var(--color-dark);
            line-height: 1.3;
        }

        .job-todo-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--color-neutral-text-light);
        }

        .job-todo-due-date {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .job-todo-due-date.overdue {
            color: #dc2626;
        }

        .job-todo-due-date.due-soon {
            color: #f59e0b;
        }

        .job-todo-due-date.normal {
            color: var(--color-neutral-text);
        }

        .job-todo-priority {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .job-todo-priority.high {
            background: #fef2f2;
            color: #dc2626;
        }

        .job-todo-priority.medium {
            background: #fffbeb;
            color: #f59e0b;
        }

        .job-todo-priority.low {
            background: #f0f9ff;
            color: #0369a1;
        }

        .job-todo-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .job-todo-item:hover .job-todo-actions {
            opacity: 1;
        }

        .job-todo-action-btn {
            padding: 4px;
            background: none;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--color-neutral-text-light);
            transition: all 0.2s;
            font-size: 14px;
        }

        .job-todo-action-btn:hover {
            background: var(--color-neutral-background);
            color: var(--color-dark);
        }

        .job-todo-action-btn.delete:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Experience Card Styles */
        .experience-card {
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 8px;
            padding: 14px;
            transition: all 0.2s;
            border-left: 4px solid var(--color-accent-blue);
        }

        .experience-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .experience-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .exp-title {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .exp-company {
            font-size: 12px;
            color: var(--color-accent-blue);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .exp-dates {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            margin-bottom: 8px;
        }

        .exp-description {
            font-size: 12px;
            color: var(--color-neutral-text);
            line-height: 1.4;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .exp-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--color-neutral-border);
        }

        .exp-section-label {
            font-family: var(--font-family-ui);
            font-size: 10px;
            font-weight: 600;
            color: var(--color-neutral-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .exp-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .exp-tag {
            background: var(--color-neutral-background);
            color: var(--color-neutral-text);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            border: 1px solid var(--color-neutral-border);
        }

        .exp-tag.core {
            background: #e3f2fd;
            color: #1976d2;
            border-color: #1976d2;
        }

        .exp-tag.peripheral {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #7b1fa2;
        }

        .exp-list {
            margin: 0;
            padding-left: 20px;
        }

        .exp-list li {
            font-size: 12px;
            color: var(--color-neutral-text);
            line-height: 1.5;
            margin-bottom: 4px;
        }

        /* Mindmap Styles */
        .mindmap-node rect {
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.3s;
            rx: 8;
            ry: 8;
        }

        .mindmap-node.root rect {
            fill: var(--color-primary-blue);
            stroke: none;
        }

        .mindmap-node.child rect {
            fill: white;
            stroke: var(--color-primary-blue);
        }

        .mindmap-node.child rect.collapsed {
            stroke: var(--color-neutral-border);
            stroke-width: 2;
        }

        .mindmap-node.child rect.expanded {
            fill: #e3f2fd;
            stroke: var(--color-primary-blue);
            stroke-width: 3;
            filter: drop-shadow(0 2px 8px rgba(0, 102, 204, 0.3));
        }

        .mindmap-node.grandchild rect {
            fill: #f5f5f7;
            stroke: #bdbdbd;
            stroke-width: 2;
        }

        .mindmap-node.root text {
            fill: white;
            font-size: 16px;
            font-weight: 600;
        }

        .mindmap-node.child text {
            fill: var(--color-dark);
            font-size: 14px;
            font-weight: 500;
        }

        .mindmap-node.grandchild text {
            fill: var(--color-neutral-text);
            font-size: 12px;
            font-weight: 400;
        }

        .mindmap-node text {
            font-family: var(--font-family-ui);
            text-anchor: middle;
            pointer-events: none;
        }

        .mindmap-node.child:hover rect {
            filter: drop-shadow(0 4px 12px rgba(0, 102, 204, 0.4));
            transform: scale(1.05);
        }

        .mindmap-node.root:hover rect {
            filter: drop-shadow(0 4px 12px rgba(0, 102, 204, 0.5));
        }

        .mindmap-node.grandchild:hover rect {
            fill: #e0e0e0;
        }

        .mindmap-link {
            fill: none;
            stroke: var(--color-primary-blue);
            stroke-width: 2;
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            .canvas-modal-content {
                width: 95%;
                height: 90vh;
            }

            .canvas-modal-header {
                padding: 16px 20px;
            }

            .canvas-modal-header h2 {
                font-size: 18px;
            }

            .canvas-modal-body {
                padding: 16px;
                grid-template-columns: 1fr;
            }

            .canvas-right-panel {
                display: none;
            }

            .mindmap-node.root text {
                font-size: 14px;
            }

            .mindmap-node.child text {
                font-size: 11px;
            }
        }

        /* Toggle Switch Styles */
        #cleansheetAiToggle:checked + span {
            background-color: var(--color-primary-blue);
        }

        #cleansheetAiToggle:checked + span + span {
            transform: translateX(24px);
        }

        .integration-header:hover {
            background: #f8f9fa !important;
        }

        /* Info Icon Tooltips (ML Pipeline Pattern) */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-neutral-background);
            color: var(--color-neutral-text-light);
            font-size: 12px;
            cursor: help;
            margin-left: 6px;
            position: relative;
            transition: all 0.2s;
        }

        .info-icon:hover {
            background: var(--color-primary-blue);
            color: white;
        }

        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .hover-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-dark);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: var(--font-family-body);
            font-size: 13px;
            line-height: 1.5;
            white-space: normal;
            width: 320px;
            max-width: 90vw;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }

        .hover-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--color-dark);
        }

        .info-icon:hover .hover-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Modal (Pipeline Edit Pattern) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-neutral-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1a1a1a;
        }

        .modal-title {
            font-family: var(--font-family-ui);
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--color-neutral-border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Button Styles for Modal */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-accent-blue);
        }

        .btn-secondary {
            background: white;
            color: var(--color-dark);
            border: 1px solid var(--color-neutral-border);
        }

        .btn-secondary:hover {
            background: var(--color-neutral-background);
        }

        /* Block-level Quill Editor Styles */
        .document-block .ql-container {
            font-family: var(--font-family-body);
            font-size: 14px;
            border: none;
        }

        .document-block .ql-editor {
            min-height: 150px;
            padding: 12px 0;
        }

        .document-block .ql-toolbar {
            border: none;
            border-bottom: 1px solid var(--color-neutral-border);
            padding: 8px 0;
            background: var(--color-neutral-background);
            border-radius: 4px 4px 0 0;
            margin-bottom: 8px;
        }

        .document-block .ql-editor.ql-blank::before {
            color: var(--color-neutral-text-light);
            font-style: normal;
        }

        .document-block .ql-snow .ql-stroke {
            stroke: var(--color-neutral-text);
        }

        .document-block .ql-snow .ql-fill {
            fill: var(--color-neutral-text);
        }

        .document-block .ql-snow .ql-picker-label {
            color: var(--color-neutral-text);
        }

        .document-block .ql-toolbar button:hover,
        .document-block .ql-toolbar button:focus,
        .document-block .ql-toolbar button.ql-active {
            color: var(--color-primary-blue);
        }

        .document-block .ql-toolbar button:hover .ql-stroke,
        .document-block .ql-toolbar button:focus .ql-stroke,
        .document-block .ql-toolbar button.ql-active .ql-stroke {
            stroke: var(--color-primary-blue);
        }

        .document-block .ql-toolbar button:hover .ql-fill,
        .document-block .ql-toolbar button:focus .ql-fill,
        .document-block .ql-toolbar button.ql-active .ql-fill {
            fill: var(--color-primary-blue);
        }

        /* Block Control Buttons */
        .block-control-btn:hover {
            background: var(--color-neutral-background) !important;
            color: var(--color-primary-blue) !important;
        }

        .block-control-btn:hover i {
            color: var(--color-primary-blue);
        }

        .block-control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed !important;
        }

        /* Drag Handle */
        .document-block:hover .drag-handle {
            opacity: 1 !important;
        }

        .drag-handle:hover {
            background: var(--color-neutral-background) !important;
            color: var(--color-primary-blue) !important;
        }

        .drag-handle:hover i {
            color: var(--color-primary-blue);
        }

        .drag-handle:active {
            cursor: grabbing !important;
        }

        /* Dragging State */
        .document-block.dragging {
            opacity: 0.4;
            border: 2px dashed var(--color-primary-blue);
        }

        .document-block.drag-over {
            border-top: 3px solid var(--color-primary-blue);
        }

        /* Focus State for Keyboard Navigation */
        .document-block:focus {
            outline: 2px solid var(--color-primary-blue);
            outline-offset: 2px;
        }

        .document-block:focus .drag-handle {
            opacity: 1 !important;
        }

        /* Markdown Preview Styles */
        .markdown-preview {
            color: var(--color-dark);
        }

        .markdown-preview h1,
        .markdown-preview h2,
        .markdown-preview h3,
        .markdown-preview h4,
        .markdown-preview h5,
        .markdown-preview h6 {
            font-family: var(--font-family-ui);
            font-weight: 600;
            margin-top: 16px;
            margin-bottom: 8px;
            color: var(--color-dark);
        }

        .markdown-preview h1 { font-size: 28px; }
        .markdown-preview h2 { font-size: 24px; }
        .markdown-preview h3 { font-size: 20px; }
        .markdown-preview h4 { font-size: 18px; }
        .markdown-preview h5 { font-size: 16px; }
        .markdown-preview h6 { font-size: 14px; }

        .markdown-preview p {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .markdown-preview ul,
        .markdown-preview ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .markdown-preview li {
            margin-bottom: 4px;
        }

        .markdown-preview code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }

        .markdown-preview pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 12px;
        }

        .markdown-preview pre code {
            background: none;
            padding: 0;
        }

        .markdown-preview blockquote {
            border-left: 4px solid var(--color-primary-blue);
            padding-left: 16px;
            margin-left: 0;
            margin-bottom: 12px;
            color: var(--color-neutral-text);
        }

        .markdown-preview a {
            color: var(--color-primary-blue);
            text-decoration: none;
        }

        .markdown-preview a:hover {
            text-decoration: underline;
        }

        .markdown-preview table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 12px;
        }

        .markdown-preview th,
        .markdown-preview td {
            border: 1px solid var(--color-neutral-border);
            padding: 8px 12px;
            text-align: left;
        }

        .markdown-preview th {
            background: var(--color-neutral-background);
            font-weight: 600;
        }

        .markdown-preview img {
            max-width: 100%;
            height: auto;
        }

        /* Preview button active state */
        .markdown-preview-btn[data-mode="preview"] {
            background: var(--color-primary-blue) !important;
            color: white !important;
        }

        .markdown-preview-btn[data-mode="preview"] i {
            color: white;
        }

        /* Table Selector Cards */
        .document-block [onclick^="createCleansheetTable"]:hover,
        .document-block [onclick^="connectCleansheetTable"]:hover,
        .document-block [onclick^="connectDataSource"]:hover {
            border-color: var(--color-primary-blue) !important;
            background: var(--color-neutral-background) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 102, 204, 0.1);
        }

    </style>
</head>
<body>
    <!-- Canvas Modal -->
    <div class="canvas-modal" id="canvasModal">
        <div class="canvas-modal-content">
            <div class="canvas-modal-header">
                <div class="canvas-modal-header-top">
                    <h2>Cleansheet Canvas Tour</h2>

                    <!-- View Mode Toggle -->
                    <div style="display: flex; gap: 4px; background: rgba(255, 255, 255, 0.1); padding: 4px; border-radius: 8px;">
                        <button class="view-mode-btn active" data-view="seeker" onclick="switchViewMode('seeker')" style="padding: 6px 12px; background: var(--color-primary-blue); border: none; color: white; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                            Seeker
                        </button>
                        <button class="view-mode-btn" data-view="learner" onclick="switchViewMode('learner')" style="padding: 6px 12px; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                            Learner
                        </button>
                        <button class="view-mode-btn" data-view="professional" onclick="switchViewMode('professional')" style="padding: 6px 12px; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                            Professional
                        </button>
                    </div>

                    <!-- Persona Selector -->
                    <div style="display: flex; gap: 4px; background: rgba(255, 255, 255, 0.1); padding: 4px; border-radius: 8px;">
                        <button class="persona-btn active" data-persona="retail-manager" onclick="switchPersona('retail-manager')" style="padding: 6px 12px; background: var(--color-primary-blue); border: none; color: white; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                            Retail Manager
                        </button>
                        <button class="persona-btn" data-persona="chemist" onclick="switchPersona('chemist')" style="padding: 6px 12px; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                            Research Chemist
                        </button>
                        <button class="persona-btn" data-persona="new-graduate" onclick="switchPersona('new-graduate')" style="padding: 6px 12px; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                            New Graduate
                        </button>
                        <button class="persona-btn" data-persona="data-analyst" onclick="switchPersona('data-analyst')" style="padding: 6px 12px; background: transparent; border: none; color: rgba(255, 255, 255, 0.7); font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                            Data Analyst
                        </button>
                    </div>
                </div>

                <!-- Main Menu -->
                <div class="main-menu">
                    <button class="main-menu-item active" onclick="setActiveMenu(this)">
                        <i class="ph ph-house"></i>
                        <span>Home</span>
                    </button>
                    <button class="main-menu-item" id="jobSearchMenuItem" onclick="setActiveMenu(this)">
                        <i class="ph ph-briefcase"></i>
                        <span>Job Search</span>
                    </button>
                    <button class="main-menu-item" id="libraryMenuItem" onclick="setActiveMenu(this)">
                        <i class="ph ph-book-open"></i>
                        <span>Library</span>
                    </button>
                    <button class="main-menu-item" id="projectsMenuItem" onclick="setActiveMenu(this); showProjectsView();" style="display: none;">
                        <i class="ph ph-folder-open"></i>
                        <span>Projects</span>
                    </button>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
                        <!-- Profile Circle -->
                        <div class="profile-circle">
                            <div class="profile-avatar" id="profileAvatar" onclick="toggleProfileDropdown()">
                                <span id="profileInitials">AM</span>
                            </div>
                            <div class="profile-dropdown" id="profileDropdown">
                                <div class="profile-dropdown-header">
                                    <div class="profile-dropdown-name" id="profileName">Alex Martinez</div>
                                    <div class="profile-dropdown-role" id="profileRole">Retail Manager</div>
                                </div>
                                <div class="profile-dropdown-menu">
                                    <button class="profile-dropdown-item" onclick="openProfileSettings()">
                                        <i class="ph ph-user-circle"></i>
                                        <span>Profile</span>
                                    </button>
                                    <button class="profile-dropdown-item" onclick="openSettings()">
                                        <i class="ph ph-gear"></i>
                                        <span>Settings</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="canvas-modal-body" id="canvasBody">
                <!-- Job Search Aggregation View -->
                <div id="jobSearchView" style="display: none; padding: 24px; overflow-y: auto; background: var(--color-neutral-background); grid-column: 1 / -1; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10;">
                    <!-- Job Search Content will be inserted here -->
                </div>

                <!-- Library View -->
                <div id="libraryView" style="display: none; overflow-y: auto; background: var(--color-neutral-background); grid-column: 1 / -1; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10;">
                    <!-- Library Content will be inserted here -->
                </div>

                <!-- Home/Canvas View -->
                <div id="homeView" style="display: contents;">
                <!-- Left Panel (formerly right panel) -->
                <div class="canvas-right-panel">
                    <!-- Calendar Widget -->
                    <div class="calendar-widget">
                        <div class="widget-header">
                            <h3><i class="ph ph-calendar"></i> Upcoming Events</h3>
                            <button class="sync-btn" onclick="syncOutlook()">
                                <i class="ph ph-microsoft-outlook-logo"></i>
                                Sync Outlook
                            </button>
                        </div>
                        <div class="calendar-events" id="calendarEvents">
                            <div class="calendar-event">
                                <div class="event-time">Today, 2:00 PM</div>
                                <div class="event-title">Interview: Senior Developer</div>
                                <div class="event-details">TechCorp - Final Round (Virtual)</div>
                            </div>
                            <div class="calendar-event">
                                <div class="event-time">Tomorrow, 10:00 AM</div>
                                <div class="event-title">Coffee Chat: Referral</div>
                                <div class="event-details">Sarah Chen - Starbucks Downtown</div>
                            </div>
                            <div class="calendar-event">
                                <div class="event-time">Wed, 3:30 PM</div>
                                <div class="event-title">Application Deadline</div>
                                <div class="event-details">Cloud Architect - Amazon AWS</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Assistant Widget -->
                    <div class="ai-assistant-widget">
                        <div class="widget-header">
                            <h3><i class="ph ph-chats-circle"></i> Cleansheet AI Assistant</h3>
                        </div>
                        <div class="ai-chat-messages" id="aiMessages">
                            <div class="ai-message assistant">
                                Hi! I'm your Cleansheet AI assistant. I can help you with:
                                <ul style="margin: 8px 0 0 20px; padding: 0;">
                                    <li>Resume and cover letter tips</li>
                                    <li>Interview preparation</li>
                                    <li>Career path guidance</li>
                                    <li>Job search strategies</li>
                                </ul>
                                What would you like to work on today?
                            </div>
                        </div>
                        <div class="ai-input-area">
                            <input type="text" class="ai-input" id="aiInput" placeholder="Ask me anything about your job search..." onkeypress="if(event.key==='Enter') sendAIMessage()">
                            <button class="ai-send-btn" onclick="sendAIMessage()">
                                <i class="ph ph-paper-plane-tilt"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="canvas-mindmap"></div>

                <!-- Projects View -->
                <div id="projects-view" style="display: none; overflow: hidden; background: var(--color-neutral-background); grid-column: 1 / -1; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; flex-direction: column;">
                    <!-- Projects Header -->
                    <div style="padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border); flex-shrink: 0;">
                        <h2 style="font-family: var(--font-family-ui); font-size: 24px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Projects</h2>
                        <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">Organize your documents, tables, forms, reports, templates, and workflows</p>
                    </div>

                    <!-- Projects Body -->
                    <div style="flex: 1; display: flex; overflow: hidden;">
                        <!-- Left Sidebar - Folder Tree -->
                        <div style="width: 280px; border-right: 1px solid var(--color-neutral-border); background: var(--color-neutral-background); overflow-y: auto;">
                            <div style="padding: 16px;">
                                <button onclick="createNewFolder()" style="width: 100%; padding: 10px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; justify-content: center; margin-bottom: 16px;">
                                    <i class="ph ph-folder-plus"></i> New Folder
                                </button>
                                <div id="folderTree" style="font-family: var(--font-family-body); font-size: 13px;">
                                    <!-- Folder tree will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Main Content - File Explorer Table -->
                        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                            <!-- Breadcrumb & Toolbar -->
                            <div style="padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: white; flex-shrink: 0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                    <div id="breadcrumb" style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); display: flex; align-items: center; gap: 6px;">
                                        <!-- Breadcrumb will be rendered here -->
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="addItemToCurrentFolder()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                            <i class="ph ph-plus"></i> Add Item
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- File Table -->
                            <div style="flex: 1; overflow-y: auto; background: white;">
                                <table id="fileExplorerTable" style="width: 100%; border-collapse: collapse; font-family: var(--font-family-body); font-size: 13px;">
                                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">
                                        <tr style="border-bottom: 1px solid var(--color-neutral-border);">
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Name
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Type
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Created
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Modified
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Shared With
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase; width: 100px;">
                                                Actions
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="fileTableBody">
                                        <!-- File rows will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Editor Modal -->
                <div class="modal" id="documentEditorModal">
                    <div class="modal-content" style="max-width: 1400px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Edit Document</h2>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <!-- Cancel Button -->
                                <button class="btn btn-secondary" onclick="closeModal('documentEditorModal')" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                                    Cancel
                                </button>
                                <!-- Save Changes Button -->
                                <button class="btn btn-primary" onclick="saveDocument()" style="padding: 8px 16px; background: var(--color-primary-blue); border: 1px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: white; cursor: pointer;">
                                    Save Changes
                                </button>
                                <!-- Export Button with Dropdown -->
                                <div style="position: relative;">
                                    <button onclick="toggleExportMenu()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                        <i class="ph ph-export" style="font-size: 16px;"></i>
                                        Export
                                        <i class="ph ph-caret-down" style="font-size: 12px;"></i>
                                    </button>
                                    <!-- Export Dropdown Menu -->
                                    <div id="exportMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); min-width: 180px; z-index: 1100;">
                                        <button onclick="exportDocument('markdown')" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; font-family: var(--font-family-ui); font-size: 13px; font-weight: 500; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                            <i class="ph ph-file-md" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                            Markdown (.md)
                                        </button>
                                        <button onclick="exportDocument('html')" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; font-family: var(--font-family-ui); font-size: 13px; font-weight: 500; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                            <i class="ph ph-file-html" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                            HTML (.html)
                                        </button>
                                        <button onclick="exportDocument('docx')" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; font-family: var(--font-family-ui); font-size: 13px; font-weight: 500; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                            <i class="ph ph-file-doc" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                            Word (.docx)
                                        </button>
                                        <button onclick="exportDocument('pdf')" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; font-family: var(--font-family-ui); font-size: 13px; font-weight: 500; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; border-top: 1px solid var(--color-neutral-border);">
                                            <i class="ph ph-file-pdf" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                            PDF (.pdf)
                                        </button>
                                    </div>
                                </div>
                                <!-- Share Document Button -->
                                <button onclick="shareDocument()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <i class="ph ph-share-network" style="font-size: 16px;"></i>
                                    Share
                                </button>
                                <button class="modal-close" onclick="closeModal('documentEditorModal')">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 0; display: flex; gap: 0; min-height: 600px;">
                            <!-- Left Panel - Block Pool (20%) -->
                            <div style="width: 20%; background: var(--color-neutral-background); border-right: 1px solid var(--color-neutral-border); padding: 20px; overflow-y: auto;">
                                <!-- Document Metadata -->
                                <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--color-neutral-border);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                        <h3 style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin: 0; letter-spacing: 0.5px;">Document Info</h3>

                                        <!-- WBS Toggle (Compact) -->
                                        <div style="display: flex; align-items: center; gap: 6px; cursor: pointer;" onclick="toggleWBS()">
                                            <span style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text);">WBS</span>
                                            <div id="wbs-toggle" style="width: 32px; height: 16px; background: #ccc; border-radius: 8px; position: relative; transition: background 0.3s;">
                                                <div style="width: 12px; height: 12px; background: white; border-radius: 6px; position: absolute; top: 2px; left: 2px; transition: left 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Title -->
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">Title</label>
                                        <input type="text" id="docTitle" placeholder="Untitled Document" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); background: white;">
                                    </div>

                                    <!-- Description -->
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">Description</label>
                                        <textarea id="docDescription" placeholder="Brief description..." style="width: 100%; min-height: 60px; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); background: white; resize: vertical;"></textarea>
                                    </div>

                                    <!-- Tags -->
                                    <div>
                                        <label style="display: block; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">Tags</label>
                                        <input type="text" id="docTags" placeholder="tag1, tag2, tag3" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); background: white;">
                                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin-top: 4px;">Separate tags with commas</div>
                                    </div>
                                </div>

                                <h3 style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin: 0 0 16px 0; letter-spacing: 0.5px;">Block Pool</h3>

                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <!-- Header Block -->
                                    <button onclick="addDocumentBlock('header')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-h" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Header</span>
                                    </button>

                                    <!-- Rich Text Block -->
                                    <button onclick="addDocumentBlock('richtext')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-aa" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Rich Text</span>
                                    </button>

                                    <!-- Markdown Block -->
                                    <button onclick="addDocumentBlock('markdown')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-markdown-logo" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Markdown</span>
                                    </button>

                                    <!-- Picture Block -->
                                    <button onclick="addDocumentBlock('picture')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-image" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Picture</span>
                                    </button>

                                    <!-- Table Block -->
                                    <button onclick="addDocumentBlock('table')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-table" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Typed Table</span>
                                    </button>

                                    <!-- Code Block -->
                                    <button onclick="addDocumentBlock('code')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-code" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Code</span>
                                    </button>

                                    <!-- Diagram Block -->
                                    <button onclick="addDocumentBlock('diagram')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-flow-arrow" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Diagram</span>
                                    </button>

                                    <!-- Divider Block -->
                                    <button onclick="addDocumentBlock('divider')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-minus" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Divider</span>
                                    </button>

                                    <!-- Mermaid Block -->
                                    <button onclick="addDocumentBlock('mermaid')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-flow-arrow" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Mermaid</span>
                                    </button>

                                    <!-- KaTeX Block -->
                                    <button onclick="addDocumentBlock('latex')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-function" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>KaTeX</span>
                                    </button>

                                    <!-- Table of Contents Block -->
                                    <button onclick="addDocumentBlock('toc')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-list-numbers" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Table of Contents</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Right Panel - Document Canvas (80%) -->
                            <div id="documentCanvas" style="width: 80%; background: white; padding: 40px; overflow-y: auto;">
                                <div style="text-align: center; color: var(--color-neutral-text-light); padding: 80px 20px;">
                                    <i class="ph ph-file-text" style="font-size: 64px; color: var(--color-neutral-border); margin-bottom: 16px;"></i>
                                    <p style="font-family: var(--font-family-body); font-size: 14px; margin: 0;">Click a block from the left panel to start building your document</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Editor Modal -->
                <div id="tableEditorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000;">
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                        <!-- Table Editor Header -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: white;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div id="tableIcon" style="width: 40px; height: 40px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="ph ph-table" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                                </div>
                                <div>
                                    <h2 id="tableEditorTitle" style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin: 0;">Table Name</h2>
                                    <div id="tableRowCount" style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light); margin-top: 2px;">0 rows</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <!-- View Selector -->
                                <select id="viewSelector" onchange="switchTableView()" style="padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer;">
                                    <option value="default">Default View</option>
                                </select>
                                <!-- Add New Row Button -->
                                <button onclick="addNewRow()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-plus"></i>
                                    Add Row
                                </button>
                                <!-- Close Button -->
                                <button onclick="closeTableEditor()" style="padding: 8px; background: none; border: none; color: var(--color-neutral-text); cursor: pointer; font-size: 20px;">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Table Toolbar -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 24px; border-bottom: 1px solid var(--color-neutral-border); background: var(--color-neutral-background-secondary);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <!-- Filter Button -->
                                <button onclick="toggleFilterPanel()" id="filterBtn" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-funnel"></i>
                                    Filter
                                </button>
                                <!-- Sort Button -->
                                <button onclick="toggleSortPanel()" id="sortBtn" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-sort-ascending"></i>
                                    Sort
                                </button>
                                <!-- Group Button -->
                                <button onclick="toggleGroupPanel()" id="groupBtn" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-rows"></i>
                                    Group
                                </button>
                                <!-- Search -->
                                <div style="position: relative;">
                                    <input type="text" id="tableSearch" placeholder="Search..." style="padding: 6px 12px 6px 32px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; width: 200px;">
                                    <i class="ph ph-magnifying-glass" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--color-neutral-text); font-size: 14px;"></i>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <!-- Save View Button -->
                                <button onclick="saveCurrentView()" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-floppy-disk"></i>
                                    Save View
                                </button>
                            </div>
                        </div>

                        <!-- Table Content Area -->
                        <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                            <!-- Filter/Sort/Group Panels (Hidden by default) -->
                            <div id="filterPanel" style="display: none; padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: #fafbfc;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Filter Conditions</div>
                                <div id="filterConditions"></div>
                                <button onclick="addFilterCondition()" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-primary-blue); cursor: pointer; margin-top: 8px;">
                                    <i class="ph ph-plus"></i> Add Condition
                                </button>
                            </div>

                            <div id="sortPanel" style="display: none; padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: #fafbfc;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Sort Order</div>
                                <div id="sortConditions"></div>
                                <button onclick="addSortCondition()" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-primary-blue); cursor: pointer; margin-top: 8px;">
                                    <i class="ph ph-plus"></i> Add Sort
                                </button>
                            </div>

                            <div id="groupPanel" style="display: none; padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: #fafbfc;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Group By</div>
                                <select id="groupByColumn" onchange="applyGrouping()" style="padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; width: 200px;">
                                    <option value="">No Grouping</option>
                                </select>
                            </div>

                            <!-- Data Grid -->
                            <div id="tableDataGrid" style="flex: 1; overflow: auto; background: white;">
                                <!-- Table will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column Type Editor Modal -->
                <div id="columnTypeEditorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; width: 100%; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                        <!-- Modal Header -->
                        <div style="padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border);">
                            <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Change Column Type</h3>
                            <div id="columnTypeEditorColumnName" style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-top: 4px;"></div>
                        </div>

                        <!-- Type Options -->
                        <div style="padding: 20px 24px; max-height: 400px; overflow-y: auto;">
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin-bottom: 12px;">Select Data Type</div>
                            <div id="columnTypeOptions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <!-- Type options will be dynamically inserted here -->
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <div style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                            <button onclick="closeColumnTypeEditor()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="applyColumnType()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Form Designer Modal -->
                <div class="modal" id="formDesignerModal">
                    <div class="modal-content" style="max-width: 1400px;">
                        <div class="modal-header">
                            <div style="flex: 1; max-width: 600px;">
                                <input type="text" id="formTitle" placeholder="Untitled Form" style="width: 100%; border: none; font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); padding: 8px 0; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <!-- Preview Button -->
                                <button onclick="openFormPreview()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-eye"></i> Preview
                                </button>
                                <!-- Publish Menu -->
                                <div style="position: relative;">
                                    <button onclick="togglePublishMenu()" id="publishBtn" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                        <i class="ph ph-paper-plane-tilt"></i>
                                        Publish
                                        <i class="ph ph-caret-down"></i>
                                    </button>
                                    <div id="publishMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 220px; z-index: 1100;">
                                        <button onclick="publishFormAs('open')" style="width: 100%; padding: 12px 16px; background: none; border: none; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                            <i class="ph ph-globe" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                                            <span>Publish as Open Form</span>
                                        </button>
                                        <button onclick="publishFormAs('specific')" style="width: 100%; padding: 12px 16px; background: none; border: none; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                            <i class="ph ph-users" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                                            <span>Publish to Specific Users</span>
                                        </button>
                                        <button onclick="shareFormWithEditors()" style="width: 100%; padding: 12px 16px; background: none; border: none; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; border-top: 1px solid var(--color-neutral-border);" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                            <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                                            <span>Share with Editors</span>
                                        </button>
                                    </div>
                                </div>
                                <!-- Save Button -->
                                <button onclick="saveFormDesign()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                                    <i class="ph ph-floppy-disk"></i> Save
                                </button>
                                <!-- Close Button -->
                                <button class="modal-close" onclick="closeFormDesigner()">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 0; display: flex; gap: 0; min-height: 600px;">
                            <!-- Left Panel - Field Palette (20%) -->
                            <div style="width: 20%; background: var(--color-neutral-background); border-right: 1px solid var(--color-neutral-border); padding: 20px; overflow-y: auto;">
                                <h3 style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin: 0 0 16px 0; letter-spacing: 0.5px;">Form Fields</h3>

                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <!-- Text Input Block -->
                                    <button onclick="addFormField('text')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-aa" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Text Input</span>
                                    </button>

                                    <!-- Text Area Block -->
                                    <button onclick="addFormField('textarea')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-align-left" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Text Area</span>
                                    </button>

                                    <!-- Email Block -->
                                    <button onclick="addFormField('email')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-envelope" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Email</span>
                                    </button>

                                    <!-- Number Block -->
                                    <button onclick="addFormField('number')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-hash" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Number</span>
                                    </button>

                                    <!-- Phone Block -->
                                    <button onclick="addFormField('phone')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-phone" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Phone</span>
                                    </button>

                                    <!-- Date Block -->
                                    <button onclick="addFormField('date')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-calendar-blank" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Date</span>
                                    </button>

                                    <!-- Time Block -->
                                    <button onclick="addFormField('time')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-clock" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Time</span>
                                    </button>
                                    <!-- Dropdown Block -->
                                    <button onclick="addFormField('dropdown')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-list" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Dropdown</span>
                                    </button>

                                    <!-- Radio Buttons Block -->
                                    <button onclick="addFormField('radio')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-radio-button" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Radio Buttons</span>
                                    </button>

                                    <!-- Checkboxes Block -->
                                    <button onclick="addFormField('checkbox')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-check-square" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Checkboxes</span>
                                    </button>

                                    <!-- File Upload Block -->
                                    <button onclick="addFormField('file')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-upload-simple" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>File Upload</span>
                                    </button>

                                    <!-- Picture Block -->
                                    <button onclick="addFormField('picture')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-image" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Picture</span>
                                    </button>

                                    <!-- Scale Block -->
                                    <button onclick="addFormField('scale')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-sliders-horizontal" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Scale</span>
                                    </button>

                                    <!-- Likert Scale Block -->
                                    <button onclick="addFormField('likert')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-rows" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Likert Scale</span>
                                    </button>

                                    <!-- Section Block -->
                                    <button onclick="addFormField('section')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-h-two" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Section Header</span>
                                    </button>
                                    </div>
                                </div>

                                <!-- Main Content Area - Form Builder (80%) -->
                                <div style="width: 80%; background: white; overflow-y: auto; padding: 24px;">
                                    <div id="formFieldsContainer" style="width: 100%; min-height: 400px;">
                                        <div style="text-align: center; color: var(--color-neutral-text); padding: 60px 20px;">
                                            <i class="ph ph-note-pencil" style="font-size: 48px; color: var(--color-neutral-border); margin-bottom: 16px;"></i>
                                            <p style="font-family: var(--font-family-body); font-size: 14px;">Click a field type to start building your form</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Preview Modal -->
                <div id="formPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10001; overflow-y: auto;">
                    <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 40px;">
                        <div style="background: white; border-radius: 12px; width: 100%; max-width: 800px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                            <!-- Preview Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border);">
                                <h3 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin: 0;">Form Preview</h3>
                                <button onclick="closeFormPreview()" style="padding: 8px; background: none; border: none; color: var(--color-neutral-text); cursor: pointer; font-size: 20px;">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                            <!-- Preview Body -->
                            <div id="formPreviewContent" style="padding: 32px; max-height: 70vh; overflow-y: auto;">
                                <!-- Form preview will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Builder Modal -->
                <div id="dashboardBuilderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000;">
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 40px; box-sizing: border-box;">
                        <div style="background: white; border-radius: 12px; width: 100%; height: 100%; max-width: 2400px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                            <!-- Dashboard Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border); flex-shrink: 0;">
                                <div style="flex: 1;">
                                    <input type="text" id="dashboardTitle" placeholder="Untitled Dashboard" style="width: 100%; max-width: 600px; border: none; font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); padding: 8px 0; outline: none;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <button onclick="saveDashboard()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                        <i class="ph ph-floppy-disk"></i> Save
                                    </button>
                                    <button onclick="closeDashboardBuilder()" style="padding: 8px; background: none; border: none; color: var(--color-neutral-text); cursor: pointer; font-size: 20px;">
                                        <i class="ph ph-x"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Dashboard Body -->
                            <div style="flex: 1; overflow: hidden; display: flex; min-height: 0;">
                                <!-- Left Sidebar - Components Palette -->
                                <div style="width: 280px; border-right: 1px solid var(--color-neutral-border); padding: 20px; background: var(--color-neutral-background); overflow-y: auto;">
                                    <h4 style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin: 0 0 16px 0;">Visualizations</h4>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="addVisualization('bar-chart')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-chart-bar"></i>
                                            Bar Chart
                                        </button>
                                        <button onclick="addVisualization('line-chart')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-chart-line"></i>
                                            Line Chart
                                        </button>
                                        <button onclick="addVisualization('pie-chart')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-chart-pie-slice"></i>
                                            Pie Chart
                                        </button>
                                        <button onclick="addVisualization('area-chart')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-chart-line-up"></i>
                                            Area Chart
                                        </button>
                                        <button onclick="addVisualization('scatter-plot')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-scatter-chart"></i>
                                            Scatter Plot
                                        </button>
                                        <button onclick="addVisualization('gauge')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-gauge"></i>
                                            Gauge
                                        </button>
                                        <button onclick="addVisualization('kpi-card')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-number-square-one"></i>
                                            KPI Card
                                        </button>
                                        <button onclick="addVisualization('table')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-table"></i>
                                            Data Table
                                        </button>
                                        <button onclick="addVisualization('heatmap')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-grid-four"></i>
                                            Heatmap
                                        </button>
                                        <button onclick="addVisualization('funnel')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-funnel"></i>
                                            Funnel Chart
                                        </button>
                                    </div>
                                </div>

                                <!-- Main Canvas Area -->
                                <div style="flex: 1; background: var(--color-neutral-background); overflow-y: auto; display: flex; justify-content: center; min-height: 0;">
                                    <div id="dashboardCanvas" style="width: 100%; max-width: 1600px; padding: 24px; box-sizing: border-box;">
                                        <div style="text-align: center; padding: 80px 20px; color: var(--color-neutral-text-muted);">
                                            <i class="ph ph-chart-line" style="font-size: 64px; margin-bottom: 16px;"></i>
                                            <p style="font-size: 16px;">Click a visualization type to add it to your dashboard</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visualization Configuration Modal -->
                <div id="vizConfigModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10001; overflow-y: auto;">
                    <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 40px;">
                        <div style="background: white; border-radius: 12px; width: 100%; max-width: 600px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                            <!-- Config Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border);">
                                <h3 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin: 0;">Configure Visualization</h3>
                                <button onclick="closeVizConfig()" style="padding: 8px; background: none; border: none; color: var(--color-neutral-text); cursor: pointer; font-size: 20px;">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                            <!-- Config Body -->
                            <div style="padding: 24px;">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                        Visualization Title
                                    </label>
                                    <input type="text" id="vizConfigTitle" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                        Select Tables
                                    </label>
                                    <div id="tableSelectionList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 12px;">
                                        <!-- Table checkboxes will be inserted here -->
                                    </div>
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--color-neutral-text-muted);">
                                        Select one or more tables to use in this visualization
                                    </div>
                                </div>
                            </div>
                            <!-- Config Footer -->
                            <div style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                                <button onclick="closeVizConfig()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                                    Cancel
                                </button>
                                <button onclick="saveVizConfig()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Collapse Toggle Button -->
                <button class="panel-collapse-toggle" onclick="toggleRightPanel()" id="collapseToggle">
                    <i class="ph ph-caret-right"></i>
                </button>
                </div> <!-- End homeView -->

                <!-- Copyright Notice -->
                <div style="position: absolute; bottom: 8px; right: 16px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); font-weight: 500; z-index: 5;">
                    © 2025 Cleansheet LLC. All rights reserved.
                </div>
            </div>

        <!-- Data Source Selection Modal -->
        <div class="modal" id="dataSourceModal" style="display: none;">
            <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 class="modal-title">Connect Data Source</h2>
                    <button class="modal-close" onclick="closeDataSourceModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 24px;">
                        Select a data source to import data into your table.
                    </p>

                    <!-- Two Column Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">

                        <!-- Left Column -->
                        <div>
                            <!-- CRM & ERP Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('crm')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-buildings" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">CRM & ERP</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="crm-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="crm-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('CRM & ERP', 'Salesforce')" class="data-source-btn">
                                            <i class="ph ph-cloud"></i> Salesforce
                                        </button>
                                        <button onclick="selectDataSource('CRM & ERP', 'Oracle ERP')" class="data-source-btn">
                                            <i class="ph ph-database"></i> Oracle ERP
                                        </button>
                                        <button onclick="selectDataSource('CRM & ERP', 'Microsoft Dynamics')" class="data-source-btn">
                                            <i class="ph ph-microsoft-logo"></i> MS Dynamics
                                        </button>
                                        <button onclick="selectDataSource('CRM & ERP', 'SAP')" class="data-source-btn">
                                            <i class="ph ph-factory"></i> SAP
                                        </button>
                                        <button onclick="selectDataSource('CRM & ERP', 'HubSpot')" class="data-source-btn">
                                            <i class="ph ph-funnel"></i> HubSpot
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Services Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('data')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-database" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Data Services</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="data-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="data-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Data Services', 'Snowflake')" class="data-source-btn">
                                            <i class="ph ph-snowflake"></i> Snowflake
                                        </button>
                                        <button onclick="selectDataSource('Data Services', 'Microsoft Dataverse')" class="data-source-btn">
                                            <i class="ph ph-microsoft-logo"></i> Dataverse
                                        </button>
                                        <button onclick="selectDataSource('Data Services', 'AWS S3')" class="data-source-btn">
                                            <i class="ph ph-amazon-logo"></i> AWS S3
                                        </button>
                                        <button onclick="selectDataSource('Data Services', 'Azure Data Lake')" class="data-source-btn">
                                            <i class="ph ph-cloud"></i> Azure Data Lake
                                        </button>
                                        <button onclick="selectDataSource('Data Services', 'Google BigQuery')" class="data-source-btn">
                                            <i class="ph ph-google-logo"></i> BigQuery
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- File Services Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('file')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-folder-open" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">File Services</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="file-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="file-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('File Services', 'OneDrive')" class="data-source-btn">
                                            <i class="ph ph-microsoft-onedrive-logo"></i> OneDrive
                                        </button>
                                        <button onclick="selectDataSource('File Services', 'Dropbox')" class="data-source-btn">
                                            <i class="ph ph-dropbox-logo"></i> Dropbox
                                        </button>
                                        <button onclick="selectDataSource('File Services', 'Box')" class="data-source-btn">
                                            <i class="ph ph-package"></i> Box
                                        </button>
                                        <button onclick="selectDataSource('File Services', 'Google Drive')" class="data-source-btn">
                                            <i class="ph ph-google-drive-logo"></i> Google Drive
                                        </button>
                                        <button onclick="selectDataSource('File Services', 'SharePoint')" class="data-source-btn">
                                            <i class="ph ph-microsoft-sharepoint-logo"></i> SharePoint
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Finance Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('finance')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-chart-line" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Finance</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="finance-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="finance-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Finance', 'Bloomberg')" class="data-source-btn">
                                            <i class="ph ph-trend-up"></i> Bloomberg
                                        </button>
                                        <button onclick="selectDataSource('Finance', 'Morningstar')" class="data-source-btn">
                                            <i class="ph ph-star"></i> Morningstar
                                        </button>
                                        <button onclick="selectDataSource('Finance', 'Refinitiv')" class="data-source-btn">
                                            <i class="ph ph-globe"></i> Refinitiv
                                        </button>
                                        <button onclick="selectDataSource('Finance', 'FactSet')" class="data-source-btn">
                                            <i class="ph ph-briefcase"></i> FactSet
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Payments Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('payments')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-credit-card" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Payments</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="payments-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="payments-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Payments', 'Stripe')" class="data-source-btn">
                                            <i class="ph ph-stripe-logo"></i> Stripe
                                        </button>
                                        <button onclick="selectDataSource('Payments', 'Plaid')" class="data-source-btn">
                                            <i class="ph ph-bank"></i> Plaid
                                        </button>
                                        <button onclick="selectDataSource('Payments', 'PayPal')" class="data-source-btn">
                                            <i class="ph ph-paypal-logo"></i> PayPal
                                        </button>
                                        <button onclick="selectDataSource('Payments', 'Square')" class="data-source-btn">
                                            <i class="ph ph-square-logo"></i> Square
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Healthcare Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('healthcare')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-heartbeat" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Healthcare</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="healthcare-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="healthcare-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Healthcare', 'Epic')" class="data-source-btn">
                                            <i class="ph ph-hospital"></i> Epic
                                        </button>
                                        <button onclick="selectDataSource('Healthcare', 'Cerner')" class="data-source-btn">
                                            <i class="ph ph-first-aid-kit"></i> Cerner
                                        </button>
                                        <button onclick="selectDataSource('Healthcare', 'Meditech')" class="data-source-btn">
                                            <i class="ph ph-clipboard-text"></i> Meditech
                                        </button>
                                        <button onclick="selectDataSource('Healthcare', 'Athenahealth')" class="data-source-btn">
                                            <i class="ph ph-heartbeat"></i> Athenahealth
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Retail & Ecommerce Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('retail')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-storefront" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Retail & Ecommerce</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="retail-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="retail-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'Shopify')" class="data-source-btn">
                                            <i class="ph ph-shopping-bag"></i> Shopify
                                        </button>
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'Wix')" class="data-source-btn">
                                            <i class="ph ph-palette"></i> Wix
                                        </button>
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'Square')" class="data-source-btn">
                                            <i class="ph ph-square-logo"></i> Square
                                        </button>
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'WooCommerce')" class="data-source-btn">
                                            <i class="ph ph-shopping-cart"></i> WooCommerce
                                        </button>
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'BigCommerce')" class="data-source-btn">
                                            <i class="ph ph-storefront"></i> BigCommerce
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Insurance Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('insurance')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-shield-check" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Insurance</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="insurance-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="insurance-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Insurance', 'Guidewire')" class="data-source-btn">
                                            <i class="ph ph-shield"></i> Guidewire
                                        </button>
                                        <button onclick="selectDataSource('Insurance', 'Duck Creek')" class="data-source-btn">
                                            <i class="ph ph-umbrella"></i> Duck Creek
                                        </button>
                                        <button onclick="selectDataSource('Insurance', 'Applied Epic')" class="data-source-btn">
                                            <i class="ph ph-file-text"></i> Applied Epic
                                        </button>
                                        <button onclick="selectDataSource('Insurance', 'Vertafore')" class="data-source-btn">
                                            <i class="ph ph-buildings"></i> Vertafore
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Data Source Configuration Modal -->
        <div class="modal" id="dataSourceConfigModal" style="display: none;">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh;">
                <div class="modal-header">
                    <h2 class="modal-title" id="dataSourceConfigTitle">Configure Data Source</h2>
                    <button class="modal-close" onclick="closeDataSourceConfig()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 140px);">
                    <div id="dataSourceConfigForm">
                        <!-- Form fields will be dynamically generated here -->
                    </div>
                </div>
                <div style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px; background: white;">
                    <button onclick="closeDataSourceConfig()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; transition: all 0.2s;">
                        Cancel
                    </button>
                    <button onclick="saveDataSourceConfig()" style="padding: 8px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="ph ph-check-circle" style="margin-right: 6px;"></i> Save Connection
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Wizard Modal -->
        <div class="modal" id="tableWizardModal">
            <div class="modal-content" style="max-width: 1200px;">
                <div class="modal-header">
                    <h2 class="modal-title">New Table</h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <!-- Export SQL Button -->
                        <button onclick="exportTableSQL()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-download-simple"></i> Export SQL
                        </button>
                        <!-- Cancel Button -->
                        <button onclick="closeModal('tableWizardModal')" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                            Cancel
                        </button>
                        <!-- Save Table Schema Button -->
                        <button onclick="saveTableSchema()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                            Save Table Schema
                        </button>
                        <button class="modal-close" onclick="closeModal('tableWizardModal')">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: calc(90vh - 140px); overflow-y: auto;">

                    <!-- Table Metadata Section -->
                    <div style="background: var(--color-neutral-background); border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0;">Table Information</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: flex; align-items: center; gap: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">
                                    Schema Name
                                    <i class="ph ph-info" title="Namespace for organizing tables. Use 'public' for default schema or create custom schemas for logical grouping." style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                                </label>
                                <input type="text" id="schemaName" value="public" oninput="updateSQLPreview()" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; gap: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">
                                    Table Name <span style="color: #dc2626;">*</span>
                                    <i class="ph ph-info" title="Unique identifier for this table within the schema. Must start with a letter or underscore, followed by letters, numbers, or underscores." style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                                </label>
                                <input type="text" id="tableName" placeholder="e.g., users, products, orders" oninput="updateSQLPreview()" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">Comment</label>
                            <textarea id="tableComment" placeholder="Description of this table..." oninput="updateSQLPreview()" style="width: 100%; min-height: 60px; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <div style="display: flex; gap: 24px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;" title="Prevents error if table already exists - useful for idempotent scripts">
                                <input type="checkbox" id="ifNotExists" onchange="updateSQLPreview()" style="width: 16px; height: 16px;">
                                <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);">IF NOT EXISTS</span>
                                <i class="ph ph-info" style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;" title="Table exists only for the duration of the session - automatically dropped when connection ends">
                                <input type="checkbox" id="temporary" onchange="updateSQLPreview()" style="width: 16px; height: 16px;">
                                <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);">Temporary</span>
                                <i class="ph ph-info" style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;" title="Faster writes but not crash-safe - data not written to write-ahead log (WAL). Use for temporary/staging data.">
                                <input type="checkbox" id="unlogged" onchange="updateSQLPreview()" style="width: 16px; height: 16px;">
                                <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);">Unlogged</span>
                                <i class="ph ph-info" style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                            </label>
                        </div>
                    </div>

                    <!-- Columns Section -->
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0;">Columns</h3>
                            <button onclick="addTableColumn()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <i class="ph ph-plus"></i> Add Column
                            </button>
                        </div>

                        <div id="tableColumnsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Column rows will be added here -->
                        </div>
                    </div>

                    <!-- SQL Preview Section -->
                    <div style="background: #1a1a1a; border-radius: 8px; padding: 20px;">
                        <h3 style="display: flex; align-items: center; gap: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: white; margin: 0 0 12px 0;">
                            SQL Preview
                            <i class="ph ph-info" title="Live preview of the CREATE TABLE statement - updates as you configure the table above" style="font-size: 14px; color: #00ff00; cursor: help;"></i>
                        </h3>
                        <pre id="sqlPreview" style="font-family: 'Courier New', monospace; font-size: 13px; color: #00ff00; margin: 0; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">-- Configure table above to see SQL</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relationship Manager Modal -->
        <div class="modal" id="relationshipManagerModal">
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h2 class="modal-title">Manage Table Relationships</h2>
                    <button class="modal-close" onclick="closeModal('relationshipManagerModal')">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Add New Relationship Section -->
                    <div style="background: #f8f8f8; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin: 0 0 16px 0;">
                            <i class="ph ph-plus-circle" style="color: var(--color-primary-blue);"></i> Add New Relationship
                        </h3>

                        <!-- Table Selection Row -->
                        <div style="display: grid; grid-template-columns: 1fr 120px 1fr; gap: 16px; align-items: end; margin-bottom: 16px;">
                            <!-- Source Table -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                    Source Table
                                    <i class="ph ph-info" title="The table that contains the foreign key" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                                </label>
                                <select id="sourceTable" onchange="updateSourceColumns()" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                    <option value="">Select table...</option>
                                </select>
                            </div>

                            <!-- Relationship Type -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Type</label>
                                <select id="relationshipType" onchange="updateRelationshipPreview()" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                    <option value="many-to-one">M:1</option>
                                    <option value="one-to-one">1:1</option>
                                    <option value="many-to-many">M:M</option>
                                </select>
                            </div>

                            <!-- Target Table -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                    Target Table
                                    <i class="ph ph-info" title="The table that is being referenced" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                                </label>
                                <select id="targetTable" onchange="updateTargetColumns()" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                    <option value="">Select table...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Column Mapping Row -->
                        <div style="display: grid; grid-template-columns: 1fr 120px 1fr; gap: 16px; align-items: end; margin-bottom: 16px;">
                            <!-- Source Columns -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                    Source Column(s) *
                                    <i class="ph ph-info" title="The column(s) containing the foreign key values" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                                </label>
                                <div id="sourceColumnsContainer" style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; background: #f8f8f8; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text);">
                                    Select source table first
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin-top: 4px;">
                                    Click columns to select/deselect
                                </div>
                            </div>

                            <!-- Visual Connection -->
                            <div style="display: flex; align-items: center; justify-content: center; margin-top: 20px;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                    <i class="ph ph-arrows-horizontal" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                                    <div id="relationshipPreview" style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text); text-align: center; font-weight: 600;">
                                        MAPS TO
                                    </div>
                                </div>
                            </div>

                            <!-- Target Columns -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                    Target Column(s) *
                                    <i class="ph ph-info" title="The column(s) being referenced (usually primary key)" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                                </label>
                                <div id="targetColumnsContainer" style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; background: #f8f8f8; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text);">
                                    Select target table first
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin-top: 4px;">
                                    Click columns to select/deselect
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 16px;">
                            <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                Relationship Label
                                <i class="ph ph-info" title="Describe how the tables relate (e.g., 'has contact', 'belongs to')" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                            </label>
                            <input type="text" id="relationshipLabel" placeholder="e.g., has contact, belongs to, part of" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>

                        <button onclick="addRelationship()" style="margin-top: 16px; padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-plus"></i> Add Relationship
                        </button>
                    </div>

                    <!-- Existing Relationships List -->
                    <div>
                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin: 0 0 16px 0;">
                            <i class="ph ph-list" style="color: var(--color-primary-blue);"></i> Existing Relationships
                        </h3>
                        <div id="relationshipsList" style="max-height: 400px; overflow-y: auto;">
                            <!-- Relationship cards will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Guided Setup Modal -->
        <div class="simple-pipeline-wizard-modal" id="tableGuidedSetupModal">
            <div class="simple-pipeline-wizard-content">
                <div class="simple-pipeline-wizard-header">
                    <h3>Create Your First Table</h3>
                    <button class="simple-pipeline-wizard-close" onclick="closeTableGuidedSetup()">&times;</button>
                </div>

                <!-- Progress Indicator -->
                <div class="simple-wizard-progress">
                    <div class="simple-progress-bar">
                        <div class="simple-progress-fill" id="tableGuidedProgressFill"></div>
                    </div>
                    <div class="simple-progress-text" id="tableGuidedProgressText">Step 1 of 3</div>
                </div>

                <div class="simple-pipeline-wizard-body">
                    <!-- Step 1: Choose Use Case -->
                    <div class="simple-wizard-step-content active" id="tableGuidedStep1">
                        <div class="wizard-welcome">
                            <i class="ph ph-table" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                            <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">What will you track?</h4>
                            <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                                Choose a template designed for your specific needs. Each comes with pre-configured columns.
                            </p>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                            <div class="template-card" onclick="selectTableTemplate('inventory')" data-table-template="inventory">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-package" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Inventory Management</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Track stock levels, locations, suppliers, and reorder points for products or equipment.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Item Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Quantity</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Location</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Supplier</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('calendar')" data-table-template="calendar">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-calendar" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Event Calendar</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Schedule meetings, events, deadlines, and milestones with attendees and reminders.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Event Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Date/Time</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Attendees</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Status</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('backlog')" data-table-template="backlog">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-kanban" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Sprint Backlog</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Manage user stories, tasks, and bugs with priorities, story points, and sprint assignments.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Title</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Priority</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Story Points</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Assignee</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('assets')" data-table-template="assets">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-briefcase" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Asset Management</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Track equipment, tools, vehicles, and property with ownership, maintenance, and depreciation.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Asset Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Type</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Owner</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Value</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('wip')" data-table-template="wip">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-spinner-gap" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Work in Progress</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Monitor active projects, deliverables, and milestones with status tracking and completion dates.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Project Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Status</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Progress</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Due Date</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('contacts')" data-table-template="contacts">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-address-book" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Contacts & CRM</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Organize customers, vendors, and partners with contact details, interactions, and notes.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Email</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Company</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Role</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Name Table -->
                    <div class="simple-wizard-step-content" id="tableGuidedStep2">
                        <div class="wizard-welcome">
                            <i class="ph ph-pencil-simple" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                            <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Name your table</h4>
                            <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                                Give it a descriptive name. This will be the PostgreSQL table name.
                            </p>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Table Name</label>
                            <input type="text" id="guidedTableName" placeholder="e.g., inventory_items" style="width: 100%; padding: 12px 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 15px; transition: border-color 0.2s;">
                            <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px;">
                                <i class="ph ph-lightbulb" style="margin-right: 4px;"></i>
                                Tip: Use lowercase with underscores (e.g., my_table_name)
                            </div>
                        </div>

                        <div id="guidedColumnsPreview" style="background: var(--color-neutral-background); border-radius: 8px; padding: 20px;">
                            <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">Pre-configured Columns</h5>
                            <div id="guidedColumnsContent" style="display: flex; flex-direction: column; gap: 8px;">
                                <!-- Will be populated based on template -->
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Review & Create -->
                    <div class="simple-wizard-step-content" id="tableGuidedStep3">
                        <div class="wizard-welcome">
                            <i class="ph ph-check-circle" style="font-size: 48px; color: #10b981; display: block; margin-bottom: 16px;"></i>
                            <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Review your table</h4>
                            <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                                Here's what we'll create. You can customize columns later.
                            </p>
                        </div>

                        <div id="guidedTableReview" style="background: var(--color-neutral-background); border-radius: 8px; padding: 20px;">
                            <!-- Review summary will be populated here -->
                        </div>

                        <div style="background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px; margin-top: 16px;">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <i class="ph ph-info" style="font-size: 24px; color: #f59e0b; flex-shrink: 0;"></i>
                                <div>
                                    <h6 style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: #92400e; margin: 0 0 6px 0;">What happens next?</h6>
                                    <p style="font-family: var(--font-family-body); font-size: 12px; color: #92400e; margin: 0; line-height: 1.5;">
                                        Your table schema will be saved and ready to export as SQL. You can customize columns, add constraints, or connect to your PostgreSQL database.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wizard Footer -->
                <div class="simple-pipeline-wizard-footer">
                    <button id="tableGuidedBackBtn" onclick="previousTableGuidedStep()" style="padding: 10px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: none;">
                        <i class="ph ph-caret-left" style="margin-right: 6px;"></i> Back
                    </button>
                    <button id="tableGuidedContinueBtn" onclick="nextTableGuidedStep()" style="padding: 10px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        Continue <i class="ph ph-caret-right"></i>
                    </button>
                    <button id="tableGuidedCreateBtn" onclick="createTableFromGuided()" style="padding: 10px 24px; background: #10b981; color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: none; align-items: center; gap: 8px;">
                        <i class="ph ph-check"></i> Create Table
                    </button>
                </div>
            </div>
        </div>

        <!-- Interview Prep Slideout (60% width) - Inside Canvas Modal -->
        <div class="interview-slideout" id="interviewSlideout">
            <div class="slideout-header">
                <h2 id="slideoutTitle">Interview Preparation</h2>
                <button class="slideout-close" onclick="closeInterviewSlideout()">&times;</button>
            </div>

            <!-- Main Interview Prep Tabs (Behavioral / Technical) -->
            <div id="interviewPrepContent" style="display: none;">
                <div class="tech-tabs" style="border-bottom: 2px solid #e5e5e7; margin-bottom: 16px;">
                    <button class="tech-tab active" onclick="switchInterviewTab('behavioral')">Behavioral</button>
                    <button class="tech-tab" onclick="switchInterviewTab('technical')">Technical</button>
                </div>

                <!-- Behavioral Stories Content -->
                <div class="slideout-body" id="behavioralContent" style="display: block;">
                    <button class="add-story-btn" onclick="openStoryForm()">
                        <i class="ph ph-plus-circle"></i> Add New Story
                    </button>
                    <div id="storiesContainer" class="stories-container">
                        <!-- Story cards will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Technical Prep Content -->
                <div class="slideout-body" id="technicalContent" style="display: none;">
                    <div class="tech-tabs">
                        <button class="tech-tab active" onclick="switchTechTab('questions')">Questions</button>
                        <button class="tech-tab" onclick="switchTechTab('research')">Company Research</button>
                        <button class="tech-tab" onclick="switchTechTab('mock')">Mock Interviews</button>
                    </div>

                    <!-- Questions Tab -->
                    <div id="questionsTab" class="tech-tab-content" style="display: block;">
                        <button class="add-story-btn" onclick="addTechnicalQuestion()">
                            <i class="ph ph-plus-circle"></i> Add Question
                        </button>
                        <div id="questionsContainer" class="tech-items-container">
                            <!-- Technical questions will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- Company Research Tab -->
                    <div id="researchTab" class="tech-tab-content" style="display: none;">
                        <button class="add-story-btn" onclick="addCompanyResearch()">
                            <i class="ph ph-plus-circle"></i> Add Company
                        </button>
                        <div id="researchContainer" class="tech-items-container">
                            <!-- Company research will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- Mock Interviews Tab -->
                    <div id="mockTab" class="tech-tab-content" style="display: none;">
                        <button class="add-story-btn" onclick="addMockSession()">
                            <i class="ph ph-plus-circle"></i> Schedule Session
                        </button>
                        <div id="mockContainer" class="tech-items-container">
                            <!-- Mock interview sessions will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Opportunities Slideout Content -->
            <div class="slideout-body" id="jobOpportunitiesContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <button class="add-story-btn" onclick="addJobOpportunity()" style="flex: 0 0 auto;">
                        <i class="ph ph-plus-circle"></i> Add Job
                    </button>
                    <div class="job-view-toggle" style="margin-left: auto;">
                        <button id="jobCardViewBtn" class="view-toggle-btn active" onclick="switchJobView('cards')">
                            <i class="ph ph-squares-four"></i> Cards
                        </button>
                        <button id="jobTableViewBtn" class="view-toggle-btn" onclick="switchJobView('table')">
                            <i class="ph ph-table"></i> Table
                        </button>
                    </div>
                </div>

                <!-- Cards View -->
                <div id="jobsContainer" class="stories-container">
                    <!-- Job opportunity cards will be dynamically inserted here -->
                </div>

                <!-- Table View -->
                <div id="jobsTableContainer" style="display: none; overflow-x: auto;">
                    <table class="jobs-table">
                        <thead>
                            <tr>
                                <th style="width: 22%;">Position</th>
                                <th style="width: 18%;">Company</th>
                                <th style="width: 12%;">Status</th>
                                <th style="width: 12%;">Close Date</th>
                                <th style="width: 19%;">Next Action</th>
                                <th style="width: 9%;">Alerts</th>
                                <th style="width: 8%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody">
                            <!-- Job rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Career Experience Slideout Content -->
            <div class="slideout-body" id="careerExperienceContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="linkedin-connect-btn" onclick="connectLinkedIn()" style="flex: 0 0 auto;">
                        <i class="ph ph-linkedin-logo"></i> Connect LinkedIn
                    </button>
                    <button class="upload-resume-btn" onclick="uploadResume()" style="flex: 0 0 auto;">
                        <i class="ph ph-file-arrow-up"></i> Upload Resume
                    </button>
                    <button class="add-story-btn" onclick="addExperienceRecord()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Add Experience
                    </button>
                </div>
                <div id="experiencesContainer" class="stories-container">
                    <!-- Experience cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Application Materials Slideout Content -->
            <div class="slideout-body" id="applicationMaterialsContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="add-story-btn" onclick="generateMaterial()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-sparkle"></i> Generate
                    </button>
                    <button class="upload-resume-btn" onclick="uploadMaterial()" style="flex: 0 0 auto;">
                        <i class="ph ph-file-arrow-up"></i> Upload
                    </button>
                </div>
                <div id="materialsContainer" class="stories-container">
                    <!-- Application material cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Portfolio Slideout Content -->
            <div class="slideout-body" id="portfolioContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="add-story-btn" onclick="addPortfolioProject()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Add Project
                    </button>
                    <button class="upload-resume-btn" onclick="importFromGitHub()" style="flex: 0 0 auto;">
                        <i class="ph ph-github-logo"></i> Import from GitHub
                    </button>
                    <button class="upload-resume-btn" onclick="connectToCodePen()" style="flex: 0 0 auto;">
                        <i class="ph ph-code"></i> Connect to CodePen
                    </button>
                </div>
                <div id="portfolioContainer" class="stories-container">
                    <!-- Portfolio project cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Skills & Competencies Slideout Content -->
            <div class="slideout-body" id="skillsCompetenciesContent" style="display: none;">
                <!-- Improvement Goals Pills -->
                <div id="improvementGoalsSection" style="margin-bottom: 24px; padding: 16px; background: #f8f8f8; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Areas for Improvement</div>
                    <div id="improvementGoalsPills" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- Goal pills will be dynamically inserted here -->
                    </div>
                </div>

                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <button class="add-story-btn" onclick="addCustomSkill()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Add Skill/Competency
                    </button>
                    <button class="upload-resume-btn" onclick="syncFromExperience()" style="flex: 0 0 auto;">
                        <i class="ph ph-arrows-clockwise"></i> Sync from Experience
                    </button>
                    <div style="margin-left: auto; font-size: 11px; color: #666;">
                        <strong>Rating Scale:</strong> 1=Beginner, 2=Intermediate, 3=Advanced, 4=Expert, 5=Master
                    </div>
                </div>
                <div id="skillsCompetenciesContainer" style="display: flex; flex-direction: column; gap: 12px; overflow-y: auto;">
                    <!-- Skills and competencies will be dynamically inserted here -->
                </div>
            </div>

            <!-- Projects Slideout Content -->
            <div class="slideout-body" id="projectsContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="add-story-btn" onclick="addProjectRepo()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Connect Repository
                    </button>
                    <button class="upload-resume-btn" onclick="scanLocalRepos()" style="flex: 0 0 auto;">
                        <i class="ph ph-folder-open"></i> Scan Local Directories
                    </button>
                </div>
                <div id="projectsContainer" class="stories-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                    <!-- Project repo cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- My Notes Slideout Content -->
            <div class="slideout-body" id="myNotesContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <button class="add-story-btn" onclick="addNote()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Add Note
                    </button>
                    <input type="text" id="notesSearchInput" placeholder="Search notes..." oninput="searchNotes()" style="flex: 1; padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                </div>
                <div id="notesContainer" class="stories-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                    <!-- Note cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Calendar Content -->
            <div class="slideout-body" id="calendarContent" style="display: none;">
                <!-- Calendar Header with View Switcher -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; gap: 8px;">
                        <button id="dailyViewBtn" onclick="switchCalendarView('daily')" class="calendar-view-btn calendar-view-btn-green active">Daily</button>
                        <button id="weeklyViewBtn" onclick="switchCalendarView('weekly')" class="calendar-view-btn calendar-view-btn-green">Weekly</button>
                        <button id="monthlyViewBtn" onclick="switchCalendarView('monthly')" class="calendar-view-btn calendar-view-btn-green">Monthly</button>
                    </div>

                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="navigateCalendar('prev')" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; font-family: var(--font-family-heading); font-size: 14px;">
                            <i class="ph ph-caret-left"></i>
                        </button>
                        <button onclick="navigateCalendar('today')" style="padding: 6px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600;">
                            Today
                        </button>
                        <button onclick="navigateCalendar('next')" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; font-family: var(--font-family-heading); font-size: 14px;">
                            <i class="ph ph-caret-right"></i>
                        </button>
                        <span id="calendarDateRange" style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-left: 8px;">
                            <!-- Date range will be set by JS -->
                        </span>
                    </div>

                    <div style="display: flex; gap: 8px;">
                        <button onclick="openAddEventForm()" class="add-story-btn" style="margin: 0; background: #16a34a;">
                            <i class="ph ph-plus-circle"></i> Add Event
                        </button>
                        <button onclick="openCalendarSettings()" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer;">
                            <i class="ph ph-gear" style="font-size: 18px; color: var(--color-neutral-text);"></i>
                        </button>
                    </div>
                </div>

                <!-- Calendar Display Area -->
                <div id="calendarDisplayArea" style="background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px; min-height: 500px;">
                    <!-- Calendar views will be rendered here -->
                </div>
            </div>

            <!-- Recipes Content -->
            <div class="slideout-body" id="recipesContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="recipesSearchInput" placeholder="Search recipes..." oninput="searchRecipes()" style="flex: 1; padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    <select id="cuisineFilterSelect" onchange="filterRecipes()" style="padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                        <option value="">All Cuisines</option>
                    </select>
                    <select id="mealTypeFilterSelect" onchange="filterRecipes()" style="padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                        <option value="">All Meal Types</option>
                    </select>
                </div>
                <div id="recipesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                    <!-- Recipe cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Finance Content -->
            <div class="slideout-body" id="financeContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; justify-content: space-between;">
                    <div style="display: flex; gap: 8px; position: relative;">
                        <button id="connectInstitutionBtn" onmouseenter="showConnectInstitutionTooltip()" onmouseleave="hideConnectInstitutionTooltip()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                            <i class="ph ph-link"></i> Connect Institution
                        </button>

                        <!-- Hover Tooltip for Connect Institution -->
                        <div id="connectInstitutionTooltip" onmouseenter="keepConnectInstitutionTooltip()" onmouseleave="hideConnectInstitutionTooltip()" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 16px; width: 320px; z-index: 1100;">
                            <h4 style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 12px 0;">
                                Connect Financial Institution
                            </h4>

                            <input type="text" id="institutionSearchTooltip" placeholder="Search for your institution..." style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; margin-bottom: 12px;">

                            <div style="max-height: 250px; overflow-y: auto; margin-bottom: 12px;">
                                <!-- Banks -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase;">Banks</div>
                                <div onclick="selectInstitution('Chase')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Chase
                                </div>
                                <div onclick="selectInstitution('Bank of America')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Bank of America
                                </div>
                                <div onclick="selectInstitution('Wells Fargo')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Wells Fargo
                                </div>
                                <div onclick="selectInstitution('Citi')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Citi
                                </div>
                                <div onclick="selectInstitution('Capital One')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Capital One
                                </div>
                                <div onclick="selectInstitution('US Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> US Bank
                                </div>
                                <div onclick="selectInstitution('PNC Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> PNC Bank
                                </div>
                                <div onclick="selectInstitution('TD Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> TD Bank
                                </div>
                                <div onclick="selectInstitution('Truist Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Truist Bank
                                </div>
                                <div onclick="selectInstitution('Ally Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Ally Bank
                                </div>

                                <!-- Credit Cards -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase; margin-top: 8px;">Credit Cards</div>
                                <div onclick="selectInstitution('American Express')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-credit-card" style="margin-right: 6px; color: #16a34a;"></i> American Express
                                </div>
                                <div onclick="selectInstitution('Discover')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-credit-card" style="margin-right: 6px; color: #16a34a;"></i> Discover
                                </div>

                                <!-- Investment & Brokerage -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase; margin-top: 8px;">Investment & Brokerage</div>
                                <div onclick="selectInstitution('Fidelity')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Fidelity
                                </div>
                                <div onclick="selectInstitution('Vanguard')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Vanguard
                                </div>
                                <div onclick="selectInstitution('Charles Schwab')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Charles Schwab
                                </div>
                                <div onclick="selectInstitution('E*TRADE')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> E*TRADE
                                </div>
                                <div onclick="selectInstitution('TD Ameritrade')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> TD Ameritrade
                                </div>
                                <div onclick="selectInstitution('Robinhood')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Robinhood
                                </div>
                                <div onclick="selectInstitution('Betterment')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Betterment
                                </div>
                                <div onclick="selectInstitution('Wealthfront')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Wealthfront
                                </div>

                                <!-- Payment & Transfer -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase; margin-top: 8px;">Payment & Transfer</div>
                                <div onclick="selectInstitution('PayPal')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> PayPal
                                </div>
                                <div onclick="selectInstitution('Venmo')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Venmo
                                </div>
                                <div onclick="selectInstitution('Cash App')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Cash App
                                </div>
                                <div onclick="selectInstitution('Zelle')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Zelle
                                </div>
                                <div onclick="selectInstitution('Apple Pay')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Apple Pay
                                </div>
                                <div onclick="selectInstitution('Google Pay')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Google Pay
                                </div>

                                <!-- Insurance -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase; margin-top: 8px;">Insurance</div>
                                <div onclick="selectInstitution('State Farm')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> State Farm
                                </div>
                                <div onclick="selectInstitution('Geico')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Geico
                                </div>
                                <div onclick="selectInstitution('Allstate')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Allstate
                                </div>
                                <div onclick="selectInstitution('Progressive')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Progressive
                                </div>
                                <div onclick="selectInstitution('Liberty Mutual')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Liberty Mutual
                                </div>
                                <div onclick="selectInstitution('USAA')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> USAA
                                </div>
                                <div onclick="selectInstitution('Farmers Insurance')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Farmers Insurance
                                </div>
                                <div onclick="selectInstitution('Nationwide')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Nationwide
                                </div>
                                <div onclick="selectInstitution('Travelers')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Travelers
                                </div>
                                <div onclick="selectInstitution('MetLife')" style="padding: 8px; cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> MetLife
                                </div>
                            </div>

                            <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin: 0;">
                                <i class="ph ph-lock"></i> Bank-level security
                            </p>
                        </div>

                        <div style="position: relative;">
                            <button id="manualAccountBtn" onmouseenter="showManualAccountTooltip()" onmouseleave="hideManualAccountTooltip()" style="padding: 8px 16px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                                <i class="ph ph-plus-circle"></i> Manual Account
                            </button>

                            <!-- Hover Tooltip for Manual Account -->
                            <div id="manualAccountTooltip" onmouseenter="keepManualAccountTooltip()" onmouseleave="hideManualAccountTooltip()" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 16px; width: 400px; z-index: 1100; max-height: 500px; overflow-y: auto;">
                                <h4 style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 12px 0;">
                                    Create Manual Account
                                </h4>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Account Type *</label>
                                    <select id="accountTypeTooltip" onchange="updateAccountTypeFieldsTooltip()" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                        <option value="">Select type...</option>
                                        <option value="Asset">Asset</option>
                                        <option value="Investment">Investment</option>
                                        <option value="Cash Flow">Cash Flow</option>
                                        <option value="Insurance">Insurance</option>
                                        <option value="Liability">Liability</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Account Name *</label>
                                    <input type="text" id="accountNameTooltip" placeholder="e.g., Primary Checking" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Institution/Provider</label>
                                    <input type="text" id="accountInstitutionTooltip" placeholder="e.g., Chase" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Current Balance/Value *</label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 8px; top: 8px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">$</span>
                                        <input type="number" id="accountBalanceTooltip" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px 8px 8px 20px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                    </div>
                                </div>

                                <!-- Asset-specific fields -->
                                <div id="assetFieldsTooltip" style="display: none; margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Asset Category</label>
                                    <select id="assetCategoryTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                        <option value="Real Estate">Real Estate</option>
                                        <option value="Vehicle">Vehicle</option>
                                        <option value="Savings">Savings Account</option>
                                        <option value="Checking">Checking Account</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <!-- Investment-specific fields -->
                                <div id="investmentFieldsTooltip" style="display: none; margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Investment Type</label>
                                    <select id="investmentTypeTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                        <option value="401(k)">401(k)</option>
                                        <option value="IRA">IRA</option>
                                        <option value="Roth IRA">Roth IRA</option>
                                        <option value="Brokerage">Brokerage Account</option>
                                        <option value="Stocks">Individual Stocks</option>
                                        <option value="Bonds">Bonds</option>
                                        <option value="Crypto">Cryptocurrency</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <!-- Cash Flow-specific fields -->
                                <div id="cashFlowFieldsTooltip" style="display: none;">
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Flow Type</label>
                                        <select id="cashFlowTypeTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                            <option value="Income">Income</option>
                                            <option value="Expense">Expense</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Frequency</label>
                                        <select id="cashFlowFrequencyTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                            <option value="Monthly">Monthly</option>
                                            <option value="Biweekly">Biweekly</option>
                                            <option value="Weekly">Weekly</option>
                                            <option value="Annually">Annually</option>
                                            <option value="One-time">One-time</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Insurance-specific fields -->
                                <div id="insuranceFieldsTooltip" style="display: none;">
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Insurance Type</label>
                                        <select id="insuranceTypeTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                            <option value="Life">Life Insurance</option>
                                            <option value="Health">Health Insurance</option>
                                            <option value="Auto">Auto Insurance</option>
                                            <option value="Home">Home/Renters Insurance</option>
                                            <option value="Disability">Disability Insurance</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Policy Number</label>
                                        <input type="text" id="insurancePolicyNumberTooltip" placeholder="Policy #" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Premium (per year)</label>
                                        <div style="position: relative;">
                                            <span style="position: absolute; left: 8px; top: 8px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">$</span>
                                            <input type="number" id="insurancePremiumTooltip" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px 8px 8px 20px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Liability-specific fields -->
                                <div id="liabilityFieldsTooltip" style="display: none;">
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Liability Type</label>
                                        <select id="liabilityTypeTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                            <option value="Mortgage">Mortgage</option>
                                            <option value="Auto Loan">Auto Loan</option>
                                            <option value="Student Loan">Student Loan</option>
                                            <option value="Credit Card">Credit Card</option>
                                            <option value="Personal Loan">Personal Loan</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Interest Rate (%)</label>
                                        <input type="number" id="liabilityInterestRateTooltip" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Monthly Payment</label>
                                        <div style="position: relative;">
                                            <span style="position: absolute; left: 8px; top: 8px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">$</span>
                                            <input type="number" id="liabilityPaymentTooltip" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px 8px 8px 20px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Notes</label>
                                    <textarea id="accountNotesTooltip" placeholder="Additional details..." rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; resize: vertical;"></textarea>
                                </div>

                                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                    <button onclick="clearManualAccountTooltipForm()" style="padding: 8px 16px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; cursor: pointer;">
                                        Clear
                                    </button>
                                    <button onclick="saveFinanceAccountFromTooltip()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; cursor: pointer;">
                                        <i class="ph ph-check-circle"></i> Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <select id="financeFilterSelect" onchange="filterFinanceAccounts()" style="padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                        <option value="">All Account Types</option>
                        <option value="Asset">Assets</option>
                        <option value="Investment">Investments</option>
                        <option value="Cash Flow">Cash Flow</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Liability">Liabilities</option>
                    </select>
                </div>

                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <div style="background: #dcfce7; border: 1px solid #16a34a; border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Total Assets</div>
                        <div id="totalAssets" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: #16a34a;">$0</div>
                    </div>
                    <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Total Liabilities</div>
                        <div id="totalLiabilities" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: #ef4444;">$0</div>
                    </div>
                    <div style="background: var(--color-neutral-background); border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Net Worth</div>
                        <div id="netWorth" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: var(--color-neutral-text);">$0</div>
                    </div>
                </div>

                <!-- Accounts List -->
                <div id="financeAccountsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Account cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="shoppingContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; justify-content: space-between;">
                    <button onclick="addShoppingItem()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                        <i class="ph ph-plus"></i> Add Item
                    </button>

                    <select id="shoppingFilterSelect" onchange="filterShoppingItems()" style="padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                        <option value="">All Categories</option>
                        <option value="Grocery">Grocery</option>
                        <option value="Home">Home</option>
                        <option value="Internet">Internet</option>
                        <option value="Gifts">Gifts</option>
                    </select>
                </div>

                <!-- Shopping Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <div style="background: #dcfce7; border: 1px solid #16a34a; border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Total Items</div>
                        <div id="totalShoppingItems" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: #16a34a;">0</div>
                    </div>
                    <div style="background: var(--color-neutral-background); border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Estimated Total</div>
                        <div id="estimatedShoppingTotal" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: var(--color-neutral-text);">$0</div>
                    </div>
                </div>

                <div id="shoppingItemsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Shopping items will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="tablesContent" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">
                        Structured data tables with typed columns for organizing professional information.
                    </p>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openTableGuidedSetup()" style="padding: 8px 16px; background: white; color: var(--color-primary-blue); border: 2px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; transition: all 0.2s;">
                            <i class="ph ph-magic-wand" style="font-size: 16px;"></i>
                            Guided Setup
                        </button>
                        <button onclick="openTableWizard()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                            <i class="ph ph-plus" style="font-size: 16px;"></i>
                            New Table
                        </button>
                    </div>
                </div>

                <!-- Tables Tabs -->
                <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--color-neutral-border);">
                    <button id="tablesCardsTab" onclick="switchTablesView('cards')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid var(--color-primary-blue); color: var(--color-primary-blue); font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer;">
                        Cards
                    </button>
                    <button id="tablesRelationshipsTab" onclick="switchTablesView('relationships')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-neutral-text); font-family: var(--font-family-heading); font-size: 14px; cursor: pointer;">
                        Relationships
                    </button>
                </div>

                <!-- Cards View -->
                <div id="tablesCardsView" style="display: block;">
                    <div id="tablesContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- Table type cards will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Relationships View (ERD) -->
                <div id="tablesRelationshipsView" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); margin: 0;">
                            Entity Relationship Diagram showing how tables connect to each other
                        </p>
                        <button onclick="openRelationshipManager()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-arrows-left-right"></i> Manage Relationships
                        </button>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 24px; border: 1px solid var(--color-neutral-border); position: relative;">
                        <!-- Zoom Controls -->
                        <div id="erdZoomControls" style="position: absolute; top: 32px; right: 32px; z-index: 10; display: flex; flex-direction: column; gap: 4px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); opacity: 0; pointer-events: none; transition: opacity 0.2s;">
                            <!-- Zoom Level Indicator -->
                            <div id="erdZoomLevel" style="padding: 4px 8px; text-align: center; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); background: #f8f9fa; border-radius: 4px; margin: 4px;">
                                100%
                            </div>
                            <button onclick="zoomERD('in')" title="Zoom In" style="padding: 8px; border: none; background: white; cursor: pointer; border-radius: 6px; color: var(--color-neutral-text); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-neutral-text)';">
                                <i class="ph ph-magnifying-glass-plus" style="font-size: 18px;"></i>
                            </button>
                            <button onclick="zoomERD('out')" title="Zoom Out" style="padding: 8px; border: none; background: white; cursor: pointer; border-radius: 6px; color: var(--color-neutral-text); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-neutral-text)';">
                                <i class="ph ph-magnifying-glass-minus" style="font-size: 18px;"></i>
                            </button>
                            <button onclick="zoomERD('reset')" title="Reset Zoom" style="padding: 8px; border: none; background: white; cursor: pointer; border-radius: 6px; color: var(--color-neutral-text); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-neutral-text)';">
                                <i class="ph ph-house" style="font-size: 18px;"></i>
                            </button>
                            <button onclick="zoomERD('fit')" title="Fit to Screen" style="padding: 8px; border: none; background: white; cursor: pointer; border-radius: 6px; color: var(--color-neutral-text); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-neutral-text)';">
                                <i class="ph ph-arrows-out" style="font-size: 18px;"></i>
                            </button>
                        </div>

                        <div id="tablesERDContainer" style="width: 100%; height: 600px; position: relative; border-radius: 8px; border: 1px solid var(--color-neutral-border); overflow: hidden;"
                             onmouseenter="showERDZoomControls()"
                             onmouseleave="hideERDZoomControls()">
                            <!-- ERD will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="slideout-body" id="formsContent" style="display: none;">
                <button class="add-story-btn" onclick="openFormDesigner()">
                    <i class="ph ph-plus-circle"></i> New Form
                </button>
                <div id="formsContainer" class="stories-container">
                    <!-- Form cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="documentsContent" style="display: none;">
                <button class="add-story-btn" onclick="openDocumentEditor()">
                    <i class="ph ph-plus-circle"></i> New Document
                </button>
                <div id="documentsContainer">
                    <!-- Document cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="reportsContent" style="display: none;">
                <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 24px;">
                    Analytics and reporting dashboards for data visualization and insights.
                </p>
                <div id="reportsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Report type cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="templatesContent" style="display: none;">
                <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 24px;">
                    Reusable templates for standardizing documents, emails, and workflows.
                </p>
                <div id="templatesContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Template type cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="pipelinesContent" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">
                        ML pipelines for automated content transformation and multi-format delivery.
                    </p>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openSimplePipelineWizard()" style="padding: 8px 16px; background: white; color: var(--color-primary-blue); border: 2px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; transition: all 0.2s;">
                            <i class="ph ph-magic-wand" style="font-size: 16px;"></i>
                            Guided Setup
                        </button>
                        <button onclick="openPipelineWizard()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                            <i class="ph ph-plus" style="font-size: 16px;"></i>
                            New Pipeline
                        </button>
                    </div>
                </div>
                <div id="pipelinesContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Pipeline cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="workflowsContent" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">
                        Automated workflows and business process automation tools.
                    </p>
                    <button onclick="openNewWorkflowModal()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                        <i class="ph ph-plus"></i>
                        New Workflow
                    </button>
                </div>
                <div id="workflowsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Workflow type cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Documents Slideout Content -->
            <div class="slideout-body" id="documentsContent" style="display: none;">
                <button class="add-story-btn" onclick="openDocumentEditor()">
                    <i class="ph ph-plus-circle"></i> New Document
                </button>
                <div id="documentsContainer" class="stories-container">
                    <!-- Document cards will be dynamically inserted here -->
                </div>
            </div>
        </div> <!-- End interview-slideout -->

    <!-- Story Form Modal (Inside Canvas Modal) -->
    <div class="story-form-modal" id="storyFormModal">
        <div class="story-form-content">
            <div class="story-form-header">
                <h3 id="formTitle">Add Behavioral Story</h3>
                <button class="story-form-close" onclick="closeStoryForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="storyForm" onsubmit="saveStory(event)">
                    <div class="form-group">
                        <label>Story Title / Competency</label>
                        <input type="text" id="storyTitle" required placeholder="e.g., Leadership Under Pressure">
                    </div>

                    <div class="form-group">
                        <label>Related Job Experience</label>
                        <select id="storyExperience">
                            <option value="">Select an experience...</option>
                            <!-- Will be populated from persona data -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Situation</label>
                        <textarea id="storySituation" rows="2" required placeholder="Describe the context and challenge..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Task</label>
                        <textarea id="storyTask" rows="2" required placeholder="What was your responsibility or goal?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Action</label>
                        <textarea id="storyAction" rows="2" required placeholder="What specific actions did you take?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Result</label>
                        <textarea id="storyResult" rows="2" required placeholder="What was the outcome? Include metrics if possible."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Key Competencies Demonstrated</label>
                        <input type="text" id="storyCompetencies" placeholder="e.g., Leadership, Problem Solving, Communication">
                        <small>Comma-separated list</small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeStoryForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Story</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End story-form-modal -->

    <!-- Job Form Modal -->
    <div class="story-form-modal" id="jobFormModal">
        <div class="story-form-content">
            <div class="story-form-header">
                <h3 id="jobFormTitle">Add Job Opportunity</h3>
                <button class="story-form-close" onclick="closeJobForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="jobForm" onsubmit="saveJob(event)">
                    <!-- URL paste option -->
                    <div class="form-group">
                        <label>Paste Job URL (Optional)</label>
                        <input type="url" id="jobUrl" placeholder="https://...">
                        <small>We'll try to extract job details automatically</small>
                    </div>

                    <!-- Manual entry fields -->
                    <div class="form-group">
                        <label>Job Title</label>
                        <input type="text" id="jobTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" id="jobCompany" required>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="jobLocation">
                    </div>
                    <div class="form-group">
                        <label>Salary</label>
                        <input type="text" id="jobSalary" placeholder="e.g., $120K, $80-100K">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="jobStatus">
                            <option value="interested">Interested</option>
                            <option value="applied">Applied</option>
                            <option value="interviewing">Interviewing</option>
                            <option value="offer">Offer</option>
                            <option value="rejected">Rejected</option>
                            <option value="not-interested">Not Interested</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Close Date (Optional)</label>
                        <input type="date" id="jobCloseDate" placeholder="When is this opportunity closing?">
                        <small style="color: var(--color-neutral-text-light); font-size: 11px;">Application deadline or when opportunity ends</small>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="jobNotes" rows="2"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeJobForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Job</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End job-form-modal -->

    <!-- Job Detail Modal -->
    <div class="job-detail-modal" id="jobDetailModal">
        <div class="job-detail-content">
            <div class="job-detail-header">
                <h3 id="jobDetailTitle">Job Details</h3>
                <button class="job-detail-close" onclick="closeJobDetail()">&times;</button>
            </div>
            <div class="job-detail-body">
                <!-- Job Info Section -->
                <div class="job-detail-section">
                    <h4><i class="ph ph-briefcase"></i> Job Information</h4>
                    <div class="job-status-editor" style="display: grid; grid-template-columns: auto 1fr auto 1fr; gap: 12px; align-items: center;">
                        <label for="jobDetailStatus" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Status:</label>
                        <select id="jobDetailStatus" class="job-status-select" onchange="updateJobStatus()">
                            <option value="interested">Interested</option>
                            <option value="applied">Applied</option>
                            <option value="interviewing">Interviewing</option>
                            <option value="offer">Offer</option>
                            <option value="rejected">Rejected</option>
                            <option value="not-interested">Not Interested</option>
                        </select>
                        <label for="jobDetailCloseDate" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Close Date:</label>
                        <input type="date" id="jobDetailCloseDate" class="job-status-select" onchange="updateJobCloseDate()" style="border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 6px 8px; font-size: 12px;">
                    </div>
                    <div id="jobDetailInfo" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 13px;">
                        <!-- Job details will be populated here -->
                    </div>
                </div>

                <!-- Job Todo Checklist Section -->
                <div class="job-detail-section">
                    <h4><i class="ph ph-check-square"></i> Application Checklist</h4>
                    <div id="jobTodoList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                        <!-- Todo items will be populated here -->
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="addJobTodo()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="ph ph-plus"></i> Add Task
                        </button>
                        <button onclick="setJobDeadlines()" style="padding: 6px 12px; background: #16a34a; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="ph ph-calendar"></i> Set Deadlines
                        </button>
                    </div>
                </div>

                <!-- Application Materials Section -->
                <div class="job-detail-section">
                    <h4><i class="ph ph-file-text"></i> Application Materials</h4>
                    <div id="jobApplicationMaterials" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
                        <!-- Application materials will be populated here -->
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="generateJobMaterial()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="ph ph-sparkle"></i> Generate
                        </button>
                        <button onclick="uploadJobMaterial()" style="padding: 6px 12px; background: #16a34a; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="ph ph-file-arrow-up"></i> Upload
                        </button>
                    </div>
                </div>

                <!-- Skills & Competencies Section -->
                <div class="job-detail-section">
                    <h4><i class="ph ph-gear"></i> Required Skills & Competencies</h4>
                    <div class="skills-competencies-grid">
                        <div>
                            <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">Required Skills</h5>
                            <div id="jobDetailSkills" class="skill-comp-list">
                                <!-- Skills will be populated here -->
                            </div>
                        </div>
                        <div>
                            <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">Key Competencies</h5>
                            <div id="jobDetailCompetencies" class="skill-comp-list">
                                <!-- Competencies will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <button onclick="addJobSkill()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="ph ph-plus"></i> Add Skill
                        </button>
                        <button onclick="addJobCompetency()" style="padding: 6px 12px; background: var(--color-accent-blue); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="ph ph-plus"></i> Add Competency
                        </button>
                    </div>
                </div>

                <!-- Fit Analysis Section -->
                <div class="job-detail-section fit-analysis-section">
                    <h4><i class="ph ph-target"></i> Fit Analysis</h4>
                    <div class="fit-score" id="overallFitScore">
                        <div class="fit-score-circle" id="fitScoreCircle">85%</div>
                        <div class="fit-score-details">
                            <h5>Overall Fit Score</h5>
                            <p>Strong match based on your skills and experience</p>
                        </div>
                    </div>
                    <div class="fit-dimensions" id="fitDimensions">
                        <!-- Fit analysis dimensions will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End job-detail-modal -->

    <!-- Project Repository Form Modal -->
    <div class="story-form-modal" id="projectFormModal">
        <div class="story-form-content">
            <div class="story-form-header">
                <h3 id="projectFormTitle">Connect Project Repository</h3>
                <button class="story-form-close" onclick="closeProjectForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="projectForm" onsubmit="saveProject(event)">
                    <div class="form-group">
                        <label>Project Name</label>
                        <input type="text" id="projectName" required placeholder="e.g., E-Commerce Dashboard">
                    </div>

                    <div class="form-group">
                        <label>Local Directory Path</label>
                        <input type="text" id="projectPath" required placeholder="C:\Users\username\projects\my-project">
                        <small>Path to your local repository folder</small>
                    </div>

                    <div class="form-group">
                        <label>Repository URL (Optional)</label>
                        <input type="url" id="projectRepoUrl" placeholder="https://github.com/username/repo">
                        <small>GitHub, GitLab, or other remote repository</small>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="projectDescription" rows="3" placeholder="Brief description of the project..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Technologies</label>
                        <input type="text" id="projectTechnologies" placeholder="React, Node.js, PostgreSQL">
                        <small>Comma-separated list (will be color-coded)</small>
                    </div>

                    <div class="form-group">
                        <label>Topics/Categories</label>
                        <input type="text" id="projectTopics" placeholder="Web Development, Full Stack, E-Commerce">
                        <small>Comma-separated list (will be color-coded)</small>
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <select id="projectStatus">
                            <option value="active">Active Development</option>
                            <option value="completed">Completed</option>
                            <option value="archived">Archived</option>
                            <option value="planning">Planning</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeProjectForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Project</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End project-form-modal -->

    <!-- My Notes Form Modal -->
    <div class="story-form-modal" id="noteFormModal">
        <div class="story-form-content">
            <div class="story-form-header">
                <h3 id="noteFormTitle">Add Note</h3>
                <button class="story-form-close" onclick="closeNoteForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="noteForm" onsubmit="saveNote(event)">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="noteTitle" required placeholder="e.g., React Hooks Best Practices">
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <select id="noteCategory">
                            <option value="learning">Learning</option>
                            <option value="idea">Idea</option>
                            <option value="question">Question</option>
                            <option value="reference">Reference</option>
                            <option value="todo">To-Do</option>
                            <option value="general">General</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tags (Optional)</label>
                        <input type="text" id="noteTags" placeholder="react, javascript, hooks">
                        <small>Comma-separated list</small>
                    </div>

                    <div class="form-group">
                        <label>Content</label>
                        <textarea id="noteContent" rows="12" required placeholder="Write your note here..."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeNoteForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End note-form-modal -->

    <!-- Calendar Event Form Modal -->
    <div class="story-form-modal" id="eventFormModal">
        <div class="story-form-content" style="max-width: 600px;">
            <div class="story-form-header">
                <h3 id="eventFormTitle">Add Event</h3>
                <button class="story-form-close" onclick="closeEventForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="eventForm" onsubmit="saveEvent(event)">
                    <div class="form-group">
                        <label>Event Title</label>
                        <input type="text" id="eventTitle" required placeholder="e.g., Team Meeting">
                    </div>

                    <div class="form-group">
                        <label>Event Type</label>
                        <select id="eventType" onchange="updateEventTypeFields()">
                            <option value="allday">All-Day Event</option>
                            <option value="datetime">Date & Time Event</option>
                            <option value="time">Time-Only Event</option>
                        </select>
                    </div>

                    <div class="form-group" id="eventDateField">
                        <label>Date</label>
                        <input type="date" id="eventDate" required>
                    </div>

                    <div class="form-group" id="eventStartTimeField" style="display: none;">
                        <label>Start Time</label>
                        <input type="time" id="eventStartTime">
                    </div>

                    <div class="form-group" id="eventEndTimeField" style="display: none;">
                        <label>End Time</label>
                        <input type="time" id="eventEndTime">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="eventRecurring" onchange="toggleRecurringFields()">
                            Recurring Event
                        </label>
                    </div>

                    <div id="recurringFields" style="display: none;">
                        <div class="form-group">
                            <label>Recurrence Pattern</label>
                            <select id="recurrencePattern">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Repeat Every</label>
                            <input type="number" id="recurrenceInterval" value="1" min="1" style="width: 80px;">
                            <span id="recurrenceUnitLabel">day(s)</span>
                        </div>

                        <div class="form-group">
                            <label>Ends</label>
                            <select id="recurrenceEndType" onchange="toggleRecurrenceEnd()">
                                <option value="never">Never</option>
                                <option value="date">On Date</option>
                                <option value="count">After Occurrences</option>
                            </select>
                        </div>

                        <div class="form-group" id="recurrenceEndDateField" style="display: none;">
                            <label>End Date</label>
                            <input type="date" id="recurrenceEndDate">
                        </div>

                        <div class="form-group" id="recurrenceCountField" style="display: none;">
                            <label>Number of Occurrences</label>
                            <input type="number" id="recurrenceCount" value="10" min="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Location (Optional)</label>
                        <input type="text" id="eventLocation" placeholder="e.g., Conference Room A">
                    </div>

                    <div class="form-group">
                        <label>Description (Optional)</label>
                        <textarea id="eventDescription" rows="3" placeholder="Add details about this event..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Calendar</label>
                        <select id="eventCalendar">
                            <option value="personal">Personal</option>
                            <!-- External calendars will be added here -->
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeEventForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End event-form-modal -->

    <!-- Calendar Settings Modal -->
    <div class="story-form-modal" id="calendarSettingsModal">
        <div class="story-form-content" style="max-width: 700px;">
            <div class="story-form-header">
                <h3>Calendar Settings</h3>
                <button class="story-form-close" onclick="closeCalendarSettings()">&times;</button>
            </div>
            <div class="story-form-body">
                <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--color-neutral-border);">
                    <button id="syncTab" onclick="switchSettingsTab('sync')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid var(--color-primary-blue); color: var(--color-primary-blue); font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer;">
                        Sync & Import
                    </button>
                    <button id="exportTab" onclick="switchSettingsTab('export')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-neutral-text); font-family: var(--font-family-heading); font-size: 14px; cursor: pointer;">
                        Export
                    </button>
                    <button id="shareTab" onclick="switchSettingsTab('share')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-neutral-text); font-family: var(--font-family-heading); font-size: 14px; cursor: pointer;">
                        Sharing
                    </button>
                </div>

                <!-- Sync & Import Tab -->
                <div id="syncSettingsContent" style="display: block;">
                    <h4 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin-bottom: 12px;">Connected Calendars</h4>
                    <div id="connectedCalendars" style="margin-bottom: 24px;">
                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); font-style: italic;">
                            No external calendars connected.
                        </p>
                    </div>

                    <h4 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin-bottom: 12px;">Connect Calendar</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button onclick="connectGoogleCalendar()" style="padding: 10px 20px; background: #4285F4; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-google-logo"></i> Google Calendar
                        </button>
                        <button onclick="connectMicrosoftCalendar()" style="padding: 10px 20px; background: #0078D4; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-microsoft-outlook-logo"></i> Outlook / Microsoft 365
                        </button>
                        <button onclick="connectAppleCalendar()" style="padding: 10px 20px; background: #555; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-apple-logo"></i> Apple Calendar
                        </button>
                    </div>

                    <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light); margin-top: 12px;">
                        Two-way sync keeps your events synchronized across all connected calendars.
                    </p>
                </div>

                <!-- Export Tab -->
                <div id="exportSettingsContent" style="display: none;">
                    <h4 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin-bottom: 12px;">Export Calendar</h4>
                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 16px;">
                        Export your entire calendar or individual events in standard formats.
                    </p>

                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="exportCalendar('ics')" style="padding: 12px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="ph ph-calendar-blank" style="margin-right: 8px;"></i> iCalendar Format (.ics)</span>
                            <i class="ph ph-download-simple"></i>
                        </button>
                        <button onclick="exportCalendar('csv')" style="padding: 12px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="ph ph-file-csv" style="margin-right: 8px;"></i> CSV Spreadsheet (.csv)</span>
                            <i class="ph ph-download-simple"></i>
                        </button>
                        <button onclick="exportCalendar('json')" style="padding: 12px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="ph ph-code" style="margin-right: 8px;"></i> JSON Format (.json)</span>
                            <i class="ph ph-download-simple"></i>
                        </button>
                    </div>
                </div>

                <!-- Share Tab -->
                <div id="shareSettingsContent" style="display: none;">
                    <h4 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin-bottom: 12px;">Share Calendar</h4>
                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 16px;">
                        Generate a shareable link to allow others to view your calendar.
                    </p>

                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <input type="text" id="shareLink" readonly value="https://cleansheet.info/calendar/share/..." style="flex: 1; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; background: var(--color-neutral-background);">
                        <button onclick="copyShareLink()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                            <i class="ph ph-copy"></i> Copy
                        </button>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="checkbox" id="sharePublic" onchange="togglePublicSharing()">
                            Make calendar publicly accessible
                        </label>
                    </div>

                    <h4 style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; margin-bottom: 8px; margin-top: 24px;">Permissions</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="radio" name="sharePermission" value="view" checked>
                            View only (others can see events)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="radio" name="sharePermission" value="edit">
                            Can edit (others can add/modify events)
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End calendar-settings-modal -->

    <!-- Recipe Form Modal -->
    <div id="recipeFormModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="position: sticky; top: 0; background: white; z-index: 10; padding: 20px; border-bottom: 1px solid var(--color-neutral-border);">
                <h2 id="recipeFormTitle" style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: var(--color-neutral-text); margin: 0;">Add Recipe</h2>
            </div>

            <div style="padding: 20px;">
                <input type="hidden" id="recipeEditIndex" value="">

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Recipe Name *</label>
                    <input type="text" id="recipeName" placeholder="e.g., Chicken Tacos" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Cuisine</label>
                        <input type="text" id="recipeCuisine" placeholder="e.g., Mexican, Italian" list="cuisineList" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        <datalist id="cuisineList">
                            <option value="Mexican">
                            <option value="Italian">
                            <option value="Chinese">
                            <option value="Indian">
                            <option value="Thai">
                            <option value="American">
                            <option value="French">
                            <option value="Japanese">
                            <option value="Mediterranean">
                            <option value="Greek">
                        </datalist>
                    </div>

                    <div>
                        <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Meal Type</label>
                        <input type="text" id="recipeMealType" placeholder="e.g., Dinner, Snack" list="mealTypeList" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        <datalist id="mealTypeList">
                            <option value="Breakfast">
                            <option value="Lunch">
                            <option value="Dinner">
                            <option value="Snack">
                            <option value="Dessert">
                            <option value="Drink">
                            <option value="Appetizer">
                        </datalist>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Prep Time (minutes)</label>
                        <input type="number" id="recipePrepTime" placeholder="30" min="0" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>

                    <div>
                        <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Cook Time (minutes)</label>
                        <input type="number" id="recipeCookTime" placeholder="45" min="0" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Servings</label>
                    <input type="number" id="recipeServings" placeholder="4" min="1" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Ingredients *</label>
                    <textarea id="recipeIngredients" placeholder="One ingredient per line&#10;e.g.,&#10;2 cups flour&#10;1 lb chicken breast&#10;1 tsp salt" rows="6" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; resize: vertical;"></textarea>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Instructions *</label>
                    <textarea id="recipeInstructions" placeholder="One step per line&#10;e.g.,&#10;1. Preheat oven to 350°F&#10;2. Mix flour and salt in bowl&#10;3. Add water and knead dough" rows="8" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; resize: vertical;"></textarea>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Notes</label>
                    <textarea id="recipeNotes" placeholder="Any additional tips, variations, or notes about this recipe" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; resize: vertical;"></textarea>
                </div>
            </div>

            <div style="position: sticky; bottom: 0; background: white; border-top: 1px solid var(--color-neutral-border); padding: 16px; display: flex; gap: 8px; justify-content: flex-end;">
                <button onclick="closeRecipeForm()" style="padding: 10px 20px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="saveRecipe()" style="padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-check-circle"></i> Save Recipe
                </button>
            </div>
        </div>
    </div> <!-- End recipe-form-modal -->

    <!-- Pipeline Management Modal -->
    <div class="pipeline-mgmt-modal" id="pipelineMgmtModal">
        <div class="pipeline-mgmt-content">
            <div class="pipeline-mgmt-header">
                <h3 id="pipelineTitle">Pipeline Management</h3>
                <button class="pipeline-mgmt-close" onclick="closePipelineMgmtModal()">&times;</button>
            </div>
            <div class="pipeline-mgmt-body">
                <iframe id="pipelineMgmtFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div> <!-- End pipeline-mgmt-modal -->

    <!-- Pipeline Wizard Modal -->
    <div class="pipeline-wizard-modal" id="pipelineWizardModal">
        <div class="pipeline-wizard-content">
            <div class="pipeline-wizard-header">
                <h3>Create New ML Pipeline</h3>
                <button class="pipeline-wizard-close" onclick="closePipelineWizard()">&times;</button>
            </div>

            <!-- Step Indicator -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Basics</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Data Sources</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Configuration</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Output</div>
                </div>
            </div>

            <div class="pipeline-wizard-body">
                <!-- Step 1: Pipeline Basics -->
                <div class="wizard-step-content active" id="wizardStep1">
                    <h4 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin-bottom: 24px;">Pipeline Basics</h4>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Pipeline Name *</label>
                        <input type="text" id="pipelineName" placeholder="e.g., Customer Content Pipeline" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Pipeline Type *</label>
                        <select id="pipelineType" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="">Select pipeline type...</option>
                            <option value="content">Content Transformation</option>
                            <option value="document">Document Intelligence</option>
                            <option value="analytics">Analytics & Insights</option>
                            <option value="image">Image Recognition</option>
                            <option value="voice">Voice Processing</option>
                            <option value="video">Video Analysis</option>
                            <option value="translation">Translation & Localization</option>
                            <option value="sentiment">Sentiment Analysis</option>
                            <option value="custom">Custom Pipeline</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Description</label>
                        <textarea id="pipelineDescription" placeholder="Describe what this pipeline does and its purpose..." style="width: 100%; min-height: 100px; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Tags</label>
                        <input type="text" id="pipelineTags" placeholder="e.g., production, ml, content (comma-separated)" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                    </div>
                </div>

                <!-- Step 2: Data Sources -->
                <div class="wizard-step-content" id="wizardStep2">
                    <h4 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin-bottom: 24px;">Data Sources & Connections</h4>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Input Source *</label>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div class="source-option" onclick="selectSource('file')" style="padding: 16px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-folder-open" style="font-size: 32px; color: var(--color-primary-blue); display: block; margin-bottom: 8px;"></i>
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">File Services</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 4px;">Dropbox, OneDrive, Drive</div>
                            </div>

                            <div class="source-option" onclick="selectSource('database')" style="padding: 16px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-database" style="font-size: 32px; color: var(--color-primary-blue); display: block; margin-bottom: 8px;"></i>
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Database</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 4px;">SQL, NoSQL, Data Lake</div>
                            </div>

                            <div class="source-option" onclick="selectSource('api')" style="padding: 16px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-plugs-connected" style="font-size: 32px; color: var(--color-primary-blue); display: block; margin-bottom: 8px;"></i>
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">API Endpoint</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 4px;">REST, GraphQL, Webhook</div>
                            </div>

                            <div class="source-option" onclick="selectSource('stream')" style="padding: 16px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-broadcast" style="font-size: 32px; color: var(--color-primary-blue); display: block; margin-bottom: 8px;"></i>
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Real-time Stream</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 4px;">Event Hub, Kafka, IoT</div>
                            </div>
                        </div>

                        <div id="sourceDetails" style="display: none; padding: 16px; background: var(--color-neutral-background); border-radius: 8px; border: 1px solid var(--color-neutral-border);">
                            <!-- Source-specific configuration will appear here -->
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">LLM Provider (Optional)</label>
                        <select id="llmProvider" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="">None</option>
                            <option value="openai">OpenAI (GPT-4)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="azure">Azure OpenAI</option>
                            <option value="cohere">Cohere</option>
                            <option value="huggingface">Hugging Face</option>
                        </select>
                    </div>
                </div>

                <!-- Step 3: Processing Configuration -->
                <div class="wizard-step-content" id="wizardStep3">
                    <h4 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin-bottom: 24px;">Processing Configuration</h4>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Processing Frequency *</label>
                        <select id="processingFrequency" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="realtime">Real-time (immediate)</option>
                            <option value="continuous">Continuous (streaming)</option>
                            <option value="hourly">Hourly</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="manual">Manual trigger only</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Batch Size</label>
                        <input type="number" id="batchSize" placeholder="100" min="1" value="100" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin-top: 4px;">Number of items to process per batch</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Error Handling</label>
                        <select id="errorHandling" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="retry">Retry with exponential backoff</option>
                            <option value="skip">Skip failed items</option>
                            <option value="halt">Halt pipeline on error</option>
                            <option value="deadletter">Send to dead letter queue</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="enableLogging" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Enable detailed logging</span>
                        </label>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="enableMetrics" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Enable performance metrics</span>
                        </label>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Custom Parameters (JSON)</label>
                        <textarea id="customParams" placeholder='{"key": "value"}' style="width: 100%; min-height: 80px; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Step 4: Output Settings -->
                <div class="wizard-step-content" id="wizardStep4">
                    <h4 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin-bottom: 24px;">Output Settings & Delivery</h4>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Output Destinations *</label>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <label style="padding: 12px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="output-destination" value="storage" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Azure Storage</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">Blob containers</div>
                                </div>
                            </label>

                            <label style="padding: 12px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="output-destination" value="database" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Database</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">Cosmos DB, SQL</div>
                                </div>
                            </label>

                            <label style="padding: 12px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="output-destination" value="webhook" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Webhook</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">POST to endpoint</div>
                                </div>
                            </label>

                            <label style="padding: 12px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="output-destination" value="email" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Email Notification</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">On completion</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Output Format</label>
                        <select id="outputFormat" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="json">JSON</option>
                            <option value="xml">XML</option>
                            <option value="csv">CSV</option>
                            <option value="parquet">Parquet</option>
                            <option value="avro">Avro</option>
                            <option value="custom">Custom format</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Notification Emails</label>
                        <input type="text" id="notificationEmails" placeholder="email@example.com, another@example.com" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin-top: 4px;">Comma-separated email addresses for pipeline alerts</div>
                    </div>

                    <div style="padding: 16px; background: var(--color-neutral-background); border-radius: 8px; border-left: 4px solid var(--color-primary-blue);">
                        <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">
                            <i class="ph ph-info" style="margin-right: 6px;"></i>Ready to Create
                        </div>
                        <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">
                            Review your configuration and click "Create Pipeline" to deploy your new ML pipeline. You can modify these settings later from the pipeline management interface.
                        </div>
                    </div>
                </div>
            </div>

            <div class="pipeline-wizard-footer">
                <button id="wizardPrevBtn" onclick="previousWizardStep()" style="padding: 10px 20px; background: white; color: var(--color-dark); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                    Previous
                </button>
                <div style="flex: 1;"></div>
                <button id="wizardNextBtn" onclick="nextWizardStep()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                    Next
                </button>
                <button id="wizardFinishBtn" onclick="finishPipelineWizard()" style="display: none; padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                    Create Pipeline
                </button>
            </div>
        </div>
    </div> <!-- End pipeline-wizard-modal -->

    <!-- Simple Pipeline Wizard Modal -->
    <div class="simple-pipeline-wizard-modal" id="simplePipelineWizardModal">
        <div class="simple-pipeline-wizard-content">
            <div class="simple-pipeline-wizard-header">
                <h3>Create Your First Pipeline</h3>
                <button class="simple-pipeline-wizard-close" onclick="closeSimplePipelineWizard()">&times;</button>
            </div>

            <!-- Friendly Progress Indicator -->
            <div class="simple-wizard-progress">
                <div class="simple-progress-bar">
                    <div class="simple-progress-fill" id="simpleProgressFill"></div>
                </div>
                <div class="simple-progress-text" id="simpleProgressText">Step 1 of 4</div>
            </div>

            <div class="simple-pipeline-wizard-body">
                <!-- Step 1: Choose Template -->
                <div class="simple-wizard-step-content active" id="simpleWizardStep1">
                    <div class="wizard-welcome">
                        <i class="ph ph-rocket-launch" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                        <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Let's build your pipeline together!</h4>
                        <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                            Choose a pre-configured template to get started quickly. We'll guide you through each step.
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                        <div class="template-card" onclick="selectTemplate('content')" data-template="content">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="ph ph-article" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Content Transformation</h5>
                                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0; line-height: 1.5;">
                                        Perfect for: Converting documents to multiple formats, generating summaries, or translating content.
                                    </p>
                                    <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">PDF → HTML</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Summarization</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Translation</span>
                                    </div>
                                </div>
                                <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                            </div>
                        </div>

                        <div class="template-card" onclick="selectTemplate('data')" data-template="data">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="ph ph-chart-bar" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Data Analysis</h5>
                                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0; line-height: 1.5;">
                                        Perfect for: Analyzing spreadsheets, generating reports, or finding insights in your data.
                                    </p>
                                    <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">CSV Analysis</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Reports</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Insights</span>
                                    </div>
                                </div>
                                <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                            </div>
                        </div>

                        <div class="template-card" onclick="selectTemplate('image')" data-template="image">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="ph ph-images" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Image Processing</h5>
                                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0; line-height: 1.5;">
                                        Perfect for: Organizing photos, detecting objects, or extracting text from images.
                                    </p>
                                    <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Auto-tagging</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">OCR</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Recognition</span>
                                    </div>
                                </div>
                                <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Basic Settings -->
                <div class="simple-wizard-step-content" id="simpleWizardStep2">
                    <div class="wizard-welcome">
                        <i class="ph ph-pencil-simple" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                        <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Name your pipeline</h4>
                        <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                            Give it a descriptive name so you can find it easily later.
                        </p>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Pipeline Name</label>
                        <input type="text" id="simplePipelineName" placeholder="e.g., My Content Pipeline" style="width: 100%; padding: 12px 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 15px; transition: border-color 0.2s;">
                        <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px;">
                            <i class="ph ph-lightbulb" style="margin-right: 4px;"></i>
                            Tip: Use a name that describes what this pipeline does
                        </div>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">How often should it run?</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <label class="frequency-option" onclick="selectFrequency('manual')">
                                <input type="radio" name="simpleFrequency" value="manual" checked style="display: none;">
                                <div class="frequency-card">
                                    <i class="ph ph-hand-pointing" style="font-size: 24px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Manual</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin-top: 4px;">You start it when needed</div>
                                </div>
                            </label>
                            <label class="frequency-option" onclick="selectFrequency('automatic')">
                                <input type="radio" name="simpleFrequency" value="automatic" style="display: none;">
                                <div class="frequency-card">
                                    <i class="ph ph-clock-clockwise" style="font-size: 24px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Automatic</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin-top: 4px;">Runs on a schedule</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div id="scheduleOptions" style="display: none; margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Schedule</label>
                        <select id="simpleSchedule" style="width: 100%; padding: 12px 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 15px; cursor: pointer;">
                            <option value="hourly">Every hour</option>
                            <option value="daily" selected>Once a day</option>
                            <option value="weekly">Once a week</option>
                        </select>
                    </div>
                </div>

                <!-- Step 3: Connect Source -->
                <div class="simple-wizard-step-content" id="simpleWizardStep3">
                    <div class="wizard-welcome">
                        <i class="ph ph-plugs-connected" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                        <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Where is your data?</h4>
                        <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                            Connect to where your files are stored. Don't worry, you can change this later.
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div class="simple-source-card" onclick="selectSimpleSource('dropbox')" data-source="dropbox">
                            <i class="ph ph-dropbox-logo" style="font-size: 40px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                            <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark);">Dropbox</div>
                            <i class="ph ph-check-circle simple-source-check" style="position: absolute; top: 12px; right: 12px; font-size: 20px; color: var(--color-primary-blue); display: none;"></i>
                        </div>

                        <div class="simple-source-card" onclick="selectSimpleSource('onedrive')" data-source="onedrive">
                            <i class="ph ph-microsoft-outlook-logo" style="font-size: 40px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                            <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark);">OneDrive</div>
                            <i class="ph ph-check-circle simple-source-check" style="position: absolute; top: 12px; right: 12px; font-size: 20px; color: var(--color-primary-blue); display: none;"></i>
                        </div>

                        <div class="simple-source-card" onclick="selectSimpleSource('googledrive')" data-source="googledrive">
                            <i class="ph ph-google-drive-logo" style="font-size: 40px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                            <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark);">Google Drive</div>
                            <i class="ph ph-check-circle simple-source-check" style="position: absolute; top: 12px; right: 12px; font-size: 20px; color: var(--color-primary-blue); display: none;"></i>
                        </div>

                        <div class="simple-source-card" onclick="selectSimpleSource('computer')" data-source="computer">
                            <i class="ph ph-laptop" style="font-size: 40px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                            <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark);">My Computer</div>
                            <i class="ph ph-check-circle simple-source-check" style="position: absolute; top: 12px; right: 12px; font-size: 20px; color: var(--color-primary-blue); display: none;"></i>
                        </div>
                    </div>

                    <div id="simpleSourceHelp" style="display: none; padding: 16px; background: rgba(0, 102, 204, 0.05); border-radius: 8px; border-left: 4px solid var(--color-primary-blue);">
                        <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">
                            <i class="ph ph-info" style="margin-right: 6px;"></i>Next step after creation
                        </div>
                        <div id="simpleSourceHelpText" style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                        </div>
                    </div>
                </div>

                <!-- Step 4: Review -->
                <div class="simple-wizard-step-content" id="simpleWizardStep4">
                    <div class="wizard-welcome">
                        <i class="ph ph-check-square" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                        <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">You're all set!</h4>
                        <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                            Here's what we're creating for you. Click "Create Pipeline" when ready.
                        </p>
                    </div>

                    <div style="background: var(--color-neutral-background); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <div style="margin-bottom: 20px;">
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Pipeline Type</div>
                            <div id="reviewTemplate" style="font-family: var(--font-family-body); font-size: 16px; color: var(--color-dark);"></div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Name</div>
                            <div id="reviewName" style="font-family: var(--font-family-body); font-size: 16px; color: var(--color-dark);"></div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Schedule</div>
                            <div id="reviewSchedule" style="font-family: var(--font-family-body); font-size: 16px; color: var(--color-dark);"></div>
                        </div>

                        <div>
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Data Source</div>
                            <div id="reviewSource" style="font-family: var(--font-family-body); font-size: 16px; color: var(--color-dark);"></div>
                        </div>
                    </div>

                    <div style="padding: 16px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4CAF50;">
                        <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: #2E7D32; margin-bottom: 6px;">
                            <i class="ph ph-check-circle" style="margin-right: 6px;"></i>What happens next?
                        </div>
                        <div style="font-family: var(--font-family-body); font-size: 12px; color: #2E7D32; line-height: 1.5;">
                            After creation, you'll be able to configure connection details, test your pipeline, and start processing data.
                        </div>
                    </div>
                </div>
            </div>

            <div class="simple-pipeline-wizard-footer">
                <button id="simpleWizardBackBtn" onclick="previousSimpleWizardStep()" style="padding: 10px 20px; background: white; color: var(--color-dark); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: none;">
                    <i class="ph ph-arrow-left" style="margin-right: 6px;"></i>
                    Back
                </button>
                <div style="flex: 1;"></div>
                <button id="simpleWizardContinueBtn" onclick="nextSimpleWizardStep()" style="padding: 10px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    Continue
                    <i class="ph ph-arrow-right"></i>
                </button>
                <button id="simpleWizardCreateBtn" onclick="finishSimplePipelineWizard()" style="display: none; padding: 10px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; align-items: center; gap: 6px;">
                    <i class="ph ph-check"></i>
                    Create Pipeline
                </button>
            </div>
        </div>
    </div> <!-- End simple-pipeline-wizard-modal -->

    <!-- New Workflow Creation Modal -->
    <div class="workflow-creation-modal" id="workflowCreationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(4px);">
        <div class="workflow-creation-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
            <div class="workflow-creation-header" style="padding: 24px; border-bottom: 1px solid var(--color-neutral-border); position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 1;">
                <h3 style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Create New Workflow</h3>
                <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">Design a custom workflow to automate your business processes</p>
                <button onclick="closeWorkflowCreationModal()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; color: var(--color-neutral-text); cursor: pointer;">&times;</button>
            </div>
            <div class="workflow-creation-body" style="padding: 24px;">
                <form id="workflowForm" onsubmit="createWorkflow(event)">
                    <!-- Basic Information -->
                    <div style="margin-bottom: 32px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-info" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                            Basic Information
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Workflow Name *</label>
                                <input type="text" id="workflowName" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Version</label>
                                <input type="text" id="workflowVersion" value="1.0.0" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Description</label>
                            <textarea id="workflowDescription" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;" placeholder="Describe what this workflow does..."></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Category *</label>
                                <select id="workflowCategory" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                    <option value="">Select Category</option>
                                    <option value="content_creative">Content & Creative</option>
                                    <option value="operational_business">Business Operations</option>
                                    <option value="hr_people">HR & People</option>
                                    <option value="technical_development">Technical Development</option>
                                    <option value="customer_facing">Customer Facing</option>
                                    <option value="compliance_quality">Compliance & Quality</option>
                                    <option value="financial">Financial</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Type *</label>
                                <select id="workflowType" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                    <option value="">Select Type</option>
                                    <option value="document_approval">Document Approval</option>
                                    <option value="publishing">Publishing</option>
                                    <option value="video_production">Video Production</option>
                                    <option value="design_review">Design Review</option>
                                    <option value="procurement">Procurement</option>
                                    <option value="invoice_processing">Invoice Processing</option>
                                    <option value="expense_reimbursement">Expense Reimbursement</option>
                                    <option value="contract_lifecycle">Contract Lifecycle</option>
                                    <option value="employee_onboarding">Employee Onboarding</option>
                                    <option value="time_off_request">Time Off Request</option>
                                    <option value="performance_review">Performance Review</option>
                                    <option value="hiring_pipeline">Hiring Pipeline</option>
                                    <option value="code_review">Code Review</option>
                                    <option value="incident_response">Incident Response</option>
                                    <option value="change_management">Change Management</option>
                                    <option value="release_management">Release Management</option>
                                    <option value="support_ticket">Support Ticket</option>
                                    <option value="order_fulfillment">Order Fulfillment</option>
                                    <option value="returns_rma">Returns & RMA</option>
                                    <option value="lead_nurturing">Lead Nurturing</option>
                                    <option value="audit_process">Audit Process</option>
                                    <option value="quality_control">Quality Control</option>
                                    <option value="risk_assessment">Risk Assessment</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Workflow States -->
                    <div style="margin-bottom: 32px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-flow-arrow" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                            Workflow States
                        </h4>
                        <div style="background: var(--color-neutral-background); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <input type="text" id="newStateName" placeholder="State name (e.g., Draft, Review, Approved)" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <select id="newStateType" style="padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                    <option value="initial">Initial</option>
                                    <option value="active" selected>Active</option>
                                    <option value="waiting">Waiting</option>
                                    <option value="completed">Completed</option>
                                    <option value="terminal">Terminal</option>
                                </select>
                                <button type="button" onclick="addWorkflowState()" style="padding: 8px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div id="workflowStatesList" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- States will be added here -->
                        </div>
                    </div>

                    <!-- SLA Settings -->
                    <div style="margin-bottom: 32px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-clock" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                            SLA Settings
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Expected Duration</label>
                                <input type="text" id="expectedDuration" placeholder="e.g., 2 hours, 1 day" style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Max Duration</label>
                                <input type="text" id="maxDuration" placeholder="e.g., 1 week, 5 days" style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Business Hours Only</label>
                                <select id="businessHoursOnly" style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div style="margin-bottom: 32px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-tag" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                            Tags
                        </h4>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <input type="text" id="newWorkflowTag" placeholder="Add tag (press Enter)" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;" onkeydown="handleTagKeydown(event)">
                        </div>
                        <div id="workflowTagsList" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- Tags will be added here -->
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 24px; border-top: 1px solid var(--color-neutral-border);">
                        <button type="button" onclick="closeWorkflowCreationModal()" style="padding: 10px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                            Cancel
                        </button>
                        <button type="submit" style="padding: 10px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-plus"></i>
                            Create Workflow
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End workflow-creation-modal -->

</div> <!-- End canvas-modal-content -->
</div> <!-- End canvas-modal -->

    <script>
        // Current persona and view mode
        let currentPersona = 'retail-manager';
        let currentViewMode = 'seeker'; // 'seeker' or 'learner'

        // AudioTourManager - Web Audio API integration for Driver.js tour narrations
        class AudioTourManager {
            constructor() {
                this.audioContext = null;
                this.audioBuffers = new Map();
                this.currentSource = null;
                this.isPlaying = false;
                this.volume = 0.8;
                this.gainNode = null;

                // Audio file mappings
                this.audioMappings = {
                    'welcome': 'assets/audio/tour-narrations/canvas-overview/welcome-canvas-intro-30s.mp3',
                    'view-modes': 'assets/audio/tour-narrations/canvas-overview/view-mode-selector-25s.mp3',
                    'mindmap-navigation': 'assets/audio/tour-narrations/ui-controls/mindmap-navigation-40s.mp3',
                    'calendar-widget': 'assets/audio/tour-narrations/ui-controls/calendar-widget-30s.mp3',
                    'ai-assistant': 'assets/audio/tour-narrations/ui-controls/ai-assistant-35s.mp3',
                    'job-search-view': 'assets/audio/tour-narrations/job-search/job-search-view-50s.mp3',
                    'projects-view': 'assets/audio/tour-narrations/professional-tools/projects-view-45s.mp3',
                    'panel-controls': 'assets/audio/tour-narrations/ui-controls/panel-controls-20s.mp3'
                };

                this.initAudioContext();
            }

            async initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.gainNode = this.audioContext.createGain();
                    this.gainNode.connect(this.audioContext.destination);
                    this.gainNode.gain.value = this.volume;

                    // Handle browser autoplay policies
                    if (this.audioContext.state === 'suspended') {
                        console.log('AudioContext suspended - will resume on user interaction');
                    }
                } catch (error) {
                    console.warn('Web Audio API not supported:', error);
                }
            }

            async loadAudio(stepId, audioUrl) {
                if (!this.audioContext || this.audioBuffers.has(stepId)) {
                    return;
                }

                try {
                    const response = await fetch(audioUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to load audio: ${response.status}`);
                    }

                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    this.audioBuffers.set(stepId, audioBuffer);

                    console.log(`Loaded audio for step: ${stepId}`);
                } catch (error) {
                    console.warn(`Failed to load audio for step ${stepId}:`, error);
                }
            }

            async preloadAllAudio() {
                const loadPromises = Object.entries(this.audioMappings).map(([stepId, audioUrl]) =>
                    this.loadAudio(stepId, audioUrl)
                );

                await Promise.allSettled(loadPromises);
                console.log(`Preloaded ${this.audioBuffers.size} audio files`);
            }

            async playNarration(stepId) {
                if (!this.audioContext) {
                    console.warn('AudioContext not available');
                    return false;
                }

                // Resume context if suspended (browser autoplay policy)
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }

                // Stop current audio if playing
                this.stopAudio();

                const buffer = this.audioBuffers.get(stepId);
                if (!buffer) {
                    console.warn(`No audio buffer found for step: ${stepId}`);
                    return false;
                }

                try {
                    this.currentSource = this.audioContext.createBufferSource();
                    this.currentSource.buffer = buffer;
                    this.currentSource.connect(this.gainNode);

                    this.currentSource.onended = () => {
                        this.isPlaying = false;
                        this.currentSource = null;
                    };

                    this.currentSource.start();
                    this.isPlaying = true;

                    console.log(`Playing narration for step: ${stepId}`);
                    return true;
                } catch (error) {
                    console.warn(`Failed to play audio for step ${stepId}:`, error);
                    return false;
                }
            }

            stopAudio() {
                if (this.currentSource && this.isPlaying) {
                    try {
                        this.currentSource.stop();
                    } catch (error) {
                        // Ignore errors when stopping already stopped sources
                    }
                    this.currentSource = null;
                    this.isPlaying = false;
                }
            }

            setVolume(volume) {
                this.volume = Math.max(0, Math.min(1, volume));
                if (this.gainNode) {
                    this.gainNode.gain.value = this.volume;
                }
            }

            getVolume() {
                return this.volume;
            }

            isAudioPlaying() {
                return this.isPlaying;
            }
        }

        // Initialize audio manager
        const audioTourManager = new AudioTourManager();


        // Centralized function to hide all content sections (prevents bleeding between slideouts)
        function hideAllContentSections() {
            const contentSections = [
                'interviewPrepContent', 'behavioralContent', 'technicalContent',
                'jobOpportunitiesContent', 'careerExperienceContent',
                'applicationMaterialsContent', 'skillsCompetenciesContent',
                'portfolioContent', 'projectsContent', 'myNotesContent',
                'calendarContent', 'recipesContent', 'financeContent',
                'tablesContent', 'formsContent', 'documentsContent',
                'reportsContent', 'templatesContent', 'pipelinesContent', 'workflowsContent'
            ];

            contentSections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) section.style.display = 'none';
            });
        }

        // Persona data from experience tagger with expandable content
        const personaData = {
            'retail-manager': {
                name: 'Alex Martinez',
                goal: 'Transition from retail management into business analytics or operations management roles in tech companies',
                children: [
                    {
                        name: 'Job Opportunities',
                        count: 5,
                        children: [
                            { name: 'Operations Manager\nAmazon (Seattle, $125K)' },
                            { name: 'Business Analyst\nTarget HQ (Minneapolis, $95K)' },
                            { name: 'Data Analyst\nWalmart eCommerce (Bentonville, $85K)' },
                            { name: 'Supply Chain Analyst\nNike (Portland, $90K)' },
                            { name: 'Ops Coordinator\nInstacart (San Francisco, $80K)' }
                        ]
                    },
                    {
                        name: 'Application Materials',
                        count: 4,
                        children: [
                            { name: 'Resume v3.2 - Analytics Focus (updated 10/2)' },
                            { name: 'Cover Letter - Amazon Ops Role' },
                            { name: 'Cover Letter - Target Analytics Role' },
                            { name: 'LinkedIn Profile - 85% Complete' }
                        ]
                    },
                    {
                        name: 'Career Experience',
                        count: 5,
                        children: [
                            { name: 'Store Manager - Target #2847 (2019-Present)' },
                            { name: 'Asst Store Manager - Target #1923 (2016-2019)' },
                            { name: 'Dept Supervisor - Best Buy (2014-2016)' },
                            { name: 'Sales Associate - Best Buy (2012-2014)' },
                            { name: 'BA Business Admin - U of Minnesota (2012)' }
                        ]
                    },
                    {
                        name: 'Goals',
                        count: 6,
                        children: [
                            { name: 'Goal: Business Analytics by Q2 2025' },
                            { name: 'Excel: Advanced (Pivot, VLOOKUP)' },
                            { name: 'Power BI: Intermediate' },
                            { name: 'SQL: Learning (Codecademy 40% done)' },
                            { name: 'Leadership: 10+ direct reports' },
                            { name: 'P&L Ownership: $8M annual revenue' }
                        ]
                    },
                    {
                        name: 'Portfolio',
                        count: 2,
                        children: [
                            { name: 'Power BI Sales Dashboard' },
                            { name: 'Staff Scheduling Model (Excel VBA)' }
                        ]
                    },
                    {
                        name: 'Interview Prep',
                        count: 2,
                        children: [
                            { name: 'Behavioral' },
                            { name: 'Technical' }
                        ]
                    }
                ]
            },
            'chemist': {
                name: 'Dr. Sarah Chen',
                goal: 'Leverage analytical chemistry expertise to transition into data science and computational chemistry roles',
                children: [
                    {
                        name: 'Job Opportunities',
                        count: 5,
                        children: [
                            { name: 'Sr Data Scientist\nPfizer R&D (Cambridge, $165K)' },
                            { name: 'Computational Chemist\nModerna (Boston, $155K)' },
                            { name: 'ML Engineer\nGenentech (South SF, $180K)' },
                            { name: 'Cheminformatics Lead\nNovartis (Basel, $145K)' },
                            { name: 'Research Scientist\nBioNTech (Mainz, €130K)' }
                        ]
                    },
                    {
                        name: 'Application Materials',
                        count: 5,
                        children: [
                            { name: 'Resume v2.8 - Data Science Focus' },
                            { name: 'Research Portfolio Website (GitHub Pages)' },
                            { name: 'Cover Letter - Pfizer Data Science' },
                            { name: 'Publication List (h-index: 12)' },
                            { name: 'LinkedIn - Featured: 3 Publications' }
                        ]
                    },
                    {
                        name: 'Career Experience',
                        count: 6,
                        children: [
                            { name: 'Sr Research Scientist - Moderna (2020-Present)' },
                            { name: 'Research Scientist - Pfizer (2017-2020)' },
                            { name: 'Postdoc - UConn Chemistry (2015-2017)' },
                            { name: 'PhD Analytical Chemistry - UC Berkeley (2015)' },
                            { name: 'Graduate Researcher - Lawrence Lab (2012-2015)' },
                            { name: 'BS Chemistry - MIT (2010)' }
                        ]
                    },
                    {
                        name: 'Goals',
                        count: 8,
                        children: [
                            { name: 'Goal: Lead Data Science Team by 2026' },
                            { name: 'Python: Pandas, NumPy, Scikit-learn' },
                            { name: 'R: Statistical modeling, ggplot2' },
                            { name: 'Machine Learning: Regression, Classification' },
                            { name: 'ChemInformatics: RDKit, OpenBabel' },
                            { name: 'Mass Spec: LC-MS, GC-MS expert' },
                            { name: 'GxP Compliance: FDA 21 CFR Part 11' },
                            { name: 'Leadership: Mentored 4 PhD students' }
                        ]
                    },
                    {
                        name: 'Portfolio',
                        count: 4,
                        children: [
                            { name: '12 Publications (h-index: 12)' },
                            { name: 'Python QC Pipeline (GitHub: 85★)' },
                            { name: 'R Shiny Dashboard' },
                            { name: 'Conference Talks: ACS, ASMS' }
                        ]
                    },
                    {
                        name: 'Interview Prep',
                        count: 2,
                        children: [
                            { name: 'Behavioral' },
                            { name: 'Technical' }
                        ]
                    }
                ]
            },
            'new-graduate': {
                name: 'Jordan Kim',
                goal: 'Launch career in software development or cloud engineering, building practical skills',
                children: [
                    {
                        name: 'Job Opportunities',
                        count: 6,
                        children: [
                            { name: 'SWE New Grad\nGoogle (MTV, $140K + equity)' },
                            { name: 'Cloud Engineer\nMicrosoft Azure (Redmond, $130K)' },
                            { name: 'DevOps Engineer\nAWS (Seattle, $125K)' },
                            { name: 'Full Stack Dev\nStripe (SF, $145K + equity)' },
                            { name: 'Junior SWE\nCoinbase (Remote, $110K)' },
                            { name: 'Platform Engineer\nRobinhood (Menlo Park, $135K)' }
                        ]
                    },
                    {
                        name: 'Application Materials',
                        count: 4,
                        children: [
                            { name: 'Resume v4.1 - New Grad SWE' },
                            { name: 'GitHub Portfolio: github.com/jrodriguez' },
                            { name: 'Cover Letter Template (3 versions)' },
                            { name: 'LinkedIn - Optimized w/ Robotics Win' }
                        ]
                    },
                    {
                        name: 'Career Experience',
                        count: 6,
                        children: [
                            { name: 'SWE Intern - TechStart Inc (Summer 2024)' },
                            { name: 'CS Teaching Assistant - UT Austin (2023-2024)' },
                            { name: 'Robotics Team Lead - UT Longhorns (2022-2024)' },
                            { name: 'Freelance Web Dev - 5 clients (2023)' },
                            { name: 'Barista - Caffe Medici (2021-2023)' },
                            { name: 'BS Computer Science - UT Austin (May 2024, 3.7 GPA)' }
                        ]
                    },
                    {
                        name: 'Goals',
                        count: 7,
                        children: [
                            { name: 'Goal: Cloud Engineering at FAANG by 2025' },
                            { name: 'Languages: Python, JavaScript, Go, C++' },
                            { name: 'Cloud: AWS (Solutions Architect Associate)' },
                            { name: 'Frontend: React, TypeScript, Next.js' },
                            { name: 'Backend: Node.js, Express, PostgreSQL' },
                            { name: 'DevOps: Docker, Kubernetes, CI/CD' },
                            { name: 'Robotics: ROS, Computer Vision, ML' }
                        ]
                    },
                    {
                        name: 'Portfolio',
                        count: 5,
                        children: [
                            { name: 'RoboCup 2024 Project' },
                            { name: 'React SaaS Portal (GitHub: 150★)' },
                            { name: 'YOLO Object Detection Model' },
                            { name: 'AWS Serverless API' },
                            { name: 'Open Source Contributions (25)' }
                        ]
                    },
                    {
                        name: 'Interview Prep',
                        count: 2,
                        children: [
                            { name: 'Behavioral' },
                            { name: 'Technical' }
                        ]
                    }
                ]
            },
            'data-analyst': {
                name: 'Riley Patel',
                goal: 'Advance from data analyst to senior data scientist or machine learning engineer role',
                children: [
                    {
                        name: 'Job Opportunities',
                        count: 5,
                        children: [
                            { name: 'Sr Data Scientist\nMeta (Menlo Park, $210K)' },
                            { name: 'ML Engineer\nNetflix (Los Gatos, $225K)' },
                            { name: 'Data Scientist\nUber (SF, $195K)' },
                            { name: 'Lead Analytics\nAirbnb (SF, $185K)' },
                            { name: 'Sr ML Engineer\nLinkedIn (Sunnyvale, $200K)' }
                        ]
                    },
                    {
                        name: 'Application Materials',
                        count: 5,
                        children: [
                            { name: 'Resume v5.3 - Sr Data Scientist' },
                            { name: 'Portfolio Site: priyapatel.dev' },
                            { name: 'Cover Letter - Meta DS Role' },
                            { name: 'Case Study Deck: Churn Prediction' },
                            { name: 'LinkedIn - Featured Projects (3)' }
                        ]
                    },
                    {
                        name: 'Career Experience',
                        count: 6,
                        children: [
                            { name: 'Sr Data Analyst - Salesforce (2021-Present)' },
                            { name: 'Data Analyst II - Lyft (2019-2021)' },
                            { name: 'Data Analyst I - Lyft (2018-2019)' },
                            { name: 'Business Analyst - Deloitte Consulting (2017-2018)' },
                            { name: 'MS Statistics - Stanford University (2017)' },
                            { name: 'BS Mathematics - UC Berkeley (2015)' }
                        ]
                    },
                    {
                        name: 'Goals',
                        count: 9,
                        children: [
                            { name: 'Goal: Sr Data Scientist at FAANG by Q2 2025' },
                            { name: 'Python: Pandas, NumPy, Scikit-learn, TensorFlow' },
                            { name: 'SQL: Advanced (Window functions, CTEs)' },
                            { name: 'ML: Classification, Regression, Clustering' },
                            { name: 'Deep Learning: Neural Networks, CNNs' },
                            { name: 'A/B Testing: Experimentation design & analysis' },
                            { name: 'Visualization: Tableau, Looker, Matplotlib' },
                            { name: 'Big Data: Spark, Hive, Airflow' },
                            { name: 'Cloud: AWS (SageMaker, Redshift, S3)' }
                        ]
                    },
                    {
                        name: 'Portfolio',
                        count: 4,
                        children: [
                            { name: 'Churn Prediction Model' },
                            { name: 'Executive Dashboard (Tableau)' },
                            { name: 'Recommender System' },
                            { name: 'GitHub ML Projects (320★)' }
                        ]
                    },
                    {
                        name: 'Interview Prep',
                        count: 2,
                        children: [
                            { name: 'Behavioral' },
                            { name: 'Technical' }
                        ]
                    }
                ]
            }
        };

        // Right panel collapse state - start collapsed
        let rightPanelCollapsed = true;

        // Toggle right panel collapse
        function toggleRightPanel() {
            const body = document.getElementById('canvasBody');
            const toggle = document.getElementById('collapseToggle');
            const icon = toggle.querySelector('i');

            rightPanelCollapsed = !rightPanelCollapsed;

            if (rightPanelCollapsed) {
                body.classList.add('collapsed');
                icon.className = 'ph ph-caret-right';
            } else {
                body.classList.remove('collapsed');
                icon.className = 'ph ph-caret-left';
            }
        }

        // View Mode Functions
        function switchViewMode(mode) {
            currentViewMode = mode;

            // Hide tooltip when switching modes
            guidanceTooltip.hide();

            // Update toggle buttons
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                const btnMode = btn.getAttribute('data-view');
                if (btnMode === mode) {
                    btn.style.background = 'var(--color-primary-blue)';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = 'rgba(255, 255, 255, 0.7)';
                    btn.classList.remove('active');
                }
            });

            // Show/hide menu items based on mode
            const jobSearchMenuItem = document.getElementById('jobSearchMenuItem');
            const libraryMenuItem = document.getElementById('libraryMenuItem');
            const projectsMenuItem = document.getElementById('projectsMenuItem');

            if (mode === 'seeker') {
                // Seeker mode: Home, Job Search, Library
                jobSearchMenuItem.style.display = 'flex';
                libraryMenuItem.style.display = 'flex';
                projectsMenuItem.style.display = 'none';
            } else if (mode === 'professional') {
                // Professional mode: Home, Projects (no Library, no Job Search)
                jobSearchMenuItem.style.display = 'none';
                libraryMenuItem.style.display = 'none';
                projectsMenuItem.style.display = 'flex';

                // If currently on Job Search or Library view, switch back to Home
                const menuName = document.querySelector('.main-menu-item.active span')?.textContent;
                if (menuName === 'Job Search' || menuName === 'Library') {
                    document.querySelector('.main-menu-item').click(); // Click Home button
                }
            } else if (mode === 'learner' || mode === 'personal') {
                // Learner/Personal mode: Hide Job Search and Projects
                jobSearchMenuItem.style.display = 'none';
                libraryMenuItem.style.display = 'flex';
                projectsMenuItem.style.display = 'none';

                // If currently on Job Search view, switch back to Home
                const menuName = document.querySelector('.main-menu-item.active span')?.textContent;
                if (menuName === 'Job Search') {
                    document.querySelector('.main-menu-item').click(); // Click Home button
                }
            }

            // Clear and redraw visualization
            d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();

            if (mode === 'seeker' || mode === 'professional') {
                // Seeker and Professional use mindmap layout
                initializeMindmap(currentPersona);
            } else {
                // Learner and Personal use network layout
                initializeLearnerNetwork(currentPersona);
            }
        }

        function getFilteredPersonaData(persona) {
            const data = personaData[persona];
            if (!data) return null;

            const filteredChildren = data.children.filter(child => {
                const excludedNodes = ['Job Opportunities', 'Application Materials', 'Interview Prep'];
                return !excludedNodes.includes(child.name);
            });

            // Load counts from localStorage
            const storedProjects = localStorage.getItem(`projects_${persona}`);
            const projectsCount = storedProjects ? JSON.parse(storedProjects).length : 0;

            const storedNotes = localStorage.getItem(`notes_${persona}`);
            const notesCount = storedNotes ? JSON.parse(storedNotes).length : 0;

            // Professional nodes
            const professionalNodes = [
                {
                    name: 'Career Experience',
                    count: filteredChildren.find(c => c.name === 'Career Experience')?.count || 0,
                    children: []
                },
                {
                    name: 'Goals',
                    count: filteredChildren.find(c => c.name === 'Goals')?.count || 0,
                    children: []
                },
                {
                    name: 'Portfolio',
                    count: filteredChildren.find(c => c.name === 'Portfolio')?.count || 0,
                    children: []
                },
                {
                    name: 'Code Snippets',
                    count: 0,
                    children: []
                },
                {
                    name: 'Projects',
                    count: projectsCount,
                    children: []
                },
                {
                    name: 'My Library',
                    count: 0,
                    children: []
                }
            ];

            // Personal nodes
            const personalNodes = [
                {
                    name: 'My Notes',
                    count: notesCount,
                    icon: 'ph-note-pencil',
                    children: []
                },
                {
                    name: 'Shopping',
                    count: 0,
                    icon: 'ph-shopping-cart',
                    children: [
                        { name: 'Grocery', count: 0, icon: 'ph-carrot' },
                        { name: 'Home', count: 0, icon: 'ph-house' },
                        { name: 'Internet', count: 0, icon: 'ph-globe' },
                        { name: 'Gifts', count: 0, icon: 'ph-gift' }
                    ]
                },
                {
                    name: 'Finance',
                    count: 0,
                    icon: 'ph-currency-dollar',
                    children: [
                        { name: 'Insurance', count: 0, icon: 'ph-shield-check' },
                        { name: 'Cash Flow', count: 0, icon: 'ph-arrows-left-right' },
                        { name: 'Assets', count: 0, icon: 'ph-bank' },
                        { name: 'Liabilities', count: 0, icon: 'ph-credit-card' },
                        { name: 'Investments', count: 0, icon: 'ph-trend-up' }
                    ]
                },
                {
                    name: 'Recipes',
                    count: 0,
                    icon: 'ph-cooking-pot',
                    children: []
                }
            ];

            // Return different structures based on view mode
            if (currentViewMode === 'learner') {
                // Learner mode: two-tier with professional features directly connected to center
                return {
                    ...data,
                    children: professionalNodes
                };
            } else if (currentViewMode === 'professional') {
                // Professional mode: mindmap structure with Documents, Tables, Forms, Reports, Templates, Workflows
                return {
                    ...data,
                    children: [
                        {
                            name: 'Documents',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Tables',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Forms',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Reports',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Templates',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Pipelines',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Workflows',
                            count: 0,
                            children: []
                        }
                    ]
                };
            } else if (currentViewMode === 'personal') {
                // Personal mode: flat network with only personal nodes
                return {
                    ...data,
                    children: personalNodes
                };
            }

            return data;
        }

        // Canvas Modal Functions
        function openCanvasModal() {
            document.getElementById('canvasModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Initialize with collapsed panel
            const body = document.getElementById('canvasBody');
            const toggle = document.getElementById('collapseToggle');
            const icon = toggle.querySelector('i');
            body.classList.add('collapsed');
            icon.className = 'ph ph-caret-right';

            // Load user data
            loadUserJobs();
            loadStories();
            loadUserExperiences();
            initializeDemoDocuments();
            initializeDemoForms();
            initializeDemoTableRelationships();

            // Add click-outside-to-close handler for slideout
            const slideout = document.getElementById('interviewSlideout');
            slideout.addEventListener('click', function(event) {
                // Close if clicking on the slideout background (not the content)
                if (event.target === slideout) {
                    closeInterviewSlideout();
                }
            });

            setTimeout(() => initializeMindmap(currentPersona), 100);
        }

        function closeCanvasModal() {
            document.getElementById('canvasModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            // Clear the mindmap
            d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();
        }

        // Projects View Functions
        let projectFolders = [];
        let currentFolderId = null;

        function showProjectsView() {
            // Hide mindmap and other views, show projects view
            document.getElementById('canvas-mindmap').style.display = 'none';
            document.getElementById('projects-view').style.display = 'flex';

            // Load project structure
            loadProjectStructure();
            renderFolderTree();
            navigateToFolder(null); // Show root level
        }

        function loadProjectStructure() {
            const saved = localStorage.getItem('projectFolders');
            if (saved) {
                projectFolders = JSON.parse(saved);
            } else {
                // Initialize with demo structure
                projectFolders = [
                    {
                        id: 'acme-corp',
                        name: 'Acme Corporation',
                        type: 'folder',
                        parentId: null,
                        created: new Date('2025-09-15').toISOString(),
                        modified: new Date('2025-10-06').toISOString(),
                        sharedWith: ['AM', 'JS']
                    },
                    {
                        id: 'vendors',
                        name: 'Vendors',
                        type: 'folder',
                        parentId: null,
                        created: new Date('2025-09-20').toISOString(),
                        modified: new Date('2025-10-05').toISOString(),
                        sharedWith: ['AM']
                    },
                    {
                        id: 'acme-docs',
                        name: 'Q4 Proposal',
                        type: 'document',
                        parentId: 'acme-corp',
                        created: new Date('2025-10-01').toISOString(),
                        modified: new Date('2025-10-05').toISOString(),
                        sharedWith: ['AM', 'JS', 'TR']
                    },
                    {
                        id: 'acme-table',
                        name: 'Customer Contacts',
                        type: 'table',
                        parentId: 'acme-corp',
                        created: new Date('2025-09-20').toISOString(),
                        modified: new Date('2025-10-06').toISOString(),
                        sharedWith: ['AM', 'JS']
                    },
                    {
                        id: 'acme-report',
                        name: 'Sales Dashboard',
                        type: 'report',
                        parentId: 'acme-corp',
                        created: new Date('2025-10-03').toISOString(),
                        modified: new Date('2025-10-06').toISOString(),
                        sharedWith: ['AM']
                    },
                    {
                        id: 'vendor-form',
                        name: 'Vendor Information Form',
                        type: 'form',
                        parentId: 'vendors',
                        created: new Date('2025-09-28').toISOString(),
                        modified: new Date('2025-09-28').toISOString(),
                        sharedWith: []
                    }
                ];
                saveProjectStructure();
            }
        }

        function saveProjectStructure() {
            localStorage.setItem('projectFolders', JSON.stringify(projectFolders));
        }

        function renderFolderTree() {
            const container = document.getElementById('folderTree');
            const rootFolders = projectFolders.filter(item => item.parentId === null && item.type === 'folder');

            let html = renderFolderTreeLevel(rootFolders, 0);
            container.innerHTML = html;
        }

        function renderFolderTreeLevel(folders, depth) {
            let html = '';
            folders.forEach(folder => {
                const indent = depth * 16;
                const isActive = currentFolderId === folder.id;
                const children = projectFolders.filter(item => item.parentId === folder.id && item.type === 'folder');

                html += `
                    <div style="margin-bottom: 4px;">
                        <div onclick="navigateToFolder('${folder.id}')" style="padding: 8px; padding-left: ${indent + 8}px; cursor: pointer; border-radius: 4px; background: ${isActive ? '#e3f2fd' : 'transparent'}; color: ${isActive ? 'var(--color-primary-blue)' : 'var(--color-dark)'}; display: flex; align-items: center; gap: 8px; transition: background 0.2s;" onmouseover="if(!this.style.background.includes('e3f2fd')) this.style.background='#f8f9fa'" onmouseout="if(!this.style.background.includes('e3f2fd')) this.style.background='transparent'">
                            <i class="ph ph-folder" style="font-size: 16px;"></i>
                            <span style="flex: 1; font-weight: ${isActive ? '600' : '400'};">${folder.name}</span>
                        </div>
                        ${children.length > 0 ? renderFolderTreeLevel(children, depth + 1) : ''}
                    </div>
                `;
            });
            return html;
        }

        function navigateToFolder(folderId) {
            currentFolderId = folderId;
            renderFolderTree();
            renderBreadcrumb();
            renderFileTable();
        }

        function renderBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');

            if (currentFolderId === null) {
                breadcrumb.innerHTML = '<i class="ph ph-house" style="font-size: 16px;"></i> <span style="font-weight: 600;">All Projects</span>';
                return;
            }

            const path = [];
            let folder = projectFolders.find(f => f.id === currentFolderId);
            while (folder) {
                path.unshift(folder);
                folder = projectFolders.find(f => f.id === folder.parentId);
            }

            let html = '<span onclick="navigateToFolder(null)" style="cursor: pointer; color: var(--color-primary-blue);"><i class="ph ph-house" style="font-size: 16px;"></i></span>';
            path.forEach((item, index) => {
                html += ' <i class="ph ph-caret-right" style="font-size: 12px; color: var(--color-neutral-text-muted);"></i> ';
                if (index === path.length - 1) {
                    html += `<span style="font-weight: 600;">${item.name}</span>`;
                } else {
                    html += `<span onclick="navigateToFolder('${item.id}')" style="cursor: pointer; color: var(--color-primary-blue);">${item.name}</span>`;
                }
            });

            breadcrumb.innerHTML = html;
        }

        function renderFileTable() {
            const tbody = document.getElementById('fileTableBody');
            const items = projectFolders.filter(item => item.parentId === currentFolderId);

            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 40px; text-align: center; color: var(--color-neutral-text-muted);">
                            <i class="ph ph-folder-open" style="font-size: 48px; margin-bottom: 8px;"></i>
                            <p>This folder is empty</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            items.forEach(item => {
                const icon = getItemIcon(item.type);
                const typeName = item.type.charAt(0).toUpperCase() + item.type.slice(1);
                const createdDate = new Date(item.created).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const modifiedDate = new Date(item.modified).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const sharedAvatars = item.sharedWith.map(initials =>
                    `<div style="width: 24px; height: 24px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: var(--color-primary-blue);">${initials}</div>`
                ).join('');

                html += `
                    <tr style="border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="${item.type === 'folder' ? `navigateToFolder('${item.id}')` : `openProjectItem('${item.id}')`}">
                        <td style="padding: 12px 16px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="ph ${icon}" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                <span style="font-weight: 500; color: var(--color-dark);">${item.name}</span>
                            </div>
                        </td>
                        <td style="padding: 12px 16px; color: var(--color-neutral-text);">
                            ${typeName}
                        </td>
                        <td style="padding: 12px 16px; color: var(--color-neutral-text);">
                            ${createdDate}
                        </td>
                        <td style="padding: 12px 16px; color: var(--color-neutral-text);">
                            ${modifiedDate}
                        </td>
                        <td style="padding: 12px 16px;">
                            <div style="display: flex; gap: 4px; align-items: center;">
                                ${sharedAvatars}
                                ${item.sharedWith.length === 0 ? '<span style="color: var(--color-neutral-text-muted); font-size: 12px;">—</span>' : ''}
                            </div>
                        </td>
                        <td style="padding: 12px 16px;">
                            <div style="display: flex; gap: 4px;">
                                <button onclick="event.stopPropagation(); deleteProjectItem('${item.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;" title="Delete">
                                    <i class="ph ph-trash" style="font-size: 14px; color: #dc2626;"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function getItemIcon(type) {
            const icons = {
                'folder': 'ph-folder',
                'document': 'ph-file-text',
                'table': 'ph-table',
                'form': 'ph-note-pencil',
                'report': 'ph-chart-line',
                'template': 'ph-file-doc',
                'workflow': 'ph-flow-arrow'
            };
            return icons[type] || 'ph-file';
        }

        function createNewFolder() {
            const folderName = prompt('Enter folder name:');
            if (!folderName) return;

            const newFolder = {
                id: Date.now().toString(),
                name: folderName,
                type: 'folder',
                parentId: currentFolderId,
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                sharedWith: []
            };

            projectFolders.push(newFolder);
            saveProjectStructure();
            renderFolderTree();
            renderFileTable();
        }

        function addItemToCurrentFolder() {
            alert('Add Item functionality coming soon! This will allow you to link existing documents, tables, forms, reports, templates, and workflows to this folder.');
        }

        function deleteProjectItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            // Remove item and all its children recursively
            function removeItemAndChildren(id) {
                const children = projectFolders.filter(item => item.parentId === id);
                children.forEach(child => removeItemAndChildren(child.id));
                projectFolders = projectFolders.filter(item => item.id !== id);
            }

            removeItemAndChildren(itemId);
            saveProjectStructure();
            renderFolderTree();
            renderFileTable();
        }

        function openProjectItem(itemId) {
            const item = projectFolders.find(f => f.id === itemId);
            if (!item) return;

            alert(`Open ${item.type}: ${item.name}\n\nFunctionality coming soon to open the actual ${item.type} editor!`);
        }

        function toggleIntegrationSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const caret = document.getElementById(`${sectionId}-caret`);

            if (content.style.display === 'none' || content.style.display === '') {
                // Open section
                content.style.display = 'block';
                caret.style.transform = 'rotate(180deg)';
            } else {
                // Close section
                content.style.display = 'none';
                caret.style.transform = 'rotate(0deg)';
            }
        }

        function toggleIntegrationCategory(categoryId) {
            const content = document.getElementById(`${categoryId}-category-content`);
            const caret = document.getElementById(`${categoryId}-category-caret`);

            if (content.style.display === 'none' || content.style.display === '') {
                // Open category
                content.style.display = 'block';
                caret.style.transform = 'rotate(180deg)';
            } else {
                // Close category
                content.style.display = 'none';
                caret.style.transform = 'rotate(0deg)';
            }
        }

        function toggleCleansheetAI() {
            const toggle = document.getElementById('cleansheetAiToggle');
            const brokerSection = document.getElementById('aiBrokerSection');
            const aiBox = document.getElementById('cleansheetAiBox');

            if (toggle.checked) {
                // Show AI Broker selection and highlight the box
                brokerSection.style.display = 'block';
                aiBox.style.background = '#e3f2fd';
                aiBox.style.borderColor = 'var(--color-primary-blue)';
                aiBox.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.2)';
            } else {
                // Hide AI Broker selection and remove highlight
                brokerSection.style.display = 'none';
                aiBox.style.background = 'white';
                aiBox.style.borderColor = 'var(--color-neutral-border)';
                aiBox.style.boxShadow = 'none';
            }
        }

        function updateNodeCounts() {
            // Redraw the visualization to update counts
            d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();
            if (currentViewMode === 'learner') {
                initializeLearnerNetwork(currentPersona);
            } else {
                initializeMindmap(currentPersona);
            }
        }

        function switchPersona(persona) {
            currentPersona = persona;

            // Hide tooltip when switching personas
            guidanceTooltip.hide();

            // Update active button styling
            document.querySelectorAll('.persona-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = 'rgba(255, 255, 255, 0.7)';
            });
            const activeBtn = document.querySelector(`[data-persona="${persona}"]`);
            activeBtn.classList.add('active');
            activeBtn.style.background = 'var(--color-primary-blue)';
            activeBtn.style.color = 'white';

            // Update profile info
            updateProfileInfo(persona);

            // Load user data for new persona
            loadUserJobs();
            loadStories();
            loadUserExperiences();

            // Reload documents for new persona (if documents slideout is visible)
            if (document.getElementById('documentsContent') &&
                document.getElementById('documentsContent').style.display === 'block') {
                loadDocuments();
            }

            // Clear and redraw mindmap
            d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();
            initializeMindmap(persona);
        }

        // Profile dropdown functions
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const profileCircle = document.querySelector('.profile-circle');
            const dropdown = document.getElementById('profileDropdown');

            if (profileCircle && !profileCircle.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        function updateProfileInfo(persona) {
            const personaInfo = {
                'retail-manager': {
                    name: 'Alex Martinez',
                    role: 'Retail Manager',
                    initials: 'AM'
                },
                'chemist': {
                    name: 'Dr. Sarah Chen',
                    role: 'Research Chemist',
                    initials: 'SC'
                },
                'new-graduate': {
                    name: 'Jordan Kim',
                    role: 'New Graduate',
                    initials: 'JK'
                },
                'data-analyst': {
                    name: 'Riley Patel',
                    role: 'Data Analyst',
                    initials: 'RP'
                }
            };

            const info = personaInfo[persona];
            if (info) {
                document.getElementById('profileInitials').textContent = info.initials;
                document.getElementById('profileName').textContent = info.name;
                document.getElementById('profileRole').textContent = info.role;
            }
        }

        function openProfileSettings() {
            alert('Profile settings coming soon! This will allow you to edit your personal information, upload a photo, and manage your account details.');
            document.getElementById('profileDropdown').classList.remove('active');
        }

        function openSettings() {
            alert('Settings coming soon! This will allow you to configure preferences, notifications, privacy settings, and application behavior.');
            document.getElementById('profileDropdown').classList.remove('active');
        }

        // Main menu functions
        function setActiveMenu(clickedItem) {
            // Remove active class from all menu items
            document.querySelectorAll('.main-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            // Add active class to clicked item
            clickedItem.classList.add('active');

            // Get menu name
            const menuName = clickedItem.querySelector('span').textContent;

            // Show/hide appropriate view
            const homeView = document.getElementById('homeView');
            const jobSearchView = document.getElementById('jobSearchView');
            const libraryView = document.getElementById('libraryView');

            // Hide all views first
            homeView.style.display = 'none';
            jobSearchView.style.display = 'none';
            libraryView.style.display = 'none';

            if (menuName === 'Job Search') {
                jobSearchView.style.display = 'block';
                loadJobSearchView();
            } else if (menuName === 'Library') {
                libraryView.style.display = 'block';
                loadLibraryView();
            } else if (menuName === 'Home') {
                homeView.style.display = 'contents';
                // Hide projects view if it was open
                document.getElementById('projects-view').style.display = 'none';
                document.getElementById('canvas-mindmap').style.display = 'block';
                // Redraw mindmap when returning to Home view
                d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();
                if (currentViewMode === 'seeker' || currentViewMode === 'professional') {
                    setTimeout(() => initializeMindmap(currentPersona), 50);
                } else {
                    setTimeout(() => initializeLearnerNetwork(currentPersona), 50);
                }
            } else if (menuName === 'Projects') {
                homeView.style.display = 'contents';
                // showProjectsView() is called by the onclick handler
            } else {
                // Reset to home if unimplemented section
                homeView.style.display = 'contents';
                document.querySelector('.main-menu-item').classList.add('active');
                clickedItem.classList.remove('active');
                alert(`${menuName} section coming soon! This is a demo of the Canvas interface navigation.`);
            }
        }

        function loadJobSearchView() {
            const container = document.getElementById('jobSearchView');

            container.innerHTML = `
                <div style="max-width: 1400px; margin: 0 auto;">
                    <!-- My Job Search Collapsible Section -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; overflow: hidden;">
                        <div onclick="toggleJobSearchSankey()" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-neutral-border);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="ph ph-funnel" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                <div>
                                    <h3 style="font-family: var(--font-family-ui); font-size: 20px; color: var(--color-dark); margin: 0;">My Job Search Pipeline</h3>
                                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); margin: 4px 0 0 0;">Track your job search progress</p>
                                </div>
                            </div>
                            <i class="ph ph-caret-down" id="sankeyToggleIcon" style="font-size: 24px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                        </div>
                        <div id="sankeyContainer" style="display: none; padding: 32px 20px;">
                            <div id="jobSearchSankey" style="width: 100%; height: 400px;"></div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h2 style="font-family: var(--font-family-ui); font-size: 28px; color: var(--color-dark); margin: 0 0 8px 0;">Job Search Aggregator</h2>
                            <p style="font-family: var(--font-family-body); color: var(--color-neutral-text-light); margin: 0;">Search across multiple job boards and configure automated alerts</p>
                        </div>
                        <button onclick="openAlertSettings()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px;">
                            <i class="ph ph-bell"></i>
                            Configure Alerts
                        </button>
                    </div>

                    <!-- Search Bar -->
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 120px; gap: 12px;">
                            <input type="text" placeholder="Job title, keywords..." style="padding: 12px 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 14px;">
                            <input type="text" placeholder="Location" style="padding: 12px 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 14px;">
                            <button style="padding: 12px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-weight: 600; cursor: pointer; font-size: 14px;">
                                <i class="ph ph-magnifying-glass"></i> Search
                            </button>
                        </div>
                    </div>

                    <!-- Job Board Sources -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        ${renderJobBoard('LinkedIn', 'ph-linkedin-logo', '#0077B5', 847, true)}
                        ${renderJobBoard('Indeed', 'ph-briefcase', '#2164F3', 1203, true)}
                        ${renderJobBoard('Glassdoor', 'ph-building', '#0CAA41', 523, false)}
                        ${renderJobBoard('ZipRecruiter', 'ph-suitcase', '#1472E8', 412, true)}
                        ${renderJobBoard('Monster', 'ph-file-text', '#6E46AE', 289, false)}
                        ${renderJobBoard('CareerBuilder', 'ph-briefcase-metal', '#0B7A3E', 356, false)}
                    </div>

                    <!-- Recent Alerts -->
                    <div style="margin-top: 32px; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="font-family: var(--font-family-ui); font-size: 18px; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-bell-ringing"></i>
                            Active Job Alerts
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${renderAlertCard('Data Analyst', 'Remote', 'Daily', 3)}
                            ${renderAlertCard('Business Analyst', 'Minneapolis, MN', 'Weekly', 0)}
                            ${renderAlertCard('Operations Manager', 'Twin Cities Metro', 'Daily', 7)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderJobBoard(name, icon, color, count, enabled) {
            return `
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${color}; ${!enabled ? 'opacity: 0.6;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: ${color}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                                <i class="ph ${icon}"></i>
                            </div>
                            <div>
                                <h4 style="font-family: var(--font-family-ui); font-size: 18px; color: var(--color-dark); margin: 0 0 4px 0;">${name}</h4>
                                <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); margin: 0;">${count.toLocaleString()} jobs found</p>
                            </div>
                        </div>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleJobBoard('${name}', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                        </label>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="searchJobBoard('${name}')" style="flex: 1; padding: 8px 16px; background: ${color}; color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-weight: 600; cursor: pointer; font-size: 13px; ${!enabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${!enabled ? 'disabled' : ''}>
                            View Results
                        </button>
                        <button onclick="configureSource('${name}')" style="padding: 8px 12px; background: var(--color-neutral-background); color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer;">
                            <i class="ph ph-gear"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAlertCard(title, location, frequency, newJobs) {
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--color-neutral-background); border-radius: 8px; border: 1px solid var(--color-neutral-border);">
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${title}</div>
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light);">
                            <i class="ph ph-map-pin"></i> ${location} · ${frequency} alerts
                        </div>
                    </div>
                    ${newJobs > 0 ? `
                        <div style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600;">
                            ${newJobs} new
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 8px; margin-left: 16px;">
                        <button onclick="editAlert('${title}')" style="padding: 6px 12px; background: white; color: var(--color-primary-blue); border: 1px solid var(--color-primary-blue); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Edit
                        </button>
                        <button onclick="deleteAlert('${title}')" style="padding: 6px 12px; background: white; color: #c33; border: 1px solid #c33; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Delete
                        </button>
                    </div>
                </div>
            `;
        }

        // Job search action functions
        function openAlertSettings() {
            alert('Alert Configuration:\n\nConfigure automated job alerts based on:\n• Keywords and job titles\n• Location preferences\n• Salary ranges\n• Company size and industry\n• Remote/hybrid/on-site preferences\n• Frequency (instant, daily, weekly)\n\nAlerts will be sent via email and push notifications.');
        }

        function toggleJobBoard(name, enabled) {
            console.log(`${name} ${enabled ? 'enabled' : 'disabled'}`);
            loadJobSearchView();
        }

        function searchJobBoard(name) {
            alert(`Opening ${name} search results...\n\nThis would display job listings from ${name} matching your current search criteria.`);
        }

        function configureSource(name) {
            alert(`Configure ${name} Settings:\n\n• API credentials\n• Search parameters\n• Auto-apply preferences\n• Salary range filters\n• Experience level requirements`);
        }

        function editAlert(title) {
            alert(`Edit Alert: ${title}\n\nModify search criteria, location, frequency, and notification preferences.`);
        }

        function deleteAlert(title) {
            if (confirm(`Delete alert for "${title}"?`)) {
                alert('Alert deleted successfully.');
            }
        }

        // Job Search Sankey Functions
        let sankeyExpanded = false;

        function toggleJobSearchSankey() {
            sankeyExpanded = !sankeyExpanded;
            const container = document.getElementById('sankeyContainer');
            const icon = document.getElementById('sankeyToggleIcon');

            if (sankeyExpanded) {
                container.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
                // Initialize Sankey diagram
                setTimeout(() => initializeJobSearchSankey(), 100);
            } else {
                container.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function initializeJobSearchSankey() {
            const container = document.getElementById('jobSearchSankey');
            if (!container) return;

            // Clear any existing content
            d3.select('#jobSearchSankey').selectAll('*').remove();

            const width = container.clientWidth;
            const height = 400;

            // Calculate total found from enabled job boards
            const totalFound = 847 + 1203 + 412; // 2462 jobs from enabled boards

            // Cleansheet color scheme - professional blues with accent colors
            const data = {
                nodes: [
                    { name: 'Found' },        // 0
                    { name: 'Interested' },   // 1
                    { name: 'Applied' },      // 2
                    { name: 'Interviewing' }, // 3
                    { name: 'Offer' }         // 4
                ],
                links: [
                    { source: 0, target: 1, value: 150, color: '#B3D9FF' },  // Light blue
                    { source: 1, target: 2, value: 80, color: '#80BFFF' },   // Medium blue
                    { source: 2, target: 3, value: 25, color: '#4D9FFF' },   // Primary blue
                    { source: 3, target: 4, value: 3, color: '#0066CC' }     // Cleansheet primary blue
                ]
            };

            // Create SVG
            const svg = d3.select('#jobSearchSankey')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Define gradient for each link
            const defs = svg.append('defs');

            data.links.forEach((link, i) => {
                const gradient = defs.append('linearGradient')
                    .attr('id', `gradient-${i}`)
                    .attr('gradientUnits', 'userSpaceOnUse');

                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', link.color)
                    .attr('stop-opacity', 0.6);

                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', link.color)
                    .attr('stop-opacity', 0.3);
            });

            // Create Sankey generator
            const sankey = d3.sankey()
                .nodeWidth(15)  // Thin vertical bars
                .nodePadding(50)  // Generous spacing
                .extent([[80, 20], [width - 200, height - 20]]);

            // Generate Sankey layout
            const { nodes, links } = sankey({
                nodes: data.nodes.map(d => Object.assign({}, d)),
                links: data.links.map(d => Object.assign({}, d))
            });

            // Custom link path generator for smooth curves
            const linkPath = d3.linkHorizontal()
                .source(d => [d.source.x1, d.y0])
                .target(d => [d.target.x0, d.y1]);

            // Draw links with gradient fills
            svg.append('g')
                .selectAll('path')
                .data(links)
                .join('path')
                .attr('d', d => {
                    // Create smooth S-curve path
                    const sourceX = d.source.x1;
                    const targetX = d.target.x0;
                    const sourceY = d.y0;
                    const targetY = d.y1;
                    const sourceHeight = d.width;

                    const path = d3.path();
                    const midX = (sourceX + targetX) / 2;

                    path.moveTo(sourceX, sourceY);
                    path.bezierCurveTo(midX, sourceY, midX, targetY, targetX, targetY);
                    path.lineTo(targetX, targetY + sourceHeight);
                    path.bezierCurveTo(midX, targetY + sourceHeight, midX, sourceY + sourceHeight, sourceX, sourceY + sourceHeight);
                    path.closePath();

                    return path.toString();
                })
                .attr('fill', (d, i) => `url(#gradient-${i})`)
                .attr('opacity', 0.7)
                .on('mouseover', function() {
                    d3.select(this).attr('opacity', 0.9);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('opacity', 0.7);
                })
                .append('title')
                .text(d => `${d.source.name} → ${d.target.name}\n${d.value} jobs`);

            // Draw nodes as thin bars
            svg.append('g')
                .selectAll('rect')
                .data(nodes)
                .join('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', '#0066CC')
                .attr('opacity', 0.8);

            // Add stage labels to the left
            svg.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .attr('x', d => d.x0 - 10)
                .attr('y', d => (d.y0 + d.y1) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'end')
                .attr('font-family', 'var(--font-family-ui)')
                .attr('font-size', '14px')
                .attr('font-weight', '600')
                .attr('fill', '#333')
                .text(d => d.name);

            // Add count labels to the right
            svg.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .attr('x', d => d.x1 + 10)
                .attr('y', d => (d.y0 + d.y1) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'start')
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '18px')
                .attr('font-weight', '700')
                .attr('fill', '#0066CC')
                .text(d => {
                    if (d.name === 'Found') return totalFound.toLocaleString();
                    return d.value.toLocaleString();
                });

            // Add conversion percentages below count labels
            svg.append('g')
                .selectAll('text')
                .data(nodes.filter((d, i) => i > 0))
                .join('text')
                .attr('x', d => d.x1 + 10)
                .attr('y', d => (d.y0 + d.y1) / 2 + 18)
                .attr('text-anchor', 'start')
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '11px')
                .attr('font-weight', '400')
                .attr('fill', '#666')
                .text((d, i) => {
                    const conversions = [6.1, 53.3, 31.3, 12.0];
                    return `${conversions[i].toFixed(1)}% conv.`;
                });
        }

        // Library View Functions
        let showRecommendedOnly = false;

        function loadLibraryView() {
            const container = document.getElementById('libraryView');

            const sampleArticles = [
                {
                    title: 'Understanding CI/CD Pipelines',
                    summary: 'Comprehensive guide to continuous integration and deployment workflows, covering best practices and tooling.',
                    tags: ['DevOps', 'Automation', 'Testing'],
                    level: 'Intermediate',
                    readTime: '12 min',
                    recommended: true
                },
                {
                    title: 'Introduction to Docker Containers',
                    summary: 'Learn the fundamentals of containerization with Docker, including images, volumes, and networking.',
                    tags: ['Docker', 'Cloud', 'DevOps'],
                    level: 'Beginner',
                    readTime: '15 min',
                    recommended: true
                },
                {
                    title: 'Advanced SQL Query Optimization',
                    summary: 'Deep dive into query performance tuning, indexing strategies, and execution plan analysis.',
                    tags: ['Data Analysis', 'SQL', 'Performance'],
                    level: 'Advanced',
                    readTime: '20 min',
                    recommended: false
                },
                {
                    title: 'Project Management Fundamentals',
                    summary: 'Essential project management concepts including scope, timeline, resource allocation, and stakeholder communication.',
                    tags: ['Project Management', 'Professional Skills', 'Leadership'],
                    level: 'Beginner',
                    readTime: '10 min',
                    recommended: true
                },
                {
                    title: 'Kubernetes Deployment Strategies',
                    summary: 'Explore rolling updates, blue-green deployments, and canary releases in Kubernetes environments.',
                    tags: ['Kubernetes', 'Cloud', 'DevOps'],
                    level: 'Advanced',
                    readTime: '18 min',
                    recommended: false
                },
                {
                    title: 'Data Visualization Best Practices',
                    summary: 'Learn to create effective charts and dashboards that communicate insights clearly to stakeholders.',
                    tags: ['Data Analysis', 'Visualization', 'Career Development'],
                    level: 'Intermediate',
                    readTime: '14 min',
                    recommended: true
                }
            ];

            const filteredArticles = showRecommendedOnly ? sampleArticles.filter(a => a.recommended) : sampleArticles;

            container.innerHTML = `
                <div style="display: flex; height: 100%;">
                    <!-- Left Sidebar -->
                    <div style="width: 320px; background: var(--color-dark); color: white; display: flex; flex-direction: column; flex-shrink: 0;">
                        <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <h2 style="font-family: var(--font-family-ui); font-size: 20px; margin-bottom: 8px;">Cleansheet Library</h2>
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7);">Curated technical content</p>
                        </div>

                        <div style="padding: 20px; flex: 1; overflow-y: auto;">
                            <!-- Search -->
                            <input type="text" placeholder="Search articles..." style="width: 100%; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; margin-bottom: 16px;">

                            <!-- Recommended Toggle -->
                            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(0, 102, 204, 0.2); border-radius: 6px; cursor: pointer; margin-bottom: 16px;">
                                <input type="checkbox" ${showRecommendedOnly ? 'checked' : ''} onchange="toggleRecommended(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600;">Recommended for You</span>
                            </label>

                            <!-- Stats -->
                            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                                <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Showing</div>
                                <div style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600;">${filteredArticles.length} articles</div>
                            </div>

                            <!-- Filter Tags -->
                            <div style="margin-top: 20px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.7);">Topics</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${['DevOps', 'Cloud', 'Data Analysis', 'Project Management'].map(tag =>
                                        `<div style="padding: 6px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; font-size: 11px; cursor: pointer;">${tag}</div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Area -->
                    <div style="flex: 1; padding: 24px; overflow-y: auto;">
                        <div style="max-width: 1200px; margin: 0 auto;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                                ${filteredArticles.map(article => renderLibraryArticleCard(article)).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLibraryArticleCard(article) {
            return `
                <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column;">
                    <!-- Header -->
                    <div style="padding: 16px; border-bottom: 1px solid var(--color-neutral-border);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <span style="background: ${article.level === 'Beginner' ? '#4caf50' : article.level === 'Intermediate' ? '#ff9800' : '#f44336'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">${article.level}</span>
                            ${article.recommended ? '<i class="ph ph-star-fill" style="color: #ff9800; font-size: 18px;"></i>' : ''}
                        </div>
                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; color: var(--color-dark); margin-bottom: 8px; line-height: 1.4;">${article.title}</h3>
                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); line-height: 1.5; margin-bottom: 12px;">${article.summary}</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px;">
                            ${article.tags.map(tag => `<span style="background: #e3f2fd; color: var(--color-primary-blue); padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">${tag}</span>`).join('')}
                        </div>
                        <div style="font-size: 11px; color: var(--color-neutral-text-muted); display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-clock"></i> ${article.readTime}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="padding: 12px; background: var(--color-neutral-background); display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <button onclick="listenToArticle('${article.title}')" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='var(--color-primary-blue)'; this.style.color='white'; this.style.borderColor='var(--color-primary-blue)';" onmouseout="this.style.background='white'; this.style.color='var(--color-neutral-text)'; this.style.borderColor='var(--color-neutral-border)';">
                            <i class="ph ph-play-circle" style="font-size: 18px;"></i>
                            <span style="font-size: 10px; font-weight: 600;">Listen</span>
                        </button>
                        <button onclick="chatAboutArticle('${article.title}')" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='var(--color-primary-blue)'; this.style.color='white'; this.style.borderColor='var(--color-primary-blue)';" onmouseout="this.style.background='white'; this.style.color='var(--color-neutral-text)'; this.style.borderColor='var(--color-neutral-border)';">
                            <i class="ph ph-chat-circle-dots" style="font-size: 18px;"></i>
                            <span style="font-size: 10px; font-weight: 600;">Chat</span>
                        </button>
                        <button onclick="translateArticle('${article.title}')" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='var(--color-primary-blue)'; this.style.color='white'; this.style.borderColor='var(--color-primary-blue)';" onmouseout="this.style.background='white'; this.style.color='var(--color-neutral-text)'; this.style.borderColor='var(--color-neutral-border)';">
                            <i class="ph ph-translate" style="font-size: 18px;"></i>
                            <span style="font-size: 10px; font-weight: 600;">Translate</span>
                        </button>
                        <button onclick="addToMyLibrary('${article.title}')" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='var(--color-primary-blue)'; this.style.color='white'; this.style.borderColor='var(--color-primary-blue)';" onmouseout="this.style.background='white'; this.style.color='var(--color-neutral-text)'; this.style.borderColor='var(--color-neutral-border)';">
                            <i class="ph ph-bookmark" style="font-size: 18px;"></i>
                            <span style="font-size: 10px; font-weight: 600;">Add</span>
                        </button>
                        <button onclick="summarizeArticle('${article.title}')" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='var(--color-primary-blue)'; this.style.color='white'; this.style.borderColor='var(--color-primary-blue)';" onmouseout="this.style.background='white'; this.style.color='var(--color-neutral-text)'; this.style.borderColor='var(--color-neutral-border)';">
                            <i class="ph ph-note-pencil" style="font-size: 18px;"></i>
                            <span style="font-size: 10px; font-weight: 600;">Summarize</span>
                        </button>
                        <button onclick="sendToMobile('${article.title}')" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='var(--color-primary-blue)'; this.style.color='white'; this.style.borderColor='var(--color-primary-blue)';" onmouseout="this.style.background='white'; this.style.color='var(--color-neutral-text)'; this.style.borderColor='var(--color-neutral-border)';">
                            <i class="ph ph-device-mobile" style="font-size: 18px;"></i>
                            <span style="font-size: 10px; font-weight: 600;">Mobile</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleRecommended(checked) {
            showRecommendedOnly = checked;
            loadLibraryView();
        }

        // Library action functions
        function listenToArticle(title) {
            alert(`Listen to: "${title}"\n\nThis will convert the article to audio using text-to-speech and play it for you. You can adjust speed, voice, and download the audio file.`);
        }

        function chatAboutArticle(title) {
            alert(`Chat about: "${title}"\n\nOpen an AI-powered chat interface to discuss the article content, ask questions, and explore related concepts.`);
        }

        function translateArticle(title) {
            alert(`Translate: "${title}"\n\nChoose from 50+ languages including Spanish, Mandarin, French, German, Japanese, and more. Translation is powered by advanced ML models.`);
        }

        function addToMyLibrary(title) {
            alert(`Added to My Library: "${title}"\n\nThis article is now saved to your personal library for offline access and future reference.`);
        }

        function summarizeArticle(title) {
            alert(`Summarize: "${title}"\n\nGenerate a concise summary highlighting key points, main concepts, and actionable takeaways in bullet-point format.`);
        }

        function sendToMobile(title) {
            alert(`Send to Mobile: "${title}"\n\nThis article will be sent to your mobile device via the Cleansheet mobile app or email. You'll receive a notification when it's ready.`);
        }

        // Close modal on background click
        document.getElementById('canvasModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCanvasModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCanvasModal();

                // Close any active modals
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                }
            }
        });

        // AI Assistant Functions
        function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            const messagesContainer = document.getElementById('aiMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'ai-message user';
            userMsg.textContent = message;
            messagesContainer.appendChild(userMsg);

            // Clear input
            input.value = '';

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Simulate AI response after a delay
            setTimeout(() => {
                const aiMsg = document.createElement('div');
                aiMsg.className = 'ai-message assistant';
                aiMsg.textContent = getAIResponse(message);
                messagesContainer.appendChild(aiMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 800);
        }

        function getAIResponse(message) {
            const msg = message.toLowerCase();

            if (msg.includes('resume') || msg.includes('cv')) {
                return "I can help you optimize your resume! Here are some tips:\n\n• Use action verbs (Led, Developed, Achieved)\n• Quantify your accomplishments with metrics\n• Tailor your resume to each job description\n• Keep it to 1-2 pages max\n\nWould you like me to review a specific section?";
            } else if (msg.includes('interview')) {
                return "Great question! For interview prep:\n\n• Research the company thoroughly\n• Practice STAR method responses\n• Prepare 3-5 questions to ask them\n• Review your resume and be ready to discuss each item\n• Do a mock interview with a friend\n\nWhat type of interview are you preparing for?";
            } else if (msg.includes('cover letter')) {
                return "Cover letter tips:\n\n• Keep it to 3-4 paragraphs\n• Show enthusiasm for the specific role\n• Connect your experience to their needs\n• Include a clear call to action\n• Proofread carefully!\n\nWant help with a specific section?";
            } else if (msg.includes('career') || msg.includes('path')) {
                return "I can help you explore career paths! Based on your profile, I see opportunities in:\n\n• Cloud Operations roles\n• DevOps Engineering\n• Site Reliability Engineering\n• Platform Engineering\n\nWhich area interests you most?";
            } else if (msg.includes('job') || msg.includes('search')) {
                return "Job search strategies that work:\n\n• Apply to 3-5 targeted roles per day\n• Network actively on LinkedIn\n• Leverage your alumni network\n• Follow up after applications\n• Track everything in your Canvas\n\nWhat part of the job search do you need help with?";
            } else {
                return "I'm here to help with your job search! I can assist with resumes, cover letters, interview prep, career guidance, and job search strategies. What would you like to work on?";
            }
        }

        // Outlook Sync Function
        function syncOutlook() {
            const btn = event.target.closest('.sync-btn');
            const originalHTML = btn.innerHTML;
            const icon = btn.querySelector('i');

            // Disable button during sync
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.cursor = 'not-allowed';

            // Show syncing state with smooth animation
            icon.className = 'ph ph-arrows-clockwise';
            icon.style.animation = 'rotate-smooth 1.2s ease-in-out infinite';
            btn.querySelector('i').nextSibling.textContent = ' Syncing...';

            // Simulate sync
            setTimeout(() => {
                // Success state with checkmark
                icon.className = 'ph ph-check-circle';
                icon.style.animation = 'scale-in 0.3s ease-out';
                icon.style.color = '#22c55e';
                btn.querySelector('i').nextSibling.textContent = ' Synced!';

                // Add a new synced event with fade-in animation
                const eventsContainer = document.getElementById('calendarEvents');
                const newEvent = document.createElement('div');
                newEvent.className = 'calendar-event';
                newEvent.style.borderLeftColor = '#22c55e';
                newEvent.style.opacity = '0';
                newEvent.style.transform = 'translateY(-10px)';
                newEvent.style.transition = 'all 0.4s ease-out';
                newEvent.innerHTML = `
                    <div class="event-time">Next Mon, 1:00 PM</div>
                    <div class="event-title">Phone Screen: Cloud Engineer</div>
                    <div class="event-details">Microsoft Azure - Recruiter Call</div>
                `;
                eventsContainer.appendChild(newEvent);

                // Trigger fade-in animation
                setTimeout(() => {
                    newEvent.style.opacity = '1';
                    newEvent.style.transform = 'translateY(0)';
                }, 50);

                // Reset button after 2.5 seconds
                setTimeout(() => {
                    icon.style.animation = 'none';
                    icon.style.color = '';
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }, 2500);
            }, 1200);
        }

        // Add professional animations for sync button
        const style = document.createElement('style');
        style.textContent = `
            @keyframes rotate-smooth {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            @keyframes scale-in {
                0% { transform: scale(0.5); opacity: 0; }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); opacity: 1; }
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // D3 Learner Network - Force-Directed Layout
        function initializeLearnerNetwork(persona) {
            const container = document.getElementById('canvas-mindmap');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Get persona data
            const data = getFilteredPersonaData(persona);
            if (!data) return;

            // Create network data
            const networkData = {
                nodes: [],
                links: []
            };

            // Add center node (learner)
            networkData.nodes.push({
                id: 'center',
                label: data.name,
                tier: 'center',
                x: width / 2,
                y: height / 2
            });

            // Two-tier structure: Center → Features (used by all view modes now)
            // In Personal mode with children: Three-tier structure: Center → Features → Children
            // For Finance and Shopping in Personal mode: Start collapsed, expand on click
            data.children.forEach((feature, idx) => {
                const featureId = `feature-${idx}`;
                const hasChildren = feature.children && feature.children.length > 0;
                const shouldStartCollapsed = currentViewMode === 'personal' &&
                    (feature.name === 'Finance' || feature.name === 'Shopping');

                networkData.nodes.push({
                    id: featureId,
                    label: feature.name,
                    tier: 'primary',
                    count: feature.count,
                    icon: feature.icon,
                    data: feature,
                    expanded: !shouldStartCollapsed,  // Track expansion state
                    hasChildren: hasChildren
                });

                // Link feature directly to center
                networkData.links.push({
                    source: 'center',
                    target: featureId
                });

                // Add child nodes if they exist AND (not Finance/Shopping OR already expanded)
                if (hasChildren && !shouldStartCollapsed) {
                    feature.children.forEach((child, childIdx) => {
                        const childId = `child-${idx}-${childIdx}`;
                        networkData.nodes.push({
                            id: childId,
                            label: child.name,
                            tier: 'tertiary',
                            count: child.count,
                            icon: child.icon,
                            data: child,
                            parentId: featureId
                        });

                        // Link child to parent feature
                        networkData.links.push({
                            source: featureId,
                            target: childId
                        });
                    });
                }
            });

            // Set initial positions for Personal mode to ensure viewport fit
            if (currentViewMode === 'personal') {
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = 180; // Distance from center to primary nodes
                const childRadius = 100; // Distance from primary to tertiary nodes

                networkData.nodes.forEach((node, i) => {
                    if (node.tier === 'center') {
                        node.x = centerX;
                        node.y = centerY;
                    } else if (node.tier === 'primary') {
                        // Arrange primary nodes in circle around center
                        const primaryNodes = networkData.nodes.filter(n => n.tier === 'primary');
                        const index = primaryNodes.indexOf(node);
                        const angle = (index / primaryNodes.length) * 2 * Math.PI - Math.PI / 2;
                        node.x = centerX + Math.cos(angle) * radius;
                        node.y = centerY + Math.sin(angle) * radius;
                    }
                });

                // Position child nodes around their parents
                networkData.links.forEach(link => {
                    const sourceNode = networkData.nodes.find(n => n.id === link.source);
                    const targetNode = networkData.nodes.find(n => n.id === link.target);

                    if (targetNode && targetNode.tier === 'tertiary' && sourceNode && sourceNode.x) {
                        // Get all children of this parent
                        const parentLinks = networkData.links.filter(l => l.source === sourceNode.id);
                        const childNodes = parentLinks.map(l => networkData.nodes.find(n => n.id === l.target));
                        const childIndex = childNodes.indexOf(targetNode);

                        // Calculate angle for this child
                        const baseAngle = Math.atan2(sourceNode.y - centerY, sourceNode.x - centerX);
                        const spreadAngle = Math.PI / 3; // 60 degree spread
                        const startAngle = baseAngle - spreadAngle / 2;
                        const angle = startAngle + (childIndex / (childNodes.length - 1 || 1)) * spreadAngle;

                        targetNode.x = sourceNode.x + Math.cos(angle) * childRadius;
                        targetNode.y = sourceNode.y + Math.sin(angle) * childRadius;
                    }
                });
            }

            // Function to toggle node expansion (for Finance and Shopping in Personal mode)
            function toggleNodeExpansion(clickedNode, networkData, nodeSelection, linkSelection, simulation) {
                // Collapse all other primary nodes with children
                networkData.nodes.filter(n => n.tier === 'primary' && n.hasChildren && n.id !== clickedNode.id)
                    .forEach(n => {
                        if (n.expanded) {
                            n.expanded = false;
                            // Remove child nodes and links
                            const childNodesToRemove = networkData.nodes.filter(child => child.parentId === n.id);
                            childNodesToRemove.forEach(child => {
                                const childIndex = networkData.nodes.indexOf(child);
                                if (childIndex > -1) networkData.nodes.splice(childIndex, 1);
                            });
                            networkData.links = networkData.links.filter(l => l.source.id !== n.id && l.target.id !== n.id);
                        }
                    });

                // Toggle the clicked node
                clickedNode.expanded = !clickedNode.expanded;

                if (clickedNode.expanded) {
                    // Add children
                    const feature = data.children.find(f => f.name === clickedNode.label);
                    if (feature && feature.children) {
                        const idx = data.children.indexOf(feature);
                        const centerX = width / 2;
                        const centerY = height / 2;
                        const childRadius = 100;

                        feature.children.forEach((child, childIdx) => {
                            const childId = `child-${idx}-${childIdx}`;
                            const childNode = {
                                id: childId,
                                label: child.name,
                                tier: 'tertiary',
                                count: child.count,
                                icon: child.icon,
                                data: child,
                                parentId: clickedNode.id
                            };

                            // Position child near parent
                            const baseAngle = Math.atan2(clickedNode.y - centerY, clickedNode.x - centerX);
                            const spreadAngle = Math.PI / 3;
                            const startAngle = baseAngle - spreadAngle / 2;
                            const angle = startAngle + (childIdx / (feature.children.length - 1 || 1)) * spreadAngle;

                            childNode.x = clickedNode.x + Math.cos(angle) * childRadius;
                            childNode.y = clickedNode.y + Math.sin(angle) * childRadius;

                            networkData.nodes.push(childNode);
                            networkData.links.push({
                                source: clickedNode.id,
                                target: childId
                            });
                        });
                    }
                } else {
                    // Remove children
                    const childNodesToRemove = networkData.nodes.filter(child => child.parentId === clickedNode.id);
                    childNodesToRemove.forEach(child => {
                        const childIndex = networkData.nodes.indexOf(child);
                        if (childIndex > -1) networkData.nodes.splice(childIndex, 1);
                    });
                    networkData.links = networkData.links.filter(l => {
                        const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                        const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                        return sourceId !== clickedNode.id;
                    });
                }

                // Update D3 visualization
                updateVisualization();
            }

            function updateVisualization() {
                // Update links - use proper D3 data join pattern
                const linkGroup = svg.selectAll('g').filter(function() {
                    return d3.select(this).selectAll('line').size() > 0;
                }).empty() ? svg.append('g') : svg.selectAll('g').filter(function() {
                    return d3.select(this).selectAll('line').size() > 0;
                });

                const linkUpdate = linkGroup.selectAll('line')
                    .data(networkData.links, d => {
                        const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                        const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                        return `${sourceId}-${targetId}`;
                    });

                linkUpdate.exit().transition().duration(300).style('opacity', 0).remove();

                const linkEnter = linkUpdate.enter()
                    .append('line')
                    .attr('stroke', 'rgba(34, 197, 94, 0.3)')
                    .attr('stroke-width', 2)
                    .style('opacity', 0);

                linkEnter.transition().duration(300).style('opacity', 1);

                // Merge for positioning updates
                const linkMerged = linkEnter.merge(linkUpdate);

                // Update nodes
                const nodeUpdate = svg.selectAll('g.network-node')
                    .data(networkData.nodes, d => d.id);

                nodeUpdate.exit().transition().duration(300).style('opacity', 0).remove();

                const nodeEnter = nodeUpdate.enter()
                    .append('g')
                    .attr('class', d => `network-node ${d.tier}`)
                    .style('opacity', 0)
                    .call(d3.drag()
                        .on('start', dragstarted)
                        .on('drag', dragged)
                        .on('end', dragended));

                // Add rectangles
                nodeEnter.each(function(d) {
                    const g = d3.select(this);
                    const rectWidth = d.icon ? 150 : 130;
                    g.append('rect')
                        .attr('width', rectWidth)
                        .attr('height', 35)
                        .attr('x', -rectWidth / 2)
                        .attr('y', -17.5)
                        .attr('fill', 'rgba(34, 197, 94, 0.2)')
                        .attr('rx', 6)
                        .style('cursor', 'pointer');

                    // Add icon
                    if (d.icon) {
                        g.append('foreignObject')
                            .attr('width', 20)
                            .attr('height', 20)
                            .attr('x', -70)
                            .attr('y', -10)
                            .append('xhtml:div')
                            .style('width', '20px')
                            .style('height', '20px')
                            .style('display', 'flex')
                            .style('align-items', 'center')
                            .style('justify-content', 'center')
                            .style('pointer-events', 'none')
                            .html(`<i class="ph ${d.icon}" style="font-size: 16px; color: #16a34a;"></i>`);
                    }

                    // Add text
                    g.append('text')
                        .attr('dy', '0.35em')
                        .attr('x', d.icon ? -46 : 0)
                        .attr('text-anchor', d.icon ? 'start' : 'middle')
                        .attr('font-family', 'var(--font-family-ui)')
                        .attr('font-size', '12px')
                        .attr('font-weight', '500')
                        .attr('fill', '#1a1a1a')
                        .attr('pointer-events', 'none')
                        .text(d.label);
                });

                // Add click handlers for new tertiary nodes
                nodeEnter.filter(d => d.tier === 'tertiary')
                    .on('click', function(event, d) {
                        event.stopPropagation();
                        handleFeatureClick(d.label);
                    })
                    .on('mouseover', function() {
                        d3.select(this).select('rect')
                            .transition().duration(200)
                            .attr('fill', 'rgba(34, 197, 94, 0.4)');
                    })
                    .on('mouseout', function() {
                        d3.select(this).select('rect')
                            .transition().duration(200)
                            .attr('fill', 'rgba(34, 197, 94, 0.2)');
                    });

                nodeEnter.transition().duration(300).style('opacity', 1);

                // Update simulation with new data
                simulation.nodes(networkData.nodes);
                simulation.force('link').links(networkData.links);

                // Update positions in tick function
                simulation.on('tick', () => {
                    linkMerged
                        .attr('x1', d => {
                            const source = typeof d.source === 'object' ? d.source : networkData.nodes.find(n => n.id === d.source);
                            return source ? source.x : 0;
                        })
                        .attr('y1', d => {
                            const source = typeof d.source === 'object' ? d.source : networkData.nodes.find(n => n.id === d.source);
                            return source ? source.y : 0;
                        })
                        .attr('x2', d => {
                            const target = typeof d.target === 'object' ? d.target : networkData.nodes.find(n => n.id === d.target);
                            return target ? target.x : 0;
                        })
                        .attr('y2', d => {
                            const target = typeof d.target === 'object' ? d.target : networkData.nodes.find(n => n.id === d.target);
                            return target ? target.y : 0;
                        });

                    svg.selectAll('g.network-node')
                        .attr('transform', d => `translate(${d.x},${d.y})`);
                });

                simulation.alpha(0.3).restart();
            }

            // Create SVG
            const svg = d3.select('#canvas-mindmap')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height]);

            // Create force simulation with adjusted parameters for three tiers
            const simulation = d3.forceSimulation(networkData.nodes)
                .force('link', d3.forceLink(networkData.links)
                    .id(d => d.id)
                    .distance(d => {
                        // Personal mode: shorter distances for tighter layout
                        if (currentViewMode === 'personal') {
                            if (d.source.tier === 'center') return 120;  // Center to primary
                            return 80;  // Primary to tertiary (children)
                        }
                        // Learner mode: original distances
                        if (d.source.tier === 'center') return 150;
                        return 200;
                    })
                    .strength(currentViewMode === 'personal' ? 0.5 : 0.3))
                .force('charge', d3.forceManyBody().strength(currentViewMode === 'personal' ? -150 : -300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => {
                    if (d.tier === 'center') return 75;
                    if (d.tier === 'secondary') return 85;
                    return 75;
                }));

            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(networkData.links)
                .join('line')
                .attr('stroke', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(0, 102, 204, 0.3)')
                .attr('stroke-width', 2);

            // Create nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(networkData.nodes)
                .join('g')
                .attr('class', d => `network-node ${d.tier}`)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add rectangles for all nodes
            node.each(function(d) {
                const g = d3.select(this);

                if (d.tier === 'center') {
                    g.append('rect')
                        .attr('width', 140)
                        .attr('height', 40)
                        .attr('x', -70)
                        .attr('y', -20)
                        .attr('fill', currentViewMode === 'personal' ? '#16a34a' : 'var(--color-primary-blue)')
                        .attr('rx', 6);
                } else if (d.tier === 'secondary') {
                    // Secondary nodes (Professional/Personal in Learner mode) - larger, darker
                    g.append('rect')
                        .attr('width', 150)
                        .attr('height', 45)
                        .attr('x', -75)
                        .attr('y', -22.5)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.5)' : 'rgba(0, 102, 204, 0.5)')
                        .attr('rx', 6)
                        .style('cursor', 'pointer');
                } else if (d.tier === 'primary') {
                    // Primary nodes (Professional/Personal mode features) - standard size
                    const width = currentViewMode === 'personal' && d.icon ? 160 : 140;
                    g.append('rect')
                        .attr('width', width)
                        .attr('height', 40)
                        .attr('x', -width / 2)
                        .attr('y', -20)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(0, 102, 204, 0.3)')
                        .attr('rx', 6)
                        .style('cursor', 'pointer');
                } else {
                    // Tertiary nodes (Learner mode features) - smaller, lighter
                    const width = currentViewMode === 'personal' && d.icon ? 150 : 130;
                    g.append('rect')
                        .attr('width', width)
                        .attr('height', 35)
                        .attr('x', -width / 2)
                        .attr('y', -17.5)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(0, 102, 204, 0.2)')
                        .attr('rx', 6)
                        .style('cursor', 'pointer');
                }
            });

            // Add icons for Personal mode nodes
            if (currentViewMode === 'personal') {
                node.filter(d => d.icon)
                    .append('foreignObject')
                    .attr('width', 20)
                    .attr('height', 20)
                    .attr('x', d => {
                        if (d.tier === 'primary') return -75;
                        if (d.tier === 'tertiary') return -70;
                        return -75;
                    })
                    .attr('y', d => {
                        if (d.tier === 'primary') return -10;
                        if (d.tier === 'tertiary') return -10;
                        return -10;
                    })
                    .append('xhtml:div')
                    .style('width', '20px')
                    .style('height', '20px')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('justify-content', 'center')
                    .style('pointer-events', 'none')
                    .html(d => `<i class="ph ${d.icon}" style="font-size: 16px; color: #16a34a;"></i>`);
            }

            // Add labels
            node.append('text')
                .attr('dy', '0.35em')
                .attr('x', d => {
                    // Position text after icon with small gap
                    if (currentViewMode === 'personal' && d.icon) {
                        if (d.tier === 'primary') return -75 + 24;  // Icon left edge + icon width + 4px gap
                        if (d.tier === 'tertiary') return -70 + 24;  // Icon left edge + icon width + 4px gap
                    }
                    return 0;
                })
                .attr('text-anchor', d => {
                    // Left-align text if icon exists in Personal mode
                    if (currentViewMode === 'personal' && d.icon) {
                        return 'start';
                    }
                    return 'middle';
                })
                .attr('font-family', 'var(--font-family-ui)')
                .attr('font-size', d => {
                    if (d.tier === 'center') return '14px';
                    if (d.tier === 'secondary') return '13px';
                    if (d.tier === 'primary') return '13px';
                    return '12px';
                })
                .attr('font-weight', d => d.tier === 'secondary' ? '700' : '600')
                .attr('fill', d => d.tier === 'center' ? 'white' : 'var(--color-neutral-text)')
                .attr('pointer-events', 'none')
                .text(d => d.label);

            // Add count badges for primary nodes (Professional/Personal modes)
            node.filter(d => d.tier === 'primary' && d.count > 0)
                .append('circle')
                .attr('cx', 70)
                .attr('cy', -20)
                .attr('r', 10)
                .attr('fill', currentViewMode === 'personal' ? '#dcfce7' : '#e3f2fd')
                .attr('stroke', currentViewMode === 'personal' ? '#16a34a' : 'var(--color-primary-blue)')
                .attr('stroke-width', 1);

            node.filter(d => d.tier === 'primary' && d.count > 0)
                .append('text')
                .attr('x', 70)
                .attr('y', -20)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'middle')
                .attr('font-family', 'var(--font-family-ui)')
                .attr('font-size', '10px')
                .attr('font-weight', '700')
                .attr('fill', currentViewMode === 'personal' ? '#16a34a' : 'var(--color-primary-blue)')
                .attr('pointer-events', 'none')
                .text(d => d.count);

            // Add count badges for tertiary nodes (Learner mode / Personal mode child nodes)
            node.filter(d => d.tier === 'tertiary' && d.count > 0)
                .append('circle')
                .attr('cx', 65)
                .attr('cy', -17.5)
                .attr('r', 10)
                .attr('fill', currentViewMode === 'personal' ? '#dcfce7' : '#e3f2fd')
                .attr('stroke', currentViewMode === 'personal' ? '#16a34a' : 'var(--color-primary-blue)')
                .attr('stroke-width', 1);

            node.filter(d => d.tier === 'tertiary' && d.count > 0)
                .append('text')
                .attr('x', 65)
                .attr('y', -17.5)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'middle')
                .attr('font-family', 'var(--font-family-ui)')
                .attr('font-size', '10px')
                .attr('font-weight', '700')
                .attr('fill', currentViewMode === 'personal' ? '#16a34a' : 'var(--color-primary-blue)')
                .attr('pointer-events', 'none')
                .text(d => d.count);

            // Shared click handler function for features
            function handleFeatureClick(nodeName) {
                if (nodeName === 'Career Experience') {
                    openCareerExperienceSlideout();
                } else if (nodeName === 'Goals') {
                    openSkillsCompetenciesSlideout();
                } else if (nodeName === 'Portfolio') {
                    openPortfolioSlideout();
                } else if (nodeName === 'Projects') {
                    openProjectsSlideout();
                } else if (nodeName === 'Code Snippets') {
                    openCodeSnippetsSlideout();
                } else if (nodeName === 'My Library') {
                    openMyLibrarySlideout();
                } else if (nodeName === 'My Notes') {
                    openMyNotesSlideout();
                } else if (nodeName === 'Shopping') {
                    openShoppingSlideout();
                } else if (nodeName === 'Finance') {
                    openFinanceSlideout();
                } else if (nodeName === 'Calendar') {
                    openCalendarSlideout();
                } else if (nodeName === 'Recipes') {
                    openRecipesSlideout();
                } else if (['Insurance', 'Cash Flow', 'Assets', 'Liabilities', 'Investments'].includes(nodeName)) {
                    // Finance child nodes - open Finance slideout with section context
                    openFinanceSlideout(nodeName);
                } else if (['Grocery', 'Home', 'Internet', 'Gifts'].includes(nodeName)) {
                    // Shopping child nodes - open Shopping slideout with section context
                    openShoppingSlideout(nodeName);
                }
            }

            // Click handler for primary nodes (Professional/Personal mode features)
            node.filter(d => d.tier === 'primary')
                .on('click', function(event, d) {
                    event.stopPropagation();

                    // In Personal mode, if node has children (Finance/Shopping), toggle expansion
                    if (currentViewMode === 'personal' && d.hasChildren) {
                        toggleNodeExpansion(d, networkData, node, link, simulation);
                    } else {
                        handleFeatureClick(d.label);
                    }
                })
                .on('mouseover', function(event, d) {
                    console.log('D3 mouseover triggered for node:', d.label);

                    // Visual hover effect
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.5)' : 'rgba(0, 102, 204, 0.5)');

                    // Show simple guidance tooltip
                    let tooltipText = null;
                    if (d.label === 'Job Opportunities') {
                        tooltipText = 'Opportunities you are pursuing appear here';
                    } else if (d.label === 'Application Materials') {
                        tooltipText = 'Your resumes, cover letters, and LinkedIn profile';
                    } else if (d.label === 'Career Experience') {
                        tooltipText = 'Your work history and professional background';
                    } else if (d.label === 'Skills & Competencies') {
                        tooltipText = 'Technical and professional skills you possess';
                    } else if (d.label === 'Portfolio') {
                        tooltipText = 'Projects and work samples to showcase your abilities';
                    } else if (d.label === 'Interview Prep') {
                        tooltipText = 'Practice questions and preparation materials';
                    }

                    console.log('Tooltip text for', d.label, ':', tooltipText);
                    console.log('Mouse position:', event.pageX, event.pageY);

                    if (tooltipText) {
                        guidanceTooltip.show(tooltipText, event.pageX, event.pageY);
                    }
                })
                .on('mouseout', function() {
                    console.log('D3 mouseout triggered');

                    // Visual hover effect
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(0, 102, 204, 0.3)');

                    // Hide tooltip
                    guidanceTooltip.hide();
                });

            // Click handler for tertiary nodes (Learner mode features / Personal mode child nodes)
            node.filter(d => d.tier === 'tertiary')
                .on('click', function(event, d) {
                    event.stopPropagation();
                    handleFeatureClick(d.label);
                })
                .on('mouseover', function(event, d) {
                    console.log('D3 tertiary node mouseover triggered for:', d.label);

                    // Visual hover effect
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.4)' : 'rgba(0, 102, 204, 0.4)');

                    // Simple guidance tooltip for child nodes
                    console.log('Showing "Click to view details" tooltip at:', event.pageX, event.pageY);
                    guidanceTooltip.show('Click to view details', event.pageX, event.pageY);
                })
                .on('mouseout', function() {
                    console.log('D3 tertiary node mouseout triggered');

                    // Visual hover effect
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(0, 102, 204, 0.2)');

                    // Hide tooltip
                    guidanceTooltip.hide();
                });

            // Hover handlers for secondary nodes (Learner mode categories - non-clickable)
            node.filter(d => d.tier === 'secondary')
                .on('mouseover', function() {
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.65)' : 'rgba(0, 102, 204, 0.65)');
                })
                .on('mouseout', function() {
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.5)' : 'rgba(0, 102, 204, 0.5)');
                });

            // Update positions on tick
            simulation.on('tick', () => {
                link.attr('x1', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    // Get dimensions based on source tier
                    let rectWidth, rectHeight;
                    if (d.source.tier === 'center') {
                        rectWidth = 70; rectHeight = 20;
                    } else if (d.source.tier === 'secondary') {
                        rectWidth = 75; rectHeight = 22.5;
                    } else if (d.source.tier === 'primary') {
                        rectWidth = 70; rectHeight = 20;
                    } else {
                        rectWidth = 65; rectHeight = 17.5;
                    }

                    const angle = Math.atan2(dy, dx);
                    const rectAngle = Math.atan2(rectHeight, rectWidth);
                    let offset;
                    if (Math.abs(angle) < rectAngle || Math.abs(angle) > Math.PI - rectAngle) {
                        offset = rectWidth / Math.abs(Math.cos(angle));
                    } else {
                        offset = rectHeight / Math.abs(Math.sin(angle));
                    }
                    return d.source.x + (dx / dist) * offset;
                })
                .attr('y1', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    let rectWidth, rectHeight;
                    if (d.source.tier === 'center') {
                        rectWidth = 70; rectHeight = 20;
                    } else if (d.source.tier === 'secondary') {
                        rectWidth = 75; rectHeight = 22.5;
                    } else if (d.source.tier === 'primary') {
                        rectWidth = 70; rectHeight = 20;
                    } else {
                        rectWidth = 65; rectHeight = 17.5;
                    }

                    const angle = Math.atan2(dy, dx);
                    const rectAngle = Math.atan2(rectHeight, rectWidth);
                    let offset;
                    if (Math.abs(angle) < rectAngle || Math.abs(angle) > Math.PI - rectAngle) {
                        offset = rectWidth / Math.abs(Math.cos(angle));
                    } else {
                        offset = rectHeight / Math.abs(Math.sin(angle));
                    }
                    return d.source.y + (dy / dist) * offset;
                })
                .attr('x2', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    // Get dimensions based on target tier
                    let rectWidth, rectHeight;
                    if (d.target.tier === 'center') {
                        rectWidth = 70; rectHeight = 20;
                    } else if (d.target.tier === 'secondary') {
                        rectWidth = 75; rectHeight = 22.5;
                    } else if (d.target.tier === 'primary') {
                        rectWidth = 70; rectHeight = 20;
                    } else {
                        rectWidth = 65; rectHeight = 17.5;
                    }

                    const angle = Math.atan2(dy, dx);
                    const rectAngle = Math.atan2(rectHeight, rectWidth);
                    let offset;
                    if (Math.abs(angle) < rectAngle || Math.abs(angle) > Math.PI - rectAngle) {
                        offset = rectWidth / Math.abs(Math.cos(angle));
                    } else {
                        offset = rectHeight / Math.abs(Math.sin(angle));
                    }
                    return d.target.x - (dx / dist) * offset;
                })
                .attr('y2', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    let rectWidth, rectHeight;
                    if (d.target.tier === 'center') {
                        rectWidth = 70; rectHeight = 20;
                    } else if (d.target.tier === 'secondary') {
                        rectWidth = 75; rectHeight = 22.5;
                    } else if (d.target.tier === 'primary') {
                        rectWidth = 70; rectHeight = 20;
                    } else {
                        rectWidth = 65; rectHeight = 17.5;
                    }

                    const angle = Math.atan2(dy, dx);
                    const rectAngle = Math.atan2(rectHeight, rectWidth);
                    let offset;
                    if (Math.abs(angle) < rectAngle || Math.abs(angle) > Math.PI - rectAngle) {
                        offset = rectWidth / Math.abs(Math.cos(angle));
                    } else {
                        offset = rectHeight / Math.abs(Math.sin(angle));
                    }
                    return d.target.y - (dy / dist) * offset;
                });

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag functions
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        }

        // D3 Mindmap Initialization - Tree Layout (Left to Right)
        function initializeMindmap(persona) {
            const container = document.getElementById('canvas-mindmap');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Reset expanded node
            expandedNode = null;

            // Get persona-specific data (filtered based on view mode)
            const data = getFilteredPersonaData(persona);
            if (!data) return;

            // Mindmap data structure - keep all children for D3 to see
            const mindmapData = {
                name: data.name + "'s Canvas",
                goal: data.goal,
                children: data.children // Keep full data structure
            };

            // Create SVG with expandable dimensions
            const svg = d3.select('#canvas-mindmap')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .style('min-width', width + 'px')
                .style('min-height', height + 'px');

            // Create a group for zoom/pan - center root node horizontally
            const g = svg.append('g')
                .attr('transform', `translate(150, ${height / 2})`);

            // Create hierarchy - D3 will now see all children
            const root = d3.hierarchy(mindmapData);
            root.x0 = 0; // Centered at transform origin
            root.y0 = 0;

            // Now collapse second-level children (hide grandchildren initially)
            if (root.children) {
                root.children.forEach(child => {
                    if (child.children) {
                        child._children = child.children;
                        child.children = null;
                    }
                });
            }

            // Define constants for rectangles
            const rootWidth = 140;
            const rootHeight = 60;
            const childWidth = 180;
            const childHeight = 50;
            const grandchildWidth = 250;
            const grandchildHeight = 40;

            // Create groups for links and nodes
            const linkGroup = g.append('g').attr('class', 'links');
            const nodeGroup = g.append('g').attr('class', 'nodes');

            // Function to update the tree
            function update(source) {
                // Count visible nodes to calculate needed height
                const visibleNodes = root.descendants();
                const neededHeight = Math.max(height, visibleNodes.length * 60);
                const neededWidth = Math.max(width, 1000);

                // Update SVG size to accommodate all nodes
                svg.style('min-width', neededWidth + 'px')
                   .style('min-height', neededHeight + 'px');

                // Create tree layout with FIXED node spacing using nodeSize
                const treeLayout = d3.tree()
                    .nodeSize([60, 220]) // [vertical spacing, horizontal spacing] - FIXED distances
                    .separation((a, b) => {
                        // More separation for grandchildren
                        if (a.depth === 2 && b.depth === 2) {
                            return a.parent === b.parent ? 1.0 : 1.3;
                        }
                        // Standard separation for other levels
                        return a.parent === b.parent ? 1.0 : 1.5;
                    });

                const treeData = treeLayout(root);
                const nodes = treeData.descendants();
                const links = treeData.links();

                // Update links
                const link = linkGroup
                    .selectAll('path')
                    .data(links, d => d.target.id || (d.target.id = ++i));

                // Enter new links
                const linkEnter = link.enter()
                    .insert('path', 'g')
                    .attr('class', 'mindmap-link')
                    .attr('d', d => {
                        const o = {x: source.x0, y: source.y0};
                        return diagonal(o, o);
                    });

                // Update existing links
                const linkUpdate = linkEnter.merge(link);
                linkUpdate.transition()
                    .duration(500)
                    .attr('d', d => diagonal(d.source, d.target));

                // Remove old links
                link.exit()
                    .transition()
                    .duration(500)
                    .attr('d', d => {
                        const o = {x: source.x, y: source.y};
                        return diagonal(o, o);
                    })
                    .remove();

                // Update nodes
                const node = nodeGroup
                    .selectAll('g')
                    .data(nodes, d => d.id || (d.id = ++i));

                // Enter new nodes
                const nodeEnter = node.enter()
                    .append('g')
                    .attr('class', d => `mindmap-node ${d.depth === 0 ? 'root' : d.depth === 1 ? 'child' : 'grandchild'}`)
                    .attr('transform', d => `translate(${source.y0}, ${source.x0})`);

                // Add rectangles
                nodeEnter.append('rect')
                    .attr('width', d => d.depth === 0 ? rootWidth : d.depth === 1 ? childWidth : grandchildWidth)
                    .attr('height', d => d.depth === 0 ? rootHeight : d.depth === 1 ? childHeight : grandchildHeight)
                    .attr('x', d => d.depth === 0 ? -rootWidth/2 : d.depth === 1 ? -childWidth/2 : -grandchildWidth/2)
                    .attr('y', d => d.depth === 0 ? -rootHeight/2 : d.depth === 1 ? -childHeight/2 : -grandchildHeight/2);

                // Add icons for depth 1 nodes (categories)
                const iconMap = {
                    // Seeker mode icons
                    'Job Opportunities': 'ph-briefcase',
                    'Application Materials': 'ph-file-text',
                    'Career Experience': 'ph-suitcase',
                    'Goals': 'ph-target',
                    'Portfolio': 'ph-folder-open',
                    'Interview Prep': 'ph-chats-circle',
                    // Professional mode icons
                    'Documents': 'ph-file-text',
                    'Tables': 'ph-table',
                    'Forms': 'ph-clipboard-text',
                    'Reports': 'ph-chart-bar',
                    'Templates': 'ph-note-blank',
                    'Pipelines': 'ph-flow-arrow',
                    'Workflows': 'ph-git-branch'
                };

                nodeEnter.each(function(d) {
                    if (d.depth === 1) {
                        const iconClass = iconMap[d.data.name];
                        if (iconClass) {
                            d3.select(this)
                                .append('foreignObject')
                                .attr('width', 20)
                                .attr('height', 20)
                                .attr('x', -childWidth/2 + 8)
                                .attr('y', -10)
                                .html(`<i class="ph ${iconClass}" style="font-size: 20px; color: #0066CC;"></i>`);
                        }
                    }
                });

                // Add text labels
                nodeEnter.append('text')
                    .attr('dy', '0.35em')
                    .attr('x', 0)
                    .each(function(d) {
                        const text = d3.select(this);
                        const label = d.data.name;
                        const count = d.data.count;

                        if (d.depth === 0) {
                            text.text(label);
                            const maxWidth = rootWidth - 20;
                            wrapText(text, maxWidth, 3); // Max 3 lines for root
                        } else if (d.depth === 1) {
                            // Shift text to the right to make room for icon
                            text.attr('x', 15);
                            const maxWidth = childWidth - 70;
                            text.text(label);
                            wrapText(text, maxWidth, 2); // Max 2 lines for categories

                            if (count > 0) {
                                d3.select(this.parentNode)
                                    .append('circle')
                                    .attr('class', 'count-badge-circle')
                                    .attr('cx', childWidth/2 - 20)
                                    .attr('cy', -childHeight/2 + 15)
                                    .attr('r', 12)
                                    .attr('fill', '#e3f2fd');

                                d3.select(this.parentNode)
                                    .append('text')
                                    .attr('class', 'count-badge-text')
                                    .attr('x', childWidth/2 - 20)
                                    .attr('y', -childHeight/2 + 15)
                                    .attr('dy', '0.35em')
                                    .attr('text-anchor', 'middle')
                                    .attr('font-size', '11px')
                                    .attr('font-weight', '600')
                                    .attr('fill', '#1a1a1a')
                                    .attr('pointer-events', 'none')
                                    .text(count);
                            }
                        } else {
                            // Grandchild nodes (third level) - truncate long text
                            const maxWidth = grandchildWidth - 20;
                            const maxChars = 50; // Character limit
                            const truncatedLabel = label.length > maxChars ? label.substring(0, maxChars) + '...' : label;
                            text.text(truncatedLabel);
                            wrapText(text, maxWidth, 2); // Max 2 lines
                        }
                    });

                // Click handler for second-level nodes
                nodeEnter.on('click', function(event, d) {
                    event.stopPropagation();
                    if (d.depth === 1) {
                        // Check if this is Job Opportunities or Interview Prep
                        const nodeName = d.data.name;

                        if (nodeName === 'Job Opportunities') {
                            openJobOpportunitiesSlideout();
                        } else if (nodeName === 'Career Experience') {
                            openCareerExperienceSlideout();
                        } else if (nodeName === 'Application Materials') {
                            openApplicationMaterialsSlideout();
                        } else if (nodeName === 'Portfolio') {
                            openPortfolioSlideout();
                        } else if (nodeName === 'Skills & Goals' || nodeName === 'Goals') {
                            openSkillsCompetenciesSlideout();
                        } else if (nodeName === 'Interview Prep') {
                            // Interview Prep opens slideout with tabbed view
                            openInterviewPrepSlideout();
                        } else if (nodeName === 'Tables') {
                            // Tables opens slideout with table type cards
                            openTablesSlideout();
                        } else if (nodeName === 'Forms') {
                            openFormsSlideout();
                        } else if (nodeName === 'Documents') {
                            openDocumentsSlideout();
                        } else if (nodeName === 'Reports') {
                            openReportsSlideout();
                        } else if (nodeName === 'Templates') {
                            openTemplatesSlideout();
                        } else if (nodeName === 'Pipelines') {
                            openPipelinesSlideout();
                        } else if (nodeName === 'Workflows') {
                            openWorkflowsSlideout();
                        } else {
                            // Other nodes expand normally
                            toggleNode(d);
                        }
                    } else if (d.depth === 2) {
                        // Third-level node clicked
                        const parentName = d.parent.data.name;
                        const nodeName = d.data.name;

                        // Close any open slideout when level 2 node is clicked
                        closeInterviewSlideout();

                        // Interview Prep child nodes no longer open slideout (handled by parent)
                        // Other depth 2 nodes can be handled here if needed
                    }
                });

                // Update existing nodes
                const nodeUpdate = nodeEnter.merge(node);
                nodeUpdate.transition()
                    .duration(500)
                    .attr('transform', d => `translate(${d.y}, ${d.x})`);

                // Ensure all depth 1 nodes have icons (handles nodes that existed before)
                nodeUpdate.each(function(d) {
                    if (d.depth === 1) {
                        const nodeElement = d3.select(this);
                        // Check if icon already exists
                        if (nodeElement.select('foreignObject').empty()) {
                            const iconClass = iconMap[d.data.name];
                            if (iconClass) {
                                nodeElement
                                    .append('foreignObject')
                                    .attr('width', 20)
                                    .attr('height', 20)
                                    .attr('x', -childWidth/2 + 8)
                                    .attr('y', -10)
                                    .html(`<i class="ph ${iconClass}" style="font-size: 20px; color: #0066CC;"></i>`);
                            }
                        }
                    }
                });

                // Update cursor for all nodes based on whether they have children
                nodeUpdate.style('cursor', d => {
                    if (d.depth === 1 && (d.children || d._children)) {
                        return 'pointer';
                    }
                    // Interview Prep children are no longer clickable (parent opens slideout)
                    return 'default';
                });

                // Update rect styling for expanded/collapsed state
                nodeUpdate.select('rect')
                    .attr('class', d => {
                        if (d.depth === 1) {
                            // Expanded if has visible children, collapsed otherwise (including no children)
                            return d.children ? 'expanded' : 'collapsed';
                        }
                        return '';
                    });

                // Remove old nodes
                node.exit()
                    .transition()
                    .duration(500)
                    .attr('transform', d => `translate(${source.y}, ${source.x})`)
                    .remove();

                // Store old positions for transitions
                nodes.forEach(d => {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }

            // Link diagonal function
            function diagonal(s, d) {
                const sourceX = s.y + (s.depth === 0 ? rootWidth/2 : s.depth === 1 ? childWidth/2 : grandchildWidth/2);
                const sourceY = s.x;
                const targetX = d.y - (d.depth === 1 ? childWidth/2 : grandchildWidth/2);
                const targetY = d.x;

                const midX = (sourceX + targetX) / 2;
                return `M ${sourceX} ${sourceY} C ${midX} ${sourceY}, ${midX} ${targetY}, ${targetX} ${targetY}`;
            }

            // Toggle node function - only one second-level node open at a time
            function toggleNode(d) {
                console.log('toggleNode called for:', d.data.name);
                console.log('Before toggle - children:', d.children, '_children:', d._children);

                if (!d._children && !d.children) {
                    console.log('No children to toggle');
                    return; // No children to toggle
                }

                // If this node is being opened
                if (d._children) {
                    console.log('Opening node, _children has', d._children.length, 'items');

                    // Close any other open second-level nodes
                    root.children.forEach(child => {
                        if (child !== d && child.children) {
                            console.log('Closing other node:', child.data.name);
                            child._children = child.children;
                            child.children = null;
                        }
                    });

                    // Open this node
                    d.children = d._children;
                    d._children = null;
                    expandedNode = d;
                    console.log('After opening - children:', d.children);
                } else {
                    console.log('Closing node');
                    // Close this node
                    d._children = d.children;
                    d.children = null;
                    expandedNode = null;
                }

                console.log('Calling update()');
                update(d);
            }

            // Text wrapping function with optional line limit
            function wrapText(text, maxWidth, maxLines = 999) {
                const textNode = text.node();
                const words = text.text().split(/\s+/).reverse();
                let word;
                let line = [];
                let lineNumber = 0;
                const lineHeight = 1.1;
                const y = text.attr('y') || 0;
                const dy = 0.35;

                text.text(null);
                let tspan = text.append('tspan')
                    .attr('x', 0)
                    .attr('y', y);

                while (word = words.pop()) {
                    // Stop if we've reached max lines
                    if (lineNumber >= maxLines) {
                        break;
                    }

                    line.push(word);
                    tspan.text(line.join(' '));
                    if (tspan.node().getComputedTextLength() > maxWidth) {
                        line.pop();

                        // If this would be the last line, add ellipsis
                        if (lineNumber === maxLines - 1 && words.length > 0) {
                            tspan.text(line.join(' ') + '...');
                        } else {
                            tspan.text(line.join(' '));
                        }

                        line = [word];
                        lineNumber++;

                        if (lineNumber < maxLines) {
                            tspan = text.append('tspan')
                                .attr('x', 0)
                                .attr('y', y)
                                .attr('dy', lineNumber * lineHeight + 'em')
                                .text(word);
                        }
                    }
                }

                // Center multi-line text vertically
                const spans = text.selectAll('tspan');
                const numLines = spans.size();
                if (numLines > 1) {
                    spans.attr('dy', function(d, i) {
                        return (i - (numLines - 1) / 2) * lineHeight + dy + 'em';
                    });
                } else {
                    spans.attr('dy', dy + 'em');
                }
            }

            // Initialize counter for node IDs
            let i = 0;

            // Initial render
            update(root);

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.5, 2])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);
        }

        // ========================================
        // Interview Prep Slideout Functions
        // ========================================

        let currentInterviewCategory = '';
        let currentEditingStoryId = null;
        let behavioralStories = JSON.parse(localStorage.getItem('behavioralStories') || '[]');

        // Example behavioral stories for each persona
        const exampleStories = {
            'retail-manager': [
                {
                    title: 'Managing Peak Season Staffing Crisis',
                    experience: 'RetailMart Store Manager (2019-2024)',
                    situation: 'During Black Friday weekend, three team members called in sick, leaving us severely understaffed during our busiest period. Customer traffic was 40% above forecast, and we risked long wait times and poor customer experience.',
                    task: 'As Store Manager, I needed to ensure we maintained service standards while managing an exhausted team and preventing further burnout.',
                    action: 'I immediately called in off-duty staff offering premium pay, reorganized floor coverage to prioritize high-traffic areas, and personally worked checkout and stocking alongside the team. I implemented 15-minute rotation breaks to prevent burnout and communicated transparently with customers about wait times.',
                    result: 'We processed 2,300 transactions over the weekend with 92% customer satisfaction scores (above our 85% target). Team morale remained strong, and we exceeded sales targets by 18%. Two team members later mentioned this experience in their positive reviews.',
                    competencies: ['Crisis Management', 'Leadership', 'Customer Service', 'Team Building']
                },
                {
                    title: 'Implementing Data-Driven Inventory System',
                    experience: 'RetailMart Store Manager (2019-2024)',
                    situation: 'Our store consistently had 22% inventory shrinkage (far above the 8% company benchmark) and frequent stockouts of popular items. Manual tracking was error-prone, and the team resisted changing established processes.',
                    task: 'I was tasked with reducing shrinkage to under 10% within six months while improving product availability.',
                    action: 'I taught myself Excel pivot tables and Power BI to analyze shrinkage patterns. I discovered 60% of losses occurred during restocking shifts. I implemented a barcode scanning system, trained staff on cycle counting procedures, and created a daily dashboard showing real-time inventory accuracy by department.',
                    result: 'Inventory shrinkage dropped to 7.5% within four months, saving $45,000 annually. Product availability improved from 83% to 94%. My analytics approach was adopted by 12 other stores in the district, and I was asked to lead regional training sessions.',
                    competencies: ['Data Analysis', 'Problem Solving', 'Change Management', 'Process Improvement']
                },
                {
                    title: 'Developing Team Member Into Assistant Manager',
                    experience: 'RetailMart Store Manager (2019-2024)',
                    situation: 'My Assistant Manager left abruptly, and corporate wanted to hire externally. I had a promising team member, Sarah, who had leadership potential but lacked confidence and formal management training.',
                    task: 'I needed to convince corporate to give Sarah a chance while rapidly developing her management capabilities.',
                    action: 'I created a 90-day development plan with weekly coaching sessions covering P&L basics, conflict resolution, and scheduling. I gradually delegated responsibilities—first shift leadership, then inventory management, finally full store operations during my vacation. I documented her progress with specific metrics and presented the case to regional management.',
                    result: 'Sarah was promoted to Assistant Manager after 12 weeks and became one of the top-performing AMs in the region. She later implemented a mentorship program that reduced turnover by 30%. This demonstrated my commitment to developing talent and influenced corporate to prioritize internal promotions.',
                    competencies: ['Mentoring', 'Talent Development', 'Advocacy', 'Influence']
                }
            ],
            'chemist': [
                {
                    title: 'Resolving Critical Production Quality Issue',
                    experience: 'PharmaCorp Senior Chemist (2020-2024)',
                    situation: 'A key pharmaceutical intermediate was failing quality control with 15% out-of-spec batches, threatening to delay a major product launch. The existing team had been troubleshooting for three weeks without identifying the root cause, and manufacturing was considering halting production.',
                    task: 'As lead chemist, I needed to identify the contamination source and implement a fix within one week to avoid missing regulatory deadlines.',
                    action: 'I formed a cross-functional team including process engineers and QC analysts. We used Design of Experiments (DOE) methodology to isolate variables. I discovered trace metal contamination from a newly installed reactor gasket. I worked with vendors to source compliant materials, validated the fix with 20 test batches, and updated SOPs to prevent recurrence.',
                    result: 'Production resumed within five days with zero OOS results in subsequent batches. The launch proceeded on schedule, generating $8M in first-year revenue. My systematic troubleshooting approach was adopted as standard protocol for quality investigations.',
                    competencies: ['Problem Solving', 'Technical Expertise', 'Cross-functional Collaboration', 'Quality Management']
                },
                {
                    title: 'Leading Lab Through Regulatory Audit',
                    experience: 'PharmaCorp Senior Chemist (2020-2024)',
                    situation: 'An unexpected FDA audit was scheduled with only two weeks notice. Our lab had several documentation gaps, and the junior staff had no audit experience. Previous audits at other sites had resulted in warning letters.',
                    task: 'I needed to prepare the team, ensure documentation compliance, and represent the lab during inspector interviews without disrupting ongoing critical experiments.',
                    action: 'I conducted daily mock audits, reviewed and corrected 200+ batch records, created an audit response guide, and coached junior chemists on answering inspector questions precisely. I organized 24/7 coverage to maintain experiments while accommodating audit schedules, and I personally handled the most technical questions.',
                    result: 'We completed the audit with zero 483 observations—a rare outcome. The inspector commended our documentation quality and technical knowledge. My audit prep materials were adopted company-wide, and I was invited to train teams at three other facilities.',
                    competencies: ['Regulatory Compliance', 'Leadership Under Pressure', 'Communication', 'Attention to Detail']
                },
                {
                    title: 'Optimizing Synthesis Route to Reduce Costs',
                    experience: 'PharmaCorp Senior Chemist (2020-2024)',
                    situation: 'Our flagship product had a synthesis route using expensive platinum catalysts, making production costs 40% above competitors. Management pressured us to cut costs without compromising quality, or they would outsource manufacturing overseas.',
                    task: 'I proposed developing an alternative synthesis route that could reduce material costs by at least 25% while maintaining API purity specifications.',
                    action: 'I screened 15 alternative catalysts through literature review and small-scale experiments, identifying a nickel-based catalyst with promising results. I scaled the reaction through pilot batches, optimized reaction conditions using statistical models, and validated that API quality met all specs. I prepared economic analysis showing $1.2M annual savings.',
                    result: 'The new route was implemented, reducing material costs by 32% and cutting reaction time by 20%. Manufacturing remained in-house, preserving 40 jobs. I received the company Innovation Award and was promoted to Principal Chemist. The process was patented with me as lead inventor.',
                    competencies: ['Innovation', 'Cost Optimization', 'Technical Problem Solving', 'Strategic Thinking']
                }
            ],
            'new-graduate': [
                {
                    title: 'Leading Team Project Under Tight Deadline',
                    experience: 'University Capstone Project (2024)',
                    situation: 'Our team of five CS students was assigned to build a React-based inventory management system for a local nonprofit. Two weeks before the deadline, one team member dropped out due to personal issues, leaving critical backend work incomplete.',
                    task: 'As project lead, I needed to redistribute work, complete the backend API integration, and ensure we delivered a working product for our client and course grade.',
                    action: 'I held an emergency team meeting to reassess scope and cut non-essential features. I personally learned Node.js/Express over a weekend to complete the REST API, integrated it with our React frontend, and implemented error handling. I reorganized our GitHub workflow with clearer task assignments and daily stand-ups to track progress.',
                    result: 'We delivered the system on time with all core features working. The nonprofit deployed it successfully and reported 30% time savings in inventory tracking. Our professor gave us an A and used our project as an example for future classes. I learned to adapt quickly and lead through adversity.',
                    competencies: ['Leadership', 'Adaptability', 'Technical Learning', 'Project Management']
                },
                {
                    title: 'Resolving Database Performance Issue',
                    experience: 'University Database Course Project (2023)',
                    situation: 'My course project—a book recommendation system—worked well with sample data but became unusably slow (30+ second queries) when testing with the full dataset of 100,000 books. The assignment deadline was in three days.',
                    task: 'I needed to identify and fix the performance bottleneck without restructuring my entire database schema.',
                    action: 'I used PostgreSQL EXPLAIN ANALYZE to identify that my recommendation algorithm was doing full table scans without indexes. I researched database optimization techniques, added composite indexes on frequently queried columns, and rewrote my most expensive query to use JOIN instead of subqueries. I tested with progressively larger datasets to validate improvements.',
                    result: 'Query times dropped from 30+ seconds to under 2 seconds, making the app responsive. I received a 98% on the project, and the professor asked me to present my optimization approach to the class. This taught me the importance of performance testing and proper indexing strategies.',
                    competencies: ['Problem Solving', 'Performance Optimization', 'Database Design', 'Self-Learning']
                },
                {
                    title: 'Organizing Community Coding Workshop',
                    experience: 'Computer Science Club VP (2023-2024)',
                    situation: 'Our CS club had low engagement (only 12 regular members) and limited visibility on campus. The club president wanted to increase membership and community impact, but we had no budget for events.',
                    task: 'As VP, I proposed organizing a free "Intro to Web Development" workshop for non-CS students to build interest and demonstrate value.',
                    action: 'I recruited three club members as co-instructors, designed a 3-hour curriculum teaching HTML/CSS/JavaScript basics, secured a computer lab through the CS department, and promoted the event through social media and flyering. I created a beginner-friendly project (personal portfolio page) that students could complete during the session.',
                    result: 'We had 45 attendees, with 30 completing projects and 18 joining the club afterward. The workshop became a quarterly event, and club membership grew to 60+ students. I developed public speaking skills and learned to make technical concepts accessible to beginners.',
                    competencies: ['Event Planning', 'Communication', 'Curriculum Design', 'Community Building']
                }
            ],
            'data-analyst': [
                {
                    title: 'Uncovering Revenue Leakage Through Data Analysis',
                    experience: 'TechCorp Business Analyst (2021-2024)',
                    situation: 'Our SaaS company was growing revenue 20% year-over-year, but profit margins were declining. Leadership suspected operational inefficiencies but had no specific insights. I was asked to investigate as part of a quarterly business review.',
                    task: 'I needed to analyze billing data, usage metrics, and customer accounts to identify where we were losing money and provide actionable recommendations.',
                    action: 'I combined data from Salesforce, Stripe, and our usage database using SQL joins, then analyzed patterns in Python. I discovered that 12% of enterprise customers were exceeding contracted usage limits without being billed for overages due to a bug in our metering system. I created visualizations in Tableau showing $340K in annual lost revenue and presented findings to the executive team with a remediation plan.',
                    result: 'Engineering fixed the metering bug within two weeks, and we implemented automated overage billing. We recovered $85K in back charges (with customer approval) and prevented future leakage. My analysis directly contributed to returning to 35% profit margins. I received a performance bonus and was promoted to Senior Analyst.',
                    competencies: ['Data Analysis', 'Problem Solving', 'Business Impact', 'Executive Communication']
                },
                {
                    title: 'Building Predictive Churn Model',
                    experience: 'TechCorp Business Analyst (2021-2024)',
                    situation: 'Customer churn was increasing from 5% to 8% monthly, and the customer success team was overwhelmed trying to prevent cancellations reactively. We needed to identify at-risk customers earlier.',
                    task: 'I proposed building a machine learning model to predict churn risk 30 days in advance, allowing proactive outreach to high-risk accounts.',
                    action: 'I extracted 18 months of customer behavior data (login frequency, feature usage, support tickets, NPS scores) and used Python scikit-learn to train a random forest classifier. I identified key churn indicators: customers with <2 logins/week and no use of core features had 60% churn probability. I built a dashboard in Power BI showing risk scores and worked with Customer Success to design intervention workflows.',
                    result: 'The model achieved 78% accuracy in predicting churn. Customer Success focused on the top 50 at-risk accounts monthly, reducing churn from 8% to 5.5% within three months—saving ~$200K in annual recurring revenue. The churn model became a core part of our CS strategy.',
                    competencies: ['Machine Learning', 'Predictive Analytics', 'Stakeholder Collaboration', 'Business Strategy']
                },
                {
                    title: 'Streamlining Reporting Process with Automation',
                    experience: 'TechCorp Business Analyst (2021-2024)',
                    situation: 'Our analytics team spent 20 hours per month manually creating executive reports by pulling data from multiple systems, copying into Excel, and formatting charts. This tedious work prevented us from doing deeper analysis.',
                    task: 'I wanted to automate the reporting process to free up time for strategic work and reduce human error.',
                    action: 'I learned Python pandas and built an automated pipeline that pulled data from our data warehouse via SQL, performed calculations, generated charts with matplotlib, and exported formatted Excel reports. I scheduled the script to run weekly via cron job and created documentation so others could maintain it. I also built a Slack bot to notify stakeholders when reports were ready.',
                    result: 'Report generation time dropped from 20 hours to 30 minutes of review time monthly, saving 230+ hours annually. Error rates decreased from ~5% to near zero. The executive team received reports faster and more consistently. My automation approach was adopted for three other recurring reports, and I led a lunch-and-learn teaching colleagues Python automation basics.',
                    competencies: ['Process Automation', 'Python Programming', 'Efficiency Improvement', 'Knowledge Sharing']
                }
            ]
        };

        // New function: Open Interview Prep with tabbed view
        function openInterviewPrepSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');
            const interviewPrepContent = document.getElementById('interviewPrepContent');
            const behavioralContent = document.getElementById('behavioralContent');
            const technicalContent = document.getElementById('technicalContent');

            // Hide all content sections
            hideAllContentSections();

            // Show interview prep content with tabs
            interviewPrepContent.style.display = 'block';

            // Default to Behavioral tab
            behavioralContent.style.display = 'block';
            technicalContent.style.display = 'none';

            // Reset tab active states
            const tabs = interviewPrepContent.querySelectorAll('.tech-tab');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');

            titleEl.textContent = 'Interview Preparation';

            // Load content
            loadStories();
            loadTechnicalContent();

            // Show slideout
            slideout.classList.add('active');
        }

        // Function to switch between Behavioral and Technical tabs
        function switchInterviewTab(tab) {
            const behavioralContent = document.getElementById('behavioralContent');
            const technicalContent = document.getElementById('technicalContent');
            const interviewPrepContent = document.getElementById('interviewPrepContent');
            const tabs = interviewPrepContent.querySelectorAll('.tech-tab');

            if (tab === 'behavioral') {
                behavioralContent.style.display = 'block';
                technicalContent.style.display = 'none';
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
            } else if (tab === 'technical') {
                behavioralContent.style.display = 'none';
                technicalContent.style.display = 'block';
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
            }
        }

        // Legacy function (no longer called from mindmap)
        function openInterviewSlideout(category) {
            currentInterviewCategory = category;
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');
            const behavioralContent = document.getElementById('behavioralContent');
            const technicalContent = document.getElementById('technicalContent');

            // Update title based on category
            const titles = {
                'Behavioral': 'Behavioral Interview Stories',
                'Technical': 'Technical Interview Preparation'
            };

            titleEl.textContent = titles[category] || 'Interview Preparation';

            // Hide all content sections
            hideAllContentSections();

            // Show appropriate content
            if (category === 'Behavioral') {
                behavioralContent.style.display = 'flex';
                loadStories();
            } else if (category === 'Technical') {
                technicalContent.style.display = 'flex';
                loadTechnicalContent();
            }

            // Show slideout
            slideout.classList.add('active');
        }

        function closeInterviewSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            slideout.classList.remove('active');
        }

        function loadStories() {
            const container = document.getElementById('storiesContainer');
            container.innerHTML = '';

            // Get example stories for current persona
            const personaExamples = exampleStories[currentPersona] || [];

            // Combine user stories with persona examples
            const allStories = [...behavioralStories, ...personaExamples];

            if (allStories.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-file-text" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No stories yet. Click "Add New Story" to create your first STAR behavioral story.</p>
                    </div>
                `;
                return;
            }

            allStories.forEach((story, index) => {
                const isUserStory = index < behavioralStories.length;
                const card = document.createElement('div');
                card.className = 'story-card';

                // Add example badge styling for persona stories
                if (!isUserStory) {
                    card.style.borderLeft = '4px solid #e3f2fd';
                    card.style.background = '#fafbfc';
                }

                card.innerHTML = `
                    <div class="story-card-header">
                        <div>
                            <h3 class="story-title">${escapeHtml(story.title)}</h3>
                            ${!isUserStory ? '<span class="competency-tag" style="margin-top: 4px; display: inline-block;">Example Story</span>' : ''}
                        </div>
                        ${isUserStory ? `
                        <div class="story-actions">
                            <button class="story-action-btn" onclick="editStory(${index})" title="Edit">
                                <i class="ph ph-pencil-simple"></i>
                            </button>
                            <button class="story-action-btn delete" onclick="deleteStory(${index})" title="Delete">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>

                    ${story.experience ? `<div class="story-experience">Related to: ${escapeHtml(story.experience)}</div>` : ''}

                    <div class="story-section">
                        <div class="story-section-label">Situation</div>
                        <div class="story-section-text">${escapeHtml(story.situation)}</div>
                    </div>

                    <div class="story-section">
                        <div class="story-section-label">Task</div>
                        <div class="story-section-text">${escapeHtml(story.task)}</div>
                    </div>

                    <div class="story-section">
                        <div class="story-section-label">Action</div>
                        <div class="story-section-text">${escapeHtml(story.action)}</div>
                    </div>

                    <div class="story-section">
                        <div class="story-section-label">Result</div>
                        <div class="story-section-text">${escapeHtml(story.result)}</div>
                    </div>

                    ${story.competencies && story.competencies.length > 0 ? `
                        <div class="story-competencies">
                            ${story.competencies.map(comp => `<span class="competency-tag">${escapeHtml(comp)}</span>`).join('')}
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
        }

        function openStoryForm(editIndex = null) {
            const modal = document.getElementById('storyFormModal');
            const form = document.getElementById('storyForm');
            const formTitle = document.getElementById('formTitle');

            // Populate experience dropdown from Career Experience node
            populateExperienceDropdown();

            if (editIndex !== null) {
                // Edit mode
                currentEditingStoryId = editIndex;
                formTitle.textContent = 'Edit Behavioral Story';
                const story = behavioralStories[editIndex];

                document.getElementById('storyTitle').value = story.title || '';
                document.getElementById('storyExperience').value = story.experience || '';
                document.getElementById('storySituation').value = story.situation || '';
                document.getElementById('storyTask').value = story.task || '';
                document.getElementById('storyAction').value = story.action || '';
                document.getElementById('storyResult').value = story.result || '';
                document.getElementById('storyCompetencies').value = story.competencies ? story.competencies.join(', ') : '';
            } else {
                // Add mode
                currentEditingStoryId = null;
                formTitle.textContent = 'Add Behavioral Story';
                form.reset();
            }

            modal.classList.add('active');
        }

        function closeStoryForm() {
            const modal = document.getElementById('storyFormModal');
            modal.classList.remove('active');
            currentEditingStoryId = null;
        }

        function populateExperienceDropdown() {
            const select = document.getElementById('storyExperience');
            const currentPersonaData = personaData[currentPersona];

            // Find Career Experience node
            const careerExpNode = currentPersonaData.children.find(child => child.name === 'Career Experience');

            // Clear existing options (except first placeholder)
            select.innerHTML = '<option value="">Select an experience...</option>';

            if (careerExpNode && careerExpNode.children) {
                careerExpNode.children.forEach(exp => {
                    const option = document.createElement('option');
                    option.value = exp.name;
                    option.textContent = exp.name;
                    select.appendChild(option);
                });
            }
        }

        function saveStory(event) {
            event.preventDefault();

            const story = {
                title: document.getElementById('storyTitle').value.trim(),
                experience: document.getElementById('storyExperience').value,
                situation: document.getElementById('storySituation').value.trim(),
                task: document.getElementById('storyTask').value.trim(),
                action: document.getElementById('storyAction').value.trim(),
                result: document.getElementById('storyResult').value.trim(),
                competencies: document.getElementById('storyCompetencies').value
                    .split(',')
                    .map(c => c.trim())
                    .filter(c => c)
            };

            if (currentEditingStoryId !== null) {
                // Update existing story
                behavioralStories[currentEditingStoryId] = story;
            } else {
                // Add new story
                behavioralStories.push(story);
            }

            // Save to localStorage
            localStorage.setItem('behavioralStories', JSON.stringify(behavioralStories));

            // Reload stories
            loadStories();

            // Close form
            closeStoryForm();
        }

        function editStory(index) {
            openStoryForm(index);
        }

        function deleteStory(index) {
            if (confirm('Are you sure you want to delete this story?')) {
                behavioralStories.splice(index, 1);
                localStorage.setItem('behavioralStories', JSON.stringify(behavioralStories));
                loadStories();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // Technical Interview Prep Functions
        // ========================================

        let currentTechTab = 'questions';

        function switchTechTab(tab) {
            currentTechTab = tab;

            // Update tab buttons
            document.querySelectorAll('.tech-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all tab contents
            document.querySelectorAll('.tech-tab-content').forEach(content => content.style.display = 'none');

            // Show selected tab
            if (tab === 'questions') {
                document.getElementById('questionsTab').style.display = 'block';
            } else if (tab === 'research') {
                document.getElementById('researchTab').style.display = 'block';
            } else if (tab === 'mock') {
                document.getElementById('mockTab').style.display = 'block';
            }
        }

        function loadTechnicalContent() {
            // Load content for all tabs
            loadTechnicalQuestions();
            loadCompanyResearch();
            loadMockSessions();
        }

        function loadTechnicalQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                    <i class="ph ph-question" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                    <p style="font-family: var(--font-family-ui); font-size: 15px;">Track technical questions you've encountered or want to practice.</p>
                    <p style="font-size: 13px; margin-top: 8px;">Coming soon: Add questions with your answers, solutions, and notes.</p>
                </div>
            `;
        }

        function loadCompanyResearch() {
            const container = document.getElementById('researchContainer');
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                    <i class="ph ph-buildings" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                    <p style="font-family: var(--font-family-ui); font-size: 15px;">Organize research on companies you're interviewing with.</p>
                    <p style="font-size: 13px; margin-top: 8px;">Coming soon: Track tech stack, culture notes, interviewers, and key talking points.</p>
                </div>
            `;
        }

        function loadMockSessions() {
            const container = document.getElementById('mockContainer');
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                    <i class="ph ph-video-camera" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                    <p style="font-family: var(--font-family-ui); font-size: 15px;">Schedule and track mock interview sessions.</p>
                    <p style="font-size: 13px; margin-top: 8px;">Coming soon: Book sessions with mentors, record feedback, and review performance.</p>
                </div>
            `;
        }

        function addTechnicalQuestion() {
            alert('Technical Questions feature coming soon!');
        }

        function addCompanyResearch() {
            alert('Company Research feature coming soon!');
        }

        function addMockSession() {
            alert('Mock Interview Sessions feature coming soon!');
        }

        // ========================================
        // Job Opportunities Functions
        // ========================================

        function openJobOpportunitiesSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');
            const jobOpportunitiesContent = document.getElementById('jobOpportunitiesContent');

            titleEl.textContent = 'Job Opportunities';

            // Hide all content sections
            hideAllContentSections();

            // Show job opportunities content
            jobOpportunitiesContent.style.display = 'flex';

            // Load job opportunities for current persona
            loadJobOpportunities();

            // Show slideout
            slideout.classList.add('active');
        }

        // Enhanced job opportunities with skills and competencies
        const exampleJobOpportunities = {
            'retail-manager': [
                { title: 'Operations Manager', company: 'Amazon', location: 'Seattle', salary: '$125K', status: 'interested', skills: ['Excel', 'Data Analysis', 'Process Optimization'], competencies: ['Leadership', 'Operations Management', 'Problem Solving'], isExample: true },
                { title: 'Business Analyst', company: 'Target HQ', location: 'Minneapolis', salary: '$95K', status: 'interested', skills: ['Excel', 'Power BI', 'SQL'], competencies: ['Data Analysis', 'Business Intelligence', 'Communication'], isExample: true },
                { title: 'Data Analyst', company: 'Walmart eCommerce', location: 'Bentonville', salary: '$85K', status: 'interested', skills: ['SQL', 'Python', 'Tableau'], competencies: ['Analytics', 'Critical Thinking', 'Collaboration'], isExample: true },
                { title: 'Supply Chain Analyst', company: 'Nike', location: 'Portland', salary: '$90K', status: 'interested', skills: ['Excel', 'Supply Chain Software', 'Data Visualization'], competencies: ['Logistics', 'Process Improvement', 'Stakeholder Management'], isExample: true },
                { title: 'Ops Coordinator', company: 'Instacart', location: 'San Francisco', salary: '$80K', status: 'interested', skills: ['Project Management', 'Excel', 'Communication'], competencies: ['Organization', 'Multitasking', 'Adaptability'], isExample: true }
            ],
            'chemist': [
                { title: 'Sr Data Scientist', company: 'Pfizer R&D', location: 'Cambridge', salary: '$165K', status: 'interested', skills: ['Python', 'Machine Learning', 'R', 'SQL'], competencies: ['Statistical Analysis', 'Research', 'Scientific Communication'], isExample: true },
                { title: 'Computational Chemist', company: 'Moderna', location: 'Boston', salary: '$155K', status: 'interested', skills: ['Python', 'Molecular Modeling', 'Linux', 'HPC'], competencies: ['Computational Chemistry', 'Problem Solving', 'Collaboration'], isExample: true },
                { title: 'ML Engineer', company: 'Genentech', location: 'South SF', salary: '$180K', status: 'interested', skills: ['Python', 'TensorFlow', 'PyTorch', 'AWS'], competencies: ['Machine Learning', 'Software Engineering', 'Agile Development'], isExample: true },
                { title: 'Bioinformatics Scientist', company: 'Illumina', location: 'San Diego', salary: '$145K', status: 'interested', skills: ['Python', 'R', 'NGS Analysis', 'Bioinformatics Tools'], competencies: ['Genomics', 'Data Analysis', 'Cross-functional Collaboration'], isExample: true },
                { title: 'Research Scientist', company: 'Merck', location: 'Rahway, NJ', salary: '$140K', status: 'interested', skills: ['Python', 'HPLC', 'Spectroscopy', 'R'], competencies: ['Analytical Chemistry', 'Experimental Design', 'Technical Writing'], isExample: true }
            ],
            'new-graduate': [
                { title: 'Junior Full Stack Developer', company: 'StartupCo', location: 'Austin', salary: '$85K', status: 'applied', skills: ['React', 'Node.js', 'JavaScript', 'Git'], competencies: ['Full Stack Development', 'Problem Solving', 'Learning Agility'], isExample: true },
                { title: 'Software Engineer I', company: 'Microsoft', location: 'Redmond', salary: '$120K', status: 'interested', skills: ['C#', '.NET', 'Azure', 'SQL'], competencies: ['Software Development', 'Collaboration', 'Technical Communication'], isExample: true },
                { title: 'Frontend Developer', company: 'Shopify', location: 'Remote', salary: '$95K', status: 'interested', skills: ['React', 'TypeScript', 'CSS', 'Redux'], competencies: ['UI Development', 'Responsive Design', 'User Experience'], isExample: true },
                { title: 'Backend Engineer', company: 'Stripe', location: 'San Francisco', salary: '$130K', status: 'interested', skills: ['Python', 'PostgreSQL', 'REST APIs', 'Docker'], competencies: ['API Development', 'System Design', 'Testing'], isExample: true },
                { title: 'Web Developer', company: 'HubSpot', location: 'Boston', salary: '$90K', status: 'interested', skills: ['JavaScript', 'React', 'Node.js', 'MongoDB'], competencies: ['Web Development', 'Agile', 'Communication'], isExample: true }
            ],
            'data-analyst': [
                { title: 'Senior Data Analyst', company: 'DataCorp', location: 'New York', salary: '$125K', status: 'interviewing', skills: ['SQL', 'Python', 'Tableau', 'Excel'], competencies: ['Data Analysis', 'Business Intelligence', 'Stakeholder Management'], isExample: true },
                { title: 'BI Analyst', company: 'Salesforce', location: 'San Francisco', salary: '$115K', status: 'interested', skills: ['SQL', 'Tableau', 'Power BI', 'ETL'], competencies: ['Business Intelligence', 'Data Visualization', 'Communication'], isExample: true },
                { title: 'Analytics Engineer', company: 'Airbnb', location: 'Remote', salary: '$140K', status: 'interested', skills: ['SQL', 'Python', 'dbt', 'Looker'], competencies: ['Data Modeling', 'Analytics Engineering', 'Collaboration'], isExample: true },
                { title: 'Data Scientist', company: 'Netflix', location: 'Los Gatos', salary: '$155K', status: 'interested', skills: ['Python', 'SQL', 'Machine Learning', 'A/B Testing'], competencies: ['Statistical Analysis', 'Experimentation', 'Product Analytics'], isExample: true },
                { title: 'Product Analyst', company: 'LinkedIn', location: 'Sunnyvale', salary: '$130K', status: 'interested', skills: ['SQL', 'Python', 'Tableau', 'Excel'], competencies: ['Product Analytics', 'Metrics Definition', 'Cross-functional Collaboration'], isExample: true }
            ]
        };

        function loadJobOpportunities() {
            // Load job data
            loadUserJobs();

            // Combine user jobs with example jobs from enhanced data
            const allJobs = [...userJobs];
            const exampleJobs = exampleJobOpportunities[currentPersona] || [];
            allJobs.push(...exampleJobs);

            // Load based on current view
            if (currentJobView === 'cards') {
                loadJobCardsView(allJobs);
            } else {
                loadJobTableView(allJobs);
            }
        }

        function loadJobCardsView(allJobs) {
            const container = document.getElementById('jobsContainer');
            const tableContainer = document.getElementById('jobsTableContainer');

            container.style.display = 'grid';
            tableContainer.style.display = 'none';
            container.innerHTML = '';

            if (allJobs.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-briefcase" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No job opportunities yet. Click "Add Job" to track a new opportunity.</p>
                    </div>
                `;
                return;
            }

            const statusLabels = {
                'interested': 'Interested',
                'applied': 'Applied',
                'interviewing': 'Interviewing',
                'offer': 'Offer',
                'rejected': 'Rejected',
                'not-interested': 'Not Interested'
            };

            // Display all jobs
            allJobs.forEach((job, index) => {
                const isUserJob = index < userJobs.length;

                const card = document.createElement('div');
                card.className = 'job-card';

                // Style example jobs differently
                if (job.isExample) {
                    card.style.borderLeft = '4px solid #e3f2fd';
                    card.style.background = '#fafbfc';
                }

                card.innerHTML = `
                    <div class="job-card-header">
                        <div style="flex: 1;">
                            <div class="job-title">${escapeHtml(job.title)}</div>
                            <div class="job-company">${escapeHtml(job.company)}</div>
                            ${job.location ? `<div class="job-location"><i class="ph ph-map-pin" style="font-size: 10px;"></i> ${escapeHtml(job.location)}</div>` : ''}
                            ${job.salary ? `<div class="job-salary">${escapeHtml(job.salary)}</div>` : ''}
                            <div style="margin-top: 6px;">
                                <span class="job-status ${job.status}">${statusLabels[job.status]}</span>
                                ${job.isExample ? '<span class="competency-tag" style="margin-left: 6px;">Example</span>' : ''}
                            </div>
                        </div>
                        <div class="story-actions">
                            <button class="story-action-btn" onclick="editJob(${index})" title="Edit">
                                <i class="ph ph-pencil-simple"></i>
                            </button>
                            <button class="story-action-btn delete" ${isUserJob ? `onclick="deleteJob(${index})"` : `onclick="showDemoDeleteToast()" style="opacity: 0.5; cursor: not-allowed;"`} title="${isUserJob ? 'Delete' : 'Cannot delete example jobs'}">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${job.skills && job.skills.length > 0 ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                            <div style="font-size: 11px; font-weight: 600; color: #666; margin-bottom: 6px;">Required Skills</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                ${job.skills.map(skill => `<span style="background: #e3f2fd; color: #0066CC; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">${escapeHtml(skill)}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${job.competencies && job.competencies.length > 0 ? `
                        <div style="margin-top: 8px;">
                            <div style="font-size: 11px; font-weight: 600; color: #666; margin-bottom: 6px;">Key Competencies</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                ${job.competencies.map(comp => `<span style="background: #f5f5f7; color: #666; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">${escapeHtml(comp)}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${job.notes ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--color-neutral-border); font-size: 11px; color: var(--color-neutral-text-light);">${escapeHtml(job.notes)}</div>` : ''}
                `;

                // Add click handler to open job detail modal
                card.addEventListener('click', (e) => {
                    // Don't trigger modal if clicking on edit/delete buttons
                    if (e.target.closest('.story-action-btn')) return;
                    openJobDetail(index, allJobs);
                });

                container.appendChild(card);
            });
        }

        function loadJobTableView(allJobs) {
            const container = document.getElementById('jobsContainer');
            const tableContainer = document.getElementById('jobsTableContainer');
            const tableBody = document.getElementById('jobsTableBody');

            container.style.display = 'none';
            tableContainer.style.display = 'block';
            tableBody.innerHTML = '';

            if (allJobs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                            <i class="ph ph-briefcase" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                            <p style="font-family: var(--font-family-ui); font-size: 15px;">No job opportunities yet. Click "Add Job" to track a new opportunity.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const statusLabels = {
                'interested': 'Interested',
                'applied': 'Applied',
                'interviewing': 'Interviewing',
                'offer': 'Offer',
                'rejected': 'Rejected',
                'not-interested': 'Not Interested'
            };

            // Load todos for next action calculations
            loadJobTodos();

            allJobs.forEach((job, index) => {
                const isUserJob = index < userJobs.length;
                const jobId = getJobIdentifier(job);
                const todos = userJobTodos[jobId] || [];

                // Find next action (first incomplete todo)
                const nextAction = todos.find(todo => !todo.completed);
                const { nextActionText, nextActionDate, nextActionStatus, alertLevel } = getJobNextAction(nextAction);

                const row = document.createElement('tr');
                if (job.isExample) {
                    row.style.background = '#fafbfc';
                }

                row.innerHTML = `
                    <td>
                        <div class="job-table-position">${escapeHtml(job.title)}</div>
                        ${job.location ? `<div class="job-table-location"><i class="ph ph-map-pin"></i> ${escapeHtml(job.location)}</div>` : ''}
                    </td>
                    <td>
                        <div class="job-table-company">${escapeHtml(job.company)}</div>
                        ${job.isExample ? '<div style="font-size: 10px; color: #999; margin-top: 2px;">Example</div>' : ''}
                    </td>
                    <td>
                        <span class="job-table-status job-status ${job.status}">${statusLabels[job.status]}</span>
                    </td>
                    <td>
                        ${job.closeDate ? `
                            <div style="font-size: 12px; font-weight: 500; color: var(--color-dark);">
                                ${new Date(job.closeDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                        ` : `
                            <div style="font-size: 12px; color: var(--color-neutral-text-light); font-style: italic;">
                                No date set
                            </div>
                        `}
                    </td>
                    <td>
                        <div class="job-table-next-action">
                            <div class="job-table-next-action-task">${nextActionText}</div>
                            ${nextActionDate ? `<div class="job-table-next-action-date ${nextActionStatus}">
                                <i class="ph ph-calendar"></i> ${nextActionDate}
                            </div>` : ''}
                        </div>
                    </td>
                    <td class="job-table-alerts">
                        <div class="job-alert-indicator ${alertLevel}" title="${getAlertTooltip(alertLevel, nextAction)}">
                            ${getAlertContent(alertLevel, todos)}
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="job-table-action-btn" onclick="editJob(${index})" title="Edit" style="background: none; border: none; color: var(--color-neutral-text); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;">
                                <i class="ph ph-pencil-simple" style="font-size: 14px;"></i>
                            </button>
                            <button class="job-table-action-btn delete" ${isUserJob ? `onclick="deleteJob(${index})" title="Delete" style="background: none; border: none; color: var(--color-neutral-text); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;"` : `onclick="showDemoDeleteToast()" title="Cannot delete example jobs" style="background: none; border: none; color: var(--color-neutral-text-light); cursor: not-allowed; padding: 4px; border-radius: 4px; opacity: 0.5;"`}>
                                <i class="ph ph-trash" style="font-size: 14px;"></i>
                            </button>
                        </div>
                    </td>
                `;

                // Add click handler to open job detail modal
                row.addEventListener('click', (e) => {
                    // Don't trigger modal if clicking on action buttons
                    if (e.target.closest('.job-table-action-btn')) return;
                    openJobDetail(index, allJobs);
                });

                tableBody.appendChild(row);
            });
        }

        function getJobNextAction(nextAction) {
            if (!nextAction) {
                return {
                    nextActionText: 'No pending tasks',
                    nextActionDate: null,
                    nextActionStatus: 'normal',
                    alertLevel: 'none'
                };
            }

            const today = new Date();
            const due = nextAction.dueDate ? new Date(nextAction.dueDate) : null;

            let nextActionDate = null;
            let nextActionStatus = 'normal';
            let alertLevel = 'normal';

            if (due) {
                const diffTime = due - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    nextActionStatus = 'overdue';
                    alertLevel = 'overdue';
                    nextActionDate = `${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''} overdue`;
                } else if (diffDays === 0) {
                    nextActionStatus = 'due-soon';
                    alertLevel = 'due-soon';
                    nextActionDate = 'Due today';
                } else if (diffDays === 1) {
                    nextActionStatus = 'due-soon';
                    alertLevel = 'due-soon';
                    nextActionDate = 'Due tomorrow';
                } else if (diffDays <= 3) {
                    nextActionStatus = 'due-soon';
                    alertLevel = 'due-soon';
                    nextActionDate = `Due in ${diffDays} days`;
                } else if (diffDays <= 7) {
                    nextActionDate = `Due in ${diffDays} days`;
                } else {
                    nextActionDate = due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            }

            return {
                nextActionText: nextAction.text.length > 40 ? nextAction.text.substring(0, 37) + '...' : nextAction.text,
                nextActionDate,
                nextActionStatus,
                alertLevel
            };
        }

        function getAlertContent(alertLevel, todos) {
            const overdueTasks = todos.filter(todo => {
                if (todo.completed || !todo.dueDate) return false;
                const today = new Date();
                const due = new Date(todo.dueDate);
                return due < today;
            }).length;

            const dueSoonTasks = todos.filter(todo => {
                if (todo.completed || !todo.dueDate) return false;
                const today = new Date();
                const due = new Date(todo.dueDate);
                const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 3;
            }).length;

            switch (alertLevel) {
                case 'overdue':
                    return overdueTasks.toString();
                case 'due-soon':
                    return dueSoonTasks.toString();
                case 'normal':
                    return todos.filter(t => !t.completed).length.toString();
                default:
                    return '0';
            }
        }

        function getAlertTooltip(alertLevel, nextAction) {
            switch (alertLevel) {
                case 'overdue':
                    return `Overdue task: ${nextAction?.text || 'Unknown task'}`;
                case 'due-soon':
                    return `Due soon: ${nextAction?.text || 'Unknown task'}`;
                case 'normal':
                    return 'Active tasks';
                default:
                    return 'No pending tasks';
            }
        }

        function switchJobView(view) {
            currentJobView = view;

            // Update button states
            const cardBtn = document.getElementById('jobCardViewBtn');
            const tableBtn = document.getElementById('jobTableViewBtn');

            cardBtn.classList.toggle('active', view === 'cards');
            tableBtn.classList.toggle('active', view === 'table');

            // Reload data in new view
            loadJobOpportunities();
        }

        // Job Opportunities Management
        let userJobs = [];
        let editingJobIndex = -1;
        let currentJobView = 'cards'; // 'cards' or 'table'

        function loadUserJobs() {
            const stored = localStorage.getItem('jobOpportunities_' + currentPersona);
            if (stored) {
                try {
                    userJobs = JSON.parse(stored);
                } catch (e) {
                    userJobs = [];
                }
            } else {
                userJobs = [];
            }
        }

        function saveUserJobs() {
            localStorage.setItem('jobOpportunities_' + currentPersona, JSON.stringify(userJobs));
        }

        function addJobOpportunity() {
            editingJobIndex = -1;
            document.getElementById('jobFormTitle').textContent = 'Add Job Opportunity';
            document.getElementById('jobForm').reset();
            document.getElementById('jobFormModal').style.display = 'flex';
        }

        function closeJobForm() {
            document.getElementById('jobFormModal').style.display = 'none';
            document.getElementById('jobForm').reset();
            editingJobIndex = -1;
        }

        function saveJob(event) {
            event.preventDefault();

            const job = {
                title: document.getElementById('jobTitle').value,
                company: document.getElementById('jobCompany').value,
                location: document.getElementById('jobLocation').value,
                salary: document.getElementById('jobSalary').value,
                status: document.getElementById('jobStatus').value,
                closeDate: document.getElementById('jobCloseDate').value,
                notes: document.getElementById('jobNotes').value,
                url: document.getElementById('jobUrl').value
            };

            if (editingJobIndex >= 0) {
                userJobs[editingJobIndex] = job;
            } else {
                userJobs.push(job);
            }

            saveUserJobs();
            closeJobForm();
            loadJobOpportunities();
            updateNodeCounts();
        }

        function editJob(index) {
            const job = userJobs[index];
            editingJobIndex = index;

            document.getElementById('jobFormTitle').textContent = 'Edit Job Opportunity';
            document.getElementById('jobTitle').value = job.title;
            document.getElementById('jobCompany').value = job.company;
            document.getElementById('jobLocation').value = job.location || '';
            document.getElementById('jobSalary').value = job.salary || '';
            document.getElementById('jobStatus').value = job.status || 'interested';
            document.getElementById('jobCloseDate').value = job.closeDate || '';
            document.getElementById('jobNotes').value = job.notes || '';
            document.getElementById('jobUrl').value = job.url || '';

            document.getElementById('jobFormModal').style.display = 'flex';
        }

        function deleteJob(index) {
            if (confirm('Are you sure you want to delete this job opportunity?')) {
                userJobs.splice(index, 1);
                saveUserJobs();
                loadJobOpportunities();
                updateNodeCounts();
            }
        }

        function showDemoDeleteToast() {
            showToast('Cannot delete example jobs. Try creating your own job opportunity!', 'info');
        }

        // Job Detail Modal Functions
        let currentJobDetail = null;
        let currentJobIndex = -1;
        let currentJobArray = null;

        function openJobDetail(jobIndex, jobArray) {
            currentJobIndex = jobIndex;
            currentJobArray = jobArray;
            currentJobDetail = jobArray[jobIndex];

            const modal = document.getElementById('jobDetailModal');
            populateJobDetailModal(currentJobDetail, jobIndex);
            modal.classList.add('active');
        }

        function closeJobDetail() {
            const modal = document.getElementById('jobDetailModal');
            modal.classList.remove('active');
            currentJobDetail = null;
            currentJobIndex = -1;
            currentJobArray = null;
        }

        function populateJobDetailModal(job, jobIndex) {
            // Set the title
            document.getElementById('jobDetailTitle').textContent = `${job.title} at ${job.company}`;

            // Set the status
            const statusSelect = document.getElementById('jobDetailStatus');
            statusSelect.value = job.status || 'interested';

            // Set the close date
            const closeDateInput = document.getElementById('jobDetailCloseDate');
            closeDateInput.value = job.closeDate || '';

            // Populate job info
            const jobDetailInfo = document.getElementById('jobDetailInfo');
            jobDetailInfo.innerHTML = `
                <div>
                    <strong style="color: var(--color-dark);">Company:</strong><br>
                    <span>${escapeHtml(job.company)}</span>
                </div>
                <div>
                    <strong style="color: var(--color-dark);">Location:</strong><br>
                    <span>${job.location ? escapeHtml(job.location) : 'Not specified'}</span>
                </div>
                <div>
                    <strong style="color: var(--color-dark);">Salary:</strong><br>
                    <span>${job.salary ? escapeHtml(job.salary) : 'Not specified'}</span>
                </div>
                <div>
                    <strong style="color: var(--color-dark);">Notes:</strong><br>
                    <span>${job.notes ? escapeHtml(job.notes) : 'No notes added'}</span>
                </div>
            `;

            // Populate todo checklist
            populateJobTodos(job);

            // Populate application materials
            populateJobApplicationMaterials(job);

            // Populate skills and competencies
            populateJobSkills(job.skills || []);
            populateJobCompetencies(job.competencies || []);

            // Calculate and display fit analysis
            calculateJobFit(job);
        }

        function populateJobSkills(skills) {
            const container = document.getElementById('jobDetailSkills');
            if (skills.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic; text-align: center;">No required skills specified</p>';
                return;
            }

            container.innerHTML = skills.map(skill => `
                <div class="skill-comp-item">
                    <span style="font-size: 13px; font-weight: 500;">${escapeHtml(skill)}</span>
                    <button onclick="removeJobSkill('${escapeHtml(skill)}')" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 16px;" title="Remove skill">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
            `).join('');
        }

        function populateJobCompetencies(competencies) {
            const container = document.getElementById('jobDetailCompetencies');
            if (competencies.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic; text-align: center;">No key competencies specified</p>';
                return;
            }

            container.innerHTML = competencies.map(comp => `
                <div class="skill-comp-item">
                    <span style="font-size: 13px; font-weight: 500;">${escapeHtml(comp)}</span>
                    <button onclick="removeJobCompetency('${escapeHtml(comp)}')" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 16px;" title="Remove competency">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
            `).join('');
        }

        function updateJobStatus() {
            if (!currentJobDetail || currentJobIndex < 0) return;

            const newStatus = document.getElementById('jobDetailStatus').value;
            currentJobDetail.status = newStatus;

            // Update in the appropriate array (user jobs vs example jobs)
            if (currentJobIndex < userJobs.length) {
                userJobs[currentJobIndex].status = newStatus;
                saveUserJobs();
            }

            // Reload the job opportunities display
            loadJobOpportunities();

            // Update the fit analysis (status might affect scoring)
            calculateJobFit(currentJobDetail);
        }

        function updateJobCloseDate() {
            if (!currentJobDetail || currentJobIndex < 0) return;

            const newCloseDate = document.getElementById('jobDetailCloseDate').value;
            currentJobDetail.closeDate = newCloseDate;

            // Update in the appropriate array (user jobs vs example jobs)
            if (currentJobIndex < userJobs.length) {
                userJobs[currentJobIndex].closeDate = newCloseDate;
                saveUserJobs();
            }

            // Reload the job opportunities display to show updated close date
            loadJobOpportunities();
        }

        function addJobSkill() {
            const skill = prompt('Enter a required skill:');
            if (!skill || !currentJobDetail) return;

            if (!currentJobDetail.skills) currentJobDetail.skills = [];
            if (currentJobDetail.skills.includes(skill.trim())) {
                alert('This skill is already listed!');
                return;
            }

            currentJobDetail.skills.push(skill.trim());

            // Update in the appropriate array if it's a user job
            if (currentJobIndex < userJobs.length) {
                if (!userJobs[currentJobIndex].skills) userJobs[currentJobIndex].skills = [];
                userJobs[currentJobIndex].skills.push(skill.trim());
                saveUserJobs();
            }

            populateJobSkills(currentJobDetail.skills);
            calculateJobFit(currentJobDetail);
            loadJobOpportunities();
        }

        function addJobCompetency() {
            const competency = prompt('Enter a key competency:');
            if (!competency || !currentJobDetail) return;

            if (!currentJobDetail.competencies) currentJobDetail.competencies = [];
            if (currentJobDetail.competencies.includes(competency.trim())) {
                alert('This competency is already listed!');
                return;
            }

            currentJobDetail.competencies.push(competency.trim());

            // Update in the appropriate array if it's a user job
            if (currentJobIndex < userJobs.length) {
                if (!userJobs[currentJobIndex].competencies) userJobs[currentJobIndex].competencies = [];
                userJobs[currentJobIndex].competencies.push(competency.trim());
                saveUserJobs();
            }

            populateJobCompetencies(currentJobDetail.competencies);
            calculateJobFit(currentJobDetail);
            loadJobOpportunities();
        }

        function removeJobSkill(skill) {
            if (!currentJobDetail || !currentJobDetail.skills) return;

            currentJobDetail.skills = currentJobDetail.skills.filter(s => s !== skill);

            // Update in the appropriate array if it's a user job
            if (currentJobIndex < userJobs.length && userJobs[currentJobIndex].skills) {
                userJobs[currentJobIndex].skills = userJobs[currentJobIndex].skills.filter(s => s !== skill);
                saveUserJobs();
            }

            populateJobSkills(currentJobDetail.skills);
            calculateJobFit(currentJobDetail);
            loadJobOpportunities();
        }

        function removeJobCompetency(competency) {
            if (!currentJobDetail || !currentJobDetail.competencies) return;

            currentJobDetail.competencies = currentJobDetail.competencies.filter(c => c !== competency);

            // Update in the appropriate array if it's a user job
            if (currentJobIndex < userJobs.length && userJobs[currentJobIndex].competencies) {
                userJobs[currentJobIndex].competencies = userJobs[currentJobIndex].competencies.filter(c => c !== competency);
                saveUserJobs();
            }

            populateJobCompetencies(currentJobDetail.competencies);
            calculateJobFit(currentJobDetail);
            loadJobOpportunities();
        }

        function calculateJobFit(job) {
            // Load user skills and competencies
            loadUserSkillsCompetencies();

            const jobSkills = job.skills || [];
            const jobCompetencies = job.competencies || [];

            // Get user's skills and competencies
            const userSkills = userSkillsCompetencies.filter(item => item.type === 'skill');
            const userComps = userSkillsCompetencies.filter(item => item.type === 'competency');

            // Calculate fit dimensions
            const dimensions = [];

            // Skills Match
            const skillsMatch = calculateMatchScore(jobSkills, userSkills.map(s => s.name));
            dimensions.push({
                name: 'Skills Match',
                score: skillsMatch.percentage,
                details: `${skillsMatch.matches} of ${jobSkills.length} required skills match`,
                color: getScoreColor(skillsMatch.percentage)
            });

            // Competencies Match
            const compMatch = calculateMatchScore(jobCompetencies, userComps.map(c => c.name));
            dimensions.push({
                name: 'Competencies Match',
                score: compMatch.percentage,
                details: `${compMatch.matches} of ${jobCompetencies.length} key competencies match`,
                color: getScoreColor(compMatch.percentage)
            });

            // Experience Level (based on user's skill levels)
            const avgUserLevel = userSkills.length > 0
                ? userSkills.reduce((sum, skill) => sum + (skill.currentLevel || 1), 0) / userSkills.length
                : 1;
            const experienceScore = Math.min(100, (avgUserLevel / 4) * 100);
            dimensions.push({
                name: 'Experience Level',
                score: experienceScore,
                details: `Average skill level: ${avgUserLevel.toFixed(1)}/4`,
                color: getScoreColor(experienceScore)
            });

            // Career Stage Alignment (based on job status and user profile)
            const careerScore = getCareerAlignmentScore(job, currentPersona);
            dimensions.push({
                name: 'Career Stage Fit',
                score: careerScore,
                details: getCareerAlignmentDetails(job, currentPersona),
                color: getScoreColor(careerScore)
            });

            // Calculate overall score (weighted average)
            const overallScore = Math.round(
                (skillsMatch.percentage * 0.4) +
                (compMatch.percentage * 0.3) +
                (experienceScore * 0.2) +
                (careerScore * 0.1)
            );

            // Display the results
            displayJobFitResults(overallScore, dimensions);
        }

        function calculateMatchScore(required, userHas) {
            if (required.length === 0) return { percentage: 100, matches: 0 };

            const matches = required.filter(req =>
                userHas.some(user => user.toLowerCase().includes(req.toLowerCase()) || req.toLowerCase().includes(user.toLowerCase()))
            ).length;

            return {
                percentage: Math.round((matches / required.length) * 100),
                matches: matches
            };
        }

        function getScoreColor(score) {
            if (score >= 80) return '#388e3c'; // Green
            if (score >= 60) return '#f57c00'; // Orange
            if (score >= 40) return '#ff9800'; // Amber
            return '#d32f2f'; // Red
        }

        function getCareerAlignmentScore(job, persona) {
            // Simple heuristic based on persona and job characteristics
            const baseScore = 75;

            // Adjust based on persona-specific factors
            switch (persona) {
                case 'new-graduate':
                    return job.title.toLowerCase().includes('junior') || job.title.toLowerCase().includes('entry') ? 90 : 60;
                case 'data-analyst':
                    return job.title.toLowerCase().includes('analyst') || job.title.toLowerCase().includes('data') ? 90 : 70;
                case 'retail-manager':
                    return job.title.toLowerCase().includes('manager') || job.title.toLowerCase().includes('operations') ? 90 : 65;
                case 'chemist':
                    return job.title.toLowerCase().includes('scientist') || job.title.toLowerCase().includes('research') ? 90 : 55;
                default:
                    return baseScore;
            }
        }

        function getCareerAlignmentDetails(job, persona) {
            switch (persona) {
                case 'new-graduate':
                    return 'Entry-level position analysis';
                case 'data-analyst':
                    return 'Data/analytics role alignment';
                case 'retail-manager':
                    return 'Management/operations alignment';
                case 'chemist':
                    return 'Scientific role alignment';
                default:
                    return 'General career fit assessment';
            }
        }

        function displayJobFitResults(overallScore, dimensions) {
            // Update overall score
            const scoreCircle = document.getElementById('fitScoreCircle');
            scoreCircle.textContent = `${overallScore}%`;
            scoreCircle.style.backgroundColor = getScoreColor(overallScore);

            const scoreDetails = scoreCircle.nextElementSibling;
            let scoreDescription;
            if (overallScore >= 80) scoreDescription = 'Excellent match based on your profile';
            else if (overallScore >= 60) scoreDescription = 'Good match with some development opportunities';
            else if (overallScore >= 40) scoreDescription = 'Moderate fit, consider skill development';
            else scoreDescription = 'Limited match, significant gaps identified';

            scoreDetails.querySelector('p').textContent = scoreDescription;

            // Update dimensions
            const dimensionsContainer = document.getElementById('fitDimensions');
            dimensionsContainer.innerHTML = dimensions.map(dim => `
                <div class="fit-dimension">
                    <div class="dimension-info">
                        <div class="dimension-name">${dim.name}</div>
                        <div class="dimension-details">${dim.details}</div>
                    </div>
                    <div class="dimension-score">
                        <div class="score-bar">
                            <div class="score-bar-fill" style="width: ${dim.score}%; background-color: ${dim.color};"></div>
                        </div>
                        <div class="score-text" style="color: ${dim.color};">${dim.score}%</div>
                    </div>
                </div>
            `).join('');
        }

        // Application Materials Functions
        function populateJobApplicationMaterials(job) {
            const container = document.getElementById('jobApplicationMaterials');

            // Load user application materials and example materials
            loadUserApplicationMaterials();
            const exampleMaterials = exampleApplicationMaterials[currentPersona] || [];
            const allMaterials = [...userApplicationMaterials, ...exampleMaterials];

            // Filter materials related to this specific job
            const jobTitle = job.title;
            const jobCompany = job.company;
            const jobOpportunityString = `${jobTitle} - ${jobCompany}`;

            const relatedMaterials = allMaterials.filter(material => {
                return material.jobOpportunity === jobOpportunityString ||
                       material.jobOpportunity === `${jobTitle} at ${jobCompany}` ||
                       material.jobOpportunity.includes(jobTitle) ||
                       material.jobOpportunity.includes(jobCompany);
            });

            if (relatedMaterials.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #999; font-style: italic;">
                        <i class="ph ph-file-text" style="font-size: 32px; margin-bottom: 8px; display: block; color: #ccc;"></i>
                        No application materials created for this opportunity yet.
                        <br><small>Use the buttons below to generate or upload materials.</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = relatedMaterials.map((material, index) => {
                const iconClass = getApplicationMaterialIcon(material.type);
                const iconBgClass = material.type.toLowerCase().replace(' ', '-');

                return `
                    <div class="app-material-item">
                        <div class="app-material-icon ${iconBgClass}">
                            <i class="ph ${iconClass}"></i>
                        </div>
                        <div class="app-material-info">
                            <div class="app-material-title">${escapeHtml(material.title)}</div>
                            <div class="app-material-meta">
                                <span class="app-material-tag format">${material.format}</span>
                                ${material.atsOptimized ? '<span class="app-material-tag ats">ATS Optimized</span>' : ''}
                                <span class="app-material-tag date">${new Date(material.createdDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</span>
                            </div>
                            <div class="app-material-preview">
                                ${escapeHtml(material.content.substring(0, 120))}${material.content.length > 120 ? '...' : ''}
                            </div>
                        </div>
                        <div class="app-material-actions">
                            <button class="app-material-action-btn" onclick="viewApplicationMaterial(${index}, '${material.type}')">
                                <i class="ph ph-eye"></i> View
                            </button>
                            <button class="app-material-action-btn" onclick="downloadApplicationMaterial(${index}, '${material.type}')">
                                <i class="ph ph-download"></i> Download
                            </button>
                            ${!material.isExample ? `
                                <button class="app-material-action-btn delete" onclick="deleteApplicationMaterial(${index}, '${material.type}')">
                                    <i class="ph ph-trash"></i> Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getApplicationMaterialIcon(type) {
            const icons = {
                'Resume': 'ph-file-text',
                'Cover Letter': 'ph-envelope',
                'Email': 'ph-at'
            };
            return icons[type] || 'ph-file-text';
        }

        function generateJobMaterial() {
            if (!currentJobDetail) return;

            const jobTitle = currentJobDetail.title;
            const jobCompany = currentJobDetail.company;

            // Create modal for material type selection
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 400px; width: 100%;">
                    <h3 style="margin: 0 0 20px 0; font-family: var(--font-family-ui); color: var(--color-dark);">Generate Application Material</h3>
                    <p style="margin: 0 0 20px 0; color: var(--color-neutral-text); font-size: 13px;">
                        Create a customized document for <strong>${escapeHtml(jobTitle)}</strong> at <strong>${escapeHtml(jobCompany)}</strong>
                    </p>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Material Type</label>
                        <select id="materialTypeSelect" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            <option value="Resume">Resume</option>
                            <option value="Cover Letter">Cover Letter</option>
                            <option value="Email">Email</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="createJobApplicationMaterial()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="ph ph-sparkle"></i> Generate
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function createJobApplicationMaterial() {
            const materialType = document.getElementById('materialTypeSelect').value;
            const modal = document.querySelector('div[style*="position: fixed"]');

            if (!currentJobDetail) {
                alert('No job selected');
                modal.remove();
                return;
            }

            // Create the material
            const jobOpportunityString = `${currentJobDetail.title} - ${currentJobDetail.company}`;
            const newMaterial = {
                type: materialType,
                title: `${materialType} for ${currentJobDetail.title}`,
                jobOpportunity: jobOpportunityString,
                content: generateMaterialContent(materialType, currentJobDetail),
                format: materialType === 'Email' ? 'HTML' : (materialType === 'Resume' ? 'PDF' : 'DOCX'),
                atsOptimized: materialType !== 'Email',
                createdDate: new Date().toISOString()
            };

            // Add to user materials
            loadUserApplicationMaterials();
            userApplicationMaterials.push(newMaterial);
            saveUserApplicationMaterials();

            // Refresh the display
            populateJobApplicationMaterials(currentJobDetail);

            modal.remove();
            alert(`${materialType} generated successfully! In a full implementation, this would create a customized ${materialType.toLowerCase()} tailored to this specific role and company.`);
        }

        function generateMaterialContent(type, job) {
            const templates = {
                'Resume': `Professional ${currentPersona} resume tailored for ${job.title} at ${job.company}. Highlights relevant experience, skills, and achievements that align with the job requirements. Includes contact information, professional summary, work experience, education, and key skills section.`,

                'Cover Letter': `Dear Hiring Manager,\n\nI am writing to express my strong interest in the ${job.title} position at ${job.company}. Based on my background and the role requirements, I believe I would be a valuable addition to your team.\n\n[Personalized content based on job requirements and user profile would be generated here]\n\nThank you for considering my application. I look forward to the opportunity to discuss how my skills and experience can contribute to ${job.company}'s success.\n\nSincerely,\n[Your Name]`,

                'Email': `Subject: Application for ${job.title} Position\n\nDear Hiring Manager,\n\nI hope this email finds you well. I am reaching out to express my interest in the ${job.title} position at ${job.company}.\n\n[Personalized email content would be generated here based on the job requirements and user profile]\n\nI have attached my resume for your review and would welcome the opportunity to discuss this position further.\n\nBest regards,\n[Your Name]`
            };

            return templates[type] || `Generated ${type} content for ${job.title} at ${job.company}`;
        }

        function uploadJobMaterial() {
            if (!currentJobDetail) return;
            alert(`Upload functionality coming soon! This will allow you to upload application materials specifically for ${currentJobDetail.title} at ${currentJobDetail.company}.`);
        }

        function viewApplicationMaterial(index, type) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            // Get the material (this is a simplified version - in reality you'd need to track the filtered materials)
            loadUserApplicationMaterials();
            const exampleMaterials = exampleApplicationMaterials[currentPersona] || [];
            const allMaterials = [...userApplicationMaterials, ...exampleMaterials];
            const material = allMaterials[index];

            if (!material) return;

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; width: 90%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-family: var(--font-family-ui);">${escapeHtml(material.title)}</h3>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <div style="padding: 20px; overflow-y: auto; flex: 1;">
                        <div style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; white-space: pre-wrap;">
                            ${escapeHtml(material.content)}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function downloadApplicationMaterial(index, type) {
            alert(`Download ${type} functionality coming soon! In a full implementation, this would download the material as a properly formatted document.`);
        }

        function deleteApplicationMaterial(index, type) {
            if (!confirm(`Are you sure you want to delete this ${type}?`)) return;

            // Remove from user materials (this is simplified - you'd need proper index tracking)
            loadUserApplicationMaterials();
            if (index < userApplicationMaterials.length) {
                userApplicationMaterials.splice(index, 1);
                saveUserApplicationMaterials();
                populateJobApplicationMaterials(currentJobDetail);
            }
        }

        // Job Todo Checklist Functions
        let userJobTodos = {};  // Will store todos by job identifier

        function getJobIdentifier(job) {
            return `${job.title}-${job.company}`.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
        }

        function loadJobTodos() {
            const stored = localStorage.getItem(`jobTodos_${currentPersona}`);
            userJobTodos = stored ? JSON.parse(stored) : {};
        }

        function saveJobTodos() {
            localStorage.setItem(`jobTodos_${currentPersona}`, JSON.stringify(userJobTodos));
        }

        function populateJobTodos(job) {
            const container = document.getElementById('jobTodoList');
            loadJobTodos();

            const jobId = getJobIdentifier(job);
            let todos = userJobTodos[jobId] || [];

            // If no todos exist, create default ones based on job status
            if (todos.length === 0) {
                todos = generateDefaultTodos(job);
                userJobTodos[jobId] = todos;
                saveJobTodos();
            }

            if (todos.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #999; font-style: italic;">
                        <i class="ph ph-check-square" style="font-size: 32px; margin-bottom: 8px; display: block; color: #ccc;"></i>
                        No application tasks created yet.
                        <br><small>Use the buttons below to add tasks or set deadlines.</small>
                    </div>
                `;
                return;
            }

            // Sort todos by due date and priority
            todos.sort((a, b) => {
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                if (a.dueDate && b.dueDate) {
                    return new Date(a.dueDate) - new Date(b.dueDate);
                }
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
            });

            container.innerHTML = todos.map((todo, index) => {
                const dueStatus = getDueStatus(todo.dueDate);
                const dueDateClass = todo.completed ? 'normal' : dueStatus.class;
                const itemClass = `job-todo-item ${todo.completed ? 'completed' : ''} ${dueStatus.itemClass}`;

                return `
                    <div class="${itemClass}">
                        <input
                            type="checkbox"
                            class="job-todo-checkbox"
                            ${todo.completed ? 'checked' : ''}
                            onchange="toggleJobTodo(${index})"
                        >
                        <div class="job-todo-content">
                            <div class="job-todo-text">${escapeHtml(todo.text)}</div>
                            <div class="job-todo-meta">
                                ${todo.dueDate ? `
                                    <span class="job-todo-due-date ${dueDateClass}">
                                        <i class="ph ph-calendar"></i>
                                        Due ${formatDueDate(todo.dueDate)}
                                    </span>
                                ` : ''}
                                ${todo.priority ? `
                                    <span class="job-todo-priority ${todo.priority}">${todo.priority}</span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="job-todo-actions">
                            <button class="job-todo-action-btn" onclick="editJobTodo(${index})" title="Edit">
                                <i class="ph ph-pencil-simple"></i>
                            </button>
                            <button class="job-todo-action-btn delete" onclick="deleteJobTodo(${index})" title="Delete">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateDefaultTodos(job) {
            const baseDate = new Date();
            const addDays = (days) => {
                const date = new Date(baseDate);
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0];
            };

            const defaultTodos = [
                { text: 'Review job description and requirements thoroughly', priority: 'high', dueDate: addDays(1), completed: false },
                { text: 'Research company culture and recent news', priority: 'high', dueDate: addDays(2), completed: false },
                { text: 'Tailor resume for this specific role', priority: 'high', dueDate: addDays(3), completed: false },
                { text: 'Write personalized cover letter', priority: 'high', dueDate: addDays(4), completed: false },
                { text: 'Submit application through company website', priority: 'high', dueDate: addDays(7), completed: false },
                { text: 'Follow up on application status', priority: 'medium', dueDate: addDays(14), completed: false },
                { text: 'Prepare for potential phone screening', priority: 'medium', dueDate: addDays(10), completed: false },
                { text: 'Research interview questions for this role', priority: 'medium', dueDate: addDays(10), completed: false },
                { text: 'Prepare behavioral interview stories', priority: 'medium', dueDate: addDays(12), completed: false },
                { text: 'Connect with employees on LinkedIn', priority: 'low', dueDate: addDays(5), completed: false }
            ];

            return defaultTodos;
        }

        function getDueStatus(dueDate) {
            if (!dueDate) return { class: 'normal', itemClass: '' };

            const today = new Date();
            const due = new Date(dueDate);
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return { class: 'overdue', itemClass: 'overdue' };
            } else if (diffDays <= 3) {
                return { class: 'due-soon', itemClass: 'due-soon' };
            } else {
                return { class: 'normal', itemClass: '' };
            }
        }

        function formatDueDate(dueDate) {
            const today = new Date();
            const due = new Date(dueDate);
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return `${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''} ago`;
            } else if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Tomorrow';
            } else if (diffDays <= 7) {
                return `in ${diffDays} days`;
            } else {
                return due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        function toggleJobTodo(index) {
            if (!currentJobDetail) return;

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];

            if (todos[index]) {
                todos[index].completed = !todos[index].completed;
                userJobTodos[jobId] = todos;
                saveJobTodos();
                populateJobTodos(currentJobDetail);
            }
        }

        function addJobTodo() {
            if (!currentJobDetail) return;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 100%;">
                    <h3 style="margin: 0 0 20px 0; font-family: var(--font-family-ui); color: var(--color-dark);">Add Application Task</h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Task Description</label>
                        <input type="text" id="todoText" placeholder="e.g., Follow up with hiring manager" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Due Date</label>
                            <input type="date" id="todoDueDate" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Priority</label>
                            <select id="todoPriority" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="saveJobTodo()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="ph ph-plus"></i> Add Task
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function saveJobTodo() {
            const text = document.getElementById('todoText').value.trim();
            const dueDate = document.getElementById('todoDueDate').value;
            const priority = document.getElementById('todoPriority').value;
            const modal = document.querySelector('div[style*="position: fixed"]');

            if (!text) {
                alert('Please enter a task description');
                return;
            }

            const jobId = getJobIdentifier(currentJobDetail);
            if (!userJobTodos[jobId]) userJobTodos[jobId] = [];

            const newTodo = {
                text: text,
                dueDate: dueDate || null,
                priority: priority,
                completed: false,
                createdDate: new Date().toISOString()
            };

            userJobTodos[jobId].push(newTodo);
            saveJobTodos();
            populateJobTodos(currentJobDetail);

            modal.remove();
        }

        function editJobTodo(index) {
            if (!currentJobDetail) return;

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];
            const todo = todos[index];

            if (!todo) return;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 100%;">
                    <h3 style="margin: 0 0 20px 0; font-family: var(--font-family-ui); color: var(--color-dark);">Edit Application Task</h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Task Description</label>
                        <input type="text" id="editTodoText" value="${escapeHtml(todo.text)}" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Due Date</label>
                            <input type="date" id="editTodoDueDate" value="${todo.dueDate || ''}" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Priority</label>
                            <select id="editTodoPriority" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <option value="low" ${todo.priority === 'low' ? 'selected' : ''}>Low</option>
                                <option value="medium" ${todo.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                <option value="high" ${todo.priority === 'high' ? 'selected' : ''}>High</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="updateJobTodo(${index})" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="ph ph-check"></i> Update Task
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function updateJobTodo(index) {
            const text = document.getElementById('editTodoText').value.trim();
            const dueDate = document.getElementById('editTodoDueDate').value;
            const priority = document.getElementById('editTodoPriority').value;
            const modal = document.querySelector('div[style*="position: fixed"]');

            if (!text) {
                alert('Please enter a task description');
                return;
            }

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];

            if (todos[index]) {
                todos[index].text = text;
                todos[index].dueDate = dueDate || null;
                todos[index].priority = priority;
                userJobTodos[jobId] = todos;
                saveJobTodos();
                populateJobTodos(currentJobDetail);
            }

            modal.remove();
        }

        function deleteJobTodo(index) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];

            if (todos[index]) {
                todos.splice(index, 1);
                userJobTodos[jobId] = todos;
                saveJobTodos();
                populateJobTodos(currentJobDetail);
            }
        }

        function setJobDeadlines() {
            if (!currentJobDetail) return;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 400px; width: 100%;">
                    <h3 style="margin: 0 0 20px 0; font-family: var(--font-family-ui); color: var(--color-dark);">Set Application Deadlines</h3>
                    <p style="margin: 0 0 20px 0; color: var(--color-neutral-text); font-size: 13px;">
                        Automatically set due dates for all tasks based on a target application date.
                    </p>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Target Application Date</label>
                        <input type="date" id="targetApplicationDate" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        <small style="color: var(--color-neutral-text-light); font-size: 11px;">Tasks will be scheduled to complete before this date</small>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="applyJobDeadlines()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="ph ph-calendar"></i> Set Deadlines
                        </button>
                    </div>
                </div>
            `;

            // Set default date to one week from today
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 7);

            document.body.appendChild(modal);
            document.getElementById('targetApplicationDate').value = defaultDate.toISOString().split('T')[0];
        }

        function applyJobDeadlines() {
            const targetDate = document.getElementById('targetApplicationDate').value;
            const modal = document.querySelector('div[style*="position: fixed"]');

            if (!targetDate) {
                alert('Please select a target application date');
                return;
            }

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];

            if (todos.length === 0) {
                alert('No tasks found to set deadlines for');
                modal.remove();
                return;
            }

            // Calculate working backwards from target date
            const target = new Date(targetDate);
            const today = new Date();
            const daysAvailable = Math.ceil((target - today) / (1000 * 60 * 60 * 24));

            if (daysAvailable < 1) {
                alert('Target date must be in the future');
                return;
            }

            // Assign deadlines based on priority and task type
            todos.forEach((todo, index) => {
                if (todo.completed) return; // Don't change completed tasks

                let dayOffset;
                const text = todo.text.toLowerCase();

                // Assign based on task content and priority
                if (text.includes('review') || text.includes('research company')) {
                    dayOffset = Math.max(1, Math.floor(daysAvailable * 0.1));
                } else if (text.includes('resume') || text.includes('tailor')) {
                    dayOffset = Math.max(2, Math.floor(daysAvailable * 0.3));
                } else if (text.includes('cover letter')) {
                    dayOffset = Math.max(3, Math.floor(daysAvailable * 0.4));
                } else if (text.includes('submit') || text.includes('apply')) {
                    dayOffset = Math.max(1, Math.floor(daysAvailable * 0.9));
                } else if (text.includes('follow up')) {
                    dayOffset = daysAvailable + 7; // After application
                } else if (text.includes('prepare') || text.includes('interview')) {
                    dayOffset = Math.max(3, Math.floor(daysAvailable * 0.8));
                } else {
                    // Default based on priority
                    switch (todo.priority) {
                        case 'high':
                            dayOffset = Math.max(1, Math.floor(daysAvailable * 0.5));
                            break;
                        case 'medium':
                            dayOffset = Math.max(2, Math.floor(daysAvailable * 0.7));
                            break;
                        default:
                            dayOffset = Math.max(3, Math.floor(daysAvailable * 0.6));
                    }
                }

                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + dayOffset);
                todo.dueDate = dueDate.toISOString().split('T')[0];
            });

            userJobTodos[jobId] = todos;
            saveJobTodos();
            populateJobTodos(currentJobDetail);

            modal.remove();
            alert(`Deadlines set for ${todos.filter(t => !t.completed).length} tasks based on ${targetDate} target date.`);
        }

        // Career Experience Management
        let userExperiences = [];
        let editingExperienceIndex = -1;

        // Example experiences for each persona
        const exampleExperiences = {
            'retail-manager': [
                {
                    organizationName: 'RetailMart',
                    role: 'Store Manager',
                    location: 'Denver, CO',
                    startDate: '2019-03',
                    endDate: '2024-02',
                    description: 'Managed daily operations of high-volume retail location with 25+ staff members. Oversaw inventory, scheduling, customer service, and P&L.',
                    technologies: [
                        { name: 'Excel', type: 'Core' },
                        { name: 'POS Systems', type: 'Core' },
                        { name: 'Inventory Management Software', type: 'Core' },
                        { name: 'Scheduling Tools', type: 'Peripheral' }
                    ],
                    keySkills: ['Team Leadership', 'P&L Management', 'Customer Service', 'Inventory Control', 'Staff Training'],
                    competencies: ['Operations Management', 'Process Improvement', 'Performance Analytics', 'Stakeholder Communication'],
                    projectTypes: ['Process Optimization', 'Team Development', 'Customer Experience Enhancement'],
                    internalStakeholders: ['Regional Manager', 'HR Department', 'Loss Prevention Team'],
                    externalStakeholders: ['Customers', 'Vendors', 'Local Community'],
                    achievements: [
                        'Increased store revenue by 23% year-over-year',
                        'Reduced employee turnover by 40% through improved training',
                        'Maintained 95%+ customer satisfaction score'
                    ]
                },
                {
                    organizationName: 'QuickMart',
                    role: 'Assistant Store Manager',
                    location: 'Denver, CO',
                    startDate: '2016-06',
                    endDate: '2019-02',
                    description: 'Supported store operations and managed shifts. Supervised 10+ employees, handled customer escalations, and assisted with inventory management.',
                    technologies: [
                        { name: 'Excel', type: 'Core' },
                        { name: 'POS Systems', type: 'Core' },
                        { name: 'Inventory Software', type: 'Peripheral' }
                    ],
                    keySkills: ['Shift Management', 'Customer Service', 'Team Supervision', 'Problem Solving', 'Cash Handling'],
                    competencies: ['Operations Support', 'Conflict Resolution', 'Team Coordination', 'Sales Performance'],
                    projectTypes: ['Customer Service Improvement', 'Team Training', 'Loss Prevention'],
                    internalStakeholders: ['Store Manager', 'District Manager', 'Loss Prevention'],
                    externalStakeholders: ['Customers', 'Vendors'],
                    achievements: [
                        'Promoted to Store Manager after 2.5 years',
                        'Reduced shrinkage by 15% through improved procedures',
                        'Consistently achieved top 3 in customer satisfaction surveys'
                    ]
                },
                {
                    organizationName: 'FreshFoods Grocery',
                    role: 'Department Supervisor',
                    location: 'Colorado Springs, CO',
                    startDate: '2014-08',
                    endDate: '2016-05',
                    description: 'Supervised produce department with 6 team members. Managed ordering, merchandising, quality control, and customer service.',
                    technologies: [
                        { name: 'Excel', type: 'Peripheral' },
                        { name: 'Ordering Systems', type: 'Core' }
                    ],
                    keySkills: ['Inventory Management', 'Merchandising', 'Quality Control', 'Team Leadership', 'Vendor Relations'],
                    competencies: ['Department Operations', 'Product Knowledge', 'Loss Prevention', 'Customer Engagement'],
                    projectTypes: ['Process Standardization', 'Quality Improvement', 'Sales Growth'],
                    internalStakeholders: ['Store Manager', 'Other Department Supervisors'],
                    externalStakeholders: ['Produce Vendors', 'Customers'],
                    achievements: [
                        'Increased department sales by 18%',
                        'Reduced spoilage by 25% through better rotation',
                        'Trained 3 employees who went on to supervisor roles'
                    ]
                }
            ],
            'chemist': [
                {
                    organizationName: 'PharmaTech Labs',
                    role: 'Research Chemist',
                    location: 'Boston, MA',
                    startDate: '2020-06',
                    endDate: '2024-01',
                    description: 'Conducted analytical chemistry research for pharmaceutical development. Designed experiments, analyzed compounds, and collaborated with cross-functional teams.',
                    technologies: [
                        { name: 'HPLC', type: 'Core' },
                        { name: 'Mass Spectrometry', type: 'Core' },
                        { name: 'Python', type: 'Peripheral' },
                        { name: 'ChemDraw', type: 'Core' },
                        { name: 'Lab Information Management Systems', type: 'Peripheral' }
                    ],
                    keySkills: ['Analytical Chemistry', 'Data Analysis', 'Technical Writing', 'Lab Safety', 'Quality Control'],
                    competencies: ['Scientific Research', 'Problem Solving', 'Regulatory Compliance', 'Cross-functional Collaboration'],
                    projectTypes: ['Research & Development', 'Quality Assurance', 'Method Validation'],
                    internalStakeholders: ['Principal Scientist', 'Quality Team', 'R&D Leadership'],
                    externalStakeholders: ['Regulatory Agencies', 'Contract Labs', 'Equipment Vendors'],
                    achievements: [
                        'Published 3 peer-reviewed papers in analytical chemistry journals',
                        'Developed new testing method reducing analysis time by 35%',
                        'Led successful FDA audit with zero findings'
                    ]
                },
                {
                    organizationName: 'BioTech Research Inc',
                    role: 'Associate Chemist',
                    location: 'Cambridge, MA',
                    startDate: '2018-09',
                    endDate: '2020-05',
                    description: 'Performed laboratory analysis and quality control testing. Maintained lab equipment, documented procedures, and supported senior researchers.',
                    technologies: [
                        { name: 'GC-MS', type: 'Core' },
                        { name: 'HPLC', type: 'Core' },
                        { name: 'Spectroscopy', type: 'Core' },
                        { name: 'LabWare LIMS', type: 'Peripheral' }
                    ],
                    keySkills: ['Laboratory Techniques', 'Quality Control', 'Documentation', 'Equipment Maintenance', 'Sample Preparation'],
                    competencies: ['Analytical Testing', 'GLP/GMP Compliance', 'Technical Documentation', 'Lab Safety'],
                    projectTypes: ['Quality Control', 'Method Development Support', 'Equipment Validation'],
                    internalStakeholders: ['Senior Chemists', 'Quality Manager', 'Lab Technicians'],
                    externalStakeholders: ['Equipment Vendors', 'Calibration Services'],
                    achievements: [
                        'Maintained 99.5% accuracy rate on quality control samples',
                        'Reduced instrument downtime by 30% through preventive maintenance',
                        'Trained 5 new lab technicians on analytical methods'
                    ]
                },
                {
                    organizationName: 'University Research Lab',
                    role: 'Graduate Research Assistant',
                    location: 'Boston, MA',
                    startDate: '2016-08',
                    endDate: '2018-05',
                    description: 'Conducted graduate research in organic chemistry. Synthesized compounds, performed characterization, and assisted with undergraduate teaching.',
                    technologies: [
                        { name: 'NMR Spectroscopy', type: 'Core' },
                        { name: 'Chromatography', type: 'Core' },
                        { name: 'ChemDraw', type: 'Core' }
                    ],
                    keySkills: ['Organic Synthesis', 'Compound Characterization', 'Literature Research', 'Scientific Writing', 'Teaching'],
                    competencies: ['Research Design', 'Data Analysis', 'Academic Collaboration', 'Presentation Skills'],
                    projectTypes: ['Academic Research', 'Teaching Assistant', 'Thesis Research'],
                    internalStakeholders: ['Thesis Advisor', 'Lab Group Members', 'Undergraduate Students'],
                    externalStakeholders: ['Academic Conferences', 'Journal Reviewers'],
                    achievements: [
                        'Published 2 first-author papers in peer-reviewed journals',
                        'Received departmental teaching excellence award',
                        'Completed Master of Science in Chemistry with honors'
                    ]
                }
            ],
            'new-graduate': [
                {
                    organizationName: 'State University',
                    role: 'Computer Science Student',
                    location: 'Austin, TX',
                    startDate: '2020-08',
                    endDate: '2024-05',
                    description: 'Bachelor of Science in Computer Science. Completed coursework in algorithms, data structures, web development, and databases. Participated in hackathons and coding competitions.',
                    technologies: [
                        { name: 'Python', type: 'Core' },
                        { name: 'Java', type: 'Core' },
                        { name: 'JavaScript', type: 'Core' },
                        { name: 'React', type: 'Peripheral' },
                        { name: 'SQL', type: 'Core' },
                        { name: 'Git', type: 'Core' }
                    ],
                    keySkills: ['Object-Oriented Programming', 'Algorithm Design', 'Web Development', 'Database Design', 'Agile Methodology'],
                    competencies: ['Software Development', 'Problem Solving', 'Technical Communication', 'Team Collaboration'],
                    projectTypes: ['Capstone Project', 'Hackathons', 'Academic Research'],
                    internalStakeholders: ['Academic Advisors', 'Professors', 'Student Teams'],
                    externalStakeholders: ['Industry Mentors', 'Open Source Community'],
                    achievements: [
                        'Graduated Magna Cum Laude with 3.8 GPA',
                        'Won 1st place at regional hackathon for mobile app development',
                        'Completed 3-month internship at tech startup'
                    ]
                },
                {
                    organizationName: 'TechStart Inc',
                    role: 'Software Engineering Intern',
                    location: 'Austin, TX',
                    startDate: '2023-06',
                    endDate: '2023-08',
                    description: '12-week summer internship developing web applications. Built features for customer-facing portal, fixed bugs, and participated in code reviews.',
                    technologies: [
                        { name: 'React', type: 'Core' },
                        { name: 'Node.js', type: 'Core' },
                        { name: 'MongoDB', type: 'Core' },
                        { name: 'Git', type: 'Core' },
                        { name: 'Docker', type: 'Peripheral' }
                    ],
                    keySkills: ['Full Stack Development', 'Agile Workflow', 'Code Review', 'RESTful APIs', 'Testing'],
                    competencies: ['Software Engineering', 'Team Collaboration', 'Problem Solving', 'Communication'],
                    projectTypes: ['Feature Development', 'Bug Fixes', 'Code Refactoring'],
                    internalStakeholders: ['Engineering Manager', 'Senior Developers', 'Product Manager'],
                    externalStakeholders: ['End Users'],
                    achievements: [
                        'Shipped 5 new features to production',
                        'Received full-time job offer upon graduation',
                        'Reduced page load time by 40% through optimization'
                    ]
                },
                {
                    organizationName: 'University IT Department',
                    role: 'Student Web Developer',
                    location: 'Austin, TX',
                    startDate: '2022-01',
                    endDate: '2024-05',
                    description: 'Part-time web development position maintaining university websites. Updated content, fixed issues, and built new pages for campus departments.',
                    technologies: [
                        { name: 'HTML/CSS', type: 'Core' },
                        { name: 'JavaScript', type: 'Core' },
                        { name: 'WordPress', type: 'Core' },
                        { name: 'PHP', type: 'Peripheral' }
                    ],
                    keySkills: ['Web Development', 'Content Management', 'Responsive Design', 'Customer Service', 'Time Management'],
                    competencies: ['Web Design', 'Technical Support', 'Project Management', 'Stakeholder Communication'],
                    projectTypes: ['Website Maintenance', 'New Site Development', 'Accessibility Compliance'],
                    internalStakeholders: ['IT Manager', 'Campus Departments', 'Web Team'],
                    externalStakeholders: ['Students', 'Faculty', 'Website Visitors'],
                    achievements: [
                        'Maintained 20+ department websites',
                        'Improved accessibility compliance across all sites',
                        'Balanced work with full-time coursework (20 hours/week)'
                    ]
                }
            ],
            'data-analyst': [
                {
                    organizationName: 'FinServe Corp',
                    role: 'Business Intelligence Analyst',
                    location: 'Chicago, IL',
                    startDate: '2021-01',
                    endDate: null,
                    description: 'Analyze business data to drive strategic decisions. Build dashboards, perform statistical analysis, and present insights to leadership.',
                    technologies: [
                        { name: 'SQL', type: 'Core' },
                        { name: 'Python', type: 'Core' },
                        { name: 'Tableau', type: 'Core' },
                        { name: 'Power BI', type: 'Peripheral' },
                        { name: 'Excel', type: 'Core' },
                        { name: 'R', type: 'Peripheral' }
                    ],
                    keySkills: ['Data Analysis', 'Data Visualization', 'Statistical Modeling', 'Business Intelligence', 'Stakeholder Communication'],
                    competencies: ['Business Analytics', 'Strategic Planning', 'Data Storytelling', 'Process Improvement'],
                    projectTypes: ['Dashboard Development', 'Predictive Analytics', 'Business Reporting'],
                    internalStakeholders: ['Finance Team', 'Executive Leadership', 'Product Managers'],
                    externalStakeholders: ['External Auditors', 'Business Partners'],
                    achievements: [
                        'Built executive dashboard used by C-suite for strategic decisions',
                        'Identified $2M in cost savings through data analysis',
                        'Reduced reporting time by 60% through automation'
                    ]
                },
                {
                    organizationName: 'RetailCo Analytics',
                    role: 'Data Analyst',
                    location: 'Minneapolis, MN',
                    startDate: '2019-06',
                    endDate: '2020-12',
                    description: 'Analyzed retail sales data to identify trends and opportunities. Created reports for merchandising teams and supported inventory optimization initiatives.',
                    technologies: [
                        { name: 'SQL', type: 'Core' },
                        { name: 'Excel', type: 'Core' },
                        { name: 'Tableau', type: 'Core' },
                        { name: 'Python', type: 'Peripheral' }
                    ],
                    keySkills: ['SQL Queries', 'Data Visualization', 'Report Building', 'Trend Analysis', 'Excel Modeling'],
                    competencies: ['Retail Analytics', 'Business Reporting', 'Data Quality', 'Stakeholder Collaboration'],
                    projectTypes: ['Sales Analysis', 'Inventory Reporting', 'Trend Forecasting'],
                    internalStakeholders: ['Merchandising Team', 'Store Operations', 'Marketing'],
                    externalStakeholders: ['Vendor Partners'],
                    achievements: [
                        'Created automated weekly sales dashboard saving 10 hours/week',
                        'Identified underperforming products leading to $500K savings',
                        'Supported successful launch of 3 new product categories'
                    ]
                },
                {
                    organizationName: 'State University',
                    role: 'Business Analytics Student',
                    location: 'Chicago, IL',
                    startDate: '2017-08',
                    endDate: '2019-05',
                    description: 'Completed Master of Science in Business Analytics. Coursework in statistics, machine learning, data visualization, and business strategy.',
                    technologies: [
                        { name: 'R', type: 'Core' },
                        { name: 'Python', type: 'Core' },
                        { name: 'SQL', type: 'Core' },
                        { name: 'Tableau', type: 'Core' },
                        { name: 'SAS', type: 'Peripheral' }
                    ],
                    keySkills: ['Statistical Analysis', 'Machine Learning', 'Data Mining', 'Predictive Modeling', 'Data Visualization'],
                    competencies: ['Quantitative Analysis', 'Research Methods', 'Business Intelligence', 'Technical Communication'],
                    projectTypes: ['Capstone Projects', 'Case Studies', 'Group Projects'],
                    internalStakeholders: ['Faculty Advisors', 'Project Teams', 'Career Services'],
                    externalStakeholders: ['Industry Partners', 'Guest Speakers'],
                    achievements: [
                        'Graduated with 3.9 GPA',
                        'Won 2nd place in analytics case competition',
                        'Completed capstone project for Fortune 500 company'
                    ]
                }
            ]
        };

        function loadUserExperiences() {
            const stored = localStorage.getItem('careerExperiences_' + currentPersona);
            if (stored) {
                try {
                    userExperiences = JSON.parse(stored);
                } catch (e) {
                    userExperiences = [];
                }
            } else {
                userExperiences = [];
            }
        }

        function saveUserExperiences() {
            localStorage.setItem('careerExperiences_' + currentPersona, JSON.stringify(userExperiences));
        }

        function openCareerExperienceSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');
            const careerExperienceContent = document.getElementById('careerExperienceContent');

            titleEl.textContent = 'Career Experience';

            // Hide all content sections
            hideAllContentSections();

            // Show career experience content
            careerExperienceContent.style.display = 'flex';

            loadCareerExperiences();
            slideout.classList.add('active');
        }

        function loadCareerExperiences() {
            const container = document.getElementById('experiencesContainer');
            container.innerHTML = '';

            loadUserExperiences();

            // Combine user experiences with example experiences
            const allExperiences = [...userExperiences];

            // Add example experiences for current persona
            const personaExamples = exampleExperiences[currentPersona] || [];
            personaExamples.forEach(exp => {
                allExperiences.push({ ...exp, isExample: true });
            });

            // Sort experiences by start date (most recent first)
            const sortedExperiences = [...allExperiences].sort((a, b) => {
                const dateA = a.startDate || '0000-00-00';
                const dateB = b.startDate || '0000-00-00';
                return dateB.localeCompare(dateA);
            });

            if (sortedExperiences.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-briefcase" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No career experiences yet. Click "Add Experience" to track your work history.</p>
                    </div>
                `;
                return;
            }

            // Display all experiences
            sortedExperiences.forEach((exp, index) => {
                const originalIndex = userExperiences.indexOf(exp);
                const isUserExperience = !exp.isExample;
                const startDate = exp.startDate ? new Date(exp.startDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short' }) : '';
                const endDate = exp.endDate ? new Date(exp.endDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short' }) : 'Present';

                const card = document.createElement('div');
                card.className = 'experience-card';

                // Style example experiences differently
                if (exp.isExample) {
                    card.style.borderLeft = '4px solid #e3f2fd';
                    card.style.background = '#fafbfc';
                }

                card.innerHTML = `
                    <div class="experience-card-header">
                        <div style="flex: 1;">
                            <div class="exp-title">${escapeHtml(exp.role)}${exp.isExample ? ' <span class="competency-tag" style="margin-left: 6px;">Example</span>' : ''}</div>
                            <div class="exp-company">${escapeHtml(exp.organizationName)}${exp.location ? ' • ' + escapeHtml(exp.location) : ''}</div>
                            <div class="exp-dates">${startDate} - ${endDate}</div>
                        </div>
                        ${isUserExperience ? `
                        <div class="story-actions">
                            <button class="story-action-btn" onclick="editExperienceRecord(${originalIndex})" title="Edit">
                                <i class="ph ph-pencil-simple"></i>
                            </button>
                            <button class="story-action-btn delete" onclick="deleteExperienceRecord(${originalIndex})" title="Delete">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                    ${exp.description ? `<div class="exp-description">${escapeHtml(exp.description)}</div>` : ''}
                    ${exp.technologies && exp.technologies.length > 0 ? `
                        <div class="exp-section">
                            <div class="exp-section-label">Technologies</div>
                            <div class="exp-tags">
                                ${exp.technologies.map(tech => `<span class="exp-tag ${tech.type ? tech.type.toLowerCase() : ''}">${escapeHtml(tech.name || tech)}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${exp.keySkills && exp.keySkills.length > 0 ? `
                        <div class="exp-section">
                            <div class="exp-section-label">Key Skills</div>
                            <div class="exp-tags">
                                ${exp.keySkills.map(skill => `<span class="exp-tag">${escapeHtml(skill)}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${exp.competencies && exp.competencies.length > 0 ? `
                        <div class="exp-section">
                            <div class="exp-section-label">Competencies</div>
                            <div class="exp-tags">
                                ${exp.competencies.map(comp => `<span class="exp-tag">${escapeHtml(comp)}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${exp.achievements && exp.achievements.length > 0 ? `
                        <div class="exp-section">
                            <div class="exp-section-label">Achievements</div>
                            <ul class="exp-list">
                                ${exp.achievements.map(achievement => `<li>${escapeHtml(achievement)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
        }

        function addExperienceRecord() {
            alert('Add Experience feature coming soon!');
        }

        function editExperienceRecord(index) {
            alert('Edit Experience feature coming soon!');
        }

        function deleteExperienceRecord(index) {
            if (confirm('Are you sure you want to delete this experience?')) {
                userExperiences.splice(index, 1);
                saveUserExperiences();
                loadCareerExperiences();
                updateNodeCounts();
            }
        }

        function connectLinkedIn() {
            alert('LinkedIn integration coming soon! This will allow you to import your work experience directly from your LinkedIn profile.');
        }

        function uploadResume() {
            alert('Resume upload coming soon! This will parse your resume and automatically extract your work experience, skills, and achievements.');
        }

        // Application Materials Management
        let userApplicationMaterials = [];
        let editingMaterialIndex = -1;

        // Example application materials for each persona
        const exampleApplicationMaterials = {
            'retail-manager': [
                {
                    type: 'Resume',
                    title: 'Cloud Operations Resume',
                    jobOpportunity: 'Cloud Operations Engineer - TechCorp',
                    content: 'Experienced retail operations manager with 5+ years managing store operations, inventory systems, and teams of 15-30 employees. Strong background in data analysis using Excel and Power BI. Seeking to transition technical operations and cloud infrastructure management skills.',
                    format: 'PDF',
                    atsOptimized: true,
                    createdDate: '2024-09-15',
                    isExample: true
                },
                {
                    type: 'Cover Letter',
                    title: 'Cloud Operations Cover Letter',
                    jobOpportunity: 'Cloud Operations Engineer - TechCorp',
                    content: 'Dear Hiring Manager,\n\nI am writing to express my strong interest in the Cloud Operations Engineer position at TechCorp. While my professional background is in retail management, I have developed a strong foundation in technical operations, data analysis, and system optimization that directly translates to cloud operations.\n\nIn my role as Store Manager at RetailMart, I successfully managed complex operational systems including POS infrastructure, inventory management systems, and business analytics platforms. I taught myself Excel, Power BI, and basic SQL to build automated reporting dashboards that reduced manual reporting time by 90% and improved inventory accuracy from 83% to 94%.\n\nMy experience managing 24/7 retail operations has given me deep expertise in incident response, system monitoring, and maintaining high availability - all critical skills for cloud operations. I\'m comfortable working under pressure during peak periods and have consistently maintained 99.5%+ system uptime even during our busiest seasons.\n\nI am currently completing AWS Cloud Practitioner and Solutions Architect Associate certifications to formalize my cloud knowledge. I\'m excited about the opportunity to bring my operational excellence, problem-solving skills, and commitment to reliability to TechCorp\'s cloud infrastructure team.\n\nThank you for considering my application.\n\nSincerely,\n[Your Name]',
                    format: 'DOCX',
                    atsOptimized: true,
                    createdDate: '2024-09-15',
                    isExample: true
                },
                {
                    type: 'Email',
                    title: 'Networking Email to TechCorp Cloud Engineer',
                    jobOpportunity: 'Cloud Operations Engineer - TechCorp',
                    content: 'Subject: Retail Manager → Cloud Operations: Seeking Advice\n\nHi [Name],\n\nI found your profile while researching Cloud Operations Engineers at TechCorp and was impressed by your career path. I\'m currently a Store Manager at RetailMart looking to transition into cloud operations, and I\'d love to learn from your experience.\n\nI\'ve been managing 24/7 retail operations for 5 years, including POS systems, inventory management, and analytics platforms. I\'ve taught myself data analysis (Excel, Power BI, SQL) and am currently studying for AWS certifications. I believe my operational experience and technical aptitude would translate well to cloud operations.\n\nWould you be open to a brief 15-minute call to share your insights on making a similar transition? I\'d love to hear about the skills that matter most in your role and any advice you have for someone with my background.\n\nI understand you\'re busy - even a few sentences via email would be incredibly helpful!\n\nThank you for considering,\n[Your Name]',
                    format: 'HTML',
                    atsOptimized: false,
                    createdDate: '2024-09-16',
                    isExample: true
                }
            ],
            'chemist': [
                {
                    type: 'Resume',
                    title: 'Cloud Computing Resume',
                    jobOpportunity: 'Cloud Solutions Architect - CloudVendor',
                    content: 'Senior Chemist with 4+ years pharmaceutical R&D experience and strong computational background. Extensive experience with scientific computing, data analysis (Python, R), and laboratory automation systems. Seeking to apply analytical rigor and technical expertise to cloud architecture and solutions design.',
                    format: 'PDF',
                    atsOptimized: true,
                    createdDate: '2024-09-12',
                    isExample: true
                },
                {
                    type: 'Cover Letter',
                    title: 'Cloud Architect Cover Letter',
                    jobOpportunity: 'Cloud Solutions Architect - CloudVendor',
                    content: 'Dear Hiring Manager,\n\nI am excited to apply for the Cloud Solutions Architect position at CloudVendor. As a Senior Chemist with extensive experience in computational chemistry and scientific data analysis, I bring a unique combination of analytical thinking, technical depth, and problem-solving skills that translate directly to cloud architecture.\n\nIn my current role at PharmaCorp, I regularly work with large-scale computational workflows processing terabytes of experimental data. I\'ve designed and optimized data pipelines using Python and R, integrated multiple scientific software platforms, and troubleshot complex system performance issues - experiences that mirror the challenges cloud architects face when designing scalable solutions.\n\nMy work has required me to deeply understand distributed computing concepts, resource optimization, and system reliability. When our lab needed to process 10x more molecular simulations for a critical drug discovery project, I architected a workflow that reduced processing time from 3 weeks to 4 days by optimizing parallelization and resource allocation.\n\nI\'ve been systematically building cloud expertise through AWS Solutions Architect certification coursework and hands-on personal projects deploying containerized applications, implementing CI/CD pipelines, and designing multi-tier architectures on AWS.\n\nI\'m eager to bring my analytical rigor, systems thinking, and technical aptitude to help CloudVendor\'s customers design robust, scalable cloud solutions.\n\nThank you for your consideration.\n\nBest regards,\n[Your Name]',
                    format: 'DOCX',
                    atsOptimized: true,
                    createdDate: '2024-09-12',
                    isExample: true
                },
                {
                    type: 'Email',
                    title: 'Cold Outreach to CloudVendor Recruiter',
                    jobOpportunity: 'Cloud Solutions Architect - CloudVendor',
                    content: 'Subject: PhD Chemist → Cloud Solutions Architect: Non-Traditional Background\n\nHi [Recruiter Name],\n\nI\'m reaching out regarding the Cloud Solutions Architect role at CloudVendor (Job #12345). I know my resume shows "Senior Chemist" rather than traditional cloud experience, but I believe my technical background positions me uniquely well for this role.\n\nIn pharmaceutical R&D, I\'ve spent 4+ years designing computational workflows for large-scale data analysis, optimizing distributed computing systems, and troubleshooting complex multi-system integrations - skills that map directly to cloud architecture challenges. I\'m proficient in Python, Linux, Git, and containerization, and I\'m completing my AWS Solutions Architect Associate certification.\n\nI\'ve successfully delivered multiple projects requiring systems thinking and technical depth:\n- Architected data pipeline processing 2TB+ datasets, reducing compute time 75%\n- Integrated 5+ scientific software platforms with automated workflows\n- Led cross-functional teams through technical troubleshooting and optimization\n\nI understand this is a non-traditional background, but I\'m confident my analytical rigor, technical aptitude, and problem-solving approach would bring value to CloudVendor\'s solutions architecture team. Would you be open to a brief conversation to discuss how my experience translates to cloud architecture?\n\nI\'ve attached my resume highlighting the technical parallels. Thank you for considering a candidate with a different path into tech!\n\nBest,\n[Your Name]',
                    format: 'TXT',
                    atsOptimized: false,
                    createdDate: '2024-09-13',
                    isExample: true
                }
            ],
            'new-graduate': [
                {
                    type: 'Resume',
                    title: 'Full Stack Developer Resume',
                    jobOpportunity: 'Junior Full Stack Developer - StartupCo',
                    content: 'Recent Computer Science graduate with strong full-stack development skills and 3 internship experiences. Proficient in React, Node.js, Python, and cloud platforms. Built 5+ personal projects including e-commerce platform and social media dashboard. Seeking entry-level full stack role to apply technical skills and continue learning.',
                    format: 'PDF',
                    atsOptimized: true,
                    createdDate: '2024-09-20',
                    isExample: true
                },
                {
                    type: 'Cover Letter',
                    title: 'Junior Developer Cover Letter',
                    jobOpportunity: 'Junior Full Stack Developer - StartupCo',
                    content: 'Dear Hiring Manager,\n\nI am excited to apply for the Junior Full Stack Developer position at StartupCo. As a recent Computer Science graduate with internship experience and a portfolio of personal projects, I am eager to contribute to your engineering team while continuing to grow my technical skills.\n\nDuring my Software Engineering Internship at TechStart Inc., I contributed to a React-based customer portal serving 10,000+ users. I implemented responsive UI components, integrated RESTful APIs, and wrote comprehensive test suites - resulting in a 20% reduction in reported bugs. This experience taught me the importance of code quality, user-centric design, and collaborative development.\n\nBeyond coursework and internships, I\'ve built several full-stack projects to deepen my skills:\n- E-commerce platform with React frontend, Node.js backend, and PostgreSQL database\n- Real-time chat application using WebSockets and Redis\n- Personal portfolio website with blog CMS (Next.js, Tailwind CSS)\n\nI\'m particularly drawn to StartupCo\'s mission to [mission] and your tech stack. I\'m proficient in React, Node.js, Python, and PostgreSQL, and I\'m comfortable learning new technologies quickly. I\'m excited about the opportunity to work on challenging problems, learn from experienced engineers, and contribute to meaningful products.\n\nThank you for considering my application. I look forward to the opportunity to discuss how I can contribute to StartupCo\'s success.\n\nBest regards,\n[Your Name]',
                    format: 'DOCX',
                    atsOptimized: true,
                    createdDate: '2024-09-20',
                    isExample: true
                },
                {
                    type: 'Email',
                    title: 'Follow-up After Career Fair',
                    jobOpportunity: 'Junior Full Stack Developer - StartupCo',
                    content: 'Subject: Following Up - CS Grad Interested in Junior Full Stack Role\n\nHi [Recruiter Name],\n\nIt was great meeting you at the Tech Career Fair yesterday! I enjoyed learning about StartupCo\'s product roadmap and engineering culture. Your comments about prioritizing code quality and mentorship really resonated with me.\n\nAs mentioned, I\'m a recent CS graduate actively seeking junior full stack roles. I have:\n- 3 internships (including 6-month SWE internship at TechStart Inc.)\n- Strong skills in React, Node.js, Python, PostgreSQL\n- Portfolio of 5+ personal projects demonstrating full-stack capabilities\n- Genuine excitement about building user-focused products\n\nI\'ve attached my resume and would love to continue the conversation about how I could contribute to your team. I\'m particularly interested in the Junior Full Stack Developer role I saw posted on your careers page.\n\nWould you be open to scheduling a brief call next week to discuss the role and answer any questions about my background?\n\nThank you again for your time at the fair!\n\nBest,\n[Your Name]\n\nPortfolio: [URL]\nGitHub: [URL]\nLinkedIn: [URL]',
                    format: 'HTML',
                    atsOptimized: false,
                    createdDate: '2024-09-21',
                    isExample: true
                }
            ],
            'data-analyst': [
                {
                    type: 'Resume',
                    title: 'Data Analyst Resume',
                    jobOpportunity: 'Senior Data Analyst - DataCorp',
                    content: 'Data Analyst with 3+ years experience in business intelligence, data visualization, and analytics. Proficient in SQL, Python, Tableau, and Power BI. Track record of delivering actionable insights that drove business decisions and revenue growth. Seeking senior analyst role to tackle complex analytical challenges.',
                    format: 'PDF',
                    atsOptimized: true,
                    createdDate: '2024-09-18',
                    isExample: true
                },
                {
                    type: 'Cover Letter',
                    title: 'Senior Analyst Cover Letter',
                    jobOpportunity: 'Senior Data Analyst - DataCorp',
                    content: 'Dear Hiring Manager,\n\nI am writing to express my strong interest in the Senior Data Analyst position at DataCorp. With over 3 years of experience delivering business-critical analytics and a proven track record of turning data into actionable insights, I am excited about the opportunity to contribute to your data team.\n\nIn my current role as BI Analyst at TechCorp, I\'ve consistently delivered high-impact analytical projects:\n- Built customer churn prediction model (78% accuracy) that reduced churn from 8% to 5.5%, saving $200K ARR\n- Automated executive reporting pipeline, reducing manual effort from 20 hours to 30 minutes monthly\n- Designed self-service analytics dashboards that democratized data access for 100+ employees\n- Collaborated cross-functionally with Product, Sales, and Customer Success to drive data-informed decisions\n\nI\'m proficient in the full analytics stack: SQL for data extraction and transformation, Python (pandas, scikit-learn) for advanced analysis and modeling, and Tableau/Power BI for visualization and storytelling. More importantly, I understand that great analysis requires both technical skills and business acumen - the ability to ask the right questions, identify meaningful patterns, and communicate insights effectively to non-technical stakeholders.\n\nI\'m particularly excited about DataCorp\'s focus on [specific aspect] and the opportunity to work with [specific technologies/data]. I\'m confident my analytical skills, business mindset, and collaborative approach would make me a strong addition to your team.\n\nThank you for considering my application. I look forward to discussing how I can contribute to DataCorp\'s success.\n\nBest regards,\n[Your Name]',
                    format: 'DOCX',
                    atsOptimized: true,
                    createdDate: '2024-09-18',
                    isExample: true
                },
                {
                    type: 'Email',
                    title: 'Referral Request from Former Colleague',
                    jobOpportunity: 'Senior Data Analyst - DataCorp',
                    content: 'Subject: Quick Favor - DataCorp Senior Analyst Referral?\n\nHey [Former Colleague],\n\nI hope you\'re doing well at DataCorp! I saw you\'ve been there about 6 months now - how are you liking it?\n\nI\'m reaching out because I\'m actively looking for my next role, and I noticed DataCorp has a Senior Data Analyst position open that looks like a great fit for my background. Given that we worked together at TechCorp and you know my analytical skills firsthand, I was hoping you might be willing to refer me?\n\nQuick reminder of what I bring to the table:\n- 3+ years BI/analytics experience\n- Strong SQL, Python, Tableau skills\n- Track record of high-impact projects (churn model, reporting automation, etc.)\n- Collaborative cross-functional approach\n\nI know referrals can be a big ask, so totally understand if the timing isn\'t right. But if you\'d be comfortable putting in a good word, I\'d really appreciate it! I\'ve attached my resume if that helps.\n\nEither way, would love to catch up sometime - it\'s been too long!\n\nThanks for considering,\n[Your Name]',
                    format: 'TXT',
                    atsOptimized: false,
                    createdDate: '2024-09-19',
                    isExample: true
                }
            ]
        };

        function loadUserApplicationMaterials() {
            const stored = localStorage.getItem(`applicationMaterials_${currentPersona}`);
            userApplicationMaterials = stored ? JSON.parse(stored) : [];
        }

        function saveUserApplicationMaterials() {
            localStorage.setItem(`applicationMaterials_${currentPersona}`, JSON.stringify(userApplicationMaterials));
        }

        function openApplicationMaterialsSlideout() {
            loadUserApplicationMaterials();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');
            const applicationMaterialsContent = document.getElementById('applicationMaterialsContent');

            titleEl.textContent = 'Application Materials';

            // Hide all content sections
            hideAllContentSections();

            // Show application materials content
            applicationMaterialsContent.style.display = 'flex';
            loadApplicationMaterials();

            slideout.classList.add('active');
        }

        function loadApplicationMaterials() {
            const container = document.getElementById('materialsContainer');
            const exampleMaterials = exampleApplicationMaterials[currentPersona] || [];
            const allMaterials = [...userApplicationMaterials, ...exampleMaterials];

            if (allMaterials.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px 20px;">No application materials yet. Click Generate or Upload to add materials.</p>';
                return;
            }

            container.innerHTML = allMaterials.map((material, index) => {
                const isUserMaterial = index < userApplicationMaterials.length;
                const typeColors = {
                    'Resume': '#0066CC',
                    'Cover Letter': '#004C99',
                    'Email': '#1a1a1a'
                };
                const typeColor = typeColors[material.type] || '#666';

                return `
                    <div class="story-card" style="opacity: ${material.isExample ? '0.7' : '1'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                    <span style="background: ${typeColor}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap;">
                                        ${material.type}
                                    </span>
                                    <span style="background: #f5f5f7; color: #666; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">
                                        ${material.format}
                                    </span>
                                    ${material.atsOptimized ? '<span style="background: #e3f2fd; color: #0066CC; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">ATS Optimized</span>' : ''}
                                    ${material.isExample ? '<span style="background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">Example</span>' : ''}
                                </div>
                                <h4 style="margin: 0 0 4px 0; color: #1a1a1a; font-size: 15px; font-weight: 600;">${material.title}</h4>
                                ${material.jobOpportunity ? `<p style="margin: 0 0 8px 0; color: #666; font-size: 12px;">For: ${material.jobOpportunity}</p>` : ''}
                                <p style="margin: 0; color: #999; font-size: 11px;">Created: ${material.createdDate}</p>
                            </div>
                            ${isUserMaterial ? `
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="downloadMaterial(${index})" style="padding: 6px 10px; background: #f5f5f7; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #666; font-weight: 600;">
                                        <i class="ph ph-download-simple"></i> Download
                                    </button>
                                    <button onclick="deleteMaterial(${index})" style="padding: 6px 10px; background: #fee; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #c33; font-weight: 600;">
                                        <i class="ph ph-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e5e7;">
                            <p style="margin: 0; color: #666; font-size: 13px; line-height: 1.5; max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                ${material.content.substring(0, 200)}${material.content.length > 200 ? '...' : ''}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateMaterial() {
            // Create modal for generation options
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

            const jobOpps = exampleJobOpportunities[currentPersona] || [];
            const jobOptions = jobOpps.map((job, i) => `<option value="${i}">${job.title} - ${job.company}</option>`).join('');

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; font-family: Questrial, sans-serif; color: #1a1a1a;">Generate Application Material</h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #333;">Material Type</label>
                        <select id="materialType" style="width: 100%; padding: 10px; border: 1px solid #e5e5e7; border-radius: 4px; font-family: Barlow, sans-serif; font-size: 14px;">
                            <option value="Resume">Resume</option>
                            <option value="Cover Letter">Cover Letter</option>
                            <option value="Email">Email</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #333;">Job Opportunity</label>
                        <select id="jobOpportunity" style="width: 100%; padding: 10px; border: 1px solid #e5e5e7; border-radius: 4px; font-family: Barlow, sans-serif; font-size: 14px;">
                            <option value="">Select a job opportunity...</option>
                            ${jobOptions}
                        </select>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #333;">Output Format</label>
                        <select id="outputFormat" style="width: 100%; padding: 10px; border: 1px solid #e5e5e7; border-radius: 4px; font-family: Barlow, sans-serif; font-size: 14px;">
                            <option value="PDF">PDF</option>
                            <option value="DOCX">DOCX (Word)</option>
                            <option value="HTML">HTML</option>
                            <option value="MD">Markdown</option>
                            <option value="TXT">Plain Text</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="atsOptimized" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 13px; font-weight: 600; color: #333;">ATS Optimized (Applicant Tracking System)</span>
                        </label>
                        <p style="margin: 4px 0 0 26px; font-size: 12px; color: #666;">Formats the document for better parsing by automated hiring systems</p>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="padding: 10px 20px; background: #f5f5f7; border: none; border-radius: 6px; cursor: pointer; font-family: Questrial, sans-serif; font-size: 14px; font-weight: 600; color: #666;">
                            Cancel
                        </button>
                        <button onclick="executeGenerate(this)" style="padding: 10px 20px; background: #0066CC; border: none; border-radius: 6px; cursor: pointer; font-family: Questrial, sans-serif; font-size: 14px; font-weight: 600; color: white;">
                            <i class="ph ph-sparkle"></i> Generate
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function executeGenerate(button) {
            const modal = button.closest('div[style*="position: fixed"]');
            const materialType = document.getElementById('materialType').value;
            const jobOppIndex = document.getElementById('jobOpportunity').value;
            const outputFormat = document.getElementById('outputFormat').value;
            const atsOptimized = document.getElementById('atsOptimized').checked;

            if (!jobOppIndex) {
                alert('Please select a job opportunity');
                return;
            }

            const jobOpps = exampleJobOpportunities[currentPersona] || [];
            const selectedJob = jobOpps[jobOppIndex];
            const jobTitle = `${selectedJob.title} - ${selectedJob.company}`;

            // Simulate generation (in real implementation, this would call an API)
            const newMaterial = {
                type: materialType,
                title: `${materialType} for ${selectedJob.company}`,
                jobOpportunity: jobTitle,
                content: `Generated ${materialType.toLowerCase()} for ${jobTitle}. This would contain the actual generated content based on your career experience and the job requirements.`,
                format: outputFormat,
                atsOptimized: atsOptimized,
                createdDate: new Date().toISOString().split('T')[0],
                isExample: false
            };

            userApplicationMaterials.push(newMaterial);
            saveUserApplicationMaterials();
            loadApplicationMaterials();
            updateNodeCounts();
            modal.remove();

            alert(`${materialType} generated successfully! In a full implementation, this would use AI to generate a customized ${materialType.toLowerCase()} based on your experience and the job requirements.`);
        }

        function uploadMaterial() {
            alert('Upload functionality coming soon! This will allow you to upload existing resumes, cover letters, and other application materials in various formats (PDF, DOCX, TXT, etc.).');
        }

        function downloadMaterial(index) {
            const material = userApplicationMaterials[index];
            alert(`Download ${material.title} as ${material.format}\n\nIn a full implementation, this would download the material in the selected format.`);
        }

        function deleteMaterial(index) {
            if (confirm('Are you sure you want to delete this application material?')) {
                userApplicationMaterials.splice(index, 1);
                saveUserApplicationMaterials();
                loadApplicationMaterials();
                updateNodeCounts();
            }
        }

        // Portfolio Management
        let userPortfolioProjects = [];

        // Example portfolio projects for each persona
        const examplePortfolioProjects = {
            'retail-manager': [
                {
                    title: 'Power BI Sales Dashboard',
                    description: 'Interactive sales analytics dashboard tracking KPIs across 15 retail locations. Includes YoY comparisons, inventory turnover analysis, and predictive sales forecasting.',
                    technologies: ['Power BI', 'Excel', 'SQL'],
                    url: null,
                    imageUrl: null,
                    completedDate: '2023-11',
                    highlights: [
                        'Reduced reporting time from 4 hours to 15 minutes',
                        'Identified $45K in inventory optimization opportunities',
                        'Adopted by 12 stores in district'
                    ],
                    isExample: true
                },
                {
                    title: 'Staff Scheduling Model (Excel VBA)',
                    description: 'Automated employee scheduling system using Excel VBA and optimization algorithms. Considers availability, labor laws, peak traffic patterns, and employee preferences.',
                    technologies: ['Excel VBA', 'Optimization Algorithms'],
                    url: null,
                    imageUrl: null,
                    completedDate: '2023-06',
                    highlights: [
                        'Reduced scheduling time from 3 hours to 30 minutes weekly',
                        'Improved schedule fairness scores by 40%',
                        'Decreased overtime costs by 15%'
                    ],
                    isExample: true
                }
            ],
            'chemist': [
                {
                    title: 'Molecular Simulation Pipeline (Python)',
                    description: 'Automated computational chemistry workflow for high-throughput molecular dynamics simulations. Processes 100+ compounds in parallel using AWS batch computing.',
                    technologies: ['Python', 'AWS', 'Docker', 'RDKit', 'PyMOL'],
                    url: 'https://github.com/username/molecular-sim-pipeline',
                    imageUrl: null,
                    completedDate: '2024-01',
                    highlights: [
                        'Reduced simulation time from 3 weeks to 4 days',
                        'Processed 2TB+ of molecular data',
                        'Published methodology in Journal of Computational Chemistry'
                    ],
                    isExample: true
                },
                {
                    title: 'HPLC Data Analysis Dashboard',
                    description: 'R Shiny web application for analyzing HPLC chromatography data with automated peak detection, integration, and statistical analysis.',
                    technologies: ['R', 'Shiny', 'ggplot2', 'Machine Learning'],
                    url: 'https://github.com/username/hplc-analysis',
                    imageUrl: null,
                    completedDate: '2023-09',
                    highlights: [
                        'Automated analysis of 500+ chromatograms monthly',
                        '95% accuracy in automated peak detection',
                        'Used by 8 chemists in R&D department'
                    ],
                    isExample: true
                }
            ],
            'new-graduate': [
                {
                    title: 'E-Commerce Platform (MERN Stack)',
                    description: 'Full-stack e-commerce application with product catalog, shopping cart, user authentication, payment processing (Stripe), and admin dashboard.',
                    technologies: ['React', 'Node.js', 'Express', 'MongoDB', 'Stripe API'],
                    url: 'https://github.com/username/ecommerce-platform',
                    imageUrl: null,
                    completedDate: '2024-03',
                    highlights: [
                        'Built responsive UI with React and Tailwind CSS',
                        'Implemented JWT authentication and role-based access',
                        'Integrated Stripe payment processing',
                        '95% test coverage with Jest'
                    ],
                    isExample: true
                },
                {
                    title: 'Real-Time Chat Application',
                    description: 'WebSocket-based chat app with real-time messaging, user presence detection, typing indicators, and message history stored in Redis.',
                    technologies: ['React', 'Socket.io', 'Node.js', 'Redis', 'Docker'],
                    url: 'https://github.com/username/realtime-chat',
                    imageUrl: null,
                    completedDate: '2024-01',
                    highlights: [
                        'Handles 100+ concurrent connections',
                        'Sub-100ms message latency',
                        'Deployed on AWS with Docker and CI/CD pipeline'
                    ],
                    isExample: true
                }
            ],
            'data-analyst': [
                {
                    title: 'Customer Churn Prediction Model',
                    description: 'Machine learning model predicting customer churn 30 days in advance with 78% accuracy. Built using Python scikit-learn with feature engineering from behavioral data.',
                    technologies: ['Python', 'scikit-learn', 'pandas', 'Power BI'],
                    url: 'https://github.com/username/churn-prediction',
                    imageUrl: null,
                    completedDate: '2023-12',
                    highlights: [
                        '78% prediction accuracy (vs 65% baseline)',
                        'Reduced churn from 8% to 5.5%',
                        'Saved $200K in annual recurring revenue',
                        'Deployed as automated daily scoring pipeline'
                    ],
                    isExample: true
                },
                {
                    title: 'Automated Reporting Pipeline',
                    description: 'Python-based ETL pipeline that extracts data from warehouse, performs calculations, generates charts, and exports formatted Excel reports on schedule.',
                    technologies: ['Python', 'pandas', 'SQL', 'matplotlib', 'Apache Airflow'],
                    url: 'https://github.com/username/reporting-automation',
                    imageUrl: null,
                    completedDate: '2023-08',
                    highlights: [
                        'Reduced manual reporting time from 20 hours to 30 minutes monthly',
                        'Eliminated ~95% of human errors',
                        'Automated 3 additional reports after initial success',
                        'Saved 230+ hours annually'
                    ],
                    isExample: true
                }
            ]
        };

        function loadUserPortfolioProjects() {
            const stored = localStorage.getItem(`portfolioProjects_${currentPersona}`);
            userPortfolioProjects = stored ? JSON.parse(stored) : [];
        }

        function saveUserPortfolioProjects() {
            localStorage.setItem(`portfolioProjects_${currentPersona}`, JSON.stringify(userPortfolioProjects));
        }

        function openPortfolioSlideout() {
            loadUserPortfolioProjects();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');
            const portfolioContent = document.getElementById('portfolioContent');

            titleEl.textContent = 'Portfolio Projects';

            // Hide all content sections
            hideAllContentSections();

            // Show portfolio content
            portfolioContent.style.display = 'flex';
            loadPortfolioProjects();

            slideout.classList.add('active');
        }

        function loadPortfolioProjects() {
            const container = document.getElementById('portfolioContainer');
            const exampleProjects = examplePortfolioProjects[currentPersona] || [];
            const allProjects = [...userPortfolioProjects, ...exampleProjects];

            if (allProjects.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px 20px;">No portfolio projects yet. Click Add Project or Import from GitHub to showcase your work.</p>';
                return;
            }

            container.innerHTML = allProjects.map((project, index) => {
                const isUserProject = index < userPortfolioProjects.length;

                return `
                    <div class="story-card" style="opacity: ${project.isExample ? '0.7' : '1'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                    ${project.isExample ? '<span style="background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">Example</span>' : ''}
                                    <span style="background: #f5f5f7; color: #666; padding: 4px 10px; border-radius: 4px; font-size: 11px;">
                                        ${project.completedDate}
                                    </span>
                                </div>
                                <h4 style="margin: 0 0 8px 0; color: #1a1a1a; font-size: 16px; font-weight: 600;">${project.title}</h4>
                                <p style="margin: 0 0 12px 0; color: #666; font-size: 13px; line-height: 1.5;">
                                    ${project.description}
                                </p>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
                                    ${project.technologies.map(tech => `
                                        <span style="background: #e3f2fd; color: #0066CC; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                            ${tech}
                                        </span>
                                    `).join('')}
                                </div>
                                ${project.highlights && project.highlights.length > 0 ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e5e7;">
                                        <strong style="font-size: 12px; color: #333; display: block; margin-bottom: 6px;">Key Achievements:</strong>
                                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #666; line-height: 1.6;">
                                            ${project.highlights.map(highlight => `<li>${highlight}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                            ${isUserProject ? `
                                <div style="display: flex; gap: 8px; margin-left: 12px;">
                                    ${project.url ? `
                                        <a href="${project.url}" target="_blank" rel="noopener noreferrer" style="padding: 6px 10px; background: #f5f5f7; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #666; font-weight: 600; text-decoration: none;">
                                            <i class="ph ph-link"></i> View
                                        </a>
                                    ` : ''}
                                    <button onclick="deletePortfolioProject(${index})" style="padding: 6px 10px; background: #fee; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #c33; font-weight: 600;">
                                        <i class="ph ph-trash"></i>
                                    </button>
                                </div>
                            ` : project.url ? `
                                <a href="${project.url}" target="_blank" rel="noopener noreferrer" style="padding: 6px 10px; background: #f5f5f7; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #666; font-weight: 600; text-decoration: none; margin-left: 12px;">
                                    <i class="ph ph-link"></i> View
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addPortfolioProject() {
            alert('Add Portfolio Project functionality coming soon! This will allow you to manually add projects with title, description, technologies, URL, and achievements.');
        }

        function importFromGitHub() {
            alert('GitHub import coming soon! This will allow you to automatically import projects from your GitHub profile including README content, technologies used, and statistics.');
        }

        function connectToCodePen() {
            alert('CodePen integration coming soon! This will allow you to import your CodePen projects including HTML/CSS/JS demos, descriptions, and view counts.');
        }

        function deletePortfolioProject(index) {
            if (confirm('Are you sure you want to delete this portfolio project?')) {
                userPortfolioProjects.splice(index, 1);
                saveUserPortfolioProjects();
                loadPortfolioProjects();
                updateNodeCounts();
            }
        }

        // Projects Management
        let userProjects = [];
        const technologyColors = {
            'React': '#61DAFB', 'Vue': '#42B883', 'Angular': '#DD0031', 'Node.js': '#68A063',
            'Python': '#3776AB', 'JavaScript': '#F7DF1E', 'TypeScript': '#3178C6',
            'Java': '#007396', 'C#': '#239120', 'Ruby': '#CC342D', 'Go': '#00ADD8',
            'PHP': '#777BB4', 'Swift': '#FA7343', 'Kotlin': '#7F52FF',
            'PostgreSQL': '#336791', 'MongoDB': '#47A248', 'MySQL': '#4479A1',
            'Redis': '#DC382D', 'Docker': '#2496ED', 'Kubernetes': '#326CE5',
            'AWS': '#FF9900', 'Azure': '#0089D6', 'GCP': '#4285F4',
            'Git': '#F05032', 'GraphQL': '#E10098', 'REST': '#009688'
        };
        const topicColors = {
            'Web Development': '#0066CC', 'Mobile': '#673AB7', 'Backend': '#4CAF50',
            'Frontend': '#FF9800', 'Full Stack': '#E91E63', 'DevOps': '#00BCD4',
            'Data Science': '#9C27B0', 'Machine Learning': '#3F51B5', 'AI': '#2196F3',
            'Cloud': '#03A9F4', 'Security': '#F44336', 'Testing': '#8BC34A',
            'E-Commerce': '#FF5722', 'Analytics': '#607D8B', 'API': '#795548'
        };

        function loadUserProjects() {
            const stored = localStorage.getItem(`projects_${currentPersona}`);
            userProjects = stored ? JSON.parse(stored) : [];
        }

        function saveUserProjects() {
            localStorage.setItem(`projects_${currentPersona}`, JSON.stringify(userProjects));
        }

        function openProjectsSlideout() {
            loadUserProjects();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Project Repositories';

            // Hide all content sections
            hideAllContentSections();

            // Show projects content
            document.getElementById('projectsContent').style.display = 'flex';
            loadProjectsCards();

            slideout.classList.add('active');
        }

        function loadProjectsCards() {
            const container = document.getElementById('projectsContainer');

            if (userProjects.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px 20px; grid-column: 1/-1;">No project repositories yet. Click Connect Repository to add your local projects.</p>';
                return;
            }

            container.innerHTML = userProjects.map((project, index) => {
                const statusBadgeColors = {
                    'active': 'background: #e8f5e9; color: #2e7d32',
                    'completed': 'background: #e3f2fd; color: #1565c0',
                    'archived': 'background: #f5f5f5; color: #757575',
                    'planning': 'background: #fff3e0; color: #ef6c00'
                };

                const technologies = project.technologies ? project.technologies.split(',').map(t => t.trim()) : [];
                const topics = project.topics ? project.topics.split(',').map(t => t.trim()) : [];

                return `
                    <div class="experience-card" style="cursor: default;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #1a1a1a; font-size: 16px; font-weight: 600;">${project.name}</h4>
                                    <span style="padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; ${statusBadgeColors[project.status]}">
                                        ${project.status.toUpperCase()}
                                    </span>
                                </div>
                                <p style="margin: 0 0 8px 0; color: #666; font-size: 12px; font-family: 'Courier New', monospace;">
                                    <i class="ph ph-folder"></i> ${project.path}
                                </p>
                                ${project.repoUrl ? `
                                    <p style="margin: 0 0 8px 0; color: #0066CC; font-size: 12px;">
                                        <i class="ph ph-git-branch"></i> <a href="${project.repoUrl}" target="_blank" rel="noopener noreferrer" style="color: #0066CC; text-decoration: none;">${project.repoUrl}</a>
                                    </p>
                                ` : ''}
                                ${project.description ? `
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 13px; line-height: 1.5;">
                                        ${project.description}
                                    </p>
                                ` : ''}
                                ${technologies.length > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;">
                                        ${technologies.map(tech => {
                                            const color = technologyColors[tech] || '#999';
                                            return `<span style="background: ${color}20; color: ${color}; border: 1px solid ${color}40; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                                ${tech}
                                            </span>`;
                                        }).join('')}
                                    </div>
                                ` : ''}
                                ${topics.length > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${topics.map(topic => {
                                            const color = topicColors[topic] || '#666';
                                            return `<span style="background: ${color}15; color: ${color}; border: 1px solid ${color}30; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                ${topic}
                                            </span>`;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px; margin-left: 12px;">
                                <button onclick="editProject(${index})" style="padding: 6px 10px; background: #f5f5f7; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #666; font-weight: 600;">
                                    <i class="ph ph-pencil"></i> Edit
                                </button>
                                <button onclick="deleteProject(${index})" style="padding: 6px 10px; background: #fee; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #c33; font-weight: 600;">
                                    <i class="ph ph-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addProjectRepo() {
            document.getElementById('projectFormModal').classList.add('active');
            document.getElementById('projectForm').reset();
            document.getElementById('projectFormTitle').textContent = 'Connect Project Repository';
            document.getElementById('projectForm').dataset.editIndex = '';
        }

        function editProject(index) {
            const project = userProjects[index];
            document.getElementById('projectFormModal').classList.add('active');
            document.getElementById('projectFormTitle').textContent = 'Edit Project Repository';

            document.getElementById('projectName').value = project.name;
            document.getElementById('projectPath').value = project.path;
            document.getElementById('projectRepoUrl').value = project.repoUrl || '';
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectTechnologies').value = project.technologies || '';
            document.getElementById('projectTopics').value = project.topics || '';
            document.getElementById('projectStatus').value = project.status;

            document.getElementById('projectForm').dataset.editIndex = index;
        }

        function closeProjectForm() {
            document.getElementById('projectFormModal').classList.remove('active');
        }

        function saveProject(event) {
            event.preventDefault();

            const projectData = {
                name: document.getElementById('projectName').value,
                path: document.getElementById('projectPath').value,
                repoUrl: document.getElementById('projectRepoUrl').value,
                description: document.getElementById('projectDescription').value,
                technologies: document.getElementById('projectTechnologies').value,
                topics: document.getElementById('projectTopics').value,
                status: document.getElementById('projectStatus').value
            };

            const editIndex = document.getElementById('projectForm').dataset.editIndex;

            if (editIndex !== '') {
                userProjects[parseInt(editIndex)] = projectData;
            } else {
                userProjects.push(projectData);
            }

            saveUserProjects();
            loadProjectsCards();
            updateNodeCounts();
            closeProjectForm();
        }

        function deleteProject(index) {
            if (confirm('Are you sure you want to remove this project repository connection?')) {
                userProjects.splice(index, 1);
                saveUserProjects();
                loadProjectsCards();
                updateNodeCounts();
            }
        }

        function scanLocalRepos() {
            alert('Scan Local Directories functionality coming soon! This will automatically detect Git repositories in your specified folders.');
        }

        function openCodeSnippetsSlideout() {
            alert('Code Snippets functionality coming soon! This will allow you to save and organize reusable code snippets with syntax highlighting.');
        }

        function openMyLibrarySlideout() {
            alert('My Library functionality coming soon! This will connect to your Cleansheet Library content for personalized learning resources.');
        }

        // My Notes Management
        let userNotes = [];
        const categoryColors = {
            'learning': { bg: '#e3f2fd', color: '#1565c0', icon: 'ph-graduation-cap' },
            'idea': { bg: '#fff3e0', color: '#ef6c00', icon: 'ph-lightbulb' },
            'question': { bg: '#f3e5f5', color: '#7b1fa2', icon: 'ph-question' },
            'reference': { bg: '#e8f5e9', color: '#2e7d32', icon: 'ph-bookmark' },
            'todo': { bg: '#ffebee', color: '#c62828', icon: 'ph-check-square' },
            'general': { bg: '#f5f5f5', color: '#616161', icon: 'ph-note' }
        };

        function loadUserNotes() {
            const stored = localStorage.getItem(`notes_${currentPersona}`);
            userNotes = stored ? JSON.parse(stored) : [];
        }

        function saveUserNotes() {
            localStorage.setItem(`notes_${currentPersona}`, JSON.stringify(userNotes));
        }

        function openMyNotesSlideout() {
            loadUserNotes();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'My Notes';

            // Hide all content sections
            hideAllContentSections();

            // Show notes content
            document.getElementById('myNotesContent').style.display = 'flex';
            document.getElementById('notesSearchInput').value = '';
            loadNotesCards();

            slideout.classList.add('active');
        }

        // Calendar Management
        let calendarEvents = [];
        let currentCalendarView = 'weekly';
        let currentCalendarDate = new Date();
        let editingEventIndex = -1;

        function loadCalendarEvents() {
            const stored = localStorage.getItem('calendarEvents_' + currentPersona);
            if (stored) {
                try {
                    calendarEvents = JSON.parse(stored);
                } catch (e) {
                    calendarEvents = [];
                }
            } else {
                // Initialize with example events if none exist
                calendarEvents = getExamplePersonalEvents();
            }
        }

        function getExamplePersonalEvents() {
            const today = new Date();
            const year = today.getFullYear();

            return [
                // Birthdays
                {
                    title: "Mom's Birthday",
                    type: 'allday',
                    date: `${year}-03-15`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Call Mom and send flowers',
                    calendar: 'personal'
                },
                {
                    title: "Dad's Birthday",
                    type: 'allday',
                    date: `${year}-07-22`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Plan dinner with family',
                    calendar: 'personal'
                },
                {
                    title: "Sister's Birthday",
                    type: 'allday',
                    date: `${year}-09-08`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: '',
                    calendar: 'personal'
                },
                {
                    title: "Best Friend's Birthday",
                    type: 'allday',
                    date: `${year}-11-12`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Birthday dinner planned',
                    calendar: 'personal'
                },

                // Holidays
                {
                    title: "New Year's Day",
                    type: 'allday',
                    date: `${year}-01-01`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Federal Holiday',
                    calendar: 'personal'
                },
                {
                    title: "Valentine's Day",
                    type: 'allday',
                    date: `${year}-02-14`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Dinner reservation at 7 PM',
                    calendar: 'personal'
                },
                {
                    title: "Memorial Day",
                    type: 'allday',
                    date: `${year}-05-26`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: '',
                    description: 'Federal Holiday - BBQ with family',
                    calendar: 'personal'
                },
                {
                    title: "Independence Day",
                    type: 'allday',
                    date: `${year}-07-04`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Fireworks at the park',
                    calendar: 'personal'
                },
                {
                    title: "Labor Day",
                    type: 'allday',
                    date: `${year}-09-01`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: '',
                    description: 'Federal Holiday',
                    calendar: 'personal'
                },
                {
                    title: "Halloween",
                    type: 'allday',
                    date: `${year}-10-31`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Trick-or-treating with kids',
                    calendar: 'personal'
                },
                {
                    title: "Thanksgiving",
                    type: 'allday',
                    date: `${year}-11-27`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: '',
                    description: 'Dinner at grandparents',
                    calendar: 'personal'
                },
                {
                    title: "Christmas Eve",
                    type: 'allday',
                    date: `${year}-12-24`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Family gathering',
                    calendar: 'personal'
                },
                {
                    title: "Christmas",
                    type: 'allday',
                    date: `${year}-12-25`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Federal Holiday',
                    calendar: 'personal'
                },
                {
                    title: "New Year's Eve",
                    type: 'allday',
                    date: `${year}-12-31`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Party at Sarah\'s house',
                    calendar: 'personal'
                },

                // Vacations
                {
                    title: "Spring Break Trip",
                    type: 'allday',
                    date: `${year}-03-20`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: 'Miami, FL',
                    description: 'Beach vacation - 7 days',
                    calendar: 'personal'
                },
                {
                    title: "Summer Vacation",
                    type: 'allday',
                    date: `${year}-07-15`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: 'Yellowstone National Park',
                    description: 'Camping and hiking - 10 days',
                    calendar: 'personal'
                },
                {
                    title: "Anniversary Weekend",
                    type: 'allday',
                    date: `${year}-09-20`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: 'Napa Valley, CA',
                    description: 'Wine country getaway',
                    calendar: 'personal'
                },
                {
                    title: "Thanksgiving Road Trip",
                    type: 'allday',
                    date: `${year}-11-22`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: 'Denver, CO to Chicago, IL',
                    description: 'Driving to see family',
                    calendar: 'personal'
                },

                // Personal Events
                {
                    title: "Dentist Appointment",
                    type: 'datetime',
                    date: `${year}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate() + 7).padStart(2, '0')}`,
                    startTime: '10:00',
                    endTime: '11:00',
                    recurring: false,
                    location: 'Dr. Smith Dental Office',
                    description: 'Regular cleaning',
                    calendar: 'personal'
                },
                {
                    title: "Gym Session",
                    type: 'datetime',
                    date: `${year}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate() + 1).padStart(2, '0')}`,
                    startTime: '06:30',
                    endTime: '07:30',
                    recurring: true,
                    recurrence: {
                        pattern: 'weekly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: 'LA Fitness',
                    description: 'Morning workout',
                    calendar: 'personal'
                },
                {
                    title: "Book Club Meeting",
                    type: 'datetime',
                    date: `${year}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate() + 14).padStart(2, '0')}`,
                    startTime: '19:00',
                    endTime: '21:00',
                    recurring: true,
                    recurrence: {
                        pattern: 'monthly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: 'Coffee House Downtown',
                    description: 'Discussing "The Great Gatsby"',
                    calendar: 'personal'
                }
            ];
        }

        function saveCalendarEvents() {
            localStorage.setItem('calendarEvents_' + currentPersona, JSON.stringify(calendarEvents));
        }

        function openCalendarSlideout() {
            loadCalendarEvents();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Calendar';

            // Hide all content sections
            hideAllContentSections();

            // Show calendar content
            document.getElementById('calendarContent').style.display = 'block';
            renderCalendar();

            slideout.classList.add('active');
        }

        function switchCalendarView(view) {
            currentCalendarView = view;

            // Update active button states
            document.querySelectorAll('.calendar-view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(view + 'ViewBtn').classList.add('active');

            renderCalendar();
        }

        function navigateCalendar(direction) {
            if (direction === 'prev') {
                if (currentCalendarView === 'daily') {
                    currentCalendarDate.setDate(currentCalendarDate.getDate() - 1);
                } else if (currentCalendarView === 'weekly') {
                    currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
                } else {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                }
            } else if (direction === 'next') {
                if (currentCalendarView === 'daily') {
                    currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
                } else if (currentCalendarView === 'weekly') {
                    currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
                } else {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                }
            } else if (direction === 'today') {
                currentCalendarDate = new Date();
            }

            renderCalendar();
        }

        function renderCalendar() {
            const displayArea = document.getElementById('calendarDisplayArea');
            const dateRangeEl = document.getElementById('calendarDateRange');

            if (currentCalendarView === 'daily') {
                renderDailyView(displayArea, dateRangeEl);
            } else if (currentCalendarView === 'weekly') {
                renderWeeklyView(displayArea, dateRangeEl);
            } else {
                renderMonthlyView(displayArea, dateRangeEl);
            }
        }

        function renderDailyView(container, dateRangeEl) {
            const dateStr = currentCalendarDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            dateRangeEl.textContent = dateStr;

            const dayEvents = getEventsForDate(currentCalendarDate);

            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';

            // Time slots from 6 AM to 10 PM
            for (let hour = 6; hour <= 22; hour++) {
                const timeStr = formatHour(hour);
                const eventsAtHour = dayEvents.filter(e => {
                    if (e.type === 'allday') return hour === 6;
                    if (!e.startTime) return false;
                    const eventHour = parseInt(e.startTime.split(':')[0]);
                    return eventHour === hour;
                });

                html += `
                    <div style="display: flex; border-bottom: 1px solid var(--color-neutral-border); padding: 8px 0;">
                        <div style="width: 80px; font-family: var(--font-family-heading); font-size: 12px; color: var(--color-neutral-text-light); padding-right: 16px; text-align: right;">
                            ${timeStr}
                        </div>
                        <div style="flex: 1;">
                            ${eventsAtHour.map(event => renderEventCard(event, 'daily')).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderWeeklyView(container, dateRangeEl) {
            const weekStart = getWeekStart(currentCalendarDate);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            dateRangeEl.textContent = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--color-neutral-border);">';

            // Day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach((day, index) => {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + index);
                const isToday = isSameDay(date, new Date());

                html += `
                    <div style="background: white; padding: 12px 8px; text-align: center; ${isToday ? 'background: #dcfce7;' : ''}">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase;">
                            ${day}
                        </div>
                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: ${isToday ? '#16a34a' : 'var(--color-neutral-text)'}; margin-top: 4px;">
                            ${date.getDate()}
                        </div>
                    </div>
                `;
            });

            // Day cells with events
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const dayEvents = getEventsForDate(date);

                html += `
                    <div style="background: white; padding: 8px; min-height: 120px; max-height: 300px; overflow-y: auto;">
                        ${dayEvents.map(event => renderEventCard(event, 'weekly')).join('')}
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderMonthlyView(container, dateRangeEl) {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const monthName = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            dateRangeEl.textContent = monthName;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--color-neutral-border);">';

            // Day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                html += `
                    <div style="background: white; padding: 8px; text-align: center; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase;">
                        ${day}
                    </div>
                `;
            });

            // Empty cells before first day
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div style="background: #fafafa; min-height: 100px;"></div>';
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = isSameDay(date, new Date());
                const dayEvents = getEventsForDate(date);

                html += `
                    <div style="background: white; padding: 8px; min-height: 100px; max-height: 150px; overflow-y: auto; ${isToday ? 'border: 2px solid #16a34a;' : ''}">
                        <div style="font-family: var(--font-family-heading); font-size: 14px; font-weight: ${isToday ? '700' : '600'}; color: ${isToday ? '#16a34a' : 'var(--color-neutral-text)'}; margin-bottom: 4px;">
                            ${day}
                        </div>
                        ${dayEvents.map(event => renderEventCard(event, 'monthly')).join('')}
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderEventCard(event, viewMode) {
            const timeStr = event.type === 'allday' ? 'All Day' : event.startTime ? event.startTime + (event.endTime ? ' - ' + event.endTime : '') : '';

            if (viewMode === 'monthly') {
                return `
                    <div onclick="viewEvent(${calendarEvents.indexOf(event)})" style="background: #dcfce7; border-left: 3px solid #16a34a; padding: 4px 6px; margin-bottom: 4px; cursor: pointer; border-radius: 3px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${event.title}
                        </div>
                    </div>
                `;
            } else if (viewMode === 'weekly') {
                return `
                    <div onclick="viewEvent(${calendarEvents.indexOf(event)})" style="background: #dcfce7; border-left: 3px solid #16a34a; padding: 6px 8px; margin-bottom: 6px; cursor: pointer; border-radius: 4px;">
                        <div style="font-family: var(--font-family-heading); font-size: 10px; color: #16a34a; font-weight: 600; margin-bottom: 2px;">
                            ${timeStr}
                        </div>
                        <div style="font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; color: var(--color-neutral-text);">
                            ${event.title}
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div onclick="viewEvent(${calendarEvents.indexOf(event)})" style="background: #dcfce7; border-left: 3px solid #16a34a; padding: 12px; margin-bottom: 8px; cursor: pointer; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                                    ${event.title}
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; color: #16a34a; font-weight: 600;">
                                    ${timeStr}
                                </div>
                                ${event.location ? `
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light); margin-top: 4px;">
                                        <i class="ph ph-map-pin"></i> ${event.location}
                                    </div>
                                ` : ''}
                                ${event.description ? `
                                    <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-top: 8px;">
                                        ${event.description}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button onclick="event.stopPropagation(); editEvent(${calendarEvents.indexOf(event)})" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">
                                    <i class="ph ph-pencil-simple" style="font-size: 14px; color: #16a34a;"></i>
                                </button>
                                <button onclick="event.stopPropagation(); shareEventPrompt(${calendarEvents.indexOf(event)})" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">
                                    <i class="ph ph-share-network" style="font-size: 14px; color: #16a34a;"></i>
                                </button>
                                <button onclick="event.stopPropagation(); deleteEvent(${calendarEvents.indexOf(event)})" style="padding: 6px; background: #fee; border: 1px solid #fcc; border-radius: 4px; cursor: pointer;">
                                    <i class="ph ph-trash" style="font-size: 14px; color: #c33;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function getEventsForDate(date) {
            return calendarEvents.filter(event => {
                const eventDate = new Date(event.date);
                return isSameDay(eventDate, date);
            });
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function formatHour(hour) {
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:00 ${ampm}`;
        }

        function openAddEventForm() {
            editingEventIndex = -1;
            document.getElementById('eventFormTitle').textContent = 'Add Event';
            document.getElementById('eventForm').reset();
            document.getElementById('eventDate').value = currentCalendarDate.toISOString().split('T')[0];
            document.getElementById('eventFormModal').style.display = 'flex';
        }

        function closeEventForm() {
            document.getElementById('eventFormModal').style.display = 'none';
            editingEventIndex = -1;
        }

        function updateEventTypeFields() {
            const type = document.getElementById('eventType').value;
            const startTimeField = document.getElementById('eventStartTimeField');
            const endTimeField = document.getElementById('eventEndTimeField');
            const dateField = document.getElementById('eventDateField');

            if (type === 'allday') {
                startTimeField.style.display = 'none';
                endTimeField.style.display = 'none';
                dateField.style.display = 'block';
            } else if (type === 'datetime') {
                startTimeField.style.display = 'block';
                endTimeField.style.display = 'block';
                dateField.style.display = 'block';
            } else if (type === 'time') {
                startTimeField.style.display = 'block';
                endTimeField.style.display = 'block';
                dateField.style.display = 'none';
            }
        }

        function toggleRecurringFields() {
            const isRecurring = document.getElementById('eventRecurring').checked;
            document.getElementById('recurringFields').style.display = isRecurring ? 'block' : 'none';
        }

        function toggleRecurrenceEnd() {
            const endType = document.getElementById('recurrenceEndType').value;
            document.getElementById('recurrenceEndDateField').style.display = endType === 'date' ? 'block' : 'none';
            document.getElementById('recurrenceCountField').style.display = endType === 'count' ? 'block' : 'none';
        }

        function saveEvent(e) {
            e.preventDefault();

            const eventData = {
                title: document.getElementById('eventTitle').value,
                type: document.getElementById('eventType').value,
                date: document.getElementById('eventDate').value,
                startTime: document.getElementById('eventStartTime').value,
                endTime: document.getElementById('eventEndTime').value,
                recurring: document.getElementById('eventRecurring').checked,
                location: document.getElementById('eventLocation').value,
                description: document.getElementById('eventDescription').value,
                calendar: document.getElementById('eventCalendar').value
            };

            if (eventData.recurring) {
                eventData.recurrence = {
                    pattern: document.getElementById('recurrencePattern').value,
                    interval: document.getElementById('recurrenceInterval').value,
                    endType: document.getElementById('recurrenceEndType').value,
                    endDate: document.getElementById('recurrenceEndDate').value,
                    count: document.getElementById('recurrenceCount').value
                };
            }

            if (editingEventIndex >= 0) {
                calendarEvents[editingEventIndex] = eventData;
            } else {
                calendarEvents.push(eventData);
            }

            saveCalendarEvents();
            renderCalendar();
            closeEventForm();
        }

        function viewEvent(index) {
            editEvent(index);
        }

        function editEvent(index) {
            const event = calendarEvents[index];
            editingEventIndex = index;

            document.getElementById('eventFormTitle').textContent = 'Edit Event';
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventType').value = event.type;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventStartTime').value = event.startTime || '';
            document.getElementById('eventEndTime').value = event.endTime || '';
            document.getElementById('eventRecurring').checked = event.recurring || false;
            document.getElementById('eventLocation').value = event.location || '';
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('eventCalendar').value = event.calendar || 'personal';

            updateEventTypeFields();
            toggleRecurringFields();

            if (event.recurrence) {
                document.getElementById('recurrencePattern').value = event.recurrence.pattern;
                document.getElementById('recurrenceInterval').value = event.recurrence.interval;
                document.getElementById('recurrenceEndType').value = event.recurrence.endType;
                document.getElementById('recurrenceEndDate').value = event.recurrence.endDate || '';
                document.getElementById('recurrenceCount').value = event.recurrence.count || 10;
                toggleRecurrenceEnd();
            }

            document.getElementById('eventFormModal').style.display = 'flex';
        }

        function deleteEvent(index) {
            if (confirm('Are you sure you want to delete this event?')) {
                calendarEvents.splice(index, 1);
                saveCalendarEvents();
                renderCalendar();
            }
        }

        function shareEventPrompt(index) {
            const event = calendarEvents[index];
            alert(`Share functionality coming soon!\n\nEvent: ${event.title}\nDate: ${event.date}\n\nYou'll be able to share this event via email, text, or social media.`);
        }

        function openCalendarSettings() {
            document.getElementById('calendarSettingsModal').style.display = 'flex';
        }

        function closeCalendarSettings() {
            document.getElementById('calendarSettingsModal').style.display = 'none';
        }

        function switchSettingsTab(tab) {
            document.getElementById('syncSettingsContent').style.display = 'none';
            document.getElementById('exportSettingsContent').style.display = 'none';
            document.getElementById('shareSettingsContent').style.display = 'none';

            document.getElementById('syncTab').style.borderBottom = '2px solid transparent';
            document.getElementById('syncTab').style.color = 'var(--color-neutral-text)';
            document.getElementById('exportTab').style.borderBottom = '2px solid transparent';
            document.getElementById('exportTab').style.color = 'var(--color-neutral-text)';
            document.getElementById('shareTab').style.borderBottom = '2px solid transparent';
            document.getElementById('shareTab').style.color = 'var(--color-neutral-text)';

            if (tab === 'sync') {
                document.getElementById('syncSettingsContent').style.display = 'block';
                document.getElementById('syncTab').style.borderBottom = '2px solid var(--color-primary-blue)';
                document.getElementById('syncTab').style.color = 'var(--color-primary-blue)';
            } else if (tab === 'export') {
                document.getElementById('exportSettingsContent').style.display = 'block';
                document.getElementById('exportTab').style.borderBottom = '2px solid var(--color-primary-blue)';
                document.getElementById('exportTab').style.color = 'var(--color-primary-blue)';
            } else if (tab === 'share') {
                document.getElementById('shareSettingsContent').style.display = 'block';
                document.getElementById('shareTab').style.borderBottom = '2px solid var(--color-primary-blue)';
                document.getElementById('shareTab').style.color = 'var(--color-primary-blue)';
            }
        }

        function connectGoogleCalendar() {
            alert('Google Calendar connection coming soon!\n\nYou\'ll be able to:\n• Two-way sync with Google Calendar\n• Import existing events\n• Auto-sync new events');
        }

        function connectMicrosoftCalendar() {
            alert('Microsoft Calendar connection coming soon!\n\nYou\'ll be able to:\n• Two-way sync with Outlook/Microsoft 365\n• Import existing events\n• Auto-sync new events');
        }

        function connectAppleCalendar() {
            alert('Apple Calendar connection coming soon!\n\nYou\'ll be able to:\n• Two-way sync with iCloud Calendar\n• Import existing events\n• Auto-sync new events');
        }

        function exportCalendar(format) {
            if (calendarEvents.length === 0) {
                alert('No events to export!');
                return;
            }

            let data, filename, mimeType;

            if (format === 'ics') {
                data = generateICS();
                filename = 'cleansheet-calendar.ics';
                mimeType = 'text/calendar';
            } else if (format === 'csv') {
                data = generateCSV();
                filename = 'cleansheet-calendar.csv';
                mimeType = 'text/csv';
            } else if (format === 'json') {
                data = JSON.stringify(calendarEvents, null, 2);
                filename = 'cleansheet-calendar.json';
                mimeType = 'application/json';
            }

            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateICS() {
            let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Cleansheet//Calendar//EN\n';

            calendarEvents.forEach(event => {
                ics += 'BEGIN:VEVENT\n';
                ics += `SUMMARY:${event.title}\n`;
                ics += `DTSTART:${event.date.replace(/-/g, '')}${event.startTime ? 'T' + event.startTime.replace(':', '') + '00' : ''}\n`;
                if (event.endTime) {
                    ics += `DTEND:${event.date.replace(/-/g, '')}T${event.endTime.replace(':', '')}00\n`;
                }
                if (event.location) {
                    ics += `LOCATION:${event.location}\n`;
                }
                if (event.description) {
                    ics += `DESCRIPTION:${event.description}\n`;
                }
                ics += 'END:VEVENT\n';
            });

            ics += 'END:VCALENDAR';
            return ics;
        }

        function generateCSV() {
            let csv = 'Title,Date,Start Time,End Time,Type,Location,Description,Recurring\n';

            calendarEvents.forEach(event => {
                csv += `"${event.title}","${event.date}","${event.startTime || ''}","${event.endTime || ''}","${event.type}","${event.location || ''}","${event.description || ''}","${event.recurring ? 'Yes' : 'No'}"\n`;
            });

            return csv;
        }

        function copyShareLink() {
            const link = document.getElementById('shareLink');
            link.select();
            document.execCommand('copy');
            alert('Share link copied to clipboard!');
        }

        function togglePublicSharing() {
            const isPublic = document.getElementById('sharePublic').checked;
            if (isPublic) {
                alert('Calendar is now publicly accessible. Anyone with the link can view your events.');
            } else {
                alert('Calendar is now private. Only people you invite can view your events.');
            }
        }

        // ============================================
        // Recipes Management
        // ============================================

        let recipes = [];

        function loadRecipes() {
            const stored = localStorage.getItem('cleansheet_recipes_personal');
            if (stored) {
                recipes = JSON.parse(stored);
            } else {
                // Load example recipes
                recipes = getExampleRecipes();
                saveRecipesToStorage();
            }
        }

        function saveRecipesToStorage() {
            localStorage.setItem('cleansheet_recipes_personal', JSON.stringify(recipes));
        }

        // Shopping Management
        let shoppingItems = [];

        function loadShoppingItems() {
            const stored = localStorage.getItem('cleansheet_shopping_personal');
            if (stored) {
                try {
                    shoppingItems = JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to parse shopping items', e);
                    shoppingItems = [];
                }
            }
        }

        function saveShoppingItemsToStorage() {
            localStorage.setItem('cleansheet_shopping_personal', JSON.stringify(shoppingItems));
        }

        function openShoppingSlideout(section = null) {
            loadShoppingItems();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Shopping';

            // Hide all other content sections (safe access)
            const contentSections = [
                'interviewPrepContent', 'behavioralContent', 'technicalContent',
                'jobOpportunitiesContent', 'careerExperienceContent', 'applicationMaterialsContent',
                'skillsCompetenciesContent', 'portfolioContent', 'projectsContent',
                'myNotesContent', 'calendarContent', 'recipesContent', 'financeContent', 'shoppingContent', 'tablesContent', 'formsContent',
                'documentsContent', 'reportsContent', 'templatesContent', 'workflowsContent'
            ];

            contentSections.forEach(sectionId => {
                const sectionEl = document.getElementById(sectionId);
                if (sectionEl) sectionEl.style.display = 'none';
            });

            // Show shopping content
            document.getElementById('shoppingContent').style.display = 'block';

            // If section is provided, update filter to show that category
            if (section) {
                const filterSelect = document.getElementById('shoppingFilterSelect');
                if (filterSelect) {
                    filterSelect.value = section;
                }
            }

            renderShoppingItems();
            updateShoppingSummary();

            slideout.classList.add('active');
        }

        function renderShoppingItems() {
            const container = document.getElementById('shoppingItemsContainer');
            const filterCategory = document.getElementById('shoppingFilterSelect').value;

            const filteredItems = shoppingItems.filter(item => {
                return !filterCategory || item.category === filterCategory;
            });

            if (filteredItems.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text-light); text-align: center; padding: 40px;">No shopping items found. Add an item to get started.</p>';
                return;
            }

            container.innerHTML = filteredItems.map((item, index) => {
                const actualIndex = shoppingItems.indexOf(item);
                const isCompleted = item.completed;
                const bgColor = isCompleted ? '#f5f5f7' : 'white';
                const textDecoration = isCompleted ? 'line-through' : 'none';
                const textColor = isCompleted ? '#999999' : 'var(--color-neutral-text)';

                return `
                    <div style="background: ${bgColor}; border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1; display: flex; align-items: start; gap: 12px;">
                                <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleShoppingItemComplete(${actualIndex})" style="margin-top: 2px; width: 18px; height: 18px; cursor: pointer;">
                                <div style="flex: 1;">
                                    <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: ${textColor}; margin: 0 0 4px 0; text-decoration: ${textDecoration};">
                                        ${item.name}
                                    </h3>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light);">
                                        ${item.category}${item.estimatedCost ? ` • $${item.estimatedCost.toFixed(2)}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="deleteShoppingItem(${actualIndex})" style="padding: 6px 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #ef4444; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </div>
                        </div>

                        ${item.notes ? `
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: ${textColor}; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--color-neutral-border); text-decoration: ${textDecoration};">
                                ${item.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterShoppingItems() {
            renderShoppingItems();
        }

        function updateShoppingSummary() {
            const totalItems = shoppingItems.length;
            const estimatedTotal = shoppingItems.reduce((sum, item) => sum + (item.estimatedCost || 0), 0);

            document.getElementById('totalShoppingItems').textContent = totalItems;
            document.getElementById('estimatedShoppingTotal').textContent = `$${estimatedTotal.toFixed(2)}`;
        }

        function addShoppingItem() {
            const name = prompt('Enter item name:');
            if (!name || !name.trim()) return;

            const category = prompt('Enter category (Grocery, Home, Internet, Gifts):') || 'Grocery';
            const estimatedCostStr = prompt('Enter estimated cost (optional):');
            const estimatedCost = estimatedCostStr ? parseFloat(estimatedCostStr) : 0;
            const notes = prompt('Enter notes (optional):') || '';

            const item = {
                name: name.trim(),
                category: category.trim(),
                estimatedCost,
                notes: notes.trim(),
                completed: false,
                createdAt: new Date().toISOString()
            };

            shoppingItems.push(item);
            saveShoppingItemsToStorage();
            renderShoppingItems();
            updateShoppingSummary();
        }

        function toggleShoppingItemComplete(index) {
            shoppingItems[index].completed = !shoppingItems[index].completed;
            saveShoppingItemsToStorage();
            renderShoppingItems();
        }

        function deleteShoppingItem(index) {
            if (confirm('Are you sure you want to delete this shopping item?')) {
                shoppingItems.splice(index, 1);
                saveShoppingItemsToStorage();
                renderShoppingItems();
                updateShoppingSummary();
            }
        }

        function openRecipesSlideout() {
            loadRecipes();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Recipes';

            // Hide all other content sections (safe access)
            const contentSections = [
                'interviewPrepContent', 'behavioralContent', 'technicalContent',
                'jobOpportunitiesContent', 'careerExperienceContent', 'applicationMaterialsContent',
                'skillsCompetenciesContent', 'portfolioContent', 'projectsContent',
                'myNotesContent', 'calendarContent', 'recipesContent', 'financeContent', 'shoppingContent', 'tablesContent', 'formsContent',
                'documentsContent', 'reportsContent', 'templatesContent', 'workflowsContent'
            ];

            contentSections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) section.style.display = 'none';
            });

            // Show recipes content
            document.getElementById('recipesContent').style.display = 'block';

            populateRecipeFilters();
            renderRecipes();

            slideout.classList.add('active');
        }

        function populateRecipeFilters() {
            const cuisines = [...new Set(recipes.map(r => r.cuisine).filter(c => c))].sort();
            const mealTypes = [...new Set(recipes.map(r => r.mealType).filter(m => m))].sort();

            const cuisineSelect = document.getElementById('cuisineFilterSelect');
            const mealTypeSelect = document.getElementById('mealTypeFilterSelect');

            // Clear and repopulate cuisine filter
            cuisineSelect.innerHTML = '<option value="">All Cuisines</option>';
            cuisines.forEach(cuisine => {
                const option = document.createElement('option');
                option.value = cuisine;
                option.textContent = cuisine;
                cuisineSelect.appendChild(option);
            });

            // Clear and repopulate meal type filter
            mealTypeSelect.innerHTML = '<option value="">All Meal Types</option>';
            mealTypes.forEach(mealType => {
                const option = document.createElement('option');
                option.value = mealType;
                option.textContent = mealType;
                mealTypeSelect.appendChild(option);
            });
        }

        function renderRecipes() {
            const container = document.getElementById('recipesContainer');
            const searchTerm = document.getElementById('recipesSearchInput').value.toLowerCase();
            const cuisineFilter = document.getElementById('cuisineFilterSelect').value;
            const mealTypeFilter = document.getElementById('mealTypeFilterSelect').value;

            const filteredRecipes = recipes.filter(recipe => {
                const matchesSearch = !searchTerm ||
                    recipe.name.toLowerCase().includes(searchTerm) ||
                    (recipe.ingredients && recipe.ingredients.toLowerCase().includes(searchTerm)) ||
                    (recipe.notes && recipe.notes.toLowerCase().includes(searchTerm));

                const matchesCuisine = !cuisineFilter || recipe.cuisine === cuisineFilter;
                const matchesMealType = !mealTypeFilter || recipe.mealType === mealTypeFilter;

                return matchesSearch && matchesCuisine && matchesMealType;
            });

            if (filteredRecipes.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text-light); text-align: center; padding: 40px;">No recipes found. Add your first recipe!</p>';
                return;
            }

            container.innerHTML = filteredRecipes.map((recipe, index) => {
                const totalTime = (recipe.prepTime || 0) + (recipe.cookTime || 0);
                return `
                    <div style="background: #dcfce7; border: 1px solid #16a34a; border-radius: 8px; padding: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
                         onclick="viewRecipe(${recipes.indexOf(recipe)})"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(22, 163, 74, 0.15)';"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 8px 0;">
                            ${recipe.name}
                        </h3>

                        ${recipe.cuisine || recipe.mealType ? `
                            <div style="display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap;">
                                ${recipe.cuisine ? `<span style="background: white; padding: 4px 8px; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${recipe.cuisine}</span>` : ''}
                                ${recipe.mealType ? `<span style="background: white; padding: 4px 8px; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${recipe.mealType}</span>` : ''}
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 12px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light);">
                            ${totalTime > 0 ? `
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <i class="ph ph-clock"></i>
                                    <span>${totalTime} min</span>
                                </div>
                            ` : ''}
                            ${recipe.servings ? `
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <i class="ph ph-users"></i>
                                    <span>${recipe.servings} servings</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchRecipes() {
            renderRecipes();
        }

        function filterRecipes() {
            renderRecipes();
        }

        function openAddRecipeForm() {
            document.getElementById('recipeFormTitle').textContent = 'Add Recipe';
            document.getElementById('recipeEditIndex').value = '';
            document.getElementById('recipeName').value = '';
            document.getElementById('recipeCuisine').value = '';
            document.getElementById('recipeMealType').value = '';
            document.getElementById('recipePrepTime').value = '';
            document.getElementById('recipeCookTime').value = '';
            document.getElementById('recipeServings').value = '';
            document.getElementById('recipeIngredients').value = '';
            document.getElementById('recipeInstructions').value = '';
            document.getElementById('recipeNotes').value = '';

            document.getElementById('recipeFormModal').style.display = 'flex';
        }

        function closeRecipeForm() {
            document.getElementById('recipeFormModal').style.display = 'none';
        }

        function saveRecipe() {
            const name = document.getElementById('recipeName').value.trim();
            const cuisine = document.getElementById('recipeCuisine').value.trim();
            const mealType = document.getElementById('recipeMealType').value.trim();
            const prepTime = parseInt(document.getElementById('recipePrepTime').value) || 0;
            const cookTime = parseInt(document.getElementById('recipeCookTime').value) || 0;
            const servings = parseInt(document.getElementById('recipeServings').value) || 0;
            const ingredients = document.getElementById('recipeIngredients').value.trim();
            const instructions = document.getElementById('recipeInstructions').value.trim();
            const notes = document.getElementById('recipeNotes').value.trim();
            const editIndex = document.getElementById('recipeEditIndex').value;

            if (!name) {
                alert('Please enter a recipe name');
                return;
            }

            if (!ingredients) {
                alert('Please enter ingredients');
                return;
            }

            if (!instructions) {
                alert('Please enter instructions');
                return;
            }

            const recipe = {
                name,
                cuisine,
                mealType,
                prepTime,
                cookTime,
                servings,
                ingredients,
                instructions,
                notes,
                createdAt: editIndex ? recipes[editIndex].createdAt : new Date().toISOString()
            };

            if (editIndex !== '') {
                recipes[editIndex] = recipe;
            } else {
                recipes.push(recipe);
            }

            saveRecipesToStorage();
            populateRecipeFilters();
            renderRecipes();
            closeRecipeForm();
        }

        function editRecipe(index) {
            const recipe = recipes[index];

            document.getElementById('recipeFormTitle').textContent = 'Edit Recipe';
            document.getElementById('recipeEditIndex').value = index;
            document.getElementById('recipeName').value = recipe.name;
            document.getElementById('recipeCuisine').value = recipe.cuisine || '';
            document.getElementById('recipeMealType').value = recipe.mealType || '';
            document.getElementById('recipePrepTime').value = recipe.prepTime || '';
            document.getElementById('recipeCookTime').value = recipe.cookTime || '';
            document.getElementById('recipeServings').value = recipe.servings || '';
            document.getElementById('recipeIngredients').value = recipe.ingredients;
            document.getElementById('recipeInstructions').value = recipe.instructions;
            document.getElementById('recipeNotes').value = recipe.notes || '';

            document.getElementById('recipeFormModal').style.display = 'flex';
        }

        function deleteRecipe(index) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                recipes.splice(index, 1);
                saveRecipesToStorage();
                populateRecipeFilters();
                renderRecipes();
            }
        }

        function viewRecipe(index) {
            const recipe = recipes[index];
            const ingredientsList = recipe.ingredients.split('\n').filter(i => i.trim());
            const instructionsList = recipe.instructions.split('\n').filter(i => i.trim());
            const totalTime = (recipe.prepTime || 0) + (recipe.cookTime || 0);

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <div style="position: sticky; top: 0; background: white; z-index: 10; padding: 20px; border-bottom: 1px solid var(--color-neutral-border);">
                        <h2 style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 8px 0;">
                            ${recipe.name}
                        </h2>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${recipe.cuisine ? `<span style="background: #dcfce7; padding: 6px 12px; border-radius: 4px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">${recipe.cuisine}</span>` : ''}
                            ${recipe.mealType ? `<span style="background: #dcfce7; padding: 6px 12px; border-radius: 4px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">${recipe.mealType}</span>` : ''}
                        </div>
                    </div>

                    <div style="padding: 20px;">
                        ${recipe.prepTime || recipe.cookTime || recipe.servings ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 24px;">
                                ${totalTime > 0 ? `
                                    <div style="text-align: center; padding: 12px; background: var(--color-neutral-background); border-radius: 8px;">
                                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Total Time</div>
                                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: #16a34a;">${totalTime} min</div>
                                    </div>
                                ` : ''}
                                ${recipe.prepTime > 0 ? `
                                    <div style="text-align: center; padding: 12px; background: var(--color-neutral-background); border-radius: 8px;">
                                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Prep Time</div>
                                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: var(--color-neutral-text);">${recipe.prepTime} min</div>
                                    </div>
                                ` : ''}
                                ${recipe.cookTime > 0 ? `
                                    <div style="text-align: center; padding: 12px; background: var(--color-neutral-background); border-radius: 8px;">
                                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Cook Time</div>
                                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: var(--color-neutral-text);">${recipe.cookTime} min</div>
                                    </div>
                                ` : ''}
                                ${recipe.servings > 0 ? `
                                    <div style="text-align: center; padding: 12px; background: var(--color-neutral-background); border-radius: 8px;">
                                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Servings</div>
                                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: var(--color-neutral-text);">${recipe.servings}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 12px;">Ingredients</h3>
                        <ul style="margin: 0 0 24px 0; padding-left: 20px;">
                            ${ingredientsList.map(ing => `<li style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 6px;">${ing}</li>`).join('')}
                        </ul>

                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 12px;">Instructions</h3>
                        <ol style="margin: 0 0 24px 0; padding-left: 20px;">
                            ${instructionsList.map(inst => `<li style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 8px; line-height: 1.5;">${inst}</li>`).join('')}
                        </ol>

                        ${recipe.notes ? `
                            <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 12px;">Notes</h3>
                            <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); line-height: 1.6; white-space: pre-wrap;">${recipe.notes}</p>
                        ` : ''}
                    </div>

                    <div style="position: sticky; bottom: 0; background: white; border-top: 1px solid var(--color-neutral-border); padding: 16px; display: flex; gap: 8px; justify-content: flex-end;">
                        <button onclick="this.closest('.modal').remove()" style="padding: 10px 20px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function getExampleRecipes() {
            return [
                {
                    name: 'Classic Chicken Tacos',
                    cuisine: 'Mexican',
                    mealType: 'Dinner',
                    prepTime: 15,
                    cookTime: 20,
                    servings: 4,
                    ingredients: '1 lb chicken breast, diced\n8 small corn tortillas\n1 tbsp olive oil\n1 tsp cumin\n1 tsp chili powder\n1/2 tsp paprika\nSalt and pepper to taste\n1 cup shredded lettuce\n1/2 cup diced tomatoes\n1/2 cup shredded cheese\n1/4 cup sour cream\nFresh cilantro for garnish',
                    instructions: '1. Heat olive oil in a large skillet over medium-high heat\n2. Season chicken with cumin, chili powder, paprika, salt, and pepper\n3. Cook chicken for 8-10 minutes until golden and cooked through\n4. Warm tortillas in a dry skillet for 30 seconds per side\n5. Assemble tacos with chicken, lettuce, tomatoes, cheese, and sour cream\n6. Garnish with fresh cilantro and serve',
                    notes: 'Can substitute chicken with ground beef or black beans for vegetarian option',
                    createdAt: new Date().toISOString()
                },
                {
                    name: 'Spaghetti Carbonara',
                    cuisine: 'Italian',
                    mealType: 'Dinner',
                    prepTime: 10,
                    cookTime: 15,
                    servings: 4,
                    ingredients: '1 lb spaghetti\n6 oz pancetta or bacon, diced\n4 large eggs\n1 cup grated Parmesan cheese\n2 cloves garlic, minced\nSalt and black pepper to taste\nFresh parsley for garnish',
                    instructions: '1. Cook spaghetti according to package directions, reserve 1 cup pasta water\n2. While pasta cooks, crisp pancetta in a large skillet over medium heat\n3. In a bowl, whisk eggs and Parmesan cheese\n4. Add minced garlic to pancetta and cook for 1 minute\n5. Drain pasta and add to skillet with pancetta\n6. Remove from heat, add egg mixture, tossing quickly to create creamy sauce\n7. Add pasta water as needed to achieve desired consistency\n8. Season with salt and pepper, garnish with parsley',
                    notes: 'The key is to work quickly so eggs create a creamy sauce without scrambling',
                    createdAt: new Date().toISOString()
                },
                {
                    name: 'Blueberry Smoothie',
                    cuisine: 'American',
                    mealType: 'Breakfast',
                    prepTime: 5,
                    cookTime: 0,
                    servings: 2,
                    ingredients: '2 cups frozen blueberries\n1 banana\n1 cup Greek yogurt\n1/2 cup milk (dairy or non-dairy)\n1 tbsp honey\n1/2 tsp vanilla extract',
                    instructions: '1. Add all ingredients to blender\n2. Blend on high until smooth and creamy\n3. Add more milk if too thick\n4. Pour into glasses and serve immediately',
                    notes: 'Can add protein powder or spinach for extra nutrition',
                    createdAt: new Date().toISOString()
                },
                {
                    name: 'Chocolate Chip Cookies',
                    cuisine: 'American',
                    mealType: 'Dessert',
                    prepTime: 15,
                    cookTime: 12,
                    servings: 24,
                    ingredients: '2 1/4 cups all-purpose flour\n1 tsp baking soda\n1 tsp salt\n1 cup butter, softened\n3/4 cup granulated sugar\n3/4 cup packed brown sugar\n2 large eggs\n2 tsp vanilla extract\n2 cups chocolate chips',
                    instructions: '1. Preheat oven to 375°F\n2. Mix flour, baking soda, and salt in a bowl\n3. In another bowl, beat butter and both sugars until creamy\n4. Add eggs and vanilla, beat well\n5. Gradually blend in flour mixture\n6. Stir in chocolate chips\n7. Drop rounded tablespoons onto ungreased cookie sheets\n8. Bake 9-11 minutes until golden brown\n9. Cool on sheets for 2 minutes, then transfer to wire racks',
                    notes: 'For chewier cookies, slightly underbake. Store in airtight container for up to 1 week',
                    createdAt: new Date().toISOString()
                }
            ];
        }

        // ============================================
        // Finance Management
        // ============================================

        let financeAccounts = [];

        function loadFinanceAccounts() {
            const stored = localStorage.getItem('cleansheet_finance_personal');
            if (stored) {
                financeAccounts = JSON.parse(stored);
            } else {
                // Load example accounts
                financeAccounts = getExampleFinanceAccounts();
                saveFinanceAccountsToStorage();
            }
        }

        function saveFinanceAccountsToStorage() {
            localStorage.setItem('cleansheet_finance_personal', JSON.stringify(financeAccounts));
        }

        function openFinanceSlideout(section = null) {
            loadFinanceAccounts();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Finance';

            // Hide all other content sections (safe access)
            const contentSections = [
                'interviewPrepContent', 'behavioralContent', 'technicalContent',
                'jobOpportunitiesContent', 'careerExperienceContent', 'applicationMaterialsContent',
                'skillsCompetenciesContent', 'portfolioContent', 'projectsContent',
                'myNotesContent', 'calendarContent', 'recipesContent', 'financeContent', 'shoppingContent', 'tablesContent', 'formsContent',
                'documentsContent', 'reportsContent', 'templatesContent', 'workflowsContent'
            ];

            contentSections.forEach(sectionId => {
                const sectionEl = document.getElementById(sectionId);
                if (sectionEl) sectionEl.style.display = 'none';
            });

            // Show finance content
            document.getElementById('financeContent').style.display = 'block';

            // If section is provided, update filter to show that section
            if (section) {
                const filterSelect = document.getElementById('financeFilterSelect');
                if (filterSelect) {
                    // Map child node names to filter values
                    const sectionMap = {
                        'Insurance': 'Insurance',
                        'Cash Flow': 'Cash Flow',
                        'Assets': 'Asset',
                        'Liabilities': 'Liability',
                        'Investments': 'Investment'
                    };

                    const filterValue = sectionMap[section];
                    if (filterValue) {
                        filterSelect.value = filterValue;
                    }
                }
            }

            renderFinanceAccounts();
            updateFinanceSummary();

            slideout.classList.add('active');
        }

        function renderFinanceAccounts() {
            const container = document.getElementById('financeAccountsContainer');
            const filterType = document.getElementById('financeFilterSelect').value;

            const filteredAccounts = financeAccounts.filter(account => {
                return !filterType || account.type === filterType;
            });

            if (filteredAccounts.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text-light); text-align: center; padding: 40px;">No accounts found. Connect an institution or create a manual account.</p>';
                return;
            }

            container.innerHTML = filteredAccounts.map((account, index) => {
                const isNegative = account.type === 'Liability' || (account.type === 'Cash Flow' && account.subtype === 'Expense');
                const amountColor = isNegative ? '#ef4444' : '#16a34a';
                const bgColor = isNegative ? '#fee2e2' : '#dcfce7';
                const borderColor = isNegative ? '#ef4444' : '#16a34a';

                return `
                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 4px 0;">
                                    ${account.name}
                                </h3>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light);">
                                    ${account.institution || 'Manual Account'} • ${account.type}${account.subtype ? ` - ${account.subtype}` : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: ${amountColor};">
                                    ${isNegative ? '-' : ''}$${Math.abs(account.balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </div>
                            </div>
                        </div>

                        ${account.notes ? `
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-top: 8px; padding-top: 8px; border-top: 1px solid ${borderColor};">
                                ${account.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterFinanceAccounts() {
            renderFinanceAccounts();
        }

        function updateFinanceSummary() {
            const assets = financeAccounts
                .filter(a => a.type === 'Asset' || a.type === 'Investment')
                .reduce((sum, a) => sum + a.balance, 0);

            const liabilities = financeAccounts
                .filter(a => a.type === 'Liability')
                .reduce((sum, a) => sum + a.balance, 0);

            const netWorth = assets - liabilities;

            document.getElementById('totalAssets').textContent = `$${assets.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalLiabilities').textContent = `$${liabilities.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('netWorth').textContent = `$${netWorth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        let connectInstitutionTooltipTimeout;

        function showConnectInstitutionTooltip() {
            clearTimeout(connectInstitutionTooltipTimeout);
            document.getElementById('connectInstitutionTooltip').style.display = 'block';
        }

        function hideConnectInstitutionTooltip() {
            connectInstitutionTooltipTimeout = setTimeout(() => {
                document.getElementById('connectInstitutionTooltip').style.display = 'none';
            }, 200);
        }

        function keepConnectInstitutionTooltip() {
            clearTimeout(connectInstitutionTooltipTimeout);
        }

        function selectInstitution(institution) {
            alert(`Connection to ${institution} would require OAuth integration with a financial data aggregator like Plaid or MX. This is a demo placeholder.`);
            document.getElementById('connectInstitutionTooltip').style.display = 'none';
        }

        let manualAccountTooltipTimeout;

        function showManualAccountTooltip() {
            clearTimeout(manualAccountTooltipTimeout);
            document.getElementById('manualAccountTooltip').style.display = 'block';
        }

        function hideManualAccountTooltip() {
            manualAccountTooltipTimeout = setTimeout(() => {
                document.getElementById('manualAccountTooltip').style.display = 'none';
            }, 200);
        }

        function keepManualAccountTooltip() {
            clearTimeout(manualAccountTooltipTimeout);
        }

        function clearManualAccountTooltipForm() {
            document.getElementById('accountTypeTooltip').value = '';
            document.getElementById('accountNameTooltip').value = '';
            document.getElementById('accountInstitutionTooltip').value = '';
            document.getElementById('accountBalanceTooltip').value = '';
            document.getElementById('accountNotesTooltip').value = '';

            // Hide all type-specific fields
            document.getElementById('assetFieldsTooltip').style.display = 'none';
            document.getElementById('investmentFieldsTooltip').style.display = 'none';
            document.getElementById('cashFlowFieldsTooltip').style.display = 'none';
            document.getElementById('insuranceFieldsTooltip').style.display = 'none';
            document.getElementById('liabilityFieldsTooltip').style.display = 'none';
        }

        function updateAccountTypeFieldsTooltip() {
            const accountType = document.getElementById('accountTypeTooltip').value;

            // Hide all type-specific fields
            document.getElementById('assetFieldsTooltip').style.display = 'none';
            document.getElementById('investmentFieldsTooltip').style.display = 'none';
            document.getElementById('cashFlowFieldsTooltip').style.display = 'none';
            document.getElementById('insuranceFieldsTooltip').style.display = 'none';
            document.getElementById('liabilityFieldsTooltip').style.display = 'none';

            // Show relevant fields based on type
            if (accountType === 'Asset') {
                document.getElementById('assetFieldsTooltip').style.display = 'block';
            } else if (accountType === 'Investment') {
                document.getElementById('investmentFieldsTooltip').style.display = 'block';
            } else if (accountType === 'Cash Flow') {
                document.getElementById('cashFlowFieldsTooltip').style.display = 'block';
            } else if (accountType === 'Insurance') {
                document.getElementById('insuranceFieldsTooltip').style.display = 'block';
            } else if (accountType === 'Liability') {
                document.getElementById('liabilityFieldsTooltip').style.display = 'block';
            }
        }

        function saveFinanceAccountFromTooltip() {
            const type = document.getElementById('accountTypeTooltip').value;
            const name = document.getElementById('accountNameTooltip').value.trim();
            const institution = document.getElementById('accountInstitutionTooltip').value.trim();
            const balance = parseFloat(document.getElementById('accountBalanceTooltip').value) || 0;
            const notes = document.getElementById('accountNotesTooltip').value.trim();

            if (!type) {
                alert('Please select an account type');
                return;
            }

            if (!name) {
                alert('Please enter an account name');
                return;
            }

            const account = {
                type,
                name,
                institution,
                balance,
                notes,
                createdAt: new Date().toISOString()
            };

            // Add type-specific fields
            if (type === 'Asset') {
                account.subtype = document.getElementById('assetCategoryTooltip').value;
            } else if (type === 'Investment') {
                account.subtype = document.getElementById('investmentTypeTooltip').value;
            } else if (type === 'Cash Flow') {
                account.subtype = document.getElementById('cashFlowTypeTooltip').value;
                account.frequency = document.getElementById('cashFlowFrequencyTooltip').value;
            } else if (type === 'Insurance') {
                account.subtype = document.getElementById('insuranceTypeTooltip').value;
                account.policyNumber = document.getElementById('insurancePolicyNumberTooltip').value.trim();
                account.premium = parseFloat(document.getElementById('insurancePremiumTooltip').value) || 0;
            } else if (type === 'Liability') {
                account.subtype = document.getElementById('liabilityTypeTooltip').value;
                account.interestRate = parseFloat(document.getElementById('liabilityInterestRateTooltip').value) || 0;
                account.monthlyPayment = parseFloat(document.getElementById('liabilityPaymentTooltip').value) || 0;
            }

            financeAccounts.push(account);
            saveFinanceAccountsToStorage();
            renderFinanceAccounts();
            updateFinanceSummary();
            clearManualAccountTooltipForm();
            document.getElementById('manualAccountTooltip').style.display = 'none';
        }

        function getExampleFinanceAccounts() {
            return [
                {
                    type: 'Asset',
                    subtype: 'Checking',
                    name: 'Primary Checking',
                    institution: 'Chase',
                    balance: 5280.45,
                    notes: '',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Asset',
                    subtype: 'Savings',
                    name: 'Emergency Fund',
                    institution: 'Ally Bank',
                    balance: 15000.00,
                    notes: 'Target: $20,000',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Investment',
                    subtype: '401(k)',
                    name: 'Employer 401(k)',
                    institution: 'Fidelity',
                    balance: 87650.23,
                    notes: 'Contributing 6% with 3% match',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Asset',
                    subtype: 'Vehicle',
                    name: '2020 Honda Accord',
                    institution: '',
                    balance: 18500.00,
                    notes: 'Current market value',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Liability',
                    subtype: 'Credit Card',
                    name: 'Chase Sapphire Reserve',
                    institution: 'Chase',
                    balance: 1250.80,
                    interestRate: 18.99,
                    monthlyPayment: 250.00,
                    notes: '',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Liability',
                    subtype: 'Auto Loan',
                    name: 'Honda Auto Loan',
                    institution: 'Capital One Auto Finance',
                    balance: 12350.00,
                    interestRate: 3.99,
                    monthlyPayment: 385.00,
                    notes: '28 months remaining',
                    createdAt: new Date().toISOString()
                }
            ];
        }

        // Tables Management
        function openTablesSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Tables';

            // Hide all content sections
            hideAllContentSections();

            // Show tables content
            document.getElementById('tablesContent').style.display = 'block';
            loadTableTypeCards();

            slideout.classList.add('active');
        }

        function loadTableTypeCards() {
            const container = document.getElementById('tablesContainer');

            // Define table types relevant to different personas
            const tableTypes = [
                {
                    name: 'Contacts',
                    icon: 'ph-address-book',
                    description: 'People and organizations with contact information, roles, and relationships.',
                    columns: ['Name', 'Email', 'Phone', 'Company', 'Role', 'Location', 'Notes']
                },
                {
                    name: 'Customers',
                    icon: 'ph-users',
                    description: 'Customer records with account details, history, and engagement data.',
                    columns: ['Customer ID', 'Name', 'Email', 'Account Type', 'Status', 'Created Date', 'Lifetime Value']
                },
                {
                    name: 'Projects',
                    icon: 'ph-folder',
                    description: 'Project tracking with timelines, resources, and deliverables.',
                    columns: ['Project Name', 'Status', 'Start Date', 'End Date', 'Budget', 'Team', 'Priority']
                },
                {
                    name: 'Tasks',
                    icon: 'ph-check-square',
                    description: 'Task management with assignments, deadlines, and dependencies.',
                    columns: ['Task Name', 'Assigned To', 'Due Date', 'Status', 'Priority', 'Tags', 'Progress']
                },
                {
                    name: 'Inventory',
                    icon: 'ph-package',
                    description: 'Product or asset inventory with quantities, locations, and specifications.',
                    columns: ['Item Name', 'SKU', 'Quantity', 'Location', 'Supplier', 'Cost', 'Last Updated']
                },
                {
                    name: 'Vendors',
                    icon: 'ph-handshake',
                    description: 'Vendor and supplier information with contracts and performance metrics.',
                    columns: ['Vendor Name', 'Contact', 'Services', 'Contract Start', 'Contract End', 'Rating', 'Notes']
                },
                {
                    name: 'Events',
                    icon: 'ph-calendar',
                    description: 'Event planning and scheduling with attendees and logistics.',
                    columns: ['Event Name', 'Date', 'Time', 'Location', 'Attendees', 'Status', 'Budget']
                },
                {
                    name: 'Assets',
                    icon: 'ph-briefcase',
                    description: 'Equipment and resource tracking with maintenance and ownership.',
                    columns: ['Asset Name', 'Type', 'Owner', 'Location', 'Purchase Date', 'Value', 'Status']
                },
                {
                    name: 'Issues',
                    icon: 'ph-warning',
                    description: 'Issue and bug tracking with severity, assignments, and resolutions.',
                    columns: ['Issue ID', 'Title', 'Severity', 'Status', 'Assigned To', 'Created Date', 'Resolved Date']
                },
                {
                    name: 'Expenses',
                    icon: 'ph-receipt',
                    description: 'Expense tracking and reimbursement management.',
                    columns: ['Date', 'Category', 'Amount', 'Vendor', 'Payment Method', 'Status', 'Receipt']
                }
            ];

            container.innerHTML = '';

            tableTypes.forEach(table => {
                const card = document.createElement('div');
                card.style.cssText = 'padding: 20px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px;';

                card.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="ph ${table.icon}" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${table.name}</div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="event.stopPropagation(); editItem('${table.name}')" title="Edit" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-pencil-simple" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteItem('${table.name}')" title="Delete" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                            </button>
                            <button onclick="event.stopPropagation(); shareTable('${table.name}')" title="Share" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                        </div>
                    </div>
                    <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">
                        ${table.description}
                    </div>
                    <div style="margin-top: 4px;">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin-bottom: 8px;">Columns</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${table.columns.map(col => `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${col}</span>`).join('')}
                        </div>
                    </div>
                    <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">SHARED WITH</div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: var(--color-primary-blue);">AM</div>
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #f3e5f5; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: #7b1fa2;">JS</div>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">+ 3 others</span>
                        </div>
                    </div>
                `;

                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = 'var(--color-primary-blue)';
                    card.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.15)';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = 'var(--color-neutral-border)';
                    card.style.boxShadow = 'none';
                });

                card.addEventListener('click', () => {
                    alert(`${table.name} table functionality coming soon!`);
                });

                container.appendChild(card);
            });
        }

        function shareTable(tableName) {
            alert(`Share ${tableName} table functionality coming soon!`);
        }

        // Zoom control functions for ERD
        function showERDZoomControls() {
            const controls = document.getElementById('erdZoomControls');
            if (controls) {
                controls.style.opacity = '1';
                controls.style.pointerEvents = 'auto';
            }
        }

        function hideERDZoomControls() {
            const controls = document.getElementById('erdZoomControls');
            if (controls) {
                controls.style.opacity = '0';
                controls.style.pointerEvents = 'none';
            }
        }

        function updateZoomLevelIndicator(scale) {
            const indicator = document.getElementById('erdZoomLevel');
            if (indicator) {
                const percentage = Math.round(scale * 100);
                indicator.textContent = `${percentage}%`;

                // Color coding for different zoom levels
                if (percentage < 50) {
                    indicator.style.color = '#d32f2f'; // Red for very zoomed out
                } else if (percentage > 200) {
                    indicator.style.color = '#1976d2'; // Blue for very zoomed in
                } else {
                    indicator.style.color = 'var(--color-neutral-text)'; // Default
                }
            }
        }

        function zoomERD(action) {
            const container = document.getElementById('tablesERDContainer');
            const svg = container.querySelector('svg');
            if (!svg || !svg.zoomBehavior) {
                console.warn('ERD zoom not available - no SVG or zoom behavior found');
                return;
            }

            const zoomBehavior = svg.zoomBehavior;
            const svgSelection = d3.select(svg);

            switch (action) {
                case 'in':
                    svgSelection.transition()
                        .duration(300)
                        .call(zoomBehavior.scaleBy, 1.5);
                    break;
                case 'out':
                    svgSelection.transition()
                        .duration(300)
                        .call(zoomBehavior.scaleBy, 1/1.5);
                    break;
                case 'reset':
                    svgSelection.transition()
                        .duration(500)
                        .call(zoomBehavior.transform, d3.zoomIdentity);
                    break;
                case 'fit':
                    // Get bounds of all content
                    const zoomGroup = svg.querySelector('.zoom-group');
                    if (zoomGroup) {
                        try {
                            const bbox = zoomGroup.getBBox();
                            if (bbox.width > 0 && bbox.height > 0) {
                                const containerRect = container.getBoundingClientRect();
                                const padding = 50;
                                const scale = Math.min(
                                    (containerRect.width - padding * 2) / bbox.width,
                                    (containerRect.height - padding * 2) / bbox.height,
                                    2  // Max zoom level for fit
                                );
                                const centerX = containerRect.width / 2;
                                const centerY = containerRect.height / 2;
                                const x = centerX - (bbox.x + bbox.width / 2) * scale;
                                const y = centerY - (bbox.y + bbox.height / 2) * scale;

                                svgSelection.transition()
                                    .duration(750)
                                    .call(zoomBehavior.transform, d3.zoomIdentity.translate(x, y).scale(scale));
                            }
                        } catch (error) {
                            console.log('Fit to screen: content bounds not available, using reset');
                            zoomERD('reset');
                        }
                    }
                    break;
            }
        }

        // Switch between Cards and Relationships views in Tables
        function switchTablesView(view) {
            const cardsTab = document.getElementById('tablesCardsTab');
            const relationshipsTab = document.getElementById('tablesRelationshipsTab');
            const cardsView = document.getElementById('tablesCardsView');
            const relationshipsView = document.getElementById('tablesRelationshipsView');

            if (view === 'cards') {
                // Show cards view
                cardsView.style.display = 'block';
                relationshipsView.style.display = 'none';

                // Update tab styling
                cardsTab.style.borderBottom = '2px solid var(--color-primary-blue)';
                cardsTab.style.color = 'var(--color-primary-blue)';
                cardsTab.style.fontWeight = '600';

                relationshipsTab.style.borderBottom = '2px solid transparent';
                relationshipsTab.style.color = 'var(--color-neutral-text)';
                relationshipsTab.style.fontWeight = '400';
            } else if (view === 'relationships') {
                // Show relationships view
                cardsView.style.display = 'none';
                relationshipsView.style.display = 'block';

                // Update tab styling
                relationshipsTab.style.borderBottom = '2px solid var(--color-primary-blue)';
                relationshipsTab.style.color = 'var(--color-primary-blue)';
                relationshipsTab.style.fontWeight = '600';

                cardsTab.style.borderBottom = '2px solid transparent';
                cardsTab.style.color = 'var(--color-neutral-text)';
                cardsTab.style.fontWeight = '400';

                // Render ERD if not already rendered
                renderTablesERD();
            }
        }

        // Render Entity Relationship Diagram with force-directed layout
        function renderTablesERD() {
            const container = document.getElementById('tablesERDContainer');

            // Clear existing content
            container.innerHTML = '';

            // Load saved relationships from localStorage
            const savedRelationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');

            // Default table nodes (can be extended with saved schemas)
            const defaultNodes = [
                { id: 'contacts', name: 'Contacts', columns: ['ID', 'Name', 'Email', 'Phone', 'Company', 'Role'] },
                { id: 'customers', name: 'Customers', columns: ['Customer_ID', 'Name', 'Email', 'Account_Type', 'Status', 'Contact_ID'] },
                { id: 'projects', name: 'Projects', columns: ['Project_ID', 'Project_Name', 'Status', 'Start_Date', 'End_Date', 'Customer_ID'] },
                { id: 'tasks', name: 'Tasks', columns: ['Task_ID', 'Task_Name', 'Assigned_To_ID', 'Due_Date', 'Status', 'Project_ID'] },
                { id: 'inventory', name: 'Inventory', columns: ['Item_ID', 'Item_Name', 'SKU', 'Quantity', 'Location', 'Supplier_ID'] },
                { id: 'vendors', name: 'Vendors', columns: ['Vendor_ID', 'Vendor_Name', 'Contact', 'Services', 'Contract_Start'] },
                { id: 'events', name: 'Events', columns: ['Event_ID', 'Event_Name', 'Date', 'Time', 'Location', 'Project_ID'] },
                { id: 'assets', name: 'Assets', columns: ['Asset_ID', 'Asset_Name', 'Type', 'Owner_ID', 'Location', 'Vendor_ID'] },
                { id: 'issues', name: 'Issues', columns: ['Issue_ID', 'Title', 'Severity', 'Status', 'Assigned_To_ID', 'Project_ID'] },
                { id: 'expenses', name: 'Expenses', columns: ['Expense_ID', 'Date', 'Amount', 'Vendor_ID', 'Project_ID', 'Submitted_By_ID'] }
            ];

            // Load saved table schemas
            const savedTables = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');

            // Combine default and saved tables
            const allTableNames = new Set([...defaultNodes.map(n => n.id)]);
            savedTables.forEach(t => allTableNames.add(t.tableName));

            // Build nodes array
            const nodes = Array.from(allTableNames).map(tableName => {
                const defaultNode = defaultNodes.find(n => n.id === tableName);
                if (defaultNode) return defaultNode;

                const savedTable = savedTables.find(t => t.tableName === tableName);
                return {
                    id: tableName,
                    name: tableName,
                    columns: savedTable ? savedTable.columns.slice(0, 5).map(c => c.name) : ['No columns']
                };
            });

            // Convert saved relationships to links format
            const links = savedRelationships.map(rel => ({
                source: rel.sourceTable,
                target: rel.targetTable,
                type: rel.type,
                label: rel.label,
                sourceColumns: rel.sourceColumns || [],
                targetColumns: rel.targetColumns || []
            }));

            // If no relationships exist, show a helpful message
            if (links.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--color-neutral-text-light);">
                        <i class="ph ph-arrows-left-right" style="font-size: 64px; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-body); font-size: 16px; margin: 0 0 8px 0; font-weight: 600;">No Relationships Defined</p>
                        <p style="font-family: var(--font-family-body); font-size: 14px; margin: 0 0 20px 0; text-align: center; max-width: 400px;">
                            Click "Manage Relationships" above to define how your tables connect to each other.
                        </p>
                        <button onclick="openRelationshipManager()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-plus"></i> Add First Relationship
                        </button>
                    </div>
                `;
                return;
            }

            // Filter nodes to only include those that are in relationships
            const usedTableNames = new Set();
            links.forEach(link => {
                usedTableNames.add(link.source);
                usedTableNames.add(link.target);
            });
            const filteredNodes = nodes.filter(n => usedTableNames.has(n.id));

            const width = container.clientWidth;
            const height = container.clientHeight;

            // Create SVG with zoom functionality
            const svg = d3.select('#tablesERDContainer')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height])
                .attr('style', 'max-width: 100%; height: auto; cursor: grab;');

            // Create zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 5])
                .on('zoom', (event) => {
                    zoomGroup.attr('transform', event.transform);
                    // Update cursor based on zoom action
                    svg.style('cursor', event.sourceEvent?.type === 'wheel' ? 'zoom-in' : 'grabbing');
                    // Update zoom level indicator
                    updateZoomLevelIndicator(event.transform.k);
                })
                .on('end', () => {
                    svg.style('cursor', 'grab');
                });

            // Apply zoom behavior to SVG
            svg.call(zoom);

            // Create a group for all zoomable content
            const zoomGroup = svg.append('g')
                .attr('class', 'zoom-group');

            // Store zoom behavior for external control
            svg.zoomBehavior = zoom;

            // Create force simulation
            const simulation = d3.forceSimulation(filteredNodes)
                .force('link', d3.forceLink(links)
                    .id(d => d.id)
                    .distance(200)
                    .strength(0.5))
                .force('charge', d3.forceManyBody().strength(-800))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(150));

            // Create arrow marker for directed edges (stays in SVG defs, not zoomGroup)
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 130)
                .attr('refY', 0)
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#0066CC')
                .attr('opacity', 0.6);

            // Draw relationship lines (in zoomGroup)
            const linkGroup = zoomGroup.append('g').attr('class', 'relationships');

            // Create column-level connections
            const columnConnections = [];
            links.forEach(link => {
                if (link.sourceColumns.length > 0 && link.targetColumns.length > 0) {
                    // Create individual column-to-column connections
                    link.sourceColumns.forEach((sourceCol, idx) => {
                        const targetCol = link.targetColumns[idx];
                        if (targetCol) {
                            columnConnections.push({
                                ...link,
                                sourceColumn: sourceCol,
                                targetColumn: targetCol,
                                connectionIndex: idx,
                                totalConnections: link.sourceColumns.length
                            });
                        }
                    });
                } else {
                    // Fallback to table-level connection
                    columnConnections.push({
                        ...link,
                        sourceColumn: null,
                        targetColumn: null,
                        connectionIndex: 0,
                        totalConnections: 1
                    });
                }
            });

            const link = linkGroup.selectAll('path')
                .data(columnConnections)
                .join('path')
                .attr('stroke', d => d.sourceColumn ? '#0066CC' : '#666')
                .attr('stroke-width', d => d.sourceColumn ? 1.5 : 2)
                .attr('stroke-dasharray', d => d.type === 'many-to-one' ? '4,3' : '0')
                .attr('opacity', d => d.sourceColumn ? 0.8 : 0.6)
                .attr('marker-end', 'url(#arrowhead)')
                .attr('fill', 'none');

            // Add relationship labels (one per relationship, not per column)
            const linkLabels = linkGroup.selectAll('text')
                .data(links)
                .join('text')
                .attr('text-anchor', 'middle')
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '10px')
                .attr('fill', '#666')
                .attr('dy', -3)
                .text(d => {
                    if (d.sourceColumns.length > 0 && d.targetColumns.length > 0) {
                        const mappings = d.sourceColumns.map((col, i) =>
                            `${col}→${d.targetColumns[i] || '?'}`
                        ).join(', ');
                        return `${d.label} (${mappings})`;
                    }
                    return d.label;
                });

            // Draw table nodes (in zoomGroup)
            const nodeGroup = zoomGroup.append('g').attr('class', 'tables');

            const node = nodeGroup.selectAll('g')
                .data(filteredNodes)
                .join('g')
                .attr('cursor', 'grab')
                .call(drag(simulation));

            // Calculate node height based on number of columns
            filteredNodes.forEach(n => {
                n.height = 40 + (n.columns.length * 24);
            });

            // Table container (rounded rectangle)
            node.append('rect')
                .attr('width', 240)
                .attr('height', d => d.height)
                .attr('x', -120)
                .attr('y', d => -d.height / 2)
                .attr('rx', 8)
                .attr('ry', 8)
                .attr('fill', 'white')
                .attr('stroke', '#0066CC')
                .attr('stroke-width', 2);

            // Table header background
            node.append('rect')
                .attr('width', 240)
                .attr('height', 40)
                .attr('x', -120)
                .attr('y', d => -d.height / 2)
                .attr('rx', 8)
                .attr('ry', 8)
                .attr('fill', '#e3f2fd');

            // Table header divider
            node.append('line')
                .attr('x1', -120)
                .attr('y1', d => -d.height / 2 + 40)
                .attr('x2', 120)
                .attr('y2', d => -d.height / 2 + 40)
                .attr('stroke', '#0066CC')
                .attr('stroke-width', 2);

            // Table icon
            node.append('foreignObject')
                .attr('width', 20)
                .attr('height', 20)
                .attr('x', -108)
                .attr('y', d => -d.height / 2 + 10)
                .html('<i class="ph ph-table" style="font-size: 20px; color: #0066CC;"></i>');

            // Table name (clickable)
            node.append('text')
                .attr('x', -80)
                .attr('y', d => -d.height / 2 + 25)
                .attr('font-family', 'var(--font-family-heading)')
                .attr('font-size', '16px')
                .attr('font-weight', '600')
                .attr('fill', '#0066CC')
                .attr('cursor', 'pointer')
                .attr('text-decoration', 'underline')
                .text(d => d.name)
                .on('click', function(event, d) {
                    event.stopPropagation();
                    openTableEditor(d.name, d.id);
                })
                .on('mouseover', function() {
                    d3.select(this).attr('fill', '#004C99');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', '#0066CC');
                });

            // Create map of connected columns for highlighting
            const connectedColumns = new Map();
            links.forEach(link => {
                if (link.sourceColumns && link.targetColumns) {
                    // Mark source columns as connected
                    const sourceKey = link.source;
                    if (!connectedColumns.has(sourceKey)) connectedColumns.set(sourceKey, new Set());
                    link.sourceColumns.forEach(col => connectedColumns.get(sourceKey).add(col));

                    // Mark target columns as connected
                    const targetKey = link.target;
                    if (!connectedColumns.has(targetKey)) connectedColumns.set(targetKey, new Set());
                    link.targetColumns.forEach(col => connectedColumns.get(targetKey).add(col));
                }
            });

            // Table columns
            node.each(function(d) {
                const group = d3.select(this);
                const tableConnectedColumns = connectedColumns.get(d.id) || new Set();

                d.columns.forEach((col, idx) => {
                    const y = -d.height / 2 + 40 + (idx * 24) + 16;
                    const isConnected = tableConnectedColumns.has(col);

                    // Column background highlight for connected columns
                    if (isConnected) {
                        group.append('rect')
                            .attr('x', -116)
                            .attr('y', y - 12)
                            .attr('width', 232)
                            .attr('height', 20)
                            .attr('fill', '#e3f2fd')
                            .attr('rx', 3)
                            .attr('opacity', 0.7);
                    }

                    // Connection indicator dot
                    if (isConnected) {
                        group.append('circle')
                            .attr('cx', -104)
                            .attr('cy', y)
                            .attr('r', 3)
                            .attr('fill', '#0066CC')
                            .attr('stroke', 'white')
                            .attr('stroke-width', 1);
                    }

                    // Column name (clickable)
                    group.append('text')
                        .attr('x', -96)
                        .attr('y', y)
                        .attr('font-family', 'var(--font-family-body)')
                        .attr('font-size', '12px')
                        .attr('fill', isConnected ? '#0066CC' : '#333')
                        .attr('font-weight', isConnected ? '600' : '400')
                        .attr('cursor', 'pointer')
                        .text(col)
                        .on('click', function(event) {
                            event.stopPropagation();
                            openColumnEditor(d.name, d.id, col);
                        })
                        .on('mouseover', function() {
                            d3.select(this)
                                .attr('fill', '#004C99')
                                .attr('text-decoration', 'underline');
                        })
                        .on('mouseout', function() {
                            d3.select(this)
                                .attr('fill', isConnected ? '#0066CC' : '#333')
                                .attr('text-decoration', 'none');
                        });

                    // Show key icon for foreign keys (columns ending in _ID) or connected columns
                    if (col.endsWith('_ID') || isConnected) {
                        const iconType = isConnected && !col.endsWith('_ID') ? 'ph-link' : 'ph-key';
                        const iconColor = isConnected ? '#0066CC' : '#666';

                        group.append('foreignObject')
                            .attr('width', 14)
                            .attr('height', 14)
                            .attr('x', 100)
                            .attr('y', y - 10)
                            .html(`<i class="ph ${iconType}" style="font-size: 14px; color: ${iconColor};"></i>`);
                    }
                });
            });

            // Helper function to get column Y position
            function getColumnY(node, columnName) {
                if (!columnName) return 0; // Center of table
                const columnIndex = node.columns.indexOf(columnName);
                if (columnIndex === -1) return 0; // Column not found, use center
                return (-node.height / 2) + 40 + (columnIndex * 24) + 12; // Column center position
            }

            // Helper function to calculate bezier curve for column connections
            function calculateColumnPath(d) {
                const sourceNode = filteredNodes.find(n => n.id === d.source.id || n.id === d.source);
                const targetNode = filteredNodes.find(n => n.id === d.target.id || n.id === d.target);

                if (!sourceNode || !targetNode) return '';

                // Get actual node positions
                const sx = sourceNode.x || 0;
                const sy = sourceNode.y || 0;
                const tx = targetNode.x || 0;
                const ty = targetNode.y || 0;

                // Calculate column-specific positions
                const sourceColumnY = sy + getColumnY(sourceNode, d.sourceColumn);
                const targetColumnY = ty + getColumnY(targetNode, d.targetColumn);

                // Calculate connection points on table edges
                const sourceX = sx + (sx < tx ? 120 : -120); // Right or left edge
                const targetX = tx + (sx < tx ? -120 : 120); // Left or right edge

                // Create bezier curve for smooth column-to-column connections
                const midX = (sourceX + targetX) / 2;
                const offsetY = d.connectionIndex * 8 - (d.totalConnections - 1) * 4; // Spread multiple connections

                return `M ${sourceX},${sourceColumnY + offsetY}
                        C ${midX},${sourceColumnY + offsetY} ${midX},${targetColumnY + offsetY} ${targetX},${targetColumnY + offsetY}`;
            }

            // Update positions on each tick
            simulation.on('tick', () => {
                // Update column-level connection paths
                link.attr('d', d => {
                    if (d.sourceColumn && d.targetColumn) {
                        return calculateColumnPath(d);
                    } else {
                        // Fallback to simple straight line for table-level connections
                        return `M ${d.source.x},${d.source.y} L ${d.target.x},${d.target.y}`;
                    }
                });

                linkLabels
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag behavior
            function drag(simulation) {
                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                    d3.select(this).attr('cursor', 'grabbing');
                }

                function dragged(event) {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }

                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                    d3.select(this).attr('cursor', 'grab');
                }

                return d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended);
            }

            // Add legend
            const legend = svg.append('g')
                .attr('transform', `translate(20, ${height - 80})`);

            legend.append('rect')
                .attr('width', 220)
                .attr('height', 70)
                .attr('rx', 6)
                .attr('fill', 'white')
                .attr('stroke', '#e5e5e7')
                .attr('stroke-width', 1);

            legend.append('text')
                .attr('x', 10)
                .attr('y', 20)
                .attr('font-family', 'var(--font-family-heading)')
                .attr('font-size', '12px')
                .attr('font-weight', '600')
                .attr('fill', '#333')
                .text('Legend');

            legend.append('line')
                .attr('x1', 10)
                .attr('y1', 35)
                .attr('x2', 40)
                .attr('y2', 35)
                .attr('stroke', '#0066CC')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,5')
                .attr('opacity', 0.6);

            legend.append('text')
                .attr('x', 50)
                .attr('y', 39)
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '11px')
                .attr('fill', '#666')
                .text('Many-to-One (Drag to move)');

            legend.append('foreignObject')
                .attr('width', 14)
                .attr('height', 14)
                .attr('x', 10)
                .attr('y', 48)
                .html('<i class="ph ph-key" style="font-size: 14px; color: #666;"></i>');

            legend.append('text')
                .attr('x', 30)
                .attr('y', 60)
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '11px')
                .attr('fill', '#666')
                .text('Foreign Key');
        }

        // Table Wizard Functions
        let tableColumns = [];
        let columnIdCounter = 0;

        function openTableWizard() {
            tableColumns = [];
            columnIdCounter = 0;
            document.getElementById('schemaName').value = 'public';
            document.getElementById('tableName').value = '';
            document.getElementById('tableComment').value = '';
            document.getElementById('ifNotExists').checked = false;
            document.getElementById('temporary').checked = false;
            document.getElementById('unlogged').checked = false;
            document.getElementById('tableColumnsContainer').innerHTML = '';
            document.getElementById('sqlPreview').textContent = '-- Configure table above to see SQL';

            // Add initial id column
            addTableColumn({name: 'id', dataType: 'serial', primaryKey: true, notNull: true});

            openModal('tableWizardModal');
        }

        function addTableColumn(preset = null) {
            const id = columnIdCounter++;
            const col = preset || {
                name: '',
                dataType: 'text',
                notNull: false,
                primaryKey: false,
                unique: false,
                defaultValue: ''
            };

            tableColumns.push({id, ...col});

            const container = document.getElementById('tableColumnsContainer');
            const row = document.createElement('div');
            row.id = `column-${id}`;
            row.style.cssText = 'background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px; display: grid; grid-template-columns: 2fr 1.5fr 0.8fr 0.8fr 0.8fr 0.8fr auto; gap: 12px; align-items: center;';

            row.innerHTML = `
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        Column Name
                        <i class="ph ph-info" title="Name of the column - must be unique within the table" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="text" value="${col.name}" oninput="updateColumnProperty(${id}, 'name', this.value)" placeholder="column_name" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        Data Type
                        <i class="ph ph-info" title="PostgreSQL data type - determines what kind of data can be stored in this column" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <select onchange="handleDataTypeChange(${id}, this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        <option value="text" ${col.dataType === 'text' ? 'selected' : ''}>text</option>
                        <option value="varchar" ${col.dataType === 'varchar' ? 'selected' : ''}>varchar</option>
                        <option value="integer" ${col.dataType === 'integer' ? 'selected' : ''}>integer</option>
                        <option value="bigint" ${col.dataType === 'bigint' ? 'selected' : ''}>bigint</option>
                        <option value="serial" ${col.dataType === 'serial' ? 'selected' : ''}>serial</option>
                        <option value="bigserial" ${col.dataType === 'bigserial' ? 'selected' : ''}>bigserial</option>
                        <option value="boolean" ${col.dataType === 'boolean' ? 'selected' : ''}>boolean</option>
                        <option value="timestamp" ${col.dataType === 'timestamp' ? 'selected' : ''}>timestamp</option>
                        <option value="timestamptz" ${col.dataType === 'timestamptz' ? 'selected' : ''}>timestamptz</option>
                        <option value="date" ${col.dataType === 'date' ? 'selected' : ''}>date</option>
                        <option value="json" ${col.dataType === 'json' ? 'selected' : ''}>json</option>
                        <option value="jsonb" ${col.dataType === 'jsonb' ? 'selected' : ''}>jsonb</option>
                        <option value="uuid" ${col.dataType === 'uuid' ? 'selected' : ''}>uuid</option>
                        <option value="decimal" ${col.dataType === 'decimal' ? 'selected' : ''}>decimal</option>
                        <option value="real" ${col.dataType === 'real' ? 'selected' : ''}>real</option>
                        <option value="generated" ${col.dataType === 'generated' ? 'selected' : ''}>⚡ Generated Column</option>
                    </select>
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        NOT NULL
                        <i class="ph ph-info" title="Column must have a value - NULL values not allowed" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="checkbox" ${col.notNull ? 'checked' : ''} onchange="updateColumnProperty(${id}, 'notNull', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        PRIMARY KEY
                        <i class="ph ph-info" title="Uniquely identifies each row - only one per table, automatically creates index" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="checkbox" ${col.primaryKey ? 'checked' : ''} onchange="updateColumnProperty(${id}, 'primaryKey', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        UNIQUE
                        <i class="ph ph-info" title="All values in this column must be different - NULL values are allowed" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="checkbox" ${col.unique ? 'checked' : ''} onchange="updateColumnProperty(${id}, 'unique', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        FOREIGN KEY
                        <i class="ph ph-info" title="References a column in another table - enforces referential integrity" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="checkbox" ${col.foreignKey ? 'checked' : ''} onchange="toggleForeignKey(${id}, this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
                <div style="padding-top: 20px;">
                    <button onclick="removeTableColumn(${id})" title="Remove column" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                    </button>
                </div>
            `;

            // Add generated column configuration section (initially hidden)
            const generatedConfigId = `generated-config-${id}`;
            const generatedConfig = document.createElement('div');
            generatedConfig.id = generatedConfigId;
            generatedConfig.style.cssText = 'display: none; background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px; margin-top: 8px; gap: 12px;';
            generatedConfig.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <i class="ph ph-lightning" style="font-size: 20px; color: #f59e0b;"></i>
                    <h4 style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: #92400e; margin: 0;">Generated Column Configuration</h4>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            Result Type
                            <i class="ph ph-info" title="Data type for the computed result" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <select id="genType-${id}" onchange="updateColumnProperty(${id}, 'generatedType', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="text">text</option>
                            <option value="integer">integer</option>
                            <option value="bigint">bigint</option>
                            <option value="decimal">decimal</option>
                            <option value="boolean">boolean</option>
                            <option value="timestamp">timestamp</option>
                            <option value="date">date</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            Expression
                            <i class="ph ph-info" title="SQL expression to calculate this column's value (e.g., price * quantity)" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <input type="text" id="genExpr-${id}" placeholder="(price * quantity)" oninput="updateColumnProperty(${id}, 'generatedExpression', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; font-family: monospace;">
                    </div>
                </div>
                <div style="margin-top: 8px; padding: 8px 12px; background: white; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: #78716c;">
                    <strong>Examples:</strong> (first_name || ' ' || last_name), (price * quantity), (EXTRACT(YEAR FROM birth_date)), (UPPER(email))
                </div>
            `;

            // Add foreign key configuration section (initially hidden)
            const foreignKeyConfigId = `foreignkey-config-${id}`;
            const foreignKeyConfig = document.createElement('div');
            foreignKeyConfig.id = foreignKeyConfigId;
            foreignKeyConfig.style.cssText = 'display: none; background: #f0f9ff; border: 1px solid #0066CC; border-radius: 8px; padding: 16px; margin-top: 8px; gap: 12px;';
            foreignKeyConfig.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <i class="ph ph-link" style="font-size: 20px; color: #0066CC;"></i>
                    <h4 style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; margin: 0; color: var(--color-dark);">Foreign Key Configuration</h4>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            References Table
                            <i class="ph ph-info" title="The table this foreign key points to" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <select id="fkRefTable-${id}" onchange="updateForeignKeyProperty(${id}, 'refTable', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="">Select table...</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            References Column
                            <i class="ph ph-info" title="The column in the referenced table (usually primary key)" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <input type="text" id="fkRefColumn-${id}" value="${col.foreignKey?.refColumn || 'id'}" placeholder="e.g., id" oninput="updateForeignKeyProperty(${id}, 'refColumn', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            ON DELETE
                            <i class="ph ph-info" title="Action when referenced row is deleted" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <select id="fkOnDelete-${id}" onchange="updateForeignKeyProperty(${id}, 'onDelete', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="NO ACTION" ${col.foreignKey?.onDelete === 'NO ACTION' ? 'selected' : ''}>NO ACTION</option>
                            <option value="RESTRICT" ${col.foreignKey?.onDelete === 'RESTRICT' ? 'selected' : ''}>RESTRICT</option>
                            <option value="CASCADE" ${col.foreignKey?.onDelete === 'CASCADE' ? 'selected' : ''}>CASCADE</option>
                            <option value="SET NULL" ${col.foreignKey?.onDelete === 'SET NULL' ? 'selected' : ''}>SET NULL</option>
                            <option value="SET DEFAULT" ${col.foreignKey?.onDelete === 'SET DEFAULT' ? 'selected' : ''}>SET DEFAULT</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            ON UPDATE
                            <i class="ph ph-info" title="Action when referenced row is updated" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <select id="fkOnUpdate-${id}" onchange="updateForeignKeyProperty(${id}, 'onUpdate', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="NO ACTION" ${col.foreignKey?.onUpdate === 'NO ACTION' ? 'selected' : ''}>NO ACTION</option>
                            <option value="RESTRICT" ${col.foreignKey?.onUpdate === 'RESTRICT' ? 'selected' : ''}>RESTRICT</option>
                            <option value="CASCADE" ${col.foreignKey?.onUpdate === 'CASCADE' ? 'selected' : ''}>CASCADE</option>
                            <option value="SET NULL" ${col.foreignKey?.onUpdate === 'SET NULL' ? 'selected' : ''}>SET NULL</option>
                            <option value="SET DEFAULT" ${col.foreignKey?.onUpdate === 'SET DEFAULT' ? 'selected' : ''}>SET DEFAULT</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 8px; padding: 8px 12px; background: white; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: #78716c;">
                    <strong>Common pattern:</strong> CASCADE deletes related rows, SET NULL keeps rows but clears FK, RESTRICT prevents deletion
                </div>
            `;

            container.appendChild(row);
            container.appendChild(generatedConfig);
            container.appendChild(foreignKeyConfig);

            // Show generated config if this column is generated
            if (col.dataType === 'generated') {
                generatedConfig.style.display = 'block';
            }

            // Show foreign key config if this column is a foreign key
            if (col.foreignKey) {
                foreignKeyConfig.style.display = 'block';
                loadForeignKeyTableOptions(id, col.foreignKey.refTable);
            }

            updateSQLPreview();
        }

        function handleDataTypeChange(id, dataType) {
            const col = tableColumns.find(c => c.id === id);
            if (col) {
                col.dataType = dataType;

                // Show/hide generated column configuration
                const generatedConfig = document.getElementById(`generated-config-${id}`);
                if (generatedConfig) {
                    if (dataType === 'generated') {
                        generatedConfig.style.display = 'block';
                        // Initialize generated properties if not set
                        if (!col.generatedType) col.generatedType = 'text';
                        if (!col.generatedExpression) col.generatedExpression = '';
                    } else {
                        generatedConfig.style.display = 'none';
                    }
                }

                updateSQLPreview();
            }
        }

        function updateColumnProperty(id, property, value) {
            const col = tableColumns.find(c => c.id === id);
            if (col) {
                col[property] = value;
                updateSQLPreview();
            }
        }

        function toggleForeignKey(id, checked) {
            const col = tableColumns.find(c => c.id === id);
            if (col) {
                if (checked) {
                    col.foreignKey = {
                        refTable: '',
                        refColumn: 'id',
                        onDelete: 'NO ACTION',
                        onUpdate: 'NO ACTION'
                    };
                    document.getElementById(`foreignkey-config-${id}`).style.display = 'block';
                    loadForeignKeyTableOptions(id, '');
                } else {
                    delete col.foreignKey;
                    document.getElementById(`foreignkey-config-${id}`).style.display = 'none';
                }
                updateSQLPreview();
            }
        }

        function updateForeignKeyProperty(id, property, value) {
            const col = tableColumns.find(c => c.id === id);
            if (col && col.foreignKey) {
                col.foreignKey[property] = value;
                updateSQLPreview();
            }
        }

        function loadForeignKeyTableOptions(columnId, selectedTable) {
            const select = document.getElementById(`fkRefTable-${columnId}`);
            if (!select) return;

            // Load tables from saved schemas and defaults
            const savedTables = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');
            const defaultTables = ['contacts', 'customers', 'projects', 'tasks', 'vendors', 'expenses', 'users', 'products', 'orders'];

            const allTables = [...defaultTables, ...savedTables.map(t => t.tableName)];
            const uniqueTables = Array.from(new Set(allTables));

            select.innerHTML = '<option value="">Select table...</option>';
            uniqueTables.forEach(tableName => {
                const option = document.createElement('option');
                option.value = tableName;
                option.textContent = tableName;
                if (tableName === selectedTable) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function removeTableColumn(id) {
            const index = tableColumns.findIndex(c => c.id === id);
            if (index !== -1) {
                tableColumns.splice(index, 1);
                document.getElementById(`column-${id}`).remove();

                // Remove generated column config if it exists
                const genConfig = document.getElementById(`generated-config-${id}`);
                if (genConfig) genConfig.remove();

                // Remove foreign key config if it exists
                const fkConfig = document.getElementById(`foreignkey-config-${id}`);
                if (fkConfig) fkConfig.remove();

                updateSQLPreview();
            }
        }

        function updateSQLPreview() {
            const schemaName = document.getElementById('schemaName').value.trim() || 'public';
            const tableName = document.getElementById('tableName').value.trim();
            const comment = document.getElementById('tableComment').value.trim();
            const ifNotExists = document.getElementById('ifNotExists').checked;
            const temporary = document.getElementById('temporary').checked;
            const unlogged = document.getElementById('unlogged').checked;

            if (!tableName || tableColumns.length === 0) {
                document.getElementById('sqlPreview').textContent = '-- Configure table name and add columns to see SQL';
                return;
            }

            let sql = 'CREATE ';
            if (temporary) sql += 'TEMPORARY ';
            if (unlogged) sql += 'UNLOGGED ';
            sql += 'TABLE ';
            if (ifNotExists) sql += 'IF NOT EXISTS ';
            sql += `${schemaName}.${tableName} (\n`;

            const columnDefs = tableColumns.map(col => {
                if (col.dataType === 'generated') {
                    // Generated column syntax
                    const genType = col.generatedType || 'text';
                    const genExpr = col.generatedExpression || '(NULL)';
                    let def = `    ${col.name} ${genType.toUpperCase()} GENERATED ALWAYS AS ${genExpr} STORED`;
                    if (col.notNull) def += ' NOT NULL';
                    if (col.unique) def += ' UNIQUE';
                    return def;
                } else {
                    // Regular column syntax
                    let def = `    ${col.name} ${col.dataType.toUpperCase()}`;
                    if (col.notNull) def += ' NOT NULL';
                    if (col.unique) def += ' UNIQUE';
                    if (col.primaryKey) def += ' PRIMARY KEY';
                    return def;
                }
            });

            // Collect foreign key constraints
            const foreignKeys = tableColumns
                .filter(col => col.foreignKey && col.foreignKey.refTable)
                .map(col => {
                    const fk = col.foreignKey;
                    let constraint = `    CONSTRAINT fk_${tableName}_${col.name} FOREIGN KEY (${col.name}) `;
                    constraint += `REFERENCES ${fk.refTable}(${fk.refColumn})`;
                    if (fk.onDelete && fk.onDelete !== 'NO ACTION') {
                        constraint += ` ON DELETE ${fk.onDelete}`;
                    }
                    if (fk.onUpdate && fk.onUpdate !== 'NO ACTION') {
                        constraint += ` ON UPDATE ${fk.onUpdate}`;
                    }
                    return constraint;
                });

            // Combine columns and constraints
            const allDefs = [...columnDefs, ...foreignKeys];
            sql += allDefs.join(',\n');
            sql += '\n);';

            if (comment) {
                sql += `\n\nCOMMENT ON TABLE ${schemaName}.${tableName} IS '${comment.replace(/'/g, "''")}';`;
            }

            document.getElementById('sqlPreview').textContent = sql;
        }

        function saveTableSchema() {
            const tableName = document.getElementById('tableName').value.trim();
            if (!tableName) {
                alert('Please enter a table name');
                return;
            }
            if (tableColumns.length === 0) {
                alert('Please add at least one column');
                return;
            }

            const schema = {
                schemaName: document.getElementById('schemaName').value.trim() || 'public',
                tableName: tableName,
                comment: document.getElementById('tableComment').value.trim(),
                ifNotExists: document.getElementById('ifNotExists').checked,
                temporary: document.getElementById('temporary').checked,
                unlogged: document.getElementById('unlogged').checked,
                columns: tableColumns.map(col => ({
                    name: col.name,
                    dataType: col.dataType,
                    notNull: col.notNull || false,
                    primaryKey: col.primaryKey || false,
                    unique: col.unique || false,
                    foreignKey: col.foreignKey || null,
                    generatedType: col.generatedType || null,
                    generatedExpression: col.generatedExpression || null
                }))
            };

            // Save to localStorage
            const tables = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');
            tables.push({
                ...schema,
                created: new Date().toISOString()
            });
            localStorage.setItem('postgresTableSchemas', JSON.stringify(tables));

            alert(`Table schema "${tableName}" saved successfully!`);
            closeModal('tableWizardModal');
        }

        function exportTableSQL() {
            const sql = document.getElementById('sqlPreview').textContent;
            if (sql.startsWith('--')) {
                alert('Please configure the table first');
                return;
            }

            const tableName = document.getElementById('tableName').value.trim() || 'table';
            const blob = new Blob([sql], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${tableName}.sql`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Relationship Management Functions
        function openRelationshipManager() {
            openModal('relationshipManagerModal');
            loadTableOptions();
            loadRelationships();
        }

        function loadTableOptions() {
            // Load tables from saved schemas
            const savedTables = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');

            // Also use the hardcoded ERD tables as defaults
            const defaultTables = [
                { tableName: 'contacts' },
                { tableName: 'customers' },
                { tableName: 'projects' },
                { tableName: 'tasks' },
                { tableName: 'vendors' },
                { tableName: 'expenses' }
            ];

            const allTables = [...defaultTables, ...savedTables];
            const uniqueTables = Array.from(new Set(allTables.map(t => t.tableName)));

            const sourceSelect = document.getElementById('sourceTable');
            const targetSelect = document.getElementById('targetTable');

            // Clear existing options except the first one
            sourceSelect.innerHTML = '<option value="">Select table...</option>';
            targetSelect.innerHTML = '<option value="">Select table...</option>';

            // Add table options
            uniqueTables.forEach(tableName => {
                sourceSelect.innerHTML += `<option value="${tableName}">${tableName}</option>`;
                targetSelect.innerHTML += `<option value="${tableName}">${tableName}</option>`;
            });
        }

        function loadRelationships() {
            const relationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');
            const container = document.getElementById('relationshipsList');

            if (relationships.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-arrows-left-right" style="font-size: 48px; margin-bottom: 12px; display: block;"></i>
                        <p style="font-family: var(--font-family-body); font-size: 14px; margin: 0;">No relationships defined yet. Add your first relationship above.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = relationships.map((rel, index) => {
                // Create column mapping display
                let columnMapping = '';
                if (rel.sourceColumns && rel.targetColumns && rel.sourceColumns.length > 0) {
                    // Enhanced relationship with column mappings
                    const mappings = rel.sourceColumns.map((sourceCol, i) =>
                        `${sourceCol} → ${rel.targetColumns[i] || '?'}`
                    ).join(', ');
                    columnMapping = `
                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-primary-blue); background: #f0f8ff; padding: 6px 8px; border-radius: 4px; margin-top: 8px; font-weight: 500;">
                            <i class="ph ph-link" style="margin-right: 4px;"></i>Column mapping: ${mappings}
                        </div>
                    `;
                } else {
                    // Legacy relationship without column mappings
                    columnMapping = `
                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); background: #fff3cd; padding: 6px 8px; border-radius: 4px; margin-top: 8px; font-style: italic;">
                            <i class="ph ph-warning" style="margin-right: 4px; color: #f59e0b;"></i>Legacy relationship - no column mapping defined
                        </div>
                    `;
                }

                // Add constraint name if available
                let constraintInfo = '';
                if (rel.constraintName) {
                    constraintInfo = `
                        <div style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text-light); margin-top: 4px;">
                            <i class="ph ph-key" style="margin-right: 4px;"></i>Constraint: ${rel.constraintName}
                        </div>
                    `;
                }

                return `
                    <div style="background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; align-items: flex-start; justify-content: space-between;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; color: var(--color-dark);">
                                    ${rel.sourceTable}
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 12px; background: #e3f2fd; border-radius: 12px;">
                                    <i class="ph ph-arrow-right" style="font-size: 14px; color: var(--color-primary-blue);"></i>
                                    <span style="font-family: var(--font-family-body); font-size: 11px; font-weight: 600; color: var(--color-primary-blue);">${rel.type.toUpperCase()}</span>
                                </div>
                                <div style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; color: var(--color-dark);">
                                    ${rel.targetTable}
                                </div>
                            </div>
                            <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light); padding-left: 4px;">
                                <i class="ph ph-quotes" style="margin-right: 4px;"></i>${rel.label}
                            </div>
                            ${columnMapping}
                            ${constraintInfo}
                        </div>
                        <div style="display: flex; gap: 8px; align-self: flex-start;">
                            <button onclick="editRelationship(${index})" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; color: var(--color-neutral-text);" title="Edit relationship">
                                <i class="ph ph-pencil"></i> Edit
                            </button>
                            <button onclick="deleteRelationship(${index})" style="padding: 6px 12px; background: white; border: 1px solid #dc2626; border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; color: #dc2626;" title="Delete relationship">
                                <i class="ph ph-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addRelationship() {
            const sourceTable = document.getElementById('sourceTable').value;
            const targetTable = document.getElementById('targetTable').value;
            const type = document.getElementById('relationshipType').value;
            const label = document.getElementById('relationshipLabel').value.trim();

            // Get selected columns from our arrays
            const sourceColumns = [...selectedSourceColumns];
            const targetColumns = [...selectedTargetColumns];

            // Enhanced validation
            if (!sourceTable) {
                alert('Please select a source table');
                return;
            }
            if (!targetTable) {
                alert('Please select a target table');
                return;
            }
            if (sourceTable === targetTable) {
                alert('Source and target tables must be different');
                return;
            }
            if (sourceColumns.length === 0) {
                alert('Please select at least one source column');
                return;
            }
            if (targetColumns.length === 0) {
                alert('Please select at least one target column');
                return;
            }
            if (sourceColumns.length !== targetColumns.length) {
                alert('Source and target must have the same number of columns selected');
                return;
            }
            if (!label) {
                alert('Please enter a relationship label');
                return;
            }

            // Validate column compatibility
            const validationResult = validateColumnCompatibility(sourceTable, sourceColumns, targetTable, targetColumns);
            if (!validationResult.valid) {
                alert(`Column compatibility issue: ${validationResult.message}`);
                return;
            }

            // Check for duplicate relationships
            const relationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');
            const isDuplicate = relationships.some(rel =>
                rel.sourceTable === sourceTable &&
                rel.targetTable === targetTable &&
                JSON.stringify(rel.sourceColumns || []) === JSON.stringify(sourceColumns) &&
                JSON.stringify(rel.targetColumns || []) === JSON.stringify(targetColumns)
            );

            if (isDuplicate) {
                alert('A relationship with these exact column mappings already exists');
                return;
            }

            // Generate constraint name
            const constraintName = generateConstraintName(sourceTable, targetTable, sourceColumns);

            const relationship = {
                id: generateUUID(),
                sourceTable,
                sourceColumns,
                targetTable,
                targetColumns,
                type,
                label,
                constraintName,
                onDelete: 'CASCADE', // Default referential action
                onUpdate: 'CASCADE', // Default referential action
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };

            // Save to localStorage
            relationships.push(relationship);
            localStorage.setItem('tableRelationships', JSON.stringify(relationships));

            // Clear form
            clearRelationshipForm();

            // Reload list
            loadRelationships();

            // Update ERD if it's visible
            if (document.getElementById('tablesRelationshipsView').style.display !== 'none') {
                renderTablesERD();
            }

            // Show success message with details
            const columnMapping = sourceColumns.map((col, i) => `${col} → ${targetColumns[i]}`).join(', ');
            showToast(`Relationship added: ${sourceTable}.${columnMapping} → ${targetTable}`, 'success');
        }

        function clearRelationshipForm() {
            document.getElementById('sourceTable').value = '';
            document.getElementById('targetTable').value = '';
            document.getElementById('relationshipType').value = 'many-to-one';
            document.getElementById('relationshipLabel').value = '';

            // Clear selected columns arrays
            selectedSourceColumns = [];
            selectedTargetColumns = [];

            // Reset column containers
            const sourceContainer = document.getElementById('sourceColumnsContainer');
            const targetContainer = document.getElementById('targetColumnsContainer');

            sourceContainer.innerHTML = 'Select source table first';
            sourceContainer.style.background = '#f8f8f8';
            sourceContainer.style.justifyContent = 'center';
            sourceContainer.style.alignItems = 'center';
            sourceContainer.style.display = 'flex';

            targetContainer.innerHTML = 'Select target table first';
            targetContainer.style.background = '#f8f8f8';
            targetContainer.style.justifyContent = 'center';
            targetContainer.style.alignItems = 'center';
            targetContainer.style.display = 'flex';

            // Reset preview
            document.getElementById('relationshipPreview').textContent = 'MAPS TO';
            document.getElementById('relationshipPreview').style.color = 'var(--color-neutral-text)';
        }

        function validateColumnCompatibility(sourceTable, sourceColumns, targetTable, targetColumns) {
            const sourceTableColumns = getColumnsForRelationships(sourceTable);
            const targetTableColumns = getColumnsForRelationships(targetTable);

            for (let i = 0; i < sourceColumns.length; i++) {
                const sourceCol = sourceTableColumns.find(c => c.name === sourceColumns[i]);
                const targetCol = targetTableColumns.find(c => c.name === targetColumns[i]);

                if (!sourceCol) {
                    return { valid: false, message: `Source column '${sourceColumns[i]}' not found in table '${sourceTable}'` };
                }

                if (!targetCol) {
                    return { valid: false, message: `Target column '${targetColumns[i]}' not found in table '${targetTable}'` };
                }

                // Basic type compatibility check
                const sourceType = normalizeDataType(sourceCol.type);
                const targetType = normalizeDataType(targetCol.type);

                if (sourceType !== targetType) {
                    return {
                        valid: false,
                        message: `Column types don't match: ${sourceColumns[i]} (${sourceCol.type}) → ${targetColumns[i]} (${targetCol.type})`
                    };
                }
            }

            return { valid: true };
        }

        function normalizeDataType(type) {
            // Normalize PostgreSQL data types for compatibility checking
            const typeStr = type.toLowerCase();

            // UUID types
            if (typeStr.includes('uuid')) return 'uuid';

            // Integer types
            if (typeStr.includes('int') || typeStr.includes('serial')) return 'integer';

            // Text/varchar types
            if (typeStr.includes('varchar') || typeStr.includes('char') || typeStr.includes('text')) return 'text';

            // Decimal/numeric types
            if (typeStr.includes('decimal') || typeStr.includes('numeric') || typeStr.includes('money')) return 'numeric';

            // Date/time types
            if (typeStr.includes('timestamp') || typeStr.includes('date') || typeStr.includes('time')) return 'timestamp';

            // Boolean
            if (typeStr.includes('bool')) return 'boolean';

            return typeStr;
        }

        function generateConstraintName(sourceTable, targetTable, sourceColumns) {
            const sourcePrefix = sourceTable.toLowerCase().substring(0, 3);
            const targetPrefix = targetTable.toLowerCase().substring(0, 3);
            const columnSuffix = sourceColumns.length === 1 ?
                sourceColumns[0].substring(0, 4) :
                sourceColumns.length.toString();

            return `fk_${sourcePrefix}_${targetPrefix}_${columnSuffix}`;
        }

        // Column Selection Functions for Relationships
        let selectedSourceColumns = [];
        let selectedTargetColumns = [];

        function updateSourceColumns() {
            const sourceTable = document.getElementById('sourceTable').value;
            const container = document.getElementById('sourceColumnsContainer');

            selectedSourceColumns = [];

            if (!sourceTable) {
                container.innerHTML = 'Select source table first';
                container.style.background = '#f8f8f8';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.display = 'flex';
                updateRelationshipPreview();
                return;
            }

            const columns = getColumnsForRelationships(sourceTable);

            if (columns.length === 0) {
                // Debug: Show what we're looking for
                console.log('Debug: No columns found for sourceTable:', sourceTable);
                console.log('Debug: Available in existing function:', getColumnsForTable(sourceTable));

                container.innerHTML = `No columns found for table "${sourceTable}"<br><small style="color: #666;">Check browser console for debug info</small>`;
                container.style.background = '#fff3cd';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.display = 'flex';
                updateRelationshipPreview();
                return;
            }

            // Create column selection interface
            container.style.background = 'white';
            container.style.justifyContent = 'flex-start';
            container.style.alignItems = 'flex-start';
            container.style.display = 'block';

            container.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${columns.map(column => `
                        <div class="column-selector" data-column="${column.name}" onclick="toggleSourceColumn('${column.name}', this)" style="
                            padding: 6px 12px;
                            border: 1px solid var(--color-neutral-border);
                            border-radius: 16px;
                            background: white;
                            cursor: pointer;
                            font-family: var(--font-family-body);
                            font-size: 12px;
                            color: var(--color-dark);
                            transition: all 0.2s;
                            user-select: none;
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        ">
                            <span style="font-weight: 600;">${column.name}</span>
                            <span style="color: var(--color-neutral-text-light);">(${column.type})</span>
                            ${column.isPrimaryKey ? '<i class="ph ph-key" style="color: var(--color-primary-blue); font-size: 10px;" title="Primary Key"></i>' : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            updateRelationshipPreview();
        }

        function updateTargetColumns() {
            const targetTable = document.getElementById('targetTable').value;
            const container = document.getElementById('targetColumnsContainer');

            selectedTargetColumns = [];

            if (!targetTable) {
                container.innerHTML = 'Select target table first';
                container.style.background = '#f8f8f8';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.display = 'flex';
                updateRelationshipPreview();
                return;
            }

            const columns = getColumnsForRelationships(targetTable);

            if (columns.length === 0) {
                // Debug: Show what we're looking for
                console.log('Debug: No columns found for targetTable:', targetTable);
                console.log('Debug: Available in existing function:', getColumnsForTable(targetTable));

                container.innerHTML = `No columns found for table "${targetTable}"<br><small style="color: #666;">Check browser console for debug info</small>`;
                container.style.background = '#fff3cd';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.display = 'flex';
                updateRelationshipPreview();
                return;
            }

            // Create column selection interface
            container.style.background = 'white';
            container.style.justifyContent = 'flex-start';
            container.style.alignItems = 'flex-start';
            container.style.display = 'block';

            container.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${columns.map(column => `
                        <div class="column-selector" data-column="${column.name}" onclick="toggleTargetColumn('${column.name}', this)" style="
                            padding: 6px 12px;
                            border: 1px solid var(--color-neutral-border);
                            border-radius: 16px;
                            background: white;
                            cursor: pointer;
                            font-family: var(--font-family-body);
                            font-size: 12px;
                            color: var(--color-dark);
                            transition: all 0.2s;
                            user-select: none;
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        ">
                            <span style="font-weight: 600;">${column.name}</span>
                            <span style="color: var(--color-neutral-text-light);">(${column.type})</span>
                            ${column.isPrimaryKey ? '<i class="ph ph-key" style="color: var(--color-primary-blue); font-size: 10px;" title="Primary Key"></i>' : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            // Auto-select primary key columns
            columns.forEach(column => {
                if (column.isPrimaryKey) {
                    const element = container.querySelector(`[data-column="${column.name}"]`);
                    if (element) {
                        toggleTargetColumn(column.name, element);
                    }
                }
            });

            updateRelationshipPreview();
        }

        function toggleSourceColumn(columnName, element) {
            const index = selectedSourceColumns.indexOf(columnName);
            if (index > -1) {
                // Deselect
                selectedSourceColumns.splice(index, 1);
                element.style.background = 'white';
                element.style.borderColor = 'var(--color-neutral-border)';
                element.style.color = 'var(--color-dark)';
            } else {
                // Select
                selectedSourceColumns.push(columnName);
                element.style.background = 'var(--color-primary-blue)';
                element.style.borderColor = 'var(--color-primary-blue)';
                element.style.color = 'white';
            }
            updateRelationshipPreview();
        }

        function toggleTargetColumn(columnName, element) {
            const index = selectedTargetColumns.indexOf(columnName);
            if (index > -1) {
                // Deselect
                selectedTargetColumns.splice(index, 1);
                element.style.background = 'white';
                element.style.borderColor = 'var(--color-neutral-border)';
                element.style.color = 'var(--color-dark)';
            } else {
                // Select
                selectedTargetColumns.push(columnName);
                element.style.background = 'var(--color-primary-blue)';
                element.style.borderColor = 'var(--color-primary-blue)';
                element.style.color = 'white';
            }
            updateRelationshipPreview();
        }

        function updateRelationshipPreview() {
            const sourceTable = document.getElementById('sourceTable').value;
            const targetTable = document.getElementById('targetTable').value;
            const relationshipType = document.getElementById('relationshipType').value;

            const previewDiv = document.getElementById('relationshipPreview');

            if (!sourceTable || !targetTable) {
                previewDiv.textContent = 'MAPS TO';
                previewDiv.style.color = 'var(--color-neutral-text)';
                return;
            }

            let preview = '';
            if (selectedSourceColumns.length > 0 && selectedTargetColumns.length > 0) {
                const sourceText = selectedSourceColumns.join(', ');
                const targetText = selectedTargetColumns.join(', ');
                const typeSymbol = relationshipType === 'many-to-one' ? 'M:1' :
                                 relationshipType === 'one-to-one' ? '1:1' : 'M:M';

                preview = `${sourceText} → (${typeSymbol}) → ${targetText}`;
                previewDiv.style.color = 'var(--color-primary-blue)';
            } else {
                preview = 'SELECT COLUMNS';
                previewDiv.style.color = 'var(--color-neutral-text)';
            }

            previewDiv.textContent = preview;
        }

        // Enhanced getColumnsForRelationships function that works with both stored schemas and defaults
        function getColumnsForRelationships(tableName) {
            // First check stored PostgreSQL schemas
            const savedSchemas = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');
            const savedSchema = savedSchemas.find(schema =>
                schema.tableName.toLowerCase() === tableName.toLowerCase()
            );

            if (savedSchema && savedSchema.columns) {
                return savedSchema.columns.map(col => ({
                    name: col.name,
                    type: col.dataType || col.type || 'text',
                    nullable: col.nullable !== false,
                    isPrimaryKey: col.isPrimaryKey || false,
                    isUnique: col.isUnique || false
                }));
            }

            // Use the existing function for default tables but handle case variations
            // Try title case first (what the function expects)
            const titleCaseName = tableName.charAt(0).toUpperCase() + tableName.slice(1).toLowerCase();
            let existingColumns = getColumnsForTable(titleCaseName);

            // If that doesn't work, try the original name
            if (!existingColumns || existingColumns.length === 0) {
                existingColumns = getColumnsForTable(tableName);
            }

            if (existingColumns && existingColumns.length > 0) {
                return existingColumns.map(colName => {
                    // Detect common patterns for primary keys and types
                    const isPrimaryKey = colName.toLowerCase().includes('_id') || colName.toLowerCase() === 'id';
                    const type = isPrimaryKey ? 'uuid' :
                                colName.toLowerCase().includes('date') ? 'date' :
                                colName.toLowerCase().includes('email') ? 'varchar(100)' :
                                colName.toLowerCase().includes('name') ? 'varchar(100)' :
                                colName.toLowerCase().includes('phone') ? 'varchar(20)' :
                                'text';

                    return {
                        name: colName,
                        type: type,
                        isPrimaryKey: isPrimaryKey,
                        nullable: !isPrimaryKey,
                        isUnique: false
                    };
                });
            }

            return [];
        }

        function editRelationship(index) {
            const relationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');
            const rel = relationships[index];

            if (!rel) return;

            // Populate form with existing values
            document.getElementById('sourceTable').value = rel.sourceTable;
            document.getElementById('targetTable').value = rel.targetTable;
            document.getElementById('relationshipType').value = rel.type;
            document.getElementById('relationshipLabel').value = rel.label;

            // Update columns and select them if they exist in the new format
            updateSourceColumns();
            updateTargetColumns();

            // Select the previously saved columns (for enhanced relationships)
            if (rel.sourceColumns && rel.sourceColumns.length > 0) {
                selectedSourceColumns = [...rel.sourceColumns];
                // Re-render and select the columns
                setTimeout(() => {
                    rel.sourceColumns.forEach(columnName => {
                        const element = document.querySelector(`#sourceColumnsContainer [data-column="${columnName}"]`);
                        if (element) {
                            element.style.background = 'var(--color-primary-blue)';
                            element.style.borderColor = 'var(--color-primary-blue)';
                            element.style.color = 'white';
                        }
                    });
                }, 50);
            }

            if (rel.targetColumns && rel.targetColumns.length > 0) {
                selectedTargetColumns = [...rel.targetColumns];
                // Re-render and select the columns
                setTimeout(() => {
                    rel.targetColumns.forEach(columnName => {
                        const element = document.querySelector(`#targetColumnsContainer [data-column="${columnName}"]`);
                        if (element) {
                            element.style.background = 'var(--color-primary-blue)';
                            element.style.borderColor = 'var(--color-primary-blue)';
                            element.style.color = 'white';
                        }
                    });
                }, 50);
            }

            updateRelationshipPreview();

            // Delete the old one (we'll add the edited version when user clicks Add)
            deleteRelationship(index, true);

            // Scroll to top
            document.querySelector('#relationshipManagerModal .modal-body').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRelationship(index, skipConfirm = false) {
            if (!skipConfirm && !confirm('Are you sure you want to delete this relationship?')) {
                return;
            }

            const relationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');
            relationships.splice(index, 1);
            localStorage.setItem('tableRelationships', JSON.stringify(relationships));

            // Reload list
            loadRelationships();

            // Update ERD if it's visible
            if (document.getElementById('tablesRelationshipsView').style.display !== 'none') {
                renderTablesERD();
            }

            if (!skipConfirm) {
                showToast('Relationship deleted', 'success');
            }
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: ${type === 'success' ? '#16a34a' : '#0066CC'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-family: var(--font-family-body);
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideInUp 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutDown 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Table Guided Setup Functions
        let currentTableGuidedStep = 1;
        let selectedTableTemplate = null;

        const tableTemplates = {
            inventory: {
                name: 'Inventory Management',
                tableName: 'inventory_items',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'item_name', dataType: 'varchar', notNull: true },
                    { name: 'sku', dataType: 'varchar', unique: true },
                    { name: 'quantity', dataType: 'integer', notNull: true },
                    { name: 'location', dataType: 'varchar' },
                    { name: 'supplier', dataType: 'varchar' },
                    { name: 'reorder_point', dataType: 'integer' },
                    { name: 'unit_cost', dataType: 'decimal' },
                    { name: 'last_updated', dataType: 'timestamptz' }
                ]
            },
            calendar: {
                name: 'Event Calendar',
                tableName: 'events',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'event_name', dataType: 'varchar', notNull: true },
                    { name: 'event_date', dataType: 'date', notNull: true },
                    { name: 'event_time', dataType: 'time' },
                    { name: 'attendees', dataType: 'text' },
                    { name: 'location', dataType: 'varchar' },
                    { name: 'status', dataType: 'varchar' },
                    { name: 'reminder_sent', dataType: 'boolean' },
                    { name: 'created_at', dataType: 'timestamptz' }
                ]
            },
            backlog: {
                name: 'Sprint Backlog',
                tableName: 'backlog_items',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'title', dataType: 'varchar', notNull: true },
                    { name: 'description', dataType: 'text' },
                    { name: 'priority', dataType: 'varchar' },
                    { name: 'story_points', dataType: 'integer' },
                    { name: 'assignee', dataType: 'varchar' },
                    { name: 'sprint', dataType: 'varchar' },
                    { name: 'status', dataType: 'varchar', notNull: true },
                    { name: 'created_at', dataType: 'timestamptz' }
                ]
            },
            assets: {
                name: 'Asset Management',
                tableName: 'assets',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'asset_name', dataType: 'varchar', notNull: true },
                    { name: 'asset_type', dataType: 'varchar' },
                    { name: 'owner', dataType: 'varchar' },
                    { name: 'purchase_date', dataType: 'date' },
                    { name: 'purchase_value', dataType: 'decimal' },
                    { name: 'current_value', dataType: 'decimal' },
                    { name: 'location', dataType: 'varchar' },
                    { name: 'status', dataType: 'varchar' }
                ]
            },
            wip: {
                name: 'Work in Progress',
                tableName: 'wip_projects',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'project_name', dataType: 'varchar', notNull: true },
                    { name: 'description', dataType: 'text' },
                    { name: 'status', dataType: 'varchar', notNull: true },
                    { name: 'progress_percent', dataType: 'integer' },
                    { name: 'due_date', dataType: 'date' },
                    { name: 'owner', dataType: 'varchar' },
                    { name: 'started_at', dataType: 'timestamptz' },
                    { name: 'completed_at', dataType: 'timestamptz' }
                ]
            },
            contacts: {
                name: 'Contacts & CRM',
                tableName: 'contacts',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'full_name', dataType: 'varchar', notNull: true },
                    { name: 'email', dataType: 'varchar', unique: true },
                    { name: 'phone', dataType: 'varchar' },
                    { name: 'company', dataType: 'varchar' },
                    { name: 'role', dataType: 'varchar' },
                    { name: 'notes', dataType: 'text' },
                    { name: 'last_contacted', dataType: 'date' },
                    { name: 'created_at', dataType: 'timestamptz' }
                ]
            }
        };

        function openTableGuidedSetup() {
            const modal = document.getElementById('tableGuidedSetupModal');
            currentTableGuidedStep = 1;
            selectedTableTemplate = null;

            // Reset form
            document.getElementById('guidedTableName').value = '';
            document.querySelectorAll('[data-table-template]').forEach(card => card.classList.remove('selected'));

            updateTableGuidedStep(1);
            modal.classList.add('active');
        }

        function closeTableGuidedSetup() {
            const modal = document.getElementById('tableGuidedSetupModal');
            modal.classList.remove('active');
        }

        function selectTableTemplate(template) {
            selectedTableTemplate = template;

            // Update visual selection
            document.querySelectorAll('[data-table-template]').forEach(card => {
                if (card.dataset.tableTemplate === template) {
                    card.classList.add('selected');
                    card.querySelector('.template-check').style.display = 'block';
                } else {
                    card.classList.remove('selected');
                    card.querySelector('.template-check').style.display = 'none';
                }
            });

            // Pre-fill table name in step 2
            const templateData = tableTemplates[template];
            if (templateData) {
                document.getElementById('guidedTableName').value = templateData.tableName;
            }
        }

        function updateTableGuidedStep(step) {
            currentTableGuidedStep = step;

            // Update progress bar
            const progressPercent = (step / 3) * 100;
            document.getElementById('tableGuidedProgressFill').style.width = progressPercent + '%';
            document.getElementById('tableGuidedProgressText').textContent = `Step ${step} of 3`;

            // Update step content visibility
            for (let i = 1; i <= 3; i++) {
                const stepContent = document.getElementById(`tableGuidedStep${i}`);
                if (stepContent) {
                    if (i === step) {
                        stepContent.classList.add('active');
                    } else {
                        stepContent.classList.remove('active');
                    }
                }
            }

            // Update button visibility
            const backBtn = document.getElementById('tableGuidedBackBtn');
            const continueBtn = document.getElementById('tableGuidedContinueBtn');
            const createBtn = document.getElementById('tableGuidedCreateBtn');

            backBtn.style.display = step === 1 ? 'none' : 'block';

            if (step === 3) {
                continueBtn.style.display = 'none';
                createBtn.style.display = 'flex';
                updateTableGuidedReview();
            } else {
                continueBtn.style.display = 'flex';
                createBtn.style.display = 'none';
            }

            // Update step 2 columns preview
            if (step === 2 && selectedTableTemplate) {
                updateColumnsPreview();
            }
        }

        function updateColumnsPreview() {
            const templateData = tableTemplates[selectedTableTemplate];
            if (!templateData) return;

            const container = document.getElementById('guidedColumnsContent');
            container.innerHTML = templateData.columns.map(col => {
                const badges = [];
                if (col.primaryKey) badges.push('<span style="padding: 2px 6px; background: #dbeafe; color: #1e40af; border-radius: 3px; font-size: 9px; font-weight: 600;">PRIMARY KEY</span>');
                if (col.notNull) badges.push('<span style="padding: 2px 6px; background: #fee2e2; color: #991b1b; border-radius: 3px; font-size: 9px; font-weight: 600;">NOT NULL</span>');
                if (col.unique) badges.push('<span style="padding: 2px 6px; background: #fef3c7; color: #92400e; border-radius: 3px; font-size: 9px; font-weight: 600;">UNIQUE</span>');

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: white; border-radius: 6px; border: 1px solid var(--color-neutral-border);">
                        <div style="flex: 1;">
                            <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">${col.name}</span>
                            <span style="margin-left: 12px; font-family: monospace; font-size: 12px; color: var(--color-neutral-text);">${col.dataType.toUpperCase()}</span>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            ${badges.join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTableGuidedReview() {
            const templateData = tableTemplates[selectedTableTemplate];
            const tableName = document.getElementById('guidedTableName').value.trim() || templateData.tableName;

            const reviewContainer = document.getElementById('guidedTableReview');
            reviewContainer.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Table Name</h5>
                    <div style="font-family: monospace; font-size: 15px; color: var(--color-primary-blue); font-weight: 600;">public.${tableName}</div>
                </div>
                <div>
                    <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">Columns (${templateData.columns.length})</h5>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${templateData.columns.map(col => {
                            const badges = [];
                            if (col.primaryKey) badges.push('<span style="padding: 2px 6px; background: #dbeafe; color: #1e40af; border-radius: 3px; font-size: 9px; font-weight: 600;">PK</span>');
                            if (col.notNull) badges.push('<span style="padding: 2px 6px; background: #fee2e2; color: #991b1b; border-radius: 3px; font-size: 9px; font-weight: 600;">NOT NULL</span>');
                            if (col.unique) badges.push('<span style="padding: 2px 6px; background: #fef3c7; color: #92400e; border-radius: 3px; font-size: 9px; font-weight: 600;">UNIQUE</span>');

                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: white; border-radius: 6px;">
                                    <div style="flex: 1;">
                                        <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">${col.name}</span>
                                        <span style="margin-left: 12px; font-family: monospace; font-size: 12px; color: var(--color-neutral-text);">${col.dataType.toUpperCase()}</span>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        ${badges.join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function nextTableGuidedStep() {
            if (currentTableGuidedStep === 1 && !selectedTableTemplate) {
                alert('Please select a table template');
                return;
            }

            if (currentTableGuidedStep === 2) {
                const tableName = document.getElementById('guidedTableName').value.trim();
                if (!tableName) {
                    alert('Please enter a table name');
                    return;
                }
            }

            if (currentTableGuidedStep < 3) {
                updateTableGuidedStep(currentTableGuidedStep + 1);
            }
        }

        function previousTableGuidedStep() {
            if (currentTableGuidedStep > 1) {
                updateTableGuidedStep(currentTableGuidedStep - 1);
            }
        }

        function createTableFromGuided() {
            const templateData = tableTemplates[selectedTableTemplate];
            const tableName = document.getElementById('guidedTableName').value.trim() || templateData.tableName;

            // Populate the main table wizard with this configuration
            tableColumns = [];
            columnIdCounter = 0;

            document.getElementById('schemaName').value = 'public';
            document.getElementById('tableName').value = tableName;
            document.getElementById('tableComment').value = `${templateData.name} table created via guided setup`;
            document.getElementById('ifNotExists').checked = true;
            document.getElementById('temporary').checked = false;
            document.getElementById('unlogged').checked = false;
            document.getElementById('tableColumnsContainer').innerHTML = '';

            // Add all columns from template
            templateData.columns.forEach(col => {
                addTableColumn(col);
            });

            // Close guided setup and open main wizard
            closeTableGuidedSetup();
            openModal('tableWizardModal');
        }

        // Forms Management
        function openFormsSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Forms';

            // Hide all content sections
            hideAllContentSections();

            // Show forms content
            document.getElementById('formsContent').style.display = 'block';
            loadFormTypeCards();

            slideout.classList.add('active');
        }

        function loadFormTypeCards() {
            const container = document.getElementById('formsContainer');

            const formTypes = [
                {
                    name: 'Contact Forms',
                    icon: 'ph-envelope',
                    description: 'Customer inquiry forms, feedback forms, and contact requests.',
                    tags: ['Customer Service', 'Sales', 'Support']
                },
                {
                    name: 'Survey Forms',
                    icon: 'ph-chart-line',
                    description: 'Employee surveys, customer satisfaction, and feedback collection.',
                    tags: ['HR', 'Customer Success', 'Marketing']
                },
                {
                    name: 'Registration Forms',
                    icon: 'ph-user-plus',
                    description: 'Event registration, account creation, and user onboarding.',
                    tags: ['Events', 'Marketing', 'Operations']
                },
                {
                    name: 'Application Forms',
                    icon: 'ph-file-text',
                    description: 'Job applications, program applications, and request forms.',
                    tags: ['HR', 'Recruiting', 'Operations']
                },
                {
                    name: 'Order Forms',
                    icon: 'ph-shopping-cart',
                    description: 'Product orders, service requests, and purchase forms.',
                    tags: ['Sales', 'E-commerce', 'Operations']
                },
                {
                    name: 'Feedback Forms',
                    icon: 'ph-chat-circle-dots',
                    description: 'Product feedback, service reviews, and suggestion forms.',
                    tags: ['Product', 'Customer Success', 'Quality']
                }
            ];

            createCardGrid(container, formTypes, 'Form');
        }

        // Documents Management
        function openDocumentsSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Documents';

            // Hide all content sections
            hideAllContentSections();

            // Show documents content
            document.getElementById('documentsContent').style.display = 'block';
            loadDocumentTypeCards();

            slideout.classList.add('active');
        }

        function loadDocumentTypeCards() {
            const container = document.getElementById('documentsContainer');

            const documentTypes = [
                {
                    name: 'Proposals',
                    icon: 'ph-file-text',
                    description: 'Business proposals, project bids, and RFP responses.',
                    tags: ['Business', 'Sales', 'Contracts']
                },
                {
                    name: 'Contracts',
                    icon: 'ph-file-doc',
                    description: 'Legal agreements, NDAs, and service contracts.',
                    tags: ['Legal', 'Compliance', 'Business']
                },
                {
                    name: 'Presentations',
                    icon: 'ph-presentation',
                    description: 'Slide decks, pitch presentations, and meeting materials.',
                    tags: ['Marketing', 'Sales', 'Internal']
                },
                {
                    name: 'Policies',
                    icon: 'ph-book',
                    description: 'Company policies, procedures, and guidelines.',
                    tags: ['HR', 'Compliance', 'Operations']
                },
                {
                    name: 'Manuals',
                    icon: 'ph-notebook',
                    description: 'User guides, training materials, and documentation.',
                    tags: ['Training', 'Support', 'Operations']
                },
                {
                    name: 'Invoices',
                    icon: 'ph-receipt',
                    description: 'Billing documents, invoices, and payment records.',
                    tags: ['Finance', 'Accounting', 'Business']
                }
            ];

            createCardGrid(container, documentTypes, 'Document');
        }

        // Reports Management
        function openReportsSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Reports';

            // Hide all content sections
            hideAllContentSections();

            // Show reports content
            document.getElementById('reportsContent').style.display = 'block';
            loadReportTypeCards();

            slideout.classList.add('active');
        }

        function loadReportTypeCards() {
            const container = document.getElementById('reportsContainer');

            const reportTypes = [
                {
                    name: 'Sales Dashboard',
                    icon: 'ph-chart-line',
                    description: 'Revenue tracking, pipeline analysis, and sales performance metrics.',
                    tags: ['Sales', 'Revenue', 'KPIs']
                },
                {
                    name: 'Financial Reports',
                    icon: 'ph-currency-dollar',
                    description: 'P&L statements, balance sheets, and cash flow analysis.',
                    tags: ['Finance', 'Accounting', 'Executive']
                },
                {
                    name: 'Project Status',
                    icon: 'ph-kanban',
                    description: 'Project timelines, milestone tracking, and resource utilization.',
                    tags: ['Projects', 'Operations', 'Management']
                },
                {
                    name: 'Customer Analytics',
                    icon: 'ph-users-three',
                    description: 'Customer behavior, retention rates, and satisfaction scores.',
                    tags: ['Customer Success', 'Analytics', 'Marketing']
                },
                {
                    name: 'Performance Metrics',
                    icon: 'ph-gauge',
                    description: 'Team performance, productivity tracking, and OKR progress.',
                    tags: ['HR', 'Management', 'Operations']
                },
                {
                    name: 'Marketing Analytics',
                    icon: 'ph-megaphone',
                    description: 'Campaign performance, lead generation, and conversion rates.',
                    tags: ['Marketing', 'Analytics', 'Sales']
                }
            ];

            createCardGrid(container, reportTypes, 'Report');
        }

        // Templates Management
        function openTemplatesSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Templates';

            // Hide all content sections
            hideAllContentSections();

            // Show templates content
            document.getElementById('templatesContent').style.display = 'block';
            loadTemplateTypeCards();

            slideout.classList.add('active');
        }

        function loadTemplateTypeCards() {
            const container = document.getElementById('templatesContainer');

            const templateTypes = [
                {
                    name: 'Email Templates',
                    icon: 'ph-envelope',
                    description: 'Pre-written emails for common business communications.',
                    tags: ['Communication', 'Sales', 'Support']
                },
                {
                    name: 'Meeting Agendas',
                    icon: 'ph-calendar-check',
                    description: 'Structured agendas for meetings and planning sessions.',
                    tags: ['Meetings', 'Operations', 'Management']
                },
                {
                    name: 'Report Templates',
                    icon: 'ph-file-chart',
                    description: 'Standardized formats for recurring reports and analysis.',
                    tags: ['Reporting', 'Analytics', 'Executive']
                },
                {
                    name: 'Onboarding Checklists',
                    icon: 'ph-user-plus',
                    description: 'Step-by-step guides for employee onboarding processes.',
                    tags: ['HR', 'Training', 'Operations']
                },
                {
                    name: 'Project Plans',
                    icon: 'ph-folder-notch',
                    description: 'Project planning templates with timelines and deliverables.',
                    tags: ['Projects', 'Management', 'Operations']
                },
                {
                    name: 'SOP Documents',
                    icon: 'ph-list-checks',
                    description: 'Standard operating procedure templates for processes.',
                    tags: ['Operations', 'Compliance', 'Training']
                }
            ];

            createCardGrid(container, templateTypes, 'Template');
        }

        // Pipelines Management
        function openPipelinesSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'ML Pipelines';

            // Hide all content sections
            hideAllContentSections();

            // Show pipelines content
            document.getElementById('pipelinesContent').style.display = 'block';
            loadPipelineCards();

            slideout.classList.add('active');
        }

        function loadPipelineCards() {
            const container = document.getElementById('pipelinesContainer');

            const pipelineTypes = [
                {
                    name: 'Cleansheet Content Pipeline',
                    icon: 'ph-flow-arrow',
                    description: 'AI-powered content transformation from corpus to multi-format, multi-language delivery with interactive NL interfaces.',
                    tags: ['Content', 'ML Processing', 'Multi-format']
                },
                {
                    name: 'Document Intelligence Pipeline',
                    icon: 'ph-file-magnifying-glass',
                    description: 'Extract, analyze, and classify documents using OCR, NLP, and entity recognition for automated processing.',
                    tags: ['OCR', 'NLP', 'Classification']
                },
                {
                    name: 'Customer Analytics Pipeline',
                    icon: 'ph-chart-line-up',
                    description: 'Real-time customer behavior analysis with sentiment detection, churn prediction, and recommendation generation.',
                    tags: ['Analytics', 'Prediction', 'Real-time']
                },
                {
                    name: 'Image Recognition Pipeline',
                    icon: 'ph-image',
                    description: 'Computer vision pipeline for object detection, facial recognition, and automated image tagging and categorization.',
                    tags: ['Computer Vision', 'Detection', 'Tagging']
                },
                {
                    name: 'Voice Processing Pipeline',
                    icon: 'ph-microphone',
                    description: 'Speech-to-text transcription, voice authentication, and natural language understanding for voice applications.',
                    tags: ['Speech', 'Transcription', 'NLU']
                }
            ];

            createCardGrid(container, pipelineTypes, 'Pipeline');
        }

        // Pipeline Wizard Functions
        let currentWizardStep = 1;
        let selectedSource = null;

        function openPipelineWizard() {
            const modal = document.getElementById('pipelineWizardModal');
            currentWizardStep = 1;
            selectedSource = null;

            // Reset form
            document.getElementById('pipelineName').value = '';
            document.getElementById('pipelineType').value = '';
            document.getElementById('pipelineDescription').value = '';
            document.getElementById('pipelineTags').value = '';
            document.getElementById('llmProvider').value = '';
            document.getElementById('processingFrequency').value = 'realtime';
            document.getElementById('batchSize').value = '100';
            document.getElementById('errorHandling').value = 'retry';
            document.getElementById('enableLogging').checked = true;
            document.getElementById('enableMetrics').checked = true;
            document.getElementById('customParams').value = '';
            document.getElementById('outputFormat').value = 'json';
            document.getElementById('notificationEmails').value = '';

            // Clear output checkboxes
            document.querySelectorAll('.output-destination').forEach(cb => cb.checked = false);

            // Clear source selection
            document.querySelectorAll('.source-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('sourceDetails').style.display = 'none';

            updateWizardStep(1);
            modal.classList.add('active');
        }

        function closePipelineWizard() {
            const modal = document.getElementById('pipelineWizardModal');
            modal.classList.remove('active');
        }

        function updateWizardStep(step) {
            currentWizardStep = step;

            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach((stepEl, index) => {
                const stepNum = index + 1;
                if (stepNum < step) {
                    stepEl.classList.add('completed');
                    stepEl.classList.remove('active');
                } else if (stepNum === step) {
                    stepEl.classList.add('active');
                    stepEl.classList.remove('completed');
                } else {
                    stepEl.classList.remove('active', 'completed');
                }
            });

            // Update step content visibility
            document.querySelectorAll('.wizard-step-content').forEach((content, index) => {
                if (index + 1 === step) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            // Update button visibility
            const prevBtn = document.getElementById('wizardPrevBtn');
            const nextBtn = document.getElementById('wizardNextBtn');
            const finishBtn = document.getElementById('wizardFinishBtn');

            prevBtn.style.display = step === 1 ? 'none' : 'block';

            if (step === 4) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                finishBtn.style.display = 'none';
            }
        }

        function nextWizardStep() {
            // Basic validation
            if (currentWizardStep === 1) {
                const name = document.getElementById('pipelineName').value.trim();
                const type = document.getElementById('pipelineType').value;

                if (!name || !type) {
                    alert('Please fill in all required fields (Pipeline Name and Type)');
                    return;
                }
            }

            if (currentWizardStep === 2) {
                if (!selectedSource) {
                    alert('Please select an input source');
                    return;
                }
            }

            if (currentWizardStep === 4) {
                const outputDestinations = document.querySelectorAll('.output-destination:checked');
                if (outputDestinations.length === 0) {
                    alert('Please select at least one output destination');
                    return;
                }
            }

            if (currentWizardStep < 4) {
                updateWizardStep(currentWizardStep + 1);
            }
        }

        function previousWizardStep() {
            if (currentWizardStep > 1) {
                updateWizardStep(currentWizardStep - 1);
            }
        }

        function selectSource(sourceType) {
            selectedSource = sourceType;

            // Update visual selection
            document.querySelectorAll('.source-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.source-option').classList.add('selected');

            // Show source-specific configuration
            const detailsDiv = document.getElementById('sourceDetails');
            detailsDiv.style.display = 'block';

            let configHTML = '';

            switch(sourceType) {
                case 'file':
                    configHTML = `
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">File Service</label>
                            <select style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                                <option value="">Select service...</option>
                                <option value="dropbox">Dropbox</option>
                                <option value="onedrive">OneDrive</option>
                                <option value="googledrive">Google Drive</option>
                                <option value="box">Box</option>
                                <option value="sharepoint">SharePoint</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Folder Path</label>
                            <input type="text" placeholder="/pipelines/input" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    `;
                    break;
                case 'database':
                    configHTML = `
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Database Type</label>
                            <select style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                                <option value="">Select type...</option>
                                <option value="sql">Azure SQL Database</option>
                                <option value="cosmos">Cosmos DB</option>
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mongodb">MongoDB</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Connection String</label>
                            <input type="password" placeholder="Server=..." style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    `;
                    break;
                case 'api':
                    configHTML = `
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">API Endpoint URL</label>
                            <input type="url" placeholder="https://api.example.com/data" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Authentication</label>
                            <select style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                                <option value="none">None</option>
                                <option value="apikey">API Key</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="oauth">OAuth 2.0</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'stream':
                    configHTML = `
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Stream Type</label>
                            <select style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                                <option value="">Select type...</option>
                                <option value="eventhub">Azure Event Hub</option>
                                <option value="kafka">Apache Kafka</option>
                                <option value="iothub">IoT Hub</option>
                                <option value="servicebus">Service Bus</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Connection String</label>
                            <input type="password" placeholder="Endpoint=..." style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    `;
                    break;
            }

            detailsDiv.innerHTML = configHTML;
        }

        function finishPipelineWizard() {
            // Validate final step
            const outputDestinations = document.querySelectorAll('.output-destination:checked');
            if (outputDestinations.length === 0) {
                alert('Please select at least one output destination');
                return;
            }

            // Collect all form data
            const pipelineData = {
                name: document.getElementById('pipelineName').value,
                type: document.getElementById('pipelineType').value,
                description: document.getElementById('pipelineDescription').value,
                tags: document.getElementById('pipelineTags').value.split(',').map(t => t.trim()).filter(t => t),
                source: selectedSource,
                llmProvider: document.getElementById('llmProvider').value,
                processingFrequency: document.getElementById('processingFrequency').value,
                batchSize: parseInt(document.getElementById('batchSize').value),
                errorHandling: document.getElementById('errorHandling').value,
                enableLogging: document.getElementById('enableLogging').checked,
                enableMetrics: document.getElementById('enableMetrics').checked,
                customParams: document.getElementById('customParams').value,
                outputFormat: document.getElementById('outputFormat').value,
                outputDestinations: Array.from(outputDestinations).map(cb => cb.value),
                notificationEmails: document.getElementById('notificationEmails').value.split(',').map(e => e.trim()).filter(e => e),
                createdAt: new Date().toISOString()
            };

            console.log('Pipeline created:', pipelineData);

            // Show success message
            alert(`Pipeline "${pipelineData.name}" created successfully!`);

            // Close wizard
            closePipelineWizard();

            // Reload pipeline cards to show the new pipeline
            // In production, this would make an API call to save the pipeline
            loadPipelineCards();
        }

        // Close wizard when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const wizardModal = document.getElementById('pipelineWizardModal');
            if (wizardModal) {
                wizardModal.addEventListener('click', function(e) {
                    if (e.target === wizardModal) {
                        closePipelineWizard();
                    }
                });
            }

            // Close simple wizard when clicking outside
            const simpleWizardModal = document.getElementById('simplePipelineWizardModal');
            if (simpleWizardModal) {
                simpleWizardModal.addEventListener('click', function(e) {
                    if (e.target === simpleWizardModal) {
                        closeSimplePipelineWizard();
                    }
                });
            }
        });

        // Simple Pipeline Wizard Functions
        let currentSimpleStep = 1;
        let selectedTemplate = null;
        let selectedSimpleSourceType = null;
        let selectedFrequencyType = 'manual';

        function openSimplePipelineWizard() {
            const modal = document.getElementById('simplePipelineWizardModal');
            currentSimpleStep = 1;
            selectedTemplate = null;
            selectedSimpleSourceType = null;
            selectedFrequencyType = 'manual';

            // Reset form
            document.getElementById('simplePipelineName').value = '';
            document.querySelectorAll('.template-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.simple-source-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('scheduleOptions').style.display = 'none';
            document.getElementById('simpleSourceHelp').style.display = 'none';

            // Show modal first
            modal.classList.add('active');

            // Then update step with a small delay to ensure DOM is ready
            setTimeout(() => {
                updateSimpleWizardStep(1);
            }, 10);
        }

        function closeSimplePipelineWizard() {
            const modal = document.getElementById('simplePipelineWizardModal');
            modal.classList.remove('active');
        }

        function updateSimpleWizardStep(step) {
            currentSimpleStep = step;

            try {
                // Update progress bar
                const progressPercent = (step / 4) * 100;
                const progressFill = document.getElementById('simpleProgressFill');
                const progressText = document.getElementById('simpleProgressText');

                if (progressFill) progressFill.style.width = progressPercent + '%';
                if (progressText) progressText.textContent = `Step ${step} of 4`;

                // Update step content visibility - be more explicit about which modal
                const modal = document.getElementById('simplePipelineWizardModal');
                if (modal) {
                    const stepContents = modal.querySelectorAll('.simple-wizard-step-content');
                    stepContents.forEach((content, index) => {
                        if (index + 1 === step) {
                            content.style.display = 'block';
                            content.classList.add('active');
                        } else {
                            content.style.display = 'none';
                            content.classList.remove('active');
                        }
                    });
                }

                // Update button visibility
                const backBtn = document.getElementById('simpleWizardBackBtn');
                const continueBtn = document.getElementById('simpleWizardContinueBtn');
                const createBtn = document.getElementById('simpleWizardCreateBtn');

                if (backBtn) backBtn.style.display = step === 1 ? 'none' : 'block';

                if (step === 4) {
                    if (continueBtn) continueBtn.style.display = 'none';
                    if (createBtn) createBtn.style.display = 'flex';
                    // Update review summary
                    updateReviewSummary();
                } else {
                    if (continueBtn) continueBtn.style.display = 'flex';
                    if (createBtn) createBtn.style.display = 'none';
                }

                console.log(`Simple wizard step ${step} updated - found ${modal?.querySelectorAll('.simple-wizard-step-content').length} step elements`);

            } catch (error) {
                console.error('Error in updateSimpleWizardStep:', error);
            }
        }

        function selectTemplate(template) {
            selectedTemplate = template;

            // Update visual selection
            document.querySelectorAll('.template-card').forEach(card => {
                if (card.dataset.template === template) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        function selectFrequency(frequency) {
            selectedFrequencyType = frequency;

            // Show/hide schedule options
            if (frequency === 'automatic') {
                document.getElementById('scheduleOptions').style.display = 'block';
            } else {
                document.getElementById('scheduleOptions').style.display = 'none';
            }
        }

        function selectSimpleSource(source) {
            selectedSimpleSourceType = source;

            // Update visual selection
            document.querySelectorAll('.simple-source-card').forEach(card => {
                if (card.dataset.source === source) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            // Show helpful text
            const helpDiv = document.getElementById('simpleSourceHelp');
            const helpText = document.getElementById('simpleSourceHelpText');
            helpDiv.style.display = 'block';

            const helpMessages = {
                'dropbox': 'After creating your pipeline, you\'ll connect your Dropbox account and choose which folder to monitor.',
                'onedrive': 'After creating your pipeline, you\'ll sign in to Microsoft and select your OneDrive folder.',
                'googledrive': 'After creating your pipeline, you\'ll connect your Google account and choose the folder to watch.',
                'computer': 'After creating your pipeline, you\'ll be able to upload files directly from your computer.'
            };

            helpText.textContent = helpMessages[source] || '';
        }

        function nextSimpleWizardStep() {
            // Validation for each step
            if (currentSimpleStep === 1) {
                if (!selectedTemplate) {
                    alert('Please choose a pipeline template to continue');
                    return;
                }
            }

            if (currentSimpleStep === 2) {
                const name = document.getElementById('simplePipelineName').value.trim();
                if (!name) {
                    alert('Please give your pipeline a name');
                    return;
                }
            }

            if (currentSimpleStep === 3) {
                if (!selectedSimpleSourceType) {
                    alert('Please choose where your data is stored');
                    return;
                }
            }

            if (currentSimpleStep < 4) {
                updateSimpleWizardStep(currentSimpleStep + 1);
            }
        }

        function previousSimpleWizardStep() {
            if (currentSimpleStep > 1) {
                updateSimpleWizardStep(currentSimpleStep - 1);
            }
        }

        function updateReviewSummary() {
            // Template
            const templateNames = {
                'content': 'Content Transformation',
                'data': 'Data Analysis',
                'image': 'Image Processing'
            };
            document.getElementById('reviewTemplate').textContent = templateNames[selectedTemplate] || 'Not selected';

            // Name
            document.getElementById('reviewName').textContent = document.getElementById('simplePipelineName').value || 'Unnamed Pipeline';

            // Schedule
            let scheduleText = 'Manual (you start it when needed)';
            if (selectedFrequencyType === 'automatic') {
                const schedule = document.getElementById('simpleSchedule').value;
                const scheduleTexts = {
                    'hourly': 'Automatic - Every hour',
                    'daily': 'Automatic - Once a day',
                    'weekly': 'Automatic - Once a week'
                };
                scheduleText = scheduleTexts[schedule] || 'Automatic';
            }
            document.getElementById('reviewSchedule').textContent = scheduleText;

            // Source
            const sourceNames = {
                'dropbox': 'Dropbox',
                'onedrive': 'Microsoft OneDrive',
                'googledrive': 'Google Drive',
                'computer': 'My Computer (manual upload)'
            };
            document.getElementById('reviewSource').textContent = sourceNames[selectedSimpleSourceType] || 'Not selected';
        }

        function finishSimplePipelineWizard() {
            // Collect all form data
            const pipelineData = {
                template: selectedTemplate,
                name: document.getElementById('simplePipelineName').value,
                frequency: selectedFrequencyType,
                schedule: selectedFrequencyType === 'automatic' ? document.getElementById('simpleSchedule').value : null,
                source: selectedSimpleSourceType,
                guided: true,
                createdAt: new Date().toISOString()
            };

            console.log('Simple Pipeline created:', pipelineData);

            // Show success message with encouragement
            alert(`🎉 Success! Your pipeline "${pipelineData.name}" has been created!\n\nNext steps:\n1. Connect to your ${pipelineData.source === 'computer' ? 'data source' : sourceNames[pipelineData.source]}\n2. Test your pipeline with sample data\n3. Start processing!`);

            // Close wizard
            closeSimplePipelineWizard();

            // Reload pipeline cards
            loadPipelineCards();
        }

        const sourceNames = {
            'dropbox': 'Dropbox',
            'onedrive': 'OneDrive',
            'googledrive': 'Google Drive',
            'computer': 'computer'
        };

        // Workflows Management
        function openWorkflowsSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Workflows';

            // Hide all content sections
            hideAllContentSections();

            // Show workflows content
            document.getElementById('workflowsContent').style.display = 'block';
            loadWorkflowTypeCards();

            slideout.classList.add('active');
        }

        function loadWorkflowTypeCards() {
            const container = document.getElementById('workflowsContainer');

            const workflowTypes = [
                {
                    name: 'Approval Workflows',
                    icon: 'ph-check-circle',
                    description: 'Multi-level approval processes for documents and requests.',
                    tags: ['Operations', 'Management', 'Compliance']
                },
                {
                    name: 'Onboarding Automation',
                    icon: 'ph-users',
                    description: 'Automated employee onboarding with task assignments.',
                    tags: ['HR', 'Operations', 'Automation']
                },
                {
                    name: 'Lead Routing',
                    icon: 'ph-arrow-circle-right',
                    description: 'Automatic lead assignment based on criteria and availability.',
                    tags: ['Sales', 'Marketing', 'Automation']
                },
                {
                    name: 'Issue Escalation',
                    icon: 'ph-warning-circle',
                    description: 'Automatic escalation of issues based on severity and time.',
                    tags: ['Support', 'Operations', 'Management']
                },
                {
                    name: 'Document Review',
                    icon: 'ph-file-magnifying-glass',
                    description: 'Collaborative document review and feedback collection.',
                    tags: ['Collaboration', 'Operations', 'Quality']
                },
                {
                    name: 'Inventory Alerts',
                    icon: 'ph-package',
                    description: 'Automated notifications for low stock and reorder points.',
                    tags: ['Inventory', 'Operations', 'Automation']
                }
            ];

            createCardGrid(container, workflowTypes, 'Workflow');
        }

        // Shared card creation function
        function createCardGrid(container, items, typeName) {
            container.innerHTML = '';

            items.forEach(item => {
                const card = document.createElement('div');
                card.style.cssText = 'padding: 20px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px;';

                card.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="ph ${item.icon}" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${item.name}</div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="event.stopPropagation(); editItem('${item.name}')" title="Edit" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-pencil-simple" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteItem('${item.name}')" title="Delete" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                            </button>
                            <button onclick="event.stopPropagation(); shareItem('${item.name}')" title="Share" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                        </div>
                    </div>
                    <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">
                        ${item.description}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${item.tags.map(tag => `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${tag}</span>`).join('')}
                    </div>
                    <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">SHARED WITH</div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: var(--color-primary-blue);">AM</div>
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #f3e5f5; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: #7b1fa2;">JS</div>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">+ 3 others</span>
                        </div>
                    </div>
                `;

                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = 'var(--color-primary-blue)';
                    card.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.15)';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = 'var(--color-neutral-border)';
                    card.style.boxShadow = 'none';
                });

                card.addEventListener('click', () => {
                    alert(`${item.name} ${typeName.toLowerCase()} functionality coming soon!`);
                });

                container.appendChild(card);
            });
        }

        // Workflow Creation Functions
        let workflowStates = [];
        let workflowTags = [];

        function openNewWorkflowModal() {
            const modal = document.getElementById('workflowCreationModal');
            modal.style.display = 'block';

            // Reset form
            document.getElementById('workflowForm').reset();
            workflowStates = [];
            workflowTags = [];
            document.getElementById('workflowVersion').value = '1.0.0';
            updateWorkflowStatesList();
            updateWorkflowTagsList();
        }

        function closeWorkflowCreationModal() {
            const modal = document.getElementById('workflowCreationModal');
            modal.style.display = 'none';
        }

        function addWorkflowState() {
            const nameInput = document.getElementById('newStateName');
            const typeSelect = document.getElementById('newStateType');

            const stateName = nameInput.value.trim();
            const stateType = typeSelect.value;

            if (!stateName) {
                alert('Please enter a state name');
                return;
            }

            // Check if state already exists
            if (workflowStates.find(s => s.name.toLowerCase() === stateName.toLowerCase())) {
                alert('A state with this name already exists');
                return;
            }

            const state = {
                id: generateUUID(),
                name: stateName,
                type: stateType,
                description: `${stateName} state in the workflow`
            };

            workflowStates.push(state);
            nameInput.value = '';
            typeSelect.value = 'active';

            updateWorkflowStatesList();
        }

        function removeWorkflowState(stateId) {
            workflowStates = workflowStates.filter(s => s.id !== stateId);
            updateWorkflowStatesList();
        }

        function updateWorkflowStatesList() {
            const container = document.getElementById('workflowStatesList');

            if (workflowStates.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); text-align: center; padding: 20px; background: var(--color-neutral-background); border-radius: 6px;">No states added yet. Add your first workflow state above.</p>';
                return;
            }

            container.innerHTML = workflowStates.map(state => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px;">
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${state.name}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="padding: 2px 8px; background: ${getStateTypeColor(state.type)}; color: white; border-radius: 12px; font-family: var(--font-family-body); font-size: 11px; font-weight: 500; text-transform: uppercase;">${state.type}</span>
                        </div>
                    </div>
                    <button onclick="removeWorkflowState('${state.id}')" style="padding: 6px; background: #fee; color: #d32f2f; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Remove state">
                        <i class="ph ph-trash" style="font-size: 14px;"></i>
                    </button>
                </div>
            `).join('');
        }

        function getStateTypeColor(type) {
            const colors = {
                initial: '#10b981',
                active: '#0066cc',
                waiting: '#f59e0b',
                completed: '#22c55e',
                cancelled: '#6b7280',
                failed: '#ef4444',
                terminal: '#8b5cf6'
            };
            return colors[type] || '#6b7280';
        }

        function handleTagKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addWorkflowTag();
            }
        }

        function addWorkflowTag() {
            const input = document.getElementById('newWorkflowTag');
            const tagName = input.value.trim();

            if (!tagName) return;

            // Check if tag already exists
            if (workflowTags.find(t => t.toLowerCase() === tagName.toLowerCase())) {
                alert('This tag already exists');
                return;
            }

            workflowTags.push(tagName);
            input.value = '';
            updateWorkflowTagsList();
        }

        function removeWorkflowTag(tag) {
            workflowTags = workflowTags.filter(t => t !== tag);
            updateWorkflowTagsList();
        }

        function updateWorkflowTagsList() {
            const container = document.getElementById('workflowTagsList');

            if (workflowTags.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); font-style: italic;">No tags added yet</p>';
                return;
            }

            container.innerHTML = workflowTags.map(tag => `
                <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #e3f2fd; border-radius: 16px;">
                    <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-primary-blue); font-weight: 500;">${tag}</span>
                    <button onclick="removeWorkflowTag('${tag}')" style="background: none; border: none; color: var(--color-primary-blue); cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center;" title="Remove tag">
                        <i class="ph ph-x" style="font-size: 12px;"></i>
                    </button>
                </div>
            `).join('');
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function createWorkflow(event) {
            event.preventDefault();

            // Collect form data
            const formData = {
                workflowId: generateUUID(),
                workflowName: document.getElementById('workflowName').value.trim(),
                workflowVersion: document.getElementById('workflowVersion').value.trim(),
                category: document.getElementById('workflowCategory').value,
                type: document.getElementById('workflowType').value,
                description: document.getElementById('workflowDescription').value.trim(),
                isActive: true,
                states: workflowStates.map(state => ({
                    stateId: state.id,
                    stateName: state.name,
                    stateType: state.type,
                    description: state.description,
                    isTerminal: state.type === 'terminal' || state.type === 'completed',
                    allowedRoles: [],
                    entryActions: [],
                    exitActions: [],
                    metadata: {}
                })),
                transitions: [], // Would be defined in a more advanced editor
                initialStateId: workflowStates.length > 0 ? workflowStates[0].id : null,
                variables: {
                    required: [],
                    schema: {}
                },
                roles: [],
                sla: {
                    expectedDuration: document.getElementById('expectedDuration').value.trim(),
                    maxDuration: document.getElementById('maxDuration').value.trim(),
                    businessHoursOnly: document.getElementById('businessHoursOnly').value === 'true'
                },
                metadata: {
                    createdBy: {
                        actorId: generateUUID(),
                        actorType: 'user',
                        actorName: 'Current User',
                        actorEmail: 'user@example.com'
                    },
                    createdAt: new Date().toISOString(),
                    updatedBy: null,
                    updatedAt: null,
                    tags: workflowTags
                }
            };

            // Validation
            if (!formData.workflowName) {
                alert('Please enter a workflow name');
                return;
            }

            if (!formData.category) {
                alert('Please select a category');
                return;
            }

            if (!formData.type) {
                alert('Please select a workflow type');
                return;
            }

            if (workflowStates.length === 0) {
                alert('Please add at least one workflow state');
                return;
            }

            // Save workflow definition to localStorage
            const workflowKey = `workflow_def_${formData.workflowName.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
            localStorage.setItem(workflowKey, JSON.stringify(formData));

            // Show success message
            alert(`✅ Success! Workflow "${formData.workflowName}" has been created!\n\nWorkflow Details:\n• Category: ${formData.category.replace('_', ' ')}\n• Type: ${formData.type.replace('_', ' ')}\n• States: ${workflowStates.length}\n• Tags: ${workflowTags.length}\n\nNext steps:\n1. Define state transitions\n2. Configure approval rules\n3. Set up notifications\n4. Test with sample data`);

            console.log('Workflow created:', formData);

            // Close modal
            closeWorkflowCreationModal();

            // Refresh workflow cards if needed
            if (document.getElementById('workflowsContent').style.display !== 'none') {
                loadWorkflowTypeCards();
            }
        }

        function editItem(itemName) {
            // Check if it's a pipeline based on known pipeline names
            const pipelineNames = ['Cleansheet Content Pipeline', 'Document Intelligence Pipeline', 'Customer Analytics Pipeline', 'Image Recognition Pipeline', 'Voice Processing Pipeline'];

            // Check if it's a report (dashboard) based on known report names
            const reportNames = ['Sales Dashboard', 'Financial Reports', 'Project Status', 'Customer Analytics', 'Performance Metrics', 'Marketing Analytics'];

            if (pipelineNames.includes(itemName)) {
                // Open ML Pipeline Management in modal
                openPipelineMgmtModal(itemName);
            } else if (reportNames.includes(itemName)) {
                openDashboardBuilder(itemName);
            } else {
                openTableEditor(itemName);
            }
        }

        function openPipelineMgmtModal(pipelineName) {
            const modal = document.getElementById('pipelineMgmtModal');
            const titleEl = document.getElementById('pipelineTitle');
            const frame = document.getElementById('pipelineMgmtFrame');

            titleEl.textContent = pipelineName || 'Pipeline Management';
            frame.src = 'ml-pipeline-mgmt.html';

            modal.classList.add('active');
        }

        function closePipelineMgmtModal() {
            const modal = document.getElementById('pipelineMgmtModal');
            const frame = document.getElementById('pipelineMgmtFrame');

            modal.classList.remove('active');

            // Clear iframe src after a short delay to allow fade out
            setTimeout(() => {
                frame.src = '';
            }, 300);
        }

        // Close pipeline modal when clicking outside the content area
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('pipelineMgmtModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePipelineMgmtModal();
                    }
                });
            }
        });

        function deleteItem(itemName) {
            if (confirm(`Are you sure you want to delete ${itemName}?`)) {
                alert(`Delete ${itemName} functionality coming soon!`);
            }
        }

        function shareItem(itemName) {
            alert(`Share ${itemName} functionality coming soon!`);
        }

        // Table Editor Functionality
        let currentTableName = '';
        let currentTableData = [];
        let currentTableColumns = [];
        let currentTableColumnTypes = {}; // Store column types { columnName: type }
        let currentTableIcon = 'ph-table';
        let currentTableViews = { 'default': { name: 'Default View', filters: [], sorts: [], groupBy: null } };
        let currentViewName = 'default';
        let filterConditionId = 0;
        let sortConditionId = 0;

        // PostgreSQL-aligned column types
        const POSTGRES_COLUMN_TYPES = [
            { value: 'text', label: 'Text', icon: 'ph-text-aa' },
            { value: 'varchar', label: 'VARCHAR', icon: 'ph-text-aa' },
            { value: 'integer', label: 'Integer', icon: 'ph-hash' },
            { value: 'bigint', label: 'Big Integer', icon: 'ph-hash' },
            { value: 'numeric', label: 'Numeric', icon: 'ph-number-square-one' },
            { value: 'decimal', label: 'Decimal', icon: 'ph-number-square-one' },
            { value: 'real', label: 'Real', icon: 'ph-number-square-one' },
            { value: 'double', label: 'Double Precision', icon: 'ph-number-square-one' },
            { value: 'boolean', label: 'Boolean', icon: 'ph-check-square' },
            { value: 'date', label: 'Date', icon: 'ph-calendar-blank' },
            { value: 'timestamp', label: 'Timestamp', icon: 'ph-clock' },
            { value: 'timestamptz', label: 'Timestamp with TZ', icon: 'ph-clock' },
            { value: 'time', label: 'Time', icon: 'ph-clock' },
            { value: 'interval', label: 'Interval', icon: 'ph-timer' },
            { value: 'json', label: 'JSON', icon: 'ph-brackets-curly' },
            { value: 'jsonb', label: 'JSONB', icon: 'ph-brackets-curly' },
            { value: 'uuid', label: 'UUID', icon: 'ph-fingerprint' },
            { value: 'array', label: 'Array', icon: 'ph-list' },
            { value: 'bytea', label: 'Bytea', icon: 'ph-file-code' }
        ];

        function openTableEditor(tableName) {
            currentTableName = tableName;

            // Find table definition
            const tableTypes = [
                { name: 'Contacts', icon: 'ph-address-book', columns: ['Name', 'Email', 'Phone', 'Company', 'Role', 'Location', 'Notes'] },
                { name: 'Customers', icon: 'ph-users', columns: ['Customer ID', 'Name', 'Email', 'Account Type', 'Status', 'Created Date', 'Lifetime Value'] },
                { name: 'Projects', icon: 'ph-folder', columns: ['Project Name', 'Status', 'Start Date', 'End Date', 'Budget', 'Team', 'Priority'] },
                { name: 'Tasks', icon: 'ph-check-square', columns: ['Task Name', 'Assigned To', 'Due Date', 'Status', 'Priority', 'Tags', 'Progress'] },
                { name: 'Inventory', icon: 'ph-package', columns: ['Item Name', 'SKU', 'Quantity', 'Location', 'Supplier', 'Cost', 'Last Updated'] },
                { name: 'Vendors', icon: 'ph-handshake', columns: ['Vendor Name', 'Contact', 'Services', 'Contract Start', 'Contract End', 'Rating', 'Notes'] },
                { name: 'Events', icon: 'ph-calendar', columns: ['Event Name', 'Date', 'Time', 'Location', 'Attendees', 'Status', 'Budget'] },
                { name: 'Assets', icon: 'ph-briefcase', columns: ['Asset Name', 'Type', 'Owner', 'Location', 'Purchase Date', 'Value', 'Status'] },
                { name: 'Issues', icon: 'ph-warning', columns: ['Issue ID', 'Title', 'Severity', 'Status', 'Assigned To', 'Created Date', 'Resolved Date'] },
                { name: 'Expenses', icon: 'ph-receipt', columns: ['Date', 'Category', 'Amount', 'Vendor', 'Payment Method', 'Status', 'Receipt'] }
            ];

            const tableDefinition = tableTypes.find(t => t.name === tableName);
            if (!tableDefinition) return;

            currentTableColumns = tableDefinition.columns;
            currentTableIcon = tableDefinition.icon;

            // Load or initialize table data and column types from localStorage
            const storageKey = `table_${tableName.toLowerCase().replace(/\s+/g, '_')}`;
            const typesKey = `table_types_${tableName.toLowerCase().replace(/\s+/g, '_')}`;

            const savedData = localStorage.getItem(storageKey);
            const savedTypes = localStorage.getItem(typesKey);

            if (savedData) {
                currentTableData = JSON.parse(savedData);
            } else {
                // Initialize with sample data
                currentTableData = generateSampleData(tableName, currentTableColumns);
                localStorage.setItem(storageKey, JSON.stringify(currentTableData));
            }

            if (savedTypes) {
                currentTableColumnTypes = JSON.parse(savedTypes);
            } else {
                // Initialize column types based on column names
                currentTableColumnTypes = inferColumnTypes(currentTableColumns);
                localStorage.setItem(typesKey, JSON.stringify(currentTableColumnTypes));
            }

            // Update modal UI
            document.getElementById('tableEditorTitle').textContent = tableName;
            document.getElementById('tableIcon').innerHTML = `<i class="ph ${currentTableIcon}" style="font-size: 20px; color: var(--color-primary-blue);"></i>`;
            updateRowCount();

            // Populate group by dropdown
            const groupBySelect = document.getElementById('groupByColumn');
            groupBySelect.innerHTML = '<option value="">No Grouping</option>';
            currentTableColumns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                groupBySelect.appendChild(option);
            });

            // Render table
            renderTableGrid();

            // Show modal
            document.getElementById('tableEditorModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function inferColumnTypes(columns) {
            const types = {};
            columns.forEach(col => {
                const lower = col.toLowerCase();

                if (lower.includes('id') || lower.includes('quantity') || lower.includes('progress')) {
                    types[col] = 'integer';
                } else if (lower.includes('email') || lower.includes('name') || lower.includes('title') || lower.includes('location') || lower.includes('notes') || lower.includes('description')) {
                    types[col] = 'text';
                } else if (lower.includes('date') && !lower.includes('time')) {
                    types[col] = 'date';
                } else if (lower.includes('time') || lower.includes('timestamp')) {
                    types[col] = 'timestamp';
                } else if (lower.includes('amount') || lower.includes('budget') || lower.includes('cost') || lower.includes('value') || lower.includes('price')) {
                    types[col] = 'numeric';
                } else if (lower.includes('rating')) {
                    types[col] = 'decimal';
                } else if (lower.includes('status') || lower.includes('priority') || lower.includes('type') || lower.includes('category')) {
                    types[col] = 'varchar';
                } else if (lower.includes('active') || lower.includes('enabled') || lower.includes('verified')) {
                    types[col] = 'boolean';
                } else if (lower.includes('tags') || lower.includes('items')) {
                    types[col] = 'array';
                } else if (lower.includes('data') || lower.includes('config') || lower.includes('metadata')) {
                    types[col] = 'jsonb';
                } else {
                    types[col] = 'text'; // Default
                }
            });
            return types;
        }

        function closeTableEditor() {
            // Save data and types before closing
            const storageKey = `table_${currentTableName.toLowerCase().replace(/\s+/g, '_')}`;
            const typesKey = `table_types_${currentTableName.toLowerCase().replace(/\s+/g, '_')}`;

            localStorage.setItem(storageKey, JSON.stringify(currentTableData));
            localStorage.setItem(typesKey, JSON.stringify(currentTableColumnTypes));

            document.getElementById('tableEditorModal').style.display = 'none';
            document.body.style.overflow = '';

            // Reset state
            currentTableName = '';
            currentTableData = [];
            currentTableColumns = [];
            currentTableColumnTypes = {};
        }

        // Function to handle column clicks from ERD
        function openColumnEditor(tableName, tableId, columnName) {
            // First open the table editor to get the table context
            openTableEditor(tableName);

            // Wait a moment for the table editor to fully load, then open column type editor
            setTimeout(() => {
                if (document.getElementById('tableEditorModal').style.display !== 'none') {
                    openColumnTypeEditor(columnName);
                }
            }, 100);

            // Show a toast notification to indicate what's happening
            showToast(`Opening ${tableName}.${columnName} editor`, 'info');
        }

        function generateSampleData(tableName, columns) {
            const samples = [];
            const sampleCount = 15;

            for (let i = 0; i < sampleCount; i++) {
                const row = { id: Date.now() + i };
                columns.forEach(col => {
                    row[col] = generateSampleValue(col, i);
                });
                samples.push(row);
            }

            return samples;
        }

        function generateSampleValue(columnName, index) {
            const lower = columnName.toLowerCase();

            if (lower.includes('name')) return `Sample ${index + 1}`;
            if (lower.includes('email')) return `user${index + 1}@example.com`;
            if (lower.includes('phone')) return `(555) ${String(index + 100).padStart(3, '0')}-${String(index * 11).padStart(4, '0')}`;
            if (lower.includes('date')) return new Date(2025, 0, index + 1).toLocaleDateString();
            if (lower.includes('status')) return ['Active', 'Pending', 'Completed', 'On Hold'][index % 4];
            if (lower.includes('priority')) return ['High', 'Medium', 'Low'][index % 3];
            if (lower.includes('amount') || lower.includes('budget') || lower.includes('cost') || lower.includes('value')) return `$${(Math.random() * 10000 + 100).toFixed(2)}`;
            if (lower.includes('quantity') || lower.includes('progress')) return Math.floor(Math.random() * 100);
            if (lower.includes('rating')) return (Math.random() * 5).toFixed(1);

            return `Data ${index + 1}`;
        }

        function renderTableGrid() {
            const grid = document.getElementById('tableDataGrid');

            // Create table HTML with sticky headers
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-family: var(--font-family-body); font-size: 13px;">
                    <thead style="position: sticky; top: 0; background: var(--color-neutral-background); z-index: 10;">
                        <tr style="border-bottom: 2px solid var(--color-neutral-border);">
                            <th style="padding: 12px; text-align: left; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; width: 40px;">
                                <input type="checkbox" onchange="toggleAllRows(this.checked)" style="cursor: pointer;">
                            </th>
            `;

            // Add column headers with type indicators
            currentTableColumns.forEach(col => {
                const colType = currentTableColumnTypes[col] || 'text';
                const typeInfo = POSTGRES_COLUMN_TYPES.find(t => t.value === colType) || POSTGRES_COLUMN_TYPES[0];

                html += `
                    <th style="padding: 12px; text-align: left; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); min-width: 180px;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="text-transform: uppercase;">${escapeHtml(col)}</span>
                                <i class="ph ph-caret-up-down" style="font-size: 12px; color: var(--color-neutral-text-light); cursor: pointer;" onclick="quickSort('${col}')"></i>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px; cursor: pointer;" onclick="openColumnTypeEditor('${col}')">
                                <i class="ph ${typeInfo.icon}" style="font-size: 11px; color: var(--color-primary-blue);"></i>
                                <span style="font-size: 10px; color: var(--color-primary-blue); font-weight: 500; text-transform: none;">${typeInfo.label}</span>
                                <i class="ph ph-caret-down" style="font-size: 10px; color: var(--color-primary-blue);"></i>
                            </div>
                        </div>
                    </th>
                `;
            });

            html += `
                            <th style="padding: 12px; width: 80px; text-align: center; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Add data rows
            currentTableData.forEach((row, rowIndex) => {
                html += `
                    <tr style="border-bottom: 1px solid var(--color-neutral-border); transition: background 0.2s;" onmouseenter="this.style.background='#f8f9fa'" onmouseleave="this.style.background='white'">
                        <td style="padding: 12px;">
                            <input type="checkbox" style="cursor: pointer;">
                        </td>
                `;

                currentTableColumns.forEach(col => {
                    const value = row[col] || '';
                    html += `
                        <td style="padding: 12px;">
                            <input type="text" value="${escapeHtml(String(value))}" onchange="updateCellValue(${rowIndex}, '${col}', this.value)" style="width: 100%; border: 1px solid transparent; padding: 4px 8px; border-radius: 4px; font-family: var(--font-family-body); font-size: 13px; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--color-primary-blue)'" onblur="this.style.borderColor='transparent'">
                        </td>
                    `;
                });

                html += `
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="deleteRow(${rowIndex})" style="padding: 4px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; color: #dc2626; transition: all 0.2s;" onmouseenter="this.style.borderColor='#dc2626'; this.style.background='#fef2f2'" onmouseleave="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white'">
                                <i class="ph ph-trash" style="font-size: 14px;"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            grid.innerHTML = html;
        }

        function updateRowCount() {
            const count = currentTableData.length;
            document.getElementById('tableRowCount').textContent = `${count} row${count !== 1 ? 's' : ''}`;
        }

        function updateCellValue(rowIndex, columnName, value) {
            currentTableData[rowIndex][columnName] = value;
            // Auto-save
            const storageKey = `table_${currentTableName.toLowerCase().replace(/\s+/g, '_')}`;
            localStorage.setItem(storageKey, JSON.stringify(currentTableData));
        }

        function addNewRow() {
            const newRow = { id: Date.now() };
            currentTableColumns.forEach(col => {
                newRow[col] = '';
            });
            currentTableData.unshift(newRow);
            renderTableGrid();
            updateRowCount();
        }

        function deleteRow(rowIndex) {
            if (confirm('Delete this row?')) {
                currentTableData.splice(rowIndex, 1);
                renderTableGrid();
                updateRowCount();
            }
        }

        function toggleAllRows(checked) {
            const checkboxes = document.querySelectorAll('#tableDataGrid tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
        }

        function quickSort(columnName) {
            currentTableData.sort((a, b) => {
                const aVal = String(a[columnName] || '');
                const bVal = String(b[columnName] || '');
                return aVal.localeCompare(bVal);
            });
            renderTableGrid();
        }

        // Filter Panel Functions
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const btn = document.getElementById('filterBtn');
            const isVisible = panel.style.display !== 'none';

            panel.style.display = isVisible ? 'none' : 'block';
            btn.style.background = isVisible ? 'white' : '#e3f2fd';
        }

        function addFilterCondition() {
            const container = document.getElementById('filterConditions');
            const conditionId = filterConditionId++;

            const div = document.createElement('div');
            div.id = `filter-${conditionId}`;
            div.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 8px;';

            div.innerHTML = `
                <select style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                    ${currentTableColumns.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
                <select style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                    <option value="contains">Contains</option>
                    <option value="equals">Equals</option>
                    <option value="starts">Starts with</option>
                    <option value="ends">Ends with</option>
                </select>
                <input type="text" placeholder="Value..." style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; flex: 1;">
                <button onclick="removeFilterCondition(${conditionId})" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; color: #dc2626;">
                    <i class="ph ph-x"></i>
                </button>
            `;

            container.appendChild(div);
        }

        function removeFilterCondition(conditionId) {
            const element = document.getElementById(`filter-${conditionId}`);
            if (element) element.remove();
        }

        // Sort Panel Functions
        function toggleSortPanel() {
            const panel = document.getElementById('sortPanel');
            const btn = document.getElementById('sortBtn');
            const isVisible = panel.style.display !== 'none';

            panel.style.display = isVisible ? 'none' : 'block';
            btn.style.background = isVisible ? 'white' : '#e3f2fd';
        }

        function addSortCondition() {
            const container = document.getElementById('sortConditions');
            const conditionId = sortConditionId++;

            const div = document.createElement('div');
            div.id = `sort-${conditionId}`;
            div.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 8px;';

            div.innerHTML = `
                <select style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; flex: 1;">
                    ${currentTableColumns.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
                <select style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
                <button onclick="removeSortCondition(${conditionId})" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; color: #dc2626;">
                    <i class="ph ph-x"></i>
                </button>
            `;

            container.appendChild(div);
        }

        function removeSortCondition(conditionId) {
            const element = document.getElementById(`sort-${conditionId}`);
            if (element) element.remove();
        }

        // Group Panel Functions
        function toggleGroupPanel() {
            const panel = document.getElementById('groupPanel');
            const btn = document.getElementById('groupBtn');
            const isVisible = panel.style.display !== 'none';

            panel.style.display = isVisible ? 'none' : 'block';
            btn.style.background = isVisible ? 'white' : '#e3f2fd';
        }

        function applyGrouping() {
            const groupByColumn = document.getElementById('groupByColumn').value;
            if (!groupByColumn) {
                renderTableGrid();
                return;
            }

            // Group rows by selected column
            alert(`Grouping by ${groupByColumn} - Full implementation coming soon!`);
        }

        // View Management
        function switchTableView() {
            const viewName = document.getElementById('viewSelector').value;
            currentViewName = viewName;
            // Load view settings
            alert(`Switching to view: ${viewName} - Full implementation coming soon!`);
        }

        function saveCurrentView() {
            const viewName = prompt('Enter name for this view:');
            if (!viewName) return;

            currentTableViews[viewName] = {
                name: viewName,
                filters: [],
                sorts: [],
                groupBy: null
            };

            // Add to view selector
            const selector = document.getElementById('viewSelector');
            const option = document.createElement('option');
            option.value = viewName;
            option.textContent = viewName;
            selector.appendChild(option);
            selector.value = viewName;

            alert(`View "${viewName}" saved successfully!`);
        }

        // Column Type Editor Functions
        let currentEditingColumn = '';
        let selectedColumnType = '';

        function openColumnTypeEditor(columnName) {
            currentEditingColumn = columnName;
            selectedColumnType = currentTableColumnTypes[columnName] || 'text';

            // Update modal header
            document.getElementById('columnTypeEditorColumnName').textContent = `Column: ${columnName}`;

            // Render type options
            const container = document.getElementById('columnTypeOptions');
            container.innerHTML = '';

            POSTGRES_COLUMN_TYPES.forEach(type => {
                const isSelected = type.value === selectedColumnType;
                const button = document.createElement('button');
                button.style.cssText = `
                    padding: 12px;
                    background: ${isSelected ? '#e3f2fd' : 'white'};
                    border: 2px solid ${isSelected ? 'var(--color-primary-blue)' : 'var(--color-neutral-border)'};
                    border-radius: 6px;
                    font-family: var(--font-family-body);
                    font-size: 12px;
                    color: var(--color-dark);
                    cursor: pointer;
                    text-align: left;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;

                button.innerHTML = `
                    <i class="ph ${type.icon}" style="font-size: 16px; color: ${isSelected ? 'var(--color-primary-blue)' : 'var(--color-neutral-text)'}; flex-shrink: 0;"></i>
                    <span style="font-weight: ${isSelected ? '600' : '400'};">${type.label}</span>
                `;

                button.onclick = () => selectColumnType(type.value);

                button.onmouseenter = () => {
                    if (!isSelected) {
                        button.style.borderColor = 'var(--color-primary-blue)';
                        button.style.background = '#f8f9fa';
                    }
                };

                button.onmouseleave = () => {
                    if (!isSelected) {
                        button.style.borderColor = 'var(--color-neutral-border)';
                        button.style.background = 'white';
                    }
                };

                container.appendChild(button);
            });

            // Show modal
            document.getElementById('columnTypeEditorModal').style.display = 'flex';
        }

        function selectColumnType(typeValue) {
            selectedColumnType = typeValue;
            // Re-render to show selection
            openColumnTypeEditor(currentEditingColumn);
        }

        function applyColumnType() {
            if (selectedColumnType && currentEditingColumn) {
                currentTableColumnTypes[currentEditingColumn] = selectedColumnType;

                // Save to localStorage
                const typesKey = `table_types_${currentTableName.toLowerCase().replace(/\s+/g, '_')}`;
                localStorage.setItem(typesKey, JSON.stringify(currentTableColumnTypes));

                // Re-render table to show new type
                renderTableGrid();

                closeColumnTypeEditor();
            }
        }

        function closeColumnTypeEditor() {
            document.getElementById('columnTypeEditorModal').style.display = 'none';
            currentEditingColumn = '';
            selectedColumnType = '';
        }

        // Form Designer Functions
        let currentFormIndex = null;
        let currentFormFields = [];
        let professionalForms = [];

        // Load forms from localStorage
        function loadProfessionalForms() {
            const saved = localStorage.getItem('professionalForms');
            if (saved) {
                professionalForms = JSON.parse(saved);
            }
        }

        // Update loadFormTypeCards to show user-created forms
        function loadFormTypeCards() {
            loadProfessionalForms();
            const container = document.getElementById('formsContainer');
            container.innerHTML = '';

            if (professionalForms.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-file-dotted" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No forms created yet. Click "+ New Form" to get started.</p>
                    </div>
                `;
                return;
            }

            professionalForms.forEach((form, index) => {
                const card = document.createElement('div');
                card.style.cssText = 'padding: 20px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px;';

                // Determine icon based on form type or use default
                const formIcon = 'ph-clipboard-text';

                // Generate tags from form fields or status
                const tags = [];
                if (form.status === 'open') tags.push('Open');
                if (form.status === 'shared') tags.push('Shared');
                if (form.fields?.length) tags.push(`${form.fields.length} Fields`);

                const description = form.fields?.length
                    ? `Form with ${form.fields.length} field${form.fields.length !== 1 ? 's' : ''}. Last modified ${new Date(form.lastModified).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}.`
                    : 'Empty form. Click to add fields and configure.';

                card.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="ph ${formIcon}" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${form.title || 'Untitled Form'}</div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="event.stopPropagation(); openFormDesigner(${index})" title="Edit" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-pencil-simple" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteForm(${index})" title="Delete" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                            </button>
                            <button onclick="event.stopPropagation(); shareForm(${index})" title="Share" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                        </div>
                    </div>
                    <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">
                        ${description}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${tags.map(tag => `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${tag}</span>`).join('')}
                    </div>
                    <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">SHARED WITH</div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: var(--color-primary-blue);">AM</div>
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #f3e5f5; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: #7b1fa2;">JS</div>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">+ 3 others</span>
                        </div>
                    </div>
                `;

                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = 'var(--color-primary-blue)';
                    card.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.15)';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = 'var(--color-neutral-border)';
                    card.style.boxShadow = 'none';
                });

                card.addEventListener('click', () => {
                    openFormDesigner(index);
                });

                container.appendChild(card);
            });
        }

        function shareForm(index) {
            alert(`Share form functionality coming soon!`);
        }

        function openFormDesigner(formIndex = null) {
            currentFormIndex = formIndex;

            if (formIndex !== null && professionalForms[formIndex]) {
                // Edit existing form
                const form = professionalForms[formIndex];
                document.getElementById('formTitle').value = form.title || '';
                currentFormFields = JSON.parse(JSON.stringify(form.fields || []));
            } else {
                // New form
                document.getElementById('formTitle').value = '';
                currentFormFields = [];
            }

            renderFormFields();
            document.getElementById('formDesignerModal').style.display = 'flex';
        }

        function closeFormDesigner() {
            document.getElementById('formDesignerModal').style.display = 'none';
            currentFormIndex = null;
            currentFormFields = [];
        }

        function addFormField(type) {
            const field = {
                id: Date.now() + Math.random(),
                type: type,
                label: getDefaultLabel(type),
                placeholder: '',
                required: false,
                linkedTable: '',
                linkedColumn: '',
                options: type === 'dropdown' || type === 'radio' || type === 'checkbox' ? ['Option 1', 'Option 2'] : []
            };

            // Add scale-specific properties
            if (type === 'scale') {
                field.scaleMin = 1;
                field.scaleMax = 10;
                field.scaleMinLabel = 'Not at all';
                field.scaleMaxLabel = 'Extremely';
            }

            // Add likert-specific properties
            if (type === 'likert') {
                field.likertOptions = ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
            }

            currentFormFields.push(field);
            renderFormFields();
        }

        function getDefaultLabel(type) {
            const labels = {
                'text': 'Text Input',
                'textarea': 'Text Area',
                'email': 'Email Address',
                'number': 'Number',
                'phone': 'Phone Number',
                'date': 'Date',
                'time': 'Time',
                'dropdown': 'Select Option',
                'radio': 'Choose One',
                'checkbox': 'Select All That Apply',
                'file': 'Upload File',
                'picture': 'Picture',
                'scale': 'Rating Scale',
                'likert': 'Likert Scale Question',
                'section': 'Section Header'
            };
            return labels[type] || 'Field';
        }

        function renderFormFields() {
            const container = document.getElementById('formFieldsContainer');
            container.innerHTML = '';

            if (currentFormFields.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-cursor-click" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p style="font-size: 16px;">Click a field type on the left to add it to your form</p>
                    </div>
                `;
                return;
            }

            currentFormFields.forEach((field, index) => {
                const fieldEl = document.createElement('div');
                fieldEl.style.cssText = `
                    background: white;
                    border: 1px solid var(--color-neutral-border);
                    border-radius: 8px;
                    padding: 20px;
                    margin-bottom: 16px;
                    position: relative;
                `;

                if (field.type === 'section') {
                    fieldEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <input type="text" value="${field.label}" onchange="updateFieldLabel(${index}, this.value)"
                                style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Questrial', sans-serif; font-size: 18px; font-weight: 600;">
                            <button onclick="removeFormField(${index})" style="margin-left: 12px; padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                        <div style="height: 2px; background: var(--color-primary-blue);"></div>
                    `;
                } else {
                    const linkedTableOptions = getAvailableTablesForLinking();
                    const linkedColumnOptions = field.linkedTable ? getColumnsForTable(field.linkedTable) : [];

                    fieldEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Field Label
                                </label>
                                <input type="text" value="${field.label}" onchange="updateFieldLabel(${index}, this.value)"
                                    style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                            </div>
                            <button onclick="removeFormField(${index})" style="margin-left: 12px; padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>

                        ${field.type !== 'file' && field.type !== 'picture' && field.type !== 'scale' && field.type !== 'likert' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Placeholder
                            </label>
                            <input type="text" value="${field.placeholder}" onchange="updateFieldPlaceholder(${index}, this.value)"
                                style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                        </div>
                        ` : ''}

                        ${field.type === 'picture' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Image URL or Upload
                            </label>
                            <input type="text" value="${field.imageUrl || ''}" onchange="updateFieldImageUrl(${index}, this.value)" placeholder="https://example.com/image.jpg"
                                style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                            <div style="margin-top: 8px; font-size: 12px; color: var(--color-neutral-text-muted);">Enter an image URL to display in the form</div>
                        </div>
                        ` : ''}

                        ${field.type === 'scale' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Scale Range
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--color-neutral-text);">Minimum</label>
                                    <input type="number" value="${field.scaleMin || 1}" onchange="updateScaleMin(${index}, this.value)"
                                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--color-neutral-text);">Maximum</label>
                                    <input type="number" value="${field.scaleMax || 10}" onchange="updateScaleMax(${index}, this.value)"
                                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Scale Labels
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--color-neutral-text);">Min Label</label>
                                    <input type="text" value="${field.scaleMinLabel || ''}" onchange="updateScaleMinLabel(${index}, this.value)" placeholder="e.g., Not at all"
                                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--color-neutral-text);">Max Label</label>
                                    <input type="text" value="${field.scaleMaxLabel || ''}" onchange="updateScaleMaxLabel(${index}, this.value)" placeholder="e.g., Extremely"
                                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        ${field.type === 'likert' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Likert Options (one per line)
                            </label>
                            <textarea onchange="updateLikertOptions(${index}, this.value)"
                                style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px; min-height: 120px;">${(field.likertOptions || []).join('\n')}</textarea>
                            <div style="margin-top: 8px; font-size: 12px; color: var(--color-neutral-text-muted);">Typical: Strongly Disagree, Disagree, Neutral, Agree, Strongly Agree</div>
                        </div>
                        ` : ''}

                        ${field.type === 'dropdown' || field.type === 'radio' || field.type === 'checkbox' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Options (one per line)
                            </label>
                            <textarea onchange="updateFieldOptions(${index}, this.value)"
                                style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px; min-height: 80px;">${field.options.join('\n')}</textarea>
                        </div>
                        ` : ''}

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Link to Table
                                </label>
                                <select onchange="updateFieldLinkedTable(${index}, this.value)"
                                    style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                    <option value="">None</option>
                                    ${linkedTableOptions.map(table => `<option value="${table}" ${field.linkedTable === table ? 'selected' : ''}>${table}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Link to Column
                                </label>
                                <select onchange="updateFieldLinkedColumn(${index}, this.value)"
                                    style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;" ${!field.linkedTable ? 'disabled' : ''}>
                                    <option value="">None</option>
                                    ${linkedColumnOptions.map(col => `<option value="${col}" ${field.linkedColumn === col ? 'selected' : ''}>${col}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px; color: var(--color-neutral-text);">
                                <input type="checkbox" ${field.required ? 'checked' : ''} onchange="updateFieldRequired(${index}, this.checked)"
                                    style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                                Required field
                            </label>
                            <button onclick="alert('Logic builder coming soon! This will allow you to show/hide fields based on other field values.')" style="padding: 6px 12px; background: white; border: 1px solid var(--color-primary-blue); color: var(--color-primary-blue); border-radius: 6px; font-family: 'Questrial', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <i class="ph ph-git-branch"></i> Logic
                            </button>
                        </div>
                    `;
                }

                container.appendChild(fieldEl);
            });
        }

        function updateFieldLabel(index, value) {
            currentFormFields[index].label = value;
        }

        function updateFieldPlaceholder(index, value) {
            currentFormFields[index].placeholder = value;
        }

        function updateFieldOptions(index, value) {
            currentFormFields[index].options = value.split('\n').filter(o => o.trim());
        }

        function updateFieldRequired(index, value) {
            currentFormFields[index].required = value;
        }

        function updateFieldLinkedTable(index, value) {
            // Handle "Create New Table" option
            if (value === '+ Create New Table') {
                // Open the table wizard to create a new table
                openTableWizard();
                // Reset to no selection for now
                currentFormFields[index].linkedTable = '';
                currentFormFields[index].linkedColumn = '';
                showToast('Opening table wizard. After creating your table, return here to link it.', 'info');
            } else {
                currentFormFields[index].linkedTable = value;
                currentFormFields[index].linkedColumn = ''; // Reset column when table changes
            }
            renderFormFields(); // Re-render to update column dropdown
        }

        function updateFieldLinkedColumn(index, value) {
            currentFormFields[index].linkedColumn = value;
        }

        function updateFieldImageUrl(index, value) {
            if (!currentFormFields[index].imageUrl) {
                currentFormFields[index].imageUrl = '';
            }
            currentFormFields[index].imageUrl = value;
        }

        function updateScaleMin(index, value) {
            currentFormFields[index].scaleMin = parseInt(value) || 1;
        }

        function updateScaleMax(index, value) {
            currentFormFields[index].scaleMax = parseInt(value) || 10;
        }

        function updateScaleMinLabel(index, value) {
            currentFormFields[index].scaleMinLabel = value;
        }

        function updateScaleMaxLabel(index, value) {
            currentFormFields[index].scaleMaxLabel = value;
        }

        function updateLikertOptions(index, value) {
            currentFormFields[index].likertOptions = value.split('\n').filter(o => o.trim());
        }

        function removeFormField(index) {
            if (confirm('Remove this field?')) {
                currentFormFields.splice(index, 1);
                renderFormFields();
            }
        }

        function getAvailableTablesForLinking() {
            const tables = [];

            // Add default table types from the system
            const defaultTables = [
                'Contacts', 'Customers', 'Projects', 'Tasks', 'Inventory',
                'Vendors', 'Events', 'Assets', 'Issues', 'Expenses'
            ];

            defaultTables.forEach(tableName => {
                if (!tables.includes(tableName)) {
                    tables.push(tableName);
                }
            });

            // Get all custom table definitions from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('table_def_')) {
                    const tableName = key.replace('table_def_', '').replace(/_/g, ' ');
                    if (!tables.includes(tableName)) {
                        tables.push(tableName);
                    }
                }
            }

            // Add "Create New Table" option at the end
            tables.push('+ Create New Table');

            return tables.sort((a, b) => {
                // Keep "Create New Table" at the end
                if (a === '+ Create New Table') return 1;
                if (b === '+ Create New Table') return -1;
                return a.localeCompare(b);
            });
        }

        function getColumnsForTable(tableName) {
            // First check for default table columns
            const defaultTableColumns = {
                'Contacts': ['ID', 'Name', 'Email', 'Phone', 'Company', 'Role', 'Location', 'Notes'],
                'Customers': ['Customer_ID', 'Name', 'Email', 'Account_Type', 'Status', 'Contact_ID', 'Created_Date', 'Lifetime_Value'],
                'Projects': ['Project_ID', 'Project_Name', 'Status', 'Start_Date', 'End_Date', 'Customer_ID', 'Budget', 'Team', 'Priority'],
                'Tasks': ['Task_ID', 'Task_Name', 'Assigned_To_ID', 'Due_Date', 'Status', 'Project_ID', 'Priority', 'Tags', 'Progress'],
                'Inventory': ['Item_ID', 'Item_Name', 'SKU', 'Quantity', 'Location', 'Supplier_ID', 'Cost', 'Last_Updated'],
                'Vendors': ['Vendor_ID', 'Vendor_Name', 'Contact', 'Services', 'Contract_Start', 'Contract_End', 'Rating', 'Notes'],
                'Events': ['Event_ID', 'Event_Name', 'Date', 'Time', 'Location', 'Project_ID', 'Attendees', 'Status', 'Budget'],
                'Assets': ['Asset_ID', 'Asset_Name', 'Type', 'Owner_ID', 'Location', 'Vendor_ID', 'Purchase_Date', 'Value', 'Status'],
                'Issues': ['Issue_ID', 'Title', 'Severity', 'Status', 'Assigned_To_ID', 'Project_ID', 'Created_Date', 'Resolved_Date'],
                'Expenses': ['Expense_ID', 'Date', 'Category', 'Amount', 'Vendor_ID', 'Project_ID', 'Submitted_By_ID', 'Payment_Method', 'Status', 'Receipt']
            };

            // Check if it's a default table
            if (defaultTableColumns[tableName]) {
                return defaultTableColumns[tableName];
            }

            // Check for custom table definition in localStorage
            const key = `table_def_${tableName.toLowerCase().replace(/\s+/g, '_')}`;
            const saved = localStorage.getItem(key);
            if (saved) {
                const def = JSON.parse(saved);
                return def.columns || [];
            }

            return [];
        }

        function togglePublishMenu() {
            const menu = document.getElementById('publishMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('publishMenu');
            const publishBtn = event.target.closest('[onclick="togglePublishMenu()"]');
            if (menu && menu.style.display === 'block' && !publishBtn && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        function publishFormAs(type) {
            const title = document.getElementById('formTitle').value.trim();
            if (!title) {
                alert('Please enter a form title before publishing.');
                return;
            }

            if (currentFormFields.length === 0) {
                alert('Please add at least one field before publishing.');
                return;
            }

            const form = {
                title: title,
                fields: currentFormFields,
                status: type,
                lastModified: new Date().toISOString(),
                createdDate: currentFormIndex !== null ? professionalForms[currentFormIndex].createdDate : new Date().toISOString()
            };

            if (currentFormIndex !== null) {
                professionalForms[currentFormIndex] = form;
            } else {
                professionalForms.push(form);
            }

            localStorage.setItem('professionalForms', JSON.stringify(professionalForms));

            let message = '';
            if (type === 'open') {
                message = 'Form published as Open Form. Anyone with the link can submit responses.';
            } else if (type === 'specific') {
                message = 'Form published to specific users. Only invited users can submit responses.';
            }

            alert(message);
            togglePublishMenu();
            closeFormDesigner();
            loadFormTypeCards();
        }

        function shareFormWithEditors() {
            const title = document.getElementById('formTitle').value.trim();
            if (!title) {
                alert('Please enter a form title before sharing.');
                return;
            }

            if (currentFormFields.length === 0) {
                alert('Please add at least one field before sharing.');
                return;
            }

            const form = {
                title: title,
                fields: currentFormFields,
                status: 'shared',
                lastModified: new Date().toISOString(),
                createdDate: currentFormIndex !== null ? professionalForms[currentFormIndex].createdDate : new Date().toISOString()
            };

            if (currentFormIndex !== null) {
                professionalForms[currentFormIndex] = form;
            } else {
                professionalForms.push(form);
            }

            localStorage.setItem('professionalForms', JSON.stringify(professionalForms));

            alert('Form shared with editors. Collaborators can now edit this form.');
            togglePublishMenu();
            closeFormDesigner();
            loadFormTypeCards();
        }

        function saveFormDesign() {
            const title = document.getElementById('formTitle').value.trim();
            if (!title) {
                alert('Please enter a form title.');
                return;
            }

            const form = {
                title: title,
                fields: currentFormFields,
                status: currentFormIndex !== null && professionalForms[currentFormIndex].status ? professionalForms[currentFormIndex].status : 'draft',
                lastModified: new Date().toISOString(),
                createdDate: currentFormIndex !== null ? professionalForms[currentFormIndex].createdDate : new Date().toISOString()
            };

            if (currentFormIndex !== null) {
                professionalForms[currentFormIndex] = form;
            } else {
                professionalForms.push(form);
            }

            localStorage.setItem('professionalForms', JSON.stringify(professionalForms));

            alert('Form saved successfully!');
            closeFormDesigner();
            loadFormTypeCards();
        }

        function deleteForm(index) {
            if (confirm('Are you sure you want to delete this form? This cannot be undone.')) {
                professionalForms.splice(index, 1);
                localStorage.setItem('professionalForms', JSON.stringify(professionalForms));
                loadFormTypeCards();
            }
        }

        // Form Preview Functions
        function openFormPreview() {
            const title = document.getElementById('formTitle').value.trim() || 'Untitled Form';
            const container = document.getElementById('formPreviewContent');

            if (currentFormFields.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-file-dotted" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No fields added to preview. Add fields to see the form preview.</p>
                    </div>
                `;
            } else {
                let html = `<h2 style="font-family: var(--font-family-ui); font-size: 24px; font-weight: 600; color: var(--color-dark); margin: 0 0 24px 0;">${title}</h2>`;

                currentFormFields.forEach(field => {
                    if (field.type === 'section') {
                        html += `
                            <div style="margin: 32px 0 16px 0;">
                                <h3 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">${field.label}</h3>
                                <div style="height: 2px; background: var(--color-primary-blue);"></div>
                            </div>
                        `;
                    } else if (field.type === 'picture') {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    ${field.label}${field.required ? ' <span style="color: #ef4444;">*</span>' : ''}
                                </label>
                                ${field.imageUrl ? `<img src="${field.imageUrl}" alt="${field.label}" style="max-width: 100%; border-radius: 8px; border: 1px solid var(--color-neutral-border);">` : `<div style="padding: 40px; background: var(--color-neutral-background); border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: center; color: var(--color-neutral-text-muted);">No image URL provided</div>`}
                            </div>
                        `;
                    } else {
                        html += `<div style="margin-bottom: 20px;">`;
                        html += `<label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">${field.label}${field.required ? ' <span style="color: #ef4444;">*</span>' : ''}</label>`;

                        if (field.type === 'textarea') {
                            html += `<textarea placeholder="${field.placeholder}" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; min-height: 100px;" disabled></textarea>`;
                        } else if (field.type === 'dropdown') {
                            html += `<select style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;" disabled>`;
                            html += `<option>${field.placeholder || 'Select an option...'}</option>`;
                            field.options.forEach(opt => {
                                html += `<option>${opt}</option>`;
                            });
                            html += `</select>`;
                        } else if (field.type === 'radio') {
                            field.options.forEach((opt, i) => {
                                html += `<div style="display: flex; align-items: center; margin-bottom: 8px;"><input type="radio" name="preview_${field.id}" id="preview_${field.id}_${i}" style="margin-right: 8px;" disabled><label for="preview_${field.id}_${i}" style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text);">${opt}</label></div>`;
                            });
                        } else if (field.type === 'checkbox') {
                            field.options.forEach((opt, i) => {
                                html += `<div style="display: flex; align-items: center; margin-bottom: 8px;"><input type="checkbox" id="preview_${field.id}_${i}" style="margin-right: 8px;" disabled><label for="preview_${field.id}_${i}" style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text);">${opt}</label></div>`;
                            });
                        } else if (field.type === 'file') {
                            html += `<input type="file" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;" disabled>`;
                        } else if (field.type === 'scale') {
                            const min = field.scaleMin || 1;
                            const max = field.scaleMax || 10;
                            html += `<div style="display: flex; align-items: center; gap: 12px; margin: 20px 0;">`;
                            html += `<span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); min-width: 100px;">${field.scaleMinLabel || min}</span>`;
                            html += `<div style="flex: 1; display: flex; gap: 8px; justify-content: space-between;">`;
                            for (let i = min; i <= max; i++) {
                                html += `<label style="display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="radio" name="preview_scale_${field.id}" value="${i}" style="cursor: pointer;" disabled>
                                    <span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">${i}</span>
                                </label>`;
                            }
                            html += `</div>`;
                            html += `<span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); min-width: 100px; text-align: right;">${field.scaleMaxLabel || max}</span>`;
                            html += `</div>`;
                        } else if (field.type === 'likert') {
                            const options = field.likertOptions || ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
                            options.forEach((opt, i) => {
                                html += `<div style="display: flex; align-items: center; margin-bottom: 8px;"><input type="radio" name="preview_likert_${field.id}" id="preview_likert_${field.id}_${i}" style="margin-right: 8px;" disabled><label for="preview_likert_${field.id}_${i}" style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text);">${opt}</label></div>`;
                            });
                        } else {
                            const inputType = field.type === 'email' ? 'email' : field.type === 'number' ? 'number' : field.type === 'phone' ? 'tel' : field.type === 'date' ? 'date' : field.type === 'time' ? 'time' : 'text';
                            html += `<input type="${inputType}" placeholder="${field.placeholder}" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;" disabled>`;
                        }
                        html += `</div>`;
                    }
                });

                html += `<div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--color-neutral-border);"><button style="padding: 12px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: not-allowed; opacity: 0.6;">Submit (Preview Only)</button></div>`;

                container.innerHTML = html;
            }

            document.getElementById('formPreviewModal').style.display = 'flex';
        }

        function closeFormPreview() {
            document.getElementById('formPreviewModal').style.display = 'none';
        }

        // Dashboard Builder Functions
        let currentDashboardName = '';
        let dashboardVisualizations = [];

        function openDashboardBuilder(dashboardName) {
            currentDashboardName = dashboardName;
            document.getElementById('dashboardTitle').value = dashboardName;

            // Load existing visualizations if any
            const saved = localStorage.getItem(`dashboard_${dashboardName.toLowerCase().replace(/\s+/g, '_')}`);
            if (saved) {
                dashboardVisualizations = JSON.parse(saved);
            } else {
                dashboardVisualizations = [];
            }

            renderDashboardCanvas();
            document.getElementById('dashboardBuilderModal').style.display = 'flex';
        }

        function closeDashboardBuilder() {
            document.getElementById('dashboardBuilderModal').style.display = 'none';
            currentDashboardName = '';
            dashboardVisualizations = [];
        }

        function addVisualization(type) {
            const viz = {
                id: Date.now() + Math.random(),
                type: type,
                title: getVisualizationTitle(type),
                dataSource: 'Sample Data',
                width: type === 'kpi-card' ? 33 : 50, // % of container width
                tables: [], // Array of selected tables
                columns: [] // Array of selected columns
            };

            dashboardVisualizations.push(viz);
            renderDashboardCanvas();
        }

        function getVisualizationTitle(type) {
            const titles = {
                'bar-chart': 'Bar Chart',
                'line-chart': 'Line Chart',
                'pie-chart': 'Pie Chart',
                'area-chart': 'Area Chart',
                'scatter-plot': 'Scatter Plot',
                'gauge': 'Performance Gauge',
                'kpi-card': 'KPI Metric',
                'table': 'Data Table',
                'heatmap': 'Heatmap',
                'funnel': 'Conversion Funnel'
            };
            return titles[type] || 'Visualization';
        }

        function renderDashboardCanvas() {
            const canvas = document.getElementById('dashboardCanvas');

            if (dashboardVisualizations.length === 0) {
                canvas.innerHTML = `
                    <div style="text-align: center; padding: 80px 20px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-chart-line" style="font-size: 64px; margin-bottom: 16px;"></i>
                        <p style="font-size: 16px;">Click a visualization type to add it to your dashboard</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-wrap: wrap; gap: 20px;">';

            dashboardVisualizations.forEach((viz, index) => {
                const widthStyle = `width: calc(${viz.width}% - 10px);`;

                html += `
                    <div style="${widthStyle} background: white; border: 1px solid var(--color-neutral-border); border-radius: 12px; padding: 20px; min-height: 300px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">${viz.title}</h3>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="configureVisualization(${index})" style="padding: 6px 12px; background: white; border: 1px solid var(--color-primary-blue); color: var(--color-primary-blue); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600;">
                                    <i class="ph ph-gear" style="font-size: 14px;"></i> Configure
                                </button>
                                <button onclick="removeVisualization(${index})" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer;">
                                    <i class="ph ph-trash" style="font-size: 14px; color: #dc2626;"></i>
                                </button>
                            </div>
                        </div>
                        ${viz.tables.length > 0 ? `
                            <div style="margin-bottom: 12px; padding: 8px 12px; background: #e3f2fd; border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-primary-blue);">
                                <i class="ph ph-database"></i> Tables: ${viz.tables.join(', ')}
                            </div>
                        ` : ''}
                        <div style="display: flex; align-items: center; justify-content: center; height: 240px; background: var(--color-neutral-background); border-radius: 8px;">
                            ${renderVisualizationPlaceholder(viz.type, viz.tables.length > 0)}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            canvas.innerHTML = html;
        }

        function renderVisualizationPlaceholder(type, hasData) {
            const icons = {
                'bar-chart': 'ph-chart-bar',
                'line-chart': 'ph-chart-line',
                'pie-chart': 'ph-chart-pie-slice',
                'area-chart': 'ph-chart-line-up',
                'scatter-plot': 'ph-scatter-chart',
                'gauge': 'ph-gauge',
                'kpi-card': 'ph-number-square-one',
                'table': 'ph-table',
                'heatmap': 'ph-grid-four',
                'funnel': 'ph-funnel'
            };

            const icon = icons[type] || 'ph-chart-line';

            if (type === 'kpi-card' && hasData) {
                return `
                    <div style="text-align: center;">
                        <div style="font-family: var(--font-family-ui); font-size: 48px; font-weight: 700; color: var(--color-primary-blue); margin-bottom: 8px;">
                            $24.5K
                        </div>
                        <div style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text);">
                            <i class="ph ph-trend-up" style="color: #10b981;"></i> +12.5% from last month
                        </div>
                    </div>
                `;
            }

            if (hasData) {
                return `
                    <div style="text-align: center; color: var(--color-neutral-text);">
                        <i class="ph ${icon}" style="font-size: 48px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                        <p style="font-size: 13px; font-weight: 600;">Ready to display data</p>
                        <p style="font-size: 11px; color: var(--color-neutral-text-muted);">Visualization configured</p>
                    </div>
                `;
            }

            return `
                <div style="text-align: center; color: var(--color-neutral-text-muted);">
                    <i class="ph ${icon}" style="font-size: 48px; margin-bottom: 12px;"></i>
                    <p style="font-size: 13px;">Data visualization placeholder</p>
                    <p style="font-size: 11px;">Click Configure to select tables</p>
                </div>
            `;
        }

        function removeVisualization(index) {
            dashboardVisualizations.splice(index, 1);
            renderDashboardCanvas();
        }

        function saveDashboard() {
            const title = document.getElementById('dashboardTitle').value.trim();
            if (!title) {
                alert('Please enter a dashboard title.');
                return;
            }

            const key = `dashboard_${title.toLowerCase().replace(/\s+/g, '_')}`;
            localStorage.setItem(key, JSON.stringify(dashboardVisualizations));

            alert('Dashboard saved successfully!');
        }

        // Visualization Configuration Functions
        let currentConfigIndex = null;

        function configureVisualization(index) {
            currentConfigIndex = index;
            const viz = dashboardVisualizations[index];

            // Set title
            document.getElementById('vizConfigTitle').value = viz.title;

            // Load available tables and render checkboxes
            renderTableSelection(viz.tables);

            // Show modal
            document.getElementById('vizConfigModal').style.display = 'flex';
        }

        function renderTableSelection(selectedTables) {
            const container = document.getElementById('tableSelectionList');
            const availableTables = getAvailableTablesFromLocalStorage();

            if (availableTables.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-database" style="font-size: 32px; margin-bottom: 8px;"></i>
                        <p style="font-size: 13px;">No tables found</p>
                        <p style="font-size: 11px;">Create tables first to use in visualizations</p>
                    </div>
                `;
                return;
            }

            let html = '';
            availableTables.forEach((table, index) => {
                const isChecked = selectedTables.includes(table);
                html += `
                    <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                        <input type="checkbox" value="${table}" ${isChecked ? 'checked' : ''} onchange="updateTableSelection()" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 14px; color: var(--color-dark);">
                                <i class="ph ph-database" style="color: var(--color-primary-blue); margin-right: 4px;"></i>
                                ${table}
                            </div>
                        </div>
                    </label>
                `;
            });

            container.innerHTML = html;
        }

        function getAvailableTablesFromLocalStorage() {
            const tables = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('table_def_')) {
                    const tableName = key.replace('table_def_', '').replace(/_/g, ' ');
                    // Capitalize first letter of each word
                    const formattedName = tableName.split(' ').map(word =>
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    tables.push(formattedName);
                }
            }
            return tables.sort();
        }

        function updateTableSelection() {
            // This is called when checkboxes change - no action needed, just for UI feedback
        }

        function saveVizConfig() {
            if (currentConfigIndex === null) return;

            const viz = dashboardVisualizations[currentConfigIndex];

            // Update title
            viz.title = document.getElementById('vizConfigTitle').value.trim() || viz.title;

            // Get selected tables
            const checkboxes = document.querySelectorAll('#tableSelectionList input[type="checkbox"]');
            viz.tables = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    viz.tables.push(checkbox.value);
                }
            });

            closeVizConfig();
            renderDashboardCanvas();
        }

        function closeVizConfig() {
            document.getElementById('vizConfigModal').style.display = 'none';
            currentConfigIndex = null;
        }

        // Initialize demo forms if none exist
        function initializeDemoForms() {
            const existing = localStorage.getItem('professionalForms');
            if (existing) return; // Don't overwrite existing forms

            const demoForms = [
                {
                    title: 'Customer Feedback Survey',
                    status: 'open',
                    lastModified: new Date('2025-10-05').toISOString(),
                    createdDate: new Date('2025-09-20').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'About You', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Full Name', placeholder: 'Enter your full name', required: true, linkedTable: 'Customer Contacts', linkedColumn: 'Name', options: [] },
                        { id: 3, type: 'email', label: 'Email Address', placeholder: 'your.email@company.com', required: true, linkedTable: 'Customer Contacts', linkedColumn: 'Email', options: [] },
                        { id: 4, type: 'text', label: 'Company Name', placeholder: 'Your company', required: true, linkedTable: 'Customer Contacts', linkedColumn: 'Company', options: [] },
                        { id: 5, type: 'section', label: 'Your Experience', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 6, type: 'radio', label: 'How satisfied are you with our product?', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Very Satisfied', 'Satisfied', 'Neutral', 'Dissatisfied', 'Very Dissatisfied'] },
                        { id: 7, type: 'checkbox', label: 'Which features do you use most?', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: ['Dashboard', 'Reports', 'API Integration', 'Mobile App', 'Analytics', 'Collaboration Tools'] },
                        { id: 8, type: 'textarea', label: 'What improvements would you like to see?', placeholder: 'Share your suggestions...', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 9, type: 'dropdown', label: 'How likely are you to recommend us?', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['10 - Extremely Likely', '9', '8', '7', '6', '5', '4', '3', '2', '1', '0 - Not at all likely'] }
                    ]
                },
                {
                    title: 'Job Application Form',
                    status: 'open',
                    lastModified: new Date('2025-10-03').toISOString(),
                    createdDate: new Date('2025-09-15').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Personal Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'First Name', placeholder: 'First name', required: true, linkedTable: 'Job Candidates', linkedColumn: 'First Name', options: [] },
                        { id: 3, type: 'text', label: 'Last Name', placeholder: 'Last name', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Last Name', options: [] },
                        { id: 4, type: 'email', label: 'Email', placeholder: 'your.email@example.com', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Email', options: [] },
                        { id: 5, type: 'phone', label: 'Phone Number', placeholder: '(555) 123-4567', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Phone', options: [] },
                        { id: 6, type: 'section', label: 'Position Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 7, type: 'dropdown', label: 'Position Applying For', placeholder: '', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Position', options: ['Senior Software Engineer', 'Product Manager', 'UX Designer', 'DevOps Engineer', 'Data Scientist', 'Marketing Manager'] },
                        { id: 8, type: 'dropdown', label: 'Years of Experience', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['0-2 years', '3-5 years', '6-10 years', '10+ years'] },
                        { id: 9, type: 'date', label: 'Available Start Date', placeholder: '', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Start Date', options: [] },
                        { id: 10, type: 'section', label: 'Additional Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 11, type: 'textarea', label: 'Why do you want to work with us?', placeholder: 'Tell us about your interest in this position...', required: true, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 12, type: 'file', label: 'Upload Resume (PDF)', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 13, type: 'checkbox', label: 'I confirm that all information provided is accurate', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Yes, I confirm'] }
                    ]
                },
                {
                    title: 'Event Registration',
                    status: 'specific',
                    lastModified: new Date('2025-10-04').toISOString(),
                    createdDate: new Date('2025-09-25').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Attendee Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Full Name', placeholder: 'Your full name', required: true, linkedTable: 'Event Attendees', linkedColumn: 'Name', options: [] },
                        { id: 3, type: 'email', label: 'Email Address', placeholder: 'email@example.com', required: true, linkedTable: 'Event Attendees', linkedColumn: 'Email', options: [] },
                        { id: 4, type: 'text', label: 'Organization', placeholder: 'Company or organization', required: false, linkedTable: 'Event Attendees', linkedColumn: 'Organization', options: [] },
                        { id: 5, type: 'text', label: 'Job Title', placeholder: 'Your role', required: false, linkedTable: 'Event Attendees', linkedColumn: 'Title', options: [] },
                        { id: 6, type: 'section', label: 'Event Preferences', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 7, type: 'radio', label: 'Attendance Type', placeholder: '', required: true, linkedTable: 'Event Attendees', linkedColumn: 'Attendance Type', options: ['In-Person', 'Virtual'] },
                        { id: 8, type: 'checkbox', label: 'Which sessions are you interested in?', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: ['Keynote Address', 'Technical Workshop', 'Panel Discussion', 'Networking Session', 'Product Demo'] },
                        { id: 9, type: 'dropdown', label: 'Dietary Restrictions (In-Person Only)', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: ['None', 'Vegetarian', 'Vegan', 'Gluten-Free', 'Dairy-Free', 'Other'] },
                        { id: 10, type: 'textarea', label: 'Special Accommodations', placeholder: 'Please let us know if you need any special accommodations', required: false, linkedTable: '', linkedColumn: '', options: [] }
                    ]
                },
                {
                    title: 'Product Support Ticket',
                    status: 'open',
                    lastModified: new Date('2025-10-06').toISOString(),
                    createdDate: new Date('2025-10-01').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Contact Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Your Name', placeholder: 'Full name', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Customer Name', options: [] },
                        { id: 3, type: 'email', label: 'Email', placeholder: 'support@yourcompany.com', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Email', options: [] },
                        { id: 4, type: 'text', label: 'Account ID or Customer Number', placeholder: 'CUST-12345', required: false, linkedTable: 'Support Tickets', linkedColumn: 'Account ID', options: [] },
                        { id: 5, type: 'section', label: 'Issue Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 6, type: 'dropdown', label: 'Priority Level', placeholder: '', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Priority', options: ['Low - General Question', 'Medium - Minor Issue', 'High - Significant Impact', 'Critical - Service Down'] },
                        { id: 7, type: 'dropdown', label: 'Category', placeholder: '', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Category', options: ['Technical Issue', 'Billing Question', 'Feature Request', 'Account Access', 'Other'] },
                        { id: 8, type: 'text', label: 'Subject', placeholder: 'Brief description of the issue', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Subject', options: [] },
                        { id: 9, type: 'textarea', label: 'Detailed Description', placeholder: 'Please describe the issue in detail, including steps to reproduce...', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Description', options: [] },
                        { id: 10, type: 'file', label: 'Attach Screenshot or Log File', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] }
                    ]
                },
                {
                    title: 'Employee Onboarding Form',
                    status: 'shared',
                    lastModified: new Date('2025-10-02').toISOString(),
                    createdDate: new Date('2025-09-10').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Personal Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Legal First Name', placeholder: 'First name', required: true, linkedTable: 'Employees', linkedColumn: 'First Name', options: [] },
                        { id: 3, type: 'text', label: 'Legal Last Name', placeholder: 'Last name', required: true, linkedTable: 'Employees', linkedColumn: 'Last Name', options: [] },
                        { id: 4, type: 'email', label: 'Personal Email', placeholder: 'personal.email@example.com', required: true, linkedTable: 'Employees', linkedColumn: 'Personal Email', options: [] },
                        { id: 5, type: 'phone', label: 'Mobile Phone', placeholder: '(555) 123-4567', required: true, linkedTable: 'Employees', linkedColumn: 'Phone', options: [] },
                        { id: 6, type: 'date', label: 'Date of Birth', placeholder: '', required: true, linkedTable: 'Employees', linkedColumn: 'DOB', options: [] },
                        { id: 7, type: 'section', label: 'Employment Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 8, type: 'text', label: 'Job Title', placeholder: 'Your position', required: true, linkedTable: 'Employees', linkedColumn: 'Job Title', options: [] },
                        { id: 9, type: 'dropdown', label: 'Department', placeholder: '', required: true, linkedTable: 'Employees', linkedColumn: 'Department', options: ['Engineering', 'Product', 'Sales', 'Marketing', 'Customer Success', 'Operations', 'HR', 'Finance'] },
                        { id: 10, type: 'date', label: 'Start Date', placeholder: '', required: true, linkedTable: 'Employees', linkedColumn: 'Start Date', options: [] },
                        { id: 11, type: 'dropdown', label: 'Employment Type', placeholder: '', required: true, linkedTable: 'Employees', linkedColumn: 'Employment Type', options: ['Full-Time', 'Part-Time', 'Contract', 'Intern'] },
                        { id: 12, type: 'section', label: 'Equipment & Access', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 13, type: 'checkbox', label: 'Required Equipment', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Laptop', 'Monitor', 'Keyboard & Mouse', 'Headset', 'Mobile Phone'] },
                        { id: 14, type: 'textarea', label: 'Additional Notes or Requirements', placeholder: 'Any special requests or accommodations', required: false, linkedTable: '', linkedColumn: '', options: [] }
                    ]
                },
                {
                    title: 'Vendor Information Form',
                    status: 'draft',
                    lastModified: new Date('2025-09-28').toISOString(),
                    createdDate: new Date('2025-09-28').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Company Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Company Legal Name', placeholder: 'Full legal business name', required: true, linkedTable: 'Vendors', linkedColumn: 'Company Name', options: [] },
                        { id: 3, type: 'text', label: 'Tax ID / EIN', placeholder: 'XX-XXXXXXX', required: true, linkedTable: 'Vendors', linkedColumn: 'Tax ID', options: [] },
                        { id: 4, type: 'email', label: 'Primary Contact Email', placeholder: 'contact@vendor.com', required: true, linkedTable: 'Vendors', linkedColumn: 'Email', options: [] },
                        { id: 5, type: 'phone', label: 'Business Phone', placeholder: '(555) 123-4567', required: true, linkedTable: 'Vendors', linkedColumn: 'Phone', options: [] },
                        { id: 6, type: 'text', label: 'Website', placeholder: 'https://www.vendor.com', required: false, linkedTable: 'Vendors', linkedColumn: 'Website', options: [] },
                        { id: 7, type: 'section', label: 'Service Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 8, type: 'checkbox', label: 'Services Provided', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Software Development', 'Consulting', 'Cloud Services', 'Marketing', 'Legal Services', 'Accounting', 'HR Services'] },
                        { id: 9, type: 'textarea', label: 'Service Description', placeholder: 'Describe the services you provide', required: true, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 10, type: 'dropdown', label: 'Insurance Coverage', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Yes - General Liability', 'Yes - Professional Liability', 'Yes - Both', 'No Insurance'] }
                    ]
                }
            ];

            localStorage.setItem('professionalForms', JSON.stringify(demoForms));
        }

        // Initialize demo table relationships if none exist
        function initializeDemoTableRelationships() {
            // Check if relationships already exist - for now, let's always reinitialize to fix the table names
            const existingRelationships = localStorage.getItem('tableRelationships');

            // Temporarily always reinitialize to fix case mismatch issues
            // TODO: Remove this override after first successful load
            // if (existingRelationships && JSON.parse(existingRelationships).length > 0) return;

            // Define logical relationships between the 10 existing tables
            const demoRelationships = [
                {
                    sourceTable: 'customers',
                    targetTable: 'contacts',
                    sourceColumn: 'Contact_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Customer has primary contact'
                },
                {
                    sourceTable: 'projects',
                    targetTable: 'customers',
                    sourceColumn: 'Customer_ID',
                    targetColumn: 'Customer_ID',
                    type: 'many-to-one',
                    label: 'Projects belong to customers'
                },
                {
                    sourceTable: 'tasks',
                    targetTable: 'projects',
                    sourceColumn: 'Project_ID',
                    targetColumn: 'Project_ID',
                    type: 'many-to-one',
                    label: 'Tasks are part of projects'
                },
                {
                    sourceTable: 'tasks',
                    targetTable: 'contacts',
                    sourceColumn: 'Assigned_To_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Tasks assigned to team members'
                },
                {
                    sourceTable: 'inventory',
                    targetTable: 'vendors',
                    sourceColumn: 'Supplier_ID',
                    targetColumn: 'Vendor_ID',
                    type: 'many-to-one',
                    label: 'Inventory items sourced from vendors'
                },
                {
                    sourceTable: 'events',
                    targetTable: 'projects',
                    sourceColumn: 'Project_ID',
                    targetColumn: 'Project_ID',
                    type: 'many-to-one',
                    label: 'Project milestones and meetings'
                },
                {
                    sourceTable: 'assets',
                    targetTable: 'contacts',
                    sourceColumn: 'Owner_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Assets assigned to team members'
                },
                {
                    sourceTable: 'issues',
                    targetTable: 'projects',
                    sourceColumn: 'Project_ID',
                    targetColumn: 'Project_ID',
                    type: 'many-to-one',
                    label: 'Issues tracked by project'
                },
                {
                    sourceTable: 'issues',
                    targetTable: 'contacts',
                    sourceColumn: 'Assigned_To_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Issues assigned to team members'
                },
                {
                    sourceTable: 'expenses',
                    targetTable: 'projects',
                    sourceColumn: 'Project_ID',
                    targetColumn: 'Project_ID',
                    type: 'many-to-one',
                    label: 'Project-related expenses'
                },
                {
                    sourceTable: 'expenses',
                    targetTable: 'contacts',
                    sourceColumn: 'Submitted_By_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Expenses submitted by team members'
                },
                {
                    sourceTable: 'expenses',
                    targetTable: 'vendors',
                    sourceColumn: 'Vendor_ID',
                    targetColumn: 'Vendor_ID',
                    type: 'many-to-one',
                    label: 'Expenses paid to vendors'
                },
                {
                    sourceTable: 'assets',
                    targetTable: 'vendors',
                    sourceColumn: 'Vendor_ID',
                    targetColumn: 'Vendor_ID',
                    type: 'many-to-one',
                    label: 'Assets purchased from vendors'
                }
            ];

            localStorage.setItem('tableRelationships', JSON.stringify(demoRelationships));
        }

        // Initialize demo documents if none exist
        function initializeDemoDocuments() {
            // Check if any persona documents already exist
            const existingRetail = localStorage.getItem('retailManagerDocuments');
            const existingChemist = localStorage.getItem('researchChemistDocuments');
            const existingGraduate = localStorage.getItem('newGraduateDocuments');
            const existingAnalyst = localStorage.getItem('dataAnalystDocuments');

            // Temporarily disabled to force re-initialization with new multi-modal documents
            // if (existingRetail || existingChemist || existingGraduate || existingAnalyst) return;

            // RETAIL MANAGER DOCUMENTS
            const retailManagerDocuments = [
                {
                    title: 'Store Technology Rollout Plan - Phase 2',
                    lastModified: new Date('2025-10-30').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['CTO', 'IT', 'DM', 'AM'],
                    blocks: [
                        { id: 'tr1', type: 'header', level: 1, content: 'Store Technology Rollout Plan - Phase 2' },
                        { id: 'tr2', type: 'text', content: 'This document outlines the comprehensive plan for Phase 2 of our store technology modernization initiative, focusing on point-of-sale system upgrades, inventory management automation, and customer experience enhancements. Implementation timeline spans Q1-Q2 2026 across 47 store locations.' },

                        { id: 'tr3', type: 'header', level: 2, content: 'Executive Summary' },
                        { id: 'tr4', type: 'text', content: 'Phase 2 builds upon the successful completion of Phase 1 (network infrastructure) and introduces customer-facing technology improvements. Key deliverables include new POS terminals with contactless payment support, real-time inventory tracking systems, and digital signage integration. Total budget allocated: $2.4M with expected ROI of 18% within 24 months.' },

                        { id: 'tr5', type: 'header', level: 2, content: 'Technology Architecture' },
                        { id: 'tr6', type: 'mermaid', content: 'graph TD\n    A[Store Manager Dashboard] --> B[POS System]\n    A --> C[Inventory Management]\n    A --> D[Customer Analytics]\n    B --> E[Payment Processing]\n    B --> F[Receipt Management]\n    C --> G[RFID Scanners]\n    C --> H[Automated Reordering]\n    D --> I[Loyalty Program Integration]\n    D --> J[Digital Signage]\n    E --> K[Cloud Payment Gateway]\n    F --> L[Email/SMS Receipts]\n    style A fill:#e3f2fd\n    style K fill:#f3e5f5\n    style L fill:#f3e5f5' },

                        { id: 'tr7', type: 'header', level: 2, content: 'Implementation Timeline' },
                        { id: 'tr8', type: 'table', content: 'Phase,Duration,Stores,Key Activities,Budget\nPilot Testing,Jan 15 - Feb 15,3 stores,Hardware installation and staff training,$145K\nWave 1 Rollout,Feb 16 - Mar 31,12 stores,Full system deployment,$580K\nWave 2 Rollout,Apr 1 - May 15,16 stores,Continued deployment + optimization,$725K\nWave 3 Rollout,May 16 - Jun 30,16 stores,Final deployment phase,$950K\nTotal Project,,47 stores,Complete technology modernization,$2.4M' },

                        { id: 'tr9', type: 'header', level: 2, content: 'Technical Specifications' },
                        { id: 'tr10', type: 'header', level: 3, content: 'POS System Requirements' },
                        { id: 'tr11', type: 'code', content: '// POS Terminal Configuration\n{\n  "hardware": {\n    "processor": "Intel i5-12400 or AMD Ryzen 5",\n    "memory": "8GB DDR4",\n    "storage": "256GB NVMe SSD",\n    "display": "15.6\\" touchscreen, 1920x1080",\n    "connectivity": ["WiFi 6", "Gigabit Ethernet", "USB 3.2", "NFC"]\n  },\n  "software": {\n    "os": "Windows 11 IoT Enterprise LTSC",\n    "pos_app": "RetailPro v12.3",\n    "payment_gateway": "SecurePayments API v3.1",\n    "backup": "Real-time cloud sync every 30 seconds"\n  },\n  "security": {\n    "encryption": "AES-256 at rest, TLS 1.3 in transit",\n    "authentication": "Multi-factor with biometric support",\n    "compliance": ["PCI DSS Level 1", "SOX", "GDPR"]\n  }\n}' },

                        { id: 'tr12', type: 'header', level: 3, content: 'Network Infrastructure' },
                        { id: 'tr13', type: 'text', content: 'Each store requires dedicated fiber internet connection (minimum 100Mbps up/down) with backup 5G cellular failover. Internal network consists of managed switches supporting PoE+ for digital signage and RFID readers. WiFi 6 access points provide customer and staff connectivity with separate VLANs for security.' },

                        { id: 'tr14', type: 'header', level: 2, content: 'Training & Change Management' },
                        { id: 'tr15', type: 'text', content: 'Comprehensive training program developed for three staff levels: store managers, associate managers, and sales associates. Training includes 4-hour hands-on workshops, online certification modules, and ongoing support documentation. Change management strategy focuses on demonstrating efficiency gains and customer experience improvements.' },

                        { id: 'tr16', type: 'header', level: 3, content: 'Training Schedule by Role' },
                        { id: 'tr17', type: 'table', content: 'Role,Training Duration,Format,Certification Required,Support Level\nStore Manager,8 hours,In-person workshop + online,Yes - Advanced Certification,Direct IT contact\nAssociate Manager,6 hours,Hybrid (4h in-person + 2h online),Yes - Standard Certification,Store manager + help desk\nSales Associate,4 hours,In-person hands-on,Basic proficiency test,Associate manager support\nSeasonal Staff,2 hours,Online modules only,Quick competency check,Peer buddy system' },

                        { id: 'tr18', type: 'header', level: 2, content: 'Risk Assessment & Mitigation' },
                        { id: 'tr19', type: 'text', content: 'Primary risks include system downtime during peak shopping periods, staff resistance to new technology, and potential payment processing disruptions. Mitigation strategies include comprehensive testing protocols, backup payment methods, and dedicated support team during rollout phases.' },

                        { id: 'tr20', type: 'divider', content: '', dividerType: 'page' },

                        { id: 'tr21', type: 'header', level: 2, content: 'Success Metrics & KPIs' },
                        { id: 'tr22', type: 'latex', content: '\\text{Customer Satisfaction Score} = \\frac{\\sum_{i=1}^{n} \\text{Rating}_i}{n} \\geq 4.2\n\n\\text{Transaction Speed Improvement} = \\frac{\\text{Old Average Time} - \\text{New Average Time}}{\\text{Old Average Time}} \\times 100\\% \\geq 25\\%\n\n\\text{System Uptime} = \\frac{\\text{Total Operational Hours} - \\text{Downtime Hours}}{\\text{Total Operational Hours}} \\times 100\\% \\geq 99.5\\%' },

                        { id: 'tr23', type: 'text', content: 'Success will be measured through customer satisfaction surveys, transaction processing speed analysis, system uptime monitoring, and staff productivity metrics. Monthly reviews with district managers will track progress against these KPIs and identify areas for optimization.' }
                    ]
                },
                {
                    title: 'Q4 Holiday Staffing Plan',
                    lastModified: new Date('2025-10-15').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['DM', 'HR', 'AM'],
                    blocks: [
                        { id: 'r1', type: 'header', level: 1, content: 'Q4 Holiday Staffing Plan' },
                        { id: 'r2', type: 'text', content: 'This document outlines staffing requirements and scheduling strategy for the upcoming holiday season (November - December 2025). Based on historical sales data and projected foot traffic, we anticipate a 45% increase in customer volume during peak shopping periods.\n\nKey objectives: Ensure adequate floor coverage during peak hours, minimize labor costs while maintaining service quality, provide fair schedule distribution, and maintain compliance with labor regulations.' },
                        { id: 'r3', type: 'header', level: 2, content: 'Staffing Requirements' },
                        { id: 'r4', type: 'table', content: 'Week,Required Staff,Peak Hours,Estimated Sales\nNov 25-Dec 1,28,10am-8pm,$185K\nDec 2-Dec 8,22,11am-7pm,$142K\nDec 9-Dec 15,26,10am-9pm,$168K\nDec 16-Dec 22,32,9am-9pm,$225K\nDec 23-Dec 25,18,10am-6pm,$95K' },
                        { id: 'r5', type: 'header', level: 2, content: 'Schedule Timeline' },
                        { id: 'r6', type: 'mermaid', content: 'gantt\n    title Holiday Staffing Schedule\n    dateFormat  YYYY-MM-DD\n    section Black Friday\n    Peak Coverage :a1, 2025-11-28, 3d\n    section Mid-Season\n    Standard Coverage :a2, 2025-12-01, 14d\n    section Final Rush\n    Maximum Coverage :a3, 2025-12-15, 8d' },
                        { id: 'r7', type: 'header', level: 2, content: 'Coverage Analysis' },
                        { id: 'r8', type: 'text', content: 'Based on 2024 performance data, we need minimum 3 cashiers, 4 sales floor associates, 2 fitting room attendants, 1 stock clerk, and 1 manager on duty during peak hours. Weekend coverage requires 25% additional staff. Break schedules must comply with state labor laws (30min unpaid for shifts >6 hours).' }
                    ]
                },
                {
                    title: 'Inventory Management Report - October 2025',
                    lastModified: new Date('2025-10-12').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['DM', 'VM', 'PC'],
                    blocks: [
                        { id: 'i1', type: 'header', level: 1, content: 'Monthly Inventory Analysis - October 2025' },
                        { id: 'i2', type: 'text', content: 'This report analyzes current stock levels, identifies reorder needs, and highlights performance metrics for October 2025. Total inventory value: $485K across 2,847 unique SKUs. Critical attention needed for 47 items below safety stock levels.' },
                        { id: 'i3', type: 'header', level: 2, content: 'Low Stock Alert' },
                        { id: 'i4', type: 'table', content: 'SKU,Product,Current Stock,Min Level,Reorder Qty,Supplier\nWJ-001,Winter Jacket Blue M,3,15,50,North Coast\nBT-205,Leather Boots Size 9,2,10,25,Footwear Plus\nSW-089,Cashmere Sweater L,1,8,20,Premium Knits\nJN-445,Skinny Jeans 32x32,4,12,30,Denim Works\nAC-223,Silk Scarf Floral,0,5,15,Luxury Access' },
                        { id: 'i5', type: 'header', level: 2, content: 'Top Performers' },
                        { id: 'i6', type: 'table', content: 'Product Category,Units Sold,Revenue,Margin %\nWomen Outerwear,234,$28,450,65%\nFootwear,189,$31,200,58%\nAccessories,156,$12,800,72%\nMen Casual,143,$19,600,61%\nDresses,128,$22,100,68%' },
                        { id: 'i7', type: 'header', level: 2, content: 'Seasonal Recommendations' },
                        { id: 'i8', type: 'text', content: 'With holiday season approaching, recommend increasing winter apparel inventory by 40%. Focus on coat sizes M-XL, boots sizes 7-10, and gift accessories under $50. Monitor cashmere and wool items closely - demand typically peaks in November.' }
                    ]
                },
                {
                    title: 'Store Performance Review - Q3 2025',
                    lastModified: new Date('2025-10-08').toISOString(),
                    documentType: 'unstructured',
                    sharedWith: ['RM', 'DM'],
                    richTextContent: '<h1>Store Performance Review - Third Quarter 2025</h1><p>This quarterly review assesses overall store performance across key metrics including sales, customer satisfaction, team productivity, and operational efficiency. Q3 results show strong performance with several areas for continued focus and improvement.</p><h2>Sales Performance</h2><p><strong>Revenue:</strong> $847,000 (vs $785K target) - 8% over goal<br><strong>Transactions:</strong> 15,420 (average ticket $54.95)<br><strong>Conversion Rate:</strong> 68% (up from 64% in Q2)<br><strong>Return Rate:</strong> 8.2% (within acceptable range)</p><p>Notable achievements include successful back-to-school campaign driving 23% increase in August sales, effective cross-selling program boosting average transaction by $8, and improved inventory management reducing stockouts by 40%.</p><h2>Customer Experience</h2><p>Customer satisfaction scores averaged 4.3/5 (target: 4.2). Mystery shopper evaluations rated service at 87/100, with particular strength in product knowledge and greeting protocols. Areas for improvement include checkout speed during peak hours and fitting room maintenance.</p><p>Customer feedback themes: Excellent product selection (mentioned in 78% of positive reviews), friendly staff (mentioned in 65%), competitive pricing (mentioned in 52%). Primary complaint: long checkout lines during weekends.</p><h2>Team Performance</h2><p>Team of 18 associates maintained strong performance metrics. Attendance rate 94%, punctuality 97%. Three team members earned recognition for exceptional customer service. Sales per hour averaged $127 across the team, with top performer reaching $156/hour.</p><p><strong>Recommendations for Q4:</strong> Implement mobile checkout during peak periods, enhance weekend staffing, focus on winter merchandise presentation, and continue customer service excellence initiatives. Target Q4 revenue: $925,000.</p>'
                },
                {
                    title: 'Customer Loyalty Program Analysis',
                    lastModified: new Date('2025-11-02').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['MM', 'DM', 'CM'],
                    blocks: [
                        { id: 'cl1', type: 'header', level: 1, content: 'Customer Loyalty Program Performance Analysis' },
                        { id: 'cl2', type: 'text', content: 'This document analyzes our customer loyalty program performance over the past 6 months since launch. The "Style Rewards" program has enrolled 2,847 customers with strong engagement metrics and measurable impact on repeat purchase behavior.' },

                        { id: 'cl3', type: 'header', level: 2, content: 'Program Overview & Metrics' },
                        { id: 'cl4', type: 'table', content: 'Metric,Current Value,Target,Status\nTotal Enrolled Members,2847,2500,✓ Exceeded\nActive Members (90 days),1923,1800,✓ Exceeded\nAverage Points per Member,1240,1000,✓ Exceeded\nRedemption Rate,34%,25%,✓ Exceeded\nMember Retention Rate,78%,70%,✓ Exceeded\nIncremental Revenue,+$127K,+$100K,✓ Exceeded' },

                        { id: 'cl5', type: 'header', level: 2, content: 'Technical Implementation' },
                        { id: 'cl6', type: 'text', content: 'The loyalty system integrates with our existing POS infrastructure through a REST API connection. Real-time point calculation and tier status updates occur at transaction completion. Mobile app enrollment drives 68% of new sign-ups.' },

                        { id: 'cl7', type: 'code', content: '// Loyalty Points Calculation Logic\nfunction calculatePoints(transaction) {\n  const baseRate = 1; // 1 point per $1 spent\n  let multiplier = 1;\n  \n  // Tier bonuses\n  if (customer.tier === "Silver") multiplier = 1.25;\n  if (customer.tier === "Gold") multiplier = 1.5;\n  if (customer.tier === "Platinum") multiplier = 2.0;\n  \n  // Category bonuses\n  const categoryBonuses = {\n    "new-arrivals": 2.0,\n    "seasonal": 1.5,\n    "accessories": 1.25\n  };\n  \n  let totalPoints = 0;\n  transaction.items.forEach(item => {\n    const categoryMultiplier = categoryBonuses[item.category] || 1;\n    const itemPoints = item.price * baseRate * multiplier * categoryMultiplier;\n    totalPoints += Math.floor(itemPoints);\n  });\n  \n  return totalPoints;\n}' },

                        { id: 'cl8', type: 'header', level: 2, content: 'Member Engagement Analysis' },
                        { id: 'cl9', type: 'mermaid', content: 'pie title Member Distribution by Tier\n    "Bronze (0-499 pts)" : 1156\n    "Silver (500-1499 pts)" : 1024\n    "Gold (1500-2999 pts)" : 487\n    "Platinum (3000+ pts)" : 180' },

                        { id: 'cl10', type: 'header', level: 3, content: 'Purchase Behavior Insights' },
                        { id: 'cl11', type: 'table', content: 'Customer Segment,Avg Transaction,Visit Frequency,Favorite Categories\nPlatinum Members,$89.40,2.3x/month,Designer • Accessories • Shoes\nGold Members,$67.20,1.8x/month,Seasonal • Outerwear • Handbags\nSilver Members,$52.10,1.4x/month,Basic • Casual • Sale Items\nBronze Members,$41.80,0.9x/month,Essentials • Clearance • Basics' },

                        { id: 'cl12', type: 'divider', content: '' },

                        { id: 'cl13', type: 'header', level: 2, content: 'Success Metrics & ROI' },
                        { id: 'cl14', type: 'latex', content: '\\text{Program ROI} = \\frac{\\text{Incremental Revenue} - \\text{Program Costs}}{\\text{Program Costs}} \\times 100\\%\n\n\\text{Current ROI} = \\frac{\\$127,000 - \\$32,000}{\\$32,000} \\times 100\\% = 297\\%\n\n\\text{Customer Lifetime Value Increase} = \\frac{\\text{Member CLV} - \\text{Non-Member CLV}}{\\text{Non-Member CLV}} \\times 100\\% = +43\\%' },

                        { id: 'cl15', type: 'header', level: 2, content: 'Recommendations' },
                        { id: 'cl16', type: 'markdown', content: '**Immediate Actions (Next 30 days):**\n\n- [ ] Launch referral bonus program (500 points for successful referral)\n- [ ] Implement birthday month double points promotion\n- [ ] Add exclusive early access to sales for Gold+ members\n\n**Medium-term Initiatives (Next Quarter):**\n\n- [ ] Partner with local businesses for cross-promotional point earning\n- [ ] Develop personalized product recommendations based on purchase history\n- [ ] Create VIP shopping events for Platinum members\n\n**Long-term Strategy (6+ months):**\n\n- [ ] Expand program to include experiential rewards (styling sessions, events)\n- [ ] Integrate with social media for engagement-based point earning\n- [ ] Develop mobile app with gamification features' },

                        { id: 'cl17', type: 'text', content: 'The loyalty program has exceeded all initial targets and demonstrates strong potential for continued growth. Member satisfaction scores average 4.6/5, with 89% of surveyed members saying the program influences their shopping decisions. Recommend increasing marketing budget by 25% to accelerate enrollment growth.' }
                    ]
                }
            ];

            // RESEARCH CHEMIST DOCUMENTS
            const researchChemistDocuments = [
                {
                    title: 'Lab Safety Protocol - Chemical Handling',
                    lastModified: new Date('2025-10-18').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['LS', 'RC', 'PD'],
                    blocks: [
                        { id: 'c1', type: 'header', level: 1, content: 'Chemical Handling Safety Protocol' },
                        { id: 'c2', type: 'text', content: 'This document outlines mandatory safety procedures for handling hazardous chemicals in Laboratory B-12. All personnel must complete safety training before working with Class 3 or higher chemicals. Last updated following OSHA inspection recommendations.' },
                        { id: 'c3', type: 'header', level: 2, content: 'Personal Protective Equipment (PPE)' },
                        { id: 'c4', type: 'markdown', content: '**Required for all chemical work:**\n\n- [ ] Safety goggles (ANSI Z87.1 compliant)\n- [ ] Lab coat (flame-resistant, knee-length)\n- [ ] Closed-toe shoes (no sandals/heels)\n- [ ] Long pants (no shorts/skirts)\n\n**Additional PPE by hazard class:**\n- [ ] Nitrile gloves (Class 1-2 chemicals)\n- [ ] Butyl rubber gloves (Class 3+ chemicals)\n- [ ] Face shield (corrosive materials)\n- [ ] Respirator (volatile organics, as specified)' },
                        { id: 'c5', type: 'header', level: 2, content: 'Chemical Classifications' },
                        { id: 'c6', type: 'table', content: 'Class,Hazard Level,Examples,Storage Temp,Special Requirements\n1,Low,NaCl H₂O,Room Temp,Standard cabinet\n2,Moderate,Ethanol Acetone,Room Temp,Ventilated cabinet\n3,High,HCl NaOH,Room Temp,Locked acid/base cabinet\n4,Severe,Benzene CCl₄,4°C,Restricted access freezer\n5,Extreme,HF Osmium,4°C,Dual approval required' },
                        { id: 'c7', type: 'header', level: 2, content: 'Emergency Procedures' },
                        { id: 'c8', type: 'text', content: 'In case of spill: Evacuate area, activate emergency shower if skin contact, call Safety Office (x4911). Eye wash stations located at exits. Emergency shut-off valves are red-handled near each workbench. Spill kits contain neutralizing agents for acids/bases.' }
                    ]
                },
                {
                    title: 'Experiment Log - Polymer Synthesis #347',
                    lastModified: new Date('2025-10-22').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['PI', 'LT', 'RC'],
                    blocks: [
                        { id: 'e1', type: 'header', level: 1, content: 'Polymer Synthesis Experiment #347' },
                        { id: 'e2', type: 'text', content: 'Objective: Synthesize biodegradable polyester from renewable monomers using ring-opening polymerization. Target molecular weight: 15,000-25,000 g/mol. Expected yield: >85%. This experiment is part of the sustainable materials research project.' },
                        { id: 'e3', type: 'header', level: 2, content: 'Materials and Reagents' },
                        { id: 'e4', type: 'table', content: 'Chemical,CAS Number,Amount,Purity,Supplier\nL-Lactide,4511-42-6,5.0g,99.5%,Sigma-Aldrich\nTin(II) ethylhexanoate,301-10-0,50mg,95%,TCI Chemicals\nDodecanol,112-53-8,100mg,98%,Fisher Scientific\nToluene,108-88-3,50mL,99.8%,EMD Millipore\nMethanol,67-56-1,200mL,99.9%,Fisher Scientific' },
                        { id: 'e5', type: 'header', level: 2, content: 'Procedure' },
                        { id: 'e6', type: 'text', content: '1. Set up reaction under nitrogen atmosphere in flame-dried glassware\n2. Dissolve L-lactide (5.0g, 34.7 mmol) in anhydrous toluene (30 mL)\n3. Add dodecanol initiator (100 mg, 0.54 mmol) and Sn(Oct)₂ catalyst (50 mg)\n4. Heat to 130°C and monitor by ¹H NMR (aliquots at 2, 4, 8 hours)\n5. Cool to RT, precipitate in cold methanol, filter and dry under vacuum' },
                        { id: 'e7', type: 'header', level: 2, content: 'Results and Analysis' },
                        { id: 'e8', type: 'table', content: 'Time (h),Conversion (%),Mn (g/mol),PDI,Yield (%)\n2,45,8500,1.2,-\n4,78,18200,1.4,-\n8,92,22500,1.6,87' },
                        { id: 'e9', type: 'code', language: 'python', content: '# Molecular weight calculation\nimport numpy as np\n\n# GPC data analysis\nretention_times = [15.2, 16.8, 18.1, 19.4]\nmolecular_weights = [45000, 22500, 12000, 5000]\n\n# Calculate polydispersity\nMn = 22500  # Number average\nMw = 36000  # Weight average\nPDI = Mw / Mn\nprint(f"PDI: {PDI:.2f}")' }
                    ]
                },
                {
                    title: 'Research Proposal - Biodegradable Plastics Study',
                    lastModified: new Date('2025-10-20').toISOString(),
                    documentType: 'unstructured',
                    sharedWith: ['PI', 'DH', 'FO'],
                    richTextContent: '<h1>Research Proposal: Development of Marine-Degradable Plastic Alternatives</h1><h2>Abstract</h2><p>This proposal outlines a 18-month research project to develop novel biodegradable polymer materials specifically designed for marine environments. Current biodegradable plastics degrade poorly in saltwater conditions, contributing to ocean pollution. Our approach combines renewable monomers with marine-specific degradation pathways to create packaging materials that break down within 6 months in seawater.</p><h2>Research Objectives</h2><p><strong>Primary Goal:</strong> Synthesize and characterize biodegradable polymers with marine degradation rates <180 days</p><p><strong>Specific Aims:</strong></p><ul><li>Develop three polymer series based on alginate, chitosan, and PHA platforms</li><li>Optimize mechanical properties to match conventional plastic films</li><li>Conduct accelerated marine degradation testing per ASTM D6691</li><li>Evaluate eco-toxicity using standard marine organism bioassays</li><li>Scale synthesis to 100g batches for application testing</li></ul><h2>Literature Review</h2><p>Marine plastic pollution affects 700+ species and costs global economies $13B annually. Current biodegradable alternatives like PLA require industrial composting at 58°C, unsuitable for ocean environments. Recent advances in marine-degradable polymers show promise, with seaweed-based materials achieving 60% degradation in 90 days. However, mechanical properties remain insufficient for packaging applications.</p><h2>Methodology</h2><p>We will employ ring-opening polymerization and enzymatic catalysis to synthesize target polymers. Marine degradation testing will be conducted in artificial seawater at 15°C, 25°C, and 35°C to simulate global ocean conditions. Polymer characterization will include GPC, DSC, tensile testing, and FTIR analysis. Degradation products will be analyzed by LC-MS.</p><h2>Budget and Timeline</h2><p><strong>Total Budget:</strong> $185,000 over 18 months</p><p><strong>Phase 1</strong> (Months 1-6): Polymer synthesis and optimization - $65K<br><strong>Phase 2</strong> (Months 7-12): Marine degradation studies - $75K<br><strong>Phase 3</strong> (Months 13-18): Scale-up and application testing - $45K</p><p><strong>Expected Outcomes:</strong> 3 peer-reviewed publications, 2 patent applications, demonstration of commercial viability for marine-degradable packaging materials with potential market impact of $500M+ in sustainable packaging sector.</p>'
                },
                {
                    title: 'Spectroscopy Data Analysis - Compound X47B',
                    lastModified: new Date('2025-11-01').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['RC', 'PI', 'GS'],
                    blocks: [
                        { id: 'sp1', type: 'header', level: 1, content: 'Spectroscopic Characterization of Compound X47B' },
                        { id: 'sp2', type: 'text', content: 'Complete structural elucidation of novel heterocyclic compound X47B (C₁₅H₁₁NO₃S) synthesized via multi-step reaction sequence. Molecular weight confirmed at 285.32 g/mol by high-resolution mass spectrometry. All spectroscopic data consistent with proposed quinoline-thiophene structure.' },

                        { id: 'sp3', type: 'header', level: 2, content: 'Experimental Conditions' },
                        { id: 'sp4', type: 'table', content: 'Analysis,Instrument,Solvent,Temperature,Acquisition Parameters\n¹H NMR,Bruker 500 MHz,CDCl₃,25°C,32 scans 0.8 Hz resolution\n¹³C NMR,Bruker 125 MHz,CDCl₃,25°C,1024 scans proton-decoupled\nIR Spectroscopy,Perkin-Elmer FT-IR,KBr pellet,RT,4000-400 cm⁻¹ 2 cm⁻¹ resolution\nMS Analysis,Agilent Q-TOF,MeCN/H₂O,RT,ESI positive mode 50-800 m/z\nUV-Vis,Shimadzu UV-2600,EtOH,RT,200-800 nm 0.5 nm bandwidth' },

                        { id: 'sp5', type: 'header', level: 2, content: 'Molecular Structure' },
                        { id: 'sp6', type: 'image', content: 'https://via.placeholder.com/400x300/0066CC/FFFFFF?text=Compound+X47B+Structure' },

                        { id: 'sp7', type: 'header', level: 2, content: 'NMR Data Processing' },
                        { id: 'sp8', type: 'code', language: 'python', content: '# NMR Data Analysis Script\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy.optimize import curve_fit\n\n# ¹H NMR chemical shifts (ppm) and integrations\nh_shifts = [8.92, 8.45, 7.89, 7.73, 7.42, 7.28, 6.95, 4.12, 1.45]\nh_integrals = [1, 1, 1, 2, 2, 1, 1, 2, 3]\nh_multiplicities = ["d", "d", "dd", "m", "m", "s", "s", "q", "t"]\n\n# Calculate theoretical vs experimental integrations\ntotal_protons = 11  # from molecular formula\ntheoretical = [h * total_protons / sum(h_integrals) for h in h_integrals]\nprint("Theoretical integrations:", theoretical)\n\n# ¹³C NMR data processing\nc_shifts = [162.4, 158.1, 149.3, 142.8, 135.7, 131.2, 128.9, 126.4, 125.1, 121.8, 118.6, 65.2, 14.8]\nprint(f"Carbon count: {len(c_shifts)} (Expected: 15)")' },

                        { id: 'sp9', type: 'header', level: 2, content: 'Spectral Assignments' },
                        { id: 'sp10', type: 'table', content: 'Position,¹H NMR (ppm),¹³C NMR (ppm),Assignment,COSY Correlations\nH-2,8.92 (d),149.3,Quinoline H-2,H-3\nH-3,8.45 (d),121.8,Quinoline H-3,H-2 H-4\nH-4,7.89 (dd),135.7,Quinoline H-4,H-3\nH-5/H-6,7.73 (m),131.2 128.9,Quinoline aromatics,Complex multipicity\nH-7/H-8,7.42 (m),126.4 125.1,Quinoline aromatics,Complex multicity\nH-thiophene,7.28 (s),142.8,Thiophene H-2,Isolated singlet\nH-aromatic,6.95 (s),118.6,Substituted aromatic,Isolated singlet\nOCH₂,4.12 (q),65.2,Ethyl ester CH₂,CH₃ triplet\nCH₃,1.45 (t),14.8,Ethyl ester CH₃,OCH₂ quartet' },

                        { id: 'sp11', type: 'header', level: 2, content: 'IR Spectroscopy Analysis' },
                        { id: 'sp12', type: 'mermaid', content: 'graph LR\n    A[4000 cm⁻¹] --> B[C-H Stretch<br>3045-3005 cm⁻¹]\n    A --> C[C=O Stretch<br>1725 cm⁻¹]\n    A --> D[C=N Stretch<br>1610 cm⁻¹]\n    A --> E[Aromatic C=C<br>1585 1495 cm⁻¹]\n    A --> F[C-O Stretch<br>1275 cm⁻¹]\n    A --> G[C-S Stretch<br>695 cm⁻¹]\n    style C fill:#ffcccc\n    style D fill:#ccffcc\n    style G fill:#ccccff' },

                        { id: 'sp13', type: 'divider', content: '' },

                        { id: 'sp14', type: 'header', level: 2, content: 'Quantum Chemical Calculations' },
                        { id: 'sp15', type: 'latex', content: '\\text{DFT Calculation Results (B3LYP/6-31G*):}\n\n\\text{Optimized Bond Lengths:}\n\nC-N_{quinoline} = 1.342 \\text{ Å} \\quad (\\text{literature: } 1.340 \\text{ Å})\n\nC-S_{thiophene} = 1.714 \\text{ Å} \\quad (\\text{literature: } 1.716 \\text{ Å})\n\n\\text{Calculated } ^1H \\text{ NMR shifts correlate with experimental data:}\n\n\\text{RMSD} = \\sqrt{\\frac{1}{n}\\sum_{i=1}^{n}(\\delta_{calc,i} - \\delta_{exp,i})^2} = 0.23 \\text{ ppm}' },

                        { id: 'sp16', type: 'header', level: 2, content: 'Conclusion' },
                        { id: 'sp17', type: 'markdown', content: '**Structural Confirmation:**\n\n✅ **Molecular Formula:** C₁₅H₁₁NO₃S confirmed by HRMS\n✅ **Functional Groups:** Quinoline, thiophene, ester functionalities identified\n✅ **Stereochemistry:** Single isomer confirmed by NMR\n✅ **Purity:** >95% by ¹H NMR integration\n\n**Key Findings:**\n\n- **Unique Chemical Shifts:** Quinoline H-2 (8.92 ppm) indicates electron-deficient system\n- **Coupling Patterns:** Complex aromatic region consistent with substitution pattern\n- **Conformational Analysis:** Restricted rotation observed between aromatic rings\n\n**Next Steps:**\n\n- [ ] Single crystal X-ray crystallography for absolute structure confirmation\n- [ ] Variable temperature NMR to study rotational dynamics\n- [ ] Biological activity screening against target enzyme panel' },

                        { id: 'sp18', type: 'text', content: 'All spectroscopic evidence supports the proposed structure of compound X47B. The synthesis pathway successfully produced the target heterocyclic system with excellent regioselectivity. Compound shows promising preliminary activity in initial screening assays.' }
                    ]
                }
            ];

            // NEW GRADUATE DOCUMENTS
            const newGraduateDocuments = [
                {
                    title: 'Job Application Tracker',
                    lastModified: new Date('2025-10-25').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['CV', 'MN'],
                    blocks: [
                        { id: 'j1', type: 'header', level: 1, content: 'Job Application Tracking - Fall 2025' },
                        { id: 'j2', type: 'text', content: 'Tracking all job applications submitted since graduation in May 2025. Target: 50 applications by end of November. Currently at 23 applications with 8 interviews scheduled. Focus areas: Software Engineering, Data Analysis, Product Management roles at tech companies.' },
                        { id: 'j3', type: 'header', level: 2, content: 'Application Status' },
                        { id: 'j4', type: 'table', content: 'Company,Position,Date Applied,Status,Next Step,Salary Range\nGoogle,Software Engineer,2025-09-15,Interview - Final,Onsite 10/28,$95K-$125K\nMicrosoft,PM Intern,2025-09-20,Rejected,N/A,$85K-$110K\nStartup Co,Full Stack Dev,2025-09-25,Phone Screen,Technical 10/30,$70K-$90K\nAmazon,Data Analyst,2025-10-01,Applied,Waiting,,$80K-$105K\nFacebook,Frontend Dev,2025-10-05,Phone Screen,Take-home,,$90K-$115K\nSpotify,Product Analyst,2025-10-10,Interview,Panel 11/01,$75K-$95K\nUber,Software Engineer,2025-10-12,Applied,Waiting,$85K-$115K\nAirbnb,Data Scientist,2025-10-15,Coding Test,Submit by 10/29,$90K-$120K' },
                        { id: 'j5', type: 'header', level: 2, content: 'Interview Preparation' },
                        { id: 'j6', type: 'markdown', content: '**Technical Skills to Review:**\n\n- [ ] Data structures and algorithms (LeetCode practice)\n- [ ] System design basics (distributed systems, caching)\n- [ ] SQL query optimization and database design\n- [ ] JavaScript/Python coding challenges\n- [ ] Behavioral interview questions (STAR method)\n\n**Companies with upcoming interviews:**\n- [ ] Google onsite (October 28) - Review distributed systems\n- [ ] Startup Co technical (October 30) - Full-stack project walkthrough\n- [ ] Spotify panel (November 1) - Product case study preparation' },
                        { id: 'j7', type: 'header', level: 2, content: 'Networking Contacts' },
                        { id: 'j8', type: 'table', content: 'Name,Company,Position,Connection,Last Contact\nSarah Kim,Google,Senior SWE,College alumna,10/20/25\nMike Chen,Microsoft,PM,LinkedIn,10/15/25\nAlex Rodriguez,Startup Co,CTO,Friend referral,10/22/25\nJenna Park,Amazon,Data Scientist,Career fair,10/18/25\nTom Wilson,Facebook,Engineering Manager,Professor introduction,10/25/25' }
                    ]
                },
                {
                    title: 'Career Development Plan - First Year',
                    lastModified: new Date('2025-10-28').toISOString(),
                    documentType: 'unstructured',
                    sharedWith: ['MN', 'CM'],
                    richTextContent: '<h1>Career Development Plan: First Year in Tech</h1><h2>Professional Goals</h2><p>As a recent computer science graduate entering the tech industry, my primary goal is to establish a strong foundation in software development while exploring different career paths. I aim to develop both technical expertise and professional skills that will position me for long-term success in technology roles.</p><h2>Short-term Objectives (0-6 months)</h2><p><strong>Technical Skills:</strong> Strengthen core programming abilities in Python and JavaScript, gain experience with modern frameworks (React, Node.js), and develop proficiency in cloud platforms (AWS or Azure). Complete at least 100 coding challenges and contribute to 2 open-source projects.</p><p><strong>Professional Development:</strong> Build effective communication skills through code reviews and technical presentations. Learn to work in agile development environments and understand CI/CD practices. Establish mentorship relationships with 2-3 senior engineers.</p><p><strong>Industry Knowledge:</strong> Stay current with technology trends through daily reading (Hacker News, tech blogs), attend local meetups and conferences, and build a professional network within the tech community.</p><h2>Medium-term Goals (6-12 months)</h2><p>Demonstrate impact through successful project deliveries and begin specializing in a particular domain (web development, data engineering, or mobile development). Seek increased responsibility such as leading small features or mentoring interns. Consider pursuing relevant certifications (AWS, Google Cloud) to validate cloud computing skills.</p><h2>Learning Plan</h2><p><strong>Technical Learning:</strong> Complete online courses in system design, database optimization, and software architecture patterns. Practice designing and implementing REST APIs, work with relational and NoSQL databases, and learn containerization with Docker.</p><p><strong>Soft Skills:</strong> Develop presentation abilities through internal tech talks, improve written communication through documentation and blog posts, and enhance collaboration skills through pair programming and code reviews.</p><h2>Success Metrics</h2><p>Track progress through quarterly performance reviews, peer feedback, and personal project portfolio growth. Measure technical advancement through successful completion of increasingly complex assignments and positive code review feedback. Monitor professional development through expanded network connections, speaking opportunities, and internal recognition.</p><p><strong>Year-end Target:</strong> Transition from junior to mid-level developer with specialized expertise, strong peer relationships, and clear direction for continued career growth in technology.</p>'
                },
                {
                    title: 'Technical Interview Preparation Guide',
                    lastModified: new Date('2025-11-03').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['MN', 'ST'],
                    blocks: [
                        { id: 'tp1', type: 'header', level: 1, content: 'Technical Interview Preparation Strategy' },
                        { id: 'tp2', type: 'text', content: 'Comprehensive preparation plan for technical interviews at top tech companies. Covers algorithms, system design, behavioral questions, and company-specific preparation. Target timeline: 8 weeks of intensive preparation before interview season.' },

                        { id: 'tp3', type: 'header', level: 2, content: 'Algorithm & Data Structure Roadmap' },
                        { id: 'tp4', type: 'table', content: 'Topic,Problems to Solve,Key Patterns,Time Allocation\nArrays & Strings,25 problems,Two pointers sliding window,Week 1\nLinked Lists,15 problems,Fast/slow pointers dummy nodes,Week 1\nTrees & Graphs,30 problems,DFS/BFS traversals,Week 2-3\nDynamic Programming,20 problems,Memoization bottom-up,Week 4\nHeaps & Priority Queues,15 problems,Top-K problems scheduling,Week 5\nBacktracking,12 problems,Permutations combinations,Week 5\nSystem Design,8 case studies,Scalability patterns,Week 6-7\nBehavioral Questions,15 scenarios,STAR method,Week 8' },

                        { id: 'tp5', type: 'header', level: 2, content: 'Coding Practice Schedule' },
                        { id: 'tp6', type: 'mermaid', content: 'gantt\n    title 8-Week Interview Prep Timeline\n    dateFormat  YYYY-MM-DD\n    section Fundamentals\n    Arrays & Linked Lists    :a1, 2025-11-04, 7d\n    Trees & Graph Basics     :a2, after a1, 7d\n    section Advanced Topics\n    Graph Algorithms         :b1, after a2, 7d\n    Dynamic Programming      :b2, after b1, 7d\n    section Specialized\n    Heaps & Backtracking     :c1, after b2, 7d\n    System Design Basics     :c2, after c1, 7d\n    section Integration\n    Mock Interviews          :d1, after c2, 14d' },

                        { id: 'tp7', type: 'header', level: 2, content: 'Sample Algorithm Implementation' },
                        { id: 'tp8', type: 'text', content: 'Here is a well-commented solution to a common interview problem that demonstrates clean coding practices and optimal time complexity:' },

                        { id: 'tp9', type: 'code', language: 'python', content: 'def longest_substring_without_repeating(s):\n    """\n    Find length of longest substring without repeating characters\n    Time: O(n), Space: O(min(m,n)) where m is charset size\n    \n    Algorithm: Sliding Window with HashMap\n    - Use two pointers (left, right) to maintain window\n    - Track character positions in HashMap\n    - Shrink window when duplicate found\n    """\n    if not s:\n        return 0\n    \n    char_map = {}  # character -> last seen index\n    max_length = 0\n    left = 0\n    \n    for right in range(len(s)):\n        current_char = s[right]\n        \n        # If character seen before and within current window\n        if current_char in char_map and char_map[current_char] >= left:\n            # Move left pointer past duplicate\n            left = char_map[current_char] + 1\n        \n        # Update character position\n        char_map[current_char] = right\n        \n        # Update max length if current window is larger\n        current_length = right - left + 1\n        max_length = max(max_length, current_length)\n    \n    return max_length\n\n# Test cases with expected outputs\ntest_cases = [\n    ("abcabcbb", 3),  # "abc"\n    ("bbbbb", 1),     # "b"\n    ("pwwkew", 3),    # "wke"\n    ("", 0),          # empty string\n    ("dvdf", 3)       # "vdf"\n]\n\nfor input_str, expected in test_cases:\n    result = longest_substring_without_repeating(input_str)\n    print(f"Input: \\"{input_str}\\" -> Output: {result} (Expected: {expected})"' },

                        { id: 'tp10', type: 'header', level: 2, content: 'System Design Study Plan' },
                        { id: 'tp11', type: 'markdown', content: '**Core Concepts to Master:**\n\n**Scalability Fundamentals:**\n- [ ] Horizontal vs Vertical Scaling\n- [ ] Load Balancers (Layer 4 vs Layer 7)\n- [ ] Database Partitioning & Sharding\n- [ ] Caching Strategies (Redis, Memcached)\n- [ ] Message Queues (Kafka, RabbitMQ)\n\n**Storage & Databases:**\n- [ ] SQL vs NoSQL trade-offs\n- [ ] CAP Theorem implications\n- [ ] Consistency patterns (Eventual, Strong)\n- [ ] Replication strategies (Master-Slave, Master-Master)\n\n**Practice Problems:**\n- [ ] Design URL Shortener (like bit.ly)\n- [ ] Design Chat System (like WhatsApp)\n- [ ] Design Social Media Feed (like Twitter)\n- [ ] Design Video Streaming (like YouTube)\n- [ ] Design Search Engine (like Google)\n- [ ] Design Ride Sharing (like Uber)\n- [ ] Design Key-Value Store (like DynamoDB)\n- [ ] Design Notification System' },

                        { id: 'tp12', type: 'divider', content: '' },

                        { id: 'tp13', type: 'header', level: 2, content: 'Company-Specific Preparation' },
                        { id: 'tp14', type: 'table', content: 'Company,Interview Focus,Preparation Strategy,Resources\nGoogle,Algorithm depth & optimization,LeetCode Hard problems,Google interview guide\nMeta,System design & architecture,Practice designing social features,Meta engineering blog\nAmazon,Leadership principles & coding,Behavioral examples + algorithms,Amazon LP guide\nMicrosoft,Problem-solving approach,Explain thought process clearly,Microsoft careers site\nApple,Attention to detail & quality,Clean well-tested code,Apple developer resources\nNetflix,Cultural fit & scaling,High-performance systems design,Netflix tech blog\nUber,Real-world problem solving,Location-based system design,Uber engineering blog\nAirbnb,Product thinking & engineering,User-focused system design,Airbnb engineering blog' },

                        { id: 'tp15', type: 'header', level: 2, content: 'Performance Tracking' },
                        { id: 'tp16', type: 'latex', content: '\\text{Weekly Progress Metrics:}\n\n\\text{Problem Solving Rate} = \\frac{\\text{Problems Solved Correctly}}{\\text{Total Problems Attempted}} \\times 100\\%\n\n\\text{Target: } \\geq 75\\% \\text{ by Week 4, } \\geq 85\\% \\text{ by Week 8}\n\n\\text{Time Efficiency} = \\frac{\\text{Optimal Solution Time}}{\\text{Actual Solution Time}}\n\n\\text{Target: } \\geq 0.8 \\text{ for Medium problems, } \\geq 0.6 \\text{ for Hard problems}' },

                        { id: 'tp17', type: 'header', level: 2, content: 'Mock Interview Schedule' },
                        { id: 'tp18', type: 'text', content: 'Final two weeks focus on realistic interview simulation with peers and mentors. Schedule 2-3 mock interviews per week covering different formats: phone screens, technical deep-dives, system design discussions, and behavioral interviews. Record sessions for review and improvement.' }
                    ]
                }
            ];

            // DATA ANALYST DOCUMENTS
            const dataAnalystDocuments = [
                {
                    title: 'Customer Churn Analysis - September 2025',
                    lastModified: new Date('2025-10-30').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['DS', 'PM', 'CS'],
                    blocks: [
                        { id: 'd1', type: 'header', level: 1, content: 'Customer Churn Analysis Report' },
                        { id: 'd2', type: 'text', content: 'Analysis of customer churn patterns for September 2025. Churn rate increased to 5.8% (vs 4.2% target), affecting 142 customers and $23,400 in monthly recurring revenue. Key findings: churn peaks in accounts 90+ days past renewal, correlates with reduced product usage, and concentrates in SMB segment.' },
                        { id: 'd3', type: 'header', level: 2, content: 'Data Query' },
                        { id: 'd4', type: 'code', language: 'sql', content: 'SELECT \n  DATE_TRUNC(\'month\', churn_date) as month,\n  COUNT(*) as churned_customers,\n  SUM(mrr) as lost_revenue,\n  AVG(days_since_last_login) as avg_days_inactive,\n  AVG(account_age_days) as avg_account_age\nFROM customer_churn \nWHERE churn_date >= \'2025-09-01\'\n  AND churn_date < \'2025-10-01\'\nGROUP BY DATE_TRUNC(\'month\', churn_date)\nORDER BY month;' },
                        { id: 'd5', type: 'header', level: 2, content: 'Churn Factors Analysis' },
                        { id: 'd6', type: 'table', content: 'Factor,Churned Group,Retained Group,Risk Ratio\nDays since last login,>45 days,<15 days,3.2x\nMonthly logins,<8 times,>25 times,2.8x\nSupport tickets,>5 per month,<2 per month,2.1x\nFeature adoption,<3 features,>7 features,2.4x\nAccount age,<6 months,>12 months,1.9x' },
                        { id: 'd7', type: 'header', level: 2, content: 'Predictive Model Results' },
                        { id: 'd8', type: 'code', language: 'python', content: 'import pandas as pd\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.metrics import classification_report\n\n# Model performance on test set\nrf_model = RandomForestClassifier(n_estimators=100, random_state=42)\nrf_model.fit(X_train, y_train)\n\ny_pred = rf_model.predict(X_test)\naccuracy = rf_model.score(X_test, y_test)\nprint(f"Model Accuracy: {accuracy:.3f}")\n\n# Feature importance\nfeature_importance = pd.DataFrame({\n    \'feature\': X_train.columns,\n    \'importance\': rf_model.feature_importances_\n}).sort_values(\'importance\', ascending=False)\n\nprint("\\nTop 5 Features:")\nprint(feature_importance.head())' },
                        { id: 'd9', type: 'header', level: 2, content: 'Recommendations' },
                        { id: 'd10', type: 'text', content: 'Implement proactive outreach for accounts with >30 days inactivity. Launch re-engagement email campaign targeting customers with declining usage. Develop onboarding improvements to increase feature adoption in first 60 days. Consider offering retention incentives to high-risk SMB accounts identified by the model.' }
                    ]
                },
                {
                    title: 'Executive Dashboard Requirements - KPI Metrics',
                    lastModified: new Date('2025-10-26').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['EX', 'PM', 'DE'],
                    blocks: [
                        { id: 'k1', type: 'header', level: 1, content: 'Executive Dashboard Requirements Document' },
                        { id: 'k2', type: 'text', content: 'Requirements for new executive dashboard providing real-time visibility into key business metrics. Dashboard will refresh every 15 minutes during business hours and display 12 core KPIs across 4 categories: Revenue, Customer, Product, and Operations. Target users: C-suite, VPs, Directors.' },
                        { id: 'k3', type: 'header', level: 2, content: 'Dashboard Mockup' },
                        { id: 'k4', type: 'image', content: 'https://via.placeholder.com/800x450/0066CC/FFFFFF?text=Executive+Dashboard+Wireframe' },
                        { id: 'k5', type: 'header', level: 2, content: 'KPI Definitions' },
                        { id: 'k6', type: 'table', content: 'KPI,Definition,Data Source,Update Frequency\nMonthly Recurring Revenue,Sum of all active subscriptions,Billing DB,Daily at 6 AM\nCustomer Acquisition Cost,Marketing spend / new customers,CRM + Finance,Weekly\nNet Promoter Score,Customer satisfaction survey average,Survey platform,Weekly\nDaily Active Users,Unique users with >1 action,Analytics DB,Hourly\nGross Revenue Retention,Revenue retained from existing customers,Billing DB,Monthly\nProduct Usage Rate,% of features used by active customers,Analytics DB,Daily\nSupport Ticket Volume,Number of open tickets,Support system,Real-time\nServer Uptime,% availability of core services,Monitoring tools,Real-time' },
                        { id: 'k7', type: 'header', level: 2, content: 'Technical Specifications' },
                        { id: 'k8', type: 'text', content: 'Dashboard built using Tableau connected to data warehouse via API. All metrics include month-over-month and year-over-year comparisons with color-coded trend indicators (green: positive, red: negative, yellow: neutral). Mobile-responsive design required for tablet viewing. Export functionality for PDF reports.' },
                        { id: 'k9', type: 'header', level: 2, content: 'Data Pipeline Architecture' },
                        { id: 'k10', type: 'mermaid', content: 'graph LR\n    A[CRM Database] --> D[Data Warehouse]\n    B[Analytics Database] --> D\n    C[Billing System] --> D\n    D --> E[ETL Process]\n    E --> F[Dashboard API]\n    F --> G[Tableau Dashboard]\n    G --> H[Executive Users]' }
                    ]
                },
                {
                    title: 'A/B Test Results - Checkout Flow Optimization',
                    lastModified: new Date('2025-10-29').toISOString(),
                    documentType: 'unstructured',
                    sharedWith: ['PM', 'UX', 'EN'],
                    richTextContent: '<h1>A/B Test Results: Checkout Flow Optimization</h1><h2>Executive Summary</h2><p>Our 4-week A/B test comparing the simplified checkout flow (Variant B) against the current 3-step process (Control A) shows significant improvements in conversion rates and user experience metrics. Variant B achieved an 18% increase in checkout completion rate and 12% increase in overall revenue per visitor.</p><h2>Test Design</h2><p><strong>Hypothesis:</strong> Reducing checkout steps from 3 to 2 will increase conversion by minimizing abandonment opportunities.</p><p><strong>Traffic Allocation:</strong> 50% Control A (3-step), 50% Variant B (2-step)<br><strong>Sample Size:</strong> 24,847 users (12,394 Control, 12,453 Variant)<br><strong>Test Duration:</strong> October 1-28, 2025<br><strong>Primary Metric:</strong> Checkout completion rate<br><strong>Secondary Metrics:</strong> Revenue per visitor, time to complete checkout, user satisfaction score</p><h2>Results Analysis</h2><p><strong>Statistical Significance:</strong> All primary and secondary metrics achieved 95% confidence intervals with p-values < 0.05, indicating statistically significant results.</p><h3>Key Metrics Performance</h3><ul><li><strong>Checkout Completion Rate:</strong> Control 64.2% vs Variant 75.8% (+18.1% relative lift)</li><li><strong>Revenue per Visitor:</strong> Control $18.42 vs Variant $20.63 (+12.0% relative lift)</li><li><strong>Average Time to Complete:</strong> Control 4:23 vs Variant 2:47 (-36.8% reduction)</li><li><strong>User Satisfaction Score:</strong> Control 3.4/5 vs Variant 4.1/5 (+20.6% improvement)</li></ul><h2>Segment Analysis</h2><p>Improvement was consistent across user segments, with particularly strong performance in mobile users (+24% completion rate lift) and new customers (+21% lift). Returning customers showed smaller but still significant improvement (+14% lift).</p><p>Geographic analysis revealed stronger lift in international markets (avg +22%) compared to domestic (+16%), likely due to reduced form complexity benefiting non-native English speakers.</p><h2>Implementation Recommendation</h2><p><strong>Recommendation:</strong> Implement Variant B (2-step checkout) for 100% of traffic based on strong statistical evidence and positive user feedback.</p><p><strong>Expected Annual Impact:</strong> $2.1M additional revenue based on current traffic projections, with improved customer satisfaction leading to higher retention rates.</p><p><strong>Implementation Timeline:</strong> 2 weeks for full rollout, including monitoring dashboards and rollback capability. Monitor closely for first 30 days post-launch to ensure sustained performance gains.</p>'
                },
                {
                    title: 'Sales Forecasting Model - Q1 2026 Predictions',
                    lastModified: new Date('2025-11-04').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['FP', 'VP', 'DS'],
                    blocks: [
                        { id: 'sf1', type: 'header', level: 1, content: 'Q1 2026 Sales Forecasting Model' },
                        { id: 'sf2', type: 'text', content: 'Advanced time series forecasting model combining ARIMA, Prophet, and ensemble methods to predict Q1 2026 sales performance. Model incorporates seasonal patterns, external economic indicators, and promotional calendar effects. Forecast confidence intervals: 80% and 95%.' },

                        { id: 'sf3', type: 'header', level: 2, content: 'Model Architecture & Data Sources' },
                        { id: 'sf4', type: 'mermaid', content: 'graph TB\n    A[Historical Sales Data<br>36 months] --> D[Feature Engineering]\n    B[Economic Indicators<br>GDP, CPI, Unemployment] --> D\n    C[Marketing Calendar<br>Campaigns, Promotions] --> D\n    D --> E[ARIMA Model<br>Trend + Seasonality]\n    D --> F[Prophet Model<br>Holiday Effects]\n    D --> G[Random Forest<br>External Factors]\n    E --> H[Ensemble Combining<br>Weighted Average]\n    F --> H\n    G --> H\n    H --> I[Final Predictions<br>with Confidence Intervals]\n    style H fill:#e3f2fd\n    style I fill:#e8f5e8' },

                        { id: 'sf5', type: 'header', level: 2, content: 'Feature Engineering Pipeline' },
                        { id: 'sf6', type: 'code', language: 'python', content: 'import pandas as pd\nimport numpy as np\nfrom sklearn.ensemble import RandomForestRegressor\nfrom statsmodels.tsa.arima.model import ARIMA\nfrom prophet import Prophet\nfrom sklearn.metrics import mean_absolute_percentage_error\n\n# Feature engineering pipeline\ndef create_features(df):\n    """\n    Generate time series features for sales forecasting\n    """\n    df = df.copy()\n    \n    # Temporal features\n    df[\'month\'] = df[\'date\'].dt.month\n    df[\'quarter\'] = df[\'date\'].dt.quarter\n    df[\'day_of_year\'] = df[\'date\'].dt.dayofyear\n    df[\'week_of_year\'] = df[\'date\'].dt.isocalendar().week\n    \n    # Lag features (previous periods)\n    for lag in [1, 3, 6, 12]:  # 1, 3, 6, 12 months ago\n        df[f\'sales_lag_{lag}\'] = df[\'sales\'].shift(lag)\n    \n    # Rolling statistics\n    for window in [3, 6, 12]:\n        df[f\'sales_rolling_mean_{window}\'] = df[\'sales\'].rolling(window).mean()\n        df[f\'sales_rolling_std_{window}\'] = df[\'sales\'].rolling(window).std()\n    \n    # Economic indicators (external data)\n    df[\'gdp_growth_rate\'] = df[\'gdp\'].pct_change(periods=12) * 100\n    df[\'unemployment_change\'] = df[\'unemployment\'].diff()\n    df[\'consumer_confidence_ma\'] = df[\'consumer_confidence\'].rolling(3).mean()\n    \n    # Promotional effects\n    df[\'promo_intensity\'] = df[\'promo_spend\'] / df[\'promo_spend\'].rolling(12).mean()\n    df[\'days_since_last_promo\'] = (df[\'date\'] - df[\'last_promo_date\']).dt.days\n    \n    return df\n\n# Model ensemble weights (optimized via cross-validation)\nmodel_weights = {\n    \'arima\': 0.35,      # Strong for trend/seasonality\n    \'prophet\': 0.40,    # Excellent for holidays/events  \n    \'rf\': 0.25         # Good for external factors\n}\n\nprint("Feature engineering pipeline ready for Q1 2026 forecast generation")' },

                        { id: 'sf7', type: 'header', level: 2, content: 'Historical Model Performance' },
                        { id: 'sf8', type: 'table', content: 'Model,MAPE (%),RMSE ($K),MAE ($K),Training Period\nARIMA(2,1,1),8.4%,245K,185K,2022-2024\nProphet with holidays,7.2%,218K,162K,2022-2024\nRandom Forest,9.1%,267K,201K,2022-2024\nEnsemble Model,6.8%,198K,148K,2022-2024\nNaive (last year),15.3%,425K,342K,Baseline comparison\nLinear Trend,12.1%,356K,278K,Simple baseline' },

                        { id: 'sf9', type: 'header', level: 2, content: 'Q1 2026 Forecast Results' },
                        { id: 'sf10', type: 'table', content: 'Month,Point Forecast ($K),80% CI Lower ($K),80% CI Upper ($K),95% CI Lower ($K),95% CI Upper ($K),Key Drivers\nJan 2026,2847,2654,3040,2543,3151,New Year promotions post-holiday recovery\nFeb 2026,2653,2471,2835,2368,2938,Valentine\'s Day campaigns seasonal dip\nMar 2026,2912,2714,3110,2605,3219,Spring launch strong economic indicators\nQ1 Total,8412,7839,8985,7716,9308,Ensemble prediction with confidence bands' },

                        { id: 'sf11', type: 'header', level: 2, content: 'Statistical Analysis' },
                        { id: 'sf12', type: 'latex', content: '\\text{Forecast Accuracy Metrics:}\n\n\\text{MAPE} = \\frac{1}{n} \\sum_{t=1}^{n} \\left| \\frac{A_t - F_t}{A_t} \\right| \\times 100\\% = 6.8\\%\n\n\\text{Prediction Intervals:}\n\n80\\% \\text{ CI: } \\hat{y} \\pm 1.28 \\times \\sigma_{forecast}\n\n95\\% \\text{ CI: } \\hat{y} \\pm 1.96 \\times \\sigma_{forecast}\n\n\\text{Where } \\sigma_{forecast} = \\sqrt{\\sigma_{model}^2 + \\sigma_{residual}^2}\n\n\\text{Ensemble Variance:}\n\n\\text{Var}(\\hat{y}_{ensemble}) = \\sum_{i=1}^{3} w_i^2 \\text{Var}(\\hat{y}_i) + 2\\sum_{i<j} w_i w_j \\text{Cov}(\\hat{y}_i, \\hat{y}_j)' },

                        { id: 'sf13', type: 'divider', content: '', dividerType: 'page' },

                        { id: 'sf14', type: 'header', level: 2, content: 'Risk Factors & Scenario Analysis' },
                        { id: 'sf15', type: 'markdown', content: '**Economic Risk Factors:**\n\n🔴 **High Risk:**\n- [ ] Recession indicators (yield curve inversion)\n- [ ] Inflation above 4% (current: 3.2%)\n- [ ] Consumer confidence below 90 (current: 98.4)\n\n🟡 **Medium Risk:**\n- [ ] Supply chain disruptions (geopolitical)\n- [ ] Competitive product launches\n- [ ] Seasonal demand shifts due to weather\n\n🟢 **Low Risk:**\n- [ ] Interest rate changes (gradual adjustments expected)\n- [ ] Currency fluctuations (hedging in place)\n- [ ] Technology platform issues (robust infrastructure)\n\n**Scenario Planning:**\n\n- **Bull Case (+15%):** Strong consumer spending, successful product launches\n- **Base Case (0%):** Current economic trajectory continues\n- **Bear Case (-12%):** Economic slowdown, reduced consumer spending' },

                        { id: 'sf16', type: 'header', level: 2, content: 'Model Monitoring & Updates' },
                        { id: 'sf17', type: 'table', content: 'Monitoring Metric,Current Value,Alert Threshold,Action Required\nWeekly MAPE,7.2%,>10%,Retrain ensemble weights\nResidual Autocorrelation,0.08,>0.20,Add lag features or seasonal terms\nFeature Importance Drift,3.4%,>15%,Update feature engineering pipeline\nPrediction Bias,-1.8%,±5%,Adjust model calibration\nData Quality Score,94.2%,<90%,Investigate data pipeline issues\nModel Staleness,12 days,>30 days,Schedule model refresh' },

                        { id: 'sf18', type: 'header', level: 2, content: 'Business Recommendations' },
                        { id: 'sf19', type: 'text', content: 'Q1 2026 forecast of $8.41M represents 7.3% YoY growth, slightly below company target of 10%. Recommend increasing marketing spend in March (+$150K) to capitalize on spring demand surge. Monitor January performance closely as economic headwinds may impact consumer discretionary spending. Model suggests 73% probability of meeting quarterly revenue target of $8.2M.' }
                    ]
                }
            ];

            // Save persona-specific documents to localStorage
            localStorage.setItem('retailManagerDocuments', JSON.stringify(retailManagerDocuments));
            localStorage.setItem('researchChemistDocuments', JSON.stringify(researchChemistDocuments));
            localStorage.setItem('newGraduateDocuments', JSON.stringify(newGraduateDocuments));
            localStorage.setItem('dataAnalystDocuments', JSON.stringify(dataAnalystDocuments));
        }

        // Documents Slideout Functions
        function openDocumentsSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Documents';

            // Hide all content sections
            hideAllContentSections();

            // Show documents content
            document.getElementById('documentsContent').style.display = 'block';
            loadDocuments();

            slideout.classList.add('active');
        }

        function loadDocuments() {
            const container = document.getElementById('documentsContainer');
            container.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 16px;';

            // Get persona-specific documents
            const personaStorageKeys = {
                'retail-manager': 'retailManagerDocuments',
                'chemist': 'researchChemistDocuments',
                'new-graduate': 'newGraduateDocuments',
                'data-analyst': 'dataAnalystDocuments'
            };

            const storageKey = personaStorageKeys[currentPersona] || 'retailManagerDocuments';
            const documents = JSON.parse(localStorage.getItem(storageKey) || '[]');

            if (documents.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: var(--color-neutral-text);"><i class="ph ph-file-text" style="font-size: 48px; color: var(--color-neutral-border); display: block; margin-bottom: 12px;"></i>No documents yet. Click "+ New Document" to create one.</div>';
                return;
            }

            container.innerHTML = '';
            documents.forEach((doc, index) => {
                const card = createDocumentCard(doc, index);
                container.appendChild(card);
            });
        }

        function createDocumentCard(doc, index) {
            const card = document.createElement('div');
            card.style.cssText = 'padding: 20px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px;';

            const lastModified = new Date(doc.lastModified).toLocaleDateString();
            const isStructured = doc.documentType === 'structured' || doc.blocks;
            const isUnstructured = doc.documentType === 'unstructured' || doc.richTextContent;

            let wordCount = 0;
            let charCount = 0;
            let blockCount = 0;
            const blockTypes = {};

            if (isUnstructured) {
                // Calculate word and character counts from rich text
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = doc.richTextContent || '';
                const text = tempDiv.textContent || '';
                wordCount = text.trim().split(/\s+/).filter(w => w.length > 0).length;
                charCount = text.length;
            } else {
                // Count blocks for structured documents
                blockCount = doc.blocks ? doc.blocks.length : 0;
                if (doc.blocks) {
                    doc.blocks.forEach(block => {
                        blockTypes[block.type] = (blockTypes[block.type] || 0) + 1;
                        // Also count words from text blocks
                        if (block.type === 'text' || block.type === 'header') {
                            const text = block.content || '';
                            wordCount += text.trim().split(/\s+/).filter(w => w.length > 0).length;
                        }
                    });
                }
            }

            // Calculate reading time (200 words per minute)
            const readingTime = Math.max(1, Math.ceil(wordCount / 200));

            // Determine icon based on content type
            let icon = 'ph-file-text';
            if (isUnstructured) {
                icon = 'ph-article';
            } else if (blockTypes.code || blockTypes.markdown) {
                icon = 'ph-code';
            } else if (blockTypes.image) {
                icon = 'ph-file-image';
            } else if (blockTypes.table) {
                icon = 'ph-table';
            }

            card.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="ph ${icon}" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${escapeHtml(doc.title || 'Untitled Document')}</div>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button onclick="event.stopPropagation(); openDocumentEditor(${index})" title="Edit" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-pencil-simple" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteDocument(${index})" title="Delete" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                        </button>
                        <button onclick="event.stopPropagation(); shareDocument(${index})" title="Share" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                        </button>
                    </div>
                </div>
                <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">
                    ${getDocumentPreview(doc)}
                </div>
                <div style="margin-top: 4px;">
                    <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin-bottom: 8px;">
                        ${isUnstructured ? 'Statistics' : 'Content'}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${isUnstructured ? `
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${wordCount.toLocaleString()} Words</span>
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${charCount.toLocaleString()} Characters</span>
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);"><i class="ph ph-clock" style="margin-right: 2px;"></i>${readingTime} min read</span>
                        ` : `
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockCount} Block${blockCount !== 1 ? 's' : ''}</span>
                            ${blockTypes.header ? `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockTypes.header} Section${blockTypes.header !== 1 ? 's' : ''}</span>` : ''}
                            ${blockTypes.image ? `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockTypes.image} Image${blockTypes.image !== 1 ? 's' : ''}</span>` : ''}
                            ${blockTypes.code ? `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockTypes.code} Code</span>` : ''}
                            ${blockTypes.table ? `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockTypes.table} Table${blockTypes.table !== 1 ? 's' : ''}</span>` : ''}
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);"><i class="ph ph-clock" style="margin-right: 2px;"></i>${readingTime} min read</span>
                        `}
                    </div>
                </div>
                ${doc.sharedWith && doc.sharedWith.length > 0 ? `
                    <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">SHARED WITH</div>
                        <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                            ${doc.sharedWith.map(initials => `
                                <div style="width: 28px; height: 28px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: var(--color-primary-blue); font-family: var(--font-family-ui);">${initials}</div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                    <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">LAST MODIFIED</div>
                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">
                        <i class="ph ph-calendar-blank" style="margin-right: 4px;"></i>
                        ${lastModified}
                    </div>
                </div>
            `;

            card.addEventListener('mouseenter', () => {
                card.style.borderColor = 'var(--color-primary-blue)';
                card.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.15)';
            });

            card.addEventListener('mouseleave', () => {
                card.style.borderColor = 'var(--color-neutral-border)';
                card.style.boxShadow = 'none';
            });

            card.addEventListener('click', () => {
                openDocumentEditor(index);
            });

            return card;
        }

        function getDocumentPreview(doc) {
            // Handle unstructured documents
            if (doc.documentType === 'unstructured' || doc.richTextContent) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = doc.richTextContent || '';
                const text = tempDiv.textContent || '';
                const preview = text.trim().substring(0, 150);
                return escapeHtml(preview) + (text.length > 150 ? '...' : '');
            }

            // Handle structured documents
            if (!doc.blocks || doc.blocks.length === 0) return 'Empty document';

            // Find first text or header block for preview
            const previewBlock = doc.blocks.find(b => b.type === 'text' || b.type === 'header');
            if (previewBlock && previewBlock.content) {
                const preview = previewBlock.content.substring(0, 150);
                return escapeHtml(preview) + (previewBlock.content.length > 150 ? '...' : '');
            }

            return `Document contains ${doc.blocks.length} block${doc.blocks.length !== 1 ? 's' : ''}`;
        }

        function shareDocument(index) {
            alert('Share functionality coming soon!\n\nYou will be able to:\n• Export as PDF\n• Share via email\n• Generate shareable link');
        }

        // Document Editor Functions
        let currentDocumentIndex = null;
        let currentDocumentBlocks = [];
        let currentBlockId = 0;

        let quillEditor = null;
        let currentDocumentView = 'structured'; // 'structured' or 'unstructured'

        function openDocumentEditor(documentIndex = null) {
            currentDocumentIndex = documentIndex;
            openModal('documentEditorModal');
        }

        function initializeQuillEditor() {
            if (quillEditor) {
                quillEditor = null;
            }

            const editorContainer = document.getElementById('quillEditor');
            editorContainer.innerHTML = ''; // Clear previous instance

            quillEditor = new Quill('#quillEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, 4, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'align': [] }],
                        ['link', 'image', 'code-block'],
                        ['clean']
                    ]
                },
                placeholder: 'Start writing your document...'
            });
        }

        function toggleDocumentView(view) {
            currentDocumentView = view;

            const structuredView = document.getElementById('structuredView');
            const unstructuredView = document.getElementById('unstructuredView');
            const structuredBtn = document.getElementById('structuredViewBtn');
            const unstructuredBtn = document.getElementById('unstructuredViewBtn');

            if (view === 'structured') {
                // Show structured view
                structuredView.style.display = 'flex';
                unstructuredView.style.display = 'none';

                // Update button styles
                structuredBtn.style.background = 'var(--color-primary-blue)';
                structuredBtn.style.color = 'white';
                unstructuredBtn.style.background = 'transparent';
                unstructuredBtn.style.color = 'var(--color-dark)';

                // Sync from Quill to blocks if switching from unstructured
                if (quillEditor) {
                    syncQuillToBlocks();
                }
            } else {
                // Show unstructured view
                structuredView.style.display = 'none';
                unstructuredView.style.display = 'flex';

                // Update button styles
                structuredBtn.style.background = 'transparent';
                structuredBtn.style.color = 'var(--color-dark)';
                unstructuredBtn.style.background = 'var(--color-primary-blue)';
                unstructuredBtn.style.color = 'white';

                // Sync from blocks to Quill if switching from structured
                syncBlocksToQuill();
            }
        }

        function syncBlocksToQuill() {
            if (!quillEditor) return;

            let html = '';

            // Process blocks in hierarchical order
            currentDocumentBlocks.forEach((block, index) => {
                switch (block.type) {
                    case 'header':
                        // Add spacing before headers (except first element)
                        if (index > 0) {
                            html += '<br>';
                        }
                        html += `<h${block.level}>${escapeHtml(block.content || '')}</h${block.level}>`;
                        break;

                    case 'text':
                        // Split text into paragraphs and clean up
                        const paragraphs = (block.content || '').split('\n').filter(p => p.trim());
                        paragraphs.forEach(para => {
                            // Check if it's a bullet point
                            if (para.trim().startsWith('•') || para.trim().startsWith('*')) {
                                html += `<li>${escapeHtml(para.replace(/^[•*]\s*/, ''))}</li>`;
                            } else {
                                html += `<p>${escapeHtml(para)}</p>`;
                            }
                        });
                        break;

                    case 'image':
                        if (block.content) {
                            html += `<p><img src="${block.content}" style="max-width: 100%; height: auto; display: block; margin: 12px 0;"></p>`;
                        }
                        break;

                    case 'code':
                        html += `<pre>${escapeHtml(block.content || '')}</pre>`;
                        break;

                    case 'table':
                        // Convert CSV-like table data to actual table
                        const tableContent = block.content || '';
                        if (tableContent.trim()) {
                            const rows = tableContent.split('\n').filter(r => r.trim());
                            if (rows.length > 0) {
                                html += '<table style="border-collapse: collapse; width: 100%; margin: 12px 0;">';
                                rows.forEach((row, rowIndex) => {
                                    const cells = row.split(',');
                                    html += '<tr>';
                                    cells.forEach(cell => {
                                        const tag = rowIndex === 0 ? 'th' : 'td';
                                        html += `<${tag} style="border: 1px solid #ddd; padding: 8px;">${escapeHtml(cell.trim())}</${tag}>`;
                                    });
                                    html += '</tr>';
                                });
                                html += '</table>';
                            }
                        }
                        break;

                    case 'markdown':
                    case 'latex':
                    case 'mermaid':
                        // Show these as formatted pre blocks with labels
                        const typeLabels = {
                            'markdown': 'Markdown Content',
                            'latex': 'KaTeX Math',
                            'mermaid': 'Mermaid Diagram'
                        };
                        html += `<p><em>${typeLabels[block.type]}:</em></p>`;
                        html += `<pre>${escapeHtml(block.content || '')}</pre>`;
                        break;
                }
            });

            const delta = quillEditor.clipboard.convert(html);
            quillEditor.setContents(delta);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function syncQuillToBlocks() {
            if (!quillEditor) return;

            // Convert Quill content to blocks
            const delta = quillEditor.getContents();
            const newBlocks = [];
            let currentTextBlock = null;

            delta.ops.forEach(op => {
                if (op.insert) {
                    if (typeof op.insert === 'string') {
                        const text = op.insert;

                        if (op.attributes && op.attributes.header) {
                            // Header block
                            const level = op.attributes.header;
                            newBlocks.push({
                                id: `block-${Date.now()}-${Math.random()}`,
                                type: 'header',
                                level: level,
                                content: text.trim()
                            });
                            currentTextBlock = null;
                        } else if (op.attributes && op.attributes['code-block']) {
                            // Code block
                            newBlocks.push({
                                id: `block-${Date.now()}-${Math.random()}`,
                                type: 'code',
                                language: 'javascript',
                                content: text
                            });
                            currentTextBlock = null;
                        } else {
                            // Regular text
                            if (!currentTextBlock) {
                                currentTextBlock = {
                                    id: `block-${Date.now()}-${Math.random()}`,
                                    type: 'text',
                                    content: ''
                                };
                                newBlocks.push(currentTextBlock);
                            }
                            currentTextBlock.content += text;
                        }
                    } else if (op.insert.image) {
                        // Image block
                        newBlocks.push({
                            id: `block-${Date.now()}-${Math.random()}`,
                            type: 'image',
                            content: op.insert.image
                        });
                        currentTextBlock = null;
                    }
                }
            });

            currentDocumentBlocks = newBlocks;
            renderDocumentBlocks();
        }

        function closeDocumentEditor() {
            closeModal('documentEditorModal');
            currentDocumentIndex = null;
            currentDocumentBlocks = [];
        }

        function addBlock(type) {
            const blockId = `block-${Date.now()}-${currentBlockId++}`;
            const block = {
                id: blockId,
                type: type,
                content: '',
                level: type === 'header' ? 1 : null,
                language: type === 'code' ? 'javascript' : null
            };

            currentDocumentBlocks.push(block);
            renderDocumentBlocks();
        }

        function renderDocumentBlocks() {
            const container = document.getElementById('documentBlocks');
            container.innerHTML = '';

            if (currentDocumentBlocks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--color-neutral-text); padding: 60px 20px;"><i class="ph ph-cursor-text" style="font-size: 48px; color: var(--color-neutral-border); margin-bottom: 16px;"></i><p style="font-family: var(--font-family-body); font-size: 14px;">Click a block type to start building your document</p></div>';
                return;
            }

            // Build hierarchical structure
            let i = 0;
            while (i < currentDocumentBlocks.length) {
                const block = currentDocumentBlocks[i];
                if (block.type === 'header') {
                    // Find all children (blocks until next header of same or higher level)
                    const children = [];
                    let j = i + 1;
                    while (j < currentDocumentBlocks.length) {
                        const nextBlock = currentDocumentBlocks[j];
                        if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                            break; // Found a header at same or higher level
                        }
                        children.push({ block: nextBlock, index: j });
                        j++;
                    }

                    // Create header container with children
                    const headerContainer = createHeaderContainer(block, i, children);
                    container.appendChild(headerContainer);
                    i = j; // Skip to next section
                } else {
                    // Orphan block (not under a header)
                    const blockEl = createBlockElement(block, i);
                    container.appendChild(blockEl);
                    i++;
                }
            }
        }

        function createHeaderContainer(headerBlock, headerIndex, children) {
            const container = document.createElement('div');
            container.style.cssText = 'margin-bottom: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; overflow: hidden;';

            // Determine container background based on level
            const levelColors = {
                1: '#e3f2fd', // Light blue for H1
                2: '#f3e5f5', // Light purple for H2
                3: '#fff3e0', // Light orange for H3
                4: '#f1f8e9'  // Light green for H4
            };
            const bgColor = levelColors[headerBlock.level] || '#f5f5f5';

            // Header section with controls
            const headerSection = document.createElement('div');
            headerSection.style.cssText = `background: ${bgColor}; padding: 16px; border-bottom: 1px solid var(--color-neutral-border);`;

            headerSection.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="flex: 1;">
                        <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <select onchange="updateBlockLevel(${headerIndex}, this.value)" style="padding: 6px 10px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 13px; font-weight: 600; background: white;">
                                <option value="1" ${headerBlock.level === 1 ? 'selected' : ''}>H1</option>
                                <option value="2" ${headerBlock.level === 2 ? 'selected' : ''}>H2</option>
                                <option value="3" ${headerBlock.level === 3 ? 'selected' : ''}>H3</option>
                                <option value="4" ${headerBlock.level === 4 ? 'selected' : ''}>H4</option>
                            </select>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px;">${children.length} block${children.length !== 1 ? 's' : ''} in section</span>
                        </div>
                        <input type="text" value="${headerBlock.content || ''}" onchange="updateBlockContent(${headerIndex}, this.value)" placeholder="Enter header text..." style="width: 100%; border: none; font-family: var(--font-family-ui); font-size: ${28 - (headerBlock.level * 4)}px; font-weight: 600; color: var(--color-dark); outline: none; background: transparent;">
                    </div>
                    <div style="display: flex; gap: 4px;">
                        <button onclick="moveBlockUp(${headerIndex})" ${headerIndex === 0 ? 'disabled' : ''} style="padding: 6px 10px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; font-size: 14px;" title="Move section up">
                            <i class="ph ph-arrow-up"></i>
                        </button>
                        <button onclick="moveBlockDown(${headerIndex})" style="padding: 6px 10px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; font-size: 14px;" title="Move section down">
                            <i class="ph ph-arrow-down"></i>
                        </button>
                        <button onclick="deleteBlock(${headerIndex})" style="padding: 6px 10px; background: white; border: 1px solid #d32f2f; color: #d32f2f; border-radius: 4px; cursor: pointer; font-size: 14px;" title="Delete section">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(headerSection);

            // Children container
            if (children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.style.cssText = 'padding: 16px; background: white;';

                children.forEach(({ block, index }) => {
                    const childEl = createBlockElement(block, index, true);
                    childrenContainer.appendChild(childEl);
                });

                container.appendChild(childrenContainer);
            }

            return container;
        }

        function createBlockElement(block, index, isChild = false) {
            const blockEl = document.createElement('div');
            blockEl.className = 'document-block';
            blockEl.style.cssText = 'position: relative; margin-bottom: 20px; padding: 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white;';

            let contentHTML = '';

            switch (block.type) {
                case 'text':
                    contentHTML = `
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter text (supports rich formatting)..." style="width: 100%; min-height: 150px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: var(--font-family-body); font-size: 14px; color: var(--color-dark); resize: vertical; outline: none; line-height: 1.6;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'table':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-table"></i> Table editor (coming soon)
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter table data (CSV format)..." style="width: 100%; min-height: 120px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 12px; resize: vertical; line-height: 1.5;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'image':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-image"></i> Image
                        </div>
                        <input type="text" value="${block.content || ''}" onchange="updateBlockContent(${index}, this.value)" placeholder="Enter image URL..." style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-body); font-size: 13px;">
                        ${block.content ? `<img src="${block.content}" style="max-width: 100%; margin-top: 12px; border-radius: 4px;" onerror="this.style.display='none'">` : ''}
                    `;
                    break;

                case 'markdown':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-markdown-logo"></i> Markdown (with LaTeX support)
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter markdown content (LaTeX: $inline$ or $$block$$)..." style="width: 100%; min-height: 180px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 12px; resize: vertical; line-height: 1.6;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'latex':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-function"></i> KaTeX Math
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter KaTeX math expressions...\n\nExamples:\n$inline: a^2 + b^2 = c^2$\n$$display block: \\int_0^\\infty e^{-x^2} dx = \\frac{\\sqrt{\\pi}}{2}$$" style="width: 100%; min-height: 180px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 12px; resize: vertical; line-height: 1.6;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'mermaid':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-flow-arrow"></i> Mermaid Diagram
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter Mermaid syntax..." style="width: 100%; min-height: 180px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 12px; resize: vertical; line-height: 1.6;">${block.content || 'graph TD\n    A[Start] --> B[Process]\n    B --> C[End]'}</textarea>
                    `;
                    break;

                case 'code':
                    contentHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <i class="ph ph-code" style="color: var(--color-neutral-text);"></i>
                            <select onchange="updateBlockLanguage(${index}, this.value)" style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 12px;">
                                <option value="javascript" ${block.language === 'javascript' ? 'selected' : ''}>JavaScript</option>
                                <option value="python" ${block.language === 'python' ? 'selected' : ''}>Python</option>
                                <option value="java" ${block.language === 'java' ? 'selected' : ''}>Java</option>
                                <option value="csharp" ${block.language === 'csharp' ? 'selected' : ''}>C#</option>
                                <option value="cpp" ${block.language === 'cpp' ? 'selected' : ''}>C++</option>
                                <option value="sql" ${block.language === 'sql' ? 'selected' : ''}>SQL</option>
                                <option value="html" ${block.language === 'html' ? 'selected' : ''}>HTML</option>
                                <option value="css" ${block.language === 'css' ? 'selected' : ''}>CSS</option>
                            </select>
                            <span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">Code block (with linting)</span>
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter code..." style="width: 100%; min-height: 220px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 13px; background: #f8f8f8; resize: vertical; line-height: 1.6;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'divider':
                    const dividerType = block.dividerType || 'visual';
                    const isPageDivider = dividerType === 'page';
                    contentHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <i class="ph ph-minus" style="color: var(--color-neutral-text);"></i>
                            <select onchange="updateBlockDividerType(${index}, this.value)" style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 12px;">
                                <option value="visual" ${dividerType === 'visual' ? 'selected' : ''}>Visual Divider</option>
                                <option value="page" ${dividerType === 'page' ? 'selected' : ''}>Page Divider</option>
                            </select>
                            <span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">
                                ${isPageDivider ? 'Creates a page break in exports' : 'Visual separator only'}
                            </span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${isPageDivider ?
                                `<div style="flex: 1; height: 3px; background: repeating-linear-gradient(45deg, var(--color-primary-blue), var(--color-primary-blue) 8px, transparent 8px, transparent 16px); border-radius: 1px;"></div>
                                 <div style="background: var(--color-primary-blue); color: white; padding: 4px 8px; border-radius: 12px; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; text-transform: uppercase;">PAGE BREAK</div>
                                 <div style="flex: 1; height: 3px; background: repeating-linear-gradient(45deg, var(--color-primary-blue), var(--color-primary-blue) 8px, transparent 8px, transparent 16px); border-radius: 1px;"></div>` :
                                `<div style="flex: 1; height: 2px; background: var(--color-neutral-border); border-radius: 1px;"></div>`
                            }
                        </div>
                    `;
                    break;
            }

            blockEl.innerHTML = `
                <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                    ${!isChild ? `
                        <button onclick="moveBlockUp(${index})" ${index === 0 ? 'disabled' : ''} style="padding: 4px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; font-size: 14px;" title="Move up">
                            <i class="ph ph-arrow-up"></i>
                        </button>
                        <button onclick="moveBlockDown(${index})" ${index === currentDocumentBlocks.length - 1 ? 'disabled' : ''} style="padding: 4px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; font-size: 14px;" title="Move down">
                            <i class="ph ph-arrow-down"></i>
                        </button>
                    ` : ''}
                    <button onclick="deleteBlock(${index})" style="padding: 4px 8px; background: white; border: 1px solid #d32f2f; color: #d32f2f; border-radius: 4px; cursor: pointer; font-size: 14px;" title="Delete block">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
                ${contentHTML}
            `;

            return blockEl;
        }

        function updateBlockContent(index, content) {
            currentDocumentBlocks[index].content = content;
        }

        function updateBlockLevel(index, level) {
            currentDocumentBlocks[index].level = parseInt(level);
            renderDocumentBlocks();
        }

        function updateBlockLanguage(index, language) {
            currentDocumentBlocks[index].language = language;
        }

        function updateBlockDividerType(index, dividerType) {
            currentDocumentBlocks[index].dividerType = dividerType;
            renderDocumentBlocks();
        }

        function moveBlockUp(index) {
            const block = currentDocumentBlocks[index];

            if (block.type === 'header') {
                // Moving a section - find all its children
                const children = [];
                let j = index + 1;
                while (j < currentDocumentBlocks.length) {
                    const nextBlock = currentDocumentBlocks[j];
                    if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                        break;
                    }
                    children.push(nextBlock);
                    j++;
                }

                const sectionLength = 1 + children.length; // header + children

                if (index === 0) return; // Can't move first section up

                // Find the previous section
                let prevSectionStart = index - 1;
                while (prevSectionStart > 0 && currentDocumentBlocks[prevSectionStart].type !== 'header') {
                    prevSectionStart--;
                }

                // Extract current section
                const section = currentDocumentBlocks.splice(index, sectionLength);

                // Insert before previous section
                currentDocumentBlocks.splice(prevSectionStart, 0, ...section);
            } else {
                // Moving a non-header block
                if (index > 0) {
                    [currentDocumentBlocks[index - 1], currentDocumentBlocks[index]] = [currentDocumentBlocks[index], currentDocumentBlocks[index - 1]];
                }
            }

            renderDocumentBlocks();
        }

        function moveBlockDown(index) {
            const block = currentDocumentBlocks[index];

            if (block.type === 'header') {
                // Moving a section - find all its children
                const children = [];
                let j = index + 1;
                while (j < currentDocumentBlocks.length) {
                    const nextBlock = currentDocumentBlocks[j];
                    if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                        break;
                    }
                    children.push(nextBlock);
                    j++;
                }

                const sectionLength = 1 + children.length;
                const sectionEnd = index + sectionLength;

                if (sectionEnd >= currentDocumentBlocks.length) return; // Can't move last section down

                // Find the next section
                let nextSectionEnd = sectionEnd + 1;
                while (nextSectionEnd < currentDocumentBlocks.length) {
                    const nextBlock = currentDocumentBlocks[nextSectionEnd];
                    if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                        break;
                    }
                    nextSectionEnd++;
                }

                // Extract current section
                const section = currentDocumentBlocks.splice(index, sectionLength);

                // Insert after next section
                const insertPos = Math.min(nextSectionEnd - sectionLength, currentDocumentBlocks.length);
                currentDocumentBlocks.splice(insertPos, 0, ...section);
            } else {
                // Moving a non-header block
                if (index < currentDocumentBlocks.length - 1) {
                    [currentDocumentBlocks[index], currentDocumentBlocks[index + 1]] = [currentDocumentBlocks[index + 1], currentDocumentBlocks[index]];
                }
            }

            renderDocumentBlocks();
        }

        function deleteBlock(index) {
            const block = currentDocumentBlocks[index];

            if (block.type === 'header') {
                // Deleting a section - find all its children
                const children = [];
                let j = index + 1;
                while (j < currentDocumentBlocks.length) {
                    const nextBlock = currentDocumentBlocks[j];
                    if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                        break;
                    }
                    children.push(nextBlock);
                    j++;
                }

                const sectionLength = 1 + children.length;
                const message = children.length > 0
                    ? `Delete this section and its ${children.length} child block${children.length !== 1 ? 's' : ''}?`
                    : 'Delete this header?';

                if (confirm(message)) {
                    currentDocumentBlocks.splice(index, sectionLength);
                    renderDocumentBlocks();
                }
            } else {
                // Deleting a regular block
                if (confirm('Delete this block?')) {
                    currentDocumentBlocks.splice(index, 1);
                    renderDocumentBlocks();
                }
            }
        }

        function toggleWorkBreakdownNumbering() {
            const enabled = document.getElementById('wbnToggle').checked;
            alert(`Work Breakdown Numbering ${enabled ? 'enabled' : 'disabled'}. This feature will automatically number headers in the exported document.`);
        }

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function exportDocument(format) {
            const title = document.getElementById('docTitle').value || 'Untitled Document';
            toggleExportMenu();
            alert(`Export to ${format.toUpperCase()} coming soon!\n\nDocument: ${title}\nBlocks: ${currentDocumentBlocks.length}`);
        }

        function saveDocument() {
            // TODO: Implement save functionality after modal content is populated
            alert('Document saved!');
            closeDocumentEditor();
        }

        function shareDocument() {
            // Nonfunctional placeholder for sharing entire document
            const docTitle = document.getElementById('docTitle').value || 'Untitled Document';
            alert(`Sharing functionality coming soon!\n\nThis will allow you to share "${docTitle}" with others.`);
        }

        function editDocument(index) {
            openDocumentEditor(index);
        }

        function deleteDocument(index) {
            if (confirm('Are you sure you want to delete this document?')) {
                const documents = JSON.parse(localStorage.getItem('professionalDocuments') || '[]');
                documents.splice(index, 1);
                localStorage.setItem('professionalDocuments', JSON.stringify(documents));
                loadDocuments();
            }
        }

        // Close export menu when clicking outside
        document.addEventListener('click', function(event) {
            const exportMenu = document.getElementById('exportMenu');
            if (exportMenu && !event.target.closest('[onclick*="toggleExportMenu"]') && !event.target.closest('#exportMenu')) {
                exportMenu.style.display = 'none';
            }
        });

        function loadNotesCards(searchTerm = '') {
            const container = document.getElementById('notesContainer');

            let filteredNotes = userNotes;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredNotes = userNotes.filter(note =>
                    note.title.toLowerCase().includes(term) ||
                    note.content.toLowerCase().includes(term) ||
                    (note.tags && note.tags.toLowerCase().includes(term))
                );
            }

            if (filteredNotes.length === 0) {
                const message = searchTerm
                    ? `<p style="color: #666; text-align: center; padding: 40px 20px; grid-column: 1/-1;">No notes found matching "${searchTerm}"</p>`
                    : '<p style="color: #666; text-align: center; padding: 40px 20px; grid-column: 1/-1;">No notes yet. Click Add Note to create your first note.</p>';
                container.innerHTML = message;
                return;
            }

            container.innerHTML = filteredNotes.map((note, index) => {
                const actualIndex = userNotes.indexOf(note);
                const categoryStyle = categoryColors[note.category] || categoryColors['general'];
                const tags = note.tags ? note.tags.split(',').map(t => t.trim()).filter(t => t) : [];
                const contentPreview = note.content.length > 200 ? note.content.substring(0, 200) + '...' : note.content;

                return `
                    <div class="story-card" style="cursor: default; border-left: 4px solid ${categoryStyle.color};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="background: ${categoryStyle.bg}; color: ${categoryStyle.color}; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                        <i class="${categoryStyle.icon}" style="font-size: 14px;"></i>
                                        ${note.category.charAt(0).toUpperCase() + note.category.slice(1)}
                                    </span>
                                    <span style="color: #999; font-size: 11px;">${note.date}</span>
                                </div>
                                <h4 style="margin: 0 0 12px 0; color: #1a1a1a; font-size: 16px; font-weight: 600;">${note.title}</h4>
                                <p style="margin: 0 0 12px 0; color: #666; font-size: 13px; line-height: 1.6; white-space: pre-wrap;">
                                    ${contentPreview}
                                </p>
                                ${tags.length > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${tags.map(tag => `
                                            <span style="background: #f5f5f5; color: #666; padding: 3px 8px; border-radius: 10px; font-size: 10px;">
                                                #${tag}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px; margin-left: 12px;">
                                <button onclick="editNote(${actualIndex})" style="padding: 6px 10px; background: #f5f5f7; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #666; font-weight: 600;">
                                    <i class="ph ph-pencil"></i> Edit
                                </button>
                                <button onclick="deleteNote(${actualIndex})" style="padding: 6px 10px; background: #fee; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #c33; font-weight: 600;">
                                    <i class="ph ph-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchNotes() {
            const searchTerm = document.getElementById('notesSearchInput').value;
            loadNotesCards(searchTerm);
        }

        function addNote() {
            document.getElementById('noteFormModal').classList.add('active');
            document.getElementById('noteForm').reset();
            document.getElementById('noteFormTitle').textContent = 'Add Note';
            document.getElementById('noteForm').dataset.editIndex = '';
        }

        function editNote(index) {
            const note = userNotes[index];
            document.getElementById('noteFormModal').classList.add('active');
            document.getElementById('noteFormTitle').textContent = 'Edit Note';

            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteCategory').value = note.category;
            document.getElementById('noteTags').value = note.tags || '';
            document.getElementById('noteContent').value = note.content;

            document.getElementById('noteForm').dataset.editIndex = index;
        }

        function closeNoteForm() {
            document.getElementById('noteFormModal').classList.remove('active');
        }

        function saveNote(event) {
            event.preventDefault();

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            const noteData = {
                title: document.getElementById('noteTitle').value,
                category: document.getElementById('noteCategory').value,
                tags: document.getElementById('noteTags').value,
                content: document.getElementById('noteContent').value,
                date: dateStr,
                timestamp: now.getTime()
            };

            const editIndex = document.getElementById('noteForm').dataset.editIndex;

            if (editIndex !== '') {
                noteData.date = userNotes[parseInt(editIndex)].date; // Keep original date
                noteData.editedDate = dateStr; // Track edit date
                userNotes[parseInt(editIndex)] = noteData;
            } else {
                userNotes.unshift(noteData); // Add to beginning (most recent first)
            }

            saveUserNotes();
            loadNotesCards();
            updateNodeCounts();
            closeNoteForm();
        }

        function deleteNote(index) {
            if (confirm('Are you sure you want to delete this note?')) {
                userNotes.splice(index, 1);
                saveUserNotes();
                loadNotesCards();
                updateNodeCounts();
            }
        }

        // Skills & Competencies Management
        let userSkillsCompetencies = [];

        function loadUserSkillsCompetencies() {
            const stored = localStorage.getItem(`skillsCompetencies_${currentPersona}`);
            userSkillsCompetencies = stored ? JSON.parse(stored) : [];
        }

        function saveUserSkillsCompetencies() {
            localStorage.setItem(`skillsCompetencies_${currentPersona}`, JSON.stringify(userSkillsCompetencies));
        }

        function openSkillsCompetenciesSlideout() {
            loadUserSkillsCompetencies();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');
            const skillsCompetenciesContent = document.getElementById('skillsCompetenciesContent');

            titleEl.textContent = 'Goals';

            // Hide all content sections
            hideAllContentSections();

            // Show skills content
            skillsCompetenciesContent.style.display = 'flex';
            loadSkillsCompetencies();

            slideout.classList.add('active');
        }

        // Example goals data with realistic current levels and improvement areas per persona
        const exampleGoalsData = {
            'retail-manager': {
                improvementGoals: ['Python Programming', 'Power BI Advanced Features', 'SQL Query Optimization'],
                skills: [
                    { name: 'Excel', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Power BI', currentLevel: 2, desiredLevel: 4 },
                    { name: 'SQL', currentLevel: 2, desiredLevel: 4 },
                    { name: 'Python', currentLevel: 1, desiredLevel: 3 },
                    { name: 'Data Analysis', currentLevel: 3, desiredLevel: 4 }
                ],
                competencies: [
                    { name: 'Leadership', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Operations Management', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Problem Solving', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Communication', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Strategic Thinking', currentLevel: 2, desiredLevel: 4 }
                ]
            },
            'field-engineer': {
                improvementGoals: ['Azure Cloud Architecture', 'Kubernetes', 'Infrastructure as Code'],
                skills: [
                    { name: 'Networking', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Windows Server', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Active Directory', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Azure', currentLevel: 2, desiredLevel: 4 },
                    { name: 'PowerShell', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Kubernetes', currentLevel: 1, desiredLevel: 3 },
                    { name: 'Terraform', currentLevel: 1, desiredLevel: 3 }
                ],
                competencies: [
                    { name: 'Technical Troubleshooting', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Customer Service', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Documentation', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Project Management', currentLevel: 2, desiredLevel: 3 },
                    { name: 'Cloud Architecture', currentLevel: 2, desiredLevel: 4 }
                ]
            },
            'business-analyst': {
                improvementGoals: ['Machine Learning Fundamentals', 'Advanced Python', 'Data Engineering'],
                skills: [
                    { name: 'SQL', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Excel', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Tableau', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Python', currentLevel: 2, desiredLevel: 4 },
                    { name: 'R', currentLevel: 2, desiredLevel: 3 },
                    { name: 'Machine Learning', currentLevel: 1, desiredLevel: 3 },
                    { name: 'Data Engineering', currentLevel: 1, desiredLevel: 3 }
                ],
                competencies: [
                    { name: 'Data Analysis', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Business Acumen', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Communication', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Statistical Analysis', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Stakeholder Management', currentLevel: 3, desiredLevel: 4 }
                ]
            },
            'devops-engineer': {
                improvementGoals: ['Security Best Practices', 'Cost Optimization', 'SRE Practices'],
                skills: [
                    { name: 'Docker', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Kubernetes', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Terraform', currentLevel: 4, desiredLevel: 4 },
                    { name: 'AWS', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Python', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Security', currentLevel: 2, desiredLevel: 4 },
                    { name: 'Cost Optimization', currentLevel: 2, desiredLevel: 4 }
                ],
                competencies: [
                    { name: 'Automation', currentLevel: 4, desiredLevel: 5 },
                    { name: 'System Design', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Troubleshooting', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Collaboration', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Site Reliability', currentLevel: 3, desiredLevel: 4 }
                ]
            }
        };

        function extractSkillsFromExperience() {
            // Return example goals data for demo
            const goalsData = exampleGoalsData[currentPersona] || { skills: [], competencies: [], improvementGoals: [] };

            return {
                skills: goalsData.skills.map(s => ({ ...s, name: s.name, type: 'skill', fromExperience: true })),
                competencies: goalsData.competencies.map(c => ({ ...c, name: c.name, type: 'competency', fromExperience: true })),
                improvementGoals: goalsData.improvementGoals || []
            };
        }

        function loadSkillsCompetencies() {
            const container = document.getElementById('skillsCompetenciesContainer');
            const pillsContainer = document.getElementById('improvementGoalsPills');
            const extracted = extractSkillsFromExperience();

            // Display improvement goals pills
            if (extracted.improvementGoals && extracted.improvementGoals.length > 0) {
                let pillsHtml = '';
                extracted.improvementGoals.forEach(goal => {
                    pillsHtml += `<div style="background: linear-gradient(135deg, #ff9800 0%, #ff6b35 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(255, 152, 0, 0.2);">
                        <i class="ph ph-target" style="font-size: 14px;"></i>
                        ${escapeHtml(goal)}
                    </div>`;
                });
                pillsContainer.innerHTML = pillsHtml;
            } else {
                pillsContainer.innerHTML = '<p style="color: #999; font-size: 12px; margin: 0;">No improvement goals set</p>';
            }

            // Use example data directly (no user override for demo)
            const skills = extracted.skills;
            const competencies = extracted.competencies;

            if (skills.length === 0 && competencies.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px 20px;">No skills or competencies found. Add career experience or manually add skills to get started.</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">';

            // Skills column
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            html += '<h3 style="margin: 0 0 8px 0; font-size: 16px; color: #1a1a1a; font-weight: 600; border-bottom: 2px solid #0066CC; padding-bottom: 8px;">Skills</h3>';
            if (skills.length > 0) {
                skills.forEach((item, index) => {
                    html += renderSkillCompetencyCard(item, index, 'skill');
                });
            } else {
                html += '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">No skills yet</p>';
            }
            html += '</div>';

            // Competencies column
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            html += '<h3 style="margin: 0 0 8px 0; font-size: 16px; color: #1a1a1a; font-weight: 600; border-bottom: 2px solid #004C99; padding-bottom: 8px;">Competencies</h3>';
            if (competencies.length > 0) {
                competencies.forEach((item, index) => {
                    html += renderSkillCompetencyCard(item, index + skills.length, 'competency');
                });
            } else {
                html += '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">No competencies yet</p>';
            }
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;
        }

        function renderSkillCompetencyCard(item, index, type) {
            const currentLevel = item.currentLevel || 1;
            const desiredLevel = item.desiredLevel || 1;
            const gap = desiredLevel - currentLevel;
            const gapColor = gap > 0 ? '#ff9800' : gap < 0 ? '#666' : '#4caf50';

            return `
                <div style="background: white; border: 1px solid #e5e5e7; border-radius: 8px; padding: 12px; position: relative;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #1a1a1a;">${escapeHtml(item.name)}</h4>
                            ${item.fromExperience ? '<span style="background: #e3f2fd; color: #0066CC; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600;">From Experience</span>' : '<span style="background: #f5f5f7; color: #666; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600;">Custom</span>'}
                        </div>
                    </div>

                    <!-- Non-interactive visual slider -->
                    <div style="position: relative; padding: 20px 0;">
                        <!-- Scale markers -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 0 10px;">
                            <span style="font-size: 10px; color: #999; font-weight: 600;">1</span>
                            <span style="font-size: 10px; color: #999; font-weight: 600;">2</span>
                            <span style="font-size: 10px; color: #999; font-weight: 600;">3</span>
                            <span style="font-size: 10px; color: #999; font-weight: 600;">4</span>
                            <span style="font-size: 10px; color: #999; font-weight: 600;">5</span>
                        </div>

                        <!-- Track (non-interactive) -->
                        <div style="position: relative; height: 8px; background: #e5e5e7; border-radius: 4px; margin: 0 10px;">
                            <!-- Current position circle (blue) -->
                            <div style="position: absolute; top: 50%; left: ${(currentLevel - 1) * 25}%; transform: translate(-50%, -50%); width: 20px; height: 20px; background: #0066CC; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 2;"></div>

                            <!-- Target position circle (orange) -->
                            <div style="position: absolute; top: 50%; left: ${(desiredLevel - 1) * 25}%; transform: translate(-50%, -50%); width: 20px; height: 20px; background: #ff9800; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 1;"></div>
                        </div>

                        <!-- Legend and values -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding: 0 10px;">
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div style="width: 12px; height: 12px; background: #0066CC; border-radius: 50%;"></div>
                                    <span style="font-size: 10px; color: #666;">Current: <strong>${currentLevel}</strong></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div style="width: 12px; height: 12px; background: #ff9800; border-radius: 50%;"></div>
                                    <span style="font-size: 10px; color: #666;">Target: <strong>${desiredLevel}</strong></span>
                                </div>
                            </div>
                            ${gap !== 0 ? `<div style="font-size: 10px; color: ${gapColor}; font-weight: 600;">Gap: ${gap > 0 ? '+' : ''}${gap}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Removed initializeSlider() - sliders are now non-interactive for demo

        function updateSkillLevel(name, type, levelType, value) {
            loadUserSkillsCompetencies();

            let item = userSkillsCompetencies.find(s => s.name === name && s.type === type);

            if (!item) {
                // Create new entry
                item = {
                    name: name,
                    type: type,
                    fromExperience: true,
                    currentLevel: 1,
                    desiredLevel: 1
                };
                userSkillsCompetencies.push(item);
            }

            if (levelType === 'current') {
                item.currentLevel = parseInt(value);
            } else {
                item.desiredLevel = parseInt(value);
            }

            saveUserSkillsCompetencies();
            loadSkillsCompetencies();
            updateNodeCounts();
        }

        function syncFromExperience() {
            loadSkillsCompetencies();
            alert('Skills and competencies synced from your career experience!');
        }

        function addCustomSkill() {
            const name = prompt('Enter skill or competency name:');
            if (!name || name.trim() === '') return;

            const type = confirm('Is this a Skill?\n\nClick OK for Skill, Cancel for Competency') ? 'skill' : 'competency';

            loadUserSkillsCompetencies();

            // Check if already exists
            const exists = userSkillsCompetencies.find(s => s.name === name.trim() && s.type === type);
            if (exists) {
                alert('This ' + type + ' already exists!');
                return;
            }

            userSkillsCompetencies.push({
                name: name.trim(),
                type: type,
                fromExperience: false,
                currentLevel: 1,
                desiredLevel: 1
            });

            saveUserSkillsCompetencies();
            loadSkillsCompetencies();
            updateNodeCounts();
        }

        function deleteSkillCompetency(name, type) {
            if (confirm(`Are you sure you want to delete this ${type}?`)) {
                loadUserSkillsCompetencies();
                userSkillsCompetencies = userSkillsCompetencies.filter(s => !(s.name === name && s.type === type));
                saveUserSkillsCompetencies();
                loadSkillsCompetencies();
                updateNodeCounts();
            }
        }

        // Modal functions (Pipeline Edit Pattern)
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Export Menu Functions
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Close export menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('exportMenu');
            const exportButton = event.target.closest('button[onclick="toggleExportMenu()"]');

            if (menu && menu.style.display === 'block' && !exportButton && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        function exportDocument(format) {
            // Close the export menu
            document.getElementById('exportMenu').style.display = 'none';

            // Get document data
            const title = document.getElementById('docTitle').value || 'Untitled Document';
            const canvas = document.getElementById('documentCanvas');
            const blocks = canvas.querySelectorAll('.document-block');

            let content = '';

            // Build content from blocks
            blocks.forEach(block => {
                // Use data-block-type attribute (new structure) or fall back to label (old structure)
                const blockType = block.getAttribute('data-block-type') || block.querySelector('.block-type-label')?.textContent.toLowerCase();

                if (blockType === 'header' || blockType === 'heading') {
                    const input = block.querySelector('input');
                    const wbsSpan = block.querySelector('.wbs-number');
                    if (input && input.value) {
                        // Include WBS number if present
                        const wbsPrefix = wbsSpan ? `${wbsSpan.textContent} ` : '';
                        content += `# ${wbsPrefix}${input.value}\n\n`;
                    }
                } else if (blockType === 'paragraph' || blockType === 'text') {
                    const textarea = block.querySelector('textarea');
                    if (textarea && textarea.value) {
                        content += `${textarea.value}\n\n`;
                    }
                } else if (blockType === 'markdown') {
                    const textarea = block.querySelector('.markdown-input');
                    if (textarea && textarea.value) {
                        content += `${textarea.value}\n\n`;
                    }
                } else if (blockType === 'quote') {
                    const textarea = block.querySelector('textarea');
                    if (textarea && textarea.value) {
                        content += `> ${textarea.value}\n\n`;
                    }
                } else if (blockType === 'code') {
                    const textarea = block.querySelector('textarea');
                    const lang = block.querySelector('select')?.value || '';
                    if (textarea && textarea.value) {
                        content += `\`\`\`${lang}\n${textarea.value}\n\`\`\`\n\n`;
                    }
                } else if (blockType === 'list') {
                    const textarea = block.querySelector('textarea');
                    if (textarea && textarea.value) {
                        const items = textarea.value.split('\n').filter(item => item.trim());
                        items.forEach(item => {
                            content += `- ${item}\n`;
                        });
                        content += '\n';
                    }
                } else if (blockType === 'picture') {
                    const img = block.querySelector('.picture-preview img');
                    const altText = block.querySelector('.image-alt-text');
                    if (img && img.src) {
                        const alt = altText?.value || 'Image';
                        content += `![${alt}](${img.src})\n\n`;
                    }
                } else if (blockType === 'mermaid') {
                    const textarea = block.querySelector('.mermaid-edit-area textarea');
                    if (textarea && textarea.value) {
                        content += `\`\`\`mermaid\n${textarea.value}\n\`\`\`\n\n`;
                    }
                } else if (blockType === 'katex' || blockType === 'latex') {
                    const textarea = block.querySelector('.latex-edit-area textarea');
                    if (textarea && textarea.value) {
                        content += `$$\n${textarea.value}\n$$\n\n`;
                    }
                } else if (blockType === 'diagram') {
                    const diagramData = block.querySelector('.diagram-data')?.value;
                    if (diagramData) {
                        // For diagrams, we'll embed the SVG if available
                        const preview = block.querySelector('.diagram-preview svg');
                        if (preview) {
                            content += `<!-- Draw.io Diagram -->\n${preview.outerHTML}\n\n`;
                        } else {
                            content += `<!-- Draw.io Diagram (data stored but not rendered) -->\n\n`;
                        }
                    }
                } else if (blockType === 'toc') {
                    // Generate TOC for export
                    content += `## Table of Contents\n\n`;
                    const tocEntries = block.querySelectorAll('.toc-content > div[style*="margin-left"]');
                    if (tocEntries.length > 0) {
                        tocEntries.forEach(entry => {
                            const text = entry.textContent.trim();
                            const indent = entry.style.marginLeft ? parseInt(entry.style.marginLeft) / 20 : 0;
                            const prefix = '  '.repeat(indent);
                            content += `${prefix}- ${text}\n`;
                        });
                    } else {
                        content += `*No headers found in document*\n`;
                    }
                    content += `\n`;
                } else if (blockType === 'divider') {
                    const dividerType = block.getAttribute('data-divider-type') || 'visual';
                    if (dividerType === 'page') {
                        // Add page break marker for different formats
                        if (format === 'docx' || format === 'pdf') {
                            content += `<div style="page-break-before: always;"></div>\n\n`;
                        } else if (format === 'markdown') {
                            content += `\n<!-- PAGE BREAK -->\n\\newpage\n\n`;
                        } else {
                            content += `\n---\n\n`; // Fallback for other formats
                        }
                    } else {
                        // Visual divider only
                        content += `\n---\n\n`;
                    }
                }
            });

            // Export based on format
            if (format === 'markdown') {
                downloadFile(`# ${title}\n\n${content}`, `${title}.md`, 'text/markdown');
            } else if (format === 'html') {
                const htmlContent = convertMarkdownToHTML(content);
                const fullHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; }
        h1, h2, h3 { color: #1a1a1a; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; }
        pre { background: #f5f5f5; padding: 16px; border-radius: 8px; overflow-x: auto; }
        blockquote { border-left: 4px solid #0066CC; padding-left: 16px; color: #666; margin: 16px 0; }
    </style>
</head>
<body>
    <h1>${title}</h1>
    ${htmlContent}
</body>
</html>`;
                downloadFile(fullHTML, `${title}.html`, 'text/html');
            } else if (format === 'docx') {
                alert('Word export coming soon! For now, you can export as HTML and open in Word.');
            } else if (format === 'pdf') {
                alert('PDF export coming soon! For now, you can export as HTML and print to PDF from your browser.');
            }
        }

        function convertMarkdownToHTML(markdown) {
            let html = markdown;

            // Headers
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');

            // Blockquotes
            html = html.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');

            // Code blocks
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

            // Lists
            html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';

            // Clean up
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[1-6]>)/g, '$1');
            html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<blockquote>)/g, '$1');
            html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            html = html.replace(/<p>(<pre>)/g, '$1');
            html = html.replace(/(<\/pre>)<\/p>/g, '$1');

            return html;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Picture Upload Functions
        function triggerPictureUpload(blockId) {
            const fileInput = document.getElementById(`fileInput-${blockId}`);
            fileInput.click();
        }

        function handlePictureFileSelect(event, blockId) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                loadPictureToBlock(file, blockId);
            }
        }

        function handlePictureDragOver(event, blockId) {
            event.preventDefault();
            event.stopPropagation();
            const zone = event.currentTarget;
            zone.style.borderColor = 'var(--color-primary-blue)';
            zone.style.background = 'rgba(0, 102, 204, 0.05)';
        }

        function handlePictureDragLeave(event, blockId) {
            event.preventDefault();
            event.stopPropagation();
            const zone = event.currentTarget;
            zone.style.borderColor = 'var(--color-neutral-border)';
            zone.style.background = 'var(--color-neutral-background)';
        }

        function handlePictureDrop(event, blockId) {
            event.preventDefault();
            event.stopPropagation();

            const zone = event.currentTarget;
            zone.style.borderColor = 'var(--color-neutral-border)';
            zone.style.background = 'var(--color-neutral-background)';

            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                loadPictureToBlock(files[0], blockId);
            }
        }

        function loadPictureToBlock(file, blockId) {
            const reader = new FileReader();

            reader.onload = function(e) {
                const block = document.getElementById(blockId);
                const uploadZone = block.querySelector('.picture-upload-zone');
                const previewZone = block.querySelector('.picture-preview');
                const img = previewZone.querySelector('img');

                // Hide upload zone, show preview
                uploadZone.style.display = 'none';
                previewZone.style.display = 'block';

                // Set image source
                img.src = e.target.result;
                img.alt = file.name;

                // Store the image data in a data attribute for export
                block.setAttribute('data-image-src', e.target.result);
            };

            reader.readAsDataURL(file);
        }

        function removePicture(blockId) {
            const block = document.getElementById(blockId);
            const uploadZone = block.querySelector('.picture-upload-zone');
            const previewZone = block.querySelector('.picture-preview');
            const img = previewZone.querySelector('img');
            const altInput = block.querySelector('.image-alt-text');

            // Clear image
            img.src = '';
            img.alt = '';
            altInput.value = '';
            block.removeAttribute('data-image-src');

            // Show upload zone, hide preview
            uploadZone.style.display = 'block';
            previewZone.style.display = 'none';

            // Reset file input
            const fileInput = document.getElementById(`fileInput-${blockId}`);
            if (fileInput) {
                fileInput.value = '';
            }
        }

        // Global paste handler for images
        document.addEventListener('paste', function(event) {
            const items = event.clipboardData?.items;
            if (!items) return;

            // Check if we're focused on a picture block
            const activeElement = document.activeElement;
            const pictureBlock = activeElement?.closest('.document-block');

            if (!pictureBlock) return;

            const blockType = pictureBlock.querySelector('.block-type-label')?.textContent;
            if (blockType !== 'Picture') return;

            // Look for image in clipboard
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    event.preventDefault();
                    const blob = items[i].getAsFile();
                    const blockId = pictureBlock.id;
                    loadPictureToBlock(blob, blockId);
                    break;
                }
            }
        });

        // Make picture blocks focusable for paste support
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for dynamically added picture blocks
            document.addEventListener('click', function(event) {
                const uploadZone = event.target.closest('.picture-upload-zone');
                if (uploadZone) {
                    // Make the block focusable
                    const block = uploadZone.closest('.document-block');
                    if (block) {
                        block.tabIndex = 0;
                        block.focus();
                    }
                }
            });
        });

        // Code Linting Functions
        function updateCodeLanguage(blockId, language) {
            const block = document.getElementById(blockId);
            block.setAttribute('data-language', language);
        }

        function lintCode(blockId) {
            const block = document.getElementById(blockId);
            const textarea = block.querySelector('.code-textarea');
            const resultsDiv = block.querySelector('.lint-results');
            const language = block.querySelector('.code-language-select').value;
            const code = textarea.value;

            if (!code.trim()) {
                resultsDiv.style.display = 'none';
                return;
            }

            const issues = performLinting(code, language);

            if (issues.length === 0) {
                resultsDiv.style.display = 'block';
                resultsDiv.style.background = '#ecfdf5';
                resultsDiv.style.border = '1px solid #6ee7b7';
                resultsDiv.style.color = '#065f46';
                resultsDiv.innerHTML = '<i class="ph ph-check-circle" style="color: #10b981; margin-right: 6px;"></i>No issues found!';
            } else {
                resultsDiv.style.display = 'block';
                resultsDiv.style.background = '#fef2f2';
                resultsDiv.style.border = '1px solid #fca5a5';
                resultsDiv.style.color = '#991b1b';
                resultsDiv.innerHTML = '<div style="margin-bottom: 8px; font-weight: 600;"><i class="ph ph-warning-circle" style="color: #ef4444; margin-right: 6px;"></i>Found ' + issues.length + ' issue(s):</div>' +
                    issues.map(issue => `<div style="margin-left: 24px; margin-bottom: 4px;">• Line ${issue.line}: ${issue.message}</div>`).join('');
            }
        }

        function performLinting(code, language) {
            const issues = [];
            const lines = code.split('\n');

            switch (language) {
                case 'javascript':
                case 'typescript':
                    // Check for common JS/TS issues
                    lines.forEach((line, index) => {
                        // Missing semicolons
                        if (line.trim() && !line.trim().endsWith(';') && !line.trim().endsWith('{') && !line.trim().endsWith('}') && !line.trim().endsWith(',') && !line.trim().startsWith('//') && !line.trim().startsWith('*') && !line.trim().startsWith('/*') && !line.trim().startsWith('import') && !line.trim().startsWith('export')) {
                            issues.push({ line: index + 1, message: 'Missing semicolon' });
                        }
                        // Console.log statements
                        if (line.includes('console.log(')) {
                            issues.push({ line: index + 1, message: 'console.log() statement found (consider removing for production)' });
                        }
                        // var usage
                        if (line.includes('var ')) {
                            issues.push({ line: index + 1, message: 'Use let or const instead of var' });
                        }
                        // == instead of ===
                        if (line.includes('==') && !line.includes('===') && !line.includes('!==')) {
                            issues.push({ line: index + 1, message: 'Use === instead of == for comparison' });
                        }
                    });
                    break;

                case 'python':
                    lines.forEach((line, index) => {
                        // Mixed tabs and spaces
                        if (line.match(/^\t/) && code.includes('    ')) {
                            issues.push({ line: index + 1, message: 'Mixed tabs and spaces for indentation' });
                        }
                        // Print statements without parentheses (Python 2 style)
                        if (line.match(/print\s+[^(]/)) {
                            issues.push({ line: index + 1, message: 'Use print() with parentheses (Python 3 syntax)' });
                        }
                        // Import * statements
                        if (line.includes('from') && line.includes('import *')) {
                            issues.push({ line: index + 1, message: 'Avoid wildcard imports (import *)' });
                        }
                    });
                    break;

                case 'java':
                case 'csharp':
                    lines.forEach((line, index) => {
                        // Missing semicolons
                        if (line.trim() && !line.trim().endsWith(';') && !line.trim().endsWith('{') && !line.trim().endsWith('}') && !line.trim().startsWith('//') && !line.trim().startsWith('*') && !line.trim().startsWith('/*') && !line.trim().startsWith('@') && line.includes('=')) {
                            issues.push({ line: index + 1, message: 'Missing semicolon' });
                        }
                        // System.out.println (Java)
                        if (language === 'java' && line.includes('System.out.println(')) {
                            issues.push({ line: index + 1, message: 'Consider using a logging framework instead of System.out.println()' });
                        }
                    });
                    break;

                case 'sql':
                    lines.forEach((line, index) => {
                        // SELECT *
                        if (line.toUpperCase().includes('SELECT *')) {
                            issues.push({ line: index + 1, message: 'Avoid SELECT *, specify column names explicitly' });
                        }
                        // Missing WHERE in UPDATE/DELETE
                        if ((line.toUpperCase().includes('UPDATE') || line.toUpperCase().includes('DELETE')) && !code.toUpperCase().includes('WHERE')) {
                            issues.push({ line: index + 1, message: 'UPDATE/DELETE without WHERE clause can be dangerous' });
                        }
                    });
                    break;

                case 'html':
                    lines.forEach((line, index) => {
                        // Missing alt attribute on images
                        if (line.includes('<img') && !line.includes('alt=')) {
                            issues.push({ line: index + 1, message: 'Missing alt attribute on <img> tag' });
                        }
                        // Inline styles
                        if (line.includes('style=') && !line.includes('style="')) {
                            issues.push({ line: index + 1, message: 'Consider using CSS classes instead of inline styles' });
                        }
                    });
                    break;

                case 'css':
                    lines.forEach((line, index) => {
                        // !important usage
                        if (line.includes('!important')) {
                            issues.push({ line: index + 1, message: 'Avoid using !important' });
                        }
                        // Missing semicolons
                        if (line.includes(':') && !line.includes(';') && !line.trim().endsWith('{') && !line.trim().endsWith('}') && line.trim() !== '') {
                            issues.push({ line: index + 1, message: 'Missing semicolon' });
                        }
                    });
                    break;

                case 'json':
                    try {
                        JSON.parse(code);
                    } catch (e) {
                        issues.push({ line: 1, message: 'Invalid JSON: ' + e.message });
                    }
                    break;

                case 'yaml':
                    lines.forEach((line, index) => {
                        // Mixed tabs and spaces
                        if (line.match(/^\t/)) {
                            issues.push({ line: index + 1, message: 'Use spaces for indentation in YAML, not tabs' });
                        }
                    });
                    break;
            }

            return issues.slice(0, 10); // Limit to 10 issues
        }

        // Document block management
        function addDocumentBlock(blockType) {
            const canvas = document.getElementById('documentCanvas');

            // Remove empty state if present
            const emptyState = canvas.querySelector('[style*="text-align: center"]');
            if (emptyState) {
                canvas.innerHTML = '';
            }

            // Create block element
            const blockId = `block-${Date.now()}`;
            const block = document.createElement('div');
            block.id = blockId;
            block.className = 'document-block';
            block.setAttribute('data-block-type', blockType);
            block.setAttribute('tabindex', '0');
            block.style.cssText = 'margin-bottom: 16px; padding: 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; position: relative;';

            // Add block content based on type
            let blockContent = '';
            switch(blockType) {
                case 'header':
                    blockContent = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <select onchange="changeHeaderLevel('${blockId}', this.value)" style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; color: var(--color-neutral-text); background: white; cursor: pointer;">
                                <option value="1">H1</option>
                                <option value="2">H2</option>
                                <option value="3" selected>H3</option>
                                <option value="4">H4</option>
                                <option value="5">H5</option>
                                <option value="6">H6</option>
                            </select>
                        </div>
                        <div class="header-input-container" style="display: flex; align-items: center; gap: 8px;">
                            <input type="text" placeholder="Enter header text..." class="header-input" data-level="3" oninput="updateTableOfContents()" style="width: 100%; border: none; font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); outline: none;">
                        </div>
                    `;
                    break;
                case 'richtext':
                    blockContent = `<div class="quill-container-${blockId}" style="background: white; margin-top: 32px; resize: both; overflow: auto; min-height: 200px; max-width: 100%;"></div>`;
                    break;
                case 'markdown':
                    blockContent = `
                        <div class="markdown-editor" style="padding-top: 32px;">
                            <textarea class="markdown-input" placeholder="Enter markdown content..." style="width: 100%; min-height: 120px; border: none; font-family: monospace; font-size: 13px; color: var(--color-dark); outline: none; resize: vertical; line-height: 1.5;"># Technical Documentation

## Overview

This document provides a **comprehensive guide** to using markdown for technical writing.

### Key Features

- **Easy to read** and write
- Supports *inline formatting*
- Code blocks with syntax highlighting
- Tables and lists

### Code Example

\`\`\`javascript
function greet(name) {
    return \`Hello, \${name}!\`;
}
\`\`\`

### Quick Reference

| Element | Syntax |
|---------|--------|
| Bold | \`**text**\` |
| Italic | \`*text*\` |
| Link | \`[text](url)\` |

> **Note:** This is a blockquote for important callouts.</textarea>
                            <div class="markdown-preview" style="display: none; width: 100%; min-height: 120px; padding: 12px; border: 1px solid var(--color-neutral-border); border-radius: 4px; background: white; font-family: var(--font-family-body); font-size: 14px; line-height: 1.6;"></div>
                        </div>
                    `;
                    break;
                case 'picture':
                    blockContent = `
                        <div class="picture-upload-zone"
                             onclick="triggerPictureUpload('${blockId}')"
                             ondrop="handlePictureDrop(event, '${blockId}')"
                             ondragover="handlePictureDragOver(event, '${blockId}')"
                             ondragleave="handlePictureDragLeave(event, '${blockId}')"
                             style="text-align: center; padding: 40px; background: var(--color-neutral-background); border: 2px dashed var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <i class="ph ph-image" style="font-size: 48px; color: var(--color-neutral-text-light);"></i>
                            <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 8px 0 4px 0;">Click to upload image</p>
                            <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin: 0;">or drag & drop</p>
                            <input type="file" id="fileInput-${blockId}" accept="image/*" style="display: none;" onchange="handlePictureFileSelect(event, '${blockId}')">
                        </div>
                        <div class="picture-preview" style="display: none;">
                            <img style="max-width: 100%; height: auto; border-radius: 8px;" />
                            <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: center;">
                                <input type="text" placeholder="Alt text (optional)" style="flex: 1; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;" class="image-alt-text">
                                <button onclick="removePicture('${blockId}')" style="padding: 8px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); cursor: pointer; transition: all 0.2s;">
                                    <i class="ph ph-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    `;
                    break;
                case 'table':
                    blockContent = `
                        <div style="display: flex; gap: 12px; padding: 20px;">
                            <!-- Create Cleansheet Table -->
                            <div onclick="createCleansheetTable('${blockId}')" style="flex: 1; text-align: center; padding: 24px 16px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-plus-circle" style="font-size: 32px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                <p style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Create Cleansheet Table</p>
                                <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin: 0;">Build a new table from scratch</p>
                            </div>

                            <!-- Connect Cleansheet Table -->
                            <div onclick="connectCleansheetTable('${blockId}')" style="flex: 1; text-align: center; padding: 24px 16px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-link" style="font-size: 32px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                <p style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Connect Cleansheet Table</p>
                                <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin: 0;">Link to existing table</p>
                            </div>

                            <!-- Connect Data Source -->
                            <div onclick="connectDataSource('${blockId}')" style="flex: 1; text-align: center; padding: 24px 16px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-database" style="font-size: 32px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                <p style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Connect Data Source</p>
                                <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin: 0;">Import from external source</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'code':
                    blockContent = `
                        <div style="margin-top: 32px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 8px; padding: 8px 12px; background: var(--color-neutral-background); border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="ph ph-code" style="font-size: 16px; color: var(--color-neutral-text);"></i>
                                    <select class="code-language-select" onchange="updateCodeLanguage('${blockId}', this.value)" style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; background: white; cursor: pointer;">
                                        <option value="javascript">JavaScript</option>
                                        <option value="python">Python</option>
                                        <option value="java">Java</option>
                                        <option value="csharp">C#</option>
                                        <option value="cpp">C++</option>
                                        <option value="typescript">TypeScript</option>
                                        <option value="go">Go</option>
                                        <option value="rust">Rust</option>
                                        <option value="php">PHP</option>
                                        <option value="ruby">Ruby</option>
                                        <option value="sql">SQL</option>
                                        <option value="html">HTML</option>
                                        <option value="css">CSS</option>
                                        <option value="json">JSON</option>
                                        <option value="yaml">YAML</option>
                                        <option value="bash">Bash</option>
                                    </select>
                                </div>
                                <button onclick="lintCode('${blockId}')" title="Lint code" style="padding: 6px 12px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--color-neutral-text); font-family: var(--font-family-ui); font-size: 12px; transition: all 0.2s;">
                                    <i class="ph ph-checks" style="font-size: 14px;"></i>
                                    Lint
                                </button>
                            </div>
                            <textarea placeholder="Enter code..." class="code-textarea" style="width: 100%; min-height: 120px; border: none; font-family: monospace; font-size: 13px; color: var(--color-dark); background: #f8f8f8; outline: none; resize: vertical; padding: 12px; line-height: 1.5;"></textarea>
                            <div class="lint-results" style="display: none; margin-top: 8px; padding: 12px; border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;"></div>
                        </div>
                    `;
                    break;
                case 'diagram':
                    blockContent = `
                        <div style="margin-top: 32px;">
                            <div class="diagram-container" style="position: relative;">
                                <div style="display: flex; gap: 8px; margin-bottom: 12px; padding: 8px; background: var(--color-neutral-background); border-radius: 6px;">
                                    <button onclick="openDrawioEditor('${blockId}')" style="padding: 6px 12px; border-radius: 4px; background: var(--color-primary-blue); color: white; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; font-family: var(--font-family-ui); font-size: 12px; transition: all 0.2s;">
                                        <i class="ph ph-pencil-simple" style="font-size: 14px;"></i>
                                        Edit Diagram
                                    </button>
                                    <button onclick="clearDiagram('${blockId}')" style="padding: 6px 12px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--color-neutral-text); font-family: var(--font-family-ui); font-size: 12px; transition: all 0.2s;">
                                        <i class="ph ph-trash" style="font-size: 14px;"></i>
                                        Clear
                                    </button>
                                </div>
                                <div class="diagram-preview" style="min-height: 300px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; display: flex; align-items: center; justify-content: center; padding: 20px;">
                                    <div style="text-align: center; color: var(--color-neutral-text-light);">
                                        <i class="ph ph-flow-arrow" style="font-size: 48px;"></i>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; margin: 12px 0 0 0;">No diagram yet. Click "Edit Diagram" to create one.</p>
                                    </div>
                                </div>
                                <input type="hidden" class="diagram-data" value="">
                            </div>
                        </div>
                    `;
                    break;
                case 'divider':
                    blockContent = `
                        <div style="margin-top: 16px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <select onchange="updateDividerType('${blockId}', this.value)" class="divider-type-select" style="padding: 6px 10px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 12px; font-family: var(--font-family-body); background: white; cursor: pointer;">
                                    <option value="visual">Visual Divider</option>
                                    <option value="page">Page Divider</option>
                                </select>
                                <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); flex: 1;">
                                    <span class="divider-description">Visual separator only</span>
                                </span>
                            </div>
                            <div class="divider-visual" style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; height: 2px; background: var(--color-neutral-border); border-radius: 1px;"></div>
                            </div>
                        </div>
                    `;
                    break;
                case 'mermaid':
                    blockContent = `
                        <div style="margin-top: 32px;">
                            <div class="mermaid-edit-area">
                                <textarea placeholder="graph TD&#10;    A[Start] --> B[Process]&#10;    B --> C[End]" style="width: 100%; min-height: 160px; border: none; font-family: monospace; font-size: 13px; color: var(--color-dark); background: #f0f9ff; outline: none; resize: vertical; padding: 12px; line-height: 1.5;">graph LR
    A[Client] --> B[Load Balancer]
    B --> C[Server 1]
    B --> D[Server 2]
    B --> E[Server 3]
    C --> F[Database]
    D --> F
    E --> F</textarea>
                                <div style="margin-top: 8px; padding: 8px; background: #e0f2fe; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);"><i class="ph ph-info" style="margin-right: 4px;"></i>Mermaid diagram syntax</div>
                            </div>
                            <div class="mermaid-preview-area" style="display: none;">
                                <div class="mermaid-render" style="padding: 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; min-height: 160px; display: flex; align-items: center; justify-content: center;"></div>
                            </div>
                        </div>
                    `;
                    break;
                case 'latex':
                    blockContent = `
                        <div style="margin-top: 32px;">
                            <div class="latex-edit-area">
                                <textarea placeholder="\\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}" style="width: 100%; min-height: 120px; border: none; font-family: monospace; font-size: 13px; color: var(--color-dark); background: #fef3c7; outline: none; resize: vertical; padding: 12px; line-height: 1.5;">\\begin{aligned}
E &= mc^2 \\\\
F &= ma \\\\
\\Delta x &= v_0t + \\frac{1}{2}at^2 \\\\
\\int_{a}^{b} f(x)dx &= F(b) - F(a)
\\end{aligned}</textarea>
                                <div style="margin-top: 8px; padding: 8px; background: #fde68a; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);"><i class="ph ph-info" style="margin-right: 4px;"></i>KaTeX mathematical notation</div>
                            </div>
                            <div class="latex-preview-area" style="display: none;">
                                <div class="latex-render" style="padding: 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; min-height: 120px; display: flex; align-items: center; justify-content: center; font-size: 18px;"></div>
                            </div>
                        </div>
                    `;
                    break;
                case 'toc':
                    blockContent = `
                        <div class="toc-container" style="margin-top: 32px; padding: 20px; background: var(--color-neutral-background); border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0;">
                                <i class="ph ph-list-numbers" style="margin-right: 8px; color: var(--color-primary-blue);"></i>
                                Table of Contents
                            </h3>
                            <div class="toc-content" style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.8; color: var(--color-neutral-text);">
                                <div style="padding: 20px; text-align: center; color: var(--color-neutral-text-light);">
                                    <i class="ph ph-file-dashed" style="font-size: 32px; margin-bottom: 8px;"></i>
                                    <p style="margin: 0; font-size: 13px;">Add headers to your document to generate the table of contents</p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }

            // Add control buttons and drag handle (except for divider)
            if (blockType !== 'divider') {
                block.setAttribute('draggable', 'true');

                // Add preview toggle button for markdown, mermaid, and latex blocks
                const previewButton = blockType === 'markdown'
                    ? `<button onclick="toggleMarkdownPreview('${blockId}')" title="Toggle preview" class="block-control-btn markdown-preview-btn" data-mode="edit" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-eye" style="font-size: 14px;"></i>
                        </button>`
                    : blockType === 'mermaid'
                    ? `<button onclick="toggleMermaidPreview('${blockId}')" title="Toggle preview" class="block-control-btn mermaid-preview-btn" data-mode="edit" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-eye" style="font-size: 14px;"></i>
                        </button>`
                    : blockType === 'latex'
                    ? `<button onclick="toggleLatexPreview('${blockId}')" title="Toggle preview" class="block-control-btn latex-preview-btn" data-mode="edit" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-eye" style="font-size: 14px;"></i>
                        </button>`
                    : '';

                block.innerHTML = `
                    <div class="drag-handle" title="Drag to reorder | Keyboard: Ctrl+Shift+↑/↓" style="position: absolute; top: 8px; left: 8px; width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: grab; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s; opacity: 0;">
                        <i class="ph ph-dots-six-vertical" style="font-size: 16px;"></i>
                    </div>
                    <div class="block-controls" style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                        ${previewButton}
                        <button onclick="shareBlock('${blockId}')" title="Share block" class="block-control-btn" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-share-network" style="font-size: 14px;"></i>
                        </button>
                        <button onclick="moveBlockUp('${blockId}')" title="Move up" class="block-control-btn" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-arrow-up" style="font-size: 14px;"></i>
                        </button>
                        <button onclick="moveBlockDown('${blockId}')" title="Move down" class="block-control-btn" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-arrow-down" style="font-size: 14px;"></i>
                        </button>
                        <button onclick="removeDocumentBlock('${blockId}')" title="Delete block" class="block-control-btn" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-x" style="font-size: 14px;"></i>
                        </button>
                    </div>
                    ${blockContent}
                `;
            } else {
                block.innerHTML = blockContent;
            }

            canvas.appendChild(block);

            // Initialize Quill editor for richtext blocks
            if (blockType === 'richtext') {
                const quillContainer = block.querySelector(`.quill-container-${blockId}`);
                if (quillContainer) {
                    new Quill(quillContainer, {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'align': [] }],
                                ['link', 'image'],
                                ['clean']
                            ]
                        },
                        placeholder: 'Enter rich text content...'
                    });
                }
            }

            // Setup drag and drop for non-divider blocks
            if (blockType !== 'divider') {
                setupBlockDragAndDrop(block);
                setupBlockKeyboardShortcuts(block);
            }

            // Update control button states
            updateBlockControlStates();

            // Refresh WBS numbers if enabled
            refreshWBS();

            // Update table of contents if present
            updateTableOfContents();
        }

        function removeDocumentBlock(blockId) {
            const block = document.getElementById(blockId);
            if (block && confirm('Remove this block?')) {
                block.remove();
                // Update control button states after removal
                updateBlockControlStates();
                // Refresh WBS numbers if enabled
                refreshWBS();
            }
        }

        function shareBlock(blockId) {
            // Nonfunctional placeholder for sharing individual blocks
            const block = document.getElementById(blockId);
            if (block) {
                const blockType = block.getAttribute('data-block-type');
                alert(`Sharing functionality coming soon!\n\nThis will allow you to share this ${blockType} block with others.`);
            }
        }

        function changeHeaderLevel(blockId, level) {
            const block = document.getElementById(blockId);
            const headerInput = block.querySelector('.header-input');

            if (headerInput) {
                // Update data attribute
                headerInput.setAttribute('data-level', level);

                // Font size mapping for different header levels
                const fontSizes = {
                    '1': '32px',  // H1
                    '2': '28px',  // H2
                    '3': '20px',  // H3
                    '4': '18px',  // H4
                    '5': '16px',  // H5
                    '6': '14px'   // H6
                };

                headerInput.style.fontSize = fontSizes[level];

                // Refresh WBS numbers if enabled
                refreshWBS();
            }
        }

        function updateDividerType(blockId, dividerType) {
            const block = document.getElementById(blockId);
            const visualDiv = block.querySelector('.divider-visual');
            const descriptionSpan = block.querySelector('.divider-description');

            // Store divider type as data attribute
            block.setAttribute('data-divider-type', dividerType);

            if (dividerType === 'page') {
                visualDiv.innerHTML = `
                    <div style="flex: 1; height: 3px; background: repeating-linear-gradient(45deg, var(--color-primary-blue), var(--color-primary-blue) 8px, transparent 8px, transparent 16px); border-radius: 1px;"></div>
                    <div style="background: var(--color-primary-blue); color: white; padding: 4px 8px; border-radius: 12px; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; text-transform: uppercase;">PAGE BREAK</div>
                    <div style="flex: 1; height: 3px; background: repeating-linear-gradient(45deg, var(--color-primary-blue), var(--color-primary-blue) 8px, transparent 8px, transparent 16px); border-radius: 1px;"></div>
                `;
                descriptionSpan.textContent = 'Creates a page break in exports';

                // Update the select dropdown
                const select = block.querySelector('.divider-type-select');
                if (select) select.value = 'page';
            } else {
                visualDiv.innerHTML = `
                    <div style="flex: 1; height: 2px; background: var(--color-neutral-border); border-radius: 1px;"></div>
                `;
                descriptionSpan.textContent = 'Visual separator only';

                // Update the select dropdown
                const select = block.querySelector('.divider-type-select');
                if (select) select.value = 'visual';
            }
        }

        // Block reordering functions
        function moveBlockUp(blockId) {
            const canvas = document.getElementById('documentCanvas');
            const block = document.getElementById(blockId);
            const previousBlock = block.previousElementSibling;

            if (previousBlock && previousBlock.classList.contains('document-block')) {
                canvas.insertBefore(block, previousBlock);

                // Smooth scroll to keep block visible
                block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Update button states
                updateBlockControlStates();

                // Refresh WBS numbers if enabled
                refreshWBS();
            }
        }

        function moveBlockDown(blockId) {
            const canvas = document.getElementById('documentCanvas');
            const block = document.getElementById(blockId);
            const nextBlock = block.nextElementSibling;

            if (nextBlock && nextBlock.classList.contains('document-block')) {
                canvas.insertBefore(nextBlock, block);

                // Smooth scroll to keep block visible
                block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Update button states
                updateBlockControlStates();

                // Refresh WBS numbers if enabled
                refreshWBS();
            }
        }

        function updateBlockControlStates() {
            const canvas = document.getElementById('documentCanvas');
            const blocks = canvas.querySelectorAll('.document-block');

            blocks.forEach((block, index) => {
                const controls = block.querySelector('.block-controls');
                if (!controls) return;

                const upBtn = controls.querySelector('[onclick*="moveBlockUp"]');
                const downBtn = controls.querySelector('[onclick*="moveBlockDown"]');

                // Disable up button on first block
                if (upBtn) {
                    upBtn.disabled = (index === 0);
                }

                // Disable down button on last block
                if (downBtn) {
                    downBtn.disabled = (index === blocks.length - 1);
                }
            });
        }

        // Drag and drop functionality
        let draggedBlock = null;

        function setupBlockDragAndDrop(block) {
            block.addEventListener('dragstart', handleDragStart);
            block.addEventListener('dragend', handleDragEnd);
            block.addEventListener('dragover', handleDragOver);
            block.addEventListener('drop', handleDrop);
            block.addEventListener('dragleave', handleDragLeave);
        }

        // Keyboard shortcuts functionality
        function setupBlockKeyboardShortcuts(block) {
            block.addEventListener('keydown', function(e) {
                // Only handle keyboard shortcuts when block is focused
                // and input/textarea elements are not focused
                const activeElement = document.activeElement;
                if (activeElement.tagName === 'INPUT' ||
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.classList.contains('ql-editor')) {
                    return;
                }

                // Ctrl+Shift+Up Arrow - Move block up
                if (e.ctrlKey && e.shiftKey && e.key === 'ArrowUp') {
                    e.preventDefault();
                    moveBlockUp(block.id);
                }

                // Ctrl+Shift+Down Arrow - Move block down
                if (e.ctrlKey && e.shiftKey && e.key === 'ArrowDown') {
                    e.preventDefault();
                    moveBlockDown(block.id);
                }

                // Ctrl+Shift+Home - Move to top
                if (e.ctrlKey && e.shiftKey && e.key === 'Home') {
                    e.preventDefault();
                    moveBlockToPosition(block.id, 0);
                }

                // Ctrl+Shift+End - Move to bottom
                if (e.ctrlKey && e.shiftKey && e.key === 'End') {
                    e.preventDefault();
                    const canvas = document.getElementById('documentCanvas');
                    const blocks = canvas.querySelectorAll('.document-block');
                    moveBlockToPosition(block.id, blocks.length - 1);
                }
            });
        }

        function moveBlockToPosition(blockId, targetIndex) {
            const canvas = document.getElementById('documentCanvas');
            const block = document.getElementById(blockId);
            const allBlocks = Array.from(canvas.querySelectorAll('.document-block'));

            if (targetIndex < 0 || targetIndex >= allBlocks.length) return;

            // Remove block from current position
            block.remove();

            // Insert at target position
            if (targetIndex === 0) {
                canvas.insertBefore(block, allBlocks[0]);
            } else if (targetIndex >= allBlocks.length - 1) {
                canvas.appendChild(block);
            } else {
                canvas.insertBefore(block, allBlocks[targetIndex]);
            }

            // Smooth scroll and focus
            block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            block.focus();

            // Update button states
            updateBlockControlStates();

            // Refresh WBS numbers if enabled
            refreshWBS();
        }

        // Markdown preview toggle
        function toggleMarkdownPreview(blockId) {
            const block = document.getElementById(blockId);
            const editor = block.querySelector('.markdown-editor');
            const input = editor.querySelector('.markdown-input');
            const preview = editor.querySelector('.markdown-preview');
            const toggleBtn = block.querySelector('.markdown-preview-btn');
            const icon = toggleBtn.querySelector('i');

            const currentMode = toggleBtn.getAttribute('data-mode');

            if (currentMode === 'edit') {
                // Switch to preview mode
                const markdownText = input.value;

                // Parse markdown using Marked.js
                if (typeof marked !== 'undefined') {
                    // Configure marked for better rendering
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        headerIds: false,
                        mangle: false
                    });

                    preview.innerHTML = marked.parse(markdownText);
                } else {
                    preview.innerHTML = '<p style="color: red;">Markdown parser not loaded</p>';
                }

                input.style.display = 'none';
                preview.style.display = 'block';
                toggleBtn.setAttribute('data-mode', 'preview');
                toggleBtn.setAttribute('title', 'Back to edit');
                icon.className = 'ph ph-pencil-simple';
            } else {
                // Switch back to edit mode
                input.style.display = 'block';
                preview.style.display = 'none';
                toggleBtn.setAttribute('data-mode', 'edit');
                toggleBtn.setAttribute('title', 'Toggle preview');
                icon.className = 'ph ph-eye';
            }
        }

        // Toggle Mermaid preview
        function toggleMermaidPreview(blockId) {
            const block = document.getElementById(blockId);
            const editArea = block.querySelector('.mermaid-edit-area');
            const previewArea = block.querySelector('.mermaid-preview-area');
            const textarea = editArea.querySelector('textarea');
            const renderDiv = previewArea.querySelector('.mermaid-render');
            const toggleBtn = block.querySelector('.mermaid-preview-btn');
            const icon = toggleBtn.querySelector('i');

            const currentMode = toggleBtn.getAttribute('data-mode');

            if (currentMode === 'edit') {
                // Switch to preview mode
                const mermaidText = textarea.value;

                // Check if Mermaid is loaded
                if (typeof mermaid !== 'undefined') {
                    // Clear previous diagram
                    renderDiv.innerHTML = '';

                    // Generate unique ID for this diagram
                    const diagramId = 'mermaid-' + blockId + '-' + Date.now();

                    try {
                        // Render the mermaid diagram
                        mermaid.render(diagramId, mermaidText).then(result => {
                            renderDiv.innerHTML = result.svg;
                        }).catch(error => {
                            renderDiv.innerHTML = `<div style="color: red; font-family: var(--font-family-body); font-size: 13px; padding: 20px;">
                                <i class="ph ph-warning-circle" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                                <strong>Diagram Error:</strong><br>${error.message || 'Invalid Mermaid syntax'}
                            </div>`;
                        });
                    } catch (error) {
                        renderDiv.innerHTML = `<div style="color: red; font-family: var(--font-family-body); font-size: 13px; padding: 20px;">
                            <i class="ph ph-warning-circle" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                            <strong>Diagram Error:</strong><br>${error.message || 'Invalid Mermaid syntax'}
                        </div>`;
                    }
                } else {
                    renderDiv.innerHTML = '<p style="color: red; font-family: var(--font-family-body); font-size: 13px;">Mermaid library not loaded</p>';
                }

                editArea.style.display = 'none';
                previewArea.style.display = 'block';
                toggleBtn.setAttribute('data-mode', 'preview');
                toggleBtn.setAttribute('title', 'Back to edit');
                icon.className = 'ph ph-pencil-simple';
            } else {
                // Switch back to edit mode
                editArea.style.display = 'block';
                previewArea.style.display = 'none';
                toggleBtn.setAttribute('data-mode', 'edit');
                toggleBtn.setAttribute('title', 'Toggle preview');
                icon.className = 'ph ph-eye';
            }
        }

        // Toggle KaTeX preview
        function toggleLatexPreview(blockId) {
            const block = document.getElementById(blockId);
            const editArea = block.querySelector('.latex-edit-area');
            const previewArea = block.querySelector('.latex-preview-area');
            const textarea = editArea.querySelector('textarea');
            const renderDiv = previewArea.querySelector('.latex-render');
            const toggleBtn = block.querySelector('.latex-preview-btn');
            const icon = toggleBtn.querySelector('i');

            const currentMode = toggleBtn.getAttribute('data-mode');

            if (currentMode === 'edit') {
                // Switch to preview mode
                const latexText = textarea.value;

                // Check if KaTeX is loaded
                if (typeof katex !== 'undefined') {
                    try {
                        // Render the LaTeX using KaTeX
                        renderDiv.innerHTML = '';
                        katex.render(latexText, renderDiv, {
                            throwOnError: false,
                            displayMode: true,
                            output: 'html',
                            trust: false
                        });
                    } catch (error) {
                        renderDiv.innerHTML = `<div style="color: red; font-family: var(--font-family-body); font-size: 13px; padding: 20px;">
                            <i class="ph ph-warning-circle" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                            <strong>KaTeX Error:</strong><br>${error.message || 'Invalid KaTeX syntax'}
                        </div>`;
                    }
                } else {
                    renderDiv.innerHTML = '<p style="color: red; font-family: var(--font-family-body); font-size: 13px;">KaTeX library not loaded</p>';
                }

                editArea.style.display = 'none';
                previewArea.style.display = 'block';
                toggleBtn.setAttribute('data-mode', 'preview');
                toggleBtn.setAttribute('title', 'Back to edit');
                icon.className = 'ph ph-pencil-simple';
            } else {
                // Switch back to edit mode
                editArea.style.display = 'block';
                previewArea.style.display = 'none';
                toggleBtn.setAttribute('data-mode', 'edit');
                toggleBtn.setAttribute('title', 'Toggle preview');
                icon.className = 'ph ph-eye';
            }
        }

        // Draw.io diagram functions
        function openDrawioEditor(blockId) {
            const block = document.getElementById(blockId);
            const diagramData = block.querySelector('.diagram-data').value;

            // Create modal for draw.io editor
            const modal = document.createElement('div');
            modal.id = 'drawio-modal-' + blockId;
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const editorContainer = document.createElement('div');
            editorContainer.style.cssText = `
                width: 90%;
                height: 90%;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            `;

            // Header with save/cancel buttons
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 16px;
                background: var(--color-dark);
                color: white;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            header.innerHTML = `
                <h3 style="margin: 0; font-family: var(--font-family-ui); font-size: 16px;">Edit Diagram</h3>
                <div style="display: flex; gap: 8px;">
                    <button onclick="saveDrawioDiagram('${blockId}')" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-family: var(--font-family-ui); font-size: 13px;">
                        <i class="ph ph-check" style="margin-right: 4px;"></i>Save
                    </button>
                    <button onclick="closeDrawioEditor('${blockId}')" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: var(--font-family-ui); font-size: 13px;">
                        <i class="ph ph-x" style="margin-right: 4px;"></i>Cancel
                    </button>
                </div>
            `;

            // Draw.io iframe with embed mode
            const iframe = document.createElement('iframe');
            iframe.id = 'drawio-iframe-' + blockId;
            iframe.style.cssText = 'flex: 1; border: none;';

            // Use draw.io embed mode with simplified UI
            let drawioUrl = 'https://embed.diagrams.net/?embed=1&ui=min&spin=1&proto=json';

            // If we have existing diagram data, load it
            if (diagramData) {
                drawioUrl += '&xml=' + encodeURIComponent(diagramData);
            }

            iframe.src = drawioUrl;

            editorContainer.appendChild(header);
            editorContainer.appendChild(iframe);
            modal.appendChild(editorContainer);
            document.body.appendChild(modal);

            // Listen for messages from draw.io
            window.addEventListener('message', function drawioMessageHandler(evt) {
                if (evt.data.length > 0) {
                    try {
                        const msg = JSON.parse(evt.data);

                        // Handle different draw.io events
                        if (msg.event === 'init') {
                            // Draw.io is ready
                            iframe.contentWindow.postMessage(JSON.stringify({action: 'load', autosave: 1}), '*');
                        } else if (msg.event === 'export') {
                            // Diagram exported, store the data
                            const dataInput = block.querySelector('.diagram-data');
                            dataInput.value = msg.data;
                        }
                    } catch (e) {
                        // Ignore non-JSON messages
                    }
                }
            });
        }

        function saveDrawioDiagram(blockId) {
            const block = document.getElementById(blockId);
            const modal = document.getElementById('drawio-modal-' + blockId);
            const iframe = document.getElementById('drawio-iframe-' + blockId);

            // Request export from draw.io
            iframe.contentWindow.postMessage(JSON.stringify({
                action: 'export',
                format: 'xmlsvg',
                xml: true,
                spin: 'Saving diagram...'
            }), '*');

            // Wait a bit for the export, then close and update preview
            setTimeout(() => {
                const diagramData = block.querySelector('.diagram-data').value;

                if (diagramData) {
                    // Update preview with SVG
                    const preview = block.querySelector('.diagram-preview');

                    // Extract SVG from the XML data
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(diagramData, 'text/xml');
                    const svgElement = xmlDoc.querySelector('svg');

                    if (svgElement) {
                        preview.innerHTML = svgElement.outerHTML;
                        preview.querySelector('svg').style.maxWidth = '100%';
                        preview.querySelector('svg').style.height = 'auto';
                    } else {
                        preview.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text);">Diagram saved successfully.</p>';
                    }
                }

                closeDrawioEditor(blockId);
            }, 1000);
        }

        function closeDrawioEditor(blockId) {
            const modal = document.getElementById('drawio-modal-' + blockId);
            if (modal) {
                modal.remove();
            }
        }

        function clearDiagram(blockId) {
            if (confirm('Are you sure you want to clear this diagram?')) {
                const block = document.getElementById(blockId);
                const dataInput = block.querySelector('.diagram-data');
                const preview = block.querySelector('.diagram-preview');

                dataInput.value = '';
                preview.innerHTML = `
                    <div style="text-align: center; color: var(--color-neutral-text-light);">
                        <i class="ph ph-flow-arrow" style="font-size: 48px;"></i>
                        <p style="font-family: var(--font-family-body); font-size: 13px; margin: 12px 0 0 0;">No diagram yet. Click "Edit Diagram" to create one.</p>
                    </div>
                `;
            }
        }

        // WBS toggle function
        let wbsEnabled = false;

        function toggleWBS() {
            wbsEnabled = !wbsEnabled;
            const toggle = document.getElementById('wbs-toggle');
            const toggleSwitch = toggle.querySelector('div');

            if (wbsEnabled) {
                // Turn on WBS view
                toggle.style.background = 'var(--color-primary-blue)';
                toggleSwitch.style.left = '18px';

                // Update WBS numbers on all headers
                updateWBSNumbers();
            } else {
                // Turn off WBS view
                toggle.style.background = '#ccc';
                toggleSwitch.style.left = '2px';

                // Remove WBS numbers from all headers
                removeWBSNumbers();
            }
        }

        function updateWBSNumbers() {
            const canvas = document.getElementById('documentCanvas');
            const blocks = canvas.querySelectorAll('.document-block');

            // Track counters for each level
            const counters = [0, 0, 0, 0, 0, 0]; // Support up to 6 levels (h1-h6)

            blocks.forEach(block => {
                const blockType = block.getAttribute('data-block-type');

                if (blockType === 'header') {
                    const select = block.querySelector('select');
                    const input = block.querySelector('input[type="text"]');

                    if (select && input) {
                        const level = parseInt(select.value);

                        // Increment counter for this level
                        counters[level - 1]++;

                        // Reset all deeper level counters
                        for (let i = level; i < counters.length; i++) {
                            counters[i] = 0;
                        }

                        // Build WBS number string (e.g., "1.2.3")
                        let wbsNumber = '';
                        for (let i = 0; i < level; i++) {
                            if (counters[i] > 0) {
                                wbsNumber += (wbsNumber ? '.' : '') + counters[i];
                            }
                        }

                        // Add or update WBS number span
                        let wbsSpan = block.querySelector('.wbs-number');
                        if (!wbsSpan) {
                            wbsSpan = document.createElement('span');
                            wbsSpan.className = 'wbs-number';
                            wbsSpan.style.cssText = `
                                display: inline-block;
                                margin-right: 8px;
                                padding: 2px 8px;
                                background: var(--color-primary-blue);
                                color: white;
                                border-radius: 4px;
                                font-family: var(--font-family-ui);
                                font-size: 11px;
                                font-weight: 600;
                                flex-shrink: 0;
                            `;

                            // Insert before the input field in the container
                            const container = block.querySelector('.header-input-container');
                            if (container) {
                                container.insertBefore(wbsSpan, input);
                            }
                        }

                        wbsSpan.textContent = wbsNumber;
                    }
                }
            });
        }

        function removeWBSNumbers() {
            const canvas = document.getElementById('documentCanvas');
            const wbsNumbers = canvas.querySelectorAll('.wbs-number');

            wbsNumbers.forEach(span => {
                span.remove();
            });
        }

        // Update WBS numbers when blocks are added, moved, or removed
        function refreshWBS() {
            if (wbsEnabled) {
                updateWBSNumbers();
            }
            updateTableOfContents();
        }

        // Table of Contents generation
        function updateTableOfContents() {
            const canvas = document.getElementById('documentCanvas');
            const tocBlocks = canvas.querySelectorAll('[data-block-type="toc"]');

            // If no TOC blocks, exit early
            if (tocBlocks.length === 0) return;

            // Gather all headers from the document
            const headerBlocks = canvas.querySelectorAll('[data-block-type="header"]');
            const headers = [];

            headerBlocks.forEach(block => {
                const select = block.querySelector('select');
                const input = block.querySelector('input[type="text"]');
                const wbsSpan = block.querySelector('.wbs-number');

                if (select && input && input.value.trim()) {
                    const level = parseInt(select.value);
                    const text = input.value.trim();
                    const wbsNumber = wbsSpan ? wbsSpan.textContent : '';

                    headers.push({
                        level: level,
                        text: text,
                        wbsNumber: wbsNumber
                    });
                }
            });

            // Update all TOC blocks
            tocBlocks.forEach(tocBlock => {
                const tocContent = tocBlock.querySelector('.toc-content');

                if (headers.length === 0) {
                    // Show empty state
                    tocContent.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--color-neutral-text-light);">
                            <i class="ph ph-file-dashed" style="font-size: 32px; margin-bottom: 8px;"></i>
                            <p style="margin: 0; font-size: 13px;">Add headers to your document to generate the table of contents</p>
                        </div>
                    `;
                } else {
                    // Generate TOC entries
                    let tocHTML = '';
                    headers.forEach((header, index) => {
                        const indent = (header.level - 1) * 20;
                        const prefix = wbsEnabled && header.wbsNumber ? `${header.wbsNumber} ` : '';

                        tocHTML += `
                            <div style="margin-left: ${indent}px; margin-bottom: 8px; cursor: pointer; transition: color 0.2s;"
                                 onmouseover="this.style.color='var(--color-primary-blue)'"
                                 onmouseout="this.style.color='var(--color-neutral-text)'">
                                <span style="font-weight: ${header.level <= 2 ? '600' : '400'};">
                                    ${prefix}${header.text}
                                </span>
                            </div>
                        `;
                    });

                    tocContent.innerHTML = tocHTML;
                }
            });
        }

        // Table creation functions
        function createCleansheetTable(blockId) {
            alert('Create Cleansheet Table functionality coming soon!\n\nThis will allow you to build a new table from scratch with custom columns and rows.');
            // TODO: Implement table creation interface
        }

        function connectCleansheetTable(blockId) {
            alert('Connect Cleansheet Table functionality coming soon!\n\nThis will allow you to link to an existing Cleansheet table in your workspace.');
            // TODO: Implement table connection interface
        }

        function connectDataSource(blockId) {
            // Store the block ID for later use when connection is established
            window.currentTableBlockId = blockId;

            // Open the data source selection modal
            const modal = document.getElementById('dataSourceModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeDataSourceModal() {
            const modal = document.getElementById('dataSourceModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function toggleDataSourceCategory(category) {
            const content = document.getElementById(`${category}-content`);
            const caret = document.getElementById(`${category}-caret`);

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                caret.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                caret.style.transform = 'rotate(0deg)';
            }
        }

        function selectDataSource(category, source) {
            // Store selected source for configuration
            window.selectedDataSource = { category, source };

            // Close selection modal and open configuration modal
            closeDataSourceModal();
            openDataSourceConfig(category, source);
        }

        function openDataSourceConfig(category, source) {
            const modal = document.getElementById('dataSourceConfigModal');
            const titleEl = document.getElementById('dataSourceConfigTitle');
            const formEl = document.getElementById('dataSourceConfigForm');

            titleEl.textContent = `Configure ${source}`;

            // Generate form fields based on category and source
            formEl.innerHTML = getDataSourceConfigFields(category, source);

            modal.style.display = 'flex';
        }

        function closeDataSourceConfig() {
            const modal = document.getElementById('dataSourceConfigModal');
            modal.style.display = 'none';
        }

        function getDataSourceConfigFields(category, source) {
            let fields = '';

            // Common authentication section
            fields += '<div style="margin-bottom: 24px;">';
            fields += '<h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.5px;">Authentication</h3>';

            // Category-specific authentication fields
            if (category === 'CRM & ERP') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Authentication Method</label>
                        <select id="authMethod" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="oauth">OAuth 2.0</option>
                            <option value="apikey">API Key</option>
                            <option value="credentials">Username/Password</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Instance URL</label>
                        <input type="text" id="instanceUrl" placeholder="https://your-instance.salesforce.com" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Client ID</label>
                        <input type="text" id="clientId" placeholder="Enter client ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Client Secret</label>
                        <input type="password" id="clientSecret" placeholder="Enter client secret" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Data Services') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Authentication Method</label>
                        <select id="authMethod" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="serviceaccount">Service Account</option>
                            <option value="accesskey">Access Key</option>
                            <option value="connectionstring">Connection String</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Account/Project ID</label>
                        <input type="text" id="accountId" placeholder="Enter account or project ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Region</label>
                        <input type="text" id="region" placeholder="us-east-1, us-central1, etc." style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Access Key / Credentials</label>
                        <textarea id="credentials" placeholder="Paste credentials JSON or access key" style="width: 100%; min-height: 80px; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    </div>
                `;
            } else if (category === 'File Services') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Authentication Method</label>
                        <select id="authMethod" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="oauth">OAuth 2.0</option>
                            <option value="token">Access Token</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Access Token</label>
                        <input type="password" id="accessToken" placeholder="Enter access token" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Finance') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">API Key</label>
                        <input type="password" id="apiKey" placeholder="Enter API key" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Terminal ID / User ID</label>
                        <input type="text" id="terminalId" placeholder="Enter terminal or user ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Payments') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Environment</label>
                        <select id="environment" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="sandbox">Sandbox (Test)</option>
                            <option value="live">Live (Production)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">API Key</label>
                        <input type="password" id="apiKey" placeholder="Enter API key" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Secret Key</label>
                        <input type="password" id="secretKey" placeholder="Enter secret key" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Healthcare') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">FHIR Base URL</label>
                        <input type="text" id="fhirUrl" placeholder="https://fhir.example.com/api/FHIR/R4" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Client ID</label>
                        <input type="text" id="clientId" placeholder="Enter client ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Client Secret</label>
                        <input type="password" id="clientSecret" placeholder="Enter client secret" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Practice ID</label>
                        <input type="text" id="practiceId" placeholder="Enter practice ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Retail & Ecommerce') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Store URL</label>
                        <input type="text" id="storeUrl" placeholder="https://your-store.myshopify.com" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">API Key / Access Token</label>
                        <input type="password" id="apiKey" placeholder="Enter API key or access token" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">API Version</label>
                        <input type="text" id="apiVersion" placeholder="2024-01" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Insurance') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Environment URL</label>
                        <input type="text" id="environmentUrl" placeholder="https://api.example.com" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Tenant ID</label>
                        <input type="text" id="tenantId" placeholder="Enter tenant ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Username</label>
                        <input type="text" id="username" placeholder="Enter username" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Password</label>
                        <input type="password" id="password" placeholder="Enter password" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            }

            fields += '</div>'; // End authentication section

            // Query/Data Selection section
            fields += '<div style="margin-bottom: 24px;">';
            fields += '<h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.5px;">Data Selection</h3>';

            if (category === 'CRM & ERP') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Object/Entity Name</label>
                        <input type="text" id="objectName" placeholder="Account, Contact, Opportunity, etc." style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Fields to Import</label>
                        <input type="text" id="fields" placeholder="Id, Name, Email, Phone (comma-separated)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Filter Criteria (SOQL WHERE clause)</label>
                        <textarea id="filterCriteria" placeholder="CreatedDate > 2024-01-01" style="width: 100%; min-height: 60px; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    </div>
                `;
            } else if (category === 'Data Services') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Database/Schema</label>
                        <input type="text" id="database" placeholder="Enter database and schema name" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Query Type</label>
                        <select id="queryType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="table">Table/View</option>
                            <option value="sql">SQL Query</option>
                            <option value="file">File Path</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Table Name or SQL Query</label>
                        <textarea id="query" placeholder="SELECT * FROM table WHERE..." style="width: 100%; min-height: 80px; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    </div>
                `;
            } else if (category === 'File Services') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Folder Path</label>
                        <input type="text" id="folderPath" placeholder="/Documents/Data" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">File Name Pattern</label>
                        <input type="text" id="filePattern" placeholder="*.xlsx, sales_*.csv" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Search Recursively</label>
                        <input type="checkbox" id="recursive" style="margin-right: 8px;">
                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);">Include subfolders</span>
                    </div>
                `;
            } else if (category === 'Finance') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Security Identifiers</label>
                        <input type="text" id="securities" placeholder="AAPL, MSFT, GOOGL (comma-separated)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Data Fields</label>
                        <input type="text" id="dataFields" placeholder="PX_LAST, VOLUME, HIGH, LOW" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Frequency</label>
                        <select id="frequency" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                `;
            } else if (category === 'Payments') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Transaction Type</label>
                        <select id="transactionType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="all">All Transactions</option>
                            <option value="charges">Charges</option>
                            <option value="refunds">Refunds</option>
                            <option value="payouts">Payouts</option>
                            <option value="disputes">Disputes</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Status Filter</label>
                        <select id="statusFilter" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="all">All</option>
                            <option value="succeeded">Succeeded</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                `;
            } else if (category === 'Healthcare') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">FHIR Resource Type</label>
                        <select id="resourceType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="Patient">Patient</option>
                            <option value="Observation">Observation</option>
                            <option value="Encounter">Encounter</option>
                            <option value="Condition">Condition</option>
                            <option value="MedicationRequest">MedicationRequest</option>
                            <option value="DiagnosticReport">DiagnosticReport</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Patient ID (Optional)</label>
                        <input type="text" id="patientId" placeholder="Leave blank for all patients" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                `;
            } else if (category === 'Retail & Ecommerce') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Resource Type</label>
                        <select id="resourceType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="orders">Orders</option>
                            <option value="products">Products</option>
                            <option value="customers">Customers</option>
                            <option value="inventory">Inventory</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Status Filter</label>
                        <select id="statusFilter" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="all">All</option>
                            <option value="open">Open</option>
                            <option value="closed">Closed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                `;
            } else if (category === 'Insurance') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Query Type</label>
                        <select id="queryType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="policies">Policies</option>
                            <option value="claims">Claims</option>
                            <option value="quotes">Quotes</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Line of Business</label>
                        <select id="lineOfBusiness" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="all">All</option>
                            <option value="personal">Personal Auto</option>
                            <option value="commercial">Commercial Auto</option>
                            <option value="property">Property</option>
                            <option value="workers">Workers Comp</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                `;
            }

            fields += '</div>'; // End data selection section

            return fields;
        }

        function saveDataSourceConfig() {
            const config = {
                source: window.selectedDataSource,
                // Collect all form values - in real implementation, gather all field values
                timestamp: new Date().toISOString()
            };

            console.log('Data Source Configuration:', config);
            alert('Connection configured successfully!\n\nConfiguration has been saved. Data will be imported into your table.');

            closeDataSourceConfig();

            // TODO: Actually save configuration and initiate data import
        }

        function handleDragStart(e) {
            draggedBlock = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');

            // Remove drag-over class from all blocks
            const canvas = document.getElementById('documentCanvas');
            const blocks = canvas.querySelectorAll('.document-block');
            blocks.forEach(block => block.classList.remove('drag-over'));

            draggedBlock = null;
            updateBlockControlStates();
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            if (this !== draggedBlock) {
                this.classList.add('drag-over');
            }

            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedBlock !== this) {
                const canvas = document.getElementById('documentCanvas');
                const allBlocks = Array.from(canvas.querySelectorAll('.document-block'));
                const draggedIndex = allBlocks.indexOf(draggedBlock);
                const targetIndex = allBlocks.indexOf(this);

                if (draggedIndex < targetIndex) {
                    // Insert after target
                    canvas.insertBefore(draggedBlock, this.nextSibling);
                } else {
                    // Insert before target
                    canvas.insertBefore(draggedBlock, this);
                }

                // Smooth scroll to moved block
                draggedBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Update button states and WBS numbers
                updateBlockControlStates();
                refreshWBS();
            }

            this.classList.remove('drag-over');
            return false;
        }

        // Canvas UI Tour with Driver.js + Audio Integration
        class CanvasTour {
            constructor() {
                this.driver = null;
                this.isActive = false;
                this.currentStep = 0;
            }

            async initTour() {
                // Preload audio files
                console.log('Preloading tour audio files...');
                await audioTourManager.preloadAllAudio();

                // Configure Driver.js tour steps
                this.driver = new Driver({
                    showProgress: true,
                    allowClose: true,
                    overlayClickNext: false,
                    doneBtnText: 'Finish Tour',
                    nextBtnText: 'Next',
                    prevBtnText: 'Previous',
                    onHighlightStarted: (element) => {
                        // Enhanced step tracking with multiple identification methods
                        const stepId = this.getCurrentStepId(element);
                        if (stepId) {
                            console.log(`Highlighting element for step: ${stepId}`);
                            audioTourManager.playNarration(stepId);
                        }
                    },
                    onNext: (element) => {
                        // Track step progression
                        this.currentStep = Math.min(this.currentStep + 1, this.tourSteps.length - 1);
                        this.onStepChanged(this.currentStep);
                    },
                    onPrevious: (element) => {
                        // Track step regression
                        this.currentStep = Math.max(this.currentStep - 1, 0);
                        this.onStepChanged(this.currentStep);
                    },
                    onDeselected: () => {
                        // Clean up on tour end
                        audioTourManager.stopAudio();
                        this.isActive = false;
                        this.currentStep = 0;
                        console.log('Tour ended, audio stopped');
                    }
                });

                this.defineSteps();
            }

            defineSteps() {
                const steps = [
                    {
                        element: '.canvas-modal-header',
                        popover: {
                            title: 'Welcome to Cleansheet Canvas',
                            description: 'This is your personal workspace for managing job search, professional projects, and career development. Let\'s take a quick tour of the key features!',
                            position: 'bottom'
                        },
                        stepId: 'welcome'
                    },
                    {
                        element: '[data-view="seeker"]',
                        popover: {
                            title: 'View Mode Selector',
                            description: 'Switch between different workspace modes: Seeker (job search focus), Learner (skill development), and Professional (work management).',
                            position: 'bottom'
                        },
                        stepId: 'view-modes'
                    },
                    {
                        element: '#canvas-mindmap',
                        popover: {
                            title: 'Interactive Mindmap',
                            description: 'Navigate your workspace using this interactive mindmap. Click on any node to expand sections like Job Opportunities, Application Materials, and Skills & Competencies.',
                            position: 'right'
                        },
                        stepId: 'mindmap-navigation'
                    },
                    {
                        element: '.calendar-widget',
                        popover: {
                            title: 'Upcoming Events',
                            description: 'Track important dates like interviews, application deadlines, and networking events. Sync with your Outlook calendar for seamless integration.',
                            position: 'left'
                        },
                        stepId: 'calendar-widget'
                    },
                    {
                        element: '.ai-assistant-widget',
                        popover: {
                            title: 'AI Assistant',
                            description: 'Get personalized career advice, application tips, and skill development recommendations powered by AI insights.',
                            position: 'left'
                        },
                        stepId: 'ai-assistant'
                    },
                    {
                        element: '#jobSearchView',
                        popover: {
                            title: 'Job Search View',
                            description: 'Aggregate and filter job opportunities from multiple sources. Set up alerts, track applications, and manage your job search pipeline.',
                            position: 'center'
                        },
                        stepId: 'job-search-view'
                    },
                    {
                        element: '#projects-view',
                        popover: {
                            title: 'Professional Projects',
                            description: 'Organize documents, create forms, build reports, and manage workflows. Perfect for demonstrating your professional capabilities.',
                            position: 'center'
                        },
                        stepId: 'projects-view'
                    },
                    {
                        element: '.panel-collapse-toggle',
                        popover: {
                            title: 'Panel Controls',
                            description: 'Collapse or expand the side panel to focus on the mindmap or maximize your workspace area.',
                            position: 'left'
                        },
                        stepId: 'panel-controls'
                    }
                ];

                // Convert steps to Driver.js format
                const driverSteps = steps.map(step => ({
                    element: step.element,
                    popover: step.popover
                }));

                this.driver.defineSteps(driverSteps);
                this.tourSteps = steps;
            }

            getCurrentStepId(element) {
                if (!this.tourSteps || !element) return null;

                // Try multiple approaches to identify the current step
                let stepIndex = -1;

                // Method 1: Match by element selector
                for (let i = 0; i < this.tourSteps.length; i++) {
                    const stepElement = document.querySelector(this.tourSteps[i].element);
                    if (stepElement === element || stepElement?.contains(element)) {
                        stepIndex = i;
                        break;
                    }
                }

                // Method 2: Match by Driver.js step index if available
                if (stepIndex === -1 && this.driver.getCurrentStep) {
                    stepIndex = this.driver.getCurrentStep();
                }

                // Method 3: Use step counter as fallback
                if (stepIndex === -1) {
                    stepIndex = this.currentStep;
                }

                // Ensure valid index
                if (stepIndex >= 0 && stepIndex < this.tourSteps.length) {
                    return this.tourSteps[stepIndex].stepId;
                }

                return null;
            }

            // Enhanced step tracking
            onStepChanged(stepIndex) {
                this.currentStep = stepIndex;
                const stepId = this.tourSteps[stepIndex]?.stepId;

                if (stepId) {
                    console.log(`Tour step changed to: ${stepId} (${stepIndex + 1}/${this.tourSteps.length})`);
                    // Trigger audio playback
                    audioTourManager.playNarration(stepId);

                    // Update tour controls progress
                    if (tourControls.isVisible) {
                        tourControls.updateProgress();
                    }
                }
            }

            async startTour() {
                if (!this.driver) {
                    await this.initTour();
                }

                if (this.driver) {
                    this.isActive = true;
                    this.driver.start();
                    console.log('Canvas tour started');
                }
            }

            stopTour() {
                if (this.driver && this.isActive) {
                    audioTourManager.stopAudio();
                    this.driver.reset();
                    this.isActive = false;
                    this.currentStep = 0;
                    console.log('Canvas tour stopped');
                }
            }

            // Jump to specific step (useful for dynamic navigation)
            goToStep(stepIndex) {
                if (!this.driver || !this.isActive) return false;

                if (stepIndex >= 0 && stepIndex < this.tourSteps.length) {
                    this.currentStep = stepIndex;
                    // Driver.js doesn't have a direct goToStep method, but we can track manually
                    this.onStepChanged(stepIndex);
                    return true;
                }
                return false;
            }

            // Get current tour progress
            getProgress() {
                return {
                    currentStep: this.currentStep,
                    totalSteps: this.tourSteps?.length || 0,
                    stepId: this.tourSteps?.[this.currentStep]?.stepId || null,
                    isActive: this.isActive,
                    progressPercent: this.tourSteps ? Math.round((this.currentStep / (this.tourSteps.length - 1)) * 100) : 0
                };
            }

            // Validate tour step elements exist in DOM
            validateSteps() {
                if (!this.tourSteps) return { valid: false, errors: ['No steps defined'] };

                const errors = [];
                let validSteps = 0;

                this.tourSteps.forEach((step, index) => {
                    const element = document.querySelector(step.element);
                    if (!element) {
                        errors.push(`Step ${index + 1} (${step.stepId}): Element '${step.element}' not found`);
                    } else {
                        validSteps++;
                    }
                });

                return {
                    valid: errors.length === 0,
                    validSteps,
                    totalSteps: this.tourSteps.length,
                    errors
                };
            }
        }

        // Simple Guidance Tooltip System
        //
        // This system provides basic explanatory tooltips to guide users throughout the UI.
        // Example: "Opportunities you are pursuing appear here"
        //
        // Usage:
        // 1. Call addGuidanceTooltip(selector, text) to add tooltip to any element
        // 2. Tooltips automatically show on hover and hide on mouse leave
        // 3. Uses dark background with white text for clear visibility
        // 4. Positions automatically to stay within viewport bounds
        //
        // Pattern for expanding throughout the UI:
        // addGuidanceTooltip('#elementId', 'Helpful explanation text');
        // addGuidanceTooltip('.className', 'What this section does');
        //
        class GuidanceTooltip {
            constructor() {
                this.tooltip = null;
                this.createTooltip();
            }

            createTooltip() {
                this.tooltip = document.createElement('div');
                this.tooltip.id = 'guidance-tooltip';
                this.tooltip.style.cssText = `
                    position: absolute;
                    background: var(--color-dark);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-family: var(--font-family-body);
                    font-size: 12px;
                    line-height: 1.4;
                    max-width: 250px;
                    z-index: 10000;
                    pointer-events: none;
                    opacity: 0;
                    transform: translateY(-4px);
                    transition: opacity 0.2s ease, transform 0.2s ease;
                    display: none;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                `;

                document.body.appendChild(this.tooltip);
            }

            show(text, x, y) {
                console.log('Tooltip show() called with:', { text, x, y });
                console.log('Tooltip element exists:', !!this.tooltip);

                if (!this.tooltip || !text) {
                    console.warn('Tooltip show() early return - tooltip or text missing');
                    return;
                }

                this.tooltip.textContent = text;
                this.tooltip.style.display = 'block';
                console.log('Tooltip display set to block, content set');

                // Position tooltip
                const rect = this.tooltip.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                let tooltipX = x + 10;
                let tooltipY = y - 35;

                // Keep tooltip within viewport bounds
                if (tooltipX + rect.width > viewportWidth) {
                    tooltipX = x - rect.width - 10;
                }

                if (tooltipY < 0) {
                    tooltipY = y + 20;
                }

                this.tooltip.style.left = `${tooltipX}px`;
                this.tooltip.style.top = `${tooltipY}px`;
                console.log('Tooltip positioned at:', { tooltipX, tooltipY });

                // Animate in
                requestAnimationFrame(() => {
                    this.tooltip.style.opacity = '1';
                    this.tooltip.style.transform = 'translateY(0)';
                    console.log('Tooltip animation applied - should be visible now');
                });
            }

            hide() {
                if (!this.tooltip) return;

                this.tooltip.style.opacity = '0';
                this.tooltip.style.transform = 'translateY(-4px)';

                setTimeout(() => {
                    this.tooltip.style.display = 'none';
                }, 200);
            }
        }

        // Initialize simple guidance tooltip system
        const guidanceTooltip = new GuidanceTooltip();

        // Debug: Test tooltip functionality
        console.log('Guidance tooltip system initialized:', guidanceTooltip);

        // Helper function to add guidance tooltips to any element
        function addGuidanceTooltip(selector, text) {
            console.log('Adding guidance tooltip to:', selector, 'with text:', text);
            const element = document.querySelector(selector);

            if (!element) {
                console.warn('Element not found for selector:', selector);
                return;
            }

            console.log('Element found:', element);

            element.addEventListener('mouseenter', (event) => {
                console.log('Mouse entered element, showing tooltip:', text);
                guidanceTooltip.show(text, event.pageX, event.pageY);
            });

            element.addEventListener('mouseleave', () => {
                console.log('Mouse left element, hiding tooltip');
                guidanceTooltip.hide();
            });

            // Update cursor to indicate tooltip
            element.style.cursor = 'help';
            console.log('Tooltip event listeners added successfully');
        }

        // Example: Add tooltips to other UI elements (can be expanded throughout the app)
        function initializeUIGuidance() {
            // Test with a simple element first
            setTimeout(() => {
                console.log('Initializing UI Guidance...');

                // Simple test - add tooltip to canvas header title
                addGuidanceTooltip('.canvas-modal-header h2', 'This is your personal workspace for career management');

                // Add tooltips to view mode buttons
                addGuidanceTooltip('[data-view="seeker"]', 'Focus on job search and career advancement');
                addGuidanceTooltip('[data-view="learner"]', 'Access learning resources and skill development');
                addGuidanceTooltip('[data-view="professional"]', 'Manage work projects and professional tools');

                // Add tooltips to persona buttons
                addGuidanceTooltip('[data-persona="retail-manager"]', 'Sample profile: Retail manager transitioning to analytics');
                addGuidanceTooltip('[data-persona="chemist"]', 'Sample profile: Research chemist exploring new opportunities');
                addGuidanceTooltip('[data-persona="new-graduate"]', 'Sample profile: Recent graduate entering the job market');
                addGuidanceTooltip('[data-persona="data-analyst"]', 'Sample profile: Experienced data analyst');

                console.log('UI Guidance initialization completed');
            }, 1000);
        }

        // Initialize tour manager
        const canvasTour = new CanvasTour();

        // Tour Controls UI Component
        class TourControls {
            constructor() {
                this.controlsContainer = null;
                this.isVisible = false;
            }

            create() {
                if (this.controlsContainer) return;

                this.controlsContainer = document.createElement('div');
                this.controlsContainer.id = 'tourControls';
                this.controlsContainer.className = 'tour-controls';
                this.controlsContainer.innerHTML = `
                    <div class="tour-controls-header">
                        <div class="tour-progress">
                            <span class="tour-step-counter">Step 1 of 8</span>
                            <div class="tour-progress-bar">
                                <div class="tour-progress-fill"></div>
                            </div>
                        </div>
                        <button class="tour-minimize-btn" onclick="tourControls.toggle()">
                            <i class="ph ph-caret-down"></i>
                        </button>
                    </div>
                    <div class="tour-controls-body">
                        <div class="audio-controls">
                            <button id="audioPlayPause" class="audio-btn" onclick="tourControls.toggleAudio()">
                                <i class="ph ph-pause"></i>
                            </button>
                            <button id="audioStop" class="audio-btn" onclick="tourControls.stopAudio()">
                                <i class="ph ph-stop"></i>
                            </button>
                            <div class="volume-control">
                                <i class="ph ph-speaker-simple-high"></i>
                                <input type="range" id="volumeSlider" min="0" max="100" value="80"
                                       oninput="tourControls.setVolume(this.value)">
                            </div>
                        </div>
                        <div class="tour-navigation">
                            <button id="tourPrev" class="nav-btn" onclick="tourControls.previousStep()">
                                <i class="ph ph-caret-left"></i> Previous
                            </button>
                            <button id="tourNext" class="nav-btn" onclick="tourControls.nextStep()">
                                Next <i class="ph ph-caret-right"></i>
                            </button>
                            <button id="tourEnd" class="end-btn" onclick="tourControls.endTour()">
                                End Tour
                            </button>
                        </div>
                    </div>
                `;

                // Add styles
                const style = document.createElement('style');
                style.textContent = `
                    .tour-controls {
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                        border: 1px solid var(--color-neutral-border);
                        width: 320px;
                        z-index: 10100;
                        font-family: var(--font-family-ui);
                        transition: all 0.3s ease;
                    }

                    .tour-controls.minimized .tour-controls-body {
                        display: none;
                    }

                    .tour-controls.minimized .tour-minimize-btn i {
                        transform: rotate(180deg);
                    }

                    .tour-controls-header {
                        padding: 12px 16px;
                        border-bottom: 1px solid var(--color-neutral-border);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 12px;
                    }

                    .tour-progress {
                        flex: 1;
                    }

                    .tour-step-counter {
                        font-size: 11px;
                        font-weight: 600;
                        color: var(--color-neutral-text);
                        display: block;
                        margin-bottom: 4px;
                    }

                    .tour-progress-bar {
                        width: 100%;
                        height: 4px;
                        background: var(--color-neutral-border);
                        border-radius: 2px;
                        overflow: hidden;
                    }

                    .tour-progress-fill {
                        height: 100%;
                        background: var(--color-primary-blue);
                        transition: width 0.3s ease;
                        width: 12.5%;
                    }

                    .tour-minimize-btn {
                        background: none;
                        border: none;
                        color: var(--color-neutral-text);
                        cursor: pointer;
                        padding: 4px;
                        border-radius: 4px;
                        font-size: 16px;
                        transition: all 0.2s ease;
                    }

                    .tour-minimize-btn:hover {
                        background: var(--color-neutral-background);
                    }

                    .tour-controls-body {
                        padding: 16px;
                    }

                    .audio-controls {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 16px;
                        padding-bottom: 16px;
                        border-bottom: 1px solid var(--color-neutral-border);
                    }

                    .audio-btn {
                        width: 32px;
                        height: 32px;
                        border-radius: 6px;
                        border: 1px solid var(--color-neutral-border);
                        background: white;
                        color: var(--color-neutral-text);
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        transition: all 0.2s ease;
                    }

                    .audio-btn:hover {
                        border-color: var(--color-primary-blue);
                        color: var(--color-primary-blue);
                    }

                    .volume-control {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex: 1;
                    }

                    .volume-control i {
                        color: var(--color-neutral-text);
                        font-size: 16px;
                    }

                    #volumeSlider {
                        flex: 1;
                        height: 4px;
                        background: var(--color-neutral-border);
                        border-radius: 2px;
                        outline: none;
                        cursor: pointer;
                    }

                    .tour-navigation {
                        display: flex;
                        gap: 8px;
                    }

                    .nav-btn, .end-btn {
                        padding: 8px 12px;
                        border-radius: 6px;
                        border: 1px solid var(--color-neutral-border);
                        background: white;
                        color: var(--color-neutral-text);
                        font-family: var(--font-family-ui);
                        font-size: 12px;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                        transition: all 0.2s ease;
                    }

                    .nav-btn:hover {
                        border-color: var(--color-primary-blue);
                        color: var(--color-primary-blue);
                    }

                    .end-btn {
                        background: #dc2626;
                        border-color: #dc2626;
                        color: white;
                        margin-left: auto;
                    }

                    .end-btn:hover {
                        background: #b91c1c;
                        border-color: #b91c1c;
                    }
                `;

                document.head.appendChild(style);
                document.body.appendChild(this.controlsContainer);
            }

            show() {
                if (!this.controlsContainer) this.create();
                this.controlsContainer.style.display = 'block';
                this.isVisible = true;
                this.updateProgress();
            }

            hide() {
                if (this.controlsContainer) {
                    this.controlsContainer.style.display = 'none';
                    this.isVisible = false;
                }
            }

            toggle() {
                if (this.controlsContainer) {
                    this.controlsContainer.classList.toggle('minimized');
                }
            }

            updateProgress() {
                if (!this.controlsContainer) return;

                const progress = canvasTour.getProgress();
                const counter = this.controlsContainer.querySelector('.tour-step-counter');
                const progressFill = this.controlsContainer.querySelector('.tour-progress-fill');

                if (counter) {
                    counter.textContent = `Step ${progress.currentStep + 1} of ${progress.totalSteps}`;
                }

                if (progressFill) {
                    progressFill.style.width = `${progress.progressPercent}%`;
                }
            }

            toggleAudio() {
                const btn = document.getElementById('audioPlayPause');
                const icon = btn.querySelector('i');

                if (audioTourManager.isAudioPlaying()) {
                    audioTourManager.stopAudio();
                    icon.className = 'ph ph-play';
                } else {
                    const progress = canvasTour.getProgress();
                    if (progress.stepId) {
                        audioTourManager.playNarration(progress.stepId);
                        icon.className = 'ph ph-pause';
                    }
                }
            }

            stopAudio() {
                audioTourManager.stopAudio();
                const btn = document.getElementById('audioPlayPause');
                const icon = btn.querySelector('i');
                icon.className = 'ph ph-play';
            }

            setVolume(value) {
                const volume = value / 100;
                audioTourManager.setVolume(volume);
            }

            previousStep() {
                // Driver.js handles the actual navigation
                if (canvasTour.driver && canvasTour.isActive) {
                    canvasTour.driver.movePrevious();
                }
            }

            nextStep() {
                // Driver.js handles the actual navigation
                if (canvasTour.driver && canvasTour.isActive) {
                    canvasTour.driver.moveNext();
                }
            }

            endTour() {
                canvasTour.stopTour();
                this.hide();
            }
        }

        // Initialize tour controls
        const tourControls = new TourControls();

        // Global functions for manual tour control (available in browser console)
        window.startCanvasTour = function() {
            console.log('Manual tour start requested');
            canvasTour.startTour();
            tourControls.show();
        };

        window.addTourButtonManually = function() {
            console.log('Manual button addition requested');
            addTourButton();
        };

        window.debugTourState = function() {
            console.log('Tour Debug Info:');
            console.log('- Canvas Tour:', canvasTour);
            console.log('- Audio Manager:', audioTourManager);
            console.log('- Tour Controls:', tourControls);
            console.log('- Tour Button Exists:', !!document.getElementById('startTourBtn'));
            console.log('- Canvas Header Elements:', document.querySelectorAll('[class*="header"]'));

            const validation = canvasTour.validateSteps?.() || { valid: false, errors: ['Tour not initialized'] };
            console.log('- Step Validation:', validation);
        };

        // Global function for adding guidance tooltips anywhere in the UI
        window.addGuidanceTooltip = addGuidanceTooltip;

        // Debug function to test tooltip manually
        window.testTooltip = function(x = 200, y = 200) {
            console.log('Manual tooltip test starting...');
            guidanceTooltip.show('Test tooltip - this should be visible!', x, y);

            setTimeout(() => {
                console.log('Hiding test tooltip...');
                guidanceTooltip.hide();
            }, 3000);
        };

        // Debug function to show tooltip at current mouse position
        window.showTooltipAtMouse = function(event) {
            const x = event?.pageX || 300;
            const y = event?.pageY || 300;
            console.log('Showing tooltip at mouse position:', x, y);
            guidanceTooltip.show('Mouse position tooltip test', x, y);
        };

        // Add tour control button to canvas header
        function addTourButton() {
            console.log('Attempting to add tour button...');

            // Try multiple selectors to find the header
            const selectors = ['.canvas-modal-header-top', '.canvas-modal-header', '.canvas-header'];
            let canvasHeader = null;

            for (const selector of selectors) {
                canvasHeader = document.querySelector(selector);
                if (canvasHeader) {
                    console.log(`Found canvas header using selector: ${selector}`);
                    break;
                }
            }

            if (!canvasHeader) {
                console.error('Canvas header not found! Available elements:', document.querySelectorAll('[class*="header"]'));
                return;
            }

            if (document.getElementById('startTourBtn')) {
                console.log('Tour button already exists');
                return;
            }

            console.log('Creating tour button...');
            const tourButton = document.createElement('button');
            tourButton.id = 'startTourBtn';
            tourButton.className = 'tour-btn';
            tourButton.innerHTML = '<i class="ph ph-play"></i> Start Tour';
            tourButton.style.cssText = `
                padding: 8px 12px;
                background: var(--color-primary-blue);
                color: white;
                border: none;
                border-radius: 6px;
                font-family: var(--font-family-ui);
                font-size: 12px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 4px;
                cursor: pointer;
                margin-left: 12px;
                white-space: nowrap;
            `;

            tourButton.addEventListener('click', () => {
                console.log('Tour button clicked!');
                canvasTour.startTour();
                tourControls.show();
            });

            canvasHeader.appendChild(tourButton);
            console.log('Tour button added successfully!');
        }

        // Auto-open Canvas Tour on page load - simple version
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            openCanvasModal();

            // Add tour button after modal is open - try multiple times if needed
            setTimeout(() => {
                console.log('First attempt to add tour button...');
                addTourButton();

                // Initialize UI guidance tooltips
                initializeUIGuidance();

                // Fallback attempt if first one failed
                setTimeout(() => {
                    if (!document.getElementById('startTourBtn')) {
                        console.log('Second attempt to add tour button...');
                        addTourButton();
                    }
                }, 1000);
            }, 500);
        });
    </script>
</body>
</html>

