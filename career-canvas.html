<!DOCTYPE html>
<html lang="en">
<head>
<!-- Azure Application Insights - DISABLED (Invalid Configuration) -->
<!--
<script type="text/javascript">
!function(T,l,y){var S=T.location,k="script",D="instrumentationKey",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w="crossOrigin",N="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"5",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,u,p,l;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][b]()]=i[1])}if(!e[C]){var r=e.endpointsuffix,o=r?e.location:null;e[C]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[D]||d[D]||"",u=s[C],p=u?u+"/v2/track":d.endpointUrl,(l=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=p,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\"/g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),l.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,p)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:N,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(N,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(l,p))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(k);n.src=h;var e=y[w];return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(k)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[I]&&!0!==s[I]){var c="onerror";t(["_"+c]);var u=T[c];T[c]=function(e,t,n,a,i){var r=u&&u(e,t,n,a,i);return!0!==r&&m["_"+c]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);function a(){y.onInit&&y.onInit(n)}(T[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js",
crossOrigin: "anonymous",
cfg: {
connectionString: "InstrumentationKey=104926d6-679a-4baa-919e-665bea6facac;IngestionEndpoint=https://eastus-8.in.applicationinsights.azure.com/;LiveEndpoint=https://eastus.livediagnostics.monitor.azure.com/;ApplicationId=2e7de093-fa39-4859-a48b-515db3520828"
}
});
</script>
-->
<!-- TODO: Set up proper Application Insights configuration using doc/APPLICATION_INSIGHTS_SETUP.md -->

<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive career management workspace with guided paths, role discovery tools, and curated learning resources">
    <meta name="theme-color" content="#0066CC">
    <title>Cleansheet Career Canvas</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/high-resolution-logo-files/icon-192.png">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="assets/high-resolution-logo-files/icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/high-resolution-logo-files/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/high-resolution-logo-files/icon-180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="assets/high-resolution-logo-files/icon-167.png">

    <!-- Apple Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Career Canvas">

    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#0066CC">
    <meta name="msapplication-TileImage" content="assets/high-resolution-logo-files/original-on-transparent.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300&family=Questrial&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

    <!-- MSAL Authentication -->
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.0/lib/msal-browser.min.js"></script>

    <!-- Cleansheet Auth & Sync -->
    <script src="shared/cleansheet-auth-msal.js"></script>
    <script src="shared/cleansheet-sync.js"></script>
    <script src="shared/llm-providers.js"></script>
    <script src="shared/cleansheet-crypto.js"></script>

    <!-- Reveal.js for presentations -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/theme/white.css" id="revealTheme">
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/plugin/markdown/markdown.js"></script>

    <!-- Excalidraw will be embedded via iframe -->

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script src="shared/quill-document-editor.js"></script>

    <!-- Draw.io Diagram Editor -->
    <script src="shared/drawio-diagram-editor.js"></script>

    <!-- Monaco Editor (VS Code Editor) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

    <!-- Markdown parsing handled by built-in parser (no external dependency) -->

    <!-- Excalidraw via iframe embed -->

    <!-- Mermaid.js for Diagram Rendering -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });
        window.mermaid = mermaid;
    </script>

    <!-- Pako for PlantUML compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <!-- KaTeX for LaTeX Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>

    <!-- Monaco Editor is already loaded above and will be used for LaTeX editing -->

    <!-- Basic LaTeX to HTML converter (fallback implementation) -->
    <script>
        // Simple LaTeX to HTML converter for basic document rendering
        // Debug: Check if we can create the object at all
        console.log('About to create SimpleLatex object...');

        // Create minimal working version first
        window.SimpleLatex = {
            parse: function(latexContent) {
                return { content: latexContent };
            },

            render: function(doc) {
                let html = doc.content.trim();

                // Detect document type for CV-specific processing
                const isCV = html.includes('\\documentclass{altacv}') ||
                            html.includes('\\cvevent') ||
                            html.includes('\\cvskill') ||
                            (doc.type && doc.type === 'cv');

                // Color tracking for CV documents
                const colorTable = {};

                // CV-specific variables
                let columnContent = { left: '', right: '' };
                let currentColumn = 'left';
                let inTwoColumnMode = false;

                // Store math expressions and other special content
                const mathExpressions = [];
                let mathIndex = 0;

                // Variables for document structure tracking
                let geometryOptions = {};

                // Comments first (remove them completely)
                html = html.replace(/%.*$/gm, '');

                // Phase 3: Handle eqnarray environments BEFORE math extraction
                html = html.replace(/\\begin\{eqnarray\*\}([\s\S]*?)\\end\{eqnarray\*\}/g, function(match, content) {
                    console.log('Converting eqnarray* to align environment');
                    return `\\begin{align*}${content}\\end{align*}`;
                });
                html = html.replace(/\\begin\{eqnarray\}([\s\S]*?)\\end\{eqnarray\}/g, function(match, content) {
                    console.log('Converting eqnarray to align environment');
                    return `\\begin{align}${content}\\end{align}`;
                });

                // Handle \left[ \begin{array}...\end{array} \right] patterns
                html = html.replace(/\\left\[\s*(\\begin\{array\}[\s\S]*?\\end\{array\})\s*\\right\]/g, function(match, arrayContent) {
                    console.log('Processing left-right bracketed array');
                    return `\\begin{bmatrix}${arrayContent.replace(/\\begin\{array\}\{[^}]*\}/, '').replace(/\\end\{array\}/, '')}\\end{bmatrix}`;
                });

                // Remove preamble commands (log but don't output)
                html = html.replace(/\\documentclass(\[[^\]]*\])?\{([^}]+)\}/g, function(match, options, className) {
                    const optionsStr = options ? options.slice(1, -1) : '';
                    console.log('Document class detected:', className, 'Options:', optionsStr || '(none)');
                    return '';
                });
                html = html.replace(/\\headers\{([^}]*)\}\s*\{([^}]*)\}\s*\{([^}]*)\}/g, function(match, left, center, right) {
                    console.log('Headers detected - Left:', left.trim(), 'Center:', center.trim(), 'Right:', right.trim());
                    return '';
                });
                html = html.replace(/\\footers\{([^}]*)\}\s*\{([^}]*)\}\s*\{([^}]*)\}/g, function(match, left, center, right) {
                    console.log('Footers detected - Left:', left.trim(), 'Center:', center.trim(), 'Right:', right.trim());
                    return '';
                });
                html = html.replace(/\\underheadoverfoot/g, function(match) {
                    console.log('Page layout command detected:', match);
                    return '';
                });
                html = html.replace(/\\pagestyle\{([^}]+)\}/g, function(match, style) {
                    console.log('Page style detected:', style);
                    return '';
                });
                html = html.replace(/\\thispagestyle\{([^}]+)\}/g, function(match, style) {
                    console.log('This page style detected:', style);
                    return '';
                });
                html = html.replace(/\\geometry\{([^}]*)\}/g, function(match, settings) {
                    const settingPairs = settings.split(',').map(s => s.trim());
                    settingPairs.forEach(pair => {
                        const [key, value] = pair.split('=').map(s => s.trim());
                        if (key && value) {
                            geometryOptions[key] = value;
                        }
                    });
                    console.log('Geometry settings detected:', geometryOptions);
                    return '';
                });

                // CV-SPECIFIC PROCESSING
                if (isCV) {
                    // Process color definitions first
                    html = html.replace(/\\definecolor\{([^}]+)\}\{HTML\}\{([^}]+)\}/g, function(match, colorName, hexValue) {
                        colorTable[colorName] = `#${hexValue}`;
                        console.log('CV color defined:', colorName, '->', `#${hexValue}`);
                        return ''; // Remove from output
                    });

                    html = html.replace(/\\definecolor\{([^}]+)\}\{rgb\}\{([^}]+)\}/g, function(match, colorName, rgbValues) {
                        const [r, g, b] = rgbValues.split(',').map(v => Math.round(parseFloat(v.trim()) * 255));
                        colorTable[colorName] = `rgb(${r}, ${g}, ${b})`;
                        console.log('CV color defined:', colorName, '->', `rgb(${r}, ${g}, ${b})`);
                        return ''; // Remove from output
                    });

                    // Process colorlet commands
                    html = html.replace(/\\colorlet\{([^}]+)\}\{([^}]+)\}/g, function(match, newColor, baseColor) {
                        if (colorTable[baseColor]) {
                            colorTable[newColor] = colorTable[baseColor];
                            console.log('CV color let:', newColor, '->', colorTable[baseColor]);
                        }
                        return ''; // Remove from output
                    });

                    // Add hyperlink support (essential for CVs)
                    html = html.replace(/\\href\{([^}]+)\}\{([^}]+)\}/g, '<a href="$1" target="_blank" rel="noopener">$2</a>');

                    // Add email support
                    html = html.replace(/\\email\{([^}]+)\}/g, '<a href="mailto:$1">$1</a>');

                    // Add phone support
                    html = html.replace(/\\phone\{([^}]+)\}/g, '<span class="cv-phone">$1</span>');

                    // Add location support
                    html = html.replace(/\\location\{([^}]+)\}/g, '<span class="cv-location">$1</span>');

                    // Two-column layout processing (paracol package)
                    html = html.replace(/\\columnratio\{([^}]+)\}/g, function(match, ratio) {
                        const leftRatio = parseFloat(ratio) * 100;
                        const rightRatio = (1 - parseFloat(ratio)) * 100;
                        console.log('Column ratio set:', leftRatio + '%', rightRatio + '%');
                        return `<!-- COLUMN_RATIO:${leftRatio},${rightRatio} -->`;
                    });

                    // Begin paracol environment
                    html = html.replace(/\\begin\{paracol\}\{2\}/g, '<!-- BEGIN_PARACOL -->');
                    html = html.replace(/\\end\{paracol\}/g, '<!-- END_PARACOL -->');

                    // Column switching
                    html = html.replace(/\\switchcolumn/g, '<!-- SWITCH_COLUMN -->');

                    console.log('CV document detected, applying professional formatting');
                }

                // ACCENT PROCESSING EARLY - Before title/section extraction
                // Accent characters (common LaTeX accents)
                const accentTable = {
                    // Acute accents
                    "\\'a": 'á', "\\'e": 'é', "\\'i": 'í', "\\'o": 'ó', "\\'u": 'ú', "\\'y": 'ý',
                    "\\'A": 'Á', "\\'E": 'É', "\\'I": 'Í', "\\'O": 'Ó', "\\'U": 'Ú', "\\'Y": 'Ý',
                    // Grave accents
                    "\\`a": 'à', "\\`e": 'è', "\\`i": 'ì', "\\`o": 'ò', "\\`u": 'ù',
                    "\\`A": 'À', "\\`E": 'È', "\\`I": 'Ì', "\\`O": 'Ò', "\\`U": 'Ù',
                    // Circumflex
                    "\\^a": 'â', "\\^e": 'ê', "\\^i": 'î', "\\^o": 'ô', "\\^u": 'û',
                    "\\^A": 'Â', "\\^E": 'Ê', "\\^I": 'Î', "\\^O": 'Ô', "\\^U": 'Û',
                    // Umlaut/diaeresis
                    '\\"a': 'ä', '\\"e': 'ë', '\\"i': 'ï', '\\"o': 'ö', '\\"u': 'ü',
                    '\\"A': 'Ä', '\\"E': 'Ë', '\\"I': 'Ï', '\\"O': 'Ö', '\\"U': 'Ü',
                    // Tilde
                    "\\~a": 'ã', "\\~n": 'ñ', "\\~o": 'õ',
                    "\\~A": 'Ã', "\\~N": 'Ñ', "\\~O": 'Õ',
                    // Cedilla
                    "\\c{c}": 'ç', "\\c{C}": 'Ç'
                };

                // Apply accent replacements with multiple approaches
                // Acute accents (most common) - handle the specific Tur\'an case first
                html = html.replace(/Tur\\'an/g, 'Turán');  // Specific fix for user's case
                html = html.replace(/tur\\'an/g, 'turán');  // Lowercase version too

                // General acute accent patterns
                html = html.replace(/\\\'a/g, 'á');
                html = html.replace(/\\'a/g, 'á');  // Also try without double backslash
                html = html.replace(/\\\'e/g, 'é');
                html = html.replace(/\\'e/g, 'é');
                html = html.replace(/\\\'i/g, 'í');
                html = html.replace(/\\'i/g, 'í');
                html = html.replace(/\\\'o/g, 'ó');
                html = html.replace(/\\'o/g, 'ó');
                html = html.replace(/\\\'u/g, 'ú');
                html = html.replace(/\\'u/g, 'ú');
                html = html.replace(/\\\'A/g, 'Á');
                html = html.replace(/\\'A/g, 'Á');
                html = html.replace(/\\\'E/g, 'É');
                html = html.replace(/\\'E/g, 'É');
                html = html.replace(/\\\'I/g, 'Í');
                html = html.replace(/\\'I/g, 'Í');
                html = html.replace(/\\\'O/g, 'Ó');
                html = html.replace(/\\'O/g, 'Ó');
                html = html.replace(/\\\'U/g, 'Ú');
                html = html.replace(/\\'U/g, 'Ú');

                console.log('Applied direct accent processing - checking for Tur\\\'an or Tur\'an patterns');

                // Handle braced accent forms like \'{a}
                html = html.replace(/\\'\{([aeiouAEIOU])\}/g, function(match, letter) {
                    const accentMap = {'a':'á','e':'é','i':'í','o':'ó','u':'ú','A':'Á','E':'É','I':'Í','O':'Ó','U':'Ú'};
                    return accentMap[letter] || match;
                });

                // Apply other accent replacements from table (after direct replacements)
                for (const [latex, unicode] of Object.entries(accentTable)) {
                    if (!latex.includes("\\'")) { // Skip acute accents (already handled)
                        const escapedLatex = latex.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        html = html.replace(new RegExp(escapedLatex, 'g'), unicode);
                    }
                }

                console.log('Applied accent processing to LaTeX text');

                // Special LaTeX commands (also moved to early processing)
                html = html.replace(/\\LaTeX\{\}/g, 'L<sup style="font-size: 0.8em; margin-left: -0.36em; vertical-align: 0.15em;">A</sup>T<sub style="font-size: 0.7em; margin-left: -0.1667em; vertical-align: -0.5ex;">E</sub>X');
                html = html.replace(/\\LaTeX(?!\w)/g, 'L<sup style="font-size: 0.8em; margin-left: -0.36em; vertical-align: 0.15em;">A</sup>T<sub style="font-size: 0.7em; margin-left: -0.1667em; vertical-align: -0.5ex;">E</sub>X');
                html = html.replace(/\\TeX\{\}/g, 'T<sub style="font-size: 0.7em; margin-left: -0.1667em; vertical-align: -0.5ex;">E</sub>X');
                html = html.replace(/\\TeX(?!\w)/g, 'T<sub style="font-size: 0.7em; margin-left: -0.1667em; vertical-align: -0.5ex;">E</sub>X');

                // POSTPONE math extraction until after custom commands are processed

                // Remove document structure commands (already processed earlier)
                html = html.replace(/\\begin\{document\}/g, '');
                html = html.replace(/\\end\{document\}/g, '');

                // Parse custom commands and theorem definitions
                let customCommands = {};
                let customTheorems = {};
                let theoremStyle = 'plain';

                // Extract and store \newcommand definitions
                // Use a manual parsing approach to handle nested braces properly
                const extractNewcommands = (text) => {
                    const newcommandRegex = /\\newcommand\{\\([^}]+)\}(?:\[([0-9]+)\])?\{/g;
                    let match;
                    const replacements = [];

                    while ((match = newcommandRegex.exec(text)) !== null) {
                        const cmdName = match[1];
                        const argCount = match[2];
                        const startPos = match.index + match[0].length;

                        // Find matching closing brace
                        let braceCount = 1;
                        let i = startPos;
                        let definition = '';

                        while (i < text.length && braceCount > 0) {
                            if (text[i] === '{') {
                                braceCount++;
                            } else if (text[i] === '}') {
                                braceCount--;
                            }

                            if (braceCount > 0) {
                                definition += text[i];
                            }
                            i++;
                        }

                        if (braceCount === 0) {
                            customCommands[cmdName] = {
                                definition: definition,
                                argCount: argCount ? parseInt(argCount) : 0
                            };
                            console.log('LaTeX custom command defined:', cmdName, 'with definition:', definition, 'and', argCount || 0, 'arguments');

                            // Store for replacement
                            const fullMatch = text.substring(match.index, i);
                            replacements.push({ fullMatch, replacement: '' });
                        }
                    }

                    // Apply all replacements
                    let result = text;
                    for (const repl of replacements.reverse()) { // reverse to handle overlaps correctly
                        result = result.replace(repl.fullMatch, repl.replacement);
                    }

                    return result;
                };

                html = extractNewcommands(html);

                // Extract \theoremstyle settings
                html = html.replace(/\\theoremstyle\{([^}]+)\}/g, function(match, style) {
                    theoremStyle = style;
                    console.log('LaTeX theorem style set to:', style);
                    return '';
                });

                // Extract and store \newtheorem definitions
                html = html.replace(/\\newtheorem\*?\{([^}]+)\}\{([^}]+)\}(?:\[([^\]]+)\])?/g, function(match, envName, displayName, counter) {
                    customTheorems[envName] = {
                        displayName: displayName,
                        style: theoremStyle,
                        counter: counter || null,
                        starred: match.includes('\\newtheorem*')
                    };
                    console.log('LaTeX custom theorem defined:', envName, 'as', displayName, 'with style', theoremStyle);
                    return '';
                });

                // Apply custom commands throughout the document
                for (const [cmdName, cmdInfo] of Object.entries(customCommands)) {
                    if (cmdInfo.argCount === 0) {
                        // No arguments - simple replacement
                        const regex = new RegExp('\\\\' + cmdName + '(?![a-zA-Z])', 'g');
                        html = html.replace(regex, cmdInfo.definition);
                    } else if (cmdInfo.argCount === 1) {
                        // Single argument - handle nested braces properly
                        const regex = new RegExp('\\\\' + cmdName + '\\{([^{}]+)\\}', 'g');
                        html = html.replace(regex, function(match, arg1) {
                            return cmdInfo.definition.replace(/#1/g, arg1);
                        });
                    } else {
                        // Multiple arguments - basic support for up to 3 args
                        let pattern = '\\\\' + cmdName;
                        for (let i = 0; i < cmdInfo.argCount; i++) {
                            pattern += '\\{([^{}]+)\\}';
                        }
                        const regex = new RegExp(pattern, 'g');
                        html = html.replace(regex, function(match, ...args) {
                            let result = cmdInfo.definition;
                            for (let i = 0; i < Math.min(args.length - 2, cmdInfo.argCount); i++) {
                                result = result.replace(new RegExp('#' + (i + 1), 'g'), args[i]);
                            }
                            return result;
                        });
                    }
                }

                // NOW extract math expressions after custom commands have been processed
                console.log('Extracting math expressions after custom command processing...');

                // Store equation labels for reference processing
                const equationLabels = {};
                let equationNumber = 1;

                // Extract and store equation environments (before other math)
                html = html.replace(/\\begin\{equation\}([\s\S]*?)\\end\{equation\}/g, function(match, mathContent) {
                    const placeholder = `__MATH_DISPLAY_${mathIndex}__`;

                    // Check for label
                    let label = null;
                    let cleanMathContent = mathContent.trim();
                    const labelMatch = mathContent.match(/\\label\{([^}]+)\}/);
                    if (labelMatch) {
                        label = labelMatch[1];
                        equationLabels[label] = equationNumber;
                        cleanMathContent = cleanMathContent.replace(/\\label\{[^}]+\}/g, '');
                        console.log(`Found equation label: ${label} = equation (${equationNumber})`);
                    }

                    mathExpressions[mathIndex] = {
                        type: 'display',
                        content: cleanMathContent,
                        label: label,
                        number: equationNumber
                    };

                    console.log(`Extracted equation math ${mathIndex}: "${cleanMathContent}" -> placeholder: ${placeholder}`);
                    equationNumber++;
                    mathIndex++;
                    return placeholder;
                });

                // PHASE 2 FIX: Extract nested environments FIRST (inner to outer)

                // Extract align and align* environments as display math
                html = html.replace(/\\begin\{align\*?\}([\s\S]*?)\\end\{align\*?\}/g, function(match, mathContent) {
                    const placeholder = `__MATH_DISPLAY_${mathIndex}__`;
                    mathExpressions[mathIndex] = { type: 'display', content: mathContent.trim() };
                    console.log(`Extracted align math ${mathIndex}: "${mathContent.trim()}" -> placeholder: ${placeholder}`);
                    mathIndex++;
                    return placeholder;
                });

                // Extract other common math environments
                html = html.replace(/\\begin\{(gather|multline|split|aligned|alignat|flalign|xalignat|xxalignat)\*?\}([\s\S]*?)\\end\{\1\*?\}/g, function(match, envName, mathContent) {
                    const placeholder = `__MATH_DISPLAY_${mathIndex}__`;
                    mathExpressions[mathIndex] = { type: 'display', content: mathContent.trim() };
                    console.log(`Extracted ${envName} math ${mathIndex}: "${mathContent.trim()}" -> placeholder: ${placeholder}`);
                    mathIndex++;
                    return placeholder;
                });

                // Handle matrix environments specifically
                html = html.replace(/\\begin\{(matrix|pmatrix|bmatrix|vmatrix|Vmatrix|smallmatrix)\}([\s\S]*?)\\end\{\1\}/g, function(match, envName, mathContent) {
                    const placeholder = `__MATH_DISPLAY_${mathIndex}__`;
                    mathExpressions[mathIndex] = { type: 'display', content: `\\begin{${envName}}${mathContent}\\end{${envName}}` };
                    console.log(`Extracted ${envName} matrix ${mathIndex}: "${mathContent.trim()}" -> placeholder: ${placeholder}`);
                    mathIndex++;
                    return placeholder;
                });

                // Handle array environments (for custom column formatting)
                html = html.replace(/\\begin\{array\}\{([^}]+)\}([\s\S]*?)\\end\{array\}/g, function(match, columnSpec, mathContent) {
                    const placeholder = `__MATH_DISPLAY_${mathIndex}__`;
                    mathExpressions[mathIndex] = { type: 'display', content: `\\begin{array}{${columnSpec}}${mathContent}\\end{array}` };
                    console.log(`Extracted array ${mathIndex} (${columnSpec}): "${mathContent.trim()}" -> placeholder: ${placeholder}`);
                    mathIndex++;
                    return placeholder;
                });

                // NOW extract outer delimiters (after inner environments are processed)

                // Extract and store display math \[...\]
                html = html.replace(/\\\[([\s\S]*?)\\\]/g, function(match, mathContent) {
                    const placeholder = `__MATH_DISPLAY_${mathIndex}__`;
                    mathExpressions[mathIndex] = { type: 'display', content: mathContent.trim() };
                    console.log(`Extracted display math ${mathIndex}: "${mathContent.trim()}" -> placeholder: ${placeholder}`);
                    mathIndex++;
                    return placeholder;
                });

                // Extract and store display math $$...$$  (enhanced for nested environments)
                html = html.replace(/\$\$([\s\S]*?)\$\$/g, function(match, mathContent) {
                    const placeholder = `__MATH_DISPLAY_${mathIndex}__`;
                    mathExpressions[mathIndex] = { type: 'display', content: mathContent.trim() };
                    console.log(`Extracted $$ display math ${mathIndex}: "${mathContent.trim()}" -> placeholder: ${placeholder}`);
                    mathIndex++;
                    return placeholder;
                });

                // Extract and store inline math $...$
                html = html.replace(/\$([^$\n]+)\$/g, function(match, mathContent) {
                    const placeholder = `__MATH_INLINE_${mathIndex}__`;
                    mathExpressions[mathIndex] = { type: 'inline', content: mathContent.trim() };
                    console.log(`Extracted inline math ${mathIndex}: "${mathContent.trim()}" -> placeholder: ${placeholder}`);
                    mathIndex++;
                    return placeholder;
                });

                // Cross-reference system: Parse labels and build reference table
                let labelCounter = 1;
                let sectionCounter = 1;
                const referenceTable = {};

                // FIRST: Extract theorem/definition labels (must happen before section processing!)
                const theoremTypes = Object.keys(customTheorems).concat(['theorem', 'lemma', 'definition', 'proposition', 'corollary']);

                theoremTypes.forEach(theoremType => {
                    // Pattern 1: Handle immediate labels like \begin{theorem}\label{thm:tree-turan}
                    const immediateRegex = new RegExp(`\\\\begin\\{${theoremType}\\}\\\\label\\{([^}]+)\\}`, 'g');
                    html = html.replace(immediateRegex, function(match, labelName) {
                        referenceTable[labelName] = labelCounter.toString();
                        console.log('LaTeX theorem label pre-registered (immediate):', labelName, '->', labelCounter);
                        labelCounter++;
                        return match; // Keep the original match, just register the label
                    });

                    // Pattern 2: Handle spaced labels like \begin{theorem} \label{thm:tree-turan}
                    const spacedRegex = new RegExp(`\\\\begin\\{${theoremType}\\}\\s+\\\\label\\{([^}]+)\\}`, 'g');
                    html = html.replace(spacedRegex, function(match, labelName) {
                        if (!referenceTable[labelName]) { // Only register if not already registered
                            referenceTable[labelName] = labelCounter.toString();
                            console.log('LaTeX theorem label pre-registered (spaced):', labelName, '->', labelCounter);
                            labelCounter++;
                        }
                        return match; // Keep the original match, just register the label
                    });
                });

                // SECOND: Extract section labels and build reference table
                // Use pattern that handles nested braces in section titles (for \ref{} commands)
                html = html.replace(/\\section\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}(?:\s*\\label\{([^}]+)\})?/g, function(match, sectionTitle, labelName) {
                    if (labelName) {
                        referenceTable[labelName] = sectionCounter.toString();
                        console.log('LaTeX label registered:', labelName, '->', sectionCounter);
                    }

                    // Process references and non-breaking spaces within section title
                    let processedTitle = sectionTitle;

                    // Handle non-breaking spaces first
                    processedTitle = processedTitle.replace(/~/g, '&nbsp;');

                    // Handle references within section title
                    processedTitle = processedTitle.replace(/\\ref\{([^}]+)\}/g, function(refMatch, refLabel) {
                        const cleanRefLabel = refLabel.trim();
                        const refNumber = referenceTable[cleanRefLabel];
                        if (refNumber) {
                            console.log('Section title reference resolved:', cleanRefLabel, '->', refNumber);
                            return refNumber;
                        } else {
                            console.warn('Section title reference not found:', cleanRefLabel, 'Available:', Object.keys(referenceTable));
                            return `<span style="background: #ffcccc; padding: 2px 4px; border-radius: 3px;">[${cleanRefLabel}?]</span>`;
                        }
                    });

                    // Add white-space: nowrap to prevent awkward line breaks in section titles
                    const result = `<h2 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin: 2em 0 1em 0; white-space: nowrap;">${processedTitle}</h2>`;
                    sectionCounter++;
                    return result;
                });

                // Theorem labels are now pre-registered above before section processing

                // Process theorem labels during theorem environment replacement
                // Include both custom theorems AND standard theorem types
                const allTheoremTypes = {
                    ...customTheorems,
                    // Add standard theorem types if not already defined
                    theorem: customTheorems.theorem || {displayName: 'Theorem', style: 'plain'},
                    lemma: customTheorems.lemma || {displayName: 'Lemma', style: 'plain'},
                    corollary: customTheorems.corollary || {displayName: 'Corollary', style: 'plain'},
                    proposition: customTheorems.proposition || {displayName: 'Proposition', style: 'plain'},
                    definition: customTheorems.definition || {displayName: 'Definition', style: 'definition'},
                    remark: customTheorems.remark || {displayName: 'Remark', style: 'remark'},
                    example: customTheorems.example || {displayName: 'Example', style: 'definition'},
                    proof: customTheorems.proof || {displayName: 'Proof', style: 'plain'}
                };

                for (const [envName, theoremInfo] of Object.entries(allTheoremTypes)) {
                    const regex = new RegExp('\\\\begin\\{' + envName + '\\}([\\s\\S]*?)\\\\end\\{' + envName + '\\}', 'g');
                    html = html.replace(regex, function(match, content) {
                        let borderColor = '#0066CC';
                        let backgroundColor = '#f8f9fa';
                        let textStyle = 'strong';
                        let labelName = null;
                        let processedContent = content.trim();

                        // Extract label from content
                        processedContent = processedContent.replace(/\\label\{([^}]+)\}/g, function(labelMatch, label) {
                            labelName = label;
                            referenceTable[label] = labelCounter.toString();
                            console.log('LaTeX theorem label registered:', label, '->', labelCounter);
                            labelCounter++;
                            return '';
                        });

                        if (theoremInfo.style === 'definition') {
                            borderColor = '#16a34a';
                            textStyle = 'strong';
                        } else if (theoremInfo.style === 'remark') {
                            borderColor = '#f59e0b';
                            textStyle = 'em';
                        }

                        const displayName = theoremInfo.displayName;
                        const theoremNumber = labelName ? ` ${referenceTable[labelName]}` : '';

                        return `<div style="margin: 1em 0; padding: 1em; border-left: 4px solid ${borderColor}; background: ${backgroundColor};">` +
                               `<${textStyle}>${displayName}${theoremNumber}:</${textStyle}> ${processedContent}</div>`;
                    });
                }

                // (Duplicate theorem processing removed - using first theorem system only)

                // Process proof environments (BEFORE math extraction so math inside proofs works)
                html = html.replace(/\\begin\{proof\}([\s\S]*?)\\end\{proof\}/g, function(match, content) {
                    return '<div style="margin: 1em 0; padding: 1em; border: 1px dashed #666; background: #fafafa; font-style: italic;">' +
                           '<strong>Proof:</strong> ' + content.trim() +
                           ' <span style="float: right; font-style: normal;">∎</span></div>';
                });

                // Handle LaTeX tilde (non-breaking space) before processing references
                html = html.replace(/~/g, '&nbsp;');

                // Merge equation labels into reference table (just the number, formatting handled elsewhere)
                Object.keys(equationLabels).forEach(label => {
                    referenceTable[label] = equationLabels[label].toString();
                    console.log(`Merged equation label: ${label} -> ${equationLabels[label]}`);
                });

                // Debug: Show all registered labels
                console.log('LaTeX reference table:', referenceTable);

                // Replace all \ref{} commands with reference numbers (BEFORE section processing!)
                html = html.replace(/\\ref\{([^}]+)\}/g, function(match, labelName) {
                    const cleanLabel = labelName.trim();
                    const refNumber = referenceTable[cleanLabel];
                    if (refNumber) {
                        // Check if this is an equation reference (starts with 'eq:')
                        const isEquationRef = cleanLabel.startsWith('eq:');
                        const formattedRef = isEquationRef ? `(${refNumber})` : refNumber;
                        console.log('LaTeX reference resolved:', cleanLabel, '->', formattedRef);
                        return formattedRef;
                    } else {
                        console.warn('LaTeX reference not found:', cleanLabel, 'Available labels:', Object.keys(referenceTable));
                        return `<span style="background: #ffcccc; padding: 2px 4px; border-radius: 3px;">[${cleanLabel}?]</span>`; // Show missing reference with highlighting
                    }
                });

                // Title, author, date (extract and remove from flow)
                let title = '', author = '', date = '';
                html = html.replace(/\\title\{([^}]*)\}/g, function(match, content) {
                    title = content;
                    return '';
                });
                html = html.replace(/\\author\{([^}]*)\}/g, function(match, content) {
                    author = content;
                    return '';
                });
                html = html.replace(/\\date\{([^}]*)\}/g, function(match, content) {
                    date = content.replace(/\\today/g, new Date().toLocaleDateString());
                    return '';
                });
                html = html.replace(/\\maketitle/g, '');

                // Build title section
                let titleSection = '';
                if (title) titleSection += `<h1 class="doc-title">${title}</h1>`;
                if (author) titleSection += `<p class="doc-author">${author}</p>`;
                if (date) titleSection += `<p class="doc-date">${date}</p>`;

                // Sections and structure
                html = html.replace(/\\section\{([^}]*)\}/g, '\n<h2>$1</h2>\n');
                html = html.replace(/\\subsection\{([^}]*)\}/g, '\n<h3>$1</h3>\n');
                html = html.replace(/\\subsubsection\{([^}]*)\}/g, '\n<h4>$1</h4>\n');

                // CV-SPECIFIC COMMANDS
                if (isCV) {
                    // \cvsection - CV section headers with professional styling
                    html = html.replace(/\\cvsection\{([^}]*)\}/g, function(match, title) {
                        const sectionColor = colorTable['heading'] || '#2E2E2E';
                        return `\n<h2 style="color: ${sectionColor}; border-bottom: 2px solid ${colorTable['headingrule'] || '#E7D192'}; padding-bottom: 0.3em; margin-top: 1.5em; margin-bottom: 0.8em; font-weight: bold;">${title}</h2>\n`;
                    });

                    // \cvevent{job title}{company}{date}{location}
                    html = html.replace(/\\cvevent\{([^}]*)\}\{([^}]*)\}\{([^}]*)\}\{([^}]*)\}/g, function(match, title, company, date, location) {
                        const accentColor = colorTable['accent'] || '#8F0D0D';
                        const emphasisColor = colorTable['emphasis'] || '#2E2E2E';

                        return `<div style="margin-bottom: 1em; padding: 0.5em 0;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.3em;">
                                <div>
                                    <h3 style="color: ${accentColor}; margin: 0; font-size: 1.1em; font-weight: bold;">${title}</h3>
                                    <p style="color: ${emphasisColor}; margin: 0.2em 0; font-weight: 600;">${company}</p>
                                </div>
                                <div style="text-align: right; font-size: 0.9em; color: ${colorTable['body'] || '#666666'};">
                                    <div>${date}</div>
                                    ${location ? `<div>${location}</div>` : ''}
                                </div>
                            </div>
                        </div>`;
                    });

                    // \cvskill{skill}{level} - skill with rating
                    html = html.replace(/\\cvskill\{([^}]*)\}\{([^}]*)\}/g, function(match, skill, level) {
                        const skillLevel = parseFloat(level) || 0;
                        const maxLevel = 5;
                        const percentage = (skillLevel / maxLevel) * 100;
                        const accentColor = colorTable['accent'] || '#8F0D0D';

                        return `<div style="margin-bottom: 0.8em;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.2em;">
                                <span style="font-weight: 600;">${skill}</span>
                                <span style="font-size: 0.9em; color: ${colorTable['body'] || '#666666'};">${skillLevel}/${maxLevel}</span>
                            </div>
                            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: ${accentColor}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>`;
                    });

                    // \cvtag{skill} - skill tag
                    html = html.replace(/\\cvtag\{([^}]*)\}/g, function(match, tag) {
                        const accentColor = colorTable['accent'] || '#8F0D0D';
                        return `<span style="display: inline-block; background: ${accentColor}; color: white; padding: 0.2em 0.6em; margin: 0.1em 0.2em; border-radius: 12px; font-size: 0.85em; font-weight: 500;">${tag}</span>`;
                    });

                    // \cvachievement{icon}{title}{description}
                    html = html.replace(/\\cvachievement\{([^}]*)\}\{([^}]*)\}\{([^}]*)\}/g, function(match, icon, title, description) {
                        const accentColor = colorTable['accent'] || '#8F0D0D';
                        const iconText = icon.replace(/\\fa\w+/g, '★'); // Replace FontAwesome with unicode

                        return `<div style="display: flex; align-items: flex-start; margin-bottom: 1em; padding: 0.5em 0;">
                            <div style="color: ${accentColor}; font-size: 1.2em; margin-right: 0.8em; margin-top: 0.1em;">${iconText}</div>
                            <div>
                                <h4 style="color: ${accentColor}; margin: 0 0 0.3em 0; font-size: 1em;">${title}</h4>
                                <p style="margin: 0; color: ${colorTable['body'] || '#666666'}; line-height: 1.4;">${description}</p>
                            </div>
                        </div>`;
                    });

                    // \divider - visual separator
                    html = html.replace(/\\divider/g, '<hr style="border: none; border-top: 1px solid #e0e0e0; margin: 1em 0;">');

                    // Apply text colors if defined
                    if (colorTable['body']) {
                        html = html.replace(/\\textcolor\{body\}\{([^}]+)\}/g, `<span style="color: ${colorTable['body']}">$1</span>`);
                    }

                    // Apply accent colors
                    if (colorTable['accent']) {
                        html = html.replace(/\\textcolor\{accent\}\{([^}]+)\}/g, `<span style="color: ${colorTable['accent']}">$1</span>`);
                    }

                    console.log('CV commands processed with colors:', Object.keys(colorTable));
                }

                // Text formatting
                html = html.replace(/\\textbf\{([^}]*)\}/g, '<strong>$1</strong>');
                html = html.replace(/\\textit\{([^}]*)\}/g, '<em>$1</em>');
                html = html.replace(/\\emph\{([^}]*)\}/g, '<em>$1</em>');

                // (Accent processing moved to early pipeline - no longer needed here)

                // Tables (process before lists to avoid conflicts)
                html = html.replace(/\\begin\{table\}(?:\[[^\]]*\])?([\s\S]*?)\\end\{table\}/g, function(match, content) {
                    console.log('Processing table environment:', content);

                    // Extract caption
                    let caption = '';
                    content = content.replace(/\\caption\{([^}]*)\}/g, function(capMatch, capContent) {
                        caption = capContent;
                        return '';
                    });

                    // Process tabular environment within table
                    const tabularMatch = content.match(/\\begin\{tabular\}\{([^}]*)\}([\s\S]*?)\\end\{tabular\}/);
                    if (!tabularMatch) {
                        return `<div class="latex-table-error">Error: Table missing tabular environment</div>`;
                    }

                    const columnSpec = tabularMatch[1];
                    let tableContent = tabularMatch[2].trim();

                    // Count columns from column specification (c, l, r, |)
                    const columnCount = (columnSpec.match(/[clr]/g) || []).length;

                    // Remove \centering command
                    content = content.replace(/\\centering\s*/g, '');

                    // Split into rows by \\
                    const rows = tableContent.split('\\\\').map(row => row.trim()).filter(row => row.length > 0);

                    // Build HTML table
                    let htmlTable = '<table style="border-collapse: collapse; margin: 20px auto; border: 1px solid #ddd;">\n';

                    rows.forEach((row, rowIndex) => {
                        // Remove \hline commands
                        row = row.replace(/\\hline\s*/g, '');
                        if (!row.trim()) return;

                        // Split by & for columns
                        const cells = row.split('&').map(cell => cell.trim());

                        // First row is header if it looks like headers (no numbers)
                        const isHeader = rowIndex === 0 && cells.some(cell =>
                            cell.match(/^[A-Za-z\s]+[0-9]*$/) && !cell.match(/^[0-9\s]*$/)
                        );

                        const cellTag = isHeader ? 'th' : 'td';
                        const cellStyle = isHeader
                            ? 'padding: 8px 12px; border: 1px solid #ddd; background: #f5f5f7; font-weight: 600; text-align: center;'
                            : 'padding: 8px 12px; border: 1px solid #ddd; text-align: center;';

                        htmlTable += `  <tr>\n`;
                        cells.forEach(cell => {
                            htmlTable += `    <${cellTag} style="${cellStyle}">${cell}</${cellTag}>\n`;
                        });
                        htmlTable += `  </tr>\n`;
                    });

                    htmlTable += '</table>\n';

                    // Add caption if present
                    if (caption) {
                        htmlTable += `<div style="text-align: center; margin-top: 8px; font-style: italic; font-size: 14px; color: #666;">${caption}</div>\n`;
                    }

                    return htmlTable;
                });

                // Graphics support (graphicx package)
                html = html.replace(/\\includegraphics(\[[^\]]*\])?\{([^}]+)\}/g, function(match, options, imagePath) {
                    let imageStyle = 'max-width: 100%; height: auto; display: block; margin: 1em auto;';

                    // Parse options if present
                    if (options) {
                        const optionString = options.slice(1, -1); // Remove square brackets
                        const optionPairs = optionString.split(',').map(s => s.trim());

                        optionPairs.forEach(pair => {
                            const [key, value] = pair.split('=').map(s => s.trim());
                            if (key && value) {
                                switch(key) {
                                    case 'width':
                                        imageStyle = imageStyle.replace('max-width: 100%;', `width: ${value};`);
                                        break;
                                    case 'height':
                                        imageStyle = imageStyle.replace('height: auto;', `height: ${value};`);
                                        break;
                                    case 'scale':
                                        const scale = parseFloat(value);
                                        imageStyle += ` transform: scale(${scale});`;
                                        break;
                                }
                            }
                        });
                    }

                    return `<img src="${imagePath}" style="${imageStyle}" alt="Figure from LaTeX document">`;
                });

                // Figure environment
                html = html.replace(/\\begin\{figure\}(\[[^\]]*\])?([\s\S]*?)\\end\{figure\}/g, function(match, position, content) {
                    let figureContent = content.trim();
                    let caption = '';

                    // Extract caption
                    figureContent = figureContent.replace(/\\caption\{([^}]*)\}/g, function(captionMatch, captionText) {
                        caption = captionText;
                        return '';
                    });

                    // Process centering
                    figureContent = figureContent.replace(/\\centering\s*/g, '');

                    let figureHTML = '<div style="margin: 2em auto; text-align: center;">';
                    figureHTML += figureContent;

                    if (caption) {
                        figureHTML += `<div style="margin-top: 1em; font-style: italic; font-size: 14px; color: #666;">Figure: ${caption}</div>`;
                    }

                    figureHTML += '</div>';
                    return figureHTML;
                });

                // Center environment
                html = html.replace(/\\begin\{center\}/g, '\n<div style="text-align: center;">\n');
                html = html.replace(/\\end\{center\}/g, '\n</div>\n');

                // Verbatim environment (preserve exact formatting)
                html = html.replace(/\\begin\{verbatim\}([\s\S]*?)\\end\{verbatim\}/g, function(match, content) {
                    // Escape HTML in verbatim content
                    const escapedContent = content
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    return `<pre style="background: #f5f5f5; padding: 12px; border-radius: 4px; font-family: monospace; font-size: 0.9em; overflow-x: auto; border: 1px solid #ddd;">${escapedContent}</pre>`;
                });

                // Section commands (with asterisk support)
                html = html.replace(/\\section\*\{([^}]+)\}/g, '<h2 style="margin-top: 2em; margin-bottom: 1em; font-weight: bold;">$1</h2>');
                html = html.replace(/\\section\{([^}]+)\}/g, '<h2 style="margin-top: 2em; margin-bottom: 1em; font-weight: bold;">$1</h2>');
                html = html.replace(/\\subsection\*\{([^}]+)\}/g, '<h3 style="margin-top: 1.5em; margin-bottom: 0.8em; font-weight: bold;">$1</h3>');
                html = html.replace(/\\subsection\{([^}]+)\}/g, '<h3 style="margin-top: 1.5em; margin-bottom: 0.8em; font-weight: bold;">$1</h3>');

                // Spacing commands
                html = html.replace(/\\smallskip/g, '<div style="margin: 0.5em 0;"></div>');
                html = html.replace(/\\medskip/g, '<div style="margin: 1em 0;"></div>');
                html = html.replace(/\\bigskip/g, '<div style="margin: 1.5em 0;"></div>');
                html = html.replace(/\\noindent/g, '<span style="text-indent: 0;">');

                // Lists
                html = html.replace(/\\begin\{itemize\}/g, '\n<ul>\n');
                html = html.replace(/\\end\{itemize\}/g, '\n</ul>\n');
                html = html.replace(/\\begin\{enumerate\}/g, '\n<ol>\n');
                html = html.replace(/\\end\{enumerate\}/g, '\n</ol>\n');
                html = html.replace(/\\item\s*/g, '<li>');

                // Array environments (matrices)
                html = html.replace(/\\left\[\s*\\begin\{array\}\{([^}]+)\}([\s\S]*?)\\end\{array\}\s*\\right\]/g, function(match, columnSpec, content) {
                    // Convert LaTeX array to HTML table
                    const rows = content.trim().split('\\\\');
                    let tableHTML = '<table style="display: inline-block; border-collapse: collapse; margin: 0.5em;">';

                    rows.forEach(row => {
                        if (row.trim()) {
                            const cells = row.split('&').map(cell => cell.trim());
                            tableHTML += '<tr>';
                            cells.forEach(cell => {
                                tableHTML += `<td style="padding: 4px 8px; text-align: center; border: 1px solid #ddd;">${cell}</td>`;
                            });
                            tableHTML += '</tr>';
                        }
                    });

                    tableHTML += '</table>';
                    return `<div style="text-align: center; margin: 1em 0;">[${tableHTML}]</div>`;
                });

                // Eqnarray processing moved to Phase 3 (before math extraction)

                // Process LaTeX grouping with formatting commands
                console.log('Processing LaTeX grouping and closing spans...');

                // Fix unclosed spans from size/format commands by processing entire groups
                html = html.replace(/\{([^{}]*\\(?:Large|large|bf|small|footnotesize|textbf|textit|emph)[^{}]*)\}/g, function(match, content) {
                    console.log('Processing group:', content);

                    // Apply commands within the group
                    let processedContent = content;

                    // Size commands
                    processedContent = processedContent.replace(/\\Large\s*/g, '<span style="font-size: 1.4em;">');
                    processedContent = processedContent.replace(/\\large\s*/g, '<span style="font-size: 1.2em;">');
                    processedContent = processedContent.replace(/\\small\s*/g, '<span style="font-size: 0.9em;">');
                    processedContent = processedContent.replace(/\\footnotesize\s*/g, '<span style="font-size: 0.8em;">');

                    // Bold/italic commands
                    processedContent = processedContent.replace(/\\bf\s*/g, '<strong>');
                    processedContent = processedContent.replace(/\\textbf\s*/g, '<strong>');
                    processedContent = processedContent.replace(/\\textit\s*/g, '<em>');
                    processedContent = processedContent.replace(/\\emph\s*/g, '<em>');

                    // Count opening tags to close them properly
                    const spanCount = (processedContent.match(/<span[^>]*>/g) || []).length;
                    const strongCount = (processedContent.match(/<strong>/g) || []).length;
                    const emCount = (processedContent.match(/<em>/g) || []).length;

                    // Add closing tags
                    let closingTags = '';
                    for (let i = 0; i < emCount; i++) closingTags += '</em>';
                    for (let i = 0; i < strongCount; i++) closingTags += '</strong>';
                    for (let i = 0; i < spanCount; i++) closingTags += '</span>';

                    return processedContent + closingTags;
                });

                // Clean up extra whitespace
                html = html.replace(/\n\s*\n\s*\n/g, '\n\n');

                // Convert paragraph breaks
                const paragraphs = html.split(/\n\s*\n/);
                const processedParagraphs = paragraphs.map(p => {
                    p = p.trim();
                    if (!p) return '';

                    // Don't wrap headings or lists in paragraphs
                    if (p.match(/^<h[1-6]|^<ul>|^<ol>|^<\/ul>|^<\/ol>|^<li>/)) {
                        return p;
                    }

                    // Don't wrap if it's already wrapped
                    if (p.startsWith('<p>')) return p;

                    return `<p>${p}</p>`;
                }).filter(p => p);

                html = processedParagraphs.join('\n\n');

                // Debug: show all math expressions found
                // Process preamble commands (before document body processing)
                console.log('Processing preamble commands...');

                // Remove preamble commands that don't affect HTML output
                html = html.replace(/\\headers\{[^}]*\}\s*\{[^}]*\}\s*\{[^}]*\}/g, '<!-- Headers removed -->');
                html = html.replace(/\\footers\{[^}]*\}\s*\{[^}]*\}\s*\{[^}]*\}/g, '<!-- Footers removed -->');
                html = html.replace(/\\underheadoverfoot/g, '<!-- Page layout command removed -->');

                // Process text formatting commands
                console.log('Processing text formatting commands...');

                // Font style and size commands that work within braces or until next command
                html = html.replace(/\{\\Large\\bf\s+([^}]+)\}/g, '<span style="font-size: 1.4em; font-weight: bold;">$1</span>');
                html = html.replace(/\{\\Large\s+([^}]+)\}/g, '<span style="font-size: 1.4em;">$1</span>');
                html = html.replace(/\{\\bf\s+([^}]+)\}/g, '<strong>$1</strong>');

                // Individual commands with braces
                html = html.replace(/\\Large\{([^}]+)\}/g, '<span style="font-size: 1.4em;">$1</span>');
                html = html.replace(/\\large\{([^}]+)\}/g, '<span style="font-size: 1.2em;">$1</span>');
                html = html.replace(/\\small\{([^}]+)\}/g, '<span style="font-size: 0.9em;">$1</span>');
                html = html.replace(/\\footnotesize\{([^}]+)\}/g, '<span style="font-size: 0.8em;">$1</span>');

                // Standalone size commands (apply until next command or end of group)
                html = html.replace(/\\Large\s*/g, '<span style="font-size: 1.4em;">');
                html = html.replace(/\\large\s*/g, '<span style="font-size: 1.2em;">');
                html = html.replace(/\\small\s*/g, '<span style="font-size: 0.9em;">');
                html = html.replace(/\\footnotesize\s*/g, '<span style="font-size: 0.8em;">');

                // Font style commands (with proper closing)
                html = html.replace(/\\bf\s+([^\\{}]+)/g, '<strong>$1</strong>');
                html = html.replace(/\\textbf\{([^}]+)\}/g, '<strong>$1</strong>');
                html = html.replace(/\\textit\{([^}]+)\}/g, '<em>$1</em>');
                html = html.replace(/\\emph\{([^}]+)\}/g, '<em>$1</em>');
                html = html.replace(/\\texttt\{([^}]+)\}/g, '<code>$1</code>');
                html = html.replace(/\\tt\s+([^\\{}]+)/g, '<code>$1</code>');

                // LaTeX logo command
                html = html.replace(/\\LaTeX\\\//g, 'LaTeX');
                html = html.replace(/\\LaTeX\{?\}?/g, 'LaTeX');

                // Equation reference processing moved to unified reference system above

                console.log('Total math expressions found:', mathExpressions.length);
                mathExpressions.forEach((expr, i) => {
                    if (expr) console.log(`Math ${i}:`, expr.type, '|', expr.content);
                });

                // Debug: show placeholders in HTML before replacement
                const placeholderMatches = html.match(/__MATH_\w+_\d+__/g);
                console.log('Placeholders in HTML:', placeholderMatches);

                // Restore math expressions with KaTeX
                for (let i = 0; i < mathExpressions.length; i++) {
                    const placeholder = `__MATH_${mathExpressions[i].type.toUpperCase()}_${i}__`;
                    if (mathExpressions[i]) {
                        console.log(`Processing math ${i}: "${placeholder}" -> "${mathExpressions[i].content}"`);

                        // Check if placeholder exists in HTML
                        if (!html.includes(placeholder)) {
                            console.warn(`Placeholder ${placeholder} not found in HTML!`);
                            continue;
                        }

                        if (window.katex) {
                            try {
                                // Pre-process math content for KaTeX compatibility
                                let mathContent = mathExpressions[i].content;

                                // KaTeX already handles most math functions and Greek letters correctly
                                // Just ensure proper spacing and formatting
                                console.log(`Rendering with KaTeX: "${mathContent}"`);

                                const rendered = katex.renderToString(mathContent, {
                                    displayMode: mathExpressions[i].type === 'display',
                                    throwOnError: false
                                });

                                // For numbered equations (with labels), add equation number
                                let finalRendered = rendered;
                                if (mathExpressions[i].type === 'display' && mathExpressions[i].number !== undefined) {
                                    finalRendered = `<div style="display: flex; justify-content: center; align-items: center; margin: 1em 0;">
                                        <div style="flex: 1; text-align: center;">${rendered}</div>
                                        <div style="width: 40px; text-align: right; font-size: 0.9em;">(${mathExpressions[i].number})</div>
                                    </div>`;
                                }

                                const beforeLength = html.length;
                                html = html.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), finalRendered);
                                const afterLength = html.length;
                                console.log(`KaTeX rendered math ${i}: ${beforeLength} -> ${afterLength} chars`);
                            } catch (e) {
                                console.warn('KaTeX render error for', mathExpressions[i].content, ':', e);
                                // Use enhanced fallback instead of raw content
                                const mathContent = SimpleLatex.formatMathFallback(mathExpressions[i].content);
                                const mathClass = mathExpressions[i].type === 'display' ? 'math-display' : 'math-inline';
                                const replacement = `<span class="${mathClass}" style="font-style: italic; color: #333;">${mathContent}</span>`;
                                console.log(`KaTeX fallback - replacing ${placeholder} with:`, replacement);
                                html = html.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), replacement);
                                console.log('Used enhanced fallback for:', mathExpressions[i].content, '->', mathContent);
                            }
                        } else {
                            console.warn('KaTeX not available, using enhanced fallback for', mathExpressions[i].content);
                            // Create beautiful fallback math formatting
                            const mathContent = SimpleLatex.formatMathFallback(mathExpressions[i].content);
                            const mathClass = mathExpressions[i].type === 'display' ? 'math-display' : 'math-inline';
                            const style = mathExpressions[i].type === 'display'
                                ? 'display: block; text-align: center; margin: 1em 0; font-style: italic; font-size: 1.2em;'
                                : 'font-style: italic;';
                            const replacement = `<span class="${mathClass}" style="${style}">${mathContent}</span>`;
                            console.log(`Replacing placeholder ${placeholder} with:`, replacement);
                            html = html.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), replacement);
                        }
                    }
                }

                // Debug: check for any remaining placeholders
                const remainingPlaceholders = html.match(/__MATH_\w+_\d+__/g);
                if (remainingPlaceholders) {
                    console.warn('Unreplaced placeholders found:', remainingPlaceholders);
                }

                // Combine title and content
                const finalHtml = titleSection + html;

                // Apply geometry settings if present
                let geometryStyles = '';
                if (Object.keys(geometryOptions).length > 0) {
                    console.log('Applying geometry settings:', geometryOptions);

                    // Convert LaTeX measurements to CSS
                    const convertMeasurement = (measurement) => {
                        if (!measurement) return '';
                        // Convert common LaTeX units to CSS
                        return measurement
                            .replace(/(\d+(?:\.\d+)?)in/g, '$1in')
                            .replace(/(\d+(?:\.\d+)?)cm/g, '$1cm')
                            .replace(/(\d+(?:\.\d+)?)mm/g, '$1mm')
                            .replace(/(\d+(?:\.\d+)?)pt/g, '$1pt')
                            .replace(/(\d+(?:\.\d+)?)em/g, '$1em');
                    };

                    // Build CSS styles from geometry options
                    const styles = [];
                    if (geometryOptions.margin) {
                        const margin = convertMeasurement(geometryOptions.margin);
                        if (margin) styles.push(`margin: ${margin}`);
                    }
                    if (geometryOptions.top) {
                        const top = convertMeasurement(geometryOptions.top);
                        if (top) styles.push(`margin-top: ${top}`);
                    }
                    if (geometryOptions.bottom) {
                        const bottom = convertMeasurement(geometryOptions.bottom);
                        if (bottom) styles.push(`margin-bottom: ${bottom}`);
                    }
                    if (geometryOptions.left) {
                        const left = convertMeasurement(geometryOptions.left);
                        if (left) styles.push(`margin-left: ${left}`);
                    }
                    if (geometryOptions.right) {
                        const right = convertMeasurement(geometryOptions.right);
                        if (right) styles.push(`margin-right: ${right}`);
                    }

                    if (styles.length > 0) {
                        geometryStyles = ` style="${styles.join('; ')}"`;
                    }
                }

                return `<div class="latex-content"${geometryStyles}>${finalHtml}</div>`;
            },

            // Enhanced math fallback formatting
            formatMathFallback: function(mathContent) {
                console.log('formatMathFallback called with:', JSON.stringify(mathContent));
                let formatted = mathContent;

                // Trigonometric and mathematical functions (process before Greek letters)
                const mathFunctions = {
                    'sin': '<span style="font-style: normal;">sin</span>',
                    'cos': '<span style="font-style: normal;">cos</span>',
                    'tan': '<span style="font-style: normal;">tan</span>',
                    'sec': '<span style="font-style: normal;">sec</span>',
                    'csc': '<span style="font-style: normal;">csc</span>',
                    'cot': '<span style="font-style: normal;">cot</span>',
                    'arcsin': '<span style="font-style: normal;">arcsin</span>',
                    'arccos': '<span style="font-style: normal;">arccos</span>',
                    'arctan': '<span style="font-style: normal;">arctan</span>',
                    'sinh': '<span style="font-style: normal;">sinh</span>',
                    'cosh': '<span style="font-style: normal;">cosh</span>',
                    'tanh': '<span style="font-style: normal;">tanh</span>',
                    'log': '<span style="font-style: normal;">log</span>',
                    'ln': '<span style="font-style: normal;">ln</span>',
                    'exp': '<span style="font-style: normal;">exp</span>',
                    'max': '<span style="font-style: normal;">max</span>',
                    'min': '<span style="font-style: normal;">min</span>',
                    'sup': '<span style="font-style: normal;">sup</span>',
                    'inf': '<span style="font-style: normal;">inf</span>',
                    'lim': '<span style="font-style: normal;">lim</span>',
                    'det': '<span style="font-style: normal;">det</span>'
                };

                // Apply math functions with proper spacing and parentheses handling
                Object.keys(mathFunctions).forEach(func => {
                    const regex = new RegExp(`\\\\${func}(?![a-zA-Z])`, 'g');
                    formatted = formatted.replace(regex, mathFunctions[func]);
                });

                // Handle function calls with parentheses (special processing)
                formatted = formatted.replace(/\\sin\s*\(([^)]+)\)/g, '<span style="font-style: normal;">sin</span>($1)');
                formatted = formatted.replace(/\\cos\s*\(([^)]+)\)/g, '<span style="font-style: normal;">cos</span>($1)');
                formatted = formatted.replace(/\\tan\s*\(([^)]+)\)/g, '<span style="font-style: normal;">tan</span>($1)');

                // Handle special spacing after function names
                formatted = formatted.replace(/(<span style="font-style: normal;">[a-z]+<\/span>)\s+/g, '$1 ');

                // Greek letters
                const greekLetters = {
                    'alpha': 'α', 'beta': 'β', 'gamma': 'γ', 'delta': 'δ', 'epsilon': 'ε',
                    'zeta': 'ζ', 'eta': 'η', 'theta': 'θ', 'iota': 'ι', 'kappa': 'κ',
                    'lambda': 'λ', 'mu': 'μ', 'nu': 'ν', 'xi': 'ξ', 'omicron': 'ο',
                    'pi': 'π', 'rho': 'ρ', 'sigma': 'σ', 'tau': 'τ', 'upsilon': 'υ',
                    'phi': 'φ', 'chi': 'χ', 'psi': 'ψ', 'omega': 'ω',
                    'Gamma': 'Γ', 'Delta': 'Δ', 'Theta': 'Θ', 'Lambda': 'Λ', 'Xi': 'Ξ',
                    'Pi': 'Π', 'Sigma': 'Σ', 'Phi': 'Φ', 'Psi': 'Ψ', 'Omega': 'Ω',
                    // Variant Greek letters (mathematical forms)
                    'varepsilon': 'ϵ', 'vartheta': 'ϑ', 'varpi': 'ϖ',
                    'varrho': 'ϱ', 'varsigma': 'ς', 'varphi': 'ϕ'
                };

                // Replace Greek letters
                for (const [latex, unicode] of Object.entries(greekLetters)) {
                    formatted = formatted.replace(new RegExp('\\\\' + latex + '(?![a-zA-Z])', 'g'), unicode);
                }

                // Mathematical operators
                formatted = formatted.replace(/\\pm/g, '±');
                formatted = formatted.replace(/\\mp/g, '∓');
                formatted = formatted.replace(/\\times/g, '×');
                formatted = formatted.replace(/\\div/g, '÷');
                formatted = formatted.replace(/\\cdot/g, '·');
                formatted = formatted.replace(/\\leq/g, '≤');
                formatted = formatted.replace(/\\geq/g, '≥');
                formatted = formatted.replace(/\\neq/g, '≠');
                formatted = formatted.replace(/\\approx/g, '≈');
                formatted = formatted.replace(/\\equiv/g, '≡');
                formatted = formatted.replace(/\\infty/g, '∞');
                formatted = formatted.replace(/\\partial/g, '∂');
                formatted = formatted.replace(/\\nabla/g, '∇');
                formatted = formatted.replace(/\\sum/g, '∑');
                formatted = formatted.replace(/\\prod/g, '∏');
                formatted = formatted.replace(/\\int/g, '∫');
                formatted = formatted.replace(/\\ell(?![a-zA-Z])/g, 'ℓ'); // Script lowercase L

                // Arrow symbols
                formatted = formatted.replace(/\\rightarrow/g, '→');
                formatted = formatted.replace(/\\to/g, '→');  // shorthand for rightarrow
                formatted = formatted.replace(/\\leftarrow/g, '←');
                formatted = formatted.replace(/\\uparrow/g, '↑');
                formatted = formatted.replace(/\\downarrow/g, '↓');
                formatted = formatted.replace(/\\leftrightarrow/g, '↔');
                formatted = formatted.replace(/\\updownarrow/g, '↕');
                formatted = formatted.replace(/\\Rightarrow/g, '⇒');
                formatted = formatted.replace(/\\Leftarrow/g, '⇐');
                formatted = formatted.replace(/\\Uparrow/g, '⇑');
                formatted = formatted.replace(/\\Downarrow/g, '⇓');
                formatted = formatted.replace(/\\Leftrightarrow/g, '⇔');
                formatted = formatted.replace(/\\Updownarrow/g, '⇕');

                // Spacing commands - convert to HTML spacing
                formatted = formatted.replace(/\\qquad/g, '&nbsp;&nbsp;&nbsp;&nbsp;'); // 2em ≈ 4 spaces
                formatted = formatted.replace(/\\quad/g, '&nbsp;&nbsp;'); // 1em ≈ 2 spaces
                formatted = formatted.replace(/\\enspace/g, '&nbsp;'); // 0.5em ≈ 1 space
                formatted = formatted.replace(/\\,/g, '&thinsp;'); // thin space
                formatted = formatted.replace(/\\:/g, '&nbsp;'); // medium space ≈ normal space
                formatted = formatted.replace(/\\;/g, '&nbsp;'); // thick space ≈ normal space
                formatted = formatted.replace(/\\!/g, ''); // negative space - just remove
                formatted = formatted.replace(/\\hspace\{[^}]+\}/g, '&nbsp;'); // custom space - use normal space

                // Additional mathematical symbols
                formatted = formatted.replace(/\\in/g, '∈');
                formatted = formatted.replace(/\\notin/g, '∉');
                formatted = formatted.replace(/\\subset/g, '⊂');
                formatted = formatted.replace(/\\supset/g, '⊃');
                formatted = formatted.replace(/\\subseteq/g, '⊆');
                formatted = formatted.replace(/\\supseteq/g, '⊇');
                formatted = formatted.replace(/\\cap/g, '∩');
                formatted = formatted.replace(/\\cup/g, '∪');
                formatted = formatted.replace(/\\emptyset/g, '∅');
                formatted = formatted.replace(/\\exists/g, '∃');
                formatted = formatted.replace(/\\forall/g, '∀');
                formatted = formatted.replace(/\\therefore/g, '∴');
                formatted = formatted.replace(/\\because/g, '∵');
                formatted = formatted.replace(/\\angle/g, '∠');
                formatted = formatted.replace(/\\perp/g, '⊥');
                formatted = formatted.replace(/\\parallel/g, '∥');

                // Dots and ellipses - process early to avoid conflicts
                formatted = formatted.replace(/\\cdots/g, '…'); // Use regular ellipsis instead of math center dots
                formatted = formatted.replace(/\\ldots/g, '…');
                formatted = formatted.replace(/\\vdots/g, '⋮');
                formatted = formatted.replace(/\\ddots/g, '⋱');
                // Alternative patterns in case of processing conflicts
                formatted = formatted.replace(/\\\.\.\./g, '…');  // fallback for dots

                // Superscripts (handle numbers and single characters)
                formatted = formatted.replace(/\^(\{([^}]+)\}|(\w))/g, function(match, group, braced, single) {
                    const content = braced || single;
                    return '<sup>' + content + '</sup>';
                });

                // Subscripts (handle numbers and single characters)
                formatted = formatted.replace(/_(\{([^}]+)\}|(\w))/g, function(match, group, braced, single) {
                    const content = braced || single;
                    return '<sub>' + content + '</sub>';
                });

                // Delimiter sizing commands - strip \left and \right, keep delimiters
                // Basic delimiters
                formatted = formatted.replace(/\\left\(/g, '(');
                formatted = formatted.replace(/\\right\)/g, ')');
                formatted = formatted.replace(/\\left\[/g, '[');
                formatted = formatted.replace(/\\right\]/g, ']');
                formatted = formatted.replace(/\\left\\{/g, '{');
                formatted = formatted.replace(/\\right\\}/g, '}');
                formatted = formatted.replace(/\\left\|/g, '|');
                formatted = formatted.replace(/\\right\|/g, '|');
                formatted = formatted.replace(/\\left\./g, ''); // invisible delimiter
                formatted = formatted.replace(/\\right\./g, ''); // invisible delimiter

                // Floor and ceiling delimiters
                formatted = formatted.replace(/\\left\\lfloor/g, '⌊');
                formatted = formatted.replace(/\\right\\rfloor/g, '⌋');
                formatted = formatted.replace(/\\left\\lceil/g, '⌈');
                formatted = formatted.replace(/\\right\\rceil/g, '⌉');

                // Angle brackets
                formatted = formatted.replace(/\\left\\langle/g, '⟨');
                formatted = formatted.replace(/\\right\\rangle/g, '⟩');

                // Additional edge cases
                formatted = formatted.replace(/\\left</g, '<');
                formatted = formatted.replace(/\\right>/g, '>');
                formatted = formatted.replace(/\\left\//g, '/');
                formatted = formatted.replace(/\\right\\/g, '\\');

                // Generic \left/\right removal (catch any remaining cases)
                // This removes \left and \right keywords while preserving any following delimiter
                formatted = formatted.replace(/\\left/g, '');
                formatted = formatted.replace(/\\right/g, '');

                // \Big family delimiter sizing commands - strip sizing, keep delimiters
                formatted = formatted.replace(/\\big\(/g, '(');
                formatted = formatted.replace(/\\Big\(/g, '(');
                formatted = formatted.replace(/\\bigg\(/g, '(');
                formatted = formatted.replace(/\\Bigg\(/g, '(');
                formatted = formatted.replace(/\\big\)/g, ')');
                formatted = formatted.replace(/\\Big\)/g, ')');
                formatted = formatted.replace(/\\bigg\)/g, ')');
                formatted = formatted.replace(/\\Bigg\)/g, ')');
                formatted = formatted.replace(/\\big\[/g, '[');
                formatted = formatted.replace(/\\Big\[/g, '[');
                formatted = formatted.replace(/\\bigg\[/g, '[');
                formatted = formatted.replace(/\\Bigg\[/g, '[');
                formatted = formatted.replace(/\\big\]/g, ']');
                formatted = formatted.replace(/\\Big\]/g, ']');
                formatted = formatted.replace(/\\bigg\]/g, ']');
                formatted = formatted.replace(/\\Bigg\]/g, ']');
                formatted = formatted.replace(/\\big\\{/g, '{');
                formatted = formatted.replace(/\\Big\\{/g, '{');
                formatted = formatted.replace(/\\bigg\\{/g, '{');
                formatted = formatted.replace(/\\Bigg\\{/g, '{');
                formatted = formatted.replace(/\\big\\}/g, '}');
                formatted = formatted.replace(/\\Big\\}/g, '}');
                formatted = formatted.replace(/\\bigg\\}/g, '}');
                formatted = formatted.replace(/\\Bigg\\}/g, '}');
                formatted = formatted.replace(/\\big\|/g, '|');
                formatted = formatted.replace(/\\Big\|/g, '|');
                formatted = formatted.replace(/\\bigg\|/g, '|');
                formatted = formatted.replace(/\\Bigg\|/g, '|');

                // Fractions (basic support)
                formatted = formatted.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g,
                    '<span style="display: inline-block; text-align: center; vertical-align: middle;">' +
                    '<span style="display: block; border-bottom: 1px solid; padding-bottom: 2px;">$1</span>' +
                    '<span style="display: block; padding-top: 2px;">$2</span>' +
                    '</span>');

                // Binomial coefficients - multiple patterns for robustness
                // Pattern 1: \binom with optional spaces - handles "\binom {n_i}{k}" cases
                formatted = formatted.replace(/\\binom\s*\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}\s*\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g,
                    '<span style="display: inline-block; vertical-align: middle; font-size: 1.2em;">' +
                    '(<span style="display: inline-block; text-align: center; vertical-align: middle;">' +
                    '<span style="display: block; line-height: 1;">$1</span>' +
                    '<span style="display: block; line-height: 1;">$2</span>' +
                    '</span>)' +
                    '</span>');

                // Pattern 2: Standard \binom{n}{k} with nested brace support (no spaces)
                formatted = formatted.replace(/\\binom\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g,
                    '<span style="display: inline-block; vertical-align: middle; font-size: 1.2em;">' +
                    '(<span style="display: inline-block; text-align: center; vertical-align: middle;">' +
                    '<span style="display: block; line-height: 1;">$1</span>' +
                    '<span style="display: block; line-height: 1;">$2</span>' +
                    '</span>)' +
                    '</span>');

                // Pattern 3: Simple \binom{single_char}{single_char} cases
                formatted = formatted.replace(/\\binom\{([^{}]+)\}\{([^{}]+)\}/g,
                    '<span style="display: inline-block; vertical-align: middle; font-size: 1.2em;">' +
                    '(<span style="display: inline-block; text-align: center; vertical-align: middle;">' +
                    '<span style="display: block; line-height: 1;">$1</span>' +
                    '<span style="display: block; line-height: 1;">$2</span>' +
                    '</span>)' +
                    '</span>');

                // Pattern 4: Fallback for any remaining \binom with minimal content
                formatted = formatted.replace(/\\binom\{([^}]*)\}\{([^}]*)\}/g,
                    '<span style="display: inline-block; vertical-align: middle; font-size: 1.2em;">' +
                    '(<span style="display: inline-block; text-align: center; vertical-align: middle;">' +
                    '<span style="display: block; line-height: 1;">$1</span>' +
                    '<span style="display: block; line-height: 1;">$2</span>' +
                    '</span>)' +
                    '</span>');

                // Variants: \dbinom and \tbinom with optional spaces
                formatted = formatted.replace(/\\[dt]binom\s*\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}\s*\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g,
                    '<span style="display: inline-block; vertical-align: middle; font-size: 1.2em;">' +
                    '(<span style="display: inline-block; text-align: center; vertical-align: middle;">' +
                    '<span style="display: block; line-height: 1;">$1</span>' +
                    '<span style="display: block; line-height: 1;">$2</span>' +
                    '</span>)' +
                    '</span>');

                // Choose notation (alternative binomial) - parse {n \choose k} syntax
                // Pattern 1: Handle nested braces - complex expressions like {⌊n/2^{h-1}⌋+1 \choose k}
                formatted = formatted.replace(/\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\s*\\choose\s*([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g, function(match, n, k) {
                    n = n.trim();
                    k = k.trim();
                    return '<span style="display: inline-block; vertical-align: middle; font-size: 1.2em;">' +
                           '(<span style="display: inline-block; text-align: center; vertical-align: middle;">' +
                           '<span style="display: block; line-height: 1;">' + n + '</span>' +
                           '<span style="display: block; line-height: 1;">' + k + '</span>' +
                           '</span>)' +
                           '</span>';
                });

                // Pattern 2: Simple choose notation fallback - handles basic cases
                formatted = formatted.replace(/\{([^{}]+)\s*\\choose\s*([^{}]+)\}/g, function(match, n, k) {
                    n = n.trim();
                    k = k.trim();
                    return '<span style="display: inline-block; vertical-align: middle; font-size: 1.2em;">' +
                           '(<span style="display: inline-block; text-align: center; vertical-align: middle;">' +
                           '<span style="display: block; line-height: 1;">' + n + '</span>' +
                           '<span style="display: block; line-height: 1;">' + k + '</span>' +
                           '</span>)' +
                           '</span>';
                });

                // Pattern 3: Minimal fallback for any remaining choose cases
                formatted = formatted.replace(/\{([^}]*)\s*\\choose\s*([^}]*)\}/g, function(match, n, k) {
                    n = n.trim();
                    k = k.trim();
                    return '<span style="display: inline-block; vertical-align: middle; font-size: 1.2em;">' +
                           '(<span style="display: inline-block; text-align: center; vertical-align: middle;">' +
                           '<span style="display: block; line-height: 1;">' + n + '</span>' +
                           '<span style="display: block; line-height: 1;">' + k + '</span>' +
                           '</span>)' +
                           '</span>';
                });

                // Square roots
                formatted = formatted.replace(/\\sqrt\{([^}]+)\}/g, '√($1)');
                formatted = formatted.replace(/\\sqrt/g, '√');

                // Floor and ceiling functions
                formatted = formatted.replace(/\\lfloor/g, '⌊');
                formatted = formatted.replace(/\\rfloor/g, '⌋');
                formatted = formatted.replace(/\\lceil/g, '⌈');
                formatted = formatted.replace(/\\rceil/g, '⌉');

                // Floor and ceiling convenience commands (from \newcommand definitions)
                formatted = formatted.replace(/\\floor\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g, '⌊$1⌋');
                formatted = formatted.replace(/\\ceil\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g, '⌈$1⌉');

                // Enhanced amsmath support
                // Note: align/align* environments are now extracted as display math in main loop

                formatted = formatted.replace(/\\begin\{equation\*?\}([\s\S]*?)\\end\{equation\*?\}/g, function(match, content) {
                    return '<div style="text-align: center; margin: 1em 0;">' + content.trim() + '</div>';
                });

                // Enhanced amsthm support
                formatted = formatted.replace(/\\begin\{theorem\}([\s\S]*?)\\end\{theorem\}/g, function(match, content) {
                    return '<div style="margin: 1em 0; padding: 1em; border-left: 4px solid #0066CC; background: #f8f9fa;">' +
                           '<strong>Theorem:</strong> ' + content.trim() + '</div>';
                });

                formatted = formatted.replace(/\\begin\{lemma\}([\s\S]*?)\\end\{lemma\}/g, function(match, content) {
                    return '<div style="margin: 1em 0; padding: 1em; border-left: 4px solid #16a34a; background: #f8f9fa;">' +
                           '<strong>Lemma:</strong> ' + content.trim() + '</div>';
                });

                // Note: proof environment processing moved to main parsing loop to handle math inside proofs

                // Enhanced amssymb support
                const amssymbSymbols = {
                    'mathbb\{R\}': 'ℝ', 'mathbb\{N\}': 'ℕ', 'mathbb\{Z\}': 'ℤ', 'mathbb\{Q\}': 'ℚ', 'mathbb\{C\}': 'ℂ',
                    'varnothing': '∅', 'backslash': '∖', 'complement': '∁',
                    'square': '□', 'blacksquare': '■', 'triangle': '△', 'blacktriangle': '▲',
                    'diamond': '◊', 'blackdiamond': '♦', 'star': '⋆', 'checkmark': '✓'
                };

                for (const [latex, unicode] of Object.entries(amssymbSymbols)) {
                    formatted = formatted.replace(new RegExp('\\\\' + latex.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), unicode);
                }

                // Additional LaTeX commands from document
                // \mathrm for upright text in math mode
                formatted = formatted.replace(/\\mathrm\{([^}]+)\}/g, '<span style="font-style: normal;">$1</span>');

                // \text for regular text in math mode (similar to \mathrm)
                formatted = formatted.replace(/\\text\{([^}]+)\}/g, '<span style="font-family: var(--font-family-body); font-style: normal;">$1</span>');

                // \substack for stacked subscripts (basic support)
                formatted = formatted.replace(/\\substack\{([^}]+)\}/g, function(match, content) {
                    const lines = content.split('\\\\').map(line => line.trim()).filter(line => line);
                    return '<span style="display: inline-block; vertical-align: middle; font-size: 0.8em; line-height: 1.1;">' +
                           lines.map(line => `<span style="display: block; text-align: center;">${line}</span>`).join('') +
                           '</span>';
                });

                // \nth ordinal suffix (handled by custom commands, but fallback)
                formatted = formatted.replace(/\\nth/g, '<sup>th</sup>');

                // Direct \N command (fallback if custom commands didn't process)
                formatted = formatted.replace(/\\N(?![a-zA-Z])/g, 'ℕ');

                // Mathematical operators and functions
                formatted = formatted.replace(/\\min(?![a-zA-Z])/g, 'min');
                formatted = formatted.replace(/\\max(?![a-zA-Z])/g, 'max');
                formatted = formatted.replace(/\\sin(?![a-zA-Z])/g, 'sin');
                formatted = formatted.replace(/\\cos(?![a-zA-Z])/g, 'cos');
                formatted = formatted.replace(/\\tan(?![a-zA-Z])/g, 'tan');
                formatted = formatted.replace(/\\log(?![a-zA-Z])/g, 'log');
                formatted = formatted.replace(/\\ln(?![a-zA-Z])/g, 'ln');
                formatted = formatted.replace(/\\exp(?![a-zA-Z])/g, 'exp');
                formatted = formatted.replace(/\\det(?![a-zA-Z])/g, 'det');
                formatted = formatted.replace(/\\lim(?![a-zA-Z])/g, 'lim');
                formatted = formatted.replace(/\\sup(?![a-zA-Z])/g, 'sup');
                formatted = formatted.replace(/\\inf(?![a-zA-Z])/g, 'inf');
                formatted = formatted.replace(/\\gcd(?![a-zA-Z])/g, 'gcd');
                formatted = formatted.replace(/\\lcm(?![a-zA-Z])/g, 'lcm');

                // Additional text styling
                formatted = formatted.replace(/\\textit\{([^}]+)\}/g, '<em>$1</em>');
                formatted = formatted.replace(/\\textbf\{([^}]+)\}/g, '<strong>$1</strong>');

                console.log('formatMathFallback returning:', JSON.stringify(formatted));
                return formatted;
            }
        };

        // Debug: Check if object was created successfully
        console.log('SimpleLatex object created successfully');

        // Make it available as LaTeX for compatibility
        window.LaTeX = window.SimpleLatex;
        console.log('Simple LaTeX renderer loaded successfully');
        console.log('window.SimpleLatex:', window.SimpleLatex);
        console.log('window.LaTeX:', window.LaTeX);

        // Backup KaTeX loading if the main CDN fails
        setTimeout(function() {
            if (!window.katex) {
                console.log('Main KaTeX CDN failed, trying backup...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js';
                script.onload = () => console.log('Backup KaTeX loaded successfully');
                script.onerror = () => console.log('Backup KaTeX also failed, using fallback rendering');
                document.head.appendChild(script);

                // Also try backup CSS
                const css = document.createElement('link');
                css.rel = 'stylesheet';
                css.href = 'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css';
                document.head.appendChild(css);
            }
        }, 2000); // Wait 2 seconds for main CDN
    </script>

    <!-- Driver.js for UI Tour -->

    <style>
        /* Cleansheet Design System - Corporate Professional */
        :root {
            /* Brand Colors */
            --color-primary-blue: #0066CC;
            --color-accent-blue: #004C99;
            --color-dark: #1a1a1a;

            /* Neutral Colors */
            --color-neutral-text: #333333;
            --color-neutral-text-light: #666666;
            --color-neutral-text-muted: #999999;
            --color-neutral-background: #f5f5f7;
            --color-neutral-background-secondary: #f8f8f8;
            --color-neutral-border: #e5e5e7;
            --color-neutral-white: #ffffff;

            /* Typography */
            --font-family-ui: 'Questrial', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-family-body: 'Barlow', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-size-h1: clamp(28px, 4vw, 32px);
            --font-size-h2: clamp(24px, 3.5vw, 36px);
            --font-size-h3: clamp(18px, 3vw, 24px);
            --font-size-body: clamp(14px, 2.5vw, 16px);
            --font-size-small: clamp(12px, 2.2vw, 14px);

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-xxl: 24px;
            --spacing-xxxl: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-body);
            font-weight: 300;
            background: var(--color-neutral-background);
            color: var(--color-neutral-text);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-family-ui);
        }

        /* Canvas Full Window */
        .canvas-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
        }

        .canvas-modal.active {
            display: flex;
        }

        .canvas-modal-content {
            background: var(--color-dark);
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .canvas-modal-header {
            padding: 16px 32px;
            background: var(--color-dark);
        }

.canvas-modal-header h2 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            color: white;
            margin: 0;
            white-space: nowrap;
        }

        /* Main Menu */
        .main-menu {
            display: flex;
            gap: 4px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            align-items: center;
            position: relative;
        }

        /* Mobile hamburger menu button */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            width: 44px;
            height: 44px;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            margin-left: auto;
            margin-right: 12px;
            z-index: 11002;
            position: relative;
        }

        .mobile-menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .mobile-menu-toggle:active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Mobile navigation dropdown */
        .main-menu-dropdown {
            display: flex; /* Always flex, but control visibility */
            flex-direction: column;
            gap: 4px;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--color-dark);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 11001;
            padding: 12px 0;
            opacity: 0;
            visibility: hidden; /* Use visibility instead of display: none */
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            pointer-events: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .main-menu-dropdown.active {
            opacity: 1;
            visibility: visible; /* Show the dropdown */
            transform: translateY(0);
            pointer-events: auto;
        }

        .main-menu-nav-items {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .main-menu-item {
            padding: 8px 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .main-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .main-menu-item.active {
            background: rgba(0, 102, 204, 0.3);
            color: white;
        }

        .main-menu-item i {
            font-size: 16px;
        }

        /* Profile Circle */
        .profile-circle {
            position: relative;
            display: inline-block;
        }

        .profile-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 102, 204, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: var(--font-family-ui);
            font-size: 16px;
            font-weight: 400;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            user-select: none;
        }

        .profile-avatar:hover {
            background: rgba(0, 102, 204, 0.4);
        }

        .profile-dropdown {
            position: absolute;
            top: 52px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
        }

        .profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown-header {
            padding: 16px;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .profile-dropdown-name {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
        }

        .profile-dropdown-role {
            font-family: var(--font-family-body);
            font-size: 12px;
            color: var(--color-neutral-text-light);
            margin: 0;
        }

        .profile-dropdown-menu {
            padding: 8px 0;
        }

        .profile-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            color: var(--color-neutral-text);
            cursor: pointer;
            transition: all 0.15s;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .profile-dropdown-item:hover {
            background: var(--color-neutral-background);
        }

        .profile-dropdown-item:focus {
            outline: 3px solid rgba(0, 102, 204, 0.5);
            outline-offset: -3px;
        }

        .profile-dropdown-item:active {
            background: rgba(0, 102, 204, 0.1);
        }

        .profile-dropdown-item i {
            font-size: 18px;
            color: var(--color-primary-blue);
        }

        /* About Dropdown */
        .about-dropdown {
            position: absolute;
            top: 52px;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
        }

        .about-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .about-dropdown-menu {
            padding: 8px 0;
        }

        .about-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            color: var(--color-neutral-text);
            cursor: pointer;
            transition: all 0.15s;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            text-decoration: none;
        }

        .about-dropdown-item:hover {
            background: var(--color-neutral-background);
        }

        .about-dropdown-item i {
            font-size: 18px;
            color: var(--color-primary-blue);
        }

        .about-dropdown-item .external-link-icon {
            margin-left: auto;
            font-size: 14px;
            color: var(--color-neutral-text-light);
        }

        .canvas-modal-body {
            flex: 1;
            padding: 24px;
            overflow: hidden;
            background: var(--color-neutral-background);
            display: grid;
            grid-template-columns: 30% 70%;
            gap: 24px;
            transition: grid-template-columns 0.3s ease;
            min-height: 0;
            position: relative;
        }

        .canvas-modal-body.left-collapsed {
            grid-template-columns: 0px 1fr;
            gap: 0;
        }

        #canvas-mindmap {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden; /* FIXED: Remove scrollbars */
            position: relative;
        }

        #canvas-mindmap svg {
            display: block;
            width: 100%;
            height: 100%;
            /* FIXED: Removed min-width/min-height to prevent overflow */
        }

        /* Left Panel */
        .left-panel {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .canvas-modal-body.left-collapsed .left-panel {
            opacity: 0;
            transform: translateX(-20px);
            pointer-events: none;
        }

        .left-panel-header {
            padding: 20px;
            background: var(--color-dark);
            color: white;
            border-bottom: 1px solid var(--color-neutral-border);
            flex-shrink: 0;
        }

        .left-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: white;
        }

        /* Left Panel Status Bar */
        .left-panel-status-bar {
            padding: 12px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--color-neutral-border);
            display: flex;
            flex-direction: row;
            gap: 12px;
            flex-shrink: 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
            flex: 1;
            min-width: 0;
        }

        .status-item i {
            font-size: 20px;
            flex-shrink: 0;
            transition: color 0.2s;
        }

        .status-text {
            flex: 1;
            min-width: 0;
        }

        .status-label {
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            color: var(--color-neutral-text);
            transition: color 0.2s;
        }

        .status-detail {
            font-family: var(--font-family-body);
            font-size: 11px;
            color: var(--color-neutral-text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Clickable Status Items */
        .status-item.clickable {
            cursor: pointer;
        }

        .status-item.clickable:hover {
            background: rgba(0, 102, 204, 0.08);
        }

        .status-item.clickable:hover i {
            color: var(--color-primary-blue);
        }

        .status-item.clickable:hover .status-label {
            color: var(--color-primary-blue);
        }

        /* Auth Status States */
        .status-item.auth-authenticated i {
            color: #16a34a;
        }

        .status-item.auth-authenticated .status-label {
            color: #16a34a;
        }

        .status-item.auth-not-authenticated i {
            color: #94a3b8;
        }

        .status-item.auth-not-authenticated .status-label {
            color: #64748b;
        }

        /* Sync Status States */
        .status-item.sync-syncing i {
            color: #3b82f6;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-item.sync-syncing .status-label {
            color: #3b82f6;
        }

        .status-item.sync-synced i {
            color: #16a34a;
        }

        .status-item.sync-synced .status-label {
            color: #16a34a;
        }

        .status-item.sync-error i {
            color: #ef4444;
        }

        .status-item.sync-error .status-label {
            color: #ef4444;
        }

        .status-item.sync-disabled i {
            color: #94a3b8;
        }

        .status-item.sync-disabled .status-label {
            color: #64748b;
        }

        /* Member Tier Disabled State */
        .status-item.member-disabled {
            opacity: 0.6;
        }

        .status-item.member-disabled .status-label::after {
            content: " - Upgrade required";
            font-weight: 400;
            font-style: italic;
            color: #ea580c;
        }

        /* Pulse Animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Chat Container Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: white;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-neutral-border);
            flex-shrink: 0;
            background: white;
        }

        .chat-header button:hover {
            background: #f5f5f7;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: white;
        }

        .chat-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            animation: fadeInMessage 0.3s ease;
            max-width: 100%;
        }

        @keyframes fadeInMessage {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
            color: white;
        }

        .chat-message.user .chat-message-avatar {
            background: var(--color-primary-blue);
        }

        .chat-message.assistant .chat-message-avatar {
            background: #16a34a;
        }

        .chat-message.system .chat-message-avatar {
            background: #ea580c;
        }

        .chat-message-content {
            flex: 1;
            padding: 10px 12px;
            border-radius: 12px;
            font-family: var(--font-family-body);
            font-size: 13px;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .chat-message.user .chat-message-content {
            background: var(--color-primary-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant .chat-message-content {
            background: #f5f5f7;
            color: var(--color-dark);
            border-bottom-left-radius: 4px;
        }

        .chat-message.system .chat-message-content {
            background: #fef2f2;
            color: #dc2626;
            border-left: 3px solid #dc2626;
        }

        .chat-input-container {
            padding: 12px 16px;
            border-top: 1px solid var(--color-neutral-border);
            flex-shrink: 0;
            background: white;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px 12px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--color-neutral-text);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-8px);
            }
        }

        /* Left Panel Toggle Button */
        .left-panel-toggle {
            position: absolute;
            top: 50%;
            left: calc(30% + 8px);
            transform: translateY(-50%);
            z-index: 1001;
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 0 8px 8px 0;
            padding: 12px 8px;
            cursor: pointer;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            color: var(--color-dark);
            font-size: 20px;
            display: flex;
            align-items: center;
        }

        .canvas-modal-body.left-collapsed .left-panel-toggle {
            left: 0;
        }

        .left-panel-toggle:hover {
            background: var(--color-primary-blue);
            color: white;
            border-color: var(--color-primary-blue);
        }

        /* Interview Prep Slideout (60% width) - Inside Canvas Modal */
        .interview-slideout {
            position: fixed;
            top: 0;
            right: -60%;
            width: 60%;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 16px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: right 0.4s ease;
            display: flex;
            flex-direction: column;
        }

        .interview-slideout.active {
            right: 0;
        }

        .interview-slideout.sliding-out {
            right: -60%;
        }

        /* Canvas modal needs to be position relative for slideout */
        .canvas-modal-content {
            position: relative;
            overflow: hidden;
        }

        .slideout-header {
            padding: 16px 20px;
            background: #2a2a2a;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .slideout-header h2 {
            font-family: var(--font-family-ui);
            font-size: 18px;
            margin: 0;
        }

        .slideout-close {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .slideout-close:hover {
            opacity: 0.7;
        }

        .slideout-close:focus {
            outline: 3px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
        }

        .slideout-close:active {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(0.98);
        }

        .slideout-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        .add-story-btn {
            padding: 8px 16px;
            background: var(--color-primary-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 16px;
            width: fit-content;
        }

        .add-story-btn:hover {
            background: var(--color-accent-blue);
            box-shadow: 0 2px 8px rgba(0,102,204,0.3);
        }

        .experience-filter-btn {
            padding: 8px 16px;
            background: white;
            color: var(--color-dark);
            border: 1px solid var(--color-neutral-border);
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .experience-filter-btn:hover {
            border-color: var(--color-primary-blue);
            background: #f8f9fa;
        }

        .experience-filter-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            min-width: 320px;
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .experience-filter-option {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-family: var(--font-family-body);
            font-size: 13px;
            color: var(--color-dark);
            border-radius: 4px;
            margin: 2px 0;
        }

        .experience-filter-option:hover {
            background: var(--color-neutral-background);
        }

        .experience-filter-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin: 13px; /* Creates 44px total touch area (18+13+13=44) */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .experience-filter-option input[type="checkbox"]:focus {
            outline: 3px solid rgba(0, 102, 204, 0.5);
            outline-offset: 2px;
        }

        .experience-filter-option label {
            cursor: pointer;
            flex: 1;
            user-select: none;
        }

        /* Global checkbox styling for touch targets */
        input[type="checkbox"]:not(.experience-filter-option input[type="checkbox"]) {
            width: 18px;
            height: 18px;
            margin: 13px; /* Creates 44px total touch area */
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        input[type="checkbox"]:focus:not(.experience-filter-option input[type="checkbox"]) {
            outline: 3px solid rgba(0, 102, 204, 0.5);
            outline-offset: 2px;
        }

        /* Ensure checkbox labels are also touch-friendly */
        label[for] {
            cursor: pointer;
            min-height: 44px;
            display: flex;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .calendar-view-btn {
            padding: 8px 16px;
            background: white;
            color: var(--color-neutral-text);
            border: 1px solid var(--color-neutral-border);
            border-radius: 6px;
            font-family: var(--font-family-heading);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-view-btn.active {
            background: var(--color-primary-blue);
            color: white;
            border-color: var(--color-primary-blue);
        }

        .calendar-view-btn:hover:not(.active) {
            background: var(--color-neutral-background-secondary);
            border-color: var(--color-primary-blue);
        }

        .calendar-view-btn-green.active {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }

        .calendar-view-btn-green:hover:not(.active) {
            background: var(--color-neutral-background-secondary);
            border-color: #16a34a;
        }

        .linkedin-connect-btn {
            padding: 8px 16px;
            background: #0077B5;
            color: white;
            border: none;
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .linkedin-connect-btn:hover {
            background: #005E93;
            box-shadow: 0 2px 8px rgba(0,119,181,0.3);
        }

        .upload-resume-btn {
            padding: 8px 16px;
            background: var(--color-accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .upload-resume-btn:hover {
            background: var(--color-dark);
            box-shadow: 0 2px 8px rgba(0,70,153,0.3);
        }

        .data-source-btn {
            padding: 12px 16px;
            background: white;
            color: var(--color-dark);
            border: 2px solid var(--color-neutral-border);
            border-radius: 8px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .data-source-btn:hover {
            border-color: var(--color-primary-blue);
            background: var(--color-neutral-background);
            color: var(--color-primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 102, 204, 0.15);
        }

        .data-source-btn i {
            font-size: 18px;
        }

        /* Export Menu Styles */
        #exportMenu button:hover {
            background: var(--color-neutral-background) !important;
        }

        #exportMenu button:first-child {
            border-radius: 8px 8px 0 0;
        }

        #exportMenu button:last-child {
            border-radius: 0 0 8px 8px;
        }

        .stories-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .story-card {
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 8px;
            padding: 14px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .story-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .story-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .story-title {
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .story-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .story-action-btn {
            background: none;
            border: none;
            color: var(--color-primary-blue);
            font-size: 16px;
            cursor: pointer;
            padding: 12px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .story-action-btn:hover {
            color: var(--color-accent-blue);
            background: rgba(0, 102, 204, 0.1);
        }

        .story-action-btn:focus {
            outline: 3px solid rgba(0, 102, 204, 0.5);
            outline-offset: 2px;
        }

        .story-action-btn:active {
            background: rgba(0, 102, 204, 0.2);
            transform: scale(0.98);
        }

        .block-btn:hover {
            background: #e3f2fd !important;
            border-color: var(--color-primary-blue) !important;
        }

        .story-action-btn.delete:hover {
            color: #dc3545;
        }

        /* Quill Editor Styles */
        #quillEditor {
            outline: none;
        }

        .editor-paragraph {
            margin: 0 0 8px 0;
        }

        .editor-heading-h1 {
            font-size: 2em;
            font-weight: 600;
            margin: 16px 0 12px 0;
            font-family: var(--font-family-ui);
            color: var(--color-dark);
        }

        .editor-heading-h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 14px 0 10px 0;
            font-family: var(--font-family-ui);
            color: var(--color-dark);
        }

        .editor-heading-h3 {
            font-size: 1.17em;
            font-weight: 600;
            margin: 12px 0 8px 0;
            font-family: var(--font-family-ui);
            color: var(--color-dark);
        }

        .editor-list-ul,
        .editor-list-ol {
            padding-left: 24px;
            margin: 8px 0;
        }

        .editor-listitem {
            margin: 4px 0;
        }

        .editor-text-bold {
            font-weight: bold;
        }

        .editor-text-italic {
            font-style: italic;
        }

        .editor-text-underline {
            text-decoration: underline;
        }

        .editor-text-strikethrough {
            text-decoration: line-through;
        }

        .editor-text-code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .editor-quote {
            border-left: 4px solid var(--color-primary-blue);
            padding-left: 16px;
            margin: 12px 0;
            color: #666;
            font-style: italic;
        }

        #quillEditor table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            border: 1px solid var(--color-neutral-border);
        }

        #quillEditor table th,
        #quillEditor table td {
            border: 1px solid var(--color-neutral-border);
            padding: 8px 12px;
            text-align: left;
        }

        #quillEditor table th {
            background: var(--color-neutral-background);
            font-weight: 600;
        }

        #quillEditor a {
            color: var(--color-primary-blue);
            text-decoration: underline;
            cursor: pointer;
        }

        #quillEditor a:hover {
            color: var(--color-accent-blue);
        }

        /* Quill Editor Styles */
        .ql-toolbar {
            border-top: none !important;
            border-left: none !important;
            border-right: none !important;
            border-bottom: 1px solid var(--color-neutral-border) !important;
            background: white !important;
            padding: 12px 24px !important;
        }

        .ql-container {
            border: none !important;
            font-family: var(--font-family-body) !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
            flex: 1 !important;
        }

        .ql-editor {
            padding: 40px 24px !important;
            background: white !important;
            color: var(--color-dark) !important;
            overflow-y: auto !important;
        }

        .ql-editor h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 24px 0 12px 0;
            color: var(--color-dark);
        }

        .ql-editor h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 20px 0 10px 0;
            color: var(--color-dark);
        }

        .ql-editor h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 16px 0 8px 0;
            color: var(--color-dark);
        }

        .ql-editor blockquote {
            margin: 16px 0;
            padding: 12px 20px;
            border-left: 4px solid var(--color-primary-blue);
            background: #f8f9fa;
            font-style: italic;
        }

        .ql-editor a {
            color: var(--color-primary-blue);
            text-decoration: underline;
        }

        .ql-editor a:hover {
            color: var(--color-accent-blue);
        }

        .ql-editor pre.ql-syntax {
            background: #f8f8f8;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
        }

        .ql-editor code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        /* Quill toolbar button styling */
        .ql-toolbar .ql-formats {
            margin-right: 12px;
        }

        .ql-toolbar button:hover {
            color: var(--color-primary-blue) !important;
        }

        .ql-toolbar button.ql-active {
            color: var(--color-primary-blue) !important;
        }

        /* Mobile responsive toolbar */
        @media (max-width: 768px) {
            .ql-toolbar {
                padding: 8px 16px !important;
            }

            .ql-editor {
                padding: 20px 16px !important;
                font-size: 16px !important; /* Prevent iOS zoom */
            }
        }

        #quillEditor .ql-editor {
            padding: 40px;
            min-height: 100%;
        }

        #quillEditor .ql-toolbar {
            border-top: none;
            border-left: none;
            border-right: none;
            border-bottom: 1px solid var(--color-neutral-border);
            background: var(--color-neutral-background-secondary);
            padding: 12px;
        }

        #quillEditor .ql-editor h1,
        #quillEditor .ql-editor h2,
        #quillEditor .ql-editor h3,
        #quillEditor .ql-editor h4 {
            font-family: var(--font-family-ui);
            font-weight: 600;
            color: var(--color-dark);
            margin-top: 24px;
            margin-bottom: 12px;
        }

        #quillEditor .ql-editor h1 {
            font-size: 32px;
        }

        #quillEditor .ql-editor h2 {
            font-size: 26px;
        }

        #quillEditor .ql-editor h3 {
            font-size: 20px;
        }

        #quillEditor .ql-editor h4 {
            font-size: 16px;
        }

        #quillEditor .ql-editor p {
            margin-bottom: 12px;
            color: var(--color-neutral-text);
        }

        .story-experience {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            margin-bottom: 8px;
            font-style: italic;
            line-height: 1.3;
        }

        .story-section {
            margin-bottom: 8px;
        }

        .story-section-label {
            font-family: var(--font-family-ui);
            font-size: 10px;
            font-weight: 600;
            color: var(--color-primary-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .story-section-text {
            font-family: var(--font-family-body);
            font-size: 12px;
            line-height: 1.4;
            color: var(--color-neutral-text);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .story-competencies {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .competency-tag {
            background: #e3f2fd;
            color: #1a1a1a;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Story Form Modal - Inside Slideout */
        .story-form-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .story-form-modal.active {
            display: flex;
        }

        .story-form-content {
            width: 100%;
            max-width: 500px;
            max-height: calc(100vh - 80px); /* More conservative height calculation */
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .story-form-header {
            padding: 14px 18px;
            background: var(--color-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .story-form-header h3 {
            font-family: var(--font-family-ui);
            font-size: 15px;
            margin: 0;
        }

        .story-form-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .story-form-close:hover {
            opacity: 0.7;
        }

        .story-form-body {
            flex: 1;
            overflow-y: auto;
            padding: 18px;
            min-height: 0; /* Ensure flex child can shrink properly */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-family: var(--font-family-ui);
            font-size: 11px;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--color-neutral-border);
            border-radius: 4px;
            font-family: var(--font-family-body);
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--color-primary-blue);
        }

        .form-group small {
            display: block;
            margin-top: 3px;
            font-size: 10px;
            color: var(--color-neutral-text-light);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px;
            padding-top: 14px;
            border-top: 1px solid var(--color-neutral-border);
            flex-shrink: 0;
        }

        .btn-cancel,
        .btn-save {
            padding: 8px 18px;
            border: none;
            border-radius: 4px;
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel {
            background: var(--color-neutral-background);
            color: var(--color-neutral-text);
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .btn-save {
            background: var(--color-primary-blue);
            color: white;
        }

        .btn-save:hover {
            background: var(--color-accent-blue);
        }

        /* Pipeline Management Modal */
        .pipeline-mgmt-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .pipeline-mgmt-modal.active {
            display: flex;
        }

        .pipeline-mgmt-content {
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .pipeline-mgmt-header {
            padding: 16px 24px;
            background: var(--color-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .pipeline-mgmt-header h3 {
            font-family: var(--font-family-ui);
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .pipeline-mgmt-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            border-radius: 6px;
        }

        .pipeline-mgmt-close:hover {
            opacity: 0.7;
            background: rgba(255, 255, 255, 0.1);
        }

        .pipeline-mgmt-body {
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        /* Pipeline Wizard Modal */
        .pipeline-wizard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .pipeline-wizard-modal.active {
            display: flex;
        }

        .pipeline-wizard-content {
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .pipeline-wizard-header {
            padding: 20px 24px;
            background: var(--color-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .pipeline-wizard-header h3 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .pipeline-wizard-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            border-radius: 6px;
        }

        .pipeline-wizard-close:hover {
            opacity: 0.7;
            background: rgba(255, 255, 255, 0.1);
        }

        .wizard-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px 24px 16px 24px;
            background: white;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-neutral-background);
            border: 2px solid var(--color-neutral-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-family-ui);
            font-size: 16px;
            font-weight: 600;
            color: var(--color-neutral-text);
            transition: all 0.3s;
        }

        .wizard-step.active .step-number {
            background: var(--color-primary-blue);
            border-color: var(--color-primary-blue);
            color: white;
        }

        .wizard-step.completed .step-number {
            background: var(--color-primary-blue);
            border-color: var(--color-primary-blue);
            color: white;
        }

        .step-label {
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            color: var(--color-neutral-text);
            transition: color 0.3s;
        }

        .wizard-step.active .step-label {
            color: var(--color-primary-blue);
        }

        .wizard-step-line {
            width: 60px;
            height: 2px;
            background: var(--color-neutral-border);
            margin: 0 8px 20px 8px;
        }

        .wizard-step.completed + .wizard-step-line {
            background: var(--color-primary-blue);
        }

        .pipeline-wizard-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px 24px;
            background: white;
            min-height: 0;
        }

        .wizard-step-content {
            display: none;
        }

        .wizard-step-content.active {
            display: block;
        }

        .pipeline-wizard-footer {
            padding: 16px 24px;
            background: var(--color-neutral-background);
            border-top: 1px solid var(--color-neutral-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .source-option:hover {
            border-color: var(--color-primary-blue);
            background: var(--color-neutral-background);
        }

        .source-option.selected {
            border-color: var(--color-primary-blue);
            background: rgba(0, 102, 204, 0.05);
        }

        /* Simple Pipeline Wizard Modal */
        .simple-pipeline-wizard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .simple-pipeline-wizard-modal.active {
            display: flex;
        }

        .simple-pipeline-wizard-content {
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            background: white;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .simple-pipeline-wizard-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--color-primary-blue) 0%, var(--color-accent-blue) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .simple-pipeline-wizard-header h3 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .simple-pipeline-wizard-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            border-radius: 6px;
        }

        .simple-pipeline-wizard-close:hover {
            opacity: 0.7;
            background: rgba(255, 255, 255, 0.15);
        }

        .simple-wizard-progress {
            padding: 20px 24px 16px 24px;
            background: white;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .simple-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-neutral-background);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .simple-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary-blue) 0%, var(--color-accent-blue) 100%);
            border-radius: 4px;
            transition: width 0.4s ease;
            width: 25%;
        }

        .simple-progress-text {
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            color: var(--color-neutral-text);
            text-align: center;
        }

        .simple-pipeline-wizard-body {
            flex: 1;
            overflow-y: auto;
            padding: 40px 32px;
            background: white;
            min-height: 0;
        }

        .simple-wizard-step-content {
            display: none;
        }

        .simple-wizard-step-content.active {
            display: block !important;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideOutDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        .wizard-welcome {
            text-align: center;
            margin-bottom: 32px;
        }

        .template-card {
            padding: 20px;
            border: 2px solid var(--color-neutral-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .template-card:hover {
            border-color: var(--color-primary-blue);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.1);
            transform: translateY(-2px);
        }

        .template-card.selected {
            border-color: var(--color-primary-blue);
            background: rgba(0, 102, 204, 0.02);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
        }

        .template-card.selected .template-check {
            display: block !important;
        }

        .frequency-card {
            padding: 16px;
            border: 2px solid var(--color-neutral-border);
            border-radius: 10px;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }

        .frequency-option:hover .frequency-card {
            border-color: var(--color-primary-blue);
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
        }

        .frequency-option input:checked + .frequency-card {
            border-color: var(--color-primary-blue);
            background: rgba(0, 102, 204, 0.05);
        }

        .simple-source-card {
            position: relative;
            padding: 24px;
            border: 2px solid var(--color-neutral-border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .simple-source-card:hover {
            border-color: var(--color-primary-blue);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.1);
            transform: translateY(-2px);
        }

        .simple-source-card.selected {
            border-color: var(--color-primary-blue);
            background: rgba(0, 102, 204, 0.05);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
        }

        .simple-source-card.selected .simple-source-check {
            display: block !important;
        }

        .simple-pipeline-wizard-footer {
            padding: 16px 24px;
            background: var(--color-neutral-background);
            border-top: 1px solid var(--color-neutral-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #simplePipelineName:focus {
            outline: none;
            border-color: var(--color-primary-blue);
        }

        /* Technical Prep Tabs */
        .tech-tabs {
            display: flex;
            gap: 0;
            justify-content: center;
            border-bottom: 2px solid var(--color-neutral-border);
            margin-bottom: 20px;
        }

        .tech-tab {
            padding: 16px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-neutral-text-light);
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .tech-tab:hover {
            color: var(--color-primary-blue);
            background: var(--color-neutral-background);
        }

        .tech-tab:focus {
            outline: 3px solid rgba(0, 102, 204, 0.5);
            outline-offset: 2px;
        }

        .tech-tab:active {
            background: rgba(0, 102, 204, 0.1);
        }

        .tech-tab.active {
            color: var(--color-primary-blue);
            border-bottom-color: var(--color-primary-blue);
        }

        .tech-tab-content {
            display: none;
        }

        .tech-items-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .tech-items-container .story-card {
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }

        /* Job Opportunity Cards */
        .job-card {
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 8px;
            padding: 14px;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 4px solid var(--color-primary-blue);
        }

        .job-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .job-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .job-title {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .job-company {
            font-size: 12px;
            color: var(--color-primary-blue);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .job-location {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            margin-bottom: 8px;
        }

        .job-salary {
            font-size: 12px;
            color: var(--color-neutral-text);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .job-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .job-status.applied {
            background: #e3f2fd;
            color: #1976d2;
        }

        .job-status.interviewing {
            background: #fff3e0;
            color: #f57c00;
        }

        .job-status.offer {
            background: #e8f5e9;
            color: #388e3c;
        }

        .job-status.rejected {
            background: #ffebee;
            color: #d32f2f;
        }

        .job-status.interested {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .job-status.not-interested {
            background: #f5f5f5;
            color: #666666;
        }

        .job-details {
            font-size: 11px;
            color: var(--color-neutral-text);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Job View Toggle Buttons */
        .job-view-toggle {
            display: flex;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--color-neutral-border);
        }

        .view-toggle-btn {
            padding: 6px 12px;
            background: white;
            border: none;
            border-right: 1px solid var(--color-neutral-border);
            color: var(--color-neutral-text);
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .view-toggle-btn:last-child {
            border-right: none;
        }

        .view-toggle-btn:hover {
            background: var(--color-neutral-background);
        }

        .view-toggle-btn.active {
            background: var(--color-primary-blue);
            color: white;
        }

        /* Jobs Table */
        .jobs-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .jobs-table thead {
            background: var(--color-dark);
            color: white;
        }

        .jobs-table th {
            padding: 12px 16px;
            text-align: left;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .jobs-table th:last-child {
            border-right: none;
        }

        .jobs-table tbody tr {
            border-bottom: 1px solid var(--color-neutral-border);
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .jobs-table tbody tr:last-child {
            border-bottom: none;
        }

        .jobs-table tbody tr:hover {
            background: var(--color-neutral-background);
        }

        .jobs-table td {
            padding: 12px 16px;
            font-family: var(--font-family-body);
            font-size: 13px;
            vertical-align: top;
        }

        .job-table-position {
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 2px;
        }

        .job-table-location {
            font-size: 11px;
            color: var(--color-neutral-text-light);
        }

        .job-table-company {
            font-weight: 500;
            color: var(--color-dark);
        }

        .job-table-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .job-table-next-action {
            font-size: 12px;
            line-height: 1.3;
        }

        .job-table-next-action-task {
            font-weight: 500;
            color: var(--color-dark);
            margin-bottom: 2px;
        }

        .job-table-next-action-date {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .job-table-next-action-date.overdue {
            color: #dc2626;
            font-weight: 600;
        }

        .job-table-next-action-date.due-soon {
            color: #f59e0b;
            font-weight: 600;
        }

        .job-table-alerts {
            text-align: center;
        }

        .job-alert-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
        }

        .job-alert-indicator.overdue {
            background: #fef2f2;
            color: #dc2626;
            border: 2px solid #dc2626;
        }

        .job-alert-indicator.due-soon {
            background: #fffbeb;
            color: #f59e0b;
            border: 2px solid #f59e0b;
        }

        .job-alert-indicator.normal {
            background: #f0f9ff;
            color: #0369a1;
            border: 2px solid #e0e7ff;
        }

        .job-alert-indicator.none {
            background: var(--color-neutral-background);
            color: var(--color-neutral-text-muted);
            border: 2px solid var(--color-neutral-border);
        }

        /* Job Table Action Buttons */
        .job-table-action-btn:hover {
            background: var(--color-neutral-background) !important;
            color: var(--color-dark) !important;
        }

        .job-table-action-btn.delete:hover {
            background: #fef2f2 !important;
            color: #dc2626 !important;
        }

        /* Job Detail Modal */
        .job-detail-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .job-detail-modal.active {
            display: flex;
        }

        .job-detail-content {
            width: 100%;
            max-width: 600px; /* Reduced from 700px for better fit */
            max-height: calc(100vh - 80px); /* More conservative height calculation */
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .job-detail-header {
            padding: 24px;
            background: var(--color-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-neutral-border);
        }

        .job-detail-header h3 {
            font-family: var(--font-family-ui);
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .job-detail-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .job-detail-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .job-detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px; /* Reduced padding from 24px for more space */
            background: var(--color-neutral-background);
            min-height: 0; /* Ensure flex child can shrink properly */
        }

        .job-detail-section {
            margin-bottom: 16px; /* Reduced from 24px */
            background: white;
            border-radius: 8px;
            padding: 16px; /* Reduced from 20px */
            border: 1px solid var(--color-neutral-border);
        }

        /* Remove bottom margin from last section to prevent extra scrolling */
        .job-detail-section:last-child {
            margin-bottom: 0;
        }

        .job-detail-section h4 {
            font-family: var(--font-family-ui);
            font-size: 15px; /* Slightly smaller from 16px */
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 12px 0; /* Reduced from 16px */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .job-detail-section h4 i {
            font-size: 18px;
            color: var(--color-primary-blue);
        }

        /* Optimize job detail modal buttons to prevent oversizing */
        .job-detail-section button {
            padding: 6px 12px; /* Consistent with inline styles but ensures override */
            font-size: 12px;
            font-family: var(--font-family-ui);
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            transition: all 0.2s;
            /* Prevent buttons from growing too large */
            max-width: 200px;
            flex-shrink: 0;
        }

        .job-detail-section button[onclick*="addJob"],
        .job-detail-section button[onclick*="openPrompt"] {
            background: var(--color-primary-blue);
            color: white;
        }

        .job-detail-section button[onclick*="addJob"]:hover,
        .job-detail-section button[onclick*="openPrompt"]:hover {
            background: var(--color-accent-blue);
        }

        .job-detail-section button[onclick*="addJobCompetency"] {
            background: var(--color-accent-blue);
            color: white;
        }

        .job-detail-section button[onclick*="addJobCompetency"]:hover {
            background: #003d7a;
        }

        /* Optimize button containers to prevent horizontal overflow */
        .job-detail-section div[style*="flex"] {
            flex-wrap: wrap;
            gap: 8px !important;
        }

        /* Ensure skills and competencies button container is responsive */
        .job-detail-section h4 + div {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .job-status-editor {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .job-status-select {
            padding: 8px 12px;
            border: 1px solid var(--color-neutral-border);
            border-radius: 6px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .skills-competencies-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .skill-comp-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .skill-comp-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--color-neutral-background);
            border-radius: 6px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .skill-comp-item:hover {
            border-color: var(--color-primary-blue);
            background: #e3f2fd;
        }

        .fit-analysis-section {
            background: var(--color-neutral-background);
        }

        .fit-score {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 2px solid var(--color-primary-blue);
        }

        .fit-score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: var(--font-family-ui);
            font-size: 18px;
            font-weight: 600;
        }

        .fit-score-details h5 {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
        }

        .fit-score-details p {
            font-size: 12px;
            color: var(--color-neutral-text-light);
            margin: 0;
        }

        .fit-dimensions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fit-dimension {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--color-neutral-border);
        }

        .dimension-info {
            flex: 1;
        }

        .dimension-name {
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 2px 0;
        }

        .dimension-details {
            font-size: 11px;
            color: var(--color-neutral-text-light);
        }

        .dimension-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-bar {
            width: 80px;
            height: 6px;
            background: var(--color-neutral-border);
            border-radius: 3px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .score-text {
            font-family: var(--font-family-ui);
            font-size: 12px;
            font-weight: 600;
            min-width: 35px;
            text-align: right;
        }

        /* Application Material Items */
        .app-material-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: var(--color-neutral-background);
            border-radius: 6px;
            border: 1px solid var(--color-neutral-border);
            transition: all 0.2s;
        }

        .app-material-item:hover {
            border-color: var(--color-primary-blue);
            background: #e3f2fd;
        }

        .app-material-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .app-material-icon.resume {
            background: #0066CC;
        }

        .app-material-icon.cover-letter {
            background: #004C99;
        }

        .app-material-icon.email {
            background: #1a1a1a;
        }

        .app-material-info {
            flex: 1;
            min-width: 0;
        }

        .app-material-title {
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .app-material-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .app-material-tag {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .app-material-tag.format {
            background: #f5f5f7;
            color: #666;
        }

        .app-material-tag.ats {
            background: #e8f5e9;
            color: #388e3c;
        }

        .app-material-tag.date {
            background: #fff3e0;
            color: #f57c00;
        }

        .app-material-preview {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .app-material-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .app-material-item:hover .app-material-actions {
            opacity: 1;
        }

        .app-material-action-btn {
            padding: 4px 8px;
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .app-material-action-btn:hover {
            border-color: var(--color-primary-blue);
            background: #e3f2fd;
        }

        .app-material-action-btn.delete:hover {
            border-color: #d32f2f;
            background: #ffebee;
            color: #d32f2f;
        }

        /* Job Todo Checklist Items */
        .job-todo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--color-neutral-border);
            transition: all 0.2s;
        }

        .job-todo-item:hover {
            border-color: var(--color-primary-blue);
            box-shadow: 0 2px 4px rgba(0, 102, 204, 0.1);
        }

        .job-todo-item.completed {
            background: #f8f9fa;
            opacity: 0.8;
        }

        .job-todo-item.completed .job-todo-text {
            text-decoration: line-through;
            color: var(--color-neutral-text-muted);
        }

        .job-todo-item.overdue {
            border-left: 4px solid #dc2626;
            background: #fef2f2;
        }

        .job-todo-item.due-soon {
            border-left: 4px solid #f59e0b;
            background: #fffbeb;
        }

        .job-todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-primary-blue);
        }

        .job-todo-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .job-todo-text {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 500;
            color: var(--color-dark);
            line-height: 1.3;
        }

        .job-todo-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--color-neutral-text-light);
        }

        .job-todo-due-date {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .job-todo-due-date.overdue {
            color: #dc2626;
        }

        .job-todo-due-date.due-soon {
            color: #f59e0b;
        }

        .job-todo-due-date.normal {
            color: var(--color-neutral-text);
        }

        .job-todo-priority {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .job-todo-priority.high {
            background: #fef2f2;
            color: #dc2626;
        }

        .job-todo-priority.medium {
            background: #fffbeb;
            color: #f59e0b;
        }

        .job-todo-priority.low {
            background: #f0f9ff;
            color: #0369a1;
        }

        .job-todo-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .job-todo-item:hover .job-todo-actions {
            opacity: 1;
        }

        .job-todo-action-btn {
            padding: 4px;
            background: none;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--color-neutral-text-light);
            transition: all 0.2s;
            font-size: 14px;
        }

        .job-todo-action-btn:hover {
            background: var(--color-neutral-background);
            color: var(--color-dark);
        }

        .job-todo-action-btn.delete:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Experience Card Styles */
        .experience-card {
            background: white;
            border: 1px solid var(--color-neutral-border);
            border-radius: 8px;
            padding: 14px;
            transition: all 0.2s;
            border-left: 4px solid var(--color-accent-blue);
        }

        .experience-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .experience-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .exp-title {
            font-family: var(--font-family-ui);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-dark);
            margin: 0;
            line-height: 1.3;
            display: inline-block;
        }

        .exp-company {
            font-size: 12px;
            color: var(--color-accent-blue);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .exp-dates {
            font-size: 11px;
            color: var(--color-neutral-text-light);
            margin-bottom: 8px;
        }

        .exp-description {
            font-size: 12px;
            color: var(--color-neutral-text);
            line-height: 1.4;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .exp-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--color-neutral-border);
        }

        .exp-section-label {
            font-family: var(--font-family-ui);
            font-size: 10px;
            font-weight: 600;
            color: var(--color-neutral-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .exp-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .exp-tag {
            background: var(--color-neutral-background);
            color: var(--color-neutral-text);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            border: 1px solid var(--color-neutral-border);
        }

        .exp-tag.core {
            background: #e3f2fd;
            color: #1976d2;
            border-color: #1976d2;
        }

        .exp-tag.peripheral {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #7b1fa2;
        }

        .exp-list {
            margin: 0;
            padding-left: 20px;
        }

        .exp-list li {
            font-size: 12px;
            color: var(--color-neutral-text);
            line-height: 1.5;
            margin-bottom: 4px;
        }

        /* Mindmap Styles */
        .mindmap-node rect {
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.3s;
            rx: 8;
            ry: 8;
        }

        .mindmap-node.root rect {
            fill: var(--color-primary-blue);
            stroke: none;
        }

        .mindmap-node.child rect {
            fill: white;
            stroke: var(--color-primary-blue);
        }

        .mindmap-node.child rect.collapsed {
            stroke: var(--color-neutral-border);
            stroke-width: 2;
        }

        .mindmap-node.child rect.expanded {
            fill: #e3f2fd;
            stroke: var(--color-primary-blue);
            stroke-width: 3;
            filter: drop-shadow(0 2px 8px rgba(0, 102, 204, 0.3));
        }

        .mindmap-node.grandchild rect {
            fill: #f5f5f7;
            stroke: #bdbdbd;
            stroke-width: 2;
        }

        .mindmap-node.root text {
            fill: white;
            font-size: 16px;
            font-weight: 600;
        }

        .mindmap-node.child text {
            fill: var(--color-dark);
            font-size: 14px;
            font-weight: 500;
        }

        .mindmap-node.grandchild text {
            fill: var(--color-neutral-text);
            font-size: 12px;
            font-weight: 400;
        }

        .mindmap-node text {
            font-family: var(--font-family-ui);
            text-anchor: middle;
            pointer-events: none;
        }

        .mindmap-node.child:hover rect {
            filter: drop-shadow(0 4px 12px rgba(0, 102, 204, 0.4));
            transform: scale(1.05);
        }

        .mindmap-node.root:hover rect {
            filter: drop-shadow(0 4px 12px rgba(0, 102, 204, 0.5));
        }

        .mindmap-node.grandchild:hover rect {
            fill: #e0e0e0;
        }

        .mindmap-link {
            fill: none;
            stroke: var(--color-primary-blue);
            stroke-width: 2;
            opacity: 0.6;
        }

        /* Mobile Menu Styles */
        .mobile-menu {
            display: none;
            padding: 20px;
            overflow-y: auto;
        }

        .mobile-menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .mobile-menu-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 12px;
            background: white;
            border: 2px solid var(--color-neutral-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            color: var(--color-dark);
            min-height: 100px;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .mobile-menu-item span {
            line-height: 1.2;
            word-wrap: break-word;
            hyphens: auto;
            -webkit-hyphens: auto;
            max-width: 100%;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-item:hover {
            border-color: var(--color-primary-blue);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
            transform: translateY(-2px);
        }

        .mobile-menu-item i {
            font-size: 32px;
            color: var(--color-primary-blue);
        }

        .mobile-menu-item-premium {
            border-color: #FFE0D6;
            background: linear-gradient(to bottom, white, #FFF8F5);
        }

        .mobile-menu-item-premium:hover {
            border-color: #FF6B35;
        }

        /* Removed mobile-paid-badge styling - no longer needed */

        /* Small Mobile Devices (iPhone SE, etc.) */
        @media (max-width: 375px) {
            .canvas-modal-header {
                padding: 12px 16px;
            }

            .canvas-modal-header h2 {
                font-size: 16px;
            }

            .mobile-menu-grid {
                gap: 8px;
            }

            .mobile-menu-item {
                padding: 14px 10px;
                font-size: 12px;
                min-height: 90px;
                gap: 6px;
            }

            .mobile-menu-item i {
                font-size: 28px;
            }

            .story-card, .tech-item {
                padding: 16px;
                font-size: 13px;
            }

            .tech-tab {
                padding: 16px 16px; /* Reduced horizontal padding for narrow screens */
                font-size: 12px;
            }
        }

        /* Standard Mobile Devices */
        @media (max-width: 480px) {
            .canvas-modal-header {
                padding: 14px 18px;
            }

            .tech-tab {
                padding: 16px 20px;
            }

            .profile-dropdown-item {
                padding: 14px;
                font-size: 14px;
            }

            /* Optimize forms for mobile */
            .modal {
                margin: 0;
                border-radius: 0;
            }

            .modal-content {
                padding: 16px;
            }

            /* Ensure touch targets remain adequate */
            .story-action-btn, .modal-close, .slideout-close {
                min-width: 44px;
                min-height: 44px;
            }
        }

        @media (max-width: 768px) {
            .canvas-modal-content {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .canvas-modal-header {
                padding: 16px 20px;
            }

            .canvas-modal-header h2 {
                font-size: 18px;
            }

            .canvas-modal-header img {
                height: 36px;
            }

            .canvas-modal-body {
                padding: 0;
                display: flex !important;
                flex-direction: column;
            }

            /* Mobile main menu collapse */
            .main-menu-nav-items {
                display: none !important;
            }

            .mobile-menu-toggle {
                display: flex !important;
            }

            /* Ensure mobile menu dropdown is properly positioned */
            .main-menu-dropdown {
                position: fixed !important; /* Use fixed positioning on mobile */
                top: 70px !important; /* Position below header */
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                max-height: calc(100vh - 70px) !important;
                overflow-y: auto !important;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
            }

            .main-menu-dropdown.active {
                visibility: visible !important;
                opacity: 1 !important;
                transform: translateY(0) !important;
                pointer-events: auto !important;
            }

            .main-menu-dropdown .main-menu-item {
                width: 100%;
                justify-content: flex-start;
                padding: 16px 20px;
                border-radius: 0;
                margin: 0;
            }

            .main-menu-dropdown .main-menu-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            .main-menu-dropdown .main-menu-item i {
                font-size: 20px;
                margin-right: 12px;
            }

            /* Hide profile dropdown and profile circle completely on mobile */
            .profile-dropdown,
            .profile-circle {
                display: none !important;
            }

            /* Mobile optimization for story/job form modals */
            .story-form-modal {
                padding: 0;
                align-items: stretch;
            }

            .story-form-content {
                width: 100%;
                height: 100vh;
                height: 100dvh; /* Use dynamic viewport height for better mobile support */
                max-width: none;
                max-height: none;
                border-radius: 0;
                margin: 0;
                min-height: 0; /* Ensure modal can handle content overflow */
            }

            .story-form-header {
                padding: 16px 20px;
                flex-shrink: 0;
            }

            .story-form-header h3 {
                font-size: 18px;
            }

            .story-form-close {
                width: 44px;
                height: 44px;
                font-size: 28px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .story-form-body {
                flex: 1;
                padding: 16px 20px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            .story-form-body form {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .form-group {
                margin-bottom: 20px;
                flex-shrink: 0;
            }

            .form-group label {
                font-size: 14px;
                margin-bottom: 8px;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 12px 16px;
                font-size: 16px; /* Prevent iOS zoom */
                min-height: 44px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .form-actions {
                margin-top: auto;
                padding: 16px 0 0 0;
                gap: 12px;
                flex-shrink: 0;
                position: sticky;
                bottom: 0;
                background: white;
                border-top: 2px solid var(--color-neutral-border);
            }

            .btn-cancel,
            .btn-save {
                padding: 14px 24px;
                font-size: 16px;
                min-height: 44px;
                flex: 1;
                border-radius: 8px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .btn-save {
                order: 2; /* Put save button on right for thumb reach */
            }

            .btn-cancel {
                order: 1;
            }

            /* Mobile optimization for job detail modal */
            .job-detail-modal {
                padding: 0;
                align-items: stretch;
            }

            .job-detail-content {
                width: 100%;
                height: 100vh;
                height: 100dvh; /* Use dynamic viewport height for better mobile support */
                max-width: none;
                max-height: none;
                border-radius: 0;
                margin: 0;
                /* Ensure modal can handle content overflow */
                min-height: 0;
            }

            .job-detail-header {
                padding: 16px 20px;
                flex-shrink: 0;
            }

            .job-detail-header h3 {
                font-size: 18px;
            }

            .job-detail-close {
                width: 44px;
                height: 44px;
                font-size: 28px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .job-detail-body {
                flex: 1;
                padding: 12px 16px;
                overflow-y: auto;
                background: var(--color-neutral-background);
                min-height: 0; /* Ensure flex child can shrink */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }

            .job-detail-section {
                margin-bottom: 16px;
                padding: 16px;
                border-radius: 8px;
            }

            .job-detail-section h4 {
                font-size: 16px;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px;
            }

            /* Make skills & competencies section more prominent and accessible */
            .job-detail-section h4 + div {
                display: flex;
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }

            /* Stack Add Skill and Add Competency buttons on mobile */
            .job-detail-section h4 + div button {
                width: 100%;
                padding: 12px 16px;
                min-height: 44px;
                font-size: 16px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            /* Make skills-competencies grid single column on mobile */
            .skills-competencies-grid {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
                margin-bottom: 16px;
            }

            /* Optimize skill/competency items for touch */
            .skill-comp-item {
                padding: 12px;
                margin-bottom: 8px;
                border: 1px solid var(--color-neutral-border);
                border-radius: 6px;
                background: white;
                font-size: 14px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                min-height: 44px;
            }

            /* Make job status selector touch-friendly */
            .job-status-select {
                padding: 12px 16px;
                font-size: 16px; /* Prevent iOS zoom */
                min-height: 44px;
                width: 100%;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            /* Fix any nested button issues */
            .job-detail-section button {
                min-height: 44px;
                padding: 12px 16px;
                font-size: 14px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            /* Ensure todo items and other interactive elements are touch-friendly */
            .todo-item,
            .application-material-item {
                min-height: 44px;
                padding: 12px;
                margin-bottom: 8px;
            }

            .canvas-description {
                padding: 16px !important;
            }

            /* Hide D3 map on mobile, show mobile menu */
            #canvas-mindmap {
                display: none !important;
            }

            .mobile-menu {
                display: none; /* Default hidden, controlled by JavaScript */
                flex: 0 0 0; /* Don't take any flex space when hidden */
                padding: 16px;
            }

            /* Show mobile menu only when canvas tab is active */
            .mobile-menu.show-for-canvas {
                display: flex;
                flex: 1; /* Take available space only when visible */
            }

            /* Ensure canvas body doesn't reserve space when hidden */
            .canvas-modal-body {
                min-height: 0 !important;
            }

            /* Hide canvas description completely when not needed */
            .canvas-description.hidden-for-other-tabs {
                display: none !important;
                padding: 0 !important;
                min-height: 0 !important;
            }

            /* Make slideouts full width on mobile */
            .interview-slideout {
                width: 100%;
                right: -100%;
            }

            .interview-slideout.active {
                right: 0;
            }

            /* Single column layout for stories, experiences, and tech items on mobile */
            .stories-container,
            .tech-items-container {
                grid-template-columns: 1fr;
            }

            /* Projects View Mobile Optimization */
            #projects-sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100vh;
                z-index: 300;
                transition: left 0.3s ease;
                box-shadow: none;
            }

            #projects-sidebar.open {
                left: 0;
                box-shadow: 4px 0 16px rgba(0, 0, 0, 0.3);
            }

            /* Show mobile sidebar toggle button */
            #mobile-sidebar-toggle {
                display: flex !important;
            }

            /* Hide file table on mobile, show cards */
            #fileExplorerTable {
                display: none !important;
            }

            #file-cards-container {
                display: flex !important;
            }

            /* Mobile file card styling */
            .mobile-file-card {
                background: white;
                border: 1px solid var(--color-neutral-border);
                border-radius: 8px;
                padding: 16px;
                display: flex;
                align-items: flex-start;
                gap: 12px;
                transition: all 0.2s;
            }

            .mobile-file-card:hover {
                border-color: var(--color-primary-blue);
                box-shadow: 0 2px 8px rgba(0, 102, 204, 0.15);
            }

            .mobile-file-icon {
                width: 40px;
                height: 40px;
                background: #e3f2fd;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .mobile-file-icon i {
                font-size: 20px;
                color: var(--color-primary-blue);
            }

            .mobile-file-info {
                flex: 1;
                min-width: 0;
            }

            .mobile-file-name {
                font-family: var(--font-family-ui);
                font-size: 14px;
                font-weight: 600;
                color: var(--color-dark);
                margin: 0 0 4px 0;
                word-break: break-word;
            }

            .mobile-file-meta {
                font-family: var(--font-family-body);
                font-size: 12px;
                color: var(--color-neutral-text);
                line-height: 1.4;
            }

            .mobile-file-actions {
                display: flex;
                gap: 4px;
                flex-shrink: 0;
            }

            .mobile-file-action-btn {
                padding: 8px;
                background: white;
                border: 1px solid var(--color-neutral-border);
                border-radius: 6px;
                cursor: pointer;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                transition: all 0.2s;
            }

            .mobile-file-action-btn i {
                font-size: 16px;
                color: var(--color-neutral-text);
            }

            .mobile-file-action-btn.edit:hover,
            .mobile-file-action-btn.share:hover {
                border-color: var(--color-primary-blue);
                background: #e3f2fd;
            }

            .mobile-file-action-btn.edit:hover i,
            .mobile-file-action-btn.share:hover i {
                color: var(--color-primary-blue);
            }

            .mobile-file-action-btn.delete:hover {
                border-color: #dc2626;
                background: #fef2f2;
            }

            .mobile-file-action-btn.delete:hover i {
                color: #dc2626;
            }

            /* Modal Mobile Optimization */
            .modal {
                padding: 0 !important;
                align-items: flex-end;
            }

            .modal-content {
                width: 100% !important;
                max-width: none !important;
                height: 100vh !important;
                max-height: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                display: flex;
                flex-direction: column;
            }

            .modal-header {
                padding: 16px 20px !important;
                position: sticky !important;
                top: 0 !important;
                background: white !important;
                z-index: 100 !important;
                border-bottom: 1px solid var(--color-neutral-border);
                flex-shrink: 0;
            }

            .modal-title {
                font-size: 18px !important;
            }

            .modal-body {
                flex: 1 !important;
                overflow-y: auto !important;
                padding: 16px 20px !important;
                -webkit-overflow-scrolling: touch;
            }

            .modal-footer {
                position: sticky !important;
                bottom: 0 !important;
                background: white !important;
                z-index: 100 !important;
                border-top: 1px solid var(--color-neutral-border);
                padding: 16px 20px !important;
                flex-shrink: 0;
            }

            /* Specific modal optimizations */
            #documentEditorModal .modal-content,
            #formDesignerModal .modal-content {
                height: 100vh !important;
                max-height: none !important;
            }

            /* Modal close button mobile optimization */
            .modal-close {
                position: absolute !important;
                top: 50% !important;
                right: 20px !important;
                transform: translateY(-50%) !important;
                width: 44px !important;
                height: 44px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: rgba(0, 0, 0, 0.1) !important;
                border-radius: 8px !important;
                z-index: 101 !important;
            }

            .modal-close:hover {
                background: rgba(0, 0, 0, 0.2) !important;
            }

            .modal-close:active {
                background: rgba(0, 0, 0, 0.3) !important;
                transform: translateY(-50%) scale(0.95) !important;
            }

            /* Tab Navigation Horizontal Scrolling */
            .main-menu {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding-bottom: 12px;
                margin-bottom: -12px; /* Hide scrollbar space */
            }

            .main-menu::-webkit-scrollbar {
                display: none;
            }

            .main-menu-item {
                min-width: max-content;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .main-menu-item span {
                white-space: nowrap;
            }

            /* Tech Tabs Horizontal Scrolling */
            .tech-tabs {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                justify-content: flex-start !important; /* Change from center to flex-start */
                padding: 16px 12px 0 12px !important; /* Override inline padding */
                margin: 0 -12px; /* Extend scrollable area to edges */
                padding-bottom: 2px;
                /* Force horizontal scrolling container */
                width: 100%;
                box-sizing: border-box;
            }

            .tech-tabs::-webkit-scrollbar {
                display: none;
            }

            .tech-tab {
                min-width: max-content !important;
                white-space: nowrap !important;
                flex-shrink: 0 !important;
                padding: 16px 16px !important; /* More compact but still touch-friendly */
                font-size: 13px !important;
                /* Ensure tabs don't wrap */
                display: inline-flex !important;
                align-items: center;
                margin: 0 2px; /* Small gap between tabs */
            }

            /* Ensure all tabs in mobile slideouts can scroll horizontally */
            .slideout-header .tech-tabs,
            .slideout-body .tech-tabs,
            div[class*="tabs"] {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                justify-content: flex-start !important;
            }

            /* Target the specific interview prep tabs container */
            #interviewPrepContent .tech-tabs {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                justify-content: flex-start !important;
                padding: 16px 12px 0 12px !important;
                margin: 0 -12px;
                width: auto;
                min-width: 100%;
            }

            /* Ensure any button container that contains tech-tab buttons scrolls */
            .slideout-body > div:first-child {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Add subtle scroll indicators for mobile tabs */
            .tech-tabs::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 2px;
                width: 20px;
                background: linear-gradient(to right, transparent, var(--color-neutral-background));
                pointer-events: none;
                opacity: 0.8;
            }

            .tech-tabs {
                position: relative;
            }

            /* Hide scroll indicator when not needed */
            @supports (scrollbar-width: none) {
                .tech-tabs::after {
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }

                .tech-tabs:hover::after {
                    opacity: 0.8;
                }
            }

            /* Interview Tabs (if present) */
            .interview-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .interview-tabs::-webkit-scrollbar {
                display: none;
            }

            .interview-tab {
                min-width: max-content;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Main Menu Mobile Layout Optimization */
            .canvas-modal-header .main-menu {
                flex-wrap: wrap;
                gap: 8px;
                padding: 8px 0;
            }

            /* Logo optimization for mobile */
            .canvas-modal-header .main-menu a img {
                height: 28px !important; /* Smaller logo on mobile */
                margin-right: 8px !important;
            }

            /* Profile section mobile optimization */
            .canvas-modal-header .main-menu > div[style*="margin-left: auto"] {
                margin-left: 8px !important; /* Less aggressive auto margin */
                flex-shrink: 0;
            }

            .profile-avatar {
                width: 36px !important;
                height: 36px !important;
            }

            .profile-avatar span {
                font-size: 14px !important;
            }

            /* On very small screens, stack header elements */
            @media (max-width: 375px) {
                .canvas-modal-header .main-menu {
                    flex-direction: column;
                    gap: 8px;
                    padding: 12px 0;
                }

                .canvas-modal-header .main-menu > a {
                    align-self: flex-start;
                    margin-right: 0 !important;
                    margin-bottom: 8px;
                }

                .canvas-modal-header .main-menu > div[style*="margin-left: auto"] {
                    margin-left: 0 !important;
                    align-self: flex-end;
                    position: absolute;
                    top: 12px;
                    right: 20px;
                }

                /* Make navigation tabs take full width */
                .main-menu-nav-container {
                    width: 100%;
                    overflow-x: auto;
                    -webkit-overflow-scrolling: touch;
                }

                .main-menu-item {
                    padding: 12px 16px;
                    font-size: 14px;
                }

                .main-menu-item i {
                    font-size: 18px;
                }
            }

            /* Profile Dropdown Mobile Positioning */
            .profile-dropdown {
                /* Ensure dropdown doesn't go off-screen on mobile */
                right: 0 !important;
                left: auto !important;
                max-width: calc(100vw - 40px) !important; /* Account for 20px padding on each side */
                min-width: 180px !important; /* Slightly smaller for mobile */
            }

            /* For very small screens, make dropdown full-width */
            @media (max-width: 375px) {
                .profile-dropdown {
                    position: fixed !important;
                    top: 60px !important; /* Account for stacked header */
                    right: 20px !important;
                    left: 20px !important;
                    max-width: none !important;
                    min-width: auto !important;
                    width: calc(100vw - 40px) !important;
                    z-index: 3000 !important; /* Higher z-index for fixed positioning */
                }

                .profile-dropdown-item {
                    padding: 16px !important; /* Larger touch targets */
                    font-size: 14px !important;
                }

                .profile-dropdown-item i {
                    font-size: 18px !important;
                    margin-right: 12px !important;
                }
            }

            /* Profile dropdown backdrop for mobile */
            .profile-dropdown.active::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.1);
                z-index: -1;
                pointer-events: none;
            }

            @media (max-width: 375px) {
                .profile-dropdown.active::before {
                    pointer-events: auto;
                }
            }

            /* Form & Input Mobile Optimization */
            .form-group input,
            .form-group textarea,
            .form-group select,
            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="number"],
            input[type="tel"],
            input[type="url"],
            textarea,
            select {
                min-height: 48px !important; /* WCAG 2.1 AA touch target requirement */
                padding: 14px 12px !important; /* Increased padding for better touch */
                font-size: 16px !important; /* Prevents iOS zoom on focus */
                line-height: 1.2 !important;
                border-radius: 8px !important; /* Larger radius for modern mobile feel */
                -webkit-appearance: none !important; /* Remove iOS default styling */
                -webkit-tap-highlight-color: transparent !important;
                touch-action: manipulation !important;
            }

            /* Textarea specific mobile optimization */
            textarea {
                min-height: 88px !important; /* Allow for 2+ lines of text */
                padding: 14px 12px !important;
                resize: vertical !important;
                line-height: 1.4 !important;
            }

            /* Select dropdowns mobile optimization */
            select {
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
                background-position: right 12px center !important;
                background-repeat: no-repeat !important;
                background-size: 16px !important;
                padding-right: 40px !important;
                cursor: pointer !important;
            }

            /* Button mobile optimization */
            button,
            .btn,
            input[type="submit"],
            input[type="button"] {
                min-height: 48px !important;
                min-width: 48px !important;
                padding: 14px 20px !important;
                font-size: 16px !important;
                border-radius: 8px !important;
                -webkit-tap-highlight-color: transparent !important;
                touch-action: manipulation !important;
                cursor: pointer !important;
                transition: all 0.2s !important;
            }

            /* Small buttons (for icon-only) still meet touch targets */
            .btn-sm,
            .small-button {
                min-height: 44px !important;
                min-width: 44px !important;
                padding: 10px 16px !important;
                font-size: 14px !important;
            }

            /* Focus styles for mobile accessibility */
            .form-group input:focus,
            .form-group textarea:focus,
            .form-group select:focus,
            input:focus,
            textarea:focus,
            select:focus {
                outline: 3px solid rgba(0, 102, 204, 0.3) !important;
                outline-offset: 2px !important;
                border-color: var(--color-primary-blue) !important;
            }

            /* Form layout mobile optimization */
            .form-group {
                margin-bottom: 20px !important; /* More space between form elements */
            }

            .form-group label {
                font-size: 16px !important; /* Larger labels for readability */
                margin-bottom: 8px !important;
                font-weight: 600 !important;
            }

            /* Multi-column forms to single column on mobile */
            .form-row,
            .form-columns {
                display: flex !important;
                flex-direction: column !important;
                gap: 16px !important;
            }

            /* Grid layouts to single column on mobile */
            .skills-competencies-grid,
            .two-column-grid,
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }

            /* Mobile form section spacing */
            .form-section,
            .field-group {
                margin-bottom: 24px !important;
            }

            /* Form buttons mobile layout */
            .form-actions,
            .button-group {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
                margin-top: 24px !important;
            }

            .form-actions .btn,
            .button-group .btn {
                width: 100% !important;
                justify-content: center !important;
            }

            /* Modal form mobile optimizations */
            .modal-body .form-group:last-child {
                margin-bottom: 0 !important;
            }

            .modal-footer .form-actions {
                margin-top: 0 !important;
                flex-direction: row !important; /* Keep modal footer buttons horizontal */
                gap: 8px !important;
            }

            .modal-footer .btn {
                flex: 1 !important;
            }

            /* Date and time input mobile optimization */
            input[type="date"],
            input[type="time"],
            input[type="datetime-local"] {
                min-height: 48px !important;
                padding: 12px !important;
                font-size: 16px !important;
                -webkit-appearance: none !important;
                background-color: white !important;
                cursor: pointer !important;
            }

            /* Inline form elements stack on mobile */
            .inline-form,
            .horizontal-form {
                display: flex !important;
                flex-direction: column !important;
                gap: 16px !important;
            }

            .inline-form .form-group,
            .horizontal-form .form-group {
                margin-bottom: 0 !important;
            }

            /* Document Editor Toolbar Mobile Optimization */
            #quillToolbar {
                padding: 12px 16px !important;
                gap: 6px !important;
                flex-wrap: wrap !important;
                justify-content: flex-start !important;
                max-height: 120px !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                border-bottom: 2px solid var(--color-neutral-border) !important;
            }

            /* Toolbar buttons mobile optimization */
            #quillToolbar button,
            .quill-toolbar-button {
                min-width: 44px !important;
                min-height: 44px !important;
                padding: 10px !important;
                margin: 2px !important;
                border-radius: 8px !important;
                font-size: 16px !important;
                -webkit-tap-highlight-color: transparent !important;
                touch-action: manipulation !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* Toolbar button groups - add visual separation */
            #quillToolbar .toolbar-group {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 4px !important;
                padding: 4px 6px !important;
                border-radius: 8px !important;
                background: rgba(0, 0, 0, 0.02) !important;
                margin: 2px !important;
            }

            /* Toolbar dropdowns mobile optimization */
            #quillToolbar select {
                min-height: 44px !important;
                padding: 10px 12px !important;
                font-size: 14px !important;
                border-radius: 8px !important;
                margin: 2px !important;
            }

            /* Hide less essential toolbar buttons on very small screens */
            @media (max-width: 375px) {
                #quillToolbar {
                    padding: 8px 12px !important;
                    max-height: 100px !important;
                }

                /* Hide advanced formatting on very small screens to save space */
                #quillToolbar .toolbar-advanced {
                    display: none !important;
                }
            }

            /* Quill editor content mobile optimization */
            #quillEditor {
                padding: 20px 16px !important;
                font-size: 16px !important; /* Prevent iOS zoom */
                line-height: 1.5 !important;
                -webkit-overflow-scrolling: touch !important;
            }

            /* Document editor modal mobile optimization */
            #documentEditorModal #quillEditorContainer {
                height: calc(100vh - 120px) !important; /* Account for toolbar height */
            }

            /* Code editor / other editor toolbar optimization */
            .editor-toolbar,
            .code-toolbar {
                flex-wrap: wrap !important;
                padding: 8px 12px !important;
                gap: 4px !important;
                max-height: 100px !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            .editor-toolbar button,
            .code-toolbar button {
                min-width: 44px !important;
                min-height: 44px !important;
                padding: 10px !important;
                margin: 2px !important;
                font-size: 14px !important;
                border-radius: 6px !important;
                -webkit-tap-highlight-color: transparent !important;
                touch-action: manipulation !important;
            }

            /* Mobile Spacing System & Typography */
            :root {
                /* Mobile spacing scale */
                --mobile-space-xs: 4px;
                --mobile-space-sm: 8px;
                --mobile-space-md: 12px;
                --mobile-space-lg: 16px;
                --mobile-space-xl: 20px;
                --mobile-space-xxl: 24px;
                --mobile-space-xxxl: 32px;

                /* Mobile typography scale */
                --mobile-font-xs: 12px;
                --mobile-font-sm: 14px;
                --mobile-font-md: 16px; /* Base font size - prevents iOS zoom */
                --mobile-font-lg: 18px;
                --mobile-font-xl: 20px;
                --mobile-font-xxl: 24px;
                --mobile-font-xxxl: 28px;

                /* Mobile line heights */
                --mobile-line-height-tight: 1.2;
                --mobile-line-height-normal: 1.4;
                --mobile-line-height-relaxed: 1.6;
                --mobile-line-height-loose: 1.8;
            }

            /* Mobile Typography System */
            body {
                font-size: var(--mobile-font-md) !important;
                line-height: var(--mobile-line-height-normal) !important;
                -webkit-text-size-adjust: 100% !important; /* Prevent text scaling */
            }

            /* Heading mobile optimization */
            h1 {
                font-size: var(--mobile-font-xxxl) !important;
                line-height: var(--mobile-line-height-tight) !important;
                margin-bottom: var(--mobile-space-lg) !important;
            }

            h2 {
                font-size: var(--mobile-font-xxl) !important;
                line-height: var(--mobile-line-height-tight) !important;
                margin-bottom: var(--mobile-space-md) !important;
            }

            h3 {
                font-size: var(--mobile-font-xl) !important;
                line-height: var(--mobile-line-height-tight) !important;
                margin-bottom: var(--mobile-space-sm) !important;
            }

            h4, h5, h6 {
                font-size: var(--mobile-font-lg) !important;
                line-height: var(--mobile-line-height-normal) !important;
                margin-bottom: var(--mobile-space-sm) !important;
            }

            /* Paragraph and body text */
            p {
                font-size: var(--mobile-font-md) !important;
                line-height: var(--mobile-line-height-relaxed) !important;
                margin-bottom: var(--mobile-space-lg) !important;
            }

            /* Small text */
            small, .text-small {
                font-size: var(--mobile-font-sm) !important;
                line-height: var(--mobile-line-height-normal) !important;
            }

            /* Large text */
            .text-large {
                font-size: var(--mobile-font-lg) !important;
                line-height: var(--mobile-line-height-normal) !important;
            }

            /* Mobile spacing utilities */
            .mobile-space-stack > * + * {
                margin-top: var(--mobile-space-lg) !important;
            }

            .mobile-space-compact > * + * {
                margin-top: var(--mobile-space-sm) !important;
            }

            /* Card spacing mobile optimization */
            .card,
            .story-card,
            .mobile-file-card,
            .job-card {
                padding: var(--mobile-space-lg) !important;
                margin-bottom: var(--mobile-space-lg) !important;
                border-radius: var(--mobile-space-sm) !important;
            }

            /* Section spacing */
            .section,
            .canvas-description,
            .modal-body,
            .slideout-body {
                padding: var(--mobile-space-lg) var(--mobile-space-lg) !important;
            }

            /* Header spacing */
            .modal-header,
            .slideout-header,
            .canvas-modal-header {
                padding: var(--mobile-space-md) var(--mobile-space-lg) !important;
            }

            /* Button spacing improvements */
            .btn-group {
                gap: var(--mobile-space-sm) !important;
            }

            .btn {
                margin: var(--mobile-space-xs) !important;
            }

            /* List spacing */
            ul, ol {
                padding-left: var(--mobile-space-xl) !important;
                margin-bottom: var(--mobile-space-lg) !important;
            }

            li {
                margin-bottom: var(--mobile-space-xs) !important;
                line-height: var(--mobile-line-height-relaxed) !important;
            }

            /* Table spacing */
            table {
                margin-bottom: var(--mobile-space-lg) !important;
            }

            th, td {
                padding: var(--mobile-space-sm) var(--mobile-space-md) !important;
            }

            /* Mobile readability enhancements */
            .readable-text {
                font-size: var(--mobile-font-md) !important;
                line-height: var(--mobile-line-height-relaxed) !important;
                max-width: 100% !important;
                word-wrap: break-word !important;
                hyphens: auto !important;
            }

            /* Link spacing for touch targets */
            a {
                padding: var(--mobile-space-xs) !important;
                margin: calc(-1 * var(--mobile-space-xs)) !important;
                border-radius: 4px !important;
                min-height: 44px !important;
                display: inline-flex !important;
                align-items: center !important;
            }

            /* Code spacing */
            code {
                padding: var(--mobile-space-xs) var(--mobile-space-sm) !important;
                font-size: var(--mobile-font-sm) !important;
                border-radius: 4px !important;
            }

            pre {
                padding: var(--mobile-space-md) !important;
                margin-bottom: var(--mobile-space-lg) !important;
                border-radius: var(--mobile-space-sm) !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            /* Swipe-to-close visual feedback for slideouts */
            .interview-slideout.swiping {
                transition: none !important; /* Disable transition during swipe */
            }

            .interview-slideout.snap-back {
                transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1) !important;
                transform: translateX(0) !important;
            }

            .interview-slideout.snap-close {
                transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1) !important;
                transform: translateX(100%) !important;
            }

            /* Bottom Sheet Mobile Alternative */
            @media (max-width: 480px) {
                .interview-slideout {
                    top: auto !important;
                    bottom: -100% !important;
                    right: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 70vh !important;
                    max-height: calc(100vh - 60px) !important;
                    border-radius: 24px 24px 0 0 !important;
                    transition: bottom 0.4s cubic-bezier(0.4, 0.0, 0.2, 1) !important;
                    box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15) !important;
                }

                .interview-slideout.active {
                    bottom: 0 !important;
                    right: auto !important;
                }

                .interview-slideout.sliding-out {
                    bottom: -100% !important;
                }

                /* Bottom sheet specific styles */
                .interview-slideout .slideout-header {
                    position: relative !important;
                    padding: 20px 24px 16px 24px !important;
                    text-align: center !important;
                    border-bottom: 1px solid var(--color-neutral-border) !important;
                }

                /* Add visual handle for bottom sheet */
                .interview-slideout .slideout-header::before {
                    content: '' !important;
                    position: absolute !important;
                    top: 12px !important;
                    left: 50% !important;
                    transform: translateX(-50%) !important;
                    width: 40px !important;
                    height: 4px !important;
                    background: var(--color-neutral-text-light) !important;
                    border-radius: 2px !important;
                    opacity: 0.5 !important;
                }

                .interview-slideout .slideout-close {
                    position: absolute !important;
                    top: 16px !important;
                    right: 20px !important;
                    width: 32px !important;
                    height: 32px !important;
                    background: rgba(0, 0, 0, 0.1) !important;
                    border-radius: 50% !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    font-size: 18px !important;
                    color: var(--color-neutral-text) !important;
                    border: none !important;
                    cursor: pointer !important;
                }

                .interview-slideout .slideout-close:hover {
                    background: rgba(0, 0, 0, 0.15) !important;
                }

                /* Modify swipe behavior for bottom sheets */
                .interview-slideout.swiping {
                    transition: none !important;
                }

                .interview-slideout.snap-back {
                    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1) !important;
                    transform: translateY(0) !important;
                }

                .interview-slideout.snap-close {
                    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1) !important;
                    transform: translateY(100%) !important;
                }

                /* Add backdrop for bottom sheets */
                .bottom-sheet-backdrop {
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    background: rgba(0, 0, 0, 0.4) !important;
                    z-index: 999 !important;
                    opacity: 0 !important;
                    transition: opacity 0.3s ease !important;
                    pointer-events: none !important;
                }

                .bottom-sheet-backdrop.active {
                    opacity: 1 !important;
                    pointer-events: auto !important;
                }
            }

            /* Long-press Context Menu Styles */
            .context-menu {
                position: fixed !important;
                background: white !important;
                border-radius: 12px !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2) !important;
                z-index: 10000 !important;
                padding: 8px 0 !important;
                min-width: 200px !important;
                opacity: 0 !important;
                transform: scale(0.9) translateY(10px) !important;
                transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1) !important;
                pointer-events: none !important;
            }

            .context-menu.active {
                opacity: 1 !important;
                transform: scale(1) translateY(0) !important;
                pointer-events: auto !important;
            }

            .context-menu-item {
                width: 100% !important;
                padding: 12px 16px !important;
                border: none !important;
                background: none !important;
                text-align: left !important;
                display: flex !important;
                align-items: center !important;
                gap: 12px !important;
                font-family: var(--font-family-ui) !important;
                font-size: 15px !important;
                color: var(--color-dark) !important;
                cursor: pointer !important;
                transition: background 0.15s ease !important;
                min-height: 48px !important; /* Touch target */
                touch-action: manipulation !important;
                -webkit-tap-highlight-color: transparent !important;
            }

            .context-menu-item:hover,
            .context-menu-item:active {
                background: var(--color-neutral-background) !important;
            }

            .context-menu-item i {
                font-size: 18px !important;
                color: var(--color-primary-blue) !important;
                flex-shrink: 0 !important;
            }

            .context-menu-item:last-child {
                border-top: 1px solid var(--color-neutral-border) !important;
            }

            .context-menu-item:last-child i {
                color: #dc2626 !important; /* Red for delete */
            }

            .context-menu-backdrop {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: rgba(0, 0, 0, 0.1) !important;
                z-index: 9999 !important;
                opacity: 0 !important;
                transition: opacity 0.2s ease !important;
                pointer-events: none !important;
            }

            .context-menu-backdrop.active {
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            /* One-handed Usage Optimization */
            .one-handed-mode .floating-action-button {
                bottom: 24px !important;
                right: 24px !important;
            }

            .reachability-button {
                display: flex !important;
                align-items: center !important;
                gap: 12px !important;
                width: 100% !important;
                padding: 16px 20px !important;
                margin-bottom: 8px !important;
                background: var(--color-neutral-background) !important;
                border: 1px solid var(--color-neutral-border) !important;
                border-radius: 12px !important;
                font-family: var(--font-family-ui) !important;
                font-size: 16px !important;
                color: var(--color-dark) !important;
                cursor: pointer !important;
                transition: all 0.15s ease !important;
                min-height: 56px !important; /* Larger for easy thumb access */
                touch-action: manipulation !important;
                -webkit-tap-highlight-color: transparent !important;
            }

            .reachability-button:hover,
            .reachability-button:active {
                background: white !important;
                border-color: var(--color-primary-blue) !important;
                transform: scale(0.98) !important;
            }

            .reachability-button i {
                font-size: 20px !important;
                color: var(--color-primary-blue) !important;
                flex-shrink: 0 !important;
            }

            .reachability-button:last-of-type {
                margin-bottom: 0 !important;
            }

            /* Thumb-friendly adjustments for large screens */
            @media (min-width: 375px) and (max-width: 480px) and (min-height: 667px) {
                /* Large mobile devices - optimize for thumb reach */
                .slideout-close,
                .modal-close {
                    bottom: 20px !important;
                    top: auto !important;
                    right: 20px !important;
                    transform: none !important;
                }

                .canvas-modal-header {
                    position: sticky !important;
                    top: 0 !important;
                    z-index: 100 !important;
                }

                /* Make primary actions more thumb-accessible */
                .add-story-btn {
                    position: sticky !important;
                    bottom: 16px !important;
                    margin-top: 20px !important;
                    z-index: 10 !important;
                }

                /* Thumb zone visual indicator (dev mode) */
                .thumb-zone-indicator {
                    display: block;
                }
            }

            /* Ultra-large mobile devices (iPhone Plus, Max models) */
            @media (min-width: 414px) and (max-width: 480px) and (min-height: 736px) {
                .reachability-menu {
                    max-height: 50vh !important;
                    overflow-y: auto !important;
                }

                /* Move critical actions even closer to thumb */
                .main-menu {
                    position: sticky !important;
                    bottom: 0 !important;
                    background: var(--color-dark) !important;
                    z-index: 100 !important;
                    border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
                }
            }
        }

        /* Toggle Switch Styles */
        #cleansheetAiToggle:checked + span {
            background-color: var(--color-primary-blue);
        }

        #cleansheetAiToggle:checked + span + span {
            transform: translateX(24px);
        }

        .integration-header:hover {
            background: #f8f9fa !important;
        }

        /* Info Icon Tooltips (ML Pipeline Pattern) */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-neutral-background);
            color: var(--color-neutral-text-light);
            font-size: 12px;
            cursor: help;
            margin-left: 6px;
            position: relative;
            transition: all 0.2s;
        }

        .info-icon:hover {
            background: var(--color-primary-blue);
            color: white;
        }

        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .hover-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-dark);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: var(--font-family-body);
            font-size: 13px;
            line-height: 1.5;
            white-space: normal;
            width: 320px;
            max-width: 90vw;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }

        .hover-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--color-dark);
        }

        .info-icon:hover .hover-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Modal (Pipeline Edit Pattern) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-neutral-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1a1a1a;
        }

        .modal-title {
            font-family: var(--font-family-ui);
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .modal-close {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .modal-close:focus {
            outline: 3px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
        }

        .modal-close:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.98);
        }

        /* Install Button Hover */
        #installButton:hover {
            background: var(--color-accent-blue) !important;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3) !important;
            transform: translateY(-1px);
        }

        /* Attach Prompt Button Hover (when enabled) */
        #attachPromptButton:not(:disabled):hover {
            background: #dcfce7 !important;
            border-color: #16a34a !important;
            box-shadow: 0 2px 8px rgba(22, 163, 74, 0.2) !important;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--color-neutral-border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Button Styles for Modal */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-family: var(--font-family-ui);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-accent-blue);
        }

        .btn-secondary {
            background: white;
            color: var(--color-dark);
            border: 1px solid var(--color-neutral-border);
        }

        .btn-secondary:hover {
            background: var(--color-neutral-background);
        }

        /* Block-level Quill Editor Styles */
        .document-block .ql-container {
            font-family: var(--font-family-body);
            font-size: 14px;
            border: none;
        }

        .document-block .ql-editor {
            min-height: 150px;
            padding: 12px 0;
        }

        .document-block .ql-toolbar {
            border: none;
            border-bottom: 1px solid var(--color-neutral-border);
            padding: 8px 0;
            background: var(--color-neutral-background);
            border-radius: 4px 4px 0 0;
            margin-bottom: 8px;
        }

        .document-block .ql-editor.ql-blank::before {
            color: var(--color-neutral-text-light);
            font-style: normal;
        }

        .document-block .ql-snow .ql-stroke {
            stroke: var(--color-neutral-text);
        }

        .document-block .ql-snow .ql-fill {
            fill: var(--color-neutral-text);
        }

        .document-block .ql-snow .ql-picker-label {
            color: var(--color-neutral-text);
        }

        .document-block .ql-toolbar button:hover,
        .document-block .ql-toolbar button:focus,
        .document-block .ql-toolbar button.ql-active {
            color: var(--color-primary-blue);
        }

        .document-block .ql-toolbar button:hover .ql-stroke,
        .document-block .ql-toolbar button:focus .ql-stroke,
        .document-block .ql-toolbar button.ql-active .ql-stroke {
            stroke: var(--color-primary-blue);
        }

        .document-block .ql-toolbar button:hover .ql-fill,
        .document-block .ql-toolbar button:focus .ql-fill,
        .document-block .ql-toolbar button.ql-active .ql-fill {
            fill: var(--color-primary-blue);
        }

        /* Block Control Buttons */
        .block-control-btn:hover {
            background: var(--color-neutral-background) !important;
            color: var(--color-primary-blue) !important;
        }

        .block-control-btn:hover i {
            color: var(--color-primary-blue);
        }

        .block-control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed !important;
        }

        /* Drag Handle */
        .document-block:hover .drag-handle {
            opacity: 1 !important;
        }

        .drag-handle:hover {
            background: var(--color-neutral-background) !important;
            color: var(--color-primary-blue) !important;
        }

        .drag-handle:hover i {
            color: var(--color-primary-blue);
        }

        .drag-handle:active {
            cursor: grabbing !important;
        }

        /* Dragging State */
        .document-block.dragging {
            opacity: 0.4;
            border: 2px dashed var(--color-primary-blue);
        }

        .document-block.drag-over {
            border-top: 3px solid var(--color-primary-blue);
        }

        /* Focus State for Keyboard Navigation */
        .document-block:focus {
            outline: 2px solid var(--color-primary-blue);
            outline-offset: 2px;
        }

        .document-block:focus .drag-handle {
            opacity: 1 !important;
        }

        /* Markdown Preview Styles */
        .markdown-preview {
            color: var(--color-dark);
        }

        .markdown-preview h1,
        .markdown-preview h2,
        .markdown-preview h3,
        .markdown-preview h4,
        .markdown-preview h5,
        .markdown-preview h6 {
            font-family: var(--font-family-ui);
            font-weight: 600;
            margin-top: 16px;
            margin-bottom: 8px;
            color: var(--color-dark);
        }

        .markdown-preview h1 { font-size: 28px; }
        .markdown-preview h2 { font-size: 24px; }
        .markdown-preview h3 { font-size: 20px; }
        .markdown-preview h4 { font-size: 18px; }
        .markdown-preview h5 { font-size: 16px; }
        .markdown-preview h6 { font-size: 14px; }

        .markdown-preview p {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .markdown-preview ul,
        .markdown-preview ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .markdown-preview li {
            margin-bottom: 4px;
        }

        .markdown-preview code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }

        .markdown-preview pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 12px;
        }

        .markdown-preview pre code {
            background: none;
            padding: 0;
        }

        .markdown-preview blockquote {
            border-left: 4px solid var(--color-primary-blue);
            padding-left: 16px;
            margin-left: 0;
            margin-bottom: 12px;
            color: var(--color-neutral-text);
        }

        .markdown-preview a {
            color: var(--color-primary-blue);
            text-decoration: none;
        }

        .markdown-preview a:hover {
            text-decoration: underline;
        }

        .markdown-preview table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 12px;
        }

        .markdown-preview th,
        .markdown-preview td {
            border: 1px solid var(--color-neutral-border);
            padding: 8px 12px;
            text-align: left;
        }

        .markdown-preview th {
            background: var(--color-neutral-background);
            font-weight: 600;
        }

        .markdown-preview img {
            max-width: 100%;
            height: auto;
        }

        /* Preview button active state */
        .markdown-preview-btn[data-mode="preview"] {
            background: var(--color-primary-blue) !important;
            color: white !important;
        }

        .markdown-preview-btn[data-mode="preview"] i {
            color: white;
        }

        /* Table Selector Cards */
        .document-block [onclick^="createCleansheetTable"]:hover,
        .document-block [onclick^="connectCleansheetTable"]:hover,
        .document-block [onclick^="connectDataSource"]:hover {
            border-color: var(--color-primary-blue) !important;
            background: var(--color-neutral-background) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 102, 204, 0.1);
        }

        /* Example Profiles Button Hover */
        .example-profiles-btn:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
        }

        /* Example Profile Item Hover */
        .example-profile-item:hover {
            border-color: var(--color-primary-blue) !important;
            background: #f8f9fa !important;
        }

        /* ==================== */
        /* Tour System Styles   */
        /* ==================== */

        /* Tour overlay animations */
        #tourOverlay {
            animation: fadeIn 0.3s ease;
        }

        #tourCard {
            animation: slideUp 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tour button hover effects */
        #tourNextBtn:hover,
        #tourPrevBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        #tourNextBtn:active,
        #tourPrevBtn:active {
            transform: translateY(0);
        }

        #tourSkipBtn:hover {
            background: #f8f9fa;
            border-color: var(--color-neutral-text);
        }

        /* Tour header close button hover */
        #tourCardHeader button:hover {
            background: rgba(255, 255, 255, 0.3) !important;
            transform: scale(1.05);
        }

        #tourCardHeader button:active {
            transform: scale(0.95);
        }

        /* Tour spotlight pulse effect */
        #tourSpotlight {
            animation: spotlightPulse 2s ease-in-out infinite;
        }

        @keyframes spotlightPulse {
            0%, 100% {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 30px 5px rgba(0, 102, 204, 0.8), inset 0 0 0 2px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 40px 8px rgba(0, 102, 204, 1), inset 0 0 0 2px rgba(255, 255, 255, 0.4);
            }
        }

        /* Start Tour Button in Description Bar */
        #startTourBtn {
            position: relative;
            overflow: hidden;
        }

        #startTourBtn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        #startTourBtn:hover::before {
            width: 300px;
            height: 300px;
        }

        #startTourBtn:active {
            transform: scale(0.95) !important;
        }

        /* Markdown Preview Styles - Dark Mode */
        #markdownPreview h1 {
            font-family: var(--font-family-ui);
            font-size: 32px;
            font-weight: 700;
            margin: 24px 0 16px 0;
            color: #ffffff;
            border-bottom: 2px solid #404040;
            padding-bottom: 8px;
        }

        #markdownPreview h2 {
            font-family: var(--font-family-ui);
            font-size: 26px;
            font-weight: 600;
            margin: 20px 0 12px 0;
            color: #ffffff;
        }

        #markdownPreview h3 {
            font-family: var(--font-family-ui);
            font-size: 20px;
            font-weight: 600;
            margin: 16px 0 10px 0;
            color: #ffffff;
        }

        #markdownPreview h4, #markdownPreview h5, #markdownPreview h6 {
            font-family: var(--font-family-ui);
            font-weight: 600;
            margin: 12px 0 8px 0;
            color: #ffffff;
        }

        #markdownPreview p {
            margin: 0 0 16px 0;
            line-height: 1.7;
            color: #d4d4d4;
        }

        #markdownPreview ul, #markdownPreview ol {
            margin: 0 0 16px 0;
            padding-left: 28px;
            color: #d4d4d4;
        }

        #markdownPreview li {
            margin: 4px 0;
        }

        #markdownPreview a {
            color: #4db8ff;
            text-decoration: none;
        }

        #markdownPreview a:hover {
            text-decoration: underline;
        }

        #markdownPreview code {
            background: #2d2d2d;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            color: #ce9178;
        }

        #markdownPreview pre {
            background: #0d1117;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0 0 16px 0;
            border: 1px solid #404040;
        }

        #markdownPreview pre code {
            background: none;
            padding: 0;
            color: inherit;
            font-size: 13px;
        }

        #markdownPreview blockquote {
            border-left: 4px solid #4db8ff;
            padding-left: 16px;
            margin: 0 0 16px 0;
            color: #8b949e;
            font-style: italic;
        }

        #markdownPreview table {
            border-collapse: collapse;
            width: 100%;
            margin: 0 0 16px 0;
        }

        #markdownPreview table th,
        #markdownPreview table td {
            border: 1px solid #404040;
            padding: 8px 12px;
            text-align: left;
            color: #d4d4d4;
        }

        #markdownPreview table th {
            background: #2d2d2d;
            font-family: var(--font-family-ui);
            font-weight: 600;
            color: #ffffff;
        }

        #markdownPreview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
        }

        #markdownPreview hr {
            border: none;
            border-top: 2px solid #404040;
            margin: 24px 0;
        }

        #markdownPreview strong {
            color: #ffffff;
        }

        #markdownPreview em {
            color: #d4d4d4;
        }

    </style>
</head>
<body>
    <!-- Visually hidden h1 for accessibility and SEO -->
    <h1 style="position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden;">Cleansheet Career Canvas - Interactive Career Management Platform</h1>

    <!-- Canvas Modal -->
    <div class="canvas-modal" id="canvasModal">
        <div class="canvas-modal-content">
            <div class="canvas-modal-header">
                <!-- Main Menu -->
                <div class="main-menu">
                    <!-- Logo -->
                    <a href="index.html" style="display: flex; align-items: center; margin-right: 16px;">
                        <img src="assets/high-resolution-logo-files/white-on-transparent.png" alt="Cleansheet Logo" style="height: 32px; width: auto;">
                    </a>

                    <!-- Navigation Tabs (Desktop) -->
                    <div class="main-menu-nav-items">
                        <button class="main-menu-item active" onclick="switchCanvasTab('canvas')">
                            <i class="ph ph-tree-structure"></i>
                            <span>Canvas</span>
                        </button>
                        <button class="main-menu-item" onclick="switchCanvasTab('paths')">
                            <i class="ph ph-path"></i>
                            <span>Paths</span>
                        </button>
                        <button class="main-menu-item" onclick="switchCanvasTab('roles')">
                            <i class="ph ph-buildings"></i>
                            <span>Industry</span>
                        </button>
                        <button class="main-menu-item" onclick="switchCanvasTab('library')">
                            <i class="ph ph-books"></i>
                            <span>Library</span>
                        </button>
                        <div style="position: relative;">
                            <button class="main-menu-item" onclick="toggleAboutDropdown()">
                                <i class="ph ph-info"></i>
                                <span>About</span>
                            </button>
                            <div class="about-dropdown" id="aboutDropdown">
                                <div class="about-dropdown-menu">
                                    <button class="about-dropdown-item" onclick="closeInterviewSlideout(); openAboutModal(); document.getElementById('aboutDropdown').classList.remove('active');">
                                        <i class="ph ph-info"></i>
                                        <span>About Cleansheet Canvas</span>
                                    </button>
                                    <a href="about-cleansheet.html" target="_blank" rel="noopener noreferrer" class="about-dropdown-item" onclick="closeInterviewSlideout(); document.getElementById('aboutDropdown').classList.remove('active');">
                                        <i class="ph ph-buildings"></i>
                                        <span>About Cleansheet</span>
                                        <i class="ph ph-arrow-square-out external-link-icon"></i>
                                    </a>
                                    <a href="whitepapers/index.html" target="_blank" rel="noopener noreferrer" class="about-dropdown-item" onclick="closeInterviewSlideout(); document.getElementById('aboutDropdown').classList.remove('active');">
                                        <i class="ph ph-lightbulb"></i>
                                        <span>White Papers</span>
                                        <i class="ph ph-arrow-square-out external-link-icon"></i>
                                    </a>
                                    <a href="privacy-policy.html" target="_blank" rel="noopener noreferrer" class="about-dropdown-item" onclick="closeInterviewSlideout(); document.getElementById('aboutDropdown').classList.remove('active');">
                                        <i class="ph ph-lock"></i>
                                        <span>Privacy Policy</span>
                                        <i class="ph ph-arrow-square-out external-link-icon"></i>
                                    </a>
                                    <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer" class="about-dropdown-item" onclick="closeInterviewSlideout(); document.getElementById('aboutDropdown').classList.remove('active');">
                                        <i class="ph ph-file-text"></i>
                                        <span>Terms of Service</span>
                                        <i class="ph ph-arrow-square-out external-link-icon"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Menu Toggle -->
                    <button class="mobile-menu-toggle" onclick="toggleMobileMainMenu()" aria-label="Toggle navigation menu">
                        <i class="ph ph-list" id="mobileMenuIcon"></i>
                    </button>

                    <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
                        <!-- Profile Circle -->
                        <div class="profile-circle">
                            <div class="profile-avatar" id="profileAvatar" onclick="toggleProfileDropdown()">
                                <span id="profileInitials">AM</span>
                            </div>
                            <div class="profile-dropdown" id="profileDropdown">
                                <div class="profile-dropdown-header">
                                    <div class="profile-dropdown-name" id="profileName">Alex Martinez</div>
                                    <div class="profile-dropdown-role" id="profileRole">Retail Manager</div>
                                </div>
                                <div class="profile-dropdown-menu">
                                    <button class="profile-dropdown-item" onclick="openProfileSettings()">
                                        <i class="ph ph-user-circle"></i>
                                        <span>Profile</span>
                                    </button>
                                    <button class="profile-dropdown-item" onclick="openPromptBuilder()">
                                        <i class="ph ph-chat-text"></i>
                                        <span>Prompt</span>
                                    </button>
                                    <button class="profile-dropdown-item" onclick="openDataManagementModal()">
                                        <i class="ph ph-database"></i>
                                        <span>Data Management</span>
                                    </button>
                                    <button class="profile-dropdown-item" onclick="openInstallAppModal()">
                                        <i class="ph ph-download-simple"></i>
                                        <span>Install App</span>
                                    </button>
                                    <button class="profile-dropdown-item" onclick="openSupportModal()">
                                        <i class="ph ph-lifebuoy"></i>
                                        <span>Support</span>
                                    </button>
                                    <button class="profile-dropdown-item" onclick="openErasureRequestModal()">
                                        <i class="ph ph-trash"></i>
                                        <span>Erasure Request</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Navigation Dropdown -->
                    <div class="main-menu-dropdown" id="mobileMainMenuDropdown">
                        <button class="main-menu-item active" onclick="switchCanvasTab('canvas'); toggleMobileMainMenu()">
                            <i class="ph ph-tree-structure"></i>
                            <span>Canvas</span>
                        </button>
                        <button class="main-menu-item" onclick="switchCanvasTab('paths'); toggleMobileMainMenu()">
                            <i class="ph ph-path"></i>
                            <span>Paths</span>
                        </button>
                        <button class="main-menu-item" onclick="switchCanvasTab('roles'); toggleMobileMainMenu()">
                            <i class="ph ph-buildings"></i>
                            <span>Industry</span>
                        </button>
                        <button class="main-menu-item" onclick="switchCanvasTab('library'); toggleMobileMainMenu()">
                            <i class="ph ph-books"></i>
                            <span>Library</span>
                        </button>
                        <button class="main-menu-item" onclick="openAboutModal(); toggleMobileMainMenu()">
                            <i class="ph ph-info"></i>
                            <span>About Cleansheet Canvas</span>
                        </button>
                        <button class="main-menu-item" onclick="window.open('about-cleansheet.html', '_blank'); toggleMobileMainMenu()">
                            <i class="ph ph-buildings"></i>
                            <span>About Cleansheet</span>
                        </button>
                        <button class="main-menu-item" onclick="window.open('whitepapers/index.html', '_blank'); toggleMobileMainMenu()">
                            <i class="ph ph-lightbulb"></i>
                            <span>White Papers</span>
                        </button>
                        <button class="main-menu-item" onclick="window.open('privacy-policy.html', '_blank'); toggleMobileMainMenu()">
                            <i class="ph ph-lock"></i>
                            <span>Privacy Policy</span>
                        </button>
                        <button class="main-menu-item" onclick="window.open('terms-of-service.html', '_blank'); toggleMobileMainMenu()">
                            <i class="ph ph-file-text"></i>
                            <span>Terms of Service</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Page Description & Privacy Notice -->
            <div class="canvas-modal-body" id="canvasBody">
                <!-- Left Panel -->
                <div class="left-panel" id="leftPanel">
                    <div class="left-panel-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <h3 style="margin: 0; font-family: var(--font-family-ui); font-size: 18px; font-weight: 600;">Welcome, <span id="leftPanelUserName"></span></h3>
                            <span id="leftPanelTierBadge" onclick="openSubscriptionModal();" style="padding: 4px 12px; background: var(--color-primary-blue); color: white; border-radius: 12px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 2px 8px rgba(0, 102, 204, 0.4)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">Seeker</span>
                        </div>
                    </div>

                    <!-- Status Bar -->
                    <div class="left-panel-status-bar" id="leftPanelStatusBar">
                        <!-- Auth Status -->
                        <div class="status-item" id="leftPanelAuthStatus" data-action="auth">
                            <i class="ph ph-user-circle" id="leftPanelAuthIcon"></i>
                            <div class="status-text">
                                <div class="status-label" id="leftPanelAuthLabel">Not signed in</div>
                                <div class="status-detail" id="leftPanelAuthDetail"></div>
                            </div>
                        </div>

                        <!-- Sync Status -->
                        <div class="status-item" id="leftPanelSyncStatus" data-action="sync">
                            <i class="ph ph-cloud-slash" id="leftPanelSyncIcon"></i>
                            <div class="status-text">
                                <div class="status-label" id="leftPanelSyncLabel">Sync disabled</div>
                                <div class="status-detail" id="leftPanelSyncDetail"></div>
                            </div>
                        </div>
                    </div>

                    <div class="left-panel-body" id="leftPanelBody">
                        <!-- Chat Container -->
                        <div class="chat-container" id="chatContainer">
                            <!-- Chat Header -->
                            <div class="chat-header">
                                <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                    <h4 style="margin: 0; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">
                                        <i class="ph ph-robot" style="margin-right: 6px;"></i>
                                        AI Career Assistant
                                    </h4>
                                    <div id="providerModelBadge" style="display: none; padding: 4px 10px; border-radius: 12px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; white-space: nowrap; transition: all 0.2s;">
                                        <!-- Populated by updateProviderBadge() -->
                                    </div>
                                </div>
                                <button onclick="openLLMSettingsModal()" title="Settings"
                                        style="background: none; border: none; color: var(--color-neutral-text); cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;">
                                    <i class="ph ph-gear" style="font-size: 18px;"></i>
                                </button>
                            </div>

                            <!-- Messages Area -->
                            <div class="chat-messages" id="chatMessages">
                                <!-- Empty state -->
                                <div id="chatEmptyState" class="chat-empty-state">
                                    <i class="ph ph-robot" style="font-size: 48px; color: var(--color-neutral-border); margin-bottom: 12px;"></i>
                                    <p style="font-family: var(--font-family-body); color: var(--color-neutral-text); text-align: center; margin: 0 0 16px 0; line-height: 1.5;">
                                        Configure your AI assistant to get started
                                    </p>
                                    <button onclick="openLLMSettingsModal()"
                                            style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-weight: 600; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                        <i class="ph ph-gear"></i>
                                        Set Up Now
                                    </button>
                                </div>

                                <!-- Messages will be appended here dynamically -->
                            </div>

                            <!-- Input Area -->
                            <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                                <textarea id="chatInput" placeholder="Ask about your career, experiences, or goals..."
                                          rows="2"
                                          style="width: 100%; padding: 10px; font-family: var(--font-family-body); font-size: 13px; border: 1px solid var(--color-neutral-border); border-radius: 6px; resize: none; box-sizing: border-box;"
                                          onkeydown="handleChatInputKeydown(event)"></textarea>
                                <div style="margin-top: 8px;">
                                    <button onclick="sendChatMessage()" id="sendButton"
                                            style="width: 100%; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-weight: 600; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                        <i class="ph ph-paper-plane-tilt"></i> Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="canvas-mindmap"></div>

                <!-- Left Panel Toggle Button -->
                <button class="left-panel-toggle" id="leftPanelToggle" onclick="toggleLeftPanel()">
                    <i class="ph ph-caret-left"></i>
                </button>

                <!-- Mobile Menu (visible only on mobile) -->
                <div id="mobile-menu" class="mobile-menu">
                    <div class="mobile-menu-grid" id="mobile-menu-grid">
                        <!-- Mobile menu items will be dynamically generated based on subscription tier -->
                    </div>
                </div>

                <!-- Projects View -->
                <div id="projects-view" style="display: none; overflow: hidden; background: var(--color-neutral-background); grid-column: 1 / -1; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; flex-direction: column;">
                    <!-- Projects Header -->
                    <div style="padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border); flex-shrink: 0;">
                        <h2 style="font-family: var(--font-family-ui); font-size: 24px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Projects</h2>
                        <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">Organize your documents, tables, forms, reports, templates, and workflows</p>
                    </div>

                    <!-- Projects Body -->
                    <div style="flex: 1; display: flex; overflow: hidden;">
                        <!-- Left Sidebar - Folder Tree -->
                        <div id="projects-sidebar" style="width: 280px; border-right: 1px solid var(--color-neutral-border); background: var(--color-neutral-background); overflow-y: auto;">
                            <div style="padding: 16px;">
                                <button onclick="createNewFolder()" style="width: 100%; padding: 10px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; justify-content: center; margin-bottom: 16px;">
                                    <i class="ph ph-folder-plus"></i> New Folder
                                </button>
                                <div id="folderTree" style="font-family: var(--font-family-body); font-size: 13px;">
                                    <!-- Folder tree will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Main Content - File Explorer Table -->
                        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                            <!-- Breadcrumb & Toolbar -->
                            <div style="padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: white; flex-shrink: 0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <!-- Mobile Sidebar Toggle Button (Hidden on Desktop) -->
                                        <button id="mobile-sidebar-toggle" onclick="toggleProjectsSidebar()" style="display: none; padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; min-width: 44px; min-height: 44px; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; touch-action: manipulation;">
                                            <i class="ph ph-list" style="font-size: 18px; color: var(--color-neutral-text);"></i>
                                        </button>
                                        <div id="breadcrumb" style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); display: flex; align-items: center; gap: 6px;">
                                            <!-- Breadcrumb will be rendered here -->
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="addItemToCurrentFolder()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                            <i class="ph ph-plus"></i> Add Item
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- File Table -->
                            <div style="flex: 1; overflow-y: auto; background: white;">
                                <table id="fileExplorerTable" style="width: 100%; border-collapse: collapse; font-family: var(--font-family-body); font-size: 13px;">
                                    <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">
                                        <tr style="border-bottom: 1px solid var(--color-neutral-border);">
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Name
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Type
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Created
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Modified
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase;">
                                                Shared With
                                            </th>
                                            <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; font-size: 12px; color: var(--color-neutral-text); text-transform: uppercase; width: 100px;">
                                                Actions
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="fileTableBody">
                                        <!-- File rows will be rendered here -->
                                    </tbody>
                                </table>

                                <!-- Mobile File Cards (Hidden on Desktop) -->
                                <div id="file-cards-container" style="display: none; padding: 16px; gap: 12px; flex-direction: column;">
                                    <!-- File cards will be rendered here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Sidebar Backdrop -->
                    <div id="projects-sidebar-backdrop" onclick="toggleProjectsSidebar()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 200;"></div>
                </div>
            </div>

            <!-- Paths View -->
            <div id="pathsView" style="display: none; flex: 1; padding: 0; overflow: hidden; background: var(--color-dark); min-height: 0;">
                <!-- Content loaded dynamically via iframe -->
            </div>

            <!-- Roles View -->
            <div id="rolesView" style="display: none; flex: 1; padding: 0; overflow: hidden; background: var(--color-dark); min-height: 0;">
                <!-- Content loaded dynamically -->
            </div>

            <!-- Library View -->
            <div id="libraryView" style="display: none; flex: 1; padding: 24px; overflow-y: auto; background: var(--color-neutral-background); min-height: 0;">
                <!-- Content loaded dynamically -->
            </div>

                <!-- Document Editor Modal -->
                <div class="modal" id="documentEditorModal">
                    <div class="modal-content" style="max-width: 1400px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Edit Document</h2>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <!-- Cancel Button -->
                                <button class="btn btn-secondary" onclick="closeModal('documentEditorModal')" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                                    Cancel
                                </button>
                                <!-- Save Changes Button -->
                                <button class="btn btn-primary" onclick="saveDocument()" style="padding: 8px 16px; background: var(--color-primary-blue); border: 1px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: white; cursor: pointer;">
                                    Save Changes
                                </button>
                                <!-- Export Button with Dropdown -->
                                <div style="position: relative;">
                                    <button onclick="toggleExportMenu()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                        <i class="ph ph-export" style="font-size: 16px;"></i>
                                        Export
                                        <i class="ph ph-caret-down" style="font-size: 12px;"></i>
                                    </button>
                                    <!-- Export Dropdown Menu -->
                                    <div id="exportMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); min-width: 180px; z-index: 1100;">
                                        <button onclick="exportDocument('markdown')" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; font-family: var(--font-family-ui); font-size: 13px; font-weight: 500; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                            <i class="ph ph-file-md" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                            Markdown (.md)
                                        </button>
                                        <button onclick="exportDocument('html')" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; font-family: var(--font-family-ui); font-size: 13px; font-weight: 500; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                            <i class="ph ph-file-html" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                            HTML (.html)
                                        </button>
                                        <button onclick="exportDocument('docx')" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; font-family: var(--font-family-ui); font-size: 13px; font-weight: 500; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                            <i class="ph ph-file-doc" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                            Word (.docx)
                                        </button>
                                        <button onclick="exportDocument('pdf')" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; font-family: var(--font-family-ui); font-size: 13px; font-weight: 500; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; border-top: 1px solid var(--color-neutral-border);">
                                            <i class="ph ph-file-pdf" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                            PDF (.pdf)
                                        </button>
                                    </div>
                                </div>
                                <!-- Share Document Button -->
                                <button onclick="shareDocument()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <i class="ph ph-share-network" style="font-size: 16px;"></i>
                                    Share
                                </button>
                                <button class="modal-close" onclick="closeModal('documentEditorModal')">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 0; display: flex; gap: 0; min-height: 600px;">
                            <!-- Left Panel - Block Pool (20%) -->
                            <div style="width: 20%; background: var(--color-neutral-background); border-right: 1px solid var(--color-neutral-border); padding: 20px; overflow-y: auto;">
                                <!-- Document Metadata -->
                                <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--color-neutral-border);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                        <h3 style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin: 0; letter-spacing: 0.5px;">Document Info</h3>

                                        <!-- WBS Toggle (Compact) -->
                                        <div style="display: flex; align-items: center; gap: 6px; cursor: pointer;" onclick="toggleWBS()">
                                            <span style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text);">WBS</span>
                                            <div id="wbs-toggle" style="width: 32px; height: 16px; background: #ccc; border-radius: 8px; position: relative; transition: background 0.3s;">
                                                <div style="width: 12px; height: 12px; background: white; border-radius: 6px; position: absolute; top: 2px; left: 2px; transition: left 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Title -->
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">Title</label>
                                        <input type="text" id="docTitle" placeholder="Untitled Document" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); background: white;">
                                    </div>

                                    <!-- Description -->
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">Description</label>
                                        <textarea id="docDescription" placeholder="Brief description..." style="width: 100%; min-height: 60px; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); background: white; resize: vertical;"></textarea>
                                    </div>

                                    <!-- Tags -->
                                    <div>
                                        <label style="display: block; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">Tags</label>
                                        <input type="text" id="docTags" placeholder="tag1, tag2, tag3" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); background: white;">
                                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin-top: 4px;">Separate tags with commas</div>
                                    </div>
                                </div>

                                <h3 style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin: 0 0 16px 0; letter-spacing: 0.5px;">Block Pool</h3>

                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <!-- Header Block -->
                                    <button onclick="addDocumentBlock('header')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-h" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Header</span>
                                    </button>

                                    <!-- Rich Text Block -->
                                    <button onclick="addDocumentBlock('richtext')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-aa" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Rich Text</span>
                                    </button>

                                    <!-- Markdown Block -->
                                    <button onclick="addDocumentBlock('markdown')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-markdown-logo" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Markdown</span>
                                    </button>

                                    <!-- Picture Block -->
                                    <button onclick="addDocumentBlock('picture')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-image" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Picture</span>
                                    </button>

                                    <!-- Table Block -->
                                    <button onclick="addDocumentBlock('table')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-table" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Typed Table</span>
                                    </button>

                                    <!-- Code Block -->
                                    <button onclick="addDocumentBlock('code')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-code" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Code</span>
                                    </button>

                                    <!-- Diagram Block -->
                                    <button onclick="addDocumentBlock('diagram')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-flow-arrow" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Diagram</span>
                                    </button>

                                    <!-- Divider Block -->
                                    <button onclick="addDocumentBlock('divider')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-minus" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Divider</span>
                                    </button>

                                    <!-- Mermaid Block -->
                                    <button onclick="addDocumentBlock('mermaid')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-flow-arrow" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Mermaid</span>
                                    </button>

                                    <!-- KaTeX Block -->
                                    <button onclick="addDocumentBlock('latex')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-function" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>KaTeX</span>
                                    </button>

                                    <!-- Table of Contents Block -->
                                    <button onclick="addDocumentBlock('toc')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-list-numbers" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Table of Contents</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Right Panel - Document Canvas (80%) -->
                            <div id="documentCanvas" style="width: 80%; background: white; padding: 40px; overflow-y: auto;">
                                <div style="text-align: center; color: var(--color-neutral-text-light); padding: 80px 20px;">
                                    <i class="ph ph-file-text" style="font-size: 64px; color: var(--color-neutral-border); margin-bottom: 16px;"></i>
                                    <p style="font-family: var(--font-family-body); font-size: 14px; margin: 0;">Click a block from the left panel to start building your document</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Editor Modal -->
                <div id="tableEditorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000;">
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                        <!-- Table Editor Header -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: white;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div id="tableIcon" style="width: 40px; height: 40px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="ph ph-table" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                                </div>
                                <div>
                                    <h2 id="tableEditorTitle" style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin: 0;">Table Name</h2>
                                    <div id="tableRowCount" style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light); margin-top: 2px;">0 rows</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <!-- View Selector -->
                                <select id="viewSelector" onchange="switchTableView()" style="padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer;">
                                    <option value="default">Default View</option>
                                </select>
                                <!-- Add New Row Button -->
                                <button onclick="addNewRow()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-plus"></i>
                                    Add Row
                                </button>
                                <!-- Close Button -->
                                <button onclick="closeTableEditor()" style="padding: 8px; background: none; border: none; color: var(--color-neutral-text); cursor: pointer; font-size: 20px;">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Table Toolbar -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 24px; border-bottom: 1px solid var(--color-neutral-border); background: var(--color-neutral-background-secondary);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <!-- Filter Button -->
                                <button onclick="toggleFilterPanel()" id="filterBtn" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-funnel"></i>
                                    Filter
                                </button>
                                <!-- Sort Button -->
                                <button onclick="toggleSortPanel()" id="sortBtn" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-sort-ascending"></i>
                                    Sort
                                </button>
                                <!-- Group Button -->
                                <button onclick="toggleGroupPanel()" id="groupBtn" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-rows"></i>
                                    Group
                                </button>
                                <!-- Search -->
                                <div style="position: relative;">
                                    <input type="text" id="tableSearch" placeholder="Search..." style="padding: 6px 12px 6px 32px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; width: 200px;">
                                    <i class="ph ph-magnifying-glass" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--color-neutral-text); font-size: 14px;"></i>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <!-- Save View Button -->
                                <button onclick="saveCurrentView()" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-floppy-disk"></i>
                                    Save View
                                </button>
                            </div>
                        </div>

                        <!-- Table Content Area -->
                        <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                            <!-- Filter/Sort/Group Panels (Hidden by default) -->
                            <div id="filterPanel" style="display: none; padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: #fafbfc;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Filter Conditions</div>
                                <div id="filterConditions"></div>
                                <button onclick="addFilterCondition()" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-primary-blue); cursor: pointer; margin-top: 8px;">
                                    <i class="ph ph-plus"></i> Add Condition
                                </button>
                            </div>

                            <div id="sortPanel" style="display: none; padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: #fafbfc;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Sort Order</div>
                                <div id="sortConditions"></div>
                                <button onclick="addSortCondition()" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-primary-blue); cursor: pointer; margin-top: 8px;">
                                    <i class="ph ph-plus"></i> Add Sort
                                </button>
                            </div>

                            <div id="groupPanel" style="display: none; padding: 16px 24px; border-bottom: 1px solid var(--color-neutral-border); background: #fafbfc;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Group By</div>
                                <select id="groupByColumn" onchange="applyGrouping()" style="padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; width: 200px;">
                                    <option value="">No Grouping</option>
                                </select>
                            </div>

                            <!-- Data Grid -->
                            <div id="tableDataGrid" style="flex: 1; overflow: auto; background: white;">
                                <!-- Table will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column Type Editor Modal -->
                <div id="columnTypeEditorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; width: 100%; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                        <!-- Modal Header -->
                        <div style="padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border);">
                            <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Change Column Type</h3>
                            <div id="columnTypeEditorColumnName" style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-top: 4px;"></div>
                        </div>

                        <!-- Type Options -->
                        <div style="padding: 20px 24px; max-height: 400px; overflow-y: auto;">
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin-bottom: 12px;">Select Data Type</div>
                            <div id="columnTypeOptions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <!-- Type options will be dynamically inserted here -->
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <div style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                            <button onclick="closeColumnTypeEditor()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="applyColumnType()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Form Designer Modal -->
                <div class="modal" id="formDesignerModal">
                    <div class="modal-content" style="max-width: 1400px;">
                        <div class="modal-header">
                            <div style="flex: 1; max-width: 600px;">
                                <input type="text" id="formTitle" placeholder="Untitled Form" style="width: 100%; border: none; font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); padding: 8px 0; outline: none;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <!-- Preview Button -->
                                <button onclick="openFormPreview()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="ph ph-eye"></i> Preview
                                </button>
                                <!-- Publish Menu -->
                                <div style="position: relative;">
                                    <button onclick="togglePublishMenu()" id="publishBtn" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                        <i class="ph ph-paper-plane-tilt"></i>
                                        Publish
                                        <i class="ph ph-caret-down"></i>
                                    </button>
                                    <div id="publishMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 220px; z-index: 1100;">
                                        <button onclick="publishFormAs('open')" style="width: 100%; padding: 12px 16px; background: none; border: none; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                            <i class="ph ph-globe" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                                            <span>Publish as Open Form</span>
                                        </button>
                                        <button onclick="publishFormAs('specific')" style="width: 100%; padding: 12px 16px; background: none; border: none; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                            <i class="ph ph-users" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                                            <span>Publish to Specific Users</span>
                                        </button>
                                        <button onclick="shareFormWithEditors()" style="width: 100%; padding: 12px 16px; background: none; border: none; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; border-top: 1px solid var(--color-neutral-border);" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                            <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                                            <span>Share with Editors</span>
                                        </button>
                                    </div>
                                </div>
                                <!-- Save Button -->
                                <button onclick="saveFormDesign()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                                    <i class="ph ph-floppy-disk"></i> Save
                                </button>
                                <!-- Close Button -->
                                <button class="modal-close" onclick="closeFormDesigner()">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 0; display: flex; gap: 0; min-height: 600px;">
                            <!-- Left Panel - Field Palette (20%) -->
                            <div style="width: 20%; background: var(--color-neutral-background); border-right: 1px solid var(--color-neutral-border); padding: 20px; overflow-y: auto;">
                                <h3 style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin: 0 0 16px 0; letter-spacing: 0.5px;">Form Fields</h3>

                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <!-- Text Input Block -->
                                    <button onclick="addFormField('text')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-aa" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Text Input</span>
                                    </button>

                                    <!-- Text Area Block -->
                                    <button onclick="addFormField('textarea')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-align-left" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Text Area</span>
                                    </button>

                                    <!-- Email Block -->
                                    <button onclick="addFormField('email')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-envelope" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Email</span>
                                    </button>

                                    <!-- Number Block -->
                                    <button onclick="addFormField('number')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-hash" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Number</span>
                                    </button>

                                    <!-- Phone Block -->
                                    <button onclick="addFormField('phone')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-phone" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Phone</span>
                                    </button>

                                    <!-- Date Block -->
                                    <button onclick="addFormField('date')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-calendar-blank" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Date</span>
                                    </button>

                                    <!-- Time Block -->
                                    <button onclick="addFormField('time')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-clock" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Time</span>
                                    </button>
                                    <!-- Dropdown Block -->
                                    <button onclick="addFormField('dropdown')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-list" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Dropdown</span>
                                    </button>

                                    <!-- Radio Buttons Block -->
                                    <button onclick="addFormField('radio')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-radio-button" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Radio Buttons</span>
                                    </button>

                                    <!-- Checkboxes Block -->
                                    <button onclick="addFormField('checkbox')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-check-square" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Checkboxes</span>
                                    </button>

                                    <!-- File Upload Block -->
                                    <button onclick="addFormField('file')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-upload-simple" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>File Upload</span>
                                    </button>

                                    <!-- Picture Block -->
                                    <button onclick="addFormField('picture')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-image" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Picture</span>
                                    </button>

                                    <!-- Scale Block -->
                                    <button onclick="addFormField('scale')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-sliders-horizontal" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Scale</span>
                                    </button>

                                    <!-- Likert Scale Block -->
                                    <button onclick="addFormField('likert')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-rows" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Likert Scale</span>
                                    </button>

                                    <!-- Section Block -->
                                    <button onclick="addFormField('section')" style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                                        <i class="ph ph-text-h-two" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span>Section Header</span>
                                    </button>
                                    </div>
                                </div>

                                <!-- Main Content Area - Form Builder (80%) -->
                                <div style="width: 80%; background: white; overflow-y: auto; padding: 24px;">
                                    <div id="formFieldsContainer" style="width: 100%; min-height: 400px;">
                                        <div style="text-align: center; color: var(--color-neutral-text); padding: 60px 20px;">
                                            <i class="ph ph-note-pencil" style="font-size: 48px; color: var(--color-neutral-border); margin-bottom: 16px;"></i>
                                            <p style="font-family: var(--font-family-body); font-size: 14px;">Click a field type to start building your form</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Preview Modal -->
                <div id="formPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10001; overflow-y: auto;">
                    <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 40px;">
                        <div style="background: white; border-radius: 12px; width: 100%; max-width: 800px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                            <!-- Preview Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border);">
                                <h3 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin: 0;">Form Preview</h3>
                                <button onclick="closeFormPreview()" style="padding: 8px; background: none; border: none; color: var(--color-neutral-text); cursor: pointer; font-size: 20px;">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                            <!-- Preview Body -->
                            <div id="formPreviewContent" style="padding: 32px; max-height: 70vh; overflow-y: auto;">
                                <!-- Form preview will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Builder Modal -->
                <div id="dashboardBuilderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000;">
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 40px; box-sizing: border-box;">
                        <div style="background: white; border-radius: 12px; width: 100%; height: 100%; max-width: 2400px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                            <!-- Dashboard Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border); flex-shrink: 0;">
                                <div style="flex: 1;">
                                    <input type="text" id="dashboardTitle" placeholder="Untitled Dashboard" style="width: 100%; max-width: 600px; border: none; font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); padding: 8px 0; outline: none;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <button onclick="saveDashboard()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                        <i class="ph ph-floppy-disk"></i> Save
                                    </button>
                                    <button onclick="closeDashboardBuilder()" style="padding: 8px; background: none; border: none; color: var(--color-neutral-text); cursor: pointer; font-size: 20px;">
                                        <i class="ph ph-x"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Dashboard Body -->
                            <div style="flex: 1; overflow: hidden; display: flex; min-height: 0;">
                                <!-- Left Sidebar - Components Palette -->
                                <div style="width: 280px; border-right: 1px solid var(--color-neutral-border); padding: 20px; background: var(--color-neutral-background); overflow-y: auto;">
                                    <h4 style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin: 0 0 16px 0;">Visualizations</h4>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="addVisualization('bar-chart')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-chart-bar"></i>
                                            Bar Chart
                                        </button>
                                        <button onclick="addVisualization('line-chart')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-chart-line"></i>
                                            Line Chart
                                        </button>
                                        <button onclick="addVisualization('pie-chart')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-chart-pie-slice"></i>
                                            Pie Chart
                                        </button>
                                        <button onclick="addVisualization('area-chart')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-chart-line-up"></i>
                                            Area Chart
                                        </button>
                                        <button onclick="addVisualization('scatter-plot')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-scatter-chart"></i>
                                            Scatter Plot
                                        </button>
                                        <button onclick="addVisualization('gauge')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-gauge"></i>
                                            Gauge
                                        </button>
                                        <button onclick="addVisualization('kpi-card')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-number-square-one"></i>
                                            KPI Card
                                        </button>
                                        <button onclick="addVisualization('table')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-table"></i>
                                            Data Table
                                        </button>
                                        <button onclick="addVisualization('heatmap')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-grid-four"></i>
                                            Heatmap
                                        </button>
                                        <button onclick="addVisualization('funnel')" class="block-btn" style="padding: 10px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; text-align: left; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                            <i class="ph ph-funnel"></i>
                                            Funnel Chart
                                        </button>
                                    </div>
                                </div>

                                <!-- Main Canvas Area -->
                                <div style="flex: 1; background: var(--color-neutral-background); overflow-y: auto; display: flex; justify-content: center; min-height: 0;">
                                    <div id="dashboardCanvas" style="width: 100%; max-width: 1600px; padding: 24px; box-sizing: border-box;">
                                        <div style="text-align: center; padding: 80px 20px; color: var(--color-neutral-text-muted);">
                                            <i class="ph ph-chart-line" style="font-size: 64px; margin-bottom: 16px;"></i>
                                            <p style="font-size: 16px;">Click a visualization type to add it to your dashboard</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visualization Configuration Modal -->
                <div id="vizConfigModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10001; overflow-y: auto;">
                    <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 40px;">
                        <div style="background: white; border-radius: 12px; width: 100%; max-width: 600px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                            <!-- Config Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--color-neutral-border);">
                                <h3 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin: 0;">Configure Visualization</h3>
                                <button onclick="closeVizConfig()" style="padding: 8px; background: none; border: none; color: var(--color-neutral-text); cursor: pointer; font-size: 20px;">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                            <!-- Config Body -->
                            <div style="padding: 24px;">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                        Visualization Title
                                    </label>
                                    <input type="text" id="vizConfigTitle" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                        Select Tables
                                    </label>
                                    <div id="tableSelectionList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 12px;">
                                        <!-- Table checkboxes will be inserted here -->
                                    </div>
                                    <div style="margin-top: 8px; font-size: 12px; color: var(--color-neutral-text-muted);">
                                        Select one or more tables to use in this visualization
                                    </div>
                                </div>
                            </div>
                            <!-- Config Footer -->
                            <div style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                                <button onclick="closeVizConfig()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                                    Cancel
                                </button>
                                <button onclick="saveVizConfig()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Copyright Notice -->
                <div style="position: absolute; bottom: 8px; right: 16px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); font-weight: 500; z-index: 5;">
                    © 2025 Cleansheet LLC. All rights reserved.
                </div>
            </div>

        <!-- Member Tier Upgrade Info Modal -->
        <div class="modal" id="memberTierInfoModal" style="display: none;">
            <div class="modal-content" style="max-width: 650px;">
                <div class="modal-header">
                    <h2 class="modal-title">Cloud Sync & Tier Features</h2>
                    <button class="modal-close" onclick="closeMemberTierInfoModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <!-- Current Tier Notice -->
                    <div style="padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; margin-bottom: 24px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <i class="ph ph-info" style="font-size: 24px; color: #dc2626; flex-shrink: 0; margin-top: 2px;"></i>
                            <div>
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: #dc2626; margin-bottom: 4px;">
                                    Cloud Sync Not Available on Member Tier
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; color: #991b1b; line-height: 1.5;">
                                    You're currently on the <strong>Member</strong> tier. Switch to <strong>Learner</strong> tier or upgrade to <strong>Seeker</strong> tier to unlock cloud sync and additional features.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cloud Sync Benefits -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-cloud-check" style="color: var(--color-primary-blue);"></i>
                            Cloud Sync Benefits
                        </h3>
                        <div style="display: grid; gap: 12px;">
                            <div style="padding: 12px 16px; background: #e3f2fd; border-left: 3px solid var(--color-primary-blue); border-radius: 4px;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                    Access Anywhere
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                                    Your profile, experiences, and stories sync across all your devices
                                </div>
                            </div>
                            <div style="padding: 12px 16px; background: #e3f2fd; border-left: 3px solid var(--color-primary-blue); border-radius: 4px;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                    Never Lose Work
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                                    Automatic cloud backup protects your career data
                                </div>
                            </div>
                            <div style="padding: 12px 16px; background: #e3f2fd; border-left: 3px solid var(--color-primary-blue); border-radius: 4px;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                    Seamless Updates
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                                    Changes you make on one device appear instantly on others
                                </div>
                            </div>
                            <div style="padding: 12px 16px; background: #e3f2fd; border-left: 3px solid var(--color-primary-blue); border-radius: 4px;">
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                    Secure Storage
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                                    Your data is encrypted and stored in Microsoft Azure
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tier Comparison -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">
                            Feature Comparison
                        </h3>
                        <div style="border: 1px solid var(--color-neutral-border); border-radius: 8px; overflow: hidden;">
                            <table style="width: 100%; border-collapse: collapse; font-family: var(--font-family-body); font-size: 13px;">
                                <thead>
                                    <tr style="background: var(--color-dark); color: white;">
                                        <th style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-weight: 600;">Feature</th>
                                        <th style="padding: 12px 16px; text-align: center; font-family: var(--font-family-ui); font-weight: 600;">Member</th>
                                        <th style="padding: 12px 16px; text-align: center; font-family: var(--font-family-ui); font-weight: 600; background: rgba(0, 102, 204, 0.2);">Learner</th>
                                        <th style="padding: 12px 16px; text-align: center; font-family: var(--font-family-ui); font-weight: 600; background: rgba(0, 102, 204, 0.3);">Seeker</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid var(--color-neutral-border);">
                                        <td style="padding: 12px 16px;">Cloud Sync</td>
                                        <td style="padding: 12px 16px; text-align: center;"><i class="ph ph-x" style="color: #dc2626;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f8fafc;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f1f5f9;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--color-neutral-border);">
                                        <td style="padding: 12px 16px;">Career Canvas</td>
                                        <td style="padding: 12px 16px; text-align: center;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f8fafc;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f1f5f9;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--color-neutral-border);">
                                        <td style="padding: 12px 16px;">Experience Tracking</td>
                                        <td style="padding: 12px 16px; text-align: center;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f8fafc;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f1f5f9;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--color-neutral-border);">
                                        <td style="padding: 12px 16px;">Behavioral Stories</td>
                                        <td style="padding: 12px 16px; text-align: center;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f8fafc;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f1f5f9;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--color-neutral-border);">
                                        <td style="padding: 12px 16px;">Cleansheet Library</td>
                                        <td style="padding: 12px 16px; text-align: center;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f8fafc;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f1f5f9;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px 16px;">Coaching Sessions</td>
                                        <td style="padding: 12px 16px; text-align: center;"><i class="ph ph-x" style="color: #dc2626;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f8fafc;"><i class="ph ph-x" style="color: #dc2626;"></i></td>
                                        <td style="padding: 12px 16px; text-align: center; background: #f1f5f9;"><i class="ph ph-check" style="color: #16a34a; font-weight: bold;"></i></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Quick Tip -->
                    <div style="padding: 16px; background: #e3f2fd; border-radius: 8px;">
                        <div style="display: flex; gap: 12px;">
                            <i class="ph ph-lightbulb" style="font-size: 20px; color: var(--color-primary-blue); flex-shrink: 0;"></i>
                            <div>
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-primary-blue); margin-bottom: 4px;">
                                    Quick Tip
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); line-height: 1.5;">
                                    Click your subscription badge at the top of the page to switch tiers. Learner tier is completely free and includes cloud sync!
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; gap: 12px;">
                    <button onclick="closeMemberTierInfoModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Close
                    </button>
                    <button onclick="closeMemberTierInfoModal(); openSubscriptionModal();" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <i class="ph ph-star"></i>
                        <span>Change Tier</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Support Modal -->
        <div class="modal" id="supportModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">Support & Troubleshooting</h2>
                    <button class="modal-close" onclick="closeSupportModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <!-- Sync Troubleshooting Section -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-cloud-arrow-up" style="color: var(--color-primary-blue);"></i>
                            Cloud Sync Troubleshooting
                        </h3>

                        <!-- Sync Status Info -->
                        <div id="syncStatusInfo" style="padding: 16px; background: #f5f5f7; border-radius: 8px; margin-bottom: 16px;">
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.6;">
                                <div style="margin-bottom: 8px;"><strong>Status:</strong> <span id="syncAuthStatus">Checking...</span></div>
                                <div style="margin-bottom: 8px;"><strong>Last Sync:</strong> <span id="syncLastSyncTime">Never</span></div>
                                <div><strong>Auto-Sync:</strong> <span id="syncAutoStatus">Enabled (every 60s)</span></div>
                            </div>
                        </div>

                        <!-- LocalStorage Diagnostics -->
                        <div style="padding: 16px; background: #fffbeb; border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <i class="ph ph-warning" style="font-size: 20px; color: #f59e0b;"></i>
                                <strong style="font-family: var(--font-family-ui); font-size: 14px; color: var(--color-dark);">LocalStorage Diagnostics</strong>
                            </div>
                            <div id="localStorageDiagnostics"></div>
                        </div>

                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.6; margin: 0 0 16px 0;">
                            If your data isn't syncing correctly, you can force a manual sync in either direction:
                        </p>

                        <!-- Sync Direction Options -->
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Sync Down -->
                            <button onclick="forceSyncDown()" style="padding: 16px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s; display: flex; gap: 12px; align-items: start;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#f8fafc';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-cloud-arrow-down" style="font-size: 24px; color: var(--color-primary-blue); flex-shrink: 0;"></i>
                                <div style="flex: 1;">
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                        Sync Down (Cloud → This Device)
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                                        Download your data from the cloud and replace local data. Use this if changes from another device aren't appearing here.
                                    </div>
                                </div>
                            </button>

                            <!-- Sync Up -->
                            <button onclick="forceSyncUp()" style="padding: 16px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s; display: flex; gap: 12px; align-items: start;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#f8fafc';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-cloud-arrow-up" style="font-size: 24px; color: var(--color-primary-blue); flex-shrink: 0;"></i>
                                <div style="flex: 1;">
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                        Sync Up (This Device → Cloud)
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                                        Upload your local data to the cloud. Use this to ensure your latest changes are saved to the cloud.
                                    </div>
                                </div>
                            </button>

                            <!-- Full Sync -->
                            <button onclick="forceFullSync()" style="padding: 16px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s; display: flex; gap: 12px; align-items: start;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#f8fafc';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-arrows-clockwise" style="font-size: 24px; color: var(--color-primary-blue); flex-shrink: 0;"></i>
                                <div style="flex: 1;">
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                        Full Sync (Bidirectional)
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                                        Sync in both directions. Cloud data will be compared with local data, and the newest version will be kept.
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Data Recovery -->
                    <div style="margin-top: 24px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--color-neutral-border);">
                            <i class="ph ph-first-aid-kit" style="margin-right: 8px;"></i>Data Recovery
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Recover Old Data -->
                            <button onclick="recoverOldData()" style="padding: 16px; background: white; border: 2px solid #f59e0b; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s; display: flex; gap: 12px; align-items: start;" onmouseover="this.style.borderColor='#d97706'; this.style.background='#fffbeb';" onmouseout="this.style.borderColor='#f59e0b'; this.style.background='white';">
                                <i class="ph ph-clock-counter-clockwise" style="font-size: 24px; color: #f59e0b; flex-shrink: 0;"></i>
                                <div style="flex: 1;">
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                        Recover Old Data
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                                        Check for data stored under old localStorage keys and migrate it to current keys. Use this if your data disappeared after an update.
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Placeholder for future support options -->
                    <div style="padding: 16px; background: #e3f2fd; border-radius: 8px; margin-top: 24px;">
                        <div style="display: flex; gap: 12px;">
                            <i class="ph ph-info" style="font-size: 20px; color: var(--color-primary-blue); flex-shrink: 0;"></i>
                            <div>
                                <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-primary-blue); margin-bottom: 4px;">
                                    Need More Help?
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-dark); line-height: 1.5;">
                                    Additional support options will be available soon, including the ability to submit support requests and chat with our team.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end;">
                    <button onclick="closeSupportModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Sign Out Confirmation Modal -->
        <div class="modal" id="signOutModal" style="display: none;">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h2 class="modal-title">Sign Out</h2>
                    <button class="modal-close" onclick="closeSignOutModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                        <div style="flex-shrink: 0;">
                            <i class="ph ph-warning-circle" style="font-size: 48px; color: #f59e0b;"></i>
                        </div>
                        <div>
                            <h3 style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">
                                Stop Cloud Sync?
                            </h3>
                            <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.6; margin: 0;">
                                You'll be signed out and your data will stop syncing to the cloud. Your local data will remain available on this device.
                            </p>
                        </div>
                    </div>

                    <div style="padding: 16px; background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; color: #92400e; line-height: 1.5; margin: 0;">
                            <strong>Note:</strong> You can sign back in at any time to resume syncing your data across devices.
                        </p>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeSignOutModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="confirmSignOut()" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <i class="ph ph-sign-out"></i>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Settings Modal -->
        <div class="modal" id="profileModal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title">Profile Settings</h2>
                    <button class="modal-close" onclick="closeProfileModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- First Name & Last Name (Same Row) -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                    First Name
                                </label>
                                <input type="text" id="profileFirstName" placeholder="Enter your first name" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                    Last Name
                                </label>
                                <input type="text" id="profileLastName" placeholder="Enter your last name" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                        </div>

                        <!-- Profession -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Profession / Role
                            </label>
                            <input type="text" id="profileProfession" placeholder="e.g., Software Engineer, Data Analyst" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Goal -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Career Goal
                            </label>
                            <textarea id="profileGoal" placeholder="e.g., Transition to senior engineering role at a tech company" rows="3" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Email & Sign In -->
                        <div style="display: flex; gap: 8px; align-items: flex-end;">
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                    Email Address
                                </label>
                                <input type="email" id="profileEmail" placeholder="your.email@example.com" style="width: 100%; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <button id="profileCloudSyncButton" onclick="handleCloudSyncClick()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 8px;">
                                <i id="profileCloudSyncIcon" class="ph ph-cloud-arrow-up" style="font-size: 16px;"></i>
                                <span id="profileCloudSyncText">Sign In</span>
                            </button>
                        </div>

                        <!-- Example Profile Notice (shown only for example profiles) -->
                        <div id="exampleProfileNotice" style="display: none; padding: 16px; background: #fff7ed; border-radius: 8px; border: 2px solid #f97316;">
                            <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px;">
                                <i class="ph ph-info" style="font-size: 24px; color: #f97316; flex-shrink: 0;"></i>
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: #ea580c; margin-bottom: 4px;">
                                        Example Profile Loaded
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 13px; color: #9a3412; line-height: 1.5;">
                                        You're viewing an example profile. When you're ready, clear this data to start building your own career canvas.
                                    </div>
                                </div>
                            </div>
                            <button onclick="clearExampleProfile()" style="width: 100%; padding: 10px 16px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <i class="ph ph-broom"></i>
                                <span>Ready to Get Started</span>
                            </button>
                        </div>

                        <!-- Profile Request Invitation (shown when NOT example profile) -->
                        <div id="profileRequestInvitation" style="display: none; padding: 16px; background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); border-radius: 8px; border: 2px solid #f97316;">
                            <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px;">
                                <i class="ph ph-sparkle" style="font-size: 24px; color: #f97316; flex-shrink: 0;"></i>
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: #ea580c; margin-bottom: 4px;">
                                        Skip the Drudgery
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 13px; color: #9a3412; line-height: 1.5;">
                                        Let Cleansheet build your professional profile from LinkedIn. We'll create a comprehensive career canvas with your experiences, skills, and accomplishments.
                                    </div>
                                </div>
                            </div>
                            <button onclick="closeProfileModal(); openSubscriptionProfileRequestModal();" style="width: 100%; padding: 10px 16px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <i class="ph ph-user-focus"></i>
                                <span>Request Cleansheet Profile</span>
                            </button>
                        </div>

                        <!-- Subscription Management -->
                        <div style="padding: 16px; background: #f5f5f7; border-radius: 8px; border: 1px solid var(--color-neutral-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                        Subscription Tier
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 4px;">
                                        Manage your subscription plan and features
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-primary-blue); font-style: italic;">
                                        All tiers are free during the preview period
                                    </div>
                                </div>
                                <button onclick="closeProfileModal(); openSubscriptionModal();" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                    Manage Plan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeProfileModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveProfile()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                        Save Profile
                    </button>
                </div>
            </div>
        </div>

        <!-- Session Request Modal -->
        <div class="modal" id="sessionRequestModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">Schedule Coaching Session</h2>
                    <button class="modal-close" onclick="closeSessionRequestModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Preview Service Notice -->
                        <div style="padding: 16px; background: #e3f2fd; border-left: 4px solid var(--color-primary-blue); border-radius: 6px;">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <i class="ph ph-info" style="font-size: 24px; color: var(--color-primary-blue); flex-shrink: 0;"></i>
                                <div>
                                    <h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">
                                        Preview Service
                                    </h3>
                                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5; margin: 0;">
                                        Mock interview coaching is currently in preview and depends on the availability of coaches matching your profile requirements.
                                        We will reach out as soon as we have an appropriate match.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- What We'll Send -->
                        <div>
                            <h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">
                                Your Profile Data
                            </h3>
                            <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5; margin-bottom: 12px;">
                                To match you with the right coach, we'll share the following from your profile:
                            </p>
                            <ul style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.6; margin: 0; padding-left: 20px;">
                                <li>Career Experience</li>
                                <li>Portfolio Projects</li>
                                <li>Job Opportunities you're pursuing</li>
                                <li>Basic profile information (name, profession, career goal)</li>
                            </ul>
                        </div>

                        <!-- Email Confirmation -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Email Address
                            </label>
                            <input type="email" id="sessionEmail" placeholder="your.email@example.com" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-muted); margin: 0;">
                                We'll contact you at this email when a coach is available.
                            </p>
                        </div>

                        <!-- Optional Notes -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Additional Notes (Optional)
                            </label>
                            <textarea id="sessionNotes" placeholder="Any specific areas you'd like to focus on or questions you have..." rows="3" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeSessionRequestModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="submitSessionRequest()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                        <i class="ph ph-paper-plane-right" style="margin-right: 6px;"></i>
                        Submit Request
                    </button>
                </div>
            </div>
        </div>

        <!-- Whiteboard Metadata Modal -->
        <div class="modal" id="whiteboardModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title" id="whiteboardModalTitle">Create Whiteboard</h2>
                    <button class="modal-close" onclick="closeWhiteboardModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Whiteboard Name -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Whiteboard Name
                            </label>
                            <input type="text" id="whiteboardName" placeholder="e.g., System Design - URL Shortener" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Description -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Description
                            </label>
                            <textarea id="whiteboardDescription" placeholder="Describe the problem, solution approach, or key concepts..." rows="3" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Link to Experience or Portfolio -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Link to (Optional)
                            </label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <button onclick="setWhiteboardLinkType('experience')" id="linkTypeExperience" style="flex: 1; padding: 8px 12px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-briefcase" style="margin-right: 6px;"></i>
                                    Experience
                                </button>
                                <button onclick="setWhiteboardLinkType('portfolio')" id="linkTypePortfolio" style="flex: 1; padding: 8px 12px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-folder-open" style="margin-right: 6px;"></i>
                                    Portfolio
                                </button>
                                <button onclick="setWhiteboardLinkType('none')" id="linkTypeNone" style="flex: 1; padding: 8px 12px; background: var(--color-primary-blue); color: white; border: 2px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-x-circle" style="margin-right: 6px;"></i>
                                    None
                                </button>
                            </div>
                            <select id="whiteboardLinkSelect" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; display: none;">
                                <option value="">Select an item...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeWhiteboardModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveWhiteboardMetadataOnly()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                        <i class="ph ph-floppy-disk" style="margin-right: 6px;"></i>
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Diagram Metadata Modal -->
        <div class="modal" id="diagramModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title" id="diagramModalTitle">Create Diagram</h2>
                    <button class="modal-close" onclick="closeDiagramModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Diagram Name -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Diagram Name
                            </label>
                            <input type="text" id="diagramName" placeholder="e.g., System Architecture - API Gateway" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Description -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Description
                            </label>
                            <textarea id="diagramDescription" placeholder="Describe the architecture, flow, or design..." rows="3" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Link to Experience or Portfolio -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Link to (Optional)
                            </label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <button onclick="setDiagramLinkType('experience')" id="diagramLinkTypeExperience" style="flex: 1; padding: 8px 12px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-briefcase" style="margin-right: 6px;"></i>
                                    Experience
                                </button>
                                <button onclick="setDiagramLinkType('portfolio')" id="diagramLinkTypePortfolio" style="flex: 1; padding: 8px 12px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-folder-open" style="margin-right: 6px;"></i>
                                    Portfolio
                                </button>
                                <button onclick="setDiagramLinkType('none')" id="diagramLinkTypeNone" style="flex: 1; padding: 8px 12px; background: var(--color-primary-blue); color: white; border: 2px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-x-circle" style="margin-right: 6px;"></i>
                                    None
                                </button>
                            </div>
                            <select id="diagramLinkSelect" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; display: none;">
                                <option value="">Select an item...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeDiagramModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveDiagramMetadata()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                        <i class="ph ph-floppy-disk" style="margin-right: 6px;"></i>
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Unified Asset Creation/Edit Modal -->
        <div class="modal" id="unifiedAssetModal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title" id="unifiedAssetModalTitle">Create Asset</h2>
                    <button class="modal-close" onclick="closeUnifiedAssetModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Asset Type Selector -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Asset Type
                            </label>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                                <button onclick="setUnifiedAssetType('Document')" id="assetTypeDocument" style="padding: 12px; background: var(--color-primary-blue); color: white; border: 2px solid var(--color-primary-blue); border-radius: 8px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="ph ph-file-text" style="font-size: 24px;"></i>
                                    Document
                                </button>
                                <button onclick="setUnifiedAssetType('LaTeX')" id="assetTypeLaTeX" style="padding: 12px; background: white; color: var(--color-dark); border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="ph ph-math-operations" style="font-size: 24px;"></i>
                                    LaTeX
                                </button>
                                <button onclick="setUnifiedAssetType('CV')" id="assetTypeCV" style="padding: 12px; background: white; color: var(--color-dark); border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="ph ph-user-circle-gear" style="font-size: 24px;"></i>
                                    CV/Resume
                                </button>
                                <button onclick="setUnifiedAssetType('Diagram')" id="assetTypeDiagram" style="padding: 12px; background: white; color: var(--color-dark); border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="ph ph-flow-arrow" style="font-size: 24px;"></i>
                                    Diagram
                                </button>
                                <button onclick="setUnifiedAssetType('Presentation')" id="assetTypePresentation" style="padding: 12px; background: white; color: var(--color-dark); border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="ph ph-presentation" style="font-size: 24px;"></i>
                                    Presentation
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">
                                <button onclick="setUnifiedAssetType('Whiteboard')" id="assetTypeWhiteboard" style="padding: 12px; background: white; color: var(--color-dark); border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="ph ph-chalkboard" style="font-size: 24px;"></i>
                                    Whiteboard
                                </button>
                                <button onclick="setUnifiedAssetType('Markdown')" id="assetTypeMarkdown" style="padding: 12px; background: white; color: var(--color-dark); border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="ph ph-markdown-logo" style="font-size: 24px;"></i>
                                    Markdown
                                </button>
                                <button onclick="setUnifiedAssetType('Code')" id="assetTypeCode" style="padding: 12px; background: white; color: var(--color-dark); border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                    <i class="ph ph-code" style="font-size: 24px;"></i>
                                    Code
                                </button>
                            </div>
                        </div>

                        <!-- Link to Experience or Portfolio -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Link to (Optional)
                            </label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <button onclick="setUnifiedAssetLinkType('experience')" id="unifiedAssetLinkTypeExperience" style="flex: 1; padding: 8px 12px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-briefcase" style="margin-right: 6px;"></i>
                                    Experience
                                </button>
                                <button onclick="setUnifiedAssetLinkType('portfolio')" id="unifiedAssetLinkTypePortfolio" style="flex: 1; padding: 8px 12px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-folder-open" style="margin-right: 6px;"></i>
                                    Portfolio
                                </button>
                                <button onclick="setUnifiedAssetLinkType('none')" id="unifiedAssetLinkTypeNone" style="flex: 1; padding: 8px 12px; background: var(--color-primary-blue); color: white; border: 2px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-x-circle" style="margin-right: 6px;"></i>
                                    None
                                </button>
                            </div>
                            <select id="unifiedAssetLinkSelect" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; display: none;">
                                <option value="">Select an item...</option>
                            </select>
                        </div>

                        <!-- Asset Name -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Name
                            </label>
                            <input type="text" id="unifiedAssetName" placeholder="e.g., System Architecture Overview" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Description -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Description
                            </label>
                            <textarea id="unifiedAssetDescription" placeholder="Describe what this asset demonstrates or documents..." rows="3" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Skills Tags -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Skills
                            </label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="unifiedAssetSkillInput" placeholder="e.g., Problem Solving" style="flex: 1; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <button onclick="addUnifiedAssetTag('skill')" style="padding: 10px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <div id="unifiedAssetSkillTags" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 32px; padding: 8px; background: var(--color-neutral-background); border-radius: 6px;">
                                <span style="color: var(--color-neutral-text); font-family: var(--font-family-body); font-size: 12px; font-style: italic;">No skills added yet</span>
                            </div>
                        </div>

                        <!-- Technologies Tags -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Technologies
                            </label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="unifiedAssetTechInput" placeholder="e.g., React, Python, AWS" style="flex: 1; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <button onclick="addUnifiedAssetTag('tech')" style="padding: 10px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <div id="unifiedAssetTechTags" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 32px; padding: 8px; background: var(--color-neutral-background); border-radius: 6px;">
                                <span style="color: var(--color-neutral-text); font-family: var(--font-family-body); font-size: 12px; font-style: italic;">No technologies added yet</span>
                            </div>
                        </div>

                        <!-- Competencies Tags -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Competencies
                            </label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="unifiedAssetCompInput" placeholder="e.g., System Design, Leadership" style="flex: 1; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <button onclick="addUnifiedAssetTag('comp')" style="padding: 10px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <div id="unifiedAssetCompTags" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 32px; padding: 8px; background: var(--color-neutral-background); border-radius: 6px;">
                                <span style="color: var(--color-neutral-text); font-family: var(--font-family-body); font-size: 12px; font-style: italic;">No competencies added yet</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeUnifiedAssetModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveUnifiedAsset()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                        <i class="ph ph-floppy-disk" style="margin-right: 6px;"></i>
                        Create & Open
                    </button>
                </div>
            </div>
        </div>

        <!-- Document Metadata Modal -->
        <div class="modal" id="documentModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title" id="documentModalTitle">Create Document</h2>
                    <button class="modal-close" onclick="closeDocumentModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Document Name -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Document Name
                            </label>
                            <input type="text" id="documentName" placeholder="e.g., Technical Spec - API Integration" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Description -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Description
                            </label>
                            <textarea id="documentDescription" placeholder="Describe the document purpose or content..." rows="3" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Link to Experience or Portfolio -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Link to (Optional)
                            </label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <button onclick="setDocumentLinkType('experience')" id="documentLinkTypeExperience" style="flex: 1; padding: 8px 12px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-briefcase" style="margin-right: 6px;"></i>
                                    Experience
                                </button>
                                <button onclick="setDocumentLinkType('portfolio')" id="documentLinkTypePortfolio" style="flex: 1; padding: 8px 12px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-folder-open" style="margin-right: 6px;"></i>
                                    Portfolio
                                </button>
                                <button onclick="setDocumentLinkType('none')" id="documentLinkTypeNone" style="flex: 1; padding: 8px 12px; background: var(--color-primary-blue); color: white; border: 2px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-x-circle" style="margin-right: 6px;"></i>
                                    None
                                </button>
                            </div>
                            <select id="documentLinkSelect" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; display: none;">
                                <option value="">Select an item...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeDocumentModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveDocumentMetadata()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                        <i class="ph ph-floppy-disk" style="margin-right: 6px;"></i>
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Whiteboard Editor (Full Screen) -->
        <div id="whiteboardEditor" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 10500; flex-direction: column;">
            <!-- Whiteboard Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: var(--color-dark); color: white; border-bottom: 1px solid var(--color-neutral-border);">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button onclick="closeWhiteboardEditor()" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; border-radius: 6px; padding: 8px 12px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-arrow-left"></i>
                        Back
                    </button>
                    <h3 id="whiteboardEditorTitle" style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; margin: 0;">
                        Untitled Whiteboard
                    </h3>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <!-- Edit Info button removed -->
                </div>
            </div>
            <!-- Whiteboard Toolbar -->
            <div style="display: none; align-items: center; gap: 12px; padding: 12px 24px; background: #f8f8f8; border-bottom: 1px solid var(--color-neutral-border); flex-wrap: wrap;">
                <!-- Mode Buttons (Hidden - Excalidraw provides its own toolbar) -->
                <button onclick="setWhiteboardTool('select')" id="btnSelectMode" style="padding: 8px 12px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-cursor"></i>
                </button>
                <button onclick="setWhiteboardTool('draw')" id="btnDrawMode" style="padding: 8px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-pencil-simple"></i>
                </button>
                <button onclick="setWhiteboardTool('rectangle')" id="btnRectMode" style="padding: 8px 12px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-rectangle"></i>
                </button>
                <button onclick="setWhiteboardTool('circle')" id="btnCircleMode" style="padding: 8px 12px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-circle"></i>
                </button>
                <button onclick="setWhiteboardTool('line')" id="btnLineMode" style="padding: 8px 12px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-line-segment"></i>
                </button>
                <button onclick="setWhiteboardTool('text')" id="btnTextMode" style="padding: 8px 12px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-text-t"></i>
                </button>

                <div style="width: 1px; height: 24px; background: var(--color-neutral-border);"></div>

                <!-- Color and Width -->
                <label style="display: flex; align-items: center; gap: 6px; font-family: var(--font-family-ui); font-size: 13px; color: var(--color-neutral-text);">
                    Color:
                    <input type="color" id="brushColor" value="#000000" onchange="updateBrushColor(this.value)" style="width: 40px; height: 32px; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">
                </label>
                <label style="display: flex; align-items: center; gap: 6px; font-family: var(--font-family-ui); font-size: 13px; color: var(--color-neutral-text);">
                    Width:
                    <input type="range" id="brushWidth" min="1" max="20" value="2" onchange="updateBrushWidth(this.value)" style="width: 100px;">
                    <span id="brushWidthDisplay" style="min-width: 24px; text-align: center;">2</span>
                </label>

                <div style="width: 1px; height: 24px; background: var(--color-neutral-border);"></div>

                <!-- Action Buttons -->
                <button onclick="deleteSelectedWhiteboardObject()" style="padding: 8px 12px; background: white; color: #dc2626; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-trash"></i>
                </button>
                <button onclick="clearWhiteboardCanvas()" style="padding: 8px 12px; background: white; color: #dc2626; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-trash"></i> Clear All
                </button>
            </div>
            <!-- Whiteboard Canvas Container -->
            <div id="whiteboardCanvasContainer" style="flex: 1; overflow: hidden; position: relative;">
                <!-- Excalidraw iframe will be created here -->
            </div>
        </div>

        <!-- Document Editor (Full Screen with Quill) -->
        <div id="documentEditor" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 10500; flex-direction: column;">
            <!-- Document Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: var(--color-dark); color: white; border-bottom: 1px solid var(--color-neutral-border);">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button onclick="closeDocumentEditor()" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; border-radius: 6px; padding: 8px 12px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-arrow-left"></i>
                        Back
                    </button>
                    <h3 id="documentEditorTitle" style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; margin: 0;">
                        Untitled Document
                    </h3>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-family: var(--font-family-body); font-size: 12px; color: rgba(255, 255, 255, 0.7); font-style: italic;">
                        <i class="ph ph-check-circle" style="margin-right: 4px;"></i>
                        <span id="saveIndicator" style="opacity: 0.7; transition: opacity 0.3s;">Auto-save enabled</span>
                    </span>
                </div>
            </div>
            <!-- Quill Editor Container -->
            <div id="quillEditorContainer" style="flex: 1; overflow: hidden; display: flex; flex-direction: column; background: #fafafa;">
                <div id="quillEditor" style="flex: 1; display: flex; flex-direction: column; background: white;">
                    <!-- Quill editor will be initialized here -->
                </div>
            </div>
        </div>

        <!-- Diagram Editor (draw.io iframe) -->
        <div id="diagramEditor" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 10500; flex-direction: column;">
            <!-- Diagram Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: var(--color-dark); color: white; border-bottom: 1px solid var(--color-neutral-border);">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button onclick="closeDiagramEditor()" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; border-radius: 6px; padding: 8px 12px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-arrow-left"></i>
                        Back
                    </button>
                    <h3 id="diagramEditorTitle" style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; margin: 0;">
                        Untitled Diagram
                    </h3>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-family: var(--font-family-body); font-size: 12px; color: rgba(255, 255, 255, 0.7); font-style: italic;">
                        <i class="ph ph-check-circle" style="margin-right: 4px;"></i>
                        <span id="saveIndicator" style="opacity: 0.7; transition: opacity 0.3s;">Auto-save enabled</span>
                    </span>
                </div>
            </div>
            <!-- Draw.io iframe -->
            <iframe id="diagramIframe" style="width: 100%; height: calc(100% - 60px); border: none; background: #f5f5f7;"></iframe>
        </div>

        <!-- LaTeX Editor (Full Screen with Split-Pane) -->
        <div id="latexEditor" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 10500; flex-direction: column;">
            <!-- LaTeX Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: var(--color-dark); color: white; border-bottom: 1px solid var(--color-neutral-border);">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button onclick="closeLatexEditor()" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; border-radius: 6px; padding: 8px 12px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-arrow-left"></i>
                        Back
                    </button>
                    <h3 id="latex-document-title" style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; margin: 0;">
                        Untitled LaTeX Document
                    </h3>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="editLatexMetadata()" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; border-radius: 6px; padding: 8px 12px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;" title="Edit Info">
                        <i class="ph ph-info"></i>
                    </button>
                    <span style="font-family: var(--font-family-body); font-size: 12px; color: rgba(255, 255, 255, 0.7); font-style: italic;">
                        <i class="ph ph-check-circle" style="margin-right: 4px;"></i>
                        <span id="saveIndicator" style="opacity: 0.7; transition: opacity 0.3s;">Auto-save enabled</span>
                    </span>
                </div>
            </div>

            <!-- Split-pane body -->
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- Editor pane (left side) -->
                <div style="flex: 1; display: flex; flex-direction: column; border-right: 2px solid var(--color-neutral-border); min-width: 0;">
                    <!-- LaTeX Toolbar -->
                    <div id="latexToolbar" style="padding: 8px 12px; background: var(--color-neutral-background); border-bottom: 1px solid var(--color-neutral-border); display: flex; gap: 4px; flex-wrap: wrap; align-items: center;">
                        <!-- Toolbar buttons will be populated via JavaScript -->
                        <button class="latex-toolbar-btn" onclick="insertLatexCommand('section')" title="Insert Section" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-text-h-one"></i>
                            Section
                        </button>
                        <button class="latex-toolbar-btn" onclick="insertLatexCommand('subsection')" title="Insert Subsection" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-text-h-two"></i>
                            Subsection
                        </button>
                        <button class="latex-toolbar-btn" onclick="insertLatexCommand('bold')" title="Bold Text" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: bold; cursor: pointer;">
                            B
                        </button>
                        <button class="latex-toolbar-btn" onclick="insertLatexCommand('italic')" title="Italic Text" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; font-style: italic; cursor: pointer;">
                            I
                        </button>
                        <div style="width: 1px; height: 20px; background: var(--color-neutral-border); margin: 0 4px;"></div>
                        <button class="latex-toolbar-btn" onclick="insertLatexCommand('itemize')" title="Insert Bullet List" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-list-bullets"></i>
                            List
                        </button>
                        <button class="latex-toolbar-btn" onclick="insertLatexCommand('enumerate')" title="Insert Numbered List" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-list-numbers"></i>
                            1,2,3
                        </button>
                        <div style="width: 1px; height: 20px; background: var(--color-neutral-border); margin: 0 4px;"></div>
                        <button class="latex-toolbar-btn" onclick="insertLatexCommand('math-inline')" title="Inline Math" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-function"></i>
                            $x$
                        </button>
                        <button class="latex-toolbar-btn" onclick="insertLatexCommand('math-display')" title="Math Block" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-equals"></i>
                            Eq
                        </button>
                        <button class="latex-toolbar-btn" onclick="insertLatexCommand('table')" title="Insert Table" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-table"></i>
                            Table
                        </button>
                        <!-- CV-specific commands (shown when editing CV documents) -->
                        <div style="width: 1px; height: 20px; background: var(--color-neutral-border); margin: 0 4px;" id="cvToolbarDivider" style="display: none;"></div>
                        <button class="latex-toolbar-btn cv-command" onclick="insertLatexCommand('cvsection')" title="Insert CV Section" style="display: none; padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer;">
                            <i class="ph ph-text-h-one" style="color: #8F0D0D;"></i>
                            CV Section
                        </button>
                        <button class="latex-toolbar-btn cv-command" onclick="insertLatexCommand('cvevent')" title="Insert CV Event/Experience" style="display: none; padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer;">
                            <i class="ph ph-briefcase" style="color: #8F0D0D;"></i>
                            Experience
                        </button>
                        <button class="latex-toolbar-btn cv-command" onclick="insertLatexCommand('cvskill')" title="Insert CV Skill" style="display: none; padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer;">
                            <i class="ph ph-gear" style="color: #8F0D0D;"></i>
                            Skill
                        </button>
                        <button class="latex-toolbar-btn cv-command" onclick="insertLatexCommand('cvtag')" title="Insert CV Tags" style="display: none; padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer;">
                            <i class="ph ph-tag" style="color: #8F0D0D;"></i>
                            Tags
                        </button>
                    </div>

                    <!-- Monaco Editor Container -->
                    <div id="latex-editor-container" style="flex: 1; overflow: hidden; background: white; font-family: 'Courier New', monospace;">
                        <!-- Monaco Editor will be initialized here -->
                        <textarea id="latexSourceTextarea" placeholder="% Start typing your LaTeX document here...
\documentclass{article}
\usepackage{amsmath,amsthm,amssymb}
\usepackage{graphicx}
\usepackage{geometry}
\geometry{margin=1in}

\title{Your Document Title}
\author{Your Name}
\date{\today}

\begin{document}

\maketitle

\section{Introduction}

Your content here...

\end{document}" style="width: 100%; height: 100%; border: none; padding: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; resize: none; outline: none; background: white;"></textarea>
                    </div>
                </div>

                <!-- Preview pane (right side) -->
                <div id="latexPreviewPane" style="flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden;">
                    <!-- Preview toolbar -->
                    <div style="padding: 8px 16px; background: var(--color-neutral-background); border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button id="compileLatexBtn" onclick="compileLatexToPDF()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <i class="ph ph-file-pdf"></i>
                                Compile PDF
                            </button>
                            <button id="downloadLatexPdfBtn" onclick="downloadLatexPDF()" disabled style="padding: 6px 12px; background: var(--color-neutral-border); color: var(--color-neutral-text); border: none; border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: not-allowed; display: flex; align-items: center; gap: 6px;">
                                <i class="ph ph-download"></i>
                                Download
                            </button>
                            <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Preview:</span>
                            <span id="latexPreviewStatus" style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); font-style: italic;">
                                Click "Compile PDF" to preview
                            </span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label id="autoCompileToggleContainer" style="display: flex; align-items: center; gap: 6px; font-family: var(--font-family-ui); font-size: 12px; color: var(--color-dark); cursor: pointer; user-select: none;">
                                <input type="checkbox" id="autoCompileToggle" onchange="toggleAutoCompile()" checked style="cursor: pointer;">
                                <span>Auto-compile</span>
                            </label>
                            <div style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 12px; color: var(--color-dark);">
                                <input type="number" id="autoCompileInterval" value="2.5" min="0.5" max="30" step="0.5" onchange="updateAutoCompileInterval()" style="width: 50px; padding: 2px 4px; border: 1px solid var(--color-neutral-border); border-radius: 3px; font-size: 12px; text-align: center;">
                                <span>sec</span>
                            </div>
                        </div>
                    </div>

                    <!-- Preview container -->
                    <div id="latexPreviewContainer" style="flex: 1; overflow: auto; background: #f8f8f8; display: flex; align-items: center; justify-content: center;">
                        <!-- Default message before compilation -->
                        <div id="latexPreviewPlaceholder" style="text-align: center; color: var(--color-neutral-text);">
                            <i class="ph ph-file-pdf" style="font-size: 64px; color: var(--color-neutral-border); margin-bottom: 16px;"></i>
                            <p style="font-family: var(--font-family-body); font-size: 14px; margin: 0; max-width: 300px; line-height: 1.5;">
                                Write your LaTeX code on the left, then click "Compile PDF" to see the rendered document.
                            </p>
                            <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light); margin: 16px 0 0 0;">
                                Document compilation happens entirely in your browser - no data is sent to servers.
                            </p>
                        </div>

                        <!-- Preview iframe (hidden until compilation) -->
                        <iframe id="latex-pdf-preview" style="display: none; width: 100%; height: 100%; border: none; background: white;" title="LaTeX Document Preview"></iframe>
                    </div>
                </div>
            </div>

            <!-- Mobile responsive: collapse to single pane on mobile -->
            <style>
                @media (max-width: 768px) {
                    #latexEditor > div:nth-child(2) {
                        flex-direction: column !important;
                    }
                    #latexEditor > div:nth-child(2) > div:first-child {
                        flex: none !important;
                        height: 50% !important;
                        border-right: none !important;
                        border-bottom: 2px solid var(--color-neutral-border) !important;
                    }
                    #latexPreviewPane {
                        flex: none !important;
                        height: 50% !important;
                    }
                }
            </style>
        </div>

        <!-- Code Editor (Monaco/VS Code) -->
        <div id="codeEditor" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 10500; flex-direction: column;">
            <!-- Code Editor Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: var(--color-dark); color: white; border-bottom: 1px solid var(--color-neutral-border);">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button onclick="closeCodeEditor()" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; border-radius: 6px; padding: 8px 12px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-arrow-left"></i>
                        Back
                    </button>
                    <h3 id="codeEditorTitle" style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; margin: 0;">
                        Untitled Code
                    </h3>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <select id="codeLanguageSelect" onchange="changeCodeLanguage()" style="padding: 8px 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                        <option value="javascript">JavaScript</option>
                        <option value="typescript">TypeScript</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="csharp">C#</option>
                        <option value="cpp">C++</option>
                        <option value="go">Go</option>
                        <option value="rust">Rust</option>
                        <option value="php">PHP</option>
                        <option value="ruby">Ruby</option>
                        <option value="sql">SQL</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="json">JSON</option>
                        <option value="yaml">YAML</option>
                        <option value="markdown">Markdown</option>
                        <option value="shell">Shell</option>
                        <option value="powershell">PowerShell</option>
                    </select>
                    <span style="font-family: var(--font-family-body); font-size: 12px; color: rgba(255, 255, 255, 0.7); font-style: italic;">
                        <i class="ph ph-check-circle" style="margin-right: 4px;"></i>
                        <span id="saveIndicator" style="opacity: 0.7; transition: opacity 0.3s;">Auto-save enabled</span>
                    </span>
                </div>
            </div>

            <!-- Monaco Editor Container -->
            <div id="monacoEditorContainer" style="flex: 1; width: 100%; height: calc(100vh - 65px);"></div>
        </div>

        <!-- Markdown Editor (Side-by-Side) -->
        <div id="markdownEditor" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 10500; flex-direction: column;">
            <!-- Markdown Editor Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: var(--color-dark); color: white; border-bottom: 1px solid var(--color-neutral-border);">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button onclick="closeMarkdownEditor()" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; border-radius: 6px; padding: 8px 12px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-arrow-left"></i>
                        Back
                    </button>
                    <h3 id="markdownEditorTitle" style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; margin: 0;">
                        Untitled Markdown
                    </h3>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-family: var(--font-family-body); font-size: 12px; color: rgba(255, 255, 255, 0.7); font-style: italic;">
                        <i class="ph ph-check-circle" style="margin-right: 4px;"></i>
                        <span id="saveIndicator" style="opacity: 0.7; transition: opacity 0.3s;">Auto-save enabled</span>
                    </span>
                </div>
            </div>

            <!-- Split View: Monaco Editor on Left, Preview on Right -->
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- Monaco Editor Container (Left Side) -->
                <div id="monacoMarkdownEditorContainer" style="flex: 1; width: 50%; height: calc(100vh - 65px); border-right: 1px solid #1e1e1e;"></div>

                <!-- Markdown Preview (Right Side) -->
                <div style="flex: 1; width: 50%; height: calc(100vh - 65px); overflow-y: auto; background: #1e1e1e;">
                    <div id="markdownPreview" style="padding: 32px; font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: #d4d4d4; max-width: 800px; margin: 0 auto;">
                        <!-- Rendered markdown will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Presentation Editor (Reveal.js) -->
        <div id="presentationEditor" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 10500; flex-direction: column;">
            <!-- Presentation Editor Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: var(--color-dark); color: white; border-bottom: 1px solid var(--color-neutral-border);">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button onclick="closePresentationEditor()" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; border-radius: 6px; padding: 8px 12px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-arrow-left"></i>
                        Back
                    </button>
                    <h3 id="presentationEditorTitle" style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; margin: 0;">
                        Untitled Presentation
                    </h3>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <!-- Theme Selector -->
                    <select id="presentationThemeSelect" onchange="changePresentationTheme()" style="padding: 8px 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                        <option value="white">White</option>
                        <option value="black">Black</option>
                        <option value="league">League</option>
                        <option value="beige">Beige</option>
                        <option value="sky">Sky</option>
                        <option value="night">Night</option>
                        <option value="serif">Serif</option>
                        <option value="simple">Simple</option>
                        <option value="solarized">Solarized</option>
                        <option value="moon">Moon</option>
                    </select>
                    <!-- Transition Selector -->
                    <select id="presentationTransitionSelect" onchange="changePresentationTransition()" style="padding: 8px 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                        <option value="slide">Slide</option>
                        <option value="fade">Fade</option>
                        <option value="convex">Convex</option>
                        <option value="concave">Concave</option>
                        <option value="zoom">Zoom</option>
                        <option value="none">None</option>
                    </select>
                    <!-- Style Button -->
                    <button onclick="showStyleCustomizer()" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 6px; padding: 8px 16px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-palette"></i>
                        Style
                    </button>
                    <!-- Present Mode Button -->
                    <button onclick="startPresentationMode()" style="background: #10b981; border: none; color: white; border-radius: 6px; padding: 8px 16px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-play"></i>
                        Present
                    </button>
                    <span style="font-family: var(--font-family-body); font-size: 12px; color: rgba(255, 255, 255, 0.7); font-style: italic;">
                        <i class="ph ph-check-circle" style="margin-right: 4px;"></i>
                        <span id="saveIndicator" style="opacity: 0.7; transition: opacity 0.3s;">Auto-save enabled</span>
                    </span>
                </div>
            </div>

            <!-- Main Content: Slides List + Editor + Preview -->
            <div style="display: flex; flex: 1; overflow: hidden; height: calc(100vh - 65px);">
                <!-- Left Sidebar: Slide Thumbnails -->
                <div style="width: 200px; background: var(--color-neutral-background); border-right: 1px solid var(--color-neutral-border); display: flex; flex-direction: column;">
                    <!-- Add Slide Button -->
                    <div style="padding: 12px; border-bottom: 1px solid var(--color-neutral-border);">
                        <button onclick="addSlideToPresentation()" style="width: 100%; padding: 10px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <i class="ph ph-plus"></i>
                            Add Slide
                        </button>
                    </div>
                    <!-- Slide List -->
                    <div id="slidesList" style="flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px;">
                        <!-- Slide thumbnails will be populated here -->
                    </div>
                </div>

                <!-- Right Panel: Editor + Preview -->
                <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <!-- Slide Editor (Top Half) -->
                    <div style="flex: 1; border-bottom: 1px solid var(--color-neutral-border); display: flex; flex-direction: column;">
                        <div style="padding: 12px 16px; background: var(--color-neutral-background); border-bottom: 1px solid var(--color-neutral-border); display: flex; align-items: center; justify-content: space-between;">
                            <h4 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin: 0; color: var(--color-dark);">
                                Edit Slide (Markdown)
                            </h4>
                            <span id="currentSlideNumber" style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">
                                Slide 1 of 1
                            </span>
                        </div>
                        <textarea id="slideContentTextarea" placeholder="# Slide Title

- Bullet point 1
- Bullet point 2

Notes: Add speaker notes here..." style="flex: 1; padding: 16px; border: none; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; resize: none; outline: none;" oninput="updateRevealPreview()"></textarea>
                    </div>

                    <!-- Reveal.js Preview (Bottom Half) -->
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <div style="padding: 12px 16px; background: var(--color-neutral-background); border-bottom: 1px solid var(--color-neutral-border);">
                            <h4 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin: 0; color: var(--color-dark);">
                                Preview
                            </h4>
                        </div>
                        <div id="revealPreview" style="flex: 1; overflow: auto; background: #2b2b2b;">
                            <!-- Reveal.js slides will be rendered here -->
                            <div class="reveal" style="width: 100%; height: 100%;">
                                <div class="slides" id="previewSlides">
                                    <!-- Slides dynamically generated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden File Input for JSON Import -->
        <input type="file" id="jsonFileInput" accept="application/json,.json" style="display: none;">

        <!-- Prompt Builder Modal -->
        <div class="modal" id="promptBuilderModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">Generate LLM Prompt</h2>
                    <button class="modal-close" onclick="closePromptBuilder()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Asset Type -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Asset Type
                            </label>
                            <select id="promptAssetType" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                                <option value="cover-letter">Cover Letter</option>
                                <option value="resume">Resume</option>
                                <option value="linkedin-summary">LinkedIn Summary</option>
                                <option value="interview-prep">Interview Preparation</option>
                                <option value="networking-email">Networking Email</option>
                                <option value="personal-statement">Personal Statement</option>
                            </select>
                        </div>

                        <!-- Interview Type (Interview Prep only) -->
                        <div id="interviewTypeSection" style="display: none; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Interview Type
                            </label>
                            <select id="interviewType" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                                <option value="behavioral">Behavioral (Leadership, teamwork, problem-solving)</option>
                                <option value="technical">Technical (Skills, tools, technical knowledge)</option>
                            </select>
                        </div>

                        <!-- Length (non-interview assets) -->
                        <div id="lengthSection" style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Length
                            </label>
                            <select id="promptLength" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                                <option value="short">Short (1 paragraph / 100-150 words)</option>
                                <option value="medium" selected>Medium (2-3 paragraphs / 250-400 words)</option>
                                <option value="long">Long (4-5 paragraphs / 500-750 words)</option>
                                <option value="comprehensive">Comprehensive (Full detail / 1000+ words)</option>
                            </select>
                        </div>

                        <!-- Number of Items (Interview Prep only) -->
                        <div id="itemCountSection" style="display: none; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Number of Items
                            </label>
                            <select id="itemCount" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                                <option value="5">5 items</option>
                                <option value="10" selected>10 items</option>
                                <option value="15">15 items</option>
                                <option value="20">20 items</option>
                            </select>
                        </div>

                        <!-- Additional Context -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Additional Context <span style="font-weight: 400; color: var(--color-neutral-text);">(Optional)</span>
                            </label>
                            <textarea id="promptContext" placeholder="e.g., Target company: Google, Role: Senior Software Engineer, Emphasize cloud infrastructure experience..." rows="4" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                            <small style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">
                                Add specific details about the target role, company, skills to emphasize, or any other relevant context.
                            </small>
                        </div>

                        <!-- Include Profile Data Options -->
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Include in Prompt
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="includeExperiences" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-dark);">Work Experiences</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="includeStories" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-dark);">STAR Stories</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="includeGoals" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-dark);">Career Goals</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="includePortfolio" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-dark);">Portfolio Projects</span>
                                </label>
                            </div>
                        </div>

                        <!-- Job Opportunity Selector (Seekers only) -->
                        <div id="jobOpportunitySection" style="display: none; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Target Job Opportunity (Optional)
                            </label>
                            <select id="promptJobOpportunity" style="padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer; background: white;">
                                <option value="">None - General prompt</option>
                            </select>
                            <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin: 0; line-height: 1.5;">
                                Select a job opportunity to tailor the prompt for that specific role and company.
                            </p>
                        </div>

                        <!-- Success Message -->
                        <div id="promptCopiedMessage" style="display: none; padding: 12px; background: #dcfce7; border: 1px solid #86efac; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; color: #166534;">
                            <i class="ph ph-check-circle" style="margin-right: 6px;"></i>
                            Prompt copied to clipboard!
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; gap: 12px;">
                    <button onclick="closePromptBuilder()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <div style="display: flex; gap: 12px;">
                        <!-- Attach Prompt button (Seekers only) -->
                        <button id="attachPromptButton" onclick="attachPromptToJob()" style="display: none; padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); color: var(--color-neutral-text); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: not-allowed; display: flex; align-items: center; gap: 6px; opacity: 0.5;">
                            <i class="ph ph-paperclip"></i>
                            Attach to Job
                        </button>
                        <button onclick="downloadPrompt()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-primary-blue); color: var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-download"></i>
                            Download
                        </button>
                        <button onclick="generateAndCopyPrompt()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-copy"></i>
                            Copy Prompt
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Start Modal -->
        <div class="modal" id="rapidOnboardingModal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header" style="position: relative;">
                    <h2 class="modal-title">
                        <i class="ph ph-lightning" style="margin-right: 8px; color: #f97316;"></i>
                        Quick Start
                    </h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button onclick="closeRapidOnboardingModal(); restartTour();" style="padding: 8px 16px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(22, 163, 74, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(22, 163, 74, 0.3)';">
                            <i class="ph ph-play-circle" style="font-size: 16px;"></i>
                            <span>Start Tour</span>
                        </button>
                        <button class="modal-close" onclick="closeRapidOnboardingModal()">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: var(--color-neutral-text); margin: 0 0 24px 0;">
                        Set up your profile to get started with Career Canvas.
                    </p>

                    <!-- Profile Setup Form -->
                    <div style="background: #f8f9fa; border: 2px solid var(--color-neutral-border); border-radius: 12px; padding: 20px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-user-circle" style="font-size: 20px;"></i>
                            Your Profile Information
                        </h3>

                        <!-- Example Profile Selector -->
                        <div style="margin-bottom: 16px; padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 8px;">
                                <i class="ph ph-users-three" style="margin-right: 4px;"></i>Try an Example Profile
                            </label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <button type="button" onclick="loadQuickStartExample('career-changer')" style="width: 100%; padding: 12px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#f0f7ff';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                    <div style="width: 36px; height: 36px; background: #f3e8ff; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                        <i class="ph ph-arrows-clockwise" style="font-size: 20px; color: #9333ea;"></i>
                                    </div>
                                    <div>
                                        <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 2px;">Marcus Thompson</div>
                                        <div style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text); line-height: 1.3;">Store Manager → Analytics</div>
                                    </div>
                                </button>
                                <button type="button" onclick="loadQuickStartExample('product-manager')" style="width: 100%; padding: 12px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#f0f7ff';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                    <div style="width: 36px; height: 36px; background: #e3f2fd; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                        <i class="ph ph-flask" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div>
                                        <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 2px;">Dr. Sarah Chen</div>
                                        <div style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text); line-height: 1.3;">Research Scientist</div>
                                    </div>
                                </button>
                                <button type="button" onclick="loadQuickStartExample('new-graduate')" style="width: 100%; padding: 12px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#f0f7ff';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                    <div style="width: 36px; height: 36px; background: #dcfce7; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                        <i class="ph ph-graduation-cap" style="font-size: 20px; color: #16a34a;"></i>
                                    </div>
                                    <div>
                                        <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 2px;">Jamie Rodriguez</div>
                                        <div style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text); line-height: 1.3;">CS Graduate</div>
                                    </div>
                                </button>
                            </div>
                            <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin-top: 8px; line-height: 1.4;">
                                <i class="ph ph-info" style="margin-right: 2px;"></i>Select an example to explore with pre-loaded career data, or fill in your own information below
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 14px;">
                            <!-- First Name -->
                            <div>
                                <label style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">First Name</label>
                                <input type="text" id="rapidOnboardingFirstName" placeholder="Enter your first name" style="width: 100%; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>

                            <!-- Last Name -->
                            <div>
                                <label style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">Last Name</label>
                                <input type="text" id="rapidOnboardingLastName" placeholder="Enter your last name" style="width: 100%; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>

                            <!-- Profession -->
                            <div>
                                <label style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">Profession / Current Role</label>
                                <input type="text" id="rapidOnboardingProfession" placeholder="e.g., Software Engineer, Marketing Manager" style="width: 100%; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>

                            <!-- Career Goal -->
                            <div>
                                <label style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">Career Goal</label>
                                <textarea id="rapidOnboardingGoal" placeholder="What's your primary career goal?" style="width: 100%; min-height: 60px; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                            </div>

                            <button onclick="saveRapidOnboardingProfile()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(249, 115, 22, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(249, 115, 22, 0.3)';">
                                <i class="ph ph-check-circle" style="font-size: 18px;"></i>
                                Start Building My Career Canvas
                            </button>
                        </div>
                    </div>

                    <!-- Privacy Notice -->
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; margin-top: 20px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #92400e; margin: 0;">
                            <i class="ph ph-lock-simple" style="margin-right: 4px;"></i>
                            <strong>Privacy First:</strong> All data is stored locally in your browser. Cleansheet does not have access to your information unless you explicitly request services by clicking "Inquire" or "Request Profile" buttons. Remember to export your data regularly.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Erasure Request Modal -->
        <div class="modal" id="erasureRequestModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-trash" style="margin-right: 8px; color: #dc2626;"></i>
                        Data Erasure Request
                    </h2>
                    <button class="modal-close" onclick="closeErasureRequestModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: var(--color-neutral-text); margin: 0 0 16px 0;">
                        Submit a request to erase all your data from Cleansheet systems. We take your privacy seriously and will process your request in accordance with applicable data protection laws.
                    </p>

                    <!-- Important Notice about Data Storage -->
                    <div style="background: #e3f2fd; border-left: 4px solid var(--color-primary-blue); padding: 12px; margin-bottom: 24px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #1e40af; margin: 0;">
                            <i class="ph ph-info" style="margin-right: 4px;"></i>
                            <strong>Note:</strong> Cleansheet only has your data if you have requested a profile from Cleansheet. If you built your own profile using the tools on this page, all your data is stored locally in your browser and Cleansheet does not have any of your information, including your name or email address.
                        </p>
                    </div>

                    <!-- Erasure Request Form -->
                    <div style="background: #f8f9fa; border: 2px solid var(--color-neutral-border); border-radius: 12px; padding: 20px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-warning" style="font-size: 20px; color: #dc2626;"></i>
                            Erasure Request Details
                        </h3>

                        <div style="display: flex; flex-direction: column; gap: 14px;">
                            <!-- Name -->
                            <div>
                                <label style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">Full Name *</label>
                                <input type="text" id="erasureRequestName" placeholder="Enter your full name" style="width: 100%; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>

                            <!-- Email -->
                            <div>
                                <label style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">Email Address *</label>
                                <input type="email" id="erasureRequestEmail" placeholder="your.email@example.com" style="width: 100%; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <div style="font-family: var(--font-family-body); font-size: 11px; color: #dc2626; margin-top: 4px;">
                                    <i class="ph ph-warning" style="margin-right: 4px;"></i>You must control this email address to submit an erasure request.
                                </div>
                            </div>

                            <!-- Important Notice -->
                            <div style="background: #fef2f2; padding: 12px; border-radius: 6px; border: 1px solid #dc2626;">
                                <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: #dc2626; margin-bottom: 8px;">
                                    <i class="ph ph-info" style="margin-right: 4px;"></i>Important Information:
                                </div>
                                <ul style="font-family: var(--font-family-body); font-size: 11px; line-height: 1.6; color: #991b1b; margin: 0; padding-left: 20px;">
                                    <li>Upon receipt of your erasure request, Cleansheet will send a confirmation email to verify your identity</li>
                                    <li>You must respond to the confirmation email from the address you provide above</li>
                                    <li>Cleansheet will <strong>erase all records within 30 days</strong> of receipt of confirmation</li>
                                    <li>This action is <strong>irreversible</strong> and will permanently delete all your data from our systems</li>
                                    <li>Local browser data must be cleared manually by you</li>
                                </ul>
                            </div>

                            <button onclick="submitErasureRequest()" style="width: 100%; padding: 12px; background: #dc2626; color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 38, 38, 0.4)'; this.style.background='#b91c1c';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(220, 38, 38, 0.3)'; this.style.background='#dc2626';">
                                <i class="ph ph-paper-plane-tilt" style="font-size: 18px;"></i>
                                Submit Erasure Request
                            </button>
                        </div>
                    </div>

                    <!-- Privacy Notice -->
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; margin-top: 20px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #92400e; margin: 0;">
                            <i class="ph ph-lock-simple" style="margin-right: 4px;"></i>
                            <strong>Your Rights:</strong> You have the right to request access to, correction of, or deletion of your personal data. For questions about our data practices, see our <a href="privacy-policy.html" target="_blank" style="color: #92400e; text-decoration: underline;">Privacy Policy</a>.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Request Confirmation Modal -->
        <div class="modal" id="profileRequestConfirmationModal" style="display: none;">
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-check-circle" style="margin-right: 8px; color: #16a34a;"></i>
                        Profile Request Submitted
                    </h2>
                    <button class="modal-close" onclick="closeProfileRequestConfirmationModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div style="background: #dcfce7; border-left: 4px solid #16a34a; padding: 16px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: #15803d; margin: 0;">
                            <i class="ph ph-check-circle" style="margin-right: 6px; font-size: 18px; vertical-align: middle;"></i>
                            <strong>Thank you!</strong> Your profile request has been successfully submitted.
                        </p>
                    </div>

                    <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <i class="ph ph-envelope" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                        What Happens Next
                    </h3>

                    <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <ol style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.7; color: var(--color-dark); margin: 0; padding-left: 20px;">
                            <li style="margin-bottom: 10px;">Our team will review your LinkedIn profile and publicly available information</li>
                            <li style="margin-bottom: 10px;">We will create your Cleansheet profile using open source data</li>
                            <li style="margin-bottom: 10px;">You'll receive an email from <strong style="color: var(--color-primary-blue);">profiles@cleansheet.dev</strong> with your completed profile</li>
                            <li>We have limited capacity to address demand and attempt to complete this within <strong>72 hours</strong></li>
                        </ol>
                    </div>

                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px; margin-bottom: 20px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #92400e; margin: 0;">
                            <i class="ph ph-info" style="margin-right: 4px;"></i>
                            <strong>In the meantime:</strong> You can start building your career canvas manually using the tools available on this page. All your data is stored locally in your browser.
                        </p>
                    </div>

                    <button onclick="closeProfileRequestConfirmationModal()" style="width: 100%; padding: 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--color-accent-blue)';" onmouseout="this.style.background='var(--color-primary-blue)';">
                        Got It, Thanks!
                    </button>
                </div>
            </div>
        </div>

        <!-- Subscription Profile Request Modal -->
        <div class="modal" id="subscriptionProfileRequestModal" style="display: none; z-index: 10001;">
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-user-focus" style="margin-right: 8px; color: #f97316;"></i>
                        Request a Cleansheet Profile
                    </h2>
                    <button class="modal-close" onclick="closeSubscriptionProfileRequestModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div style="background: #fff7ed; border-left: 4px solid #f97316; padding: 16px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.6; color: #92400e; margin: 0;">
                            <i class="ph ph-info" style="margin-right: 6px; font-size: 16px; vertical-align: middle;"></i>
                            During the preview period, request a Cleansheet profile built from publicly available information.
                        </p>
                    </div>

                    <form id="subscriptionProfileRequestForm" style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Email -->
                        <div>
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">Email Address *</label>
                            <input type="email" id="subProfileEmail" placeholder="your.email@example.com" required style="width: 100%; padding: 10px 12px; border: 2px solid #f97316; border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            <div style="font-family: var(--font-family-body); font-size: 11px; color: #92400e; margin-top: 4px;">
                                <i class="ph ph-warning" style="margin-right: 4px;"></i>You must control this email address. 2FA will be leveraged for verification.
                            </div>
                        </div>

                        <!-- LinkedIn URL -->
                        <div>
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">LinkedIn Profile URL *</label>
                            <input type="url" id="subProfileLinkedIn" placeholder="https://www.linkedin.com/in/yourprofile" required style="width: 100%; padding: 10px 12px; border: 2px solid #f97316; border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Acknowledgement Checkbox -->
                        <div>
                            <label style="display: flex; align-items: start; gap: 10px; cursor: pointer; font-size: 12px; line-height: 1.5; padding: 12px; background: white; border: 2px solid #f97316; border-radius: 6px;">
                                <input type="checkbox" id="subscriptionAcknowledgement" style="margin-top: 2px; width: 16px; height: 16px; cursor: pointer; flex-shrink: 0;">
                                <div style="font-family: var(--font-family-body); color: #92400e;">
                                    I acknowledge that I am requesting a profile <strong>only for myself</strong>, I authorize Cleansheet to perform an <strong>AI-assisted open source search</strong> based on my current profile and the information provided in this form, and I agree to the <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer" style="color: #ea580c; text-decoration: underline; font-weight: 600;">Terms of Service</a>. *
                                </div>
                            </label>
                        </div>

                        <!-- Privacy Notice -->
                        <div style="background: #fffbeb; border: 1px solid #fbbf24; padding: 12px; border-radius: 6px;">
                            <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: #92400e; margin-bottom: 6px;">
                                <i class="ph ph-shield-check" style="margin-right: 4px;"></i>Privacy Notice
                            </div>
                            <ul style="font-family: var(--font-family-body); font-size: 11px; line-height: 1.5; color: #92400e; margin: 0; padding-left: 18px;">
                                <li>Cleansheet will conduct an <strong>open source search</strong> to minimally populate your professional and educational profile</li>
                                <li>Cleansheet will <strong>retain this data</strong> to provide the requested service</li>
                                <li>You can submit <strong>erasure requests</strong> from the user menu</li>
                                <li>This is an <strong>experimental preview service</strong> and data accuracy is not guaranteed</li>
                            </ul>
                        </div>

                        <!-- Buttons -->
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 6px rgba(249, 115, 22, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 8px rgba(249, 115, 22, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(249, 115, 22, 0.3)';">
                                <i class="ph ph-paper-plane-tilt" style="font-size: 18px;"></i>
                                Submit Request
                            </button>
                            <button type="button" onclick="closeSubscriptionProfileRequestModal()" style="padding: 12px 20px; background: white; color: var(--color-neutral-text); border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.color='var(--color-primary-blue)';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.color='var(--color-neutral-text)';">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Mock Interview Interest Modal -->
        <div class="modal" id="mockInterviewInterestModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-video-camera" style="margin-right: 8px; color: var(--color-primary-blue);"></i>
                        Mock Interview Coaching Interest
                    </h2>
                    <button class="modal-close" onclick="closeMockInterviewInterestModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <!-- Introduction -->
                    <div style="background: #e3f2fd; border-left: 4px solid var(--color-primary-blue); padding: 16px; margin-bottom: 24px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.6; color: #1e40af; margin: 0;">
                            <i class="ph ph-info" style="margin-right: 4px;"></i>
                            <strong>We're Building Our Coaching Service!</strong><br>
                            We are currently assembling a team of experienced coaches to provide mock interview sessions. Submit your interest below and we'll contact you when we have coaches available who match your background and career goals.
                        </p>
                    </div>

                    <!-- Email Input -->
                    <div style="margin-bottom: 20px;">
                        <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 8px;">
                            Email Address <span style="color: #dc2626;">*</span>
                        </label>
                        <input type="email" id="mockInterviewEmail" placeholder="your.email@example.com" style="width: 100%; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        <small style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); display: block; margin-top: 4px;">
                            We'll use this to contact you about coaching availability
                        </small>
                    </div>

                    <!-- Data Sharing Notice -->
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #92400e; margin: 0;">
                            <i class="ph ph-share-network" style="margin-right: 4px;"></i>
                            <strong>What We'll Share:</strong> By clicking "Submit Request", you're explicitly authorizing Cleansheet to transmit your profile information, career experience, stories, goals, portfolio, and job opportunities to our coaching team so we can match you with the most appropriate coach for your needs. No data is transmitted without this explicit action.
                        </p>
                    </div>

                    <!-- Consent Checkbox -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="mockInterviewConsent" style="margin-top: 3px; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                            <span style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.5; color: var(--color-dark);">
                                I consent to sharing my profile, career experiences, job opportunities, and portfolio with Cleansheet's coaching team for the purpose of matching me with an appropriate mock interview coach.
                            </span>
                        </label>
                    </div>

                    <!-- Submit Button -->
                    <button onclick="submitMockInterviewInterest()" style="width: 100%; padding: 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(0, 102, 204, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 102, 204, 0.4)'; this.style.background='var(--color-accent-blue)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 102, 204, 0.3)'; this.style.background='var(--color-primary-blue)';">
                        <i class="ph ph-paper-plane-tilt" style="font-size: 18px;"></i>
                        Submit Interest
                    </button>
                </div>
            </div>
        </div>

        <!-- Restore Mode Selection Modal -->
        <div class="modal" id="importModeModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-upload" style="margin-right: 8px; color: var(--color-primary-blue);"></i>
                        Choose Restore Mode
                    </h2>
                    <button class="modal-close" onclick="closeImportModeModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <!-- Restore Summary -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">
                            Restoring:
                        </h3>
                        <div id="importSummary" style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.7; color: var(--color-dark);">
                            <!-- Summary will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Mode Options -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <!-- Overwrite Option -->
                        <button onclick="processImportWithMode(true)" style="padding: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 12px; text-align: center;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-trash" style="font-size: 32px; color: #dc2626;"></i>
                            <div>
                                <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Overwrite</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.4; color: var(--color-neutral-text);">Delete all existing data and replace with backup data</div>
                            </div>
                        </button>

                        <!-- Update/Merge Option -->
                        <button onclick="processImportWithMode(false)" style="padding: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 12px; text-align: center;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-plus-circle" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                            <div>
                                <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Update</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.4; color: var(--color-neutral-text);">Keep existing data and add backup data to it</div>
                            </div>
                        </button>
                    </div>

                    <!-- Info Note -->
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #92400e; margin: 0;">
                            <i class="ph ph-info" style="margin-right: 4px;"></i>
                            <strong>Note:</strong> The page will refresh after restore to update all badge numbers and display the restored data.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Management Modal -->
        <div class="modal" id="dataManagementModal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-database" style="margin-right: 8px; color: var(--color-primary-blue);"></i>
                        Data Management
                    </h2>
                    <button class="modal-close" onclick="closeDataManagementModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: var(--color-neutral-text); margin: 0 0 24px 0;">
                        Manage your Career Canvas data with backup and restore operations.
                    </p>

                    <!-- Action Cards -->
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        <!-- Backup Option -->
                        <button onclick="handleBackupFromModal()" style="padding: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.borderColor='#16a34a'; this.style.background='#f0fdf4';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-download" style="font-size: 32px; color: #16a34a; flex-shrink: 0;"></i>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Backup Data</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.4; color: var(--color-neutral-text);">Export all your Career Canvas data to a JSON file for safekeeping</div>
                            </div>
                        </button>

                        <!-- Restore (Overwrite) Option -->
                        <button onclick="handleRestoreFromModal('overwrite')" style="padding: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-trash" style="font-size: 32px; color: #dc2626; flex-shrink: 0;"></i>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Restore (Overwrite)</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.4; color: var(--color-neutral-text);">Delete all existing data and replace it with backup data from a JSON file</div>
                            </div>
                        </button>

                        <!-- Restore (Update) Option -->
                        <button onclick="handleRestoreFromModal('update')" style="padding: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-plus-circle" style="font-size: 32px; color: var(--color-primary-blue); flex-shrink: 0;"></i>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Restore (Update)</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.4; color: var(--color-neutral-text);">Keep existing data and add backup data to it from a JSON file</div>
                            </div>
                        </button>
                    </div>

                    <!-- Info Note -->
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #92400e; margin: 0;">
                            <i class="ph ph-info" style="margin-right: 4px;"></i>
                            <strong>Note:</strong> We recommend backing up your data regularly. Restore operations will refresh the page to update all data.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup Options Modal -->
        <div class="modal" id="backupOptionsModal" style="display: none; z-index: 11000;">
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-download" style="margin-right: 8px; color: var(--color-primary-blue);"></i>
                        Backup Options
                    </h2>
                    <button class="modal-close" onclick="closeBackupOptionsModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: var(--color-neutral-text); margin: 0 0 24px 0;">
                        Configure your backup settings before exporting.
                    </p>

                    <!-- API Key Backup Option -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="includeApiKeysCheckbox" onchange="toggleApiKeyPassword()" style="margin-top: 2px; width: 18px; height: 18px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Include API Keys (requires password)</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.4; color: var(--color-neutral-text);">Backup your LLM provider API keys with password protection</div>
                            </div>
                        </label>
                    </div>

                    <!-- Password Fields (hidden by default) -->
                    <div id="apiKeyPasswordSection" style="display: none; margin-bottom: 24px; padding: 20px; background: #fffbeb; border-left: 4px solid #f59e0b; border-radius: 4px;">
                        <!-- Warning -->
                        <div style="margin-bottom: 16px;">
                            <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #92400e; margin: 0;">
                                <i class="ph ph-warning" style="margin-right: 4px;"></i>
                                <strong>Important:</strong> If you lose this password, backups will restore WITHOUT API keys. You'll need to re-obtain keys from your LLM providers (OpenAI, Anthropic, etc.).
                            </p>
                        </div>

                        <!-- Password Input -->
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Backup Password</label>
                            <input type="password" id="backupPassword" placeholder="Enter password (min 8 characters)" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Password Confirmation -->
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Confirm Password</label>
                            <input type="password" id="backupPasswordConfirm" placeholder="Re-enter password" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeBackupOptionsModal()" style="padding: 10px 20px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="executeBackupWithOptions()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                            <i class="ph ph-download" style="margin-right: 6px;"></i>
                            Export Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Restore Password Modal -->
        <div class="modal" id="restorePasswordModal" style="display: none; z-index: 11000;">
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-lock-key" style="margin-right: 8px; color: var(--color-primary-blue);"></i>
                        Password Required
                    </h2>
                    <button class="modal-close" onclick="closeRestorePasswordModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: var(--color-neutral-text); margin: 0 0 24px 0;">
                        This backup includes encrypted API keys for: <strong id="restoreProvidersList"></strong>
                    </p>

                    <!-- Info Box -->
                    <div style="margin-bottom: 24px; padding: 16px; background: #e3f2fd; border-left: 4px solid var(--color-primary-blue); border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.5; color: #1a237e; margin: 0;">
                            <i class="ph ph-info" style="margin-right: 4px;"></i>
                            Enter the password you used when creating this backup to restore your API keys.
                        </p>
                    </div>

                    <!-- Error Message (hidden by default) -->
                    <div id="restorePasswordError" style="display: none; margin-bottom: 16px; padding: 12px; background: #fef2f2; border-left: 4px solid #dc2626; border-radius: 4px;">
                        <p id="restorePasswordErrorText" style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.4; color: #991b1b; margin: 0;"></p>
                    </div>

                    <!-- Password Input -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Backup Password</label>
                        <input type="password" id="restorePassword" placeholder="Enter password" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px;">
                            Attempts remaining: <strong id="restoreAttemptsRemaining">3</strong>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="restoreWithoutKeysBtn" onclick="restoreWithoutKeys()" style="padding: 10px 20px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                            Restore Without Keys
                        </button>
                        <button onclick="attemptRestoreWithPassword()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                            <i class="ph ph-lock-key-open" style="margin-right: 6px;"></i>
                            Unlock & Restore
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LaTeX Download Modal -->
        <div class="modal" id="latexDownloadModal" style="display: none; z-index: 15000;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-download" style="margin-right: 8px; color: var(--color-primary-blue);"></i>
                        Download Document
                    </h2>
                    <button class="modal-close" onclick="closeLatexDownloadModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: var(--color-neutral-text); margin: 0 0 24px 0;">
                        Choose how you'd like to save your compiled LaTeX document.
                    </p>

                    <!-- Download Options -->
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        <!-- PDF Download Option -->
                        <button onclick="handlePDFDownload()" style="padding: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-file-pdf" style="font-size: 32px; color: #dc2626; flex-shrink: 0;"></i>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Save as PDF</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.4; color: var(--color-neutral-text);">Opens browser print dialog - select "Save as PDF" as destination (recommended)</div>
                            </div>
                            <i class="ph ph-arrow-right" style="font-size: 20px; color: var(--color-neutral-text); opacity: 0.5;"></i>
                        </button>

                        <!-- HTML Download Option -->
                        <button onclick="handleHTMLDownload()" style="padding: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.borderColor='#16a34a'; this.style.background='#f0fdf4';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-file-html" style="font-size: 32px; color: #16a34a; flex-shrink: 0;"></i>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Download HTML</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.4; color: var(--color-neutral-text);">Save as a standalone HTML file that can be viewed in any web browser</div>
                            </div>
                            <i class="ph ph-arrow-right" style="font-size: 20px; color: var(--color-neutral-text); opacity: 0.5;"></i>
                        </button>

                        <!-- LaTeX Source Option -->
                        <button onclick="handleLatexSourceDownload()" style="padding: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-file-code" style="font-size: 32px; color: var(--color-primary-blue); flex-shrink: 0;"></i>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Download LaTeX Source</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.4; color: var(--color-neutral-text);">Save the raw LaTeX source code (.tex file) for use in other LaTeX editors</div>
                            </div>
                            <i class="ph ph-arrow-right" style="font-size: 20px; color: var(--color-neutral-text); opacity: 0.5;"></i>
                        </button>
                    </div>

                    <!-- Info Note -->
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #92400e; margin: 0;">
                            <i class="ph ph-info" style="margin-right: 4px;"></i>
                            <strong>Privacy Note:</strong> All document processing happens locally in your browser. No data is sent to external servers during download.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Modal -->
        <div class="modal" id="subscriptionModal" style="display: none;" onclick="closeSubscriptionModalOnOutsideClick(event)">
            <div class="modal-content" style="max-width: 1200px; overflow: visible; display: flex; flex-direction: column; max-height: 90vh;" onclick="event.stopPropagation()">
                <div class="modal-header" style="flex-shrink: 0;">
                    <h2 class="modal-title">Choose Your Cleansheet Plan</h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button id="rapidOnboardingBtn" onclick="closeSubscriptionModal(); openRapidOnboardingModal();" style="padding: 8px 16px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 6px rgba(249, 115, 22, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(249, 115, 22, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(249, 115, 22, 0.2)';">
                            <i class="ph ph-lightning" style="font-size: 16px;"></i>
                            <span>Quick Start</span>
                        </button>
                        <button onclick="openInstallAppModal();" style="padding: 8px 16px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(22, 163, 74, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(22, 163, 74, 0.3)';">
                            <i class="ph ph-download-simple" style="font-size: 16px;"></i>
                            <span>Install App</span>
                        </button>
                        <button onclick="closeSubscriptionModal(); restartTour();" style="padding: 8px 16px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(22, 163, 74, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(22, 163, 74, 0.3)';">
                            <i class="ph ph-play-circle" style="font-size: 16px;"></i>
                            <span>Start Tour</span>
                        </button>
                        <button class="modal-close" onclick="closeSubscriptionModal()">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body" style="padding: 20px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <!-- Subscription Tiers Grid -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <!-- Member Tier (Free) -->
                        <div id="memberPlanCard" onclick="selectPlan('member')" style="border: 2px solid var(--color-neutral-border); border-radius: 10px; padding: 16px; background: white; display: flex; flex-direction: column; cursor: pointer; transition: all 0.2s;">
                            <div style="text-align: center; padding-bottom: 12px; border-bottom: 1px solid var(--color-neutral-border);">
                                <h3 style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Member</h3>
                                <div style="font-family: var(--font-family-ui); font-size: 28px; font-weight: 700; color: var(--color-primary-blue); margin-bottom: 2px;">Free</div>
                                <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">Always free, no credit card required</div>
                                <div style="font-family: var(--font-family-body); font-size: 10px; color: #999999; margin-top: 4px; font-style: italic;">Desktop viewport on mobile devices</div>
                            </div>
                            <div style="flex: 1; padding: 14px 0;">
                                <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 10px;">Includes:</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Career Experience Management</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Behavioral Story Journal (STAR)</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">LLM Prompt Generation</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Local Storage (Browser-based)</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Cleansheet Library Access</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Career Path Navigator</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Job Role to Industry Decoder</span>
                                    </div>
                                </div>
                            </div>
                            <button id="memberPlanButton" style="padding: 12px 24px; background: white; border: 2px solid var(--color-primary-blue); border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-primary-blue); cursor: pointer; width: 100%;">
                                Current Plan
                            </button>
                        </div>

                        <!-- Learner Tier -->
                        <div id="learnerPlanCard" onclick="selectPlan('learner')" style="border: 2px solid var(--color-neutral-border); border-radius: 10px; padding: 16px; background: white; display: flex; flex-direction: column; cursor: pointer; transition: all 0.2s;">
                            <div style="text-align: center; padding-bottom: 12px; border-bottom: 1px solid var(--color-neutral-border);">
                                <h3 style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Learner</h3>
                                <div style="font-family: var(--font-family-ui); font-size: 28px; font-weight: 700; color: var(--color-primary-blue); margin-bottom: 2px;">
                                    <span style="text-decoration: line-through; opacity: 0.5;">$9<span style="font-size: 14px; font-weight: 500;">/mo</span></span>
                                    <span style="margin-left: 8px;">FREE</span>
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 11px; color: #16a34a; font-weight: 600;">Free for limited time, no credit card required</div>
                            </div>
                            <div style="flex: 1; padding: 14px 0;">
                                <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 10px;">Everything in Member, plus:</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;"><strong>LLM Integration (Bring your own key)</strong></span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Cleansheet Profile Service <button onclick="event.stopPropagation(); openSubscriptionProfileRequestModal();" style="padding: 2px 8px; margin-left: 4px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; border-radius: 4px; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(249, 115, 22, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(249, 115, 22, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(249, 115, 22, 0.3)';">Request</button></span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Mobile-Responsive Viewport</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Goal Management & Tracking</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Centralized Portfolio Management</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Diagrams & Documents</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-clock" style="font-size: 20px; color: #f59e0b; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Cloud-Based Storage</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-clock" style="font-size: 20px; color: #f59e0b; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Advanced Learning Resources</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: var(--color-primary-blue); flex-shrink: 0; margin-top: 2px;"></i>
                                        <div style="display: flex; flex-direction: column; gap: 6px; flex: 1;">
                                            <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Portfolio Coaching</span>
                                            <button onclick="event.stopPropagation(); openCoachingInquiryModal('portfolio_coaching');" style="padding: 6px 12px; background: linear-gradient(135deg, #0066CC 0%, #004C99 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0, 102, 204, 0.3); width: fit-content;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0, 102, 204, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0, 102, 204, 0.3)';">
                                                <i class="ph ph-chat-circle-dots" style="margin-right: 4px;"></i>Inquire
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button id="learnerPlanButton" style="padding: 12px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s;">
                                Subscribe
                            </button>
                        </div>

                        <!-- Seeker Tier -->
                        <div id="seekerPlanCard" onclick="selectPlan('seeker')" style="border: 2px solid var(--color-neutral-border); border-radius: 10px; padding: 16px; background: white; display: flex; flex-direction: column; cursor: pointer; transition: all 0.2s;">
                            <div style="text-align: center; padding-bottom: 12px; border-bottom: 1px solid var(--color-neutral-border);">
                                <h3 style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Job Seeker</h3>
                                <div style="font-family: var(--font-family-ui); font-size: 28px; font-weight: 700; color: var(--color-primary-blue); margin-bottom: 2px;">
                                    <span style="text-decoration: line-through; opacity: 0.5;">$19<span style="font-size: 14px; font-weight: 500;">/mo</span></span>
                                    <span style="margin-left: 8px;">FREE</span>
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 11px; color: #16a34a; font-weight: 600;">Free for limited time, no credit card required</div>
                            </div>
                            <div style="flex: 1; padding: 14px 0;">
                                <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 10px;">Everything in Learner, plus:</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Job Opportunity Management</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">LLM Prompt Management</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-clock" style="font-size: 20px; color: #f59e0b; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Application Asset Management</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-clock" style="font-size: 20px; color: #f59e0b; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Calendar Synchronization</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-clock" style="font-size: 20px; color: #f59e0b; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Cleansheet AI</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-clock" style="font-size: 20px; color: #f59e0b; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Company Research Tools</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: var(--color-primary-blue); flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Whiteboards and Presentations</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-clock" style="font-size: 20px; color: #f59e0b; flex-shrink: 0; margin-top: 2px;"></i>
                                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Recruiter Profile Sharing</span>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="ph ph-check-circle" style="font-size: 20px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                                        <div style="display: flex; flex-direction: column; gap: 6px; flex: 1;">
                                            <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); line-height: 1.5;">Mock Interviews</span>
                                            <button onclick="event.stopPropagation(); openCoachingInquiryModal('mock_interviews');" style="padding: 6px 12px; background: linear-gradient(135deg, #0066CC 0%, #004C99 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0, 102, 204, 0.3); width: fit-content;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0, 102, 204, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0, 102, 204, 0.3)';">
                                                <i class="ph ph-chat-circle-dots" style="margin-right: 4px;"></i>Inquire
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button id="seekerPlanButton" style="padding: 12px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s;">
                                Subscribe
                            </button>
                        </div>

                    </div>

                    <!-- Cleansheet Engagements Section -->
                    <div style="margin-top: 16px;">
                        <!-- Collapsible Header -->
                        <button onclick="toggleEngagementsSection()" style="width: 100%; padding: 12px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between;" onmouseover="this.style.background='linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)';" onmouseout="this.style.background='linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';">
                            <span>Cleansheet Services & Partnerships</span>
                            <i id="engagementsToggleIcon" class="ph ph-caret-down" style="font-size: 20px; transition: transform 0.3s;"></i>
                        </button>

                        <!-- Engagements Grid (Collapsible) -->
                        <div id="engagementsGrid" style="display: none; margin-top: 12px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <!-- Cleansheet Quarter Engagement -->
                        <div style="padding: 11px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid var(--color-neutral-border);">
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <div style="flex-shrink: 0;">
                                    <div style="width: 40px; height: 40px; background: var(--color-primary-blue); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="ph ph-chalkboard-teacher" style="font-size: 24px; color: white;"></i>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Cleansheet Quarter Engagement</h4>
                                    <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin: 0 0 10px 0; line-height: 1.4;">
                                        12-week structured coaching engagement with a Cleansheet Success Manager. Includes goal setting, capstone project planning, virtual meetings, and personalized guidance tailored to your objectives.
                                    </p>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 700; color: var(--color-primary-blue);">
                                            <span style="text-decoration: line-through; opacity: 0.5;">$1199<span style="font-size: 12px; font-weight: 500;"></span></span>
                                            <span style="margin-left: 8px;">FREE</span>
                                        </div>
                                        <button onclick="openCoachPreviewModal()" style="padding: 6px 12px; background: linear-gradient(135deg, #0066CC 0%, #004C99 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0, 102, 204, 0.3); width: fit-content;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0, 102, 204, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0, 102, 204, 0.3)';">
                                            <i class="ph ph-eye" style="margin-right: 4px;"></i>Preview
                                        </button>
                                        <button onclick="event.stopPropagation(); openCoachingInquiryModal('cleansheet_quarter');" style="padding: 6px 12px; background: linear-gradient(135deg, #0066CC 0%, #004C99 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0, 102, 204, 0.3); width: fit-content;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0, 102, 204, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0, 102, 204, 0.3)';">
                                            <i class="ph ph-chat-circle-dots" style="margin-right: 4px;"></i>Inquire
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recruiter Partnership -->
                        <div style="padding: 11px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid var(--color-neutral-border);">
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <div style="flex-shrink: 0;">
                                    <div style="width: 40px; height: 40px; background: #16a34a; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="ph ph-handshake" style="font-size: 24px; color: white;"></i>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Recruiter Partnership</h4>
                                    <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin: 0 0 10px 0; line-height: 1.4;">
                                        We are exploring partnership opportunities with recruitment professionals and agencies. We are very early in our business development cycle and welcome conversations about potential collaboration models.
                                    </p>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 700; color: #16a34a;">
                                            Early Stage
                                        </div>
                                        <button onclick="window.open('recruiter.html', '_blank')" style="padding: 6px 12px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(22, 163, 74, 0.3); width: fit-content;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(22, 163, 74, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(22, 163, 74, 0.3)';">
                                            <i class="ph ph-cursor-click" style="margin-right: 4px;"></i>Preview
                                        </button>
                                        <button onclick="event.stopPropagation(); openCoachingInquiryModal('recruiter_partnership');" style="padding: 6px 12px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(22, 163, 74, 0.3); width: fit-content;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(22, 163, 74, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(22, 163, 74, 0.3)';">
                                            <i class="ph ph-chat-circle-dots" style="margin-right: 4px;"></i>Inquire
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cleansheet Professional -->
                        <div style="padding: 11px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid var(--color-neutral-border);">
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <div style="flex-shrink: 0;">
                                    <div style="width: 40px; height: 40px; background: #f59e0b; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="ph ph-kanban" style="font-size: 24px; color: white;"></i>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Cleansheet Professional</h4>
                                    <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin: 0 0 10px 0; line-height: 1.4;">
                                        Digital transformation canvas for managing work projects, documents, ML pipelines and automation bots. Enterprise-grade tools for project management and collaborative authoring workflows.
                                    </p>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 700; color: #f59e0b;">
                                            $14-$49<span style="font-size: 12px; font-weight: 500;">/mo</span>
                                        </div>
                                        <button onclick="window.open('canvas-tour-pro.html', '_blank')" style="padding: 6px 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3); width: fit-content;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(245, 158, 11, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(245, 158, 11, 0.3)';">
                                            <i class="ph ph-cursor-click" style="margin-right: 4px;"></i>Preview
                                        </button>
                                        <button onclick="event.stopPropagation(); openCoachingInquiryModal('professional_services');" style="padding: 6px 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3); width: fit-content;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(245, 158, 11, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(245, 158, 11, 0.3)';">
                                            <i class="ph ph-chat-circle-dots" style="margin-right: 4px;"></i>Inquire
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cleansheet Consulting Engagement -->
                        <div style="padding: 11px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid var(--color-neutral-border);">
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <div style="flex-shrink: 0;">
                                    <div style="width: 40px; height: 40px; background: #7c3aed; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="ph ph-briefcase" style="font-size: 24px; color: white;"></i>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Cleansheet Consulting Engagement</h4>
                                    <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin: 0 0 10px 0; line-height: 1.4;">
                                        Enterprise consulting services for digital transformation, data pipeline architecture, and systems integration. Custom engagements tailored to your organization's technical challenges and strategic objectives.
                                    </p>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 700; color: #7c3aed;">
                                            Custom Quote
                                        </div>
                                        <button onclick="event.stopPropagation(); openCoachingInquiryModal('consulting_services');" style="padding: 6px 12px; background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(124, 58, 237, 0.3); width: fit-content;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(124, 58, 237, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(124, 58, 237, 0.3)';">
                                            <i class="ph ph-chat-circle-dots" style="margin-right: 4px;"></i>Inquire
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Comparison Note -->
                    <div style="margin-top: 14px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid var(--color-primary-blue);">
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <i class="ph ph-info" style="font-size: 16px; color: var(--color-primary-blue); flex-shrink: 0; margin-top: 1px;"></i>
                            <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-dark); line-height: 1.4;">
                                <strong>All plans include:</strong> Privacy-first architecture with no third-party tracking, comprehensive STAR story framework, career experience timeline visualization, and access to the Cleansheet learning library. Upgrade or downgrade anytime.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coaching Inquiry Modal -->
        <div class="modal" id="coachingInquiryModal" style="display: none; z-index: 10001;">
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i id="coachingModalIcon" class="ph ph-chalkboard-teacher" style="margin-right: 8px; color: var(--color-primary-blue);"></i>
                        <span id="coachingModalTitle">Request Coaching Session</span>
                    </h2>
                    <button class="modal-close" onclick="closeCoachingInquiryModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <!-- Empty Profile Warning -->
                    <div id="coachingEmptyProfileWarning" style="display: none; background: #fef2f2; border-left: 4px solid #dc2626; padding: 16px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: #991b1b; margin: 0 0 12px 0;">
                            <i class="ph ph-x-circle" style="margin-right: 6px; font-size: 18px; vertical-align: middle;"></i>
                            <strong>Profile Required:</strong> Your profile appears to be empty.
                        </p>
                        <p style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.6; color: #991b1b; margin: 0 0 12px 0;">
                            To provide the best coaching experience, we need to understand your career background. Please complete one of the following before requesting coaching services:
                        </p>
                        <ul style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #991b1b; margin: 0; padding-left: 24px;">
                            <li style="margin-bottom: 6px;">Fill out the <strong>Quick Start</strong> form to set up your basic profile</li>
                            <li style="margin-bottom: 6px;">Use the <strong>Profile Request</strong> service to have us build your profile from LinkedIn</li>
                            <li>Manually add your career experiences using the Career Experience section</li>
                        </ul>
                    </div>

                    <!-- Experience Warning (if < 4 experiences) -->
                    <div id="coachingExperienceWarning" style="display: none; background: #fffbeb; border-left: 4px solid #f59e0b; padding: 14px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.6; color: #92400e; margin: 0 0 10px 0;">
                            <i class="ph ph-warning" style="margin-right: 6px; font-size: 16px; vertical-align: middle;"></i>
                            <strong>Recommendation:</strong> You currently have fewer than 4 career experiences in your profile.
                        </p>
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #92400e; margin: 0;">
                            For the best coaching experience, we recommend using the <strong>Profile Request</strong> service first to fully populate your career history. This will help your coach provide more personalized guidance.
                        </p>
                    </div>

                    <p id="coachingModalDescription" style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.6; color: var(--color-neutral-text); margin: 0 0 20px 0;">
                        Connect with a Cleansheet Success Manager to discuss your career goals and coaching needs.
                    </p>

                    <form id="coachingInquiryForm" style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Email Field -->
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">
                                Email Address *
                            </label>
                            <input type="email" id="coachingInquiryEmail" required
                                   style="width: 100%; padding: 10px 12px; font-family: var(--font-family-body); font-size: 14px; border: 1px solid var(--color-neutral-border); border-radius: 6px; box-sizing: border-box;"
                                   placeholder="your@email.com">
                        </div>

                        <!-- Notes Field -->
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">
                                Additional Notes (Optional)
                            </label>
                            <textarea id="coachingInquiryNotes" rows="4"
                                      style="width: 100%; padding: 10px 12px; font-family: var(--font-family-body); font-size: 14px; border: 1px solid var(--color-neutral-border); border-radius: 6px; box-sizing: border-box; resize: vertical;"
                                      placeholder="Tell us about your coaching goals, specific challenges you're facing, or any questions you have..."></textarea>
                        </div>

                        <!-- Acknowledgement -->
                        <div>
                            <label id="coachingAcknowledgementLabel" style="display: flex; align-items: start; gap: 10px; cursor: pointer; font-size: 12px; line-height: 1.5; padding: 12px; background: #e3f2fd; border: 2px solid var(--color-primary-blue); border-radius: 6px;">
                                <input type="checkbox" id="coachingInquiryAcknowledgement" required style="margin-top: 2px; width: 16px; height: 16px; cursor: pointer; flex-shrink: 0;">
                                <div id="coachingAcknowledgementText" style="font-family: var(--font-family-body); color: #0c4a6e;">
                                    I acknowledge that I am sharing my profile information with Cleansheet to <strong>facilitate the coach match process</strong>, and I agree to the <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary-blue); text-decoration: underline; font-weight: 600;">Terms of Service</a>. *
                                </div>
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" style="width: 100%; padding: 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--color-accent-blue)';" onmouseout="this.style.background='var(--color-primary-blue)';">
                            <i class="ph ph-paper-plane-tilt" style="margin-right: 6px;"></i>
                            Submit Inquiry
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Coaching Inquiry Confirmation Modal -->
        <div class="modal" id="coachingInquiryConfirmationModal" style="display: none; z-index: 10002;">
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="ph ph-check-circle" style="margin-right: 8px; color: #16a34a;"></i>
                        Coaching Inquiry Submitted
                    </h2>
                    <button class="modal-close" onclick="closeCoachingInquiryConfirmationModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div style="background: #dcfce7; border-left: 4px solid #16a34a; padding: 16px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: #15803d; margin: 0;">
                            <i class="ph ph-check-circle" style="margin-right: 6px; font-size: 18px; vertical-align: middle;"></i>
                            <strong>Thank you!</strong> Your coaching inquiry has been successfully submitted.
                        </p>
                    </div>

                    <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <i class="ph ph-calendar-check" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                        What Happens Next
                    </h3>

                    <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <ol style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.7; color: var(--color-dark); margin: 0; padding-left: 20px;">
                            <li style="margin-bottom: 10px;">Our team will review your profile and coaching request</li>
                            <li style="margin-bottom: 10px;">We will match you with the best Cleansheet Success Manager for your goals</li>
                            <li style="margin-bottom: 10px;">You'll receive an email from <strong style="color: var(--color-primary-blue);">coaching@cleansheet.dev</strong> with next steps</li>
                            <li>We typically respond within <strong>24-48 hours</strong></li>
                        </ol>
                    </div>

                    <div style="background: #e3f2fd; border-left: 4px solid var(--color-primary-blue); padding: 12px; border-radius: 4px; margin-bottom: 20px;">
                        <p style="font-family: var(--font-family-body); font-size: 12px; line-height: 1.5; color: #0c4a6e; margin: 0;">
                            <i class="ph ph-info" style="margin-right: 4px;"></i>
                            <strong>While you wait:</strong> Continue building your career canvas and exploring the Cleansheet Library to prepare for your coaching session.
                        </p>
                    </div>

                    <button onclick="closeCoachingInquiryConfirmationModal()" style="width: 100%; padding: 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--color-accent-blue)';" onmouseout="this.style.background='var(--color-primary-blue)';">
                        Got It, Thanks!
                    </button>
                </div>
            </div>
        </div>

        <!-- Install App Modal -->
        <div class="modal" id="installAppModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">Install Career Canvas</h2>
                    <button class="modal-close" onclick="closeInstallAppModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 32px 24px; max-height: 70vh; overflow-y: auto;">
                    <!-- App Icon and Name -->
                    <div style="text-align: center; margin-bottom: 32px;">
                        <img src="assets/high-resolution-logo-files/black-on-transparent.png"
                             alt="Cleansheet Logo"
                             style="width: 120px; height: auto; margin-bottom: 16px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 24px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">
                            Career Canvas
                        </h3>
                        <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">
                            Interactive career management workspace
                        </p>
                    </div>

                    <!-- Install Status -->
                    <div id="installStatus">
                        <!-- Ready to Install -->
                        <div id="installReady" style="display: none;">
                            <div style="background: #e3f2fd; border: 1px solid var(--color-primary-blue); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <i class="ph ph-check-circle" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                    <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">
                                        Ready to Install
                                    </h4>
                                </div>
                                <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0; line-height: 1.5;">
                                    Install Career Canvas on your device for quick access and offline functionality.
                                </p>
                            </div>

                            <button id="installButton" onclick="triggerPWAInstall()"
                                    style="width: 100%; padding: 14px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;">
                                <i class="ph ph-download-simple" style="font-size: 20px;"></i>
                                Install App
                            </button>
                        </div>

                        <!-- Already Installed -->
                        <div id="installComplete" style="display: none;">
                            <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <i class="ph ph-check-circle" style="font-size: 24px; color: #22c55e;"></i>
                                    <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">
                                        App Installed
                                    </h4>
                                </div>
                                <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0; line-height: 1.5;">
                                    Career Canvas is already installed on your device. You can access it from your home screen or app launcher.
                                </p>
                            </div>
                        </div>

                        <!-- Not Available -->
                        <div id="installNotAvailable" style="display: none;">
                            <div style="background: #fef9e7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <i class="ph ph-info" style="font-size: 24px; color: #f59e0b;"></i>
                                    <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">
                                        Install Not Available
                                    </h4>
                                </div>
                                <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 12px 0; line-height: 1.5;">
                                    The app install feature is not available in your current browser. Try:
                                </p>
                                <ul style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0; padding-left: 20px; line-height: 1.6;">
                                    <li>Using Chrome, Edge, or Safari</li>
                                    <li>Accessing the site via HTTPS</li>
                                    <li>Adding to home screen manually (mobile)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Features List -->
                    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--color-neutral-border);">
                        <h4 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0;">
                            Benefits of Installing
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <i class="ph ph-lightning" style="font-size: 20px; color: var(--color-primary-blue); flex-shrink: 0; margin-top: 2px;"></i>
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 2px;">
                                        Quick Access
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.4;">
                                        Launch from your home screen or app launcher
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <i class="ph ph-wifi-slash" style="font-size: 20px; color: var(--color-primary-blue); flex-shrink: 0; margin-top: 2px;"></i>
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 2px;">
                                        Offline Access
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.4;">
                                        Work on your career goals even without internet
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <i class="ph ph-device-mobile" style="font-size: 20px; color: var(--color-primary-blue); flex-shrink: 0; margin-top: 2px;"></i>
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 2px;">
                                        Full-Screen Experience
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.4;">
                                        App-like interface without browser chrome
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <i class="ph ph-bell" style="font-size: 20px; color: var(--color-primary-blue); flex-shrink: 0; margin-top: 2px;"></i>
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 2px;">
                                        Push Notifications
                                    </div>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.4;">
                                        Stay updated with career milestones and goals
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Install Instructions -->
                    <div id="manualInstructions" style="display: none; margin-top: 24px; padding: 16px; background: var(--color-neutral-background); border-radius: 8px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">
                            Manual Installation (Mobile)
                        </h4>
                        <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.6;">
                            <p style="margin: 0 0 8px 0;"><strong>iOS Safari:</strong></p>
                            <ol style="margin: 0 0 12px 0; padding-left: 20px;">
                                <li>Tap the Share button (square with arrow)</li>
                                <li>Scroll down and tap "Add to Home Screen"</li>
                                <li>Tap "Add" to confirm</li>
                            </ol>
                            <p style="margin: 0 0 8px 0;"><strong>Android Chrome:</strong></p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>Tap the menu (three dots)</li>
                                <li>Tap "Add to Home screen"</li>
                                <li>Tap "Add" to confirm</li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeInstallAppModal()"
                            style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- LLM Settings Modal -->
        <div class="modal" id="llmSettingsModal" style="display: none;">
            <div class="modal-overlay" onclick="closeLLMSettingsModal()"></div>
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 style="margin: 0; font-family: var(--font-family-ui); font-size: 20px; font-weight: 600;">
                        <i class="ph ph-robot" style="margin-right: 8px;"></i>
                        AI Assistant Settings
                    </h2>
                    <button class="modal-close" onclick="closeLLMSettingsModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>

                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <!-- Provider Selection -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                            Select Provider
                        </label>
                        <select id="llmProviderSelect" onchange="handleProviderChange()"
                                style="width: 100%; padding: 12px; font-family: var(--font-family-body); font-size: 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: border-color 0.2s;">
                            <option value="">-- Select Provider --</option>
                            <option value="openai">OpenAI (GPT-4, GPT-3.5) ✓ Browser Compatible</option>
                            <option value="anthropic">Anthropic (Claude 3.5, Claude 3) ✓ Browser Compatible</option>
                            <option value="gemini">Google Gemini (Gemini 2.0, 1.5 Pro) ✓ Browser Compatible</option>
                            <option value="azure" disabled>Azure OpenAI (Coming Soon)</option>
                        </select>
                        <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px; line-height: 1.5;">
                            ℹ️ Choose which AI provider you'd like to use. You'll need your own API key.
                        </p>
                    </div>

                    <!-- Shared BYOK Privacy Info (appears for all providers) -->
                    <div id="byokPrivacyInfo" style="display: none; background: #eff6ff; border: 2px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <i class="ph ph-shield-check" style="font-size: 24px; color: #0066CC; flex-shrink: 0; margin-top: 2px;"></i>
                            <div>
                                <h4 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: #0066CC; margin: 0 0 8px 0;">
                                    Bring Your Own Key (BYOK) - Privacy First
                                </h4>
                                <p style="font-family: var(--font-family-body); font-size: 13px; color: #1e40af; margin: 0; line-height: 1.5;">
                                    <strong>Your API key is stored locally</strong> and used directly from your browser.
                                    Conversations stay between you and your chosen AI provider.
                                </p>
                                <p style="font-family: var(--font-family-body); font-size: 13px; color: #1e40af; margin: 8px 0 0 0; line-height: 1.5;">
                                    🔒 <strong>Your API key never touches Cleansheet servers.</strong>
                                    This secure, privacy-first approach applies to all AI providers (OpenAI, Anthropic, and Gemini).
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- OpenAI Configuration -->
                    <div id="openaiConfig" style="display: none;">
                        <div style="background: #f5f5f7; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-family: var(--font-family-ui); font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    OpenAI API Key
                                    <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer"
                                       style="font-weight: 400; color: var(--color-primary-blue); margin-left: 8px; text-decoration: none; font-size: 13px;">
                                        <i class="ph ph-arrow-square-out" style="font-size: 12px;"></i> Get API Key
                                    </a>
                                </label>
                                <input type="password" id="openaiApiKey" placeholder="sk-proj-..." autocomplete="off"
                                       style="width: 100%; padding: 12px; font-family: var(--font-family-body); font-size: 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white;" />
                                <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px; line-height: 1.5;">
                                    🔒 Your API key is encrypted and stored locally in your browser. It's never sent to Cleansheet servers.
                                </p>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-family: var(--font-family-ui); font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Model
                                </label>
                                <select id="openaiModelSelect"
                                        style="width: 100%; padding: 12px; font-family: var(--font-family-body); font-size: 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer;">
                                    <option value="gpt-4o">GPT-4o (Recommended) - ~$0.005/1k tokens</option>
                                    <option value="gpt-4o-mini">GPT-4o Mini (Fast & Cheap) - ~$0.00015/1k tokens</option>
                                    <option value="gpt-4-turbo">GPT-4 Turbo - ~$0.01/1k tokens</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Budget) - ~$0.0005/1k tokens</option>
                                </select>
                            </div>

                            <button onclick="testOpenAIConnection()"
                                    style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-weight: 600; font-size: 14px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px;">
                                <i class="ph ph-check-circle"></i>
                                Test Connection
                            </button>
                            <span id="connectionStatus" style="margin-left: 12px; font-family: var(--font-family-body); font-size: 13px; vertical-align: middle;"></span>
                        </div>
                    </div>

                    <!-- Anthropic Configuration -->
                    <div id="anthropicConfig" style="display: none;">
                        <div style="background: #f5f5f7; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-family: var(--font-family-ui); font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Anthropic API Key
                                    <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener noreferrer"
                                       style="font-weight: 400; color: var(--color-primary-blue); margin-left: 8px; text-decoration: none; font-size: 13px;">
                                        <i class="ph ph-arrow-square-out" style="font-size: 12px;"></i> Get API Key
                                    </a>
                                </label>
                                <input type="password" id="anthropicApiKey" placeholder="sk-ant-..." autocomplete="off"
                                       style="width: 100%; padding: 12px; font-family: var(--font-family-body); font-size: 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white;" />
                                <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px; line-height: 1.5;">
                                    🔒 Your API key is encrypted and stored locally in your browser. It's never sent to Cleansheet servers.
                                </p>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-family: var(--font-family-ui); font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Model
                                </label>
                                <select id="anthropicModelSelect"
                                        style="width: 100%; padding: 12px; font-family: var(--font-family-body); font-size: 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer;">
                                    <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 (Latest) - Best Overall</option>
                                    <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 - Fast & Efficient</option>
                                    <option value="claude-opus-4-1-20250805">Claude Opus 4.1 - Most Capable</option>
                                    <option value="claude-3-5-haiku-20241022">Claude Haiku 3.5 (Legacy)</option>
                                    <option value="claude-3-haiku-20240307">Claude Haiku 3 (Legacy)</option>
                                </select>
                                <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px; line-height: 1.5;">
                                    💡 Claude Sonnet 4.5 offers the best balance of intelligence, speed, and cost. All models have 200K token context.
                                </p>
                            </div>

                            <button onclick="testAnthropicConnection()"
                                    style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-weight: 600; font-size: 14px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px;">
                                <i class="ph ph-check-circle"></i>
                                Test Connection
                            </button>
                            <span id="anthropicConnectionStatus" style="margin-left: 12px; font-family: var(--font-family-body); font-size: 13px; vertical-align: middle;"></span>
                        </div>
                    </div>

                    <!-- Gemini Configuration -->
                    <div id="geminiConfig" style="display: none;">
                        <div style="background: #f5f5f7; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-family: var(--font-family-ui); font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Google AI API Key
                                    <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer"
                                       style="font-weight: 400; color: var(--color-primary-blue); margin-left: 8px; text-decoration: none; font-size: 13px;">
                                        <i class="ph ph-arrow-square-out" style="font-size: 12px;"></i> Get API Key
                                    </a>
                                </label>
                                <input type="password" id="geminiApiKey" placeholder="AIza..." autocomplete="off"
                                       style="width: 100%; padding: 12px; font-family: var(--font-family-body); font-size: 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white;" />
                                <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px; line-height: 1.5;">
                                    🔒 Your API key is encrypted and stored locally in your browser. It's never sent to Cleansheet servers.
                                </p>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-family: var(--font-family-ui); font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Model
                                </label>
                                <select id="geminiModelSelect"
                                        style="width: 100%; padding: 12px; font-family: var(--font-family-body); font-size: 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer;">
                                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental) - Fastest, Latest</option>
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash - Fast & Efficient</option>
                                    <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash-8B - High Volume</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro - Most Capable</option>
                                </select>
                                <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px; line-height: 1.5;">
                                    💡 All Gemini models have 1M+ token context windows. 2.0 Flash is experimental but highly capable.
                                </p>
                            </div>

                            <button onclick="testGeminiConnection()"
                                    style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-weight: 600; font-size: 14px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px;">
                                <i class="ph ph-check-circle"></i>
                                Test Connection
                            </button>
                            <span id="geminiConnectionStatus" style="margin-left: 12px; font-family: var(--font-family-body); font-size: 13px; vertical-align: middle;"></span>
                        </div>
                    </div>

                    <!-- Usage Stats (if configured) -->
                    <div id="llmUsageStats" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--color-neutral-border);">
                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--color-dark);">
                            <i class="ph ph-chart-line" style="margin-right: 6px;"></i>
                            Usage This Month (All Providers)
                        </h3>
                        <!-- Container for all provider usage stats (populated dynamically) -->
                        <div id="usageStatsContainer"></div>
                        <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin: 16px 0 0 0; line-height: 1.5;">
                            💡 This shows your usage through Cleansheet only. Check each provider's dashboard for total account usage.
                        </p>
                    </div>
                </div>

                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeLLMSettingsModal()"
                            style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer; transition: all 0.2s;">
                        Cancel
                    </button>
                    <button onclick="saveLLMSettings()"
                            style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px;">
                        <i class="ph ph-check"></i>
                        Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Onboarding Tour Overlay -->
        <div id="tourOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: 9998; transition: opacity 0.3s ease;"></div>

        <!-- Tour Spotlight (highlights specific elements) -->
        <div id="tourSpotlight" style="display: none; position: fixed; z-index: 9999; pointer-events: none; border: 4px solid var(--color-primary-blue); border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 30px 5px rgba(0, 102, 204, 0.8), inset 0 0 0 2px rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.02); transition: all 0.3s ease;"></div>

        <!-- Tour Card -->
        <div id="tourCard" style="display: none; position: fixed; z-index: 10000; max-width: 480px; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); padding: 0; transition: all 0.3s ease;">
            <!-- Tour Card Header -->
            <div id="tourCardHeader" style="padding: 24px 24px 20px 24px; background: linear-gradient(135deg, var(--color-primary-blue) 0%, var(--color-accent-blue) 100%); border-radius: 12px 12px 0 0; color: white;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i id="tourIcon" class="ph ph-hand-waving" style="font-size: 28px; color: white;"></i>
                        </div>
                        <div>
                            <div id="tourStepIndicator" style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">
                                Step 1 of 4
                            </div>
                            <h3 id="tourTitle" style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; margin: 4px 0 0 0; line-height: 1.2;">
                                Welcome to Cleansheet
                            </h3>
                        </div>
                    </div>
                    <button onclick="skipTour()" style="background: rgba(255, 255, 255, 0.2); border: none; border-radius: 6px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;">
                        <i class="ph ph-x" style="font-size: 20px; color: white;"></i>
                    </button>
                </div>
            </div>

            <!-- Tour Card Body -->
            <div id="tourCardBody" style="padding: 24px;">
                <p id="tourContent" style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); line-height: 1.6; margin: 0;">
                    Let's take a quick tour to help you get started with your career management workspace.
                </p>
            </div>

            <!-- Tour Card Footer -->
            <div id="tourCardFooter" style="padding: 20px 24px; background: var(--color-neutral-background); border-radius: 0 0 12px 12px; display: flex; align-items: center; justify-content: space-between; border-top: 1px solid var(--color-neutral-border);">
                <button id="tourSkipBtn" onclick="skipTour()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer; transition: all 0.2s;">
                    Skip Tour
                </button>
                <div style="display: flex; gap: 10px;">
                    <button id="tourPrevBtn" onclick="previousTourStep()" style="display: none; padding: 10px 20px; background: white; border: 2px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-primary-blue); cursor: pointer; transition: all 0.2s;">
                        Previous
                    </button>
                    <button id="tourNextBtn" onclick="nextTourStep()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;">
                        Next <i class="ph ph-arrow-right" style="font-size: 16px;"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Coach Preview Modal -->
        <div class="modal" id="coachPreviewModal" style="display: none;">
            <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow: hidden; padding: 0;">
                <div class="modal-header" style="position: sticky; top: 0; z-index: 100; background: var(--color-dark);">
                    <h2 class="modal-title">Cleansheet Quarters Preview</h2>
                    <button class="modal-close" onclick="closeCoachPreviewModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 0; height: calc(95vh - 80px); overflow-y: auto;">
                    <iframe id="coachPreviewFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
        </div>

        <!-- About Modal -->
        <div class="modal" id="aboutModal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">About Career Canvas</h2>
                    <button class="modal-close" onclick="closeAboutModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">
                            Your Interactive Career Management Workspace
                        </h3>
                        <p style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; color: var(--color-neutral-text); margin: 0 0 16px 0;">
                            Career Canvas is your personal workspace for managing every aspect of your professional development. Track experiences, prepare for interviews, set goals, showcase projects, and manage job opportunities—all in one integrated platform.
                        </p>
                    </div>

                    <div style="background: var(--color-neutral-background); border-left: 4px solid var(--color-primary-blue); padding: 16px; margin-bottom: 24px; border-radius: 4px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">
                            The Cleansheet Philosophy
                        </h4>
                        <p style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.6; color: var(--color-neutral-text); margin: 0;">
                            Career security in the modern economy comes from intentional diversity of experience: <strong>upskilling</strong> (building deeper expertise in adjacent areas) and <strong>sideskilling</strong> (building breadth across parallel domains). Together, they create professionals who can adapt, pivot, and thrive through change.
                        </p>
                    </div>

                    <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0;">
                        Canvas Features
                    </h3>

                    <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                        <div style="display: flex; gap: 12px; padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="ph ph-briefcase" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Career Experience</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">Document your work history and generate STAR stories for behavioral interviews</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="ph ph-chats-circle" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Interview Prep</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">Practice behavioral questions using your real experiences and STAR methodology</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="ph ph-target" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Goals</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">Set and track career objectives with deadlines and progress milestones</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="ph ph-folder" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Portfolio</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">Showcase your projects, achievements, and technical capabilities</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="ph ph-briefcase" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Job Opportunities</div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">Track applications and generate tailored resumes, cover letters, and prompts</div>
                            </div>
                        </div>
                    </div>

                    <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0;">
                        Additional Resources
                    </h3>

                    <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                        <div style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                <i class="ph ph-path" style="color: var(--color-primary-blue); margin-right: 6px;"></i>Career Paths
                            </div>
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">Explore guided career paths across 9 technical domains with realistic progression routes</div>
                        </div>

                        <div style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                <i class="ph ph-buildings" style="color: var(--color-primary-blue); margin-right: 6px;"></i>Industry Insights
                            </div>
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">Discover industry-specific information, trends, and role requirements across sectors</div>
                        </div>

                        <div style="padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">
                                <i class="ph ph-books" style="color: var(--color-primary-blue); margin-right: 6px;"></i>Curated Library
                            </div>
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">Access 189+ curated articles on technical skills, career development, and professional growth</div>
                        </div>
                    </div>

                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px; margin-bottom: 24px; border-radius: 4px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: #92400e; margin: 0 0 8px 0;">
                            <i class="ph ph-shield-check" style="margin-right: 6px;"></i>Your Privacy Matters
                        </h4>
                        <p style="font-family: var(--font-family-body); font-size: 13px; line-height: 1.6; color: #92400e; margin: 0;">
                            During the preview, all your data is stored locally in your browser. Nothing is shared with Cleansheet servers. We don't track your behavior, sell your data, or use your information to train AI models. Your professional development belongs to you.
                        </p>
                    </div>

                    <div style="text-align: center; padding-top: 16px; border-top: 1px solid var(--color-neutral-border);">
                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 12px 0;">
                            Learn more about Cleansheet's mission and values
                        </p>
                        <a href="about-cleansheet.html" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; background: var(--color-primary-blue); color: white; text-decoration: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; transition: all 0.2s;">
                            <i class="ph ph-arrow-square-out"></i>
                            <span>Read Full About Page</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Experience Modal -->
        <div class="modal" id="experienceModal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title" id="experienceModalTitle">Add Experience</h2>
                    <button class="modal-close" onclick="closeExperienceModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <form id="experienceForm" style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Basic Information -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="display: flex; flex-direction: column; gap: 8px; grid-column: 1/-1;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Role / Position *</label>
                                <input type="text" id="expRole" required placeholder="e.g., Product Manager" style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 8px; grid-column: 1/-1;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Organization Name *</label>
                                <input type="text" id="expOrganization" required placeholder="e.g., Dell Technologies" style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Location</label>
                                <input type="text" id="expLocation" placeholder="e.g., Glastonbury, CT" style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Start Date</label>
                                <div style="display: flex; gap: 8px;">
                                    <select id="expStartMonth" style="flex: 1; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                                        <option value="">Month</option>
                                        <option value="01">January</option>
                                        <option value="02">February</option>
                                        <option value="03">March</option>
                                        <option value="04">April</option>
                                        <option value="05">May</option>
                                        <option value="06">June</option>
                                        <option value="07">July</option>
                                        <option value="08">August</option>
                                        <option value="09">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                    <input type="number" id="expStartYear" placeholder="Year" min="1950" max="2099" style="flex: 0 0 100px; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                </div>
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">End Date</label>
                                <div style="display: flex; gap: 8px;">
                                    <select id="expEndMonth" style="flex: 1; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                                        <option value="">Month</option>
                                        <option value="01">January</option>
                                        <option value="02">February</option>
                                        <option value="03">March</option>
                                        <option value="04">April</option>
                                        <option value="05">May</option>
                                        <option value="06">June</option>
                                        <option value="07">July</option>
                                        <option value="08">August</option>
                                        <option value="09">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                    <input type="number" id="expEndYear" placeholder="Year" min="1950" max="2099" style="flex: 0 0 100px; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                </div>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="expCurrentRole" onchange="toggleEndDate()" style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="expCurrentRole" style="font-family: var(--font-family-ui); font-size: 13px; color: var(--color-dark); cursor: pointer;">Currently in this role</label>
                            </div>
                        </div>

                        <!-- Description -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Description</label>
                            <textarea id="expDescription" rows="3" placeholder="Brief description of your role and responsibilities..." style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Technologies -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Technologies</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="expTechName" placeholder="Technology name" onkeypress="if(event.key==='Enter'){event.preventDefault();addTechnology();}" style="flex: 2; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                <select id="expTechType" style="flex: 0 0 120px; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                    <option value="Core">Core</option>
                                    <option value="Peripheral">Peripheral</option>
                                </select>
                                <button type="button" onclick="addTechnology()" style="flex: 0 0 auto; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <div id="expTechList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px;">
                                <!-- Technology tags will appear here -->
                            </div>
                        </div>

                        <!-- Key Skills -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Key Skills</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="expSkillName" placeholder="Skill name" onkeypress="if(event.key==='Enter'){event.preventDefault();addSkill();}" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                <button type="button" onclick="addSkill()" style="flex: 0 0 auto; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <div id="expSkillList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px;">
                                <!-- Skill tags will appear here -->
                            </div>
                        </div>

                        <!-- Competencies -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Competencies</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="expCompetencyName" placeholder="Competency name" onkeypress="if(event.key==='Enter'){event.preventDefault();addCompetency();}" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                <button type="button" onclick="addCompetency()" style="flex: 0 0 auto; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <div id="expCompetencyList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px;">
                                <!-- Competency tags will appear here -->
                            </div>
                        </div>

                        <!-- Achievements -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Achievements</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="expAchievementText" placeholder="Achievement description" onkeypress="if(event.key==='Enter'){event.preventDefault();addAchievement();}" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                <button type="button" onclick="addAchievement()" style="flex: 0 0 auto; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <ul id="expAchievementList" style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px;">
                                <!-- Achievement items will appear here -->
                            </ul>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeExperienceModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveExperience()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                        Save Experience
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Goal Modal -->
        <div class="modal" id="goalModal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title" id="goalModalTitle">Add SMART Goal</h2>
                    <button class="modal-close" onclick="closeGoalModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <!-- SMART Goals Explanation -->
                    <div style="margin-bottom: 20px; padding: 12px; background: #e3f2fd; border-left: 4px solid var(--color-primary-blue); border-radius: 6px;">
                        <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">SMART Goals Framework</div>
                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); line-height: 1.4;">
                            <strong>S</strong>pecific • <strong>M</strong>easurable • <strong>A</strong>chievable • <strong>R</strong>elevant • <strong>T</strong>ime-bound
                        </div>
                    </div>

                    <form id="goalForm" style="display: flex; flex-direction: column; gap: 18px;">
                        <!-- Goal Title -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Goal Title *</label>
                            <input type="text" id="goalTitle" required placeholder="e.g., Complete AWS Solutions Architect Certification" style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Category -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Category</label>
                            <select id="goalCategory" style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                                <option value="Career Development">Career Development</option>
                                <option value="Technical Skills">Technical Skills</option>
                                <option value="Professional Skills">Professional Skills</option>
                                <option value="Education">Education</option>
                                <option value="Networking">Networking</option>
                                <option value="Personal Growth">Personal Growth</option>
                            </select>
                        </div>

                        <!-- Specific -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                <i class="ph ph-target" style="color: var(--color-primary-blue);"></i> Specific: What exactly will you accomplish?
                            </label>
                            <textarea id="goalSpecific" rows="2" placeholder="Clearly define what you want to achieve..." style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Measurable -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                <i class="ph ph-chart-line" style="color: var(--color-primary-blue);"></i> Measurable: How will you track progress?
                            </label>
                            <textarea id="goalMeasurable" rows="2" placeholder="Define specific metrics or milestones..." style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Achievable -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                <i class="ph ph-check-circle" style="color: var(--color-primary-blue);"></i> Achievable: What resources do you need?
                            </label>
                            <textarea id="goalAchievable" rows="2" placeholder="Identify resources, skills, and support needed..." style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Relevant -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                <i class="ph ph-lightbulb" style="color: var(--color-primary-blue);"></i> Relevant: Why does this goal matter?
                            </label>
                            <textarea id="goalRelevant" rows="2" placeholder="Explain how this aligns with your career objectives..." style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Time-bound -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                    <i class="ph ph-calendar" style="color: var(--color-primary-blue);"></i> Target Date
                                </label>
                                <input type="date" id="goalTargetDate" style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Status</label>
                                <select id="goalStatus" style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                                    <option value="Not Started">Not Started</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="On Hold">On Hold</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">
                                Progress: <span id="goalProgressValue">0</span>%
                            </label>
                            <input type="range" id="goalProgress" min="0" max="100" value="0" oninput="document.getElementById('goalProgressValue').textContent = this.value" style="width: 100%; cursor: pointer;">
                        </div>

                        <!-- Notes -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Additional Notes</label>
                            <textarea id="goalNotes" rows="2" placeholder="Any additional context or notes..." style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeGoalModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveGoal()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                        Save Goal
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Portfolio Project Modal -->
        <div class="modal" id="portfolioModal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title" id="portfolioModalTitle">Add Portfolio Project</h2>
                    <button class="modal-close" onclick="closePortfolioModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <form id="portfolioForm" style="display: flex; flex-direction: column; gap: 18px;">
                        <!-- Project Name -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Project Name *</label>
                            <input type="text" id="portfolioName" required placeholder="e.g., E-commerce Platform Redesign" style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Link -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Link</label>
                            <input type="url" id="portfolioLink" placeholder="https://github.com/username/project or https://example.com" style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>

                        <!-- Description -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Description</label>
                            <textarea id="portfolioDescription" rows="4" placeholder="Describe the project, your role, and key outcomes..." style="padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <!-- Technologies -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Technologies</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="portfolioTechName" placeholder="Technology name" onkeypress="if(event.key==='Enter'){event.preventDefault();addPortfolioTechnology();}" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                <button type="button" onclick="addPortfolioTechnology()" style="flex: 0 0 auto; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <div id="portfolioTechList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px;">
                                <!-- Technology tags will appear here -->
                            </div>
                        </div>

                        <!-- Key Skills -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Key Skills</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="portfolioSkillName" placeholder="Skill name" onkeypress="if(event.key==='Enter'){event.preventDefault();addPortfolioSkill();}" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                <button type="button" onclick="addPortfolioSkill()" style="flex: 0 0 auto; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <div id="portfolioSkillList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px;">
                                <!-- Skill tags will appear here -->
                            </div>
                        </div>

                        <!-- Competencies -->
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Competencies</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="portfolioCompetencyName" placeholder="Competency name" onkeypress="if(event.key==='Enter'){event.preventDefault();addPortfolioCompetency();}" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                <button type="button" onclick="addPortfolioCompetency()" style="flex: 0 0 auto; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                            <div id="portfolioCompetencyList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px;">
                                <!-- Competency tags will appear here -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closePortfolioModal()" style="padding: 10px 20px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="savePortfolioProject()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                        Save Project
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Source Selection Modal -->
        <div class="modal" id="dataSourceModal" style="display: none;">
            <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 class="modal-title">Connect Data Source</h2>
                    <button class="modal-close" onclick="closeDataSourceModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 24px;">
                        Select a data source to import data into your table.
                    </p>

                    <!-- Two Column Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">

                        <!-- Left Column -->
                        <div>
                            <!-- CRM & ERP Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('crm')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-buildings" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">CRM & ERP</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="crm-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="crm-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('CRM & ERP', 'Salesforce')" class="data-source-btn">
                                            <i class="ph ph-cloud"></i> Salesforce
                                        </button>
                                        <button onclick="selectDataSource('CRM & ERP', 'Oracle ERP')" class="data-source-btn">
                                            <i class="ph ph-database"></i> Oracle ERP
                                        </button>
                                        <button onclick="selectDataSource('CRM & ERP', 'Microsoft Dynamics')" class="data-source-btn">
                                            <i class="ph ph-microsoft-logo"></i> MS Dynamics
                                        </button>
                                        <button onclick="selectDataSource('CRM & ERP', 'SAP')" class="data-source-btn">
                                            <i class="ph ph-factory"></i> SAP
                                        </button>
                                        <button onclick="selectDataSource('CRM & ERP', 'HubSpot')" class="data-source-btn">
                                            <i class="ph ph-funnel"></i> HubSpot
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Services Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('data')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-database" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Data Services</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="data-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="data-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Data Services', 'Snowflake')" class="data-source-btn">
                                            <i class="ph ph-snowflake"></i> Snowflake
                                        </button>
                                        <button onclick="selectDataSource('Data Services', 'Microsoft Dataverse')" class="data-source-btn">
                                            <i class="ph ph-microsoft-logo"></i> Dataverse
                                        </button>
                                        <button onclick="selectDataSource('Data Services', 'AWS S3')" class="data-source-btn">
                                            <i class="ph ph-amazon-logo"></i> AWS S3
                                        </button>
                                        <button onclick="selectDataSource('Data Services', 'Azure Data Lake')" class="data-source-btn">
                                            <i class="ph ph-cloud"></i> Azure Data Lake
                                        </button>
                                        <button onclick="selectDataSource('Data Services', 'Google BigQuery')" class="data-source-btn">
                                            <i class="ph ph-google-logo"></i> BigQuery
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- File Services Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('file')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-folder-open" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">File Services</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="file-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="file-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('File Services', 'OneDrive')" class="data-source-btn">
                                            <i class="ph ph-microsoft-onedrive-logo"></i> OneDrive
                                        </button>
                                        <button onclick="selectDataSource('File Services', 'Dropbox')" class="data-source-btn">
                                            <i class="ph ph-dropbox-logo"></i> Dropbox
                                        </button>
                                        <button onclick="selectDataSource('File Services', 'Box')" class="data-source-btn">
                                            <i class="ph ph-package"></i> Box
                                        </button>
                                        <button onclick="selectDataSource('File Services', 'Google Drive')" class="data-source-btn">
                                            <i class="ph ph-google-drive-logo"></i> Google Drive
                                        </button>
                                        <button onclick="selectDataSource('File Services', 'SharePoint')" class="data-source-btn">
                                            <i class="ph ph-microsoft-sharepoint-logo"></i> SharePoint
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Finance Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('finance')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-chart-line" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Finance</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="finance-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="finance-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Finance', 'Bloomberg')" class="data-source-btn">
                                            <i class="ph ph-trend-up"></i> Bloomberg
                                        </button>
                                        <button onclick="selectDataSource('Finance', 'Morningstar')" class="data-source-btn">
                                            <i class="ph ph-star"></i> Morningstar
                                        </button>
                                        <button onclick="selectDataSource('Finance', 'Refinitiv')" class="data-source-btn">
                                            <i class="ph ph-globe"></i> Refinitiv
                                        </button>
                                        <button onclick="selectDataSource('Finance', 'FactSet')" class="data-source-btn">
                                            <i class="ph ph-briefcase"></i> FactSet
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Payments Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('payments')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-credit-card" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Payments</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="payments-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="payments-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Payments', 'Stripe')" class="data-source-btn">
                                            <i class="ph ph-stripe-logo"></i> Stripe
                                        </button>
                                        <button onclick="selectDataSource('Payments', 'Plaid')" class="data-source-btn">
                                            <i class="ph ph-bank"></i> Plaid
                                        </button>
                                        <button onclick="selectDataSource('Payments', 'PayPal')" class="data-source-btn">
                                            <i class="ph ph-paypal-logo"></i> PayPal
                                        </button>
                                        <button onclick="selectDataSource('Payments', 'Square')" class="data-source-btn">
                                            <i class="ph ph-square-logo"></i> Square
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Healthcare Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('healthcare')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-heartbeat" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Healthcare</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="healthcare-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="healthcare-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Healthcare', 'Epic')" class="data-source-btn">
                                            <i class="ph ph-hospital"></i> Epic
                                        </button>
                                        <button onclick="selectDataSource('Healthcare', 'Cerner')" class="data-source-btn">
                                            <i class="ph ph-first-aid-kit"></i> Cerner
                                        </button>
                                        <button onclick="selectDataSource('Healthcare', 'Meditech')" class="data-source-btn">
                                            <i class="ph ph-clipboard-text"></i> Meditech
                                        </button>
                                        <button onclick="selectDataSource('Healthcare', 'Athenahealth')" class="data-source-btn">
                                            <i class="ph ph-heartbeat"></i> Athenahealth
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Retail & Ecommerce Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('retail')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-storefront" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Retail & Ecommerce</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="retail-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="retail-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'Shopify')" class="data-source-btn">
                                            <i class="ph ph-shopping-bag"></i> Shopify
                                        </button>
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'Wix')" class="data-source-btn">
                                            <i class="ph ph-palette"></i> Wix
                                        </button>
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'Square')" class="data-source-btn">
                                            <i class="ph ph-square-logo"></i> Square
                                        </button>
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'WooCommerce')" class="data-source-btn">
                                            <i class="ph ph-shopping-cart"></i> WooCommerce
                                        </button>
                                        <button onclick="selectDataSource('Retail & Ecommerce', 'BigCommerce')" class="data-source-btn">
                                            <i class="ph ph-storefront"></i> BigCommerce
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Insurance Category -->
                            <div style="margin-bottom: 16px; border: 2px solid var(--color-neutral-border); border-radius: 12px; overflow: hidden;">
                                <div onclick="toggleDataSourceCategory('insurance')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--color-neutral-background); cursor: pointer; transition: background 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="ph ph-shield-check" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                        <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">Insurance</h3>
                                    </div>
                                    <i class="ph ph-caret-down" id="insurance-caret" style="font-size: 20px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                                </div>
                                <div id="insurance-content" style="display: none; padding: 16px; background: white;">
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button onclick="selectDataSource('Insurance', 'Guidewire')" class="data-source-btn">
                                            <i class="ph ph-shield"></i> Guidewire
                                        </button>
                                        <button onclick="selectDataSource('Insurance', 'Duck Creek')" class="data-source-btn">
                                            <i class="ph ph-umbrella"></i> Duck Creek
                                        </button>
                                        <button onclick="selectDataSource('Insurance', 'Applied Epic')" class="data-source-btn">
                                            <i class="ph ph-file-text"></i> Applied Epic
                                        </button>
                                        <button onclick="selectDataSource('Insurance', 'Vertafore')" class="data-source-btn">
                                            <i class="ph ph-buildings"></i> Vertafore
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Data Source Configuration Modal -->
        <div class="modal" id="dataSourceConfigModal" style="display: none;">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh;">
                <div class="modal-header">
                    <h2 class="modal-title" id="dataSourceConfigTitle">Configure Data Source</h2>
                    <button class="modal-close" onclick="closeDataSourceConfig()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 140px);">
                    <div id="dataSourceConfigForm">
                        <!-- Form fields will be dynamically generated here -->
                    </div>
                </div>
                <div style="padding: 16px 24px; border-top: 1px solid var(--color-neutral-border); display: flex; justify-content: flex-end; gap: 12px; background: white;">
                    <button onclick="closeDataSourceConfig()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; transition: all 0.2s;">
                        Cancel
                    </button>
                    <button onclick="saveDataSourceConfig()" style="padding: 8px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="ph ph-check-circle" style="margin-right: 6px;"></i> Save Connection
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Wizard Modal -->
        <div class="modal" id="tableWizardModal">
            <div class="modal-content" style="max-width: 1200px;">
                <div class="modal-header">
                    <h2 class="modal-title">New Table</h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <!-- Export SQL Button -->
                        <button onclick="exportTableSQL()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-download-simple"></i> Export SQL
                        </button>
                        <!-- Cancel Button -->
                        <button onclick="closeModal('tableWizardModal')" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                            Cancel
                        </button>
                        <!-- Save Table Schema Button -->
                        <button onclick="saveTableSchema()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                            Save Table Schema
                        </button>
                        <button class="modal-close" onclick="closeModal('tableWizardModal')">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body" style="padding: 24px; max-height: calc(90vh - 140px); overflow-y: auto;">

                    <!-- Table Metadata Section -->
                    <div style="background: var(--color-neutral-background); border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0;">Table Information</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: flex; align-items: center; gap: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">
                                    Schema Name
                                    <i class="ph ph-info" title="Namespace for organizing tables. Use 'public' for default schema or create custom schemas for logical grouping." style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                                </label>
                                <input type="text" id="schemaName" value="public" oninput="updateSQLPreview()" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; gap: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">
                                    Table Name <span style="color: #dc2626;">*</span>
                                    <i class="ph ph-info" title="Unique identifier for this table within the schema. Must start with a letter or underscore, followed by letters, numbers, or underscores." style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                                </label>
                                <input type="text" id="tableName" placeholder="e.g., users, products, orders" oninput="updateSQLPreview()" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">Comment</label>
                            <textarea id="tableComment" placeholder="Description of this table..." oninput="updateSQLPreview()" style="width: 100%; min-height: 60px; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                        </div>

                        <div style="display: flex; gap: 24px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;" title="Prevents error if table already exists - useful for idempotent scripts">
                                <input type="checkbox" id="ifNotExists" onchange="updateSQLPreview()" style="width: 16px; height: 16px;">
                                <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);">IF NOT EXISTS</span>
                                <i class="ph ph-info" style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;" title="Table exists only for the duration of the session - automatically dropped when connection ends">
                                <input type="checkbox" id="temporary" onchange="updateSQLPreview()" style="width: 16px; height: 16px;">
                                <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);">Temporary</span>
                                <i class="ph ph-info" style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;" title="Faster writes but not crash-safe - data not written to write-ahead log (WAL). Use for temporary/staging data.">
                                <input type="checkbox" id="unlogged" onchange="updateSQLPreview()" style="width: 16px; height: 16px;">
                                <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);">Unlogged</span>
                                <i class="ph ph-info" style="font-size: 14px; color: var(--color-primary-blue); cursor: help;"></i>
                            </label>
                        </div>
                    </div>

                    <!-- Columns Section -->
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0;">Columns</h3>
                            <button onclick="addTableColumn()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <i class="ph ph-plus"></i> Add Column
                            </button>
                        </div>

                        <div id="tableColumnsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Column rows will be added here -->
                        </div>
                    </div>

                    <!-- SQL Preview Section -->
                    <div style="background: #1a1a1a; border-radius: 8px; padding: 20px;">
                        <h3 style="display: flex; align-items: center; gap: 8px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: white; margin: 0 0 12px 0;">
                            SQL Preview
                            <i class="ph ph-info" title="Live preview of the CREATE TABLE statement - updates as you configure the table above" style="font-size: 14px; color: #00ff00; cursor: help;"></i>
                        </h3>
                        <pre id="sqlPreview" style="font-family: 'Courier New', monospace; font-size: 13px; color: #00ff00; margin: 0; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">-- Configure table above to see SQL</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relationship Manager Modal -->
        <div class="modal" id="relationshipManagerModal">
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h2 class="modal-title">Manage Table Relationships</h2>
                    <button class="modal-close" onclick="closeModal('relationshipManagerModal')">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Add New Relationship Section -->
                    <div style="background: #f8f8f8; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin: 0 0 16px 0;">
                            <i class="ph ph-plus-circle" style="color: var(--color-primary-blue);"></i> Add New Relationship
                        </h3>

                        <!-- Table Selection Row -->
                        <div style="display: grid; grid-template-columns: 1fr 120px 1fr; gap: 16px; align-items: end; margin-bottom: 16px;">
                            <!-- Source Table -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                    Source Table
                                    <i class="ph ph-info" title="The table that contains the foreign key" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                                </label>
                                <select id="sourceTable" onchange="updateSourceColumns()" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                    <option value="">Select table...</option>
                                </select>
                            </div>

                            <!-- Relationship Type -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Type</label>
                                <select id="relationshipType" onchange="updateRelationshipPreview()" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                    <option value="many-to-one">M:1</option>
                                    <option value="one-to-one">1:1</option>
                                    <option value="many-to-many">M:M</option>
                                </select>
                            </div>

                            <!-- Target Table -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                    Target Table
                                    <i class="ph ph-info" title="The table that is being referenced" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                                </label>
                                <select id="targetTable" onchange="updateTargetColumns()" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                                    <option value="">Select table...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Column Mapping Row -->
                        <div style="display: grid; grid-template-columns: 1fr 120px 1fr; gap: 16px; align-items: end; margin-bottom: 16px;">
                            <!-- Source Columns -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                    Source Column(s) *
                                    <i class="ph ph-info" title="The column(s) containing the foreign key values" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                                </label>
                                <div id="sourceColumnsContainer" style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; background: #f8f8f8; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text);">
                                    Select source table first
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin-top: 4px;">
                                    Click columns to select/deselect
                                </div>
                            </div>

                            <!-- Visual Connection -->
                            <div style="display: flex; align-items: center; justify-content: center; margin-top: 20px;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                    <i class="ph ph-arrows-horizontal" style="font-size: 20px; color: var(--color-primary-blue);"></i>
                                    <div id="relationshipPreview" style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text); text-align: center; font-weight: 600;">
                                        MAPS TO
                                    </div>
                                </div>
                            </div>

                            <!-- Target Columns -->
                            <div>
                                <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                    Target Column(s) *
                                    <i class="ph ph-info" title="The column(s) being referenced (usually primary key)" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                                </label>
                                <div id="targetColumnsContainer" style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; background: #f8f8f8; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text);">
                                    Select target table first
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin-top: 4px;">
                                    Click columns to select/deselect
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 16px;">
                            <label style="display: block; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">
                                Relationship Label
                                <i class="ph ph-info" title="Describe how the tables relate (e.g., 'has contact', 'belongs to')" style="color: var(--color-primary-blue); cursor: help; font-size: 14px; margin-left: 4px;"></i>
                            </label>
                            <input type="text" id="relationshipLabel" placeholder="e.g., has contact, belongs to, part of" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>

                        <button onclick="addRelationship()" style="margin-top: 16px; padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-plus"></i> Add Relationship
                        </button>
                    </div>

                    <!-- Existing Relationships List -->
                    <div>
                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin: 0 0 16px 0;">
                            <i class="ph ph-list" style="color: var(--color-primary-blue);"></i> Existing Relationships
                        </h3>
                        <div id="relationshipsList" style="max-height: 400px; overflow-y: auto;">
                            <!-- Relationship cards will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Guided Setup Modal -->
        <div class="simple-pipeline-wizard-modal" id="tableGuidedSetupModal">
            <div class="simple-pipeline-wizard-content">
                <div class="simple-pipeline-wizard-header">
                    <h3>Create Your First Table</h3>
                    <button class="simple-pipeline-wizard-close" onclick="closeTableGuidedSetup()">&times;</button>
                </div>

                <!-- Progress Indicator -->
                <div class="simple-wizard-progress">
                    <div class="simple-progress-bar">
                        <div class="simple-progress-fill" id="tableGuidedProgressFill"></div>
                    </div>
                    <div class="simple-progress-text" id="tableGuidedProgressText">Step 1 of 3</div>
                </div>

                <div class="simple-pipeline-wizard-body">
                    <!-- Step 1: Choose Use Case -->
                    <div class="simple-wizard-step-content active" id="tableGuidedStep1">
                        <div class="wizard-welcome">
                            <i class="ph ph-table" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                            <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">What will you track?</h4>
                            <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                                Choose a template designed for your specific needs. Each comes with pre-configured columns.
                            </p>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                            <div class="template-card" onclick="selectTableTemplate('inventory')" data-table-template="inventory">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-package" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Inventory Management</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Track stock levels, locations, suppliers, and reorder points for products or equipment.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Item Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Quantity</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Location</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Supplier</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('calendar')" data-table-template="calendar">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-calendar" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Event Calendar</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Schedule meetings, events, deadlines, and milestones with attendees and reminders.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Event Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Date/Time</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Attendees</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Status</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('backlog')" data-table-template="backlog">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-kanban" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Sprint Backlog</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Manage user stories, tasks, and bugs with priorities, story points, and sprint assignments.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Title</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Priority</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Story Points</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Assignee</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('assets')" data-table-template="assets">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-briefcase" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Asset Management</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Track equipment, tools, vehicles, and property with ownership, maintenance, and depreciation.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Asset Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Type</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Owner</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Value</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('wip')" data-table-template="wip">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-spinner-gap" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Work in Progress</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Monitor active projects, deliverables, and milestones with status tracking and completion dates.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Project Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Status</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Progress</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Due Date</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>

                            <div class="template-card" onclick="selectTableTemplate('contacts')" data-table-template="contacts">
                                <div style="display: flex; gap: 16px; align-items: flex-start;">
                                    <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ph-address-book" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Contacts & CRM</h5>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0 0 8px 0; line-height: 1.5;">
                                            Organize customers, vendors, and partners with contact details, interactions, and notes.
                                        </p>
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Name</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Email</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Company</span>
                                            <span style="padding: 3px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 10px; color: var(--color-neutral-text);">Role</span>
                                        </div>
                                    </div>
                                    <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Name Table -->
                    <div class="simple-wizard-step-content" id="tableGuidedStep2">
                        <div class="wizard-welcome">
                            <i class="ph ph-pencil-simple" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                            <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Name your table</h4>
                            <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                                Give it a descriptive name. This will be the PostgreSQL table name.
                            </p>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Table Name</label>
                            <input type="text" id="guidedTableName" placeholder="e.g., inventory_items" style="width: 100%; padding: 12px 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 15px; transition: border-color 0.2s;">
                            <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px;">
                                <i class="ph ph-lightbulb" style="margin-right: 4px;"></i>
                                Tip: Use lowercase with underscores (e.g., my_table_name)
                            </div>
                        </div>

                        <div id="guidedColumnsPreview" style="background: var(--color-neutral-background); border-radius: 8px; padding: 20px;">
                            <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">Pre-configured Columns</h5>
                            <div id="guidedColumnsContent" style="display: flex; flex-direction: column; gap: 8px;">
                                <!-- Will be populated based on template -->
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Review & Create -->
                    <div class="simple-wizard-step-content" id="tableGuidedStep3">
                        <div class="wizard-welcome">
                            <i class="ph ph-check-circle" style="font-size: 48px; color: #10b981; display: block; margin-bottom: 16px;"></i>
                            <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Review your table</h4>
                            <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                                Here's what we'll create. You can customize columns later.
                            </p>
                        </div>

                        <div id="guidedTableReview" style="background: var(--color-neutral-background); border-radius: 8px; padding: 20px;">
                            <!-- Review summary will be populated here -->
                        </div>

                        <div style="background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px; margin-top: 16px;">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <i class="ph ph-info" style="font-size: 24px; color: #f59e0b; flex-shrink: 0;"></i>
                                <div>
                                    <h6 style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: #92400e; margin: 0 0 6px 0;">What happens next?</h6>
                                    <p style="font-family: var(--font-family-body); font-size: 12px; color: #92400e; margin: 0; line-height: 1.5;">
                                        Your table schema will be saved and ready to export as SQL. You can customize columns, add constraints, or connect to your PostgreSQL database.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wizard Footer -->
                <div class="simple-pipeline-wizard-footer">
                    <button id="tableGuidedBackBtn" onclick="previousTableGuidedStep()" style="padding: 10px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); cursor: pointer; display: none;">
                        <i class="ph ph-caret-left" style="margin-right: 6px;"></i> Back
                    </button>
                    <button id="tableGuidedContinueBtn" onclick="nextTableGuidedStep()" style="padding: 10px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        Continue <i class="ph ph-caret-right"></i>
                    </button>
                    <button id="tableGuidedCreateBtn" onclick="createTableFromGuided()" style="padding: 10px 24px; background: #10b981; color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: none; align-items: center; gap: 8px;">
                        <i class="ph ph-check"></i> Create Table
                    </button>
                </div>
            </div>
        </div>

        <!-- Interview Prep Slideout (60% width) - Inside Canvas Modal -->
        <div class="interview-slideout" id="interviewSlideout">
            <div class="slideout-header">
                <h2 id="slideoutTitle">Interview Preparation</h2>
                <button class="slideout-close" onclick="closeInterviewSlideout()">&times;</button>
            </div>

            <!-- Main Interview Prep Tabs (Stories / Documents / Diagrams / Whiteboards / Mock Interviews) -->
            <div id="interviewPrepContent" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                <div class="tech-tabs" style="border-bottom: 2px solid #e5e5e7; padding: 16px 24px 0 24px; background: var(--color-neutral-background); flex-shrink: 0;">
                    <button class="tech-tab active" onclick="switchInterviewTab('behavioral')">Stories</button>
                    <button id="assetsTab" class="tech-tab" onclick="switchInterviewTab('assets')">Assets</button>
                    <button id="mockInterviewsTab" class="tech-tab" onclick="switchInterviewTab('mock')">Mock Interviews</button>
                </div>

                <!-- Stories Content -->
                <div class="slideout-body" id="behavioralContent" style="display: flex; flex: 1; flex-direction: column; overflow-y: auto;">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                        <button class="add-story-btn" onclick="openStoryForm()" style="flex: 0 0 auto; margin-bottom: 0;">
                            <i class="ph ph-plus-circle"></i> Add New Story
                        </button>
                        <div class="experience-filter-container" style="position: relative; flex: 0 0 auto;">
                            <button class="experience-filter-btn" onclick="toggleExperienceFilter()" id="experienceFilterBtn">
                                <i class="ph ph-funnel"></i> Filter by Experience
                                <span id="filterCount" style="display: none; margin-left: 4px; padding: 2px 6px; background: var(--color-primary-blue); color: white; border-radius: 10px; font-size: 10px; font-weight: 600;"></span>
                            </button>
                            <div class="experience-filter-dropdown" id="experienceFilterDropdown" style="display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Select Experiences</span>
                                    <button onclick="clearExperienceFilter()" style="background: none; border: none; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; padding: 2px 4px;">Clear</button>
                                </div>
                                <div id="experienceFilterOptions" style="max-height: 300px; overflow-y: auto; padding: 4px;">
                                    <!-- Experience checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="storiesContainer" class="stories-container">
                        <!-- Story cards will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Assets Content (Unified Documents, Diagrams, Whiteboards) -->
                <div class="slideout-body" id="assetsContent" style="display: none; flex: 1; flex-direction: column; overflow: hidden; min-height: 0;">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; flex-shrink: 0;">
                        <button class="add-story-btn" onclick="openAssetCreationModal()" style="flex: 0 0 auto; margin-bottom: 0;">
                            <i class="ph ph-plus-circle"></i> Add Asset
                        </button>
                        <div class="experience-filter-container" style="position: relative; flex: 0 0 auto;">
                            <button class="experience-filter-btn" onclick="toggleAssetsExperienceFilter()" id="assetsExperienceFilterBtn">
                                <i class="ph ph-funnel"></i> Filter by Experience
                                <span id="assetsExperienceFilterCount" style="display: none; margin-left: 4px; padding: 2px 6px; background: var(--color-primary-blue); color: white; border-radius: 10px; font-size: 10px; font-weight: 600;"></span>
                            </button>
                            <div class="experience-filter-dropdown" id="assetsExperienceFilterDropdown" style="display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Select Experiences</span>
                                    <button onclick="clearAssetsExperienceFilter()" style="background: none; border: none; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; padding: 2px 4px;">Clear</button>
                                </div>
                                <div id="assetsExperienceFilterOptions" style="max-height: 300px; overflow-y: auto; padding: 4px;">
                                    <!-- Experience checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div class="experience-filter-container" style="position: relative; flex: 0 0 auto;">
                            <button class="experience-filter-btn" onclick="toggleAssetsPortfolioFilter()" id="assetsPortfolioFilterBtn">
                                <i class="ph ph-funnel"></i> Filter by Portfolio
                                <span id="assetsPortfolioFilterCount" style="display: none; margin-left: 4px; padding: 2px 6px; background: var(--color-primary-blue); color: white; border-radius: 10px; font-size: 10px; font-weight: 600;"></span>
                            </button>
                            <div class="experience-filter-dropdown" id="assetsPortfolioFilterDropdown" style="display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Select Portfolio Items</span>
                                    <button onclick="clearAssetsPortfolioFilter()" style="background: none; border: none; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; padding: 2px 4px;">Clear</button>
                                </div>
                                <div id="assetsPortfolioFilterOptions" style="max-height: 300px; overflow-y: auto; padding: 4px;">
                                    <!-- Portfolio checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                        <!-- Search Filter (Inline) -->
                        <div style="display: flex; align-items: center; gap: 8px; background: white; border-radius: 8px; border: 1px solid var(--color-neutral-border); padding: 8px 12px; flex: 1; min-width: 200px;">
                            <i class="ph ph-magnifying-glass" style="font-size: 16px; color: var(--color-neutral-text);"></i>
                            <input
                                type="text"
                                id="assetsSearchInput"
                                placeholder="Filter by name..."
                                oninput="filterAssetsByName()"
                                style="flex: 1; border: none; outline: none; font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);"
                            />
                            <button onclick="clearAssetsSearch()" id="assetsClearSearchBtn" style="display: none; padding: 4px; background: none; border: none; color: var(--color-neutral-text); cursor: pointer; font-size: 14px;">
                                <i class="ph ph-x"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Assets Table -->
                    <div style="background: white; border-radius: 8px; border: 1px solid var(--color-neutral-border); flex: 1; min-height: 0; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--color-neutral-background); border-bottom: 2px solid var(--color-neutral-border);">
                                    <th onclick="sortAssetsTable('name')" style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); cursor: pointer; user-select: none;" onmouseover="this.style.background='rgba(0, 102, 204, 0.05)'" onmouseout="this.style.background='transparent'">
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            Name
                                            <i class="ph ph-caret-up-down" id="sortIconName" style="font-size: 14px; opacity: 0.3;"></i>
                                        </div>
                                    </th>
                                    <th onclick="sortAssetsTable('type')" style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); width: 120px; cursor: pointer; user-select: none;" onmouseover="this.style.background='rgba(0, 102, 204, 0.05)'" onmouseout="this.style.background='transparent'">
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            Type
                                            <i class="ph ph-caret-up-down" id="sortIconType" style="font-size: 14px; opacity: 0.3;"></i>
                                        </div>
                                    </th>
                                    <th onclick="sortAssetsTable('linkedTo')" style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); width: 200px; cursor: pointer; user-select: none;" onmouseover="this.style.background='rgba(0, 102, 204, 0.05)'" onmouseout="this.style.background='transparent'">
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            Linked To
                                            <i class="ph ph-caret-up-down" id="sortIconLinkedTo" style="font-size: 14px; opacity: 0.3;"></i>
                                        </div>
                                    </th>
                                    <th onclick="sortAssetsTable('lastModified')" style="padding: 12px 16px; text-align: left; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); width: 140px; cursor: pointer; user-select: none;" onmouseover="this.style.background='rgba(0, 102, 204, 0.05)'" onmouseout="this.style.background='transparent'">
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            Last Updated
                                            <i class="ph ph-caret-down" id="sortIconLastModified" style="font-size: 14px; opacity: 1;"></i>
                                        </div>
                                    </th>
                                    <th style="padding: 12px 16px; text-align: right; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assetsTableBody">
                                <!-- Assets will be dynamically inserted here -->
                            </tbody>
                        </table>
                        <div id="assetsEmptyState" style="display: none; padding: 48px 24px; text-align: center;">
                            <i class="ph ph-files" style="font-size: 48px; color: var(--color-neutral-text); opacity: 0.5;"></i>
                            <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); margin-top: 12px;">No assets yet</div>
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-top: 4px;">Create documents, diagrams, or whiteboards to get started.</div>
                        </div>
                    </div>
                </div>

                <!-- Diagrams Content -->
                <div class="slideout-body" id="diagramsContent" style="display: none; flex: 1; flex-direction: column; overflow-y: auto;">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                        <button class="add-story-btn" onclick="addDiagram()" style="flex: 0 0 auto; margin-bottom: 0;">
                            <i class="ph ph-plus-circle"></i> Add Diagram
                        </button>
                        <div class="experience-filter-container" style="position: relative; flex: 0 0 auto;">
                            <button class="experience-filter-btn" onclick="toggleDiagramExperienceFilter()" id="diagramExperienceFilterBtn">
                                <i class="ph ph-funnel"></i> Filter by Experience
                                <span id="diagramExperienceFilterCount" style="display: none; margin-left: 4px; padding: 2px 6px; background: var(--color-primary-blue); color: white; border-radius: 10px; font-size: 10px; font-weight: 600;"></span>
                            </button>
                            <div class="experience-filter-dropdown" id="diagramExperienceFilterDropdown" style="display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Select Experiences</span>
                                    <button onclick="clearDiagramExperienceFilter()" style="background: none; border: none; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; padding: 2px 4px;">Clear</button>
                                </div>
                                <div id="diagramExperienceFilterOptions" style="max-height: 300px; overflow-y: auto; padding: 4px;">
                                    <!-- Experience checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div class="experience-filter-container" style="position: relative; flex: 0 0 auto;">
                            <button class="experience-filter-btn" onclick="toggleDiagramPortfolioFilter()" id="diagramPortfolioFilterBtn">
                                <i class="ph ph-funnel"></i> Filter by Portfolio
                                <span id="diagramPortfolioFilterCount" style="display: none; margin-left: 4px; padding: 2px 6px; background: var(--color-primary-blue); color: white; border-radius: 10px; font-size: 10px; font-weight: 600;"></span>
                            </button>
                            <div class="experience-filter-dropdown" id="diagramPortfolioFilterDropdown" style="display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Select Portfolio Items</span>
                                    <button onclick="clearDiagramPortfolioFilter()" style="background: none; border: none; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; padding: 2px 4px;">Clear</button>
                                </div>
                                <div id="diagramPortfolioFilterOptions" style="max-height: 300px; overflow-y: auto; padding: 4px;">
                                    <!-- Portfolio checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="diagramsContainer" class="tech-items-container">
                        <!-- Diagrams will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Documents Content -->
                <div class="slideout-body" id="documentsContent" style="display: none; flex: 1; flex-direction: column; overflow-y: auto;">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                        <button class="add-story-btn" onclick="addDocument()" style="flex: 0 0 auto; margin-bottom: 0;">
                            <i class="ph ph-plus-circle"></i> Add Document
                        </button>
                        <div class="experience-filter-container" style="position: relative; flex: 0 0 auto;">
                            <button class="experience-filter-btn" onclick="toggleDocumentExperienceFilter()" id="documentExperienceFilterBtn">
                                <i class="ph ph-funnel"></i> Filter by Experience
                                <span id="documentExperienceFilterCount" style="display: none; margin-left: 4px; padding: 2px 6px; background: var(--color-primary-blue); color: white; border-radius: 10px; font-size: 10px; font-weight: 600;"></span>
                            </button>
                            <div class="experience-filter-dropdown" id="documentExperienceFilterDropdown" style="display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Select Experiences</span>
                                    <button onclick="clearDocumentExperienceFilter()" style="background: none; border: none; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; padding: 2px 4px;">Clear</button>
                                </div>
                                <div id="documentExperienceFilterOptions" style="max-height: 300px; overflow-y: auto; padding: 4px;">
                                    <!-- Experience checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div class="experience-filter-container" style="position: relative; flex: 0 0 auto;">
                            <button class="experience-filter-btn" onclick="toggleDocumentPortfolioFilter()" id="documentPortfolioFilterBtn">
                                <i class="ph ph-funnel"></i> Filter by Portfolio
                                <span id="documentPortfolioFilterCount" style="display: none; margin-left: 4px; padding: 2px 6px; background: var(--color-primary-blue); color: white; border-radius: 10px; font-size: 10px; font-weight: 600;"></span>
                            </button>
                            <div class="experience-filter-dropdown" id="documentPortfolioFilterDropdown" style="display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Select Portfolio Items</span>
                                    <button onclick="clearDocumentPortfolioFilter()" style="background: none; border: none; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; padding: 2px 4px;">Clear</button>
                                </div>
                                <div id="documentPortfolioFilterOptions" style="max-height: 300px; overflow-y: auto; padding: 4px;">
                                    <!-- Portfolio checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="interviewDocumentsContainer" class="tech-items-container">
                        <!-- Documents will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Whiteboards Content (Seeker tier only) -->
                <div class="slideout-body" id="whiteboardsContent" style="display: none; flex: 1; flex-direction: column; overflow-y: auto;">
                    <div style="padding: 12px 16px; margin-bottom: 16px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; display: flex; align-items: flex-start; gap: 12px;">
                        <i class="ph ph-warning" style="font-size: 20px; color: #ff9800; flex-shrink: 0; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: #d97706; margin-bottom: 4px;">
                                Under Development
                            </div>
                            <div style="font-family: var(--font-family-body); font-size: 12px; color: #92400e; line-height: 1.4;">
                                Whiteboard creation and management tools are coming soon.
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                        <button class="add-story-btn" onclick="addWhiteboard()" style="flex: 0 0 auto; margin-bottom: 0;">
                            <i class="ph ph-plus-circle"></i> Add Whiteboard
                        </button>
                        <div class="experience-filter-container" style="position: relative; flex: 0 0 auto;">
                            <button class="experience-filter-btn" onclick="toggleWhiteboardExperienceFilter()" id="whiteboardExperienceFilterBtn">
                                <i class="ph ph-funnel"></i> Filter by Experience
                                <span id="whiteboardExperienceFilterCount" style="display: none; margin-left: 4px; padding: 2px 6px; background: var(--color-primary-blue); color: white; border-radius: 10px; font-size: 10px; font-weight: 600;"></span>
                            </button>
                            <div class="experience-filter-dropdown" id="whiteboardExperienceFilterDropdown" style="display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Select Experiences</span>
                                    <button onclick="clearWhiteboardExperienceFilter()" style="background: none; border: none; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; padding: 2px 4px;">Clear</button>
                                </div>
                                <div id="whiteboardExperienceFilterOptions" style="max-height: 300px; overflow-y: auto; padding: 4px;">
                                    <!-- Experience checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div class="experience-filter-container" style="position: relative; flex: 0 0 auto;">
                            <button class="experience-filter-btn" onclick="toggleWhiteboardPortfolioFilter()" id="whiteboardPortfolioFilterBtn">
                                <i class="ph ph-funnel"></i> Filter by Portfolio
                                <span id="whiteboardPortfolioFilterCount" style="display: none; margin-left: 4px; padding: 2px 6px; background: var(--color-primary-blue); color: white; border-radius: 10px; font-size: 10px; font-weight: 600;"></span>
                            </button>
                            <div class="experience-filter-dropdown" id="whiteboardPortfolioFilterDropdown" style="display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Select Portfolio Items</span>
                                    <button onclick="clearWhiteboardPortfolioFilter()" style="background: none; border: none; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; padding: 2px 4px;">Clear</button>
                                </div>
                                <div id="whiteboardPortfolioFilterOptions" style="max-height: 300px; overflow-y: auto; padding: 4px;">
                                    <!-- Portfolio checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="whiteboardsContainer" class="tech-items-container">
                        <!-- Whiteboard sessions will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Mock Interviews Content (Seeker tier only) -->
                <div class="slideout-body" id="mockContent" style="display: none; flex: 1; flex-direction: column; overflow-y: auto;">
                    <div style="padding: 12px 16px; margin-bottom: 16px; background: #e3f2fd; border: 1px solid var(--color-primary-blue); border-radius: 8px; display: flex; align-items: flex-start; gap: 12px;">
                        <i class="ph ph-info" style="font-size: 20px; color: var(--color-primary-blue); flex-shrink: 0; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-accent-blue); margin-bottom: 4px;">
                                Mock Interview Sessions
                            </div>
                            <div style="font-family: var(--font-family-body); font-size: 12px; color: #1565c0; line-height: 1.4;">
                                Schedule practice interviews with Cleansheet coaches. Your request and profile information will be sent to our team for session coordination.
                            </div>
                        </div>
                    </div>
                    <button class="add-story-btn" onclick="openCoachingInquiryModal('mock_interviews')">
                        <i class="ph ph-plus-circle"></i> Schedule Session
                    </button>
                    <div id="mockContainer" class="tech-items-container">
                        <!-- Mock interview sessions will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Job Opportunities Slideout Content -->
            <div class="slideout-body" id="jobOpportunitiesContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <button class="add-story-btn" onclick="addJobOpportunity()" style="flex: 0 0 auto;">
                        <i class="ph ph-plus-circle"></i> Add Job
                    </button>
                </div>

                <!-- Table View -->
                <div id="jobsTableContainer" style="overflow-x: auto;">
                    <table class="jobs-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Position</th>
                                <th style="width: 16%;">Company</th>
                                <th style="width: 5%;">Link</th>
                                <th style="width: 11%;">Status</th>
                                <th style="width: 11%;">Close Date</th>
                                <th style="width: 18%;">Next Action</th>
                                <th style="width: 8%;">Alerts</th>
                                <th style="width: 11%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody">
                            <!-- Job rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Career Experience Slideout Content -->
            <div class="slideout-body" id="careerExperienceContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="add-story-btn" onclick="addExperienceRecord()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Add Experience
                    </button>
                    <button id="requestProfileButton" class="add-story-btn" onclick="closeInterviewSlideout(); openSubscriptionProfileRequestModal();" style="flex: 0 0 auto; margin-bottom: 0; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border: none;">
                        <i class="ph ph-user-focus"></i> Request Profile
                    </button>
                </div>

                <!-- Profile Request Form (Collapsible) -->
                <div id="profileRequestFormContainer" style="display: none; margin-bottom: 20px; padding: 16px; background: #fff7ed; border: 2px solid #f97316; border-radius: 8px;">
                    <h4 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: #ea580c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <i class="ph ph-info" style="font-size: 18px;"></i>
                        Request a Cleansheet Profile (Experimental)
                    </h4>
                    <p style="font-family: var(--font-family-body); font-size: 12px; color: #92400e; line-height: 1.5; margin: 0 0 14px 0;">
                        During the preview period, request a Cleansheet profile built from publicly available information.
                    </p>

                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Email -->
                        <div>
                            <label style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">Email Address *</label>
                            <input type="email" id="slideoutProfileEmail" placeholder="your.email@example.com" style="width: 100%; padding: 8px 10px; border: 2px solid #f97316; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <div style="font-family: var(--font-family-body); font-size: 11px; color: #92400e; margin-top: 4px;">
                                <i class="ph ph-warning" style="margin-right: 4px;"></i>You must control this email address. 2FA will be leveraged for verification.
                            </div>
                        </div>

                        <!-- LinkedIn URL -->
                        <div>
                            <label style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 6px;">LinkedIn Profile URL *</label>
                            <input type="url" id="slideoutProfileLinkedIn" placeholder="https://linkedin.com/in/yourprofile" style="width: 100%; padding: 8px 10px; border: 2px solid #f97316; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>

                        <!-- Acknowledgement Checkbox -->
                        <div>
                            <label style="display: flex; align-items: start; gap: 8px; cursor: pointer; font-size: 11px; line-height: 1.5; padding: 10px; background: white; border: 2px solid #f97316; border-radius: 6px;">
                                <input type="checkbox" id="slideoutAcknowledgement" style="margin-top: 2px; width: 14px; height: 14px; cursor: pointer; flex-shrink: 0;">
                                <div style="font-family: var(--font-family-body); color: #92400e;">
                                    I acknowledge that I am requesting a profile <strong>only for myself</strong>, I authorize Cleansheet to perform an <strong>AI-assisted open source search</strong> based on my current profile and the information provided in this form, and I agree to the <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer" style="color: #ea580c; text-decoration: underline; font-weight: 600;">Terms of Service</a>. *
                                </div>
                            </label>
                        </div>

                        <!-- Consent Notice -->
                        <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #f97316;">
                            <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: #ea580c; margin-bottom: 6px;">
                                <i class="ph ph-info" style="margin-right: 4px;"></i>What You're Consenting To:
                            </div>
                            <ul style="font-family: var(--font-family-body); font-size: 10px; line-height: 1.5; color: #92400e; margin: 0; padding-left: 18px;">
                                <li>Cleansheet will conduct an <strong>open source search</strong> to minimally populate your professional and educational profile</li>
                                <li>Cleansheet will <strong>retain this data</strong> to provide the requested service</li>
                                <li>You can submit <strong>erasure requests</strong> from the user menu</li>
                                <li>This is an <strong>experimental preview service</strong> and data accuracy is not guaranteed</li>
                            </ul>
                        </div>

                        <div style="display: flex; gap: 8px;">
                            <button onclick="submitSlideoutProfileRequest()" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: 0 2px 6px rgba(249, 115, 22, 0.3);">
                                <i class="ph ph-paper-plane-tilt" style="font-size: 16px;"></i>
                                Submit Request
                            </button>
                            <button onclick="toggleProfileRequestForm()" style="padding: 10px 16px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <div id="experiencesContainer" class="stories-container">
                    <!-- Experience cards will be dynamically inserted here -->
                </div>
            </div>


            <!-- Goals Slideout Content -->
            <div class="slideout-body" id="goalsContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="add-story-btn" onclick="addGoal()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Add Goal
                    </button>
                </div>
                <div id="goalsContainer" class="stories-container">
                    <!-- Goal cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Portfolio Slideout Content -->
            <div class="slideout-body" id="portfolioContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="add-story-btn" onclick="addPortfolioProject()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Add Project
                    </button>
                </div>
                <div id="portfolioContainer" class="stories-container">
                    <!-- Portfolio project cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Skills & Competencies Slideout Content -->
            <div class="slideout-body" id="skillsCompetenciesContent" style="display: none;">
                <!-- Improvement Goals Pills -->
                <div id="improvementGoalsSection" style="margin-bottom: 24px; padding: 16px; background: #f8f8f8; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Areas for Improvement</div>
                    <div id="improvementGoalsPills" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- Goal pills will be dynamically inserted here -->
                    </div>
                </div>

                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <button class="add-story-btn" onclick="addCustomSkill()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Add Skill/Competency
                    </button>
                    <button class="upload-resume-btn" onclick="syncFromExperience()" style="flex: 0 0 auto;">
                        <i class="ph ph-arrows-clockwise"></i> Sync from Experience
                    </button>
                    <div style="margin-left: auto; font-size: 11px; color: #666;">
                        <strong>Rating Scale:</strong> 1=Beginner, 2=Intermediate, 3=Advanced, 4=Expert, 5=Master
                    </div>
                </div>
                <div id="skillsCompetenciesContainer" style="display: flex; flex-direction: column; gap: 12px; overflow-y: auto;">
                    <!-- Skills and competencies will be dynamically inserted here -->
                </div>
            </div>

            <!-- Projects Slideout Content -->
            <div class="slideout-body" id="projectsContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="add-story-btn" onclick="addProjectRepo()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Connect Repository
                    </button>
                    <button class="upload-resume-btn" onclick="scanLocalRepos()" style="flex: 0 0 auto;">
                        <i class="ph ph-folder-open"></i> Scan Local Directories
                    </button>
                </div>
                <div id="projectsContainer" class="stories-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                    <!-- Project repo cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- My Notes Slideout Content -->
            <div class="slideout-body" id="myNotesContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <button class="add-story-btn" onclick="addNote()" style="flex: 0 0 auto; margin-bottom: 0;">
                        <i class="ph ph-plus-circle"></i> Add Note
                    </button>
                    <input type="text" id="notesSearchInput" placeholder="Search notes..." oninput="searchNotes()" style="flex: 1; padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                </div>
                <div id="notesContainer" class="stories-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                    <!-- Note cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Calendar Content -->
            <div class="slideout-body" id="calendarContent" style="display: none;">
                <!-- Calendar Header with View Switcher -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; gap: 8px;">
                        <button id="dailyViewBtn" onclick="switchCalendarView('daily')" class="calendar-view-btn calendar-view-btn-green active">Daily</button>
                        <button id="weeklyViewBtn" onclick="switchCalendarView('weekly')" class="calendar-view-btn calendar-view-btn-green">Weekly</button>
                        <button id="monthlyViewBtn" onclick="switchCalendarView('monthly')" class="calendar-view-btn calendar-view-btn-green">Monthly</button>
                    </div>

                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="navigateCalendar('prev')" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; font-family: var(--font-family-heading); font-size: 14px;">
                            <i class="ph ph-caret-left"></i>
                        </button>
                        <button onclick="navigateCalendar('today')" style="padding: 6px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600;">
                            Today
                        </button>
                        <button onclick="navigateCalendar('next')" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; font-family: var(--font-family-heading); font-size: 14px;">
                            <i class="ph ph-caret-right"></i>
                        </button>
                        <span id="calendarDateRange" style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-left: 8px;">
                            <!-- Date range will be set by JS -->
                        </span>
                    </div>

                    <div style="display: flex; gap: 8px;">
                        <button onclick="openAddEventForm()" class="add-story-btn" style="margin: 0; background: #16a34a;">
                            <i class="ph ph-plus-circle"></i> Add Event
                        </button>
                        <button onclick="openCalendarSettings()" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer;">
                            <i class="ph ph-gear" style="font-size: 18px; color: var(--color-neutral-text);"></i>
                        </button>
                    </div>
                </div>

                <!-- Calendar Display Area -->
                <div id="calendarDisplayArea" style="background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px; min-height: 500px;">
                    <!-- Calendar views will be rendered here -->
                </div>
            </div>

            <!-- Recipes Content -->
            <div class="slideout-body" id="recipesContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="recipesSearchInput" placeholder="Search recipes..." oninput="searchRecipes()" style="flex: 1; padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    <select id="cuisineFilterSelect" onchange="filterRecipes()" style="padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                        <option value="">All Cuisines</option>
                    </select>
                    <select id="mealTypeFilterSelect" onchange="filterRecipes()" style="padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                        <option value="">All Meal Types</option>
                    </select>
                </div>
                <div id="recipesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                    <!-- Recipe cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Finance Content -->
            <div class="slideout-body" id="financeContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; justify-content: space-between;">
                    <div style="display: flex; gap: 8px; position: relative;">
                        <button id="connectInstitutionBtn" onmouseenter="showConnectInstitutionTooltip()" onmouseleave="hideConnectInstitutionTooltip()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                            <i class="ph ph-link"></i> Connect Institution
                        </button>

                        <!-- Hover Tooltip for Connect Institution -->
                        <div id="connectInstitutionTooltip" onmouseenter="keepConnectInstitutionTooltip()" onmouseleave="hideConnectInstitutionTooltip()" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 16px; width: 320px; z-index: 1100;">
                            <h4 style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 12px 0;">
                                Connect Financial Institution
                            </h4>

                            <input type="text" id="institutionSearchTooltip" placeholder="Search for your institution..." style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; margin-bottom: 12px;">

                            <div style="max-height: 250px; overflow-y: auto; margin-bottom: 12px;">
                                <!-- Banks -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase;">Banks</div>
                                <div onclick="selectInstitution('Chase')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Chase
                                </div>
                                <div onclick="selectInstitution('Bank of America')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Bank of America
                                </div>
                                <div onclick="selectInstitution('Wells Fargo')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Wells Fargo
                                </div>
                                <div onclick="selectInstitution('Citi')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Citi
                                </div>
                                <div onclick="selectInstitution('Capital One')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Capital One
                                </div>
                                <div onclick="selectInstitution('US Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> US Bank
                                </div>
                                <div onclick="selectInstitution('PNC Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> PNC Bank
                                </div>
                                <div onclick="selectInstitution('TD Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> TD Bank
                                </div>
                                <div onclick="selectInstitution('Truist Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Truist Bank
                                </div>
                                <div onclick="selectInstitution('Ally Bank')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-bank" style="margin-right: 6px; color: #16a34a;"></i> Ally Bank
                                </div>

                                <!-- Credit Cards -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase; margin-top: 8px;">Credit Cards</div>
                                <div onclick="selectInstitution('American Express')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-credit-card" style="margin-right: 6px; color: #16a34a;"></i> American Express
                                </div>
                                <div onclick="selectInstitution('Discover')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-credit-card" style="margin-right: 6px; color: #16a34a;"></i> Discover
                                </div>

                                <!-- Investment & Brokerage -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase; margin-top: 8px;">Investment & Brokerage</div>
                                <div onclick="selectInstitution('Fidelity')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Fidelity
                                </div>
                                <div onclick="selectInstitution('Vanguard')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Vanguard
                                </div>
                                <div onclick="selectInstitution('Charles Schwab')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Charles Schwab
                                </div>
                                <div onclick="selectInstitution('E*TRADE')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> E*TRADE
                                </div>
                                <div onclick="selectInstitution('TD Ameritrade')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> TD Ameritrade
                                </div>
                                <div onclick="selectInstitution('Robinhood')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Robinhood
                                </div>
                                <div onclick="selectInstitution('Betterment')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Betterment
                                </div>
                                <div onclick="selectInstitution('Wealthfront')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-trend-up" style="margin-right: 6px; color: #16a34a;"></i> Wealthfront
                                </div>

                                <!-- Payment & Transfer -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase; margin-top: 8px;">Payment & Transfer</div>
                                <div onclick="selectInstitution('PayPal')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> PayPal
                                </div>
                                <div onclick="selectInstitution('Venmo')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Venmo
                                </div>
                                <div onclick="selectInstitution('Cash App')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Cash App
                                </div>
                                <div onclick="selectInstitution('Zelle')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Zelle
                                </div>
                                <div onclick="selectInstitution('Apple Pay')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Apple Pay
                                </div>
                                <div onclick="selectInstitution('Google Pay')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-currency-circle-dollar" style="margin-right: 6px; color: #16a34a;"></i> Google Pay
                                </div>

                                <!-- Insurance -->
                                <div style="padding: 6px 8px; background: #f5f5f7; font-family: var(--font-family-heading); font-size: 10px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase; margin-top: 8px;">Insurance</div>
                                <div onclick="selectInstitution('State Farm')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> State Farm
                                </div>
                                <div onclick="selectInstitution('Geico')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Geico
                                </div>
                                <div onclick="selectInstitution('Allstate')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Allstate
                                </div>
                                <div onclick="selectInstitution('Progressive')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Progressive
                                </div>
                                <div onclick="selectInstitution('Liberty Mutual')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Liberty Mutual
                                </div>
                                <div onclick="selectInstitution('USAA')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> USAA
                                </div>
                                <div onclick="selectInstitution('Farmers Insurance')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Farmers Insurance
                                </div>
                                <div onclick="selectInstitution('Nationwide')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Nationwide
                                </div>
                                <div onclick="selectInstitution('Travelers')" style="padding: 8px; border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> Travelers
                                </div>
                                <div onclick="selectInstitution('MetLife')" style="padding: 8px; cursor: pointer; font-family: var(--font-family-body); font-size: 13px; border-radius: 4px;" onmouseover="this.style.background='var(--color-neutral-background)'" onmouseout="this.style.background='white'">
                                    <i class="ph ph-shield-check" style="margin-right: 6px; color: #16a34a;"></i> MetLife
                                </div>
                            </div>

                            <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin: 0;">
                                <i class="ph ph-lock"></i> Bank-level security
                            </p>
                        </div>

                        <div style="position: relative;">
                            <button id="manualAccountBtn" onmouseenter="showManualAccountTooltip()" onmouseleave="hideManualAccountTooltip()" style="padding: 8px 16px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                                <i class="ph ph-plus-circle"></i> Manual Account
                            </button>

                            <!-- Hover Tooltip for Manual Account -->
                            <div id="manualAccountTooltip" onmouseenter="keepManualAccountTooltip()" onmouseleave="hideManualAccountTooltip()" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 16px; width: 400px; z-index: 1100; max-height: 500px; overflow-y: auto;">
                                <h4 style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 12px 0;">
                                    Create Manual Account
                                </h4>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Account Type *</label>
                                    <select id="accountTypeTooltip" onchange="updateAccountTypeFieldsTooltip()" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                        <option value="">Select type...</option>
                                        <option value="Asset">Asset</option>
                                        <option value="Investment">Investment</option>
                                        <option value="Cash Flow">Cash Flow</option>
                                        <option value="Insurance">Insurance</option>
                                        <option value="Liability">Liability</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Account Name *</label>
                                    <input type="text" id="accountNameTooltip" placeholder="e.g., Primary Checking" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Institution/Provider</label>
                                    <input type="text" id="accountInstitutionTooltip" placeholder="e.g., Chase" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Current Balance/Value *</label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 8px; top: 8px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">$</span>
                                        <input type="number" id="accountBalanceTooltip" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px 8px 8px 20px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                    </div>
                                </div>

                                <!-- Asset-specific fields -->
                                <div id="assetFieldsTooltip" style="display: none; margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Asset Category</label>
                                    <select id="assetCategoryTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                        <option value="Real Estate">Real Estate</option>
                                        <option value="Vehicle">Vehicle</option>
                                        <option value="Savings">Savings Account</option>
                                        <option value="Checking">Checking Account</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <!-- Investment-specific fields -->
                                <div id="investmentFieldsTooltip" style="display: none; margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Investment Type</label>
                                    <select id="investmentTypeTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                        <option value="401(k)">401(k)</option>
                                        <option value="IRA">IRA</option>
                                        <option value="Roth IRA">Roth IRA</option>
                                        <option value="Brokerage">Brokerage Account</option>
                                        <option value="Stocks">Individual Stocks</option>
                                        <option value="Bonds">Bonds</option>
                                        <option value="Crypto">Cryptocurrency</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <!-- Cash Flow-specific fields -->
                                <div id="cashFlowFieldsTooltip" style="display: none;">
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Flow Type</label>
                                        <select id="cashFlowTypeTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                            <option value="Income">Income</option>
                                            <option value="Expense">Expense</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Frequency</label>
                                        <select id="cashFlowFrequencyTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                            <option value="Monthly">Monthly</option>
                                            <option value="Biweekly">Biweekly</option>
                                            <option value="Weekly">Weekly</option>
                                            <option value="Annually">Annually</option>
                                            <option value="One-time">One-time</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Insurance-specific fields -->
                                <div id="insuranceFieldsTooltip" style="display: none;">
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Insurance Type</label>
                                        <select id="insuranceTypeTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                            <option value="Life">Life Insurance</option>
                                            <option value="Health">Health Insurance</option>
                                            <option value="Auto">Auto Insurance</option>
                                            <option value="Home">Home/Renters Insurance</option>
                                            <option value="Disability">Disability Insurance</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Policy Number</label>
                                        <input type="text" id="insurancePolicyNumberTooltip" placeholder="Policy #" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Premium (per year)</label>
                                        <div style="position: relative;">
                                            <span style="position: absolute; left: 8px; top: 8px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">$</span>
                                            <input type="number" id="insurancePremiumTooltip" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px 8px 8px 20px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Liability-specific fields -->
                                <div id="liabilityFieldsTooltip" style="display: none;">
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Liability Type</label>
                                        <select id="liabilityTypeTooltip" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; cursor: pointer;">
                                            <option value="Mortgage">Mortgage</option>
                                            <option value="Auto Loan">Auto Loan</option>
                                            <option value="Student Loan">Student Loan</option>
                                            <option value="Credit Card">Credit Card</option>
                                            <option value="Personal Loan">Personal Loan</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Interest Rate (%)</label>
                                        <input type="number" id="liabilityInterestRateTooltip" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Monthly Payment</label>
                                        <div style="position: relative;">
                                            <span style="position: absolute; left: 8px; top: 8px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">$</span>
                                            <input type="number" id="liabilityPaymentTooltip" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px 8px 8px 20px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--color-neutral-text);">Notes</label>
                                    <textarea id="accountNotesTooltip" placeholder="Additional details..." rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; resize: vertical;"></textarea>
                                </div>

                                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                    <button onclick="clearManualAccountTooltipForm()" style="padding: 8px 16px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; cursor: pointer;">
                                        Clear
                                    </button>
                                    <button onclick="saveFinanceAccountFromTooltip()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; cursor: pointer;">
                                        <i class="ph ph-check-circle"></i> Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <select id="financeFilterSelect" onchange="filterFinanceAccounts()" style="padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                        <option value="">All Account Types</option>
                        <option value="Asset">Assets</option>
                        <option value="Investment">Investments</option>
                        <option value="Cash Flow">Cash Flow</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Liability">Liabilities</option>
                    </select>
                </div>

                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <div style="background: #dcfce7; border: 1px solid #16a34a; border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Total Assets</div>
                        <div id="totalAssets" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: #16a34a;">$0</div>
                    </div>
                    <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Total Liabilities</div>
                        <div id="totalLiabilities" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: #ef4444;">$0</div>
                    </div>
                    <div style="background: var(--color-neutral-background); border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Net Worth</div>
                        <div id="netWorth" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: var(--color-neutral-text);">$0</div>
                    </div>
                </div>

                <!-- Accounts List -->
                <div id="financeAccountsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Account cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="shoppingContent" style="display: none;">
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; justify-content: space-between;">
                    <button onclick="addShoppingItem()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                        <i class="ph ph-plus"></i> Add Item
                    </button>

                    <select id="shoppingFilterSelect" onchange="filterShoppingItems()" style="padding: 8px 12px; border: 1px solid #e5e5e7; border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                        <option value="">All Categories</option>
                        <option value="Grocery">Grocery</option>
                        <option value="Home">Home</option>
                        <option value="Internet">Internet</option>
                        <option value="Gifts">Gifts</option>
                    </select>
                </div>

                <!-- Shopping Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <div style="background: #dcfce7; border: 1px solid #16a34a; border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Total Items</div>
                        <div id="totalShoppingItems" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: #16a34a;">0</div>
                    </div>
                    <div style="background: var(--color-neutral-background); border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Estimated Total</div>
                        <div id="estimatedShoppingTotal" style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: var(--color-neutral-text);">$0</div>
                    </div>
                </div>

                <div id="shoppingItemsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Shopping items will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="tablesContent" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">
                        Structured data tables with typed columns for organizing professional information.
                    </p>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openTableGuidedSetup()" style="padding: 8px 16px; background: white; color: var(--color-primary-blue); border: 2px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; transition: all 0.2s;">
                            <i class="ph ph-magic-wand" style="font-size: 16px;"></i>
                            Guided Setup
                        </button>
                        <button onclick="openTableWizard()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                            <i class="ph ph-plus" style="font-size: 16px;"></i>
                            New Table
                        </button>
                    </div>
                </div>

                <!-- Tables Tabs -->
                <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--color-neutral-border);">
                    <button id="tablesCardsTab" onclick="switchTablesView('cards')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid var(--color-primary-blue); color: var(--color-primary-blue); font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer;">
                        Cards
                    </button>
                    <button id="tablesRelationshipsTab" onclick="switchTablesView('relationships')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-neutral-text); font-family: var(--font-family-heading); font-size: 14px; cursor: pointer;">
                        Relationships
                    </button>
                </div>

                <!-- Cards View -->
                <div id="tablesCardsView" style="display: block;">
                    <div id="tablesContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- Table type cards will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Relationships View (ERD) -->
                <div id="tablesRelationshipsView" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); margin: 0;">
                            Entity Relationship Diagram showing how tables connect to each other
                        </p>
                        <button onclick="openRelationshipManager()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-arrows-left-right"></i> Manage Relationships
                        </button>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 24px; border: 1px solid var(--color-neutral-border); position: relative;">
                        <!-- Zoom Controls -->
                        <div id="erdZoomControls" style="position: absolute; top: 32px; right: 32px; z-index: 10; display: flex; flex-direction: column; gap: 4px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); opacity: 0; pointer-events: none; transition: opacity 0.2s;">
                            <!-- Zoom Level Indicator -->
                            <div id="erdZoomLevel" style="padding: 4px 8px; text-align: center; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); background: #f8f9fa; border-radius: 4px; margin: 4px;">
                                100%
                            </div>
                            <button onclick="zoomERD('in')" title="Zoom In" style="padding: 8px; border: none; background: white; cursor: pointer; border-radius: 6px; color: var(--color-neutral-text); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-neutral-text)';">
                                <i class="ph ph-magnifying-glass-plus" style="font-size: 18px;"></i>
                            </button>
                            <button onclick="zoomERD('out')" title="Zoom Out" style="padding: 8px; border: none; background: white; cursor: pointer; border-radius: 6px; color: var(--color-neutral-text); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-neutral-text)';">
                                <i class="ph ph-magnifying-glass-minus" style="font-size: 18px;"></i>
                            </button>
                            <button onclick="zoomERD('reset')" title="Reset Zoom" style="padding: 8px; border: none; background: white; cursor: pointer; border-radius: 6px; color: var(--color-neutral-text); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-neutral-text)';">
                                <i class="ph ph-house" style="font-size: 18px;"></i>
                            </button>
                            <button onclick="zoomERD('fit')" title="Fit to Screen" style="padding: 8px; border: none; background: white; cursor: pointer; border-radius: 6px; color: var(--color-neutral-text); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-neutral-text)';">
                                <i class="ph ph-arrows-out" style="font-size: 18px;"></i>
                            </button>
                        </div>

                        <div id="tablesERDContainer" style="width: 100%; height: 600px; position: relative; border-radius: 8px; border: 1px solid var(--color-neutral-border); overflow: hidden;"
                             onmouseenter="showERDZoomControls()"
                             onmouseleave="hideERDZoomControls()">
                            <!-- ERD will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="slideout-body" id="formsContent" style="display: none;">
                <button class="add-story-btn" onclick="openFormDesigner()">
                    <i class="ph ph-plus-circle"></i> New Form
                </button>
                <div id="formsContainer" class="stories-container">
                    <!-- Form cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="documentsContent" style="display: none;">
                <button class="add-story-btn" onclick="openDocumentEditor()">
                    <i class="ph ph-plus-circle"></i> New Document
                </button>
                <div id="documentsContainer">
                    <!-- Document cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="reportsContent" style="display: none;">
                <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 24px;">
                    Analytics and reporting dashboards for data visualization and insights.
                </p>
                <div id="reportsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Report type cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="templatesContent" style="display: none;">
                <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 24px;">
                    Reusable templates for standardizing documents, emails, and workflows.
                </p>
                <div id="templatesContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Template type cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="pipelinesContent" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">
                        ML pipelines for automated content transformation and multi-format delivery.
                    </p>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openSimplePipelineWizard()" style="padding: 8px 16px; background: white; color: var(--color-primary-blue); border: 2px solid var(--color-primary-blue); border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; transition: all 0.2s;">
                            <i class="ph ph-magic-wand" style="font-size: 16px;"></i>
                            Guided Setup
                        </button>
                        <button onclick="openPipelineWizard()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                            <i class="ph ph-plus" style="font-size: 16px;"></i>
                            New Pipeline
                        </button>
                    </div>
                </div>
                <div id="pipelinesContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Pipeline cards will be dynamically inserted here -->
                </div>
            </div>

            <div class="slideout-body" id="workflowsContent" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                    <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">
                        Automated workflows and business process automation tools.
                    </p>
                    <button onclick="openNewWorkflowModal()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                        <i class="ph ph-plus"></i>
                        New Workflow
                    </button>
                </div>
                <div id="workflowsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Workflow type cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Documents Slideout Content -->
            <div class="slideout-body" id="documentsContent" style="display: none;">
                <button class="add-story-btn" onclick="openDocumentEditor()">
                    <i class="ph ph-plus-circle"></i> New Document
                </button>
                <div id="documentsContainer" class="stories-container">
                    <!-- Document cards will be dynamically inserted here -->
                </div>
            </div>
        </div> <!-- End interview-slideout -->

    <!-- Story Form Modal (Inside Canvas Modal) -->
    <div class="story-form-modal" id="storyFormModal">
        <div class="story-form-content">
            <div class="story-form-header">
                <h3 id="formTitle">Add Behavioral Story</h3>
                <button class="story-form-close" onclick="closeStoryForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="storyForm" onsubmit="saveStory(event)">
                    <div class="form-group">
                        <label>Story Title / Competency</label>
                        <input type="text" id="storyTitle" required placeholder="e.g., Leadership Under Pressure">
                    </div>

                    <div class="form-group">
                        <label>Related Job Experience</label>
                        <select id="storyExperience">
                            <option value="">Select an experience...</option>
                            <!-- Will be populated from persona data -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Situation</label>
                        <textarea id="storySituation" rows="2" required placeholder="Describe the context and challenge..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Task</label>
                        <textarea id="storyTask" rows="2" required placeholder="What was your responsibility or goal?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Action</label>
                        <textarea id="storyAction" rows="2" required placeholder="What specific actions did you take?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Result</label>
                        <textarea id="storyResult" rows="2" required placeholder="What was the outcome? Include metrics if possible."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Key Competencies Demonstrated</label>
                        <input type="text" id="storyCompetencies" placeholder="e.g., Leadership, Problem Solving, Communication">
                        <small>Comma-separated list</small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeStoryForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Story</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End story-form-modal -->

    <!-- Job Form Modal -->
    <div class="story-form-modal" id="jobFormModal">
        <div class="story-form-content">
            <div class="story-form-header">
                <h3 id="jobFormTitle">Add Job Opportunity</h3>
                <button class="story-form-close" onclick="closeJobForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="jobForm" onsubmit="saveJob(event)">
                    <!-- URL paste option -->
                    <div class="form-group">
                        <label>Job URL (Optional)</label>
                        <input type="url" id="jobUrl" placeholder="https://...">
                        <small>Paste the job posting URL for your reference</small>
                    </div>

                    <!-- Manual entry fields -->
                    <div class="form-group">
                        <label>Job Title *</label>
                        <input type="text" id="jobTitle" required placeholder="e.g., Senior Software Engineer">
                    </div>
                    <div class="form-group">
                        <label>Company *</label>
                        <input type="text" id="jobCompany" required placeholder="e.g., TechCorp">
                    </div>

                    <!-- Hidden fields with default values -->
                    <input type="hidden" id="jobLocation" value="">
                    <input type="hidden" id="jobSalary" value="">
                    <input type="hidden" id="jobStatus" value="interested">
                    <input type="hidden" id="jobCloseDate" value="">
                    <input type="hidden" id="jobNotes" value="">
                    <input type="hidden" id="todoTaskInput" value="">
                    <input type="hidden" id="todoDateInput" value="">
                    <div id="jobTodoList" style="display: none;"></div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeJobForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Job</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End job-form-modal -->

    <!-- Job Detail Modal -->
    <div class="job-detail-modal" id="jobDetailModal">
        <div class="job-detail-content">
            <div class="job-detail-header">
                <h3 id="jobDetailTitle">Job Details</h3>
                <button class="job-detail-close" onclick="closeJobDetail()">&times;</button>
            </div>
            <div class="job-detail-body">
                <!-- Job Info Section -->
                <div class="job-detail-section">
                    <h4><i class="ph ph-briefcase"></i> Job Information</h4>
                    <div class="job-status-editor" style="display: grid; grid-template-columns: auto 1fr auto 1fr; gap: 12px; align-items: center;">
                        <label for="jobDetailStatus" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Status:</label>
                        <select id="jobDetailStatus" class="job-status-select" onchange="updateJobStatus()">
                            <option value="interested">Interested</option>
                            <option value="applied">Applied</option>
                            <option value="interviewing">Interviewing</option>
                            <option value="offer">Offer</option>
                            <option value="rejected">Rejected</option>
                            <option value="not-interested">Not Interested</option>
                        </select>
                        <label for="jobDetailCloseDate" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Close Date:</label>
                        <input type="date" id="jobDetailCloseDate" class="job-status-select" onchange="updateJobCloseDate()" style="border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 6px 8px; font-size: 12px;">
                    </div>
                    <div id="jobDetailInfo" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 13px;">
                        <!-- Job details will be populated here -->
                    </div>
                </div>

                <!-- Job Todo Checklist Section -->
                <div class="job-detail-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0;"><i class="ph ph-check-square"></i> Action Items</h4>
                        <button onclick="addJobTodoInDetail()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-plus"></i> Add Task
                        </button>
                    </div>
                    <div id="jobDetailTodoList" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Todo items will be populated here -->
                    </div>
                </div>

                <!-- Prompts Section -->
                <div class="job-detail-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0;"><i class="ph ph-file-text"></i> Prompts</h4>
                        <button onclick="openPromptBuilderForJob()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-plus"></i> Add Prompt
                        </button>
                    </div>
                    <div id="jobApplicationMaterials" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Attached prompts will be populated here -->
                    </div>
                </div>

                <!-- Skills & Competencies Section -->
                <div class="job-detail-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0;"><i class="ph ph-gear"></i> Required Skills & Competencies</h4>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="addJobSkill()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <i class="ph ph-plus"></i> Add Skill
                            </button>
                            <button onclick="addJobCompetency()" style="padding: 6px 12px; background: var(--color-accent-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <i class="ph ph-plus"></i> Add Competency
                            </button>
                        </div>
                    </div>
                    <div class="skills-competencies-grid">
                        <div>
                            <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">Required Skills</h5>
                            <div id="jobDetailSkills" class="skill-comp-list">
                                <!-- Skills will be populated here -->
                            </div>
                        </div>
                        <div>
                            <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">Key Competencies</h5>
                            <div id="jobDetailCompetencies" class="skill-comp-list">
                                <!-- Competencies will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fit Analysis Section -->
                <div class="job-detail-section fit-analysis-section">
                    <h4><i class="ph ph-target"></i> Fit Analysis</h4>
                    <div class="fit-score" id="overallFitScore">
                        <div class="fit-score-circle" id="fitScoreCircle">85%</div>
                        <div class="fit-score-details">
                            <h5>Overall Fit Score</h5>
                            <p>Strong match based on your skills and experience</p>
                        </div>
                    </div>
                    <div class="fit-dimensions" id="fitDimensions">
                        <!-- Fit analysis dimensions will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End job-detail-modal -->

    <!-- Project Repository Form Modal -->
    <div class="story-form-modal" id="projectFormModal">
        <div class="story-form-content">
            <div class="story-form-header">
                <h3 id="projectFormTitle">Connect Project Repository</h3>
                <button class="story-form-close" onclick="closeProjectForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="projectForm" onsubmit="saveProject(event)">
                    <div class="form-group">
                        <label>Project Name</label>
                        <input type="text" id="projectName" required placeholder="e.g., E-Commerce Dashboard">
                    </div>

                    <div class="form-group">
                        <label>Local Directory Path</label>
                        <input type="text" id="projectPath" required placeholder="C:\Users\username\projects\my-project">
                        <small>Path to your local repository folder</small>
                    </div>

                    <div class="form-group">
                        <label>Repository URL (Optional)</label>
                        <input type="url" id="projectRepoUrl" placeholder="https://github.com/username/repo">
                        <small>GitHub, GitLab, or other remote repository</small>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="projectDescription" rows="3" placeholder="Brief description of the project..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Technologies</label>
                        <input type="text" id="projectTechnologies" placeholder="React, Node.js, PostgreSQL">
                        <small>Comma-separated list (will be color-coded)</small>
                    </div>

                    <div class="form-group">
                        <label>Topics/Categories</label>
                        <input type="text" id="projectTopics" placeholder="Web Development, Full Stack, E-Commerce">
                        <small>Comma-separated list (will be color-coded)</small>
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <select id="projectStatus">
                            <option value="active">Active Development</option>
                            <option value="completed">Completed</option>
                            <option value="archived">Archived</option>
                            <option value="planning">Planning</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeProjectForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Project</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End project-form-modal -->

    <!-- My Notes Form Modal -->
    <div class="story-form-modal" id="noteFormModal">
        <div class="story-form-content">
            <div class="story-form-header">
                <h3 id="noteFormTitle">Add Note</h3>
                <button class="story-form-close" onclick="closeNoteForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="noteForm" onsubmit="saveNote(event)">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="noteTitle" required placeholder="e.g., React Hooks Best Practices">
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <select id="noteCategory">
                            <option value="learning">Learning</option>
                            <option value="idea">Idea</option>
                            <option value="question">Question</option>
                            <option value="reference">Reference</option>
                            <option value="todo">To-Do</option>
                            <option value="general">General</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tags (Optional)</label>
                        <input type="text" id="noteTags" placeholder="react, javascript, hooks">
                        <small>Comma-separated list</small>
                    </div>

                    <div class="form-group">
                        <label>Content</label>
                        <textarea id="noteContent" rows="12" required placeholder="Write your note here..."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeNoteForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End note-form-modal -->

    <!-- Calendar Event Form Modal -->
    <div class="story-form-modal" id="eventFormModal">
        <div class="story-form-content" style="max-width: 600px;">
            <div class="story-form-header">
                <h3 id="eventFormTitle">Add Event</h3>
                <button class="story-form-close" onclick="closeEventForm()">&times;</button>
            </div>
            <div class="story-form-body">
                <form id="eventForm" onsubmit="saveEvent(event)">
                    <div class="form-group">
                        <label>Event Title</label>
                        <input type="text" id="eventTitle" required placeholder="e.g., Team Meeting">
                    </div>

                    <div class="form-group">
                        <label>Event Type</label>
                        <select id="eventType" onchange="updateEventTypeFields()">
                            <option value="allday">All-Day Event</option>
                            <option value="datetime">Date & Time Event</option>
                            <option value="time">Time-Only Event</option>
                        </select>
                    </div>

                    <div class="form-group" id="eventDateField">
                        <label>Date</label>
                        <input type="date" id="eventDate" required>
                    </div>

                    <div class="form-group" id="eventStartTimeField" style="display: none;">
                        <label>Start Time</label>
                        <input type="time" id="eventStartTime">
                    </div>

                    <div class="form-group" id="eventEndTimeField" style="display: none;">
                        <label>End Time</label>
                        <input type="time" id="eventEndTime">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="eventRecurring" onchange="toggleRecurringFields()">
                            Recurring Event
                        </label>
                    </div>

                    <div id="recurringFields" style="display: none;">
                        <div class="form-group">
                            <label>Recurrence Pattern</label>
                            <select id="recurrencePattern">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Repeat Every</label>
                            <input type="number" id="recurrenceInterval" value="1" min="1" style="width: 80px;">
                            <span id="recurrenceUnitLabel">day(s)</span>
                        </div>

                        <div class="form-group">
                            <label>Ends</label>
                            <select id="recurrenceEndType" onchange="toggleRecurrenceEnd()">
                                <option value="never">Never</option>
                                <option value="date">On Date</option>
                                <option value="count">After Occurrences</option>
                            </select>
                        </div>

                        <div class="form-group" id="recurrenceEndDateField" style="display: none;">
                            <label>End Date</label>
                            <input type="date" id="recurrenceEndDate">
                        </div>

                        <div class="form-group" id="recurrenceCountField" style="display: none;">
                            <label>Number of Occurrences</label>
                            <input type="number" id="recurrenceCount" value="10" min="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Location (Optional)</label>
                        <input type="text" id="eventLocation" placeholder="e.g., Conference Room A">
                    </div>

                    <div class="form-group">
                        <label>Description (Optional)</label>
                        <textarea id="eventDescription" rows="3" placeholder="Add details about this event..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Calendar</label>
                        <select id="eventCalendar">
                            <option value="personal">Personal</option>
                            <!-- External calendars will be added here -->
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeEventForm()">Cancel</button>
                        <button type="submit" class="btn-save">Save Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End event-form-modal -->

    <!-- Calendar Settings Modal -->
    <div class="story-form-modal" id="calendarSettingsModal">
        <div class="story-form-content" style="max-width: 700px;">
            <div class="story-form-header">
                <h3>Calendar Settings</h3>
                <button class="story-form-close" onclick="closeCalendarSettings()">&times;</button>
            </div>
            <div class="story-form-body">
                <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--color-neutral-border);">
                    <button id="syncTab" onclick="switchSettingsTab('sync')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid var(--color-primary-blue); color: var(--color-primary-blue); font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer;">
                        Sync & Import
                    </button>
                    <button id="exportTab" onclick="switchSettingsTab('export')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-neutral-text); font-family: var(--font-family-heading); font-size: 14px; cursor: pointer;">
                        Export
                    </button>
                    <button id="shareTab" onclick="switchSettingsTab('share')" style="padding: 12px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-neutral-text); font-family: var(--font-family-heading); font-size: 14px; cursor: pointer;">
                        Sharing
                    </button>
                </div>

                <!-- Sync & Import Tab -->
                <div id="syncSettingsContent" style="display: block;">
                    <h4 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin-bottom: 12px;">Connected Calendars</h4>
                    <div id="connectedCalendars" style="margin-bottom: 24px;">
                        <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); font-style: italic;">
                            No external calendars connected.
                        </p>
                    </div>

                    <h4 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin-bottom: 12px;">Connect Calendar</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button onclick="connectGoogleCalendar()" style="padding: 10px 20px; background: #4285F4; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-google-logo"></i> Google Calendar
                        </button>
                        <button onclick="connectMicrosoftCalendar()" style="padding: 10px 20px; background: #0078D4; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-microsoft-outlook-logo"></i> Outlook / Microsoft 365
                        </button>
                        <button onclick="connectAppleCalendar()" style="padding: 10px 20px; background: #555; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-apple-logo"></i> Apple Calendar
                        </button>
                    </div>

                    <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light); margin-top: 12px;">
                        Two-way sync keeps your events synchronized across all connected calendars.
                    </p>
                </div>

                <!-- Export Tab -->
                <div id="exportSettingsContent" style="display: none;">
                    <h4 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin-bottom: 12px;">Export Calendar</h4>
                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 16px;">
                        Export your entire calendar or individual events in standard formats.
                    </p>

                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="exportCalendar('ics')" style="padding: 12px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="ph ph-calendar-blank" style="margin-right: 8px;"></i> iCalendar Format (.ics)</span>
                            <i class="ph ph-download-simple"></i>
                        </button>
                        <button onclick="exportCalendar('csv')" style="padding: 12px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="ph ph-file-csv" style="margin-right: 8px;"></i> CSV Spreadsheet (.csv)</span>
                            <i class="ph ph-download-simple"></i>
                        </button>
                        <button onclick="exportCalendar('json')" style="padding: 12px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="ph ph-code" style="margin-right: 8px;"></i> JSON Format (.json)</span>
                            <i class="ph ph-download-simple"></i>
                        </button>
                    </div>
                </div>

                <!-- Share Tab -->
                <div id="shareSettingsContent" style="display: none;">
                    <h4 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; margin-bottom: 12px;">Share Calendar</h4>
                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 16px;">
                        Generate a shareable link to allow others to view your calendar.
                    </p>

                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <input type="text" id="shareLink" readonly value="https://cleansheet.info/calendar/share/..." style="flex: 1; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; background: var(--color-neutral-background);">
                        <button onclick="copyShareLink()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                            <i class="ph ph-copy"></i> Copy
                        </button>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="checkbox" id="sharePublic" onchange="togglePublicSharing()">
                            Make calendar publicly accessible
                        </label>
                    </div>

                    <h4 style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; margin-bottom: 8px; margin-top: 24px;">Permissions</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="radio" name="sharePermission" value="view" checked>
                            View only (others can see events)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="radio" name="sharePermission" value="edit">
                            Can edit (others can add/modify events)
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End calendar-settings-modal -->

    <!-- Recipe Form Modal -->
    <div id="recipeFormModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="position: sticky; top: 0; background: white; z-index: 10; padding: 20px; border-bottom: 1px solid var(--color-neutral-border);">
                <h2 id="recipeFormTitle" style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: var(--color-neutral-text); margin: 0;">Add Recipe</h2>
            </div>

            <div style="padding: 20px;">
                <input type="hidden" id="recipeEditIndex" value="">

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Recipe Name *</label>
                    <input type="text" id="recipeName" placeholder="e.g., Chicken Tacos" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Cuisine</label>
                        <input type="text" id="recipeCuisine" placeholder="e.g., Mexican, Italian" list="cuisineList" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        <datalist id="cuisineList">
                            <option value="Mexican">
                            <option value="Italian">
                            <option value="Chinese">
                            <option value="Indian">
                            <option value="Thai">
                            <option value="American">
                            <option value="French">
                            <option value="Japanese">
                            <option value="Mediterranean">
                            <option value="Greek">
                        </datalist>
                    </div>

                    <div>
                        <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Meal Type</label>
                        <input type="text" id="recipeMealType" placeholder="e.g., Dinner, Snack" list="mealTypeList" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        <datalist id="mealTypeList">
                            <option value="Breakfast">
                            <option value="Lunch">
                            <option value="Dinner">
                            <option value="Snack">
                            <option value="Dessert">
                            <option value="Drink">
                            <option value="Appetizer">
                        </datalist>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Prep Time (minutes)</label>
                        <input type="number" id="recipePrepTime" placeholder="30" min="0" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>

                    <div>
                        <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Cook Time (minutes)</label>
                        <input type="number" id="recipeCookTime" placeholder="45" min="0" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Servings</label>
                    <input type="number" id="recipeServings" placeholder="4" min="1" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Ingredients *</label>
                    <textarea id="recipeIngredients" placeholder="One ingredient per line&#10;e.g.,&#10;2 cups flour&#10;1 lb chicken breast&#10;1 tsp salt" rows="6" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; resize: vertical;"></textarea>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Instructions *</label>
                    <textarea id="recipeInstructions" placeholder="One step per line&#10;e.g.,&#10;1. Preheat oven to 350°F&#10;2. Mix flour and salt in bowl&#10;3. Add water and knead dough" rows="8" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; resize: vertical;"></textarea>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--color-neutral-text);">Notes</label>
                    <textarea id="recipeNotes" placeholder="Any additional tips, variations, or notes about this recipe" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; resize: vertical;"></textarea>
                </div>
            </div>

            <div style="position: sticky; bottom: 0; background: white; border-top: 1px solid var(--color-neutral-border); padding: 16px; display: flex; gap: 8px; justify-content: flex-end;">
                <button onclick="closeRecipeForm()" style="padding: 10px 20px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="saveRecipe()" style="padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                    <i class="ph ph-check-circle"></i> Save Recipe
                </button>
            </div>
        </div>
    </div> <!-- End recipe-form-modal -->

    <!-- Pipeline Management Modal -->
    <div class="pipeline-mgmt-modal" id="pipelineMgmtModal">
        <div class="pipeline-mgmt-content">
            <div class="pipeline-mgmt-header">
                <h3 id="pipelineTitle">Pipeline Management</h3>
                <button class="pipeline-mgmt-close" onclick="closePipelineMgmtModal()">&times;</button>
            </div>
            <div class="pipeline-mgmt-body">
                <iframe id="pipelineMgmtFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div> <!-- End pipeline-mgmt-modal -->

    <!-- Pipeline Wizard Modal -->
    <div class="pipeline-wizard-modal" id="pipelineWizardModal">
        <div class="pipeline-wizard-content">
            <div class="pipeline-wizard-header">
                <h3>Create New ML Pipeline</h3>
                <button class="pipeline-wizard-close" onclick="closePipelineWizard()">&times;</button>
            </div>

            <!-- Step Indicator -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Basics</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Data Sources</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Configuration</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Output</div>
                </div>
            </div>

            <div class="pipeline-wizard-body">
                <!-- Step 1: Pipeline Basics -->
                <div class="wizard-step-content active" id="wizardStep1">
                    <h4 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin-bottom: 24px;">Pipeline Basics</h4>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Pipeline Name *</label>
                        <input type="text" id="pipelineName" placeholder="e.g., Customer Content Pipeline" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Pipeline Type *</label>
                        <select id="pipelineType" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="">Select pipeline type...</option>
                            <option value="content">Content Transformation</option>
                            <option value="document">Document Intelligence</option>
                            <option value="analytics">Analytics & Insights</option>
                            <option value="image">Image Recognition</option>
                            <option value="voice">Voice Processing</option>
                            <option value="video">Video Analysis</option>
                            <option value="translation">Translation & Localization</option>
                            <option value="sentiment">Sentiment Analysis</option>
                            <option value="custom">Custom Pipeline</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Description</label>
                        <textarea id="pipelineDescription" placeholder="Describe what this pipeline does and its purpose..." style="width: 100%; min-height: 100px; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Tags</label>
                        <input type="text" id="pipelineTags" placeholder="e.g., production, ml, content (comma-separated)" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                    </div>
                </div>

                <!-- Step 2: Data Sources -->
                <div class="wizard-step-content" id="wizardStep2">
                    <h4 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin-bottom: 24px;">Data Sources & Connections</h4>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Input Source *</label>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div class="source-option" onclick="selectSource('file')" style="padding: 16px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-folder-open" style="font-size: 32px; color: var(--color-primary-blue); display: block; margin-bottom: 8px;"></i>
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">File Services</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 4px;">Dropbox, OneDrive, Drive</div>
                            </div>

                            <div class="source-option" onclick="selectSource('database')" style="padding: 16px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-database" style="font-size: 32px; color: var(--color-primary-blue); display: block; margin-bottom: 8px;"></i>
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Database</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 4px;">SQL, NoSQL, Data Lake</div>
                            </div>

                            <div class="source-option" onclick="selectSource('api')" style="padding: 16px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-plugs-connected" style="font-size: 32px; color: var(--color-primary-blue); display: block; margin-bottom: 8px;"></i>
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">API Endpoint</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 4px;">REST, GraphQL, Webhook</div>
                            </div>

                            <div class="source-option" onclick="selectSource('stream')" style="padding: 16px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-broadcast" style="font-size: 32px; color: var(--color-primary-blue); display: block; margin-bottom: 8px;"></i>
                                <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Real-time Stream</div>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 4px;">Event Hub, Kafka, IoT</div>
                            </div>
                        </div>

                        <div id="sourceDetails" style="display: none; padding: 16px; background: var(--color-neutral-background); border-radius: 8px; border: 1px solid var(--color-neutral-border);">
                            <!-- Source-specific configuration will appear here -->
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">LLM Provider (Optional)</label>
                        <select id="llmProvider" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="">None</option>
                            <option value="openai">OpenAI (GPT-4)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="azure">Azure OpenAI</option>
                            <option value="cohere">Cohere</option>
                            <option value="huggingface">Hugging Face</option>
                        </select>
                    </div>
                </div>

                <!-- Step 3: Processing Configuration -->
                <div class="wizard-step-content" id="wizardStep3">
                    <h4 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin-bottom: 24px;">Processing Configuration</h4>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Processing Frequency *</label>
                        <select id="processingFrequency" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="realtime">Real-time (immediate)</option>
                            <option value="continuous">Continuous (streaming)</option>
                            <option value="hourly">Hourly</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="manual">Manual trigger only</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Batch Size</label>
                        <input type="number" id="batchSize" placeholder="100" min="1" value="100" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin-top: 4px;">Number of items to process per batch</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Error Handling</label>
                        <select id="errorHandling" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="retry">Retry with exponential backoff</option>
                            <option value="skip">Skip failed items</option>
                            <option value="halt">Halt pipeline on error</option>
                            <option value="deadletter">Send to dead letter queue</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="enableLogging" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Enable detailed logging</span>
                        </label>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="enableMetrics" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">Enable performance metrics</span>
                        </label>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Custom Parameters (JSON)</label>
                        <textarea id="customParams" placeholder='{"key": "value"}' style="width: 100%; min-height: 80px; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Step 4: Output Settings -->
                <div class="wizard-step-content" id="wizardStep4">
                    <h4 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin-bottom: 24px;">Output Settings & Delivery</h4>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Output Destinations *</label>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <label style="padding: 12px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="output-destination" value="storage" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Azure Storage</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">Blob containers</div>
                                </div>
                            </label>

                            <label style="padding: 12px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="output-destination" value="database" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Database</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">Cosmos DB, SQL</div>
                                </div>
                            </label>

                            <label style="padding: 12px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="output-destination" value="webhook" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Webhook</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">POST to endpoint</div>
                                </div>
                            </label>

                            <label style="padding: 12px; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="output-destination" value="email" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Email Notification</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">On completion</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Output Format</label>
                        <select id="outputFormat" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            <option value="json">JSON</option>
                            <option value="xml">XML</option>
                            <option value="csv">CSV</option>
                            <option value="parquet">Parquet</option>
                            <option value="avro">Avro</option>
                            <option value="custom">Custom format</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Notification Emails</label>
                        <input type="text" id="notificationEmails" placeholder="email@example.com, another@example.com" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin-top: 4px;">Comma-separated email addresses for pipeline alerts</div>
                    </div>

                    <div style="padding: 16px; background: var(--color-neutral-background); border-radius: 8px; border-left: 4px solid var(--color-primary-blue);">
                        <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">
                            <i class="ph ph-info" style="margin-right: 6px;"></i>Ready to Create
                        </div>
                        <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">
                            Review your configuration and click "Create Pipeline" to deploy your new ML pipeline. You can modify these settings later from the pipeline management interface.
                        </div>
                    </div>
                </div>
            </div>

            <div class="pipeline-wizard-footer">
                <button id="wizardPrevBtn" onclick="previousWizardStep()" style="padding: 10px 20px; background: white; color: var(--color-dark); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                    Previous
                </button>
                <div style="flex: 1;"></div>
                <button id="wizardNextBtn" onclick="nextWizardStep()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                    Next
                </button>
                <button id="wizardFinishBtn" onclick="finishPipelineWizard()" style="display: none; padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                    Create Pipeline
                </button>
            </div>
        </div>
    </div> <!-- End pipeline-wizard-modal -->

    <!-- Simple Pipeline Wizard Modal -->
    <div class="simple-pipeline-wizard-modal" id="simplePipelineWizardModal">
        <div class="simple-pipeline-wizard-content">
            <div class="simple-pipeline-wizard-header">
                <h3>Create Your First Pipeline</h3>
                <button class="simple-pipeline-wizard-close" onclick="closeSimplePipelineWizard()">&times;</button>
            </div>

            <!-- Friendly Progress Indicator -->
            <div class="simple-wizard-progress">
                <div class="simple-progress-bar">
                    <div class="simple-progress-fill" id="simpleProgressFill"></div>
                </div>
                <div class="simple-progress-text" id="simpleProgressText">Step 1 of 4</div>
            </div>

            <div class="simple-pipeline-wizard-body">
                <!-- Step 1: Choose Template -->
                <div class="simple-wizard-step-content active" id="simpleWizardStep1">
                    <div class="wizard-welcome">
                        <i class="ph ph-rocket-launch" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                        <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Let's build your pipeline together!</h4>
                        <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                            Choose a pre-configured template to get started quickly. We'll guide you through each step.
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                        <div class="template-card" onclick="selectTemplate('content')" data-template="content">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="ph ph-article" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Content Transformation</h5>
                                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0; line-height: 1.5;">
                                        Perfect for: Converting documents to multiple formats, generating summaries, or translating content.
                                    </p>
                                    <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">PDF → HTML</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Summarization</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Translation</span>
                                    </div>
                                </div>
                                <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                            </div>
                        </div>

                        <div class="template-card" onclick="selectTemplate('data')" data-template="data">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="ph ph-chart-bar" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Data Analysis</h5>
                                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0; line-height: 1.5;">
                                        Perfect for: Analyzing spreadsheets, generating reports, or finding insights in your data.
                                    </p>
                                    <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">CSV Analysis</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Reports</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Insights</span>
                                    </div>
                                </div>
                                <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                            </div>
                        </div>

                        <div class="template-card" onclick="selectTemplate('image')" data-template="image">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div style="width: 56px; height: 56px; background: rgba(0, 102, 204, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="ph ph-images" style="font-size: 32px; color: var(--color-primary-blue);"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h5 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Image Processing</h5>
                                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0; line-height: 1.5;">
                                        Perfect for: Organizing photos, detecting objects, or extracting text from images.
                                    </p>
                                    <div style="margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Auto-tagging</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">OCR</span>
                                        <span style="padding: 4px 8px; background: var(--color-neutral-background); border-radius: 4px; font-size: 11px; color: var(--color-neutral-text);">Recognition</span>
                                    </div>
                                </div>
                                <i class="ph ph-check-circle template-check" style="font-size: 24px; color: var(--color-primary-blue); display: none;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Basic Settings -->
                <div class="simple-wizard-step-content" id="simpleWizardStep2">
                    <div class="wizard-welcome">
                        <i class="ph ph-pencil-simple" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                        <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Name your pipeline</h4>
                        <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                            Give it a descriptive name so you can find it easily later.
                        </p>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Pipeline Name</label>
                        <input type="text" id="simplePipelineName" placeholder="e.g., My Content Pipeline" style="width: 100%; padding: 12px 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 15px; transition: border-color 0.2s;">
                        <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin-top: 6px;">
                            <i class="ph ph-lightbulb" style="margin-right: 4px;"></i>
                            Tip: Use a name that describes what this pipeline does
                        </div>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">How often should it run?</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <label class="frequency-option" onclick="selectFrequency('manual')">
                                <input type="radio" name="simpleFrequency" value="manual" checked style="display: none;">
                                <div class="frequency-card">
                                    <i class="ph ph-hand-pointing" style="font-size: 24px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Manual</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin-top: 4px;">You start it when needed</div>
                                </div>
                            </label>
                            <label class="frequency-option" onclick="selectFrequency('automatic')">
                                <input type="radio" name="simpleFrequency" value="automatic" style="display: none;">
                                <div class="frequency-card">
                                    <i class="ph ph-clock-clockwise" style="font-size: 24px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                    <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark);">Automatic</div>
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin-top: 4px;">Runs on a schedule</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div id="scheduleOptions" style="display: none; margin-bottom: 24px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Schedule</label>
                        <select id="simpleSchedule" style="width: 100%; padding: 12px 14px; border: 2px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 15px; cursor: pointer;">
                            <option value="hourly">Every hour</option>
                            <option value="daily" selected>Once a day</option>
                            <option value="weekly">Once a week</option>
                        </select>
                    </div>
                </div>

                <!-- Step 3: Connect Source -->
                <div class="simple-wizard-step-content" id="simpleWizardStep3">
                    <div class="wizard-welcome">
                        <i class="ph ph-plugs-connected" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                        <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">Where is your data?</h4>
                        <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                            Connect to where your files are stored. Don't worry, you can change this later.
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div class="simple-source-card" onclick="selectSimpleSource('dropbox')" data-source="dropbox">
                            <i class="ph ph-dropbox-logo" style="font-size: 40px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                            <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark);">Dropbox</div>
                            <i class="ph ph-check-circle simple-source-check" style="position: absolute; top: 12px; right: 12px; font-size: 20px; color: var(--color-primary-blue); display: none;"></i>
                        </div>

                        <div class="simple-source-card" onclick="selectSimpleSource('onedrive')" data-source="onedrive">
                            <i class="ph ph-microsoft-outlook-logo" style="font-size: 40px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                            <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark);">OneDrive</div>
                            <i class="ph ph-check-circle simple-source-check" style="position: absolute; top: 12px; right: 12px; font-size: 20px; color: var(--color-primary-blue); display: none;"></i>
                        </div>

                        <div class="simple-source-card" onclick="selectSimpleSource('googledrive')" data-source="googledrive">
                            <i class="ph ph-google-drive-logo" style="font-size: 40px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                            <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark);">Google Drive</div>
                            <i class="ph ph-check-circle simple-source-check" style="position: absolute; top: 12px; right: 12px; font-size: 20px; color: var(--color-primary-blue); display: none;"></i>
                        </div>

                        <div class="simple-source-card" onclick="selectSimpleSource('computer')" data-source="computer">
                            <i class="ph ph-laptop" style="font-size: 40px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                            <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark);">My Computer</div>
                            <i class="ph ph-check-circle simple-source-check" style="position: absolute; top: 12px; right: 12px; font-size: 20px; color: var(--color-primary-blue); display: none;"></i>
                        </div>
                    </div>

                    <div id="simpleSourceHelp" style="display: none; padding: 16px; background: rgba(0, 102, 204, 0.05); border-radius: 8px; border-left: 4px solid var(--color-primary-blue);">
                        <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">
                            <i class="ph ph-info" style="margin-right: 6px;"></i>Next step after creation
                        </div>
                        <div id="simpleSourceHelpText" style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); line-height: 1.5;">
                        </div>
                    </div>
                </div>

                <!-- Step 4: Review -->
                <div class="simple-wizard-step-content" id="simpleWizardStep4">
                    <div class="wizard-welcome">
                        <i class="ph ph-check-square" style="font-size: 48px; color: var(--color-primary-blue); display: block; margin-bottom: 16px;"></i>
                        <h4 style="font-family: var(--font-family-ui); font-size: 22px; font-weight: 600; color: var(--color-dark); margin-bottom: 12px;">You're all set!</h4>
                        <p style="font-family: var(--font-family-body); font-size: 15px; color: var(--color-neutral-text); margin-bottom: 32px; line-height: 1.6;">
                            Here's what we're creating for you. Click "Create Pipeline" when ready.
                        </p>
                    </div>

                    <div style="background: var(--color-neutral-background); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <div style="margin-bottom: 20px;">
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Pipeline Type</div>
                            <div id="reviewTemplate" style="font-family: var(--font-family-body); font-size: 16px; color: var(--color-dark);"></div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Name</div>
                            <div id="reviewName" style="font-family: var(--font-family-body); font-size: 16px; color: var(--color-dark);"></div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Schedule</div>
                            <div id="reviewSchedule" style="font-family: var(--font-family-body); font-size: 16px; color: var(--color-dark);"></div>
                        </div>

                        <div>
                            <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Data Source</div>
                            <div id="reviewSource" style="font-family: var(--font-family-body); font-size: 16px; color: var(--color-dark);"></div>
                        </div>
                    </div>

                    <div style="padding: 16px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4CAF50;">
                        <div style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: #2E7D32; margin-bottom: 6px;">
                            <i class="ph ph-check-circle" style="margin-right: 6px;"></i>What happens next?
                        </div>
                        <div style="font-family: var(--font-family-body); font-size: 12px; color: #2E7D32; line-height: 1.5;">
                            After creation, you'll be able to configure connection details, test your pipeline, and start processing data.
                        </div>
                    </div>
                </div>
            </div>

            <div class="simple-pipeline-wizard-footer">
                <button id="simpleWizardBackBtn" onclick="previousSimpleWizardStep()" style="padding: 10px 20px; background: white; color: var(--color-dark); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: none;">
                    <i class="ph ph-arrow-left" style="margin-right: 6px;"></i>
                    Back
                </button>
                <div style="flex: 1;"></div>
                <button id="simpleWizardContinueBtn" onclick="nextSimpleWizardStep()" style="padding: 10px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    Continue
                    <i class="ph ph-arrow-right"></i>
                </button>
                <button id="simpleWizardCreateBtn" onclick="finishSimplePipelineWizard()" style="display: none; padding: 10px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; align-items: center; gap: 6px;">
                    <i class="ph ph-check"></i>
                    Create Pipeline
                </button>
            </div>
        </div>
    </div> <!-- End simple-pipeline-wizard-modal -->

    <!-- New Workflow Creation Modal -->
    <div class="workflow-creation-modal" id="workflowCreationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(4px);">
        <div class="workflow-creation-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
            <div class="workflow-creation-header" style="padding: 24px; border-bottom: 1px solid var(--color-neutral-border); position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 1;">
                <h3 style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Create New Workflow</h3>
                <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin: 0;">Design a custom workflow to automate your business processes</p>
                <button onclick="closeWorkflowCreationModal()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; color: var(--color-neutral-text); cursor: pointer;">&times;</button>
            </div>
            <div class="workflow-creation-body" style="padding: 24px;">
                <form id="workflowForm" onsubmit="createWorkflow(event)">
                    <!-- Basic Information -->
                    <div style="margin-bottom: 32px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-info" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                            Basic Information
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Workflow Name *</label>
                                <input type="text" id="workflowName" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Version</label>
                                <input type="text" id="workflowVersion" value="1.0.0" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Description</label>
                            <textarea id="workflowDescription" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; resize: vertical;" placeholder="Describe what this workflow does..."></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Category *</label>
                                <select id="workflowCategory" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                    <option value="">Select Category</option>
                                    <option value="content_creative">Content & Creative</option>
                                    <option value="operational_business">Business Operations</option>
                                    <option value="hr_people">HR & People</option>
                                    <option value="technical_development">Technical Development</option>
                                    <option value="customer_facing">Customer Facing</option>
                                    <option value="compliance_quality">Compliance & Quality</option>
                                    <option value="financial">Financial</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Type *</label>
                                <select id="workflowType" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                    <option value="">Select Type</option>
                                    <option value="document_approval">Document Approval</option>
                                    <option value="publishing">Publishing</option>
                                    <option value="video_production">Video Production</option>
                                    <option value="design_review">Design Review</option>
                                    <option value="procurement">Procurement</option>
                                    <option value="invoice_processing">Invoice Processing</option>
                                    <option value="expense_reimbursement">Expense Reimbursement</option>
                                    <option value="contract_lifecycle">Contract Lifecycle</option>
                                    <option value="employee_onboarding">Employee Onboarding</option>
                                    <option value="time_off_request">Time Off Request</option>
                                    <option value="performance_review">Performance Review</option>
                                    <option value="hiring_pipeline">Hiring Pipeline</option>
                                    <option value="code_review">Code Review</option>
                                    <option value="incident_response">Incident Response</option>
                                    <option value="change_management">Change Management</option>
                                    <option value="release_management">Release Management</option>
                                    <option value="support_ticket">Support Ticket</option>
                                    <option value="order_fulfillment">Order Fulfillment</option>
                                    <option value="returns_rma">Returns & RMA</option>
                                    <option value="lead_nurturing">Lead Nurturing</option>
                                    <option value="audit_process">Audit Process</option>
                                    <option value="quality_control">Quality Control</option>
                                    <option value="risk_assessment">Risk Assessment</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Workflow States -->
                    <div style="margin-bottom: 32px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-flow-arrow" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                            Workflow States
                        </h4>
                        <div style="background: var(--color-neutral-background); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <input type="text" id="newStateName" placeholder="State name (e.g., Draft, Review, Approved)" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <select id="newStateType" style="padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                    <option value="initial">Initial</option>
                                    <option value="active" selected>Active</option>
                                    <option value="waiting">Waiting</option>
                                    <option value="completed">Completed</option>
                                    <option value="terminal">Terminal</option>
                                </select>
                                <button type="button" onclick="addWorkflowState()" style="padding: 8px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div id="workflowStatesList" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- States will be added here -->
                        </div>
                    </div>

                    <!-- SLA Settings -->
                    <div style="margin-bottom: 32px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-clock" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                            SLA Settings
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Expected Duration</label>
                                <input type="text" id="expectedDuration" placeholder="e.g., 2 hours, 1 day" style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Max Duration</label>
                                <input type="text" id="maxDuration" placeholder="e.g., 1 week, 5 days" style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Business Hours Only</label>
                                <select id="businessHoursOnly" style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div style="margin-bottom: 32px;">
                        <h4 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-tag" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                            Tags
                        </h4>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <input type="text" id="newWorkflowTag" placeholder="Add tag (press Enter)" style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;" onkeydown="handleTagKeydown(event)">
                        </div>
                        <div id="workflowTagsList" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- Tags will be added here -->
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 24px; border-top: 1px solid var(--color-neutral-border);">
                        <button type="button" onclick="closeWorkflowCreationModal()" style="padding: 10px 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                            Cancel
                        </button>
                        <button type="submit" style="padding: 10px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-plus"></i>
                            Create Workflow
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- End workflow-creation-modal -->

</div> <!-- End canvas-modal-content -->
</div> <!-- End canvas-modal -->

    <script>
        // Current persona and view mode
        let currentPersona = localStorage.getItem('cleansheet_currentPersona') || 'default';
        let currentViewMode = 'seeker'; // 'seeker' or 'learner'

        // DIAGNOSTIC: Log initial state at page load
        console.log('[DIAGNOSTIC] Page initialization:');
        console.log('[DIAGNOSTIC] currentPersona variable initialized to:', currentPersona);
        console.log('[DIAGNOSTIC] localStorage cleansheet_currentPersona:', localStorage.getItem('cleansheet_currentPersona'));

        // ===================================================================
        // Authentication & Sync Configuration
        // ===================================================================
        const authConfig = {
            clientId: '365cb98b-a67e-48fe-ab87-4b79a91af651',
            tenantId: 'd0c94b5c-2d4a-4dbc-8690-f7a434b2ffdb',
            authority: 'https://login.microsoftonline.com/d0c94b5c-2d4a-4dbc-8690-f7a434b2ffdb',
            redirectUri: window.location.origin + window.location.pathname,
            tokenEndpoint: 'https://cleansheet-functions-b6dze5ece9d4fefr.eastus2-01.azurewebsites.net/api/user/sas-token',
            storageAccount: 'storageb681',
            containerName: 'userworkspaces'
        };

        // Initialize auth and sync
        const auth = new CleansheetAuth(authConfig);
        const sync = new CleansheetSync(auth, authConfig);

        // Authentication state
        let isAuthenticated = false;
        let currentUser = null;
        let isInitializing = true;

        // Force button to default state immediately on script load (before any events)
        (function() {
            const button = document.getElementById('cloudSyncButton');
            const icon = document.getElementById('cloudSyncIcon');
            const text = document.getElementById('cloudSyncText');
            if (button && icon && text) {
                console.log('[Auth Init] Setting button to default state on script load');
                icon.className = 'ph ph-cloud-arrow-up';
                text.textContent = 'Sign In';
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            }
        })();

        // Set button to correct state as soon as DOM is ready (before load event)
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Auth Init] DOMContentLoaded - updating button, isAuth:', isAuthenticated);
            updateCloudSyncButton();
        });

        // Handle Firefox bfcache (back-forward cache)
        window.addEventListener('pageshow', (event) => {
            console.log('[Auth Init] pageshow - persisted:', event.persisted);
            if (event.persisted) {
                // Page was restored from bfcache, reset button state
                console.log('[Auth Init] Page restored from bfcache, resetting button state');
                isAuthenticated = false;
                currentUser = null;
                isInitializing = true;
                updateCloudSyncButton();

                // Re-check auth state
                if (auth.isAuthenticated()) {
                    console.log('[Auth Init] User still authenticated after bfcache restore');
                    isAuthenticated = true;
                    currentUser = auth.getUser();
                } else {
                    console.log('[Auth Init] User not authenticated after bfcache restore');
                }
                isInitializing = false;

                // Update left panel status after bfcache restore
                updateLeftPanelStatusBar();
                updateCloudSyncButton();
            }
        });

        // Simple auth initialization on page load
        window.addEventListener('load', async () => {
            console.log('[Auth Init] load event - starting, isAuth:', isAuthenticated);
            // Set button to default state immediately (before any async operations)
            updateCloudSyncButton();

            try {
                console.log('[Auth Init] Calling handleRedirectCallback');
                await auth.handleRedirectCallback();

                console.log('[Auth Init] Checking if authenticated:', auth.isAuthenticated());
                if (auth.isAuthenticated()) {
                    isAuthenticated = true;
                    currentUser = auth.getUser();
                    console.log('[Auth Init] ✓ User authenticated:', currentUser.email);

                    // Update left panel auth status
                    updateLeftPanelAuthStatus();

                    // Initialize sync
                    console.log('[Auth Init] Initializing sync...');
                    await sync.initialize();
                    console.log('[Auth Init] ✓ Workspace sync initialized');

                    // IMPORTANT: Mark initialization as complete BEFORE updating button
                    // This must happen after sync.initialize() completes to block sync events
                    isInitializing = false;
                    console.log('[Auth Init] Initialization complete, isAuth:', isAuthenticated);

                    // Update button after successful auth and sync
                    updateCloudSyncButton();
                } else {
                    console.log('[Auth Init] User not authenticated');

                    // Mark initialization as complete for unauthenticated users
                    isInitializing = false;
                    console.log('[Auth Init] Initialization complete, isAuth:', isAuthenticated);

                    // Update button for unauthenticated state
                    updateCloudSyncButton();
                }
            } catch (error) {
                console.error('[Auth Init] Auth initialization error:', error);

                // Mark initialization as complete even on error
                isInitializing = false;
                updateCloudSyncButton();
            }
        });

        // Handle cloud sync button click
        async function handleCloudSyncClick() {
            const subscriptionTier = localStorage.getItem('subscription_tier') || 'seeker';

            // Show member tier info modal for Member tier
            if (subscriptionTier === 'member') {
                openMemberTierInfoModal();
            } else {
                // Directly trigger auth without modal
                if (isAuthenticated) {
                    // Open sign out confirmation modal
                    openSignOutModal();
                } else {
                    // Sign in directly
                    await auth.signIn();
                }
            }
        }

        // Open member tier info modal
        function openMemberTierInfoModal() {
            const modal = document.getElementById('memberTierInfoModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // Close member tier info modal
        function closeMemberTierInfoModal() {
            const modal = document.getElementById('memberTierInfoModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }


        // Open sign out confirmation modal
        function openSignOutModal() {
            const modal = document.getElementById('signOutModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // Close sign out confirmation modal
        function closeSignOutModal() {
            const modal = document.getElementById('signOutModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Confirm and execute sign out
        async function confirmSignOut() {
            closeSignOutModal();

            isAuthenticated = false;
            currentUser = null;
            updateCloudSyncButton();

            // Update left panel auth and sync status
            updateLeftPanelAuthStatus();
            updateLeftPanelSyncStatus();

            await auth.signOut();
        }

        // ===================================================================
        // Data Recovery Functions
        // ===================================================================

        function checkForOldData() {
            const oldKeys = {
                'cleansheet_profile': 'userProfile',
                'cleansheet_experiences': 'user_experiences',
                'cleansheet_stories': 'user_stories',
                'behavioralStories': 'user_stories'
            };

            const found = [];
            for (const [oldKey, newKey] of Object.entries(oldKeys)) {
                const oldData = localStorage.getItem(oldKey);
                if (oldData && oldData !== '[]' && oldData !== 'null' && oldData !== '{}') {
                    found.push({ oldKey, newKey, size: oldData.length });
                }
            }

            return found;
        }

        async function recoverOldData() {
            const oldData = checkForOldData();

            if (oldData.length === 0) {
                alert('No old data found to recover.');
                return;
            }

            const message = `Found data in old localStorage keys:\n${oldData.map(d => `- ${d.oldKey} (${d.size} bytes)`).join('\n')}\n\nRecover this data?`;

            if (!confirm(message)) {
                return;
            }

            try {
                console.log('[Recovery] Starting data recovery...');

                // Copy data from old keys to new keys
                for (const {oldKey, newKey} of oldData) {
                    const data = localStorage.getItem(oldKey);
                    const existing = localStorage.getItem(newKey);

                    if (existing && existing !== '[]' && existing !== 'null' && existing !== '{}') {
                        if (!confirm(`${newKey} already has data. Overwrite with old data from ${oldKey}?`)) {
                            continue;
                        }
                    }

                    localStorage.setItem(newKey, data);
                    console.log(`[Recovery] Copied ${oldKey} → ${newKey}`);
                }

                // Reload UI
                await loadAllCounts();
                if (typeof refreshMindmap === 'function') {
                    refreshMindmap();
                }

                showToast('Data recovered! Now use "Sync Up" to upload to cloud.', 'success');
                closeSupportModal();

            } catch (error) {
                console.error('[Recovery] Recovery failed:', error);
                alert('Recovery failed: ' + error.message);
            }
        }

        // ===================================================================
        // Support Modal Functions
        // ===================================================================

        function openSupportModal() {
            const modal = document.getElementById('supportModal');
            if (modal) {
                modal.style.display = 'flex';
                updateSyncStatusInfo();

                // Close profile dropdown
                const dropdown = document.getElementById('profileDropdown');
                if (dropdown) dropdown.classList.remove('active');
            }
        }

        function closeSupportModal() {
            const modal = document.getElementById('supportModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updateSyncStatusInfo() {
            const authStatus = document.getElementById('syncAuthStatus');
            const lastSyncTime = document.getElementById('syncLastSyncTime');
            const autoStatus = document.getElementById('syncAutoStatus');

            if (authStatus) {
                authStatus.textContent = isAuthenticated ? `Authenticated (${currentUser?.email || 'Unknown'})` : 'Not Authenticated';
                authStatus.style.color = isAuthenticated ? '#16a34a' : '#dc2626';
            }

            if (autoStatus) {
                autoStatus.textContent = isAuthenticated ? 'Enabled (every 60 seconds)' : 'Disabled (not signed in)';
                autoStatus.style.color = isAuthenticated ? '#16a34a' : '#666';
            }

            // Get last sync time from localStorage
            if (lastSyncTime) {
                const lastSync = localStorage.getItem('cleansheet_last_modified');
                if (lastSync) {
                    const date = new Date(lastSync);
                    lastSyncTime.textContent = date.toLocaleString();
                } else {
                    lastSyncTime.textContent = 'Never';
                }
            }

            // Show localStorage diagnostic info
            showLocalStorageDiagnostics();
        }

        function showLocalStorageDiagnostics() {
            const diagnosticsDiv = document.getElementById('localStorageDiagnostics');
            if (!diagnosticsDiv) return;

            const persona = currentPersona || localStorage.getItem('current_persona') || 'member';

            const keys = [
                { label: 'Profile', key: 'userProfile' },
                { label: 'Experiences', key: 'user_experiences' },
                { label: 'Stories', key: 'user_stories' },
                { label: 'Jobs', key: 'user_jobs' },
                { label: 'Goals', key: `userGoals_${persona}` },
                { label: 'Portfolio', key: `userPortfolio_${persona}` },
                { label: 'Persona', key: 'current_persona' },
                { label: 'Subscription', key: 'subscription_tier' }
            ];

            let html = '<div style="font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto;">';

            for (const {label, key} of keys) {
                const value = localStorage.getItem(key);
                let status = '';
                let color = '';

                if (!value || value === 'null' || value === 'undefined') {
                    status = '❌ NULL/MISSING';
                    color = '#dc2626';
                } else if (value === '[]' || value === '{}') {
                    status = '⚠️ EMPTY';
                    color = '#f59e0b';
                } else {
                    try {
                        const parsed = JSON.parse(value);
                        if (Array.isArray(parsed)) {
                            status = `✓ ${parsed.length} items`;
                            color = '#16a34a';
                        } else if (typeof parsed === 'object') {
                            const propCount = Object.keys(parsed).length;
                            status = `✓ ${propCount} properties`;
                            color = '#16a34a';
                        } else {
                            status = `✓ ${value}`;
                            color = '#16a34a';
                        }
                    } catch (e) {
                        status = `✓ ${value.substring(0, 20)}...`;
                        color = '#16a34a';
                    }
                }

                html += `<div style="margin-bottom: 4px; padding: 4px; background: #f5f5f7; border-radius: 4px;">
                    <strong>${label}:</strong> <span style="color: ${color};">${status}</span>
                    <br><span style="color: #666; font-size: 10px;">${key}</span>
                </div>`;
            }

            html += '</div>';
            diagnosticsDiv.innerHTML = html;
        }

        async function forceSyncDown() {
            if (!isAuthenticated || !sync) {
                alert('Please sign in to sync');
                return;
            }

            if (confirm('Download data from cloud and replace local data?\n\nThis will overwrite any local changes with data from the cloud.')) {
                try {
                    console.log('[Force Sync] Starting sync down...');
                    console.log('[Force Sync] User:', auth.getUser());
                    console.log('[Force Sync] Workspace path:', `${auth.getUser().id}/workspace/`);

                    // Get workspace data from cloud
                    const cloudData = await sync.getWorkspace();

                    console.log('[Force Sync] Cloud data received:', cloudData ? 'YES' : 'NO');
                    if (cloudData) {
                        console.log('[Force Sync] Cloud data contents:', {
                            profile: !!cloudData.profile,
                            experiences: cloudData.experiences?.length || 0,
                            stories: cloudData.stories?.length || 0,
                            jobs: cloudData.jobs?.length || 0,
                            goals: cloudData.goals?.length || 0,
                            portfolio: cloudData.portfolio?.length || 0,
                            persona: cloudData.persona,
                            subscriptionTier: cloudData.subscriptionTier
                        });

                        // Save to localStorage
                        localStorage.setItem('cleansheet_last_modified', cloudData.lastModified || new Date().toISOString());

                        // Save each data type
                        if (cloudData.profile) {
                            localStorage.setItem('userProfile', JSON.stringify(cloudData.profile));
                            console.log('[Force Sync] Saved profile to localStorage');
                        }
                        if (cloudData.experiences) {
                            // FIXED: Save to cleansheet_experiences (not user_experiences) to match loadUserExperiences
                            localStorage.setItem('cleansheet_experiences', JSON.stringify(cloudData.experiences));
                            console.log('[Force Sync] Saved', cloudData.experiences.length, 'experiences to cleansheet_experiences');
                        }
                        if (cloudData.stories) {
                            localStorage.setItem('user_stories', JSON.stringify(cloudData.stories));
                            console.log('[Force Sync] Saved', cloudData.stories.length, 'stories to localStorage');
                        }
                        if (cloudData.jobs) {
                            localStorage.setItem('user_jobs', JSON.stringify(cloudData.jobs));
                            console.log('[Force Sync] Saved', cloudData.jobs.length, 'jobs to localStorage');
                        }
                        if (cloudData.goals) {
                            localStorage.setItem(`userGoals_${currentPersona}`, JSON.stringify(cloudData.goals));
                            console.log('[Force Sync] Saved', cloudData.goals.length, 'goals to localStorage');
                        }
                        if (cloudData.portfolio) {
                            localStorage.setItem(`userPortfolio_${currentPersona}`, JSON.stringify(cloudData.portfolio));
                            console.log('[Force Sync] Saved', cloudData.portfolio.length, 'portfolio items to localStorage');
                        }
                        if (cloudData.persona) {
                            localStorage.setItem('current_persona', cloudData.persona);
                            console.log('[Force Sync] Saved persona:', cloudData.persona);
                        }
                        if (cloudData.subscriptionTier) {
                            localStorage.setItem('subscription_tier', cloudData.subscriptionTier);
                            console.log('[Force Sync] Saved subscription tier:', cloudData.subscriptionTier);
                        }

                        // Set flag to prevent demo data from loading on next page load
                        localStorage.setItem('cleansheet_currentPersona', cloudData.persona || 'member');

                        // FIXED: Update global currentPersona variable to match localStorage
                        currentPersona = cloudData.persona || 'member';
                        console.log('[Force Sync] Set cleansheet_currentPersona flag and updated currentPersona variable to:', currentPersona);

                        // FIXED: Clear conflicting demo data and old keys
                        const keysToClean = [
                            'user_experiences',  // Old wrong key from before fix
                            'careerExperiences_career-changer',  // Marcus Thompson demo
                            'careerExperiences_default',
                            'careerExperiences_member',
                            'careerExperiences_learner'
                        ];
                        let cleanedKeys = [];
                        keysToClean.forEach(key => {
                            if (localStorage.getItem(key)) {
                                localStorage.removeItem(key);
                                cleanedKeys.push(key);
                            }
                        });
                        if (cleanedKeys.length > 0) {
                            console.log('[Force Sync] Cleaned up conflicting keys:', cleanedKeys.join(', '));
                        }

                        // DIAGNOSTIC: Log all localStorage keys and currentPersona variable state
                        console.log('[DIAGNOSTIC] After forceSyncDown:');
                        console.log('[DIAGNOSTIC] currentPersona variable:', currentPersona);
                        console.log('[DIAGNOSTIC] localStorage cleansheet_currentPersona:', localStorage.getItem('cleansheet_currentPersona'));
                        console.log('[DIAGNOSTIC] localStorage current_persona:', localStorage.getItem('current_persona'));

                        // Log all experience-related keys
                        const expKeys = ['user_experiences', 'cleansheet_experiences', 'careerExperiences_career-changer', 'careerExperiences_member', 'careerExperiences_default'];
                        expKeys.forEach(key => {
                            const data = localStorage.getItem(key);
                            if (data) {
                                try {
                                    const parsed = JSON.parse(data);
                                    console.log(`[DIAGNOSTIC] localStorage ${key}: ${parsed.length} items`);
                                } catch(e) {
                                    console.log(`[DIAGNOSTIC] localStorage ${key}: exists but not JSON`);
                                }
                            } else {
                                console.log(`[DIAGNOSTIC] localStorage ${key}: null/undefined`);
                            }
                        });

                        console.log('[Force Sync] Cloud data saved to localStorage');

                        // Reload UI
                        console.log('[Force Sync] Reloading UI...');
                        await loadAllCounts();
                        if (typeof refreshMindmap === 'function') {
                            refreshMindmap();
                        }

                        showToast('Data synced from cloud successfully', 'success');
                        updateSyncStatusInfo();
                        console.log('[Force Sync] Sync down complete');
                    } else {
                        console.warn('[Force Sync] No cloud data returned from getWorkspace()');
                        showToast('No cloud data found', 'info');
                    }
                } catch (error) {
                    console.error('[Force Sync] Sync down failed:', error);
                    console.error('[Force Sync] Error details:', {
                        message: error.message,
                        stack: error.stack,
                        status: error.status
                    });
                    showToast('Sync failed: ' + error.message, 'error');
                }
            }
        }

        async function forceSyncUp() {
            if (!isAuthenticated || !sync) {
                alert('Please sign in to sync');
                return;
            }

            if (confirm('Upload your local data to cloud?\n\nThis will overwrite cloud data with your local changes.')) {
                try {
                    console.log('[Force Sync] Starting sync up...');
                    console.log('[Force Sync] Current persona:', currentPersona);

                    // Gather all local data
                    const workspaceData = {
                        profile: JSON.parse(localStorage.getItem('userProfile') || 'null'),
                        experiences: JSON.parse(localStorage.getItem('user_experiences') || '[]'),
                        stories: JSON.parse(localStorage.getItem('user_stories') || '[]'),
                        jobs: JSON.parse(localStorage.getItem('user_jobs') || '[]'),
                        goals: JSON.parse(localStorage.getItem(`userGoals_${currentPersona}`) || '[]'),
                        portfolio: JSON.parse(localStorage.getItem(`userPortfolio_${currentPersona}`) || '[]'),
                        persona: localStorage.getItem('current_persona') || 'member',
                        subscriptionTier: localStorage.getItem('subscription_tier') || 'seeker',
                        lastModified: new Date().toISOString()
                    };

                    // Log what we're uploading
                    console.log('[Force Sync] Workspace data being uploaded:');
                    console.log('  - Profile:', workspaceData.profile);
                    console.log('  - Experiences:', workspaceData.experiences?.length || 0, 'items');
                    console.log('  - Stories:', workspaceData.stories?.length || 0, 'items');
                    console.log('  - Jobs:', workspaceData.jobs?.length || 0, 'items');
                    console.log('  - Goals:', workspaceData.goals?.length || 0, 'items');
                    console.log('  - Portfolio:', workspaceData.portfolio?.length || 0, 'items');
                    console.log('  - Persona:', workspaceData.persona);
                    console.log('  - Subscription:', workspaceData.subscriptionTier);

                    // Upload to cloud
                    await sync.saveWorkspace(workspaceData);
                    localStorage.setItem('cleansheet_last_modified', workspaceData.lastModified);

                    console.log('[Force Sync] Local data uploaded to cloud');
                    showToast('Data uploaded to cloud successfully', 'success');
                    updateSyncStatusInfo();
                } catch (error) {
                    console.error('[Force Sync] Sync up failed:', error);
                    showToast('Sync failed: ' + error.message, 'error');
                }
            }
        }

        async function forceFullSync() {
            if (!isAuthenticated || !sync) {
                alert('Please sign in to sync');
                return;
            }

            try {
                console.log('[Force Sync] Starting full bidirectional sync...');

                // Re-initialize sync which does bidirectional sync with conflict resolution
                await sync.initialize();

                // Reload UI
                await loadAllCounts();
                if (typeof refreshMindmap === 'function') {
                    refreshMindmap();
                }

                console.log('[Force Sync] Full sync completed');
                showToast('Full sync completed successfully', 'success');
                updateSyncStatusInfo();
            } catch (error) {
                console.error('[Force Sync] Full sync failed:', error);
                showToast('Sync failed: ' + error.message, 'error');
            }
        }

        // ===================================================================
        // Cloud Sync Button Management
        // ===================================================================

        // Update cloud sync button appearance
        function updateCloudSyncButton() {
            const button = document.getElementById('cloudSyncButton');
            const icon = document.getElementById('cloudSyncIcon');
            const text = document.getElementById('cloudSyncText');
            const subscriptionTier = localStorage.getItem('subscription_tier') || 'seeker';

            console.log('[Auth Button] updateCloudSyncButton called - isAuth:', isAuthenticated, 'tier:', subscriptionTier, 'isInitializing:', isInitializing);

            if (!button || !icon || !text) {
                console.log('[Auth Button] Button elements not found yet');
                return;
            }

            // Style differently for Member tier (but keep clickable to show info modal)
            if (subscriptionTier === 'member') {
                console.log('[Auth Button] Setting to Member tier state');
                button.disabled = false;
                button.style.opacity = '0.7';
                button.style.cursor = 'pointer';
                icon.className = 'ph ph-cloud-slash';
                text.textContent = 'Cloud Sync Unavailable';
                button.title = 'Click to learn about cloud sync and tier features';
                return;
            }

            // Enable for Seeker and Learner
            button.disabled = false;
            button.style.opacity = '1';
            button.style.cursor = 'pointer';

            if (isAuthenticated && currentUser) {
                console.log('[Auth Button] Setting to authenticated state');
                icon.className = 'ph ph-cloud-check';
                text.textContent = 'Signed In';
                button.title = 'Click to sign out';
            } else {
                console.log('[Auth Button] Setting to unauthenticated state (Sign In)');
                icon.className = 'ph ph-cloud-arrow-up';
                text.textContent = 'Sign In';
                button.title = 'Sign in to sync your data across devices';
            }
        }

        // ===================================================================
        // Sync Status UI Management
        // ===================================================================

        // Add animations for sync indicator
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.5;
                    transform: scale(1.2);
                }
            }
        `;
        document.head.appendChild(style);

        // Helper function to reload all data and refresh UI
        async function loadAllCounts() {
            console.log('[Sync] Reloading all data from localStorage...');

            // Reload jobs
            if (typeof loadUserJobs === 'function') {
                loadUserJobs();
            }

            // Reload stories
            if (typeof loadStories === 'function') {
                loadStories();
            }

            // Reload experiences
            if (typeof loadUserExperiences === 'function') {
                loadUserExperiences();
            }

            // Reload goals
            if (typeof loadGoals === 'function') {
                loadGoals();
            }

            // Reload portfolio
            if (typeof loadPortfolio === 'function') {
                loadPortfolio();
            }

            console.log('[Sync] All data reloaded');
        }

        // Add subtle sync status indicator (non-interactive)
        if (sync) {
            sync.addEventListener('sync_start', () => {
                if (isInitializing) return;
                const indicator = document.getElementById('syncStatusIndicator');
                if (indicator && isAuthenticated) {
                    indicator.style.display = 'block';
                    indicator.style.animation = 'pulse 1.5s ease-in-out infinite';
                    indicator.style.background = '#3b82f6'; // Blue when syncing
                }
                // Update left panel sync status
                updateLeftPanelSyncStatus('syncing');
            });

            sync.addEventListener('sync_complete', (data) => {
                if (isInitializing) return;

                console.log('[Sync] Sync complete:', data);

                // Update subtle indicator
                const indicator = document.getElementById('syncStatusIndicator');
                if (indicator && isAuthenticated) {
                    indicator.style.animation = 'none';
                    indicator.style.background = '#10b981'; // Green when complete
                    // Show briefly then fade out
                    setTimeout(() => {
                        if (indicator) {
                            indicator.style.transition = 'opacity 1s';
                            indicator.style.opacity = '0';
                            setTimeout(() => {
                                if (indicator) {
                                    indicator.style.display = 'none';
                                    indicator.style.opacity = '1';
                                    indicator.style.transition = '';
                                }
                            }, 1000);
                        }
                    }, 1500);
                }

                // Refresh UI if this was a sync down (data came from cloud)
                if (data && data.direction === 'down') {
                    console.log('[Sync] Data synced from cloud - refreshing UI');

                    // Reload counts and refresh mindmap
                    loadAllCounts().then(() => {
                        console.log('[Sync] Counts refreshed, updating mindmap');
                        if (typeof refreshMindmap === 'function') {
                            refreshMindmap();
                        }
                    });

                    // Show a subtle toast notification
                    if (typeof showToast === 'function') {
                        showToast('Data synced from cloud', 'success');
                    }
                }

                // Update left panel sync status
                updateLeftPanelSyncStatus('synced');
            });

            sync.addEventListener('sync_error', () => {
                if (isInitializing) return;
                const indicator = document.getElementById('syncStatusIndicator');
                if (indicator && isAuthenticated) {
                    indicator.style.animation = 'none';
                    indicator.style.background = '#ef4444'; // Red on error
                    // Show briefly then fade out
                    setTimeout(() => {
                        if (indicator) {
                            indicator.style.transition = 'opacity 1s';
                            indicator.style.opacity = '0';
                            setTimeout(() => {
                                if (indicator) {
                                    indicator.style.display = 'none';
                                    indicator.style.opacity = '1';
                                    indicator.style.transition = '';
                                }
                            }, 1000);
                        }
                    }, 2000);
                }

                // Update left panel sync status
                updateLeftPanelSyncStatus('error');
            });
        }

        // ===================================================================
        // Legacy Profile Storage (TO BE DEPRECATED)
        // ===================================================================
        // Azure Table Storage endpoint for profile requests (write-only SAS token)
        // Direct write to Table Storage - no Azure Function needed
        // SAS token has 'add' permission only (cannot read existing data)
        // Token expires: 2026-11-05
        const PROFILE_REQUEST_TABLE_URL = 'https://storageb681.table.core.windows.net/ProfileRequests?se=2026-11-05T01%3A04Z&sp=a&sv=2019-02-02&tn=ProfileRequests&sig=Cx6YwQaoga8xPSzKJWCPenEoLZUbN/U85k6gPmqtOa8%3D';

        // Azure Blob Storage container for large profile data (write-only SAS token)
        // Used for storing complete profile exports that exceed Table Storage 32KB limit
        // SAS token has 'w' permission only (write, cannot read/list/delete)
        // Token expires: 2026-11-05
        // Generated by azure-create-profile-blobs.sh on 2025-11-07
        const PROFILE_BLOB_CONTAINER_URL = 'https://storageb681.blob.core.windows.net/profileblobs?se=2026-11-05T01%3A04Z&sp=w&spr=https&sv=2022-11-02&sr=c&sig=vBTWVGRSUjGwTB4LdLLjVc6mpnZdt/RYx0RRun8%2BW3U%3D';

        // Example documents for each persona
        const exampleDocuments = {
            'career-changer': [
                {
                    id: 'example-doc-rm-1',
                    name: 'Store Operations Playbook',
                    description: 'Comprehensive guide for daily store operations, opening/closing procedures, and staff scheduling protocols.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    content: '',
                    created: '2024-01-15T08:00:00.000Z',
                    lastModified: '2024-01-15T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-doc-rm-2',
                    name: 'Customer Service Training Manual',
                    description: 'Training materials for new hires covering customer engagement, conflict resolution, and company policies.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    content: '',
                    created: '2024-01-20T08:00:00.000Z',
                    lastModified: '2024-01-20T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-doc-rm-3',
                    name: 'Inventory Management Best Practices',
                    description: 'Documentation of inventory tracking systems, reordering procedures, and loss prevention strategies.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    content: '',
                    created: '2024-01-25T08:00:00.000Z',
                    lastModified: '2024-01-25T08:00:00.000Z',
                    isExample: true
                }
            ],
            'product-manager': [
                {
                    id: 'example-doc-chem-1',
                    name: 'Lab Safety & Compliance Protocol',
                    description: 'Safety procedures, chemical handling guidelines, and regulatory compliance documentation for laboratory operations.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    content: '',
                    created: '2024-01-15T08:00:00.000Z',
                    lastModified: '2024-01-15T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-doc-chem-2',
                    name: 'Experimental Procedures - Polymer Synthesis',
                    description: 'Detailed methodology for polymer synthesis experiments including materials, equipment setup, and analysis techniques.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    content: '',
                    created: '2024-01-20T08:00:00.000Z',
                    lastModified: '2024-01-20T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-doc-chem-3',
                    name: 'Quality Control Standards & Testing',
                    description: 'Quality assurance protocols, testing procedures, and acceptance criteria for research outputs.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    content: '',
                    created: '2024-01-25T08:00:00.000Z',
                    lastModified: '2024-01-25T08:00:00.000Z',
                    isExample: true
                }
            ],
            'new-graduate': [
                {
                    id: 'example-doc-da-1',
                    name: 'SQL Query Library & Documentation',
                    description: 'Collection of reusable SQL queries for common reporting needs, with explanations and optimization notes.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    content: '',
                    created: '2024-01-15T08:00:00.000Z',
                    lastModified: '2024-01-15T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-doc-da-2',
                    name: 'Dashboard Design Standards',
                    description: 'Guidelines for creating effective data visualizations, color schemes, and user interface best practices.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    content: '',
                    created: '2024-01-20T08:00:00.000Z',
                    lastModified: '2024-01-20T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-doc-da-3',
                    name: 'Data Cleaning & Validation Procedures',
                    description: 'Step-by-step processes for data quality checks, handling missing values, and ensuring data integrity.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    content: '',
                    created: '2024-01-25T08:00:00.000Z',
                    lastModified: '2024-01-25T08:00:00.000Z',
                    isExample: true
                }
            ]
        };

        // Example diagrams for each persona
        const exampleDiagrams = {
            'career-changer': [
                {
                    id: 'example-diag-rm-1',
                    name: 'Store Layout & Customer Flow',
                    description: 'Floor plan showing product placement, checkout zones, and optimal customer traffic patterns for maximum sales conversion.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    diagramData: null,
                    created: '2024-01-15T08:00:00.000Z',
                    lastModified: '2024-01-15T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-diag-rm-2',
                    name: 'Team Organization Chart',
                    description: 'Organizational structure showing reporting relationships, shift schedules, and department responsibilities.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    diagramData: null,
                    created: '2024-01-20T08:00:00.000Z',
                    lastModified: '2024-01-20T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-diag-rm-3',
                    name: 'Inventory Management Process Flow',
                    description: 'Workflow diagram illustrating receiving, stocking, inventory counts, and reordering processes.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    diagramData: null,
                    created: '2024-01-25T08:00:00.000Z',
                    lastModified: '2024-01-25T08:00:00.000Z',
                    isExample: true
                }
            ],
            'product-manager': [
                {
                    id: 'example-diag-chem-1',
                    name: 'Lab Equipment Layout',
                    description: 'Laboratory floor plan showing equipment placement, safety stations, and workflow zones for optimal efficiency.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    diagramData: null,
                    created: '2024-01-15T08:00:00.000Z',
                    lastModified: '2024-01-15T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-diag-chem-2',
                    name: 'Synthesis Reaction Pathway',
                    description: 'Chemical reaction scheme showing synthesis steps, intermediate compounds, and reaction conditions.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    diagramData: null,
                    created: '2024-01-20T08:00:00.000Z',
                    lastModified: '2024-01-20T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-diag-chem-3',
                    name: 'Quality Control Workflow',
                    description: 'Process flowchart for sample testing, analysis methods, data validation, and approval procedures.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    diagramData: null,
                    created: '2024-01-25T08:00:00.000Z',
                    lastModified: '2024-01-25T08:00:00.000Z',
                    isExample: true
                }
            ],
            'new-graduate': [
                {
                    id: 'example-diag-da-1',
                    name: 'Data Pipeline Architecture',
                    description: 'System architecture diagram showing data sources, ETL processes, databases, and reporting layers.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    diagramData: null,
                    created: '2024-01-15T08:00:00.000Z',
                    lastModified: '2024-01-15T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-diag-da-2',
                    name: 'Dashboard Wireframe - Sales Analytics',
                    description: 'Wireframe design for executive sales dashboard with KPIs, trend charts, and drill-down capabilities.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    diagramData: null,
                    created: '2024-01-20T08:00:00.000Z',
                    lastModified: '2024-01-20T08:00:00.000Z',
                    isExample: true
                },
                {
                    id: 'example-diag-da-3',
                    name: 'Analysis Process Flowchart',
                    description: 'Workflow showing data collection, cleaning, analysis, visualization, and stakeholder communication steps.',
                    linkedType: 'none',
                    linkedId: '',
                    linkedName: '',
                    diagramData: null,
                    created: '2024-01-25T08:00:00.000Z',
                    lastModified: '2024-01-25T08:00:00.000Z',
                    isExample: true
                }
            ]
        };

        // AudioTourManager - Web Audio API integration for Driver.js tour narrations
        class AudioTourManager {
            constructor() {
                this.audioContext = null;
                this.audioBuffers = new Map();
                this.currentSource = null;
                this.isPlaying = false;
                this.volume = 0.8;
                this.gainNode = null;

                // Audio file mappings
                this.audioMappings = {
                    'welcome': 'assets/audio/tour-narrations/canvas-overview/welcome-canvas-intro-30s.mp3',
                    'view-modes': 'assets/audio/tour-narrations/canvas-overview/view-mode-selector-25s.mp3',
                    'mindmap-navigation': 'assets/audio/tour-narrations/ui-controls/mindmap-navigation-40s.mp3',
                    'calendar-widget': 'assets/audio/tour-narrations/ui-controls/calendar-widget-30s.mp3',
                    'ai-assistant': 'assets/audio/tour-narrations/ui-controls/ai-assistant-35s.mp3',
                    'job-search-view': 'assets/audio/tour-narrations/job-search/job-search-view-50s.mp3',
                    'projects-view': 'assets/audio/tour-narrations/professional-tools/projects-view-45s.mp3',
                    'panel-controls': 'assets/audio/tour-narrations/ui-controls/panel-controls-20s.mp3'
                };

                this.initAudioContext();
            }

            async initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.gainNode = this.audioContext.createGain();
                    this.gainNode.connect(this.audioContext.destination);
                    this.gainNode.gain.value = this.volume;

                    // Handle browser autoplay policies
                    if (this.audioContext.state === 'suspended') {
                        console.log('AudioContext suspended - will resume on user interaction');
                    }
                } catch (error) {
                    console.warn('Web Audio API not supported:', error);
                }
            }

            async loadAudio(stepId, audioUrl) {
                if (!this.audioContext || this.audioBuffers.has(stepId)) {
                    return;
                }

                try {
                    const response = await fetch(audioUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to load audio: ${response.status}`);
                    }

                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    this.audioBuffers.set(stepId, audioBuffer);

                    console.log(`Loaded audio for step: ${stepId}`);
                } catch (error) {
                    console.warn(`Failed to load audio for step ${stepId}:`, error);
                }
            }

            async preloadAllAudio() {
                const loadPromises = Object.entries(this.audioMappings).map(([stepId, audioUrl]) =>
                    this.loadAudio(stepId, audioUrl)
                );

                await Promise.allSettled(loadPromises);
                console.log(`Preloaded ${this.audioBuffers.size} audio files`);
            }

            async playNarration(stepId) {
                if (!this.audioContext) {
                    console.warn('AudioContext not available');
                    return false;
                }

                // Resume context if suspended (browser autoplay policy)
                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }

                // Stop current audio if playing
                this.stopAudio();

                const buffer = this.audioBuffers.get(stepId);
                if (!buffer) {
                    console.warn(`No audio buffer found for step: ${stepId}`);
                    return false;
                }

                try {
                    this.currentSource = this.audioContext.createBufferSource();
                    this.currentSource.buffer = buffer;
                    this.currentSource.connect(this.gainNode);

                    this.currentSource.onended = () => {
                        this.isPlaying = false;
                        this.currentSource = null;
                    };

                    this.currentSource.start();
                    this.isPlaying = true;

                    console.log(`Playing narration for step: ${stepId}`);
                    return true;
                } catch (error) {
                    console.warn(`Failed to play audio for step ${stepId}:`, error);
                    return false;
                }
            }

            stopAudio() {
                if (this.currentSource && this.isPlaying) {
                    try {
                        this.currentSource.stop();
                    } catch (error) {
                        // Ignore errors when stopping already stopped sources
                    }
                    this.currentSource = null;
                    this.isPlaying = false;
                }
            }

            setVolume(volume) {
                this.volume = Math.max(0, Math.min(1, volume));
                if (this.gainNode) {
                    this.gainNode.gain.value = this.volume;
                }
            }

            getVolume() {
                return this.volume;
            }

            isAudioPlaying() {
                return this.isPlaying;
            }
        }

        // Initialize audio manager
        const audioTourManager = new AudioTourManager();


        // Centralized function to hide all content sections (prevents bleeding between slideouts)
        function hideAllContentSections() {
            const contentSections = [
                'interviewPrepContent', 'behavioralContent', 'diagramsContent', 'documentsContent', 'mockContent', 'whiteboardsContent',
                'jobOpportunitiesContent', 'careerExperienceContent',
                'skillsCompetenciesContent',
                'goalsContent', 'portfolioContent', 'projectsContent', 'myNotesContent',
                'calendarContent', 'recipesContent', 'financeContent',
                'tablesContent', 'formsContent',
                'reportsContent', 'templatesContent', 'pipelinesContent', 'workflowsContent'
            ];

            contentSections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) section.style.display = 'none';
            });
        }

        // Helper function to animate slideout transitions
        function animateSlideoutTransition(callback) {
            const slideout = document.getElementById('interviewSlideout');

            // If slideout is already open, slide it out first
            if (slideout.classList.contains('active')) {
                slideout.classList.add('sliding-out');
                slideout.classList.remove('active');

                // Wait for slide-out animation, then update content and slide in
                setTimeout(() => {
                    slideout.classList.remove('sliding-out');
                    callback();
                    // Small delay before sliding in with new content
                    setTimeout(() => {
                        slideout.classList.add('active');
                    }, 50);
                }, 400); // Match the transition duration
            } else {
                // Not currently open, just show it directly
                callback();
                slideout.classList.add('active');
            }
        }

        // Default career canvas structure (no example persona data)
        // Feature flag configuration: defines which nodes are available for each subscription tier
        const subscriptionTiers = {
            'member': {
                level: 0,
                availableNodes: ['Career Experience', 'Interview Prep'],
                availableFeatures: []  // Technical tab NOT available for members
            },
            'learner': {
                level: 1,
                availableNodes: ['Career Experience', 'Interview Prep', 'Goals', 'Portfolio'],
                availableFeatures: []  // Technical tab NOT available for learners
            },
            'seeker': {
                level: 2,
                availableNodes: ['Career Experience', 'Interview Prep', 'Goals', 'Portfolio', 'Job Opportunities'],
                availableFeatures: ['Technical']  // Technical tab only available for seekers
            }
        };

        // Get current subscription tier (defaults to 'seeker' for users)
        function getCurrentSubscriptionTier() {
            // In production, this would check actual subscription status
            // For now, defaults to 'seeker'
            const tier = localStorage.getItem('subscription_tier') || 'seeker';
            return tier;
        }

        // Apply viewport settings based on subscription tier
        function applyViewportForTier() {
            const currentTier = getCurrentSubscriptionTier();
            const viewportMeta = document.querySelector('meta[name="viewport"]');

            if (!viewportMeta) {
                console.error('[Viewport] Viewport meta tag not found');
                return;
            }

            if (currentTier === 'member') {
                // Member tier: Fixed desktop width on mobile
                viewportMeta.setAttribute('content', 'width=1024, initial-scale=1.0, user-scalable=no, maximum-scale=1.0');
                console.log('[Viewport] Applied desktop viewport for Member tier (width=1024)');

                // Hide Request Profile button for Member tier (Career Experience section)
                const requestProfileBtn = document.getElementById('requestProfileButton');
                if (requestProfileBtn) {
                    requestProfileBtn.style.display = 'none';
                    console.log('[Tier Features] Request Profile button hidden for Member tier');
                }

                // Hide Assets tab in Interview Preparation for Member tier
                const assetsTab = document.getElementById('assetsTab');
                if (assetsTab) {
                    assetsTab.style.display = 'none';
                    console.log('[Tier Features] Assets tab hidden for Member tier');
                }

                // Show notification once per session
                if (!sessionStorage.getItem('viewport_notification_shown')) {
                    setTimeout(() => {
                        showViewportNotification();
                        sessionStorage.setItem('viewport_notification_shown', 'true');
                    }, 1000); // Delay 1 second to avoid overwhelming user on load
                }
            } else if (currentTier === 'learner') {
                // Learner tier: Mobile-responsive viewport
                viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.0');
                console.log('[Viewport] Applied mobile-responsive viewport for Learner tier');

                // Show Request Profile button for Learner tier (Career Experience section)
                const requestProfileBtn = document.getElementById('requestProfileButton');
                if (requestProfileBtn) {
                    requestProfileBtn.style.display = 'flex';
                    console.log('[Tier Features] Request Profile button visible for Learner tier');
                }

                // Show Assets tab in Interview Preparation for Learner tier
                const assetsTab = document.getElementById('assetsTab');
                if (assetsTab) {
                    assetsTab.style.display = 'inline-flex';
                    console.log('[Tier Features] Assets tab visible for Learner tier');
                }

                // Hide advanced asset types for Learner tier
                const assetTypeWhiteboard = document.getElementById('assetTypeWhiteboard');
                const assetTypeMarkdown = document.getElementById('assetTypeMarkdown');
                const assetTypeCode = document.getElementById('assetTypeCode');
                if (assetTypeWhiteboard) assetTypeWhiteboard.style.display = 'none';
                if (assetTypeMarkdown) assetTypeMarkdown.style.display = 'none';
                if (assetTypeCode) assetTypeCode.style.display = 'none';
                console.log('[Tier Features] Advanced asset types (Whiteboard, Markdown, Code) hidden for Learner tier');
            } else {
                // Seeker tier: Mobile-responsive viewport with all features
                viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.0');
                console.log(`[Viewport] Applied mobile-responsive viewport for ${currentTier} tier`);

                // Show Request Profile button for Seeker tier (Career Experience section)
                const requestProfileBtn = document.getElementById('requestProfileButton');
                if (requestProfileBtn) {
                    requestProfileBtn.style.display = 'flex';
                    console.log('[Tier Features] Request Profile button visible for paid tiers');
                }

                // Show Assets tab in Interview Preparation for Seeker tier
                const assetsTab = document.getElementById('assetsTab');
                if (assetsTab) {
                    assetsTab.style.display = 'inline-flex';
                    console.log('[Tier Features] Assets tab visible for paid tiers');
                }

                // Show all asset types for Seeker tier
                const assetTypeWhiteboard = document.getElementById('assetTypeWhiteboard');
                const assetTypeMarkdown = document.getElementById('assetTypeMarkdown');
                const assetTypeCode = document.getElementById('assetTypeCode');
                if (assetTypeWhiteboard) assetTypeWhiteboard.style.display = 'flex';
                if (assetTypeMarkdown) assetTypeMarkdown.style.display = 'flex';
                if (assetTypeCode) assetTypeCode.style.display = 'flex';
                console.log('[Tier Features] All asset types visible for Seeker tier');
            }

            // Generate mobile menu based on subscription tier
            generateMobileMenu();
            console.log('[Mobile Menu] Generated mobile menu for tier:', currentTier);

            // Initialize swipe-to-close for mobile slideouts
            initializeSwipeToClose();

            // Initialize conditional D3 loading for performance
            initializeConditionalD3Loading();

            // Initialize lazy loading for off-screen content
            initializeLazyLoading();

            // Initialize long-press context menus for mobile
            initializeLongPressContextMenus();

            // Initialize one-handed usage optimization for large mobile devices
            initializeOneHandedOptimization();
        }

        // Show notification for viewport restriction
        function showViewportNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #0066CC 0%, #004C99 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
                z-index: 10000;
                font-family: var(--font-family-body);
                font-size: 13px;
                max-width: 90%;
                text-align: center;
                animation: slideUpFade 0.3s ease-out;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                    <i class="ph ph-info" style="font-size: 18px;"></i>
                    <span>Mobile view optimized for desktop. <strong>Upgrade to Learner</strong> for mobile-responsive experience.</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideDownFade 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Check if a node should be visible based on subscription tier
        function shouldShowNode(nodeName) {
            // Always filter based on subscription tier
            const currentTier = getCurrentSubscriptionTier();
            const tierConfig = subscriptionTiers[currentTier];

            if (!tierConfig) {
                return true; // If tier not found, show everything
            }

            return tierConfig.availableNodes.includes(nodeName);
        }

        // Check if a feature (like Technical tab) should be visible based on subscription tier
        function shouldShowFeature(featureName) {
            // Always filter based on subscription tier
            const currentTier = getCurrentSubscriptionTier();
            const tierConfig = subscriptionTiers[currentTier];

            if (!tierConfig) {
                return true; // If tier not found, show everything
            }

            return tierConfig.availableFeatures && tierConfig.availableFeatures.includes(featureName);
        }

        // Update UI visibility for subscription-gated features
        function updateFeatureVisibility() {
            const currentTier = getCurrentSubscriptionTier();

            // Get all interview prep tabs
            const diagramsTab = document.getElementById('diagramsTab');
            const documentsTab = document.getElementById('documentsTab');
            const mockInterviewsTab = document.getElementById('mockInterviewsTab');
            const whiteboardsMainTab = document.getElementById('whiteboardsMainTab');

            // Member tier: Stories only (everything else hidden)
            // Learner tier: Stories, Diagrams, Documents
            // Seeker tier: Stories, Diagrams, Documents, Whiteboards, Mock Interviews

            const isMember = currentTier === 'member';
            const isSeeker = currentTier === 'seeker';
            const isLearnerOrSeeker = currentTier === 'learner' || currentTier === 'seeker';

            // Diagrams and Documents: Hidden for Member, shown for Learner and Seeker
            if (diagramsTab) {
                diagramsTab.style.display = isLearnerOrSeeker ? '' : 'none';
            }

            if (documentsTab) {
                documentsTab.style.display = isLearnerOrSeeker ? '' : 'none';
            }

            // Mock Interviews and Whiteboards: Seeker only
            if (mockInterviewsTab) {
                mockInterviewsTab.style.display = isSeeker ? '' : 'none';
            }

            if (whiteboardsMainTab) {
                whiteboardsMainTab.style.display = isSeeker ? '' : 'none';
            }
        }

        // Developer helper: Set subscription tier for testing
        // Usage in browser console: setSubscriptionTier('learner') or setSubscriptionTier('seeker')
        window.setSubscriptionTier = function(tier) {
            if (!['member', 'learner', 'seeker'].includes(tier)) {
                console.error('Invalid tier. Use: "member", "learner", or "seeker"');
                return;
            }
            localStorage.setItem('subscription_tier', tier);
            console.log(`Subscription tier set to: ${tier}`);
            console.log('Canvas nodes will update automatically based on the new tier.');

            // Refresh the mindmap if it's visible
            if (currentViewMode) {
                refreshMindmap();
            }

            // Update feature visibility (Technical tab, etc.)
            updateFeatureVisibility();

            // Update cloud sync button
            updateCloudSyncButton();
        };

        const personaData = {
            'default': {
                name: 'User',
                goal: '',
                children: [
                    {
                        name: 'Job Opportunities',
                        tier: 'seeker',  // Required tier for this node
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Career Experience',
                        tier: 'member',  // Available to all tiers
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Goals',
                        tier: 'learner',  // Required tier for this node
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Portfolio',
                        tier: 'learner',  // Required tier for this node
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Interview Prep',
                        tier: 'member',  // Available to all tiers
                        count: 0,
                        children: []
                    }
                ]
            },
            'career-changer': {
                name: 'Marcus Thompson',
                goal: 'Store Manager → Analytics',
                children: [
                    {
                        name: 'Job Opportunities',
                        tier: 'seeker',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Career Experience',
                        tier: 'member',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Goals',
                        tier: 'learner',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Portfolio',
                        tier: 'learner',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Interview Prep',
                        tier: 'member',
                        count: 0,
                        children: []
                    }
                ]
            },
            'product-manager': {
                name: 'Dr. Sarah Chen',
                goal: 'Research Scientist → Data Science',
                children: [
                    {
                        name: 'Job Opportunities',
                        tier: 'seeker',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Career Experience',
                        tier: 'member',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Goals',
                        tier: 'learner',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Portfolio',
                        tier: 'learner',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Interview Prep',
                        tier: 'member',
                        count: 0,
                        children: []
                    }
                ]
            },
            'new-graduate': {
                name: 'Jamie Rodriguez',
                goal: 'CS Graduate → Software Engineering',
                children: [
                    {
                        name: 'Job Opportunities',
                        tier: 'seeker',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Career Experience',
                        tier: 'member',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Goals',
                        tier: 'learner',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Portfolio',
                        tier: 'learner',
                        count: 0,
                        children: []
                    },
                    {
                        name: 'Interview Prep',
                        tier: 'member',
                        count: 0,
                        children: []
                    }
                ]
            }
        };

        // View Mode Functions
        function switchViewMode(mode) {
            currentViewMode = mode;

            // Hide tooltip when switching modes
            guidanceTooltip.hide();

            // Update toggle buttons
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                const btnMode = btn.getAttribute('data-view');
                if (btnMode === mode) {
                    btn.style.background = 'var(--color-primary-blue)';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = 'rgba(255, 255, 255, 0.7)';
                    btn.classList.remove('active');
                }
            });

            // Show/hide menu items based on mode
            const jobSearchMenuItem = document.getElementById('jobSearchMenuItem');
            const libraryMenuItem = document.getElementById('libraryMenuItem');
            const projectsMenuItem = document.getElementById('projectsMenuItem');

            if (mode === 'seeker') {
                // Seeker mode: Home, Job Search, Library
                jobSearchMenuItem.style.display = 'flex';
                libraryMenuItem.style.display = 'flex';
                projectsMenuItem.style.display = 'none';
            } else if (mode === 'professional') {
                // Professional mode: Home, Projects (no Library, no Job Search)
                jobSearchMenuItem.style.display = 'none';
                libraryMenuItem.style.display = 'none';
                projectsMenuItem.style.display = 'flex';

                // If currently on Job Search or Library view, switch back to Home
                const menuName = document.querySelector('.main-menu-item.active span')?.textContent;
                if (menuName === 'Job Search' || menuName === 'Library') {
                    document.querySelector('.main-menu-item').click(); // Click Home button
                }
            } else if (mode === 'learner' || mode === 'personal') {
                // Learner/Personal mode: Hide Job Search and Projects
                jobSearchMenuItem.style.display = 'none';
                libraryMenuItem.style.display = 'flex';
                projectsMenuItem.style.display = 'none';

                // If currently on Job Search view, switch back to Home
                const menuName = document.querySelector('.main-menu-item.active span')?.textContent;
                if (menuName === 'Job Search') {
                    document.querySelector('.main-menu-item').click(); // Click Home button
                }
            }

            // Clear and redraw visualization
            d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();

            if (mode === 'seeker' || mode === 'professional') {
                // Seeker and Professional use mindmap layout
                initializeMindmap(currentPersona);
            } else {
                // Learner and Personal use network layout
                initializeLearnerNetwork(currentPersona);
            }
        }

        function getFilteredPersonaData(persona) {
            let data = personaData[persona];
            // FIXED: Fallback to 'default' if persona doesn't exist in personaData
            if (!data) {
                console.warn(`[Mindmap] Persona '${persona}' not found in personaData, falling back to 'default'`);
                data = personaData['default'];
            }
            if (!data) return null;

            // Apply feature flag filtering based on subscription tier and user preference
            const filteredChildren = data.children.filter(child => {
                // First check if node should be shown based on subscription tier
                if (!shouldShowNode(child.name)) {
                    return false;
                }

                // Then apply view-mode specific filtering (exclude certain nodes from learner/personal views)
                const excludedNodes = ['Job Opportunities', 'Interview Prep'];
                return !excludedNodes.includes(child.name);
            });

            // Load counts from localStorage
            const storedProjects = localStorage.getItem(`projects_${persona}`);
            const projectsCount = storedProjects ? JSON.parse(storedProjects).length : 0;

            const storedNotes = localStorage.getItem(`notes_${persona}`);
            const notesCount = storedNotes ? JSON.parse(storedNotes).length : 0;

            // Professional nodes (with feature flag filtering applied)
            // Note: Learner mode shows these nodes; Code Snippets, Projects, My Library have no subscription restriction
            const allProfessionalNodes = [
                {
                    name: 'Career Experience',
                    tier: 'member',  // Available to all tiers
                    count: data.children.find(c => c.name === 'Career Experience')?.count || 0,
                    children: []
                },
                {
                    name: 'Goals',
                    premium: true,
                    tier: 'learner',  // Requires Learner tier
                    count: data.children.find(c => c.name === 'Goals')?.count || 0,
                    children: []
                },
                {
                    name: 'Portfolio',
                    tier: 'learner',  // Requires Learner tier
                    count: data.children.find(c => c.name === 'Portfolio')?.count || 0,
                    children: []
                },
                {
                    name: 'Code Snippets',
                    tier: 'member',  // Available to all tiers (for now)
                    count: 0,
                    children: []
                },
                {
                    name: 'Projects',
                    tier: 'member',  // Available to all tiers (for now)
                    count: projectsCount,
                    children: []
                },
                {
                    name: 'My Library',
                    tier: 'member',  // Available to all tiers
                    count: 0,
                    children: []
                }
            ];

            // Apply feature flag filtering to professional nodes
            const professionalNodes = allProfessionalNodes.filter(node => shouldShowNode(node.name));

            // Personal nodes
            const personalNodes = [
                {
                    name: 'My Notes',
                    count: notesCount,
                    icon: 'ph-note-pencil',
                    children: []
                },
                {
                    name: 'Shopping',
                    count: 0,
                    icon: 'ph-shopping-cart',
                    children: [
                        { name: 'Grocery', count: 0, icon: 'ph-carrot' },
                        { name: 'Home', count: 0, icon: 'ph-house' },
                        { name: 'Internet', count: 0, icon: 'ph-globe' },
                        { name: 'Gifts', count: 0, icon: 'ph-gift' }
                    ]
                },
                {
                    name: 'Finance',
                    count: 0,
                    icon: 'ph-currency-dollar',
                    children: [
                        { name: 'Insurance', count: 0, icon: 'ph-shield-check' },
                        { name: 'Cash Flow', count: 0, icon: 'ph-arrows-left-right' },
                        { name: 'Assets', count: 0, icon: 'ph-bank' },
                        { name: 'Liabilities', count: 0, icon: 'ph-credit-card' },
                        { name: 'Investments', count: 0, icon: 'ph-trend-up' }
                    ]
                },
                {
                    name: 'Recipes',
                    count: 0,
                    icon: 'ph-cooking-pot',
                    children: []
                }
            ];

            // Return different structures based on view mode
            if (currentViewMode === 'learner') {
                // Learner mode: two-tier with professional features directly connected to center
                return {
                    ...data,
                    children: professionalNodes
                };
            } else if (currentViewMode === 'professional') {
                // Professional mode: mindmap structure with Documents, Tables, Forms, Reports, Templates, Workflows
                return {
                    ...data,
                    children: [
                        {
                            name: 'Documents',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Tables',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Forms',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Reports',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Templates',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Pipelines',
                            count: 0,
                            children: []
                        },
                        {
                            name: 'Workflows',
                            count: 0,
                            children: []
                        }
                    ]
                };
            } else if (currentViewMode === 'personal') {
                // Personal mode: flat network with only personal nodes
                return {
                    ...data,
                    children: personalNodes
                };
            }

            // Seeker mode (default): return all nodes with feature flag filtering applied
            return {
                ...data,
                children: data.children.filter(child => shouldShowNode(child.name))
            };
        }

        // ============================================
        // LLM Integration Functions
        // ============================================

        let currentProvider = null;
        let conversationHistory = [];

        // Update provider badge with cost-based color coding
        function updateProviderBadge() {
            const badge = document.getElementById('providerModelBadge');
            if (!badge) return;

            const config = JSON.parse(localStorage.getItem('llm_config_encrypted') || '{}');

            if (!config.activeProvider || !currentProvider) {
                badge.style.display = 'none';
                return;
            }

            const provider = config.activeProvider;
            const model = config[provider]?.model || 'Unknown';

            // Get cost per 1K tokens from provider
            const models = currentProvider.getModels();
            const modelInfo = models.find(m => m.id === model);
            const costPer1k = modelInfo ? modelInfo.costPer1k : 0;

            // Provider display names
            const providerNames = {
                'openai': 'OpenAI',
                'anthropic': 'Claude',
                'gemini': 'Gemini'
            };

            // Model short names
            const modelShortNames = {
                'gpt-4o': 'GPT-4o',
                'gpt-4o-mini': '4o-mini',
                'gpt-4-turbo': '4-Turbo',
                'gpt-3.5-turbo': '3.5',
                'claude-3-5-sonnet-20241022': '3.5 Sonnet',
                'claude-3-5-haiku-20241022': '3.5 Haiku',
                'claude-3-opus-20240229': '3 Opus',
                'claude-3-sonnet-20240229': '3 Sonnet',
                'claude-3-haiku-20240307': '3 Haiku',
                'gemini-2.0-flash-exp': '2.0 Flash',
                'gemini-1.5-flash': '1.5 Flash',
                'gemini-1.5-flash-8b': '1.5-8B',
                'gemini-1.5-pro': '1.5 Pro'
            };

            const providerName = providerNames[provider] || provider;
            const modelShort = modelShortNames[model] || model;

            // Color coding based on cost
            let bgColor, textColor, borderColor;
            if (costPer1k === 0) {
                // Free
                bgColor = '#dcfce7';
                textColor = '#15803d';
                borderColor = '#86efac';
            } else if (costPer1k < 0.001) {
                // Very low cost (< $0.001)
                bgColor = '#d1fae5';
                textColor = '#065f46';
                borderColor = '#6ee7b7';
            } else if (costPer1k < 0.003) {
                // Low cost ($0.001-$0.003)
                bgColor = '#dbeafe';
                textColor = '#1e40af';
                borderColor = '#93c5fd';
            } else if (costPer1k < 0.01) {
                // Medium cost ($0.003-$0.01)
                bgColor = '#e0e7ff';
                textColor = '#4338ca';
                borderColor = '#a5b4fc';
            } else {
                // High cost (> $0.01)
                bgColor = '#ffedd5';
                textColor = '#c2410c';
                borderColor = '#fdba74';
            }

            badge.textContent = `${providerName} · ${modelShort}`;
            badge.style.display = 'block';
            badge.style.background = bgColor;
            badge.style.color = textColor;
            badge.style.border = `1px solid ${borderColor}`;
            badge.title = `Using ${providerName} ${modelShort} (~$${costPer1k.toFixed(4)}/1K tokens)`;
        }

        // Initialize LLM system on canvas open
        async function initializeLLM() {
            // Safety check: ensure required elements exist
            const chatContainer = document.getElementById('chatContainer');
            const chatEmptyState = document.getElementById('chatEmptyState');
            const chatInputContainer = document.getElementById('chatInputContainer');

            if (!chatContainer || !chatEmptyState || !chatInputContainer) {
                console.warn('[LLM Init] Required elements not found, skipping initialization');
                return;
            }

            // Check tier access - AI Assistant only for Learner and Seeker
            const currentTier = getCurrentSubscriptionTier();

            if (currentTier === 'member') {
                console.log('[LLM Init] AI Assistant restricted for Member tier');
                // Show Member tier upgrade message
                chatEmptyState.innerHTML = `
                    <i class="ph ph-robot" style="font-size: 48px; color: var(--color-neutral-border); margin-bottom: 12px;"></i>
                    <p style="font-family: var(--font-family-body); color: var(--color-neutral-text); text-align: center; margin: 0 0 4px 0; line-height: 1.5; font-size: 14px;">
                        <strong style="color: var(--color-dark);">AI Career Assistant</strong>
                    </p>
                    <p style="font-family: var(--font-family-body); color: var(--color-neutral-text); text-align: center; margin: 0 0 16px 0; line-height: 1.5; font-size: 13px;">
                        Available on Learner and Seeker tiers
                    </p>
                    <button onclick="openSubscriptionModal()"
                            style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-weight: 600; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: background 0.2s;"
                            onmouseover="this.style.background='var(--color-accent-blue)'"
                            onmouseout="this.style.background='var(--color-primary-blue)'">
                        <i class="ph ph-star"></i>
                        Upgrade to Access
                    </button>
                `;
                chatEmptyState.style.display = 'flex';
                chatInputContainer.style.display = 'none';
                return; // Stop initialization for Member tier
            }

            // For Learner and Seeker tiers: proceed with normal initialization
            await loadLLMConfig();

            // Show/hide UI based on configuration
            if (currentProvider) {
                chatEmptyState.style.display = 'none';
                chatInputContainer.style.display = 'block';
            } else {
                chatEmptyState.style.display = 'flex';
                chatInputContainer.style.display = 'none';
            }
        }

        // Check if user can access LLM features
        function canUseLLM() {
            // Safety check: ensure FeatureFlags is loaded
            if (typeof FeatureFlags === 'undefined' || !FeatureFlags.isEnabled) {
                console.warn('[LLM] FeatureFlags not loaded, defaulting to false');
                return false;
            }

            const tier = localStorage.getItem('subscription_tier') || 'member';
            return FeatureFlags.isEnabled('llm-chat-byok', tier);
        }

        // Load LLM configuration from localStorage
        async function loadLLMConfig() {
            try {
                const encryptedConfig = localStorage.getItem('llm_config_encrypted');
                if (!encryptedConfig) return;

                const config = JSON.parse(encryptedConfig);

                // Decrypt API key if present and initialize provider
                if (config.activeProvider === 'openai' && config.openai?.apiKey) {
                    const decryptedApiKey = await CleansheetCrypto.decrypt(config.openai.apiKey);
                    currentProvider = new LLMProviders.OpenAIProvider(
                        decryptedApiKey,
                        { model: config.openai.model || 'gpt-4o' }
                    );
                    console.log('[LLM] OpenAI configuration loaded and decrypted successfully');
                } else if (config.activeProvider === 'anthropic' && config.anthropic?.apiKey) {
                    const decryptedApiKey = await CleansheetCrypto.decrypt(config.anthropic.apiKey);
                    currentProvider = new LLMProviders.AnthropicProvider(
                        decryptedApiKey,
                        { model: config.anthropic.model || 'claude-3-5-sonnet-20241022' }
                    );
                    console.log('[LLM] Anthropic configuration loaded and decrypted successfully');
                } else if (config.activeProvider === 'gemini' && config.gemini?.apiKey) {
                    const decryptedApiKey = await CleansheetCrypto.decrypt(config.gemini.apiKey);
                    currentProvider = new LLMProviders.GeminiProvider(
                        decryptedApiKey,
                        { model: config.gemini.model || 'gemini-2.0-flash-exp' }
                    );
                    console.log('[LLM] Gemini configuration loaded and decrypted successfully');
                }

                // Update provider badge
                updateProviderBadge();
            } catch (error) {
                console.error('[LLM] Failed to load LLM config:', error);
                // Clear invalid config
                localStorage.removeItem('llm_config_encrypted');
            }
        }

        // Open LLM settings modal
        // Populate usage stats for all providers
        function populateAllProviderUsageStats() {
            const usage = JSON.parse(localStorage.getItem('llm_usage') || '{}');
            const container = document.getElementById('usageStatsContainer');
            const statsSection = document.getElementById('llmUsageStats');

            if (!container) return;

            // Clear container
            container.innerHTML = '';

            // Provider display info
            const providerInfo = {
                openai: { name: 'OpenAI', color: '#10a37f', dashboardUrl: 'https://platform.openai.com/usage' },
                anthropic: { name: 'Claude', color: '#d97757', dashboardUrl: 'https://console.anthropic.com/settings/logs' },
                gemini: { name: 'Gemini', color: '#4285f4', dashboardUrl: 'https://aistudio.google.com/app/apikey' }
            };

            let hasAnyUsage = false;
            let totalMessages = 0;
            let totalTokens = 0;
            let totalCost = 0;

            // Create stats card for each provider with usage
            for (const provider in providerInfo) {
                if (usage[provider] && usage[provider].messages > 0) {
                    hasAnyUsage = true;
                    const info = providerInfo[provider];
                    const providerUsage = usage[provider];

                    totalMessages += providerUsage.messages || 0;
                    totalTokens += providerUsage.tokens || 0;
                    totalCost += providerUsage.cost || 0;

                    const card = document.createElement('div');
                    card.style.cssText = 'background: #f5f5f7; border-radius: 12px; padding: 16px; margin-bottom: 12px;';
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: ${info.color}; margin: 0;">
                                ${info.name}
                            </h4>
                            <a href="${info.dashboardUrl}" target="_blank" rel="noopener noreferrer"
                               style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; color: var(--color-primary-blue); font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; text-decoration: none; transition: all 0.2s;">
                                <i class="ph ph-arrow-square-out" style="font-size: 12px;"></i>
                                Dashboard
                            </a>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div>
                                <div style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Messages</div>
                                <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: ${info.color};">${providerUsage.messages || 0}</div>
                            </div>
                            <div>
                                <div style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Est. Tokens</div>
                                <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: ${info.color};">${(providerUsage.tokens || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Est. Cost</div>
                                <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: ${info.color};">$${(providerUsage.cost || 0).toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                }
            }

            // Show total if multiple providers have usage
            const providersWithUsage = Object.keys(providerInfo).filter(p => usage[p] && usage[p].messages > 0);
            if (providersWithUsage.length > 1) {
                const totalCard = document.createElement('div');
                totalCard.style.cssText = 'background: var(--color-primary-blue); border-radius: 12px; padding: 16px; margin-top: 4px;';
                totalCard.innerHTML = `
                    <h4 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: white; margin: 0 0 12px 0;">
                        Total (All Providers)
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div>
                            <div style="font-family: var(--font-family-body); font-size: 10px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Messages</div>
                            <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: white;">${totalMessages}</div>
                        </div>
                        <div>
                            <div style="font-family: var(--font-family-body); font-size: 10px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Est. Tokens</div>
                            <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: white;">${totalTokens.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="font-family: var(--font-family-body); font-size: 10px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Est. Cost</div>
                            <div style="font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: white;">$${totalCost.toFixed(2)}</div>
                        </div>
                    </div>
                `;
                container.appendChild(totalCard);
            }

            // Show/hide stats section based on whether there's any usage
            statsSection.style.display = hasAnyUsage ? 'block' : 'none';
        }

        async function openLLMSettingsModal() {
            const modal = document.getElementById('llmSettingsModal');
            modal.style.display = 'flex';

            // Load current configuration
            const config = JSON.parse(localStorage.getItem('llm_config_encrypted') || '{}');

            if (config.activeProvider) {
                document.getElementById('llmProviderSelect').value = config.activeProvider;
                handleProviderChange();
            }

            // Populate ALL provider fields that have keys stored (not just active provider)
            // This allows users to see and manage all configured providers

            if (config.openai?.apiKey) {
                try {
                    // Decrypt API key before displaying
                    const decryptedApiKey = await CleansheetCrypto.decrypt(config.openai.apiKey);
                    document.getElementById('openaiApiKey').value = decryptedApiKey;
                    document.getElementById('openaiModelSelect').value = config.openai?.model || 'gpt-4o';
                } catch (error) {
                    console.error('[LLM] Failed to decrypt OpenAI API key:', error);
                    // Clear invalid config
                    document.getElementById('openaiApiKey').value = '';
                }
            }

            if (config.anthropic?.apiKey) {
                try {
                    // Decrypt API key before displaying
                    const decryptedApiKey = await CleansheetCrypto.decrypt(config.anthropic.apiKey);
                    document.getElementById('anthropicApiKey').value = decryptedApiKey;
                    document.getElementById('anthropicModelSelect').value = config.anthropic?.model || 'claude-3-5-sonnet-20241022';
                } catch (error) {
                    console.error('[LLM] Failed to decrypt Anthropic API key:', error);
                    // Clear invalid config
                    document.getElementById('anthropicApiKey').value = '';
                }
            }

            if (config.gemini?.apiKey) {
                try {
                    // Decrypt API key before displaying
                    const decryptedApiKey = await CleansheetCrypto.decrypt(config.gemini.apiKey);
                    document.getElementById('geminiApiKey').value = decryptedApiKey;
                    document.getElementById('geminiModelSelect').value = config.gemini?.model || 'gemini-2.0-flash-exp';
                } catch (error) {
                    console.error('[LLM] Failed to decrypt Gemini API key:', error);
                    // Clear invalid config
                    document.getElementById('geminiApiKey').value = '';
                }
            }

            // Populate usage stats for ALL providers with usage data
            populateAllProviderUsageStats();

            // Load auto-execute setting (session-based, defaults to false)
            const autoExecuteCheckbox = document.getElementById('autoExecuteActions');
            if (autoExecuteCheckbox) {
                autoExecuteCheckbox.checked = autoExecuteActions;
            }
        }

        // Close LLM settings modal
        function closeLLMSettingsModal() {
            document.getElementById('llmSettingsModal').style.display = 'none';
        }

        // Handle provider selection change
        function handleProviderChange() {
            const provider = document.getElementById('llmProviderSelect').value;

            // Hide all provider configs
            document.getElementById('openaiConfig').style.display = 'none';
            document.getElementById('anthropicConfig').style.display = 'none';
            document.getElementById('geminiConfig').style.display = 'none';

            // Show/hide shared BYOK privacy info
            const byokInfo = document.getElementById('byokPrivacyInfo');
            if (provider && provider !== '') {
                byokInfo.style.display = 'block';
            } else {
                byokInfo.style.display = 'none';
            }

            // Show selected provider config
            if (provider === 'openai') {
                document.getElementById('openaiConfig').style.display = 'block';
            } else if (provider === 'anthropic') {
                document.getElementById('anthropicConfig').style.display = 'block';
            } else if (provider === 'gemini') {
                document.getElementById('geminiConfig').style.display = 'block';
            }
        }

        // Test OpenAI connection
        async function testOpenAIConnection() {
            const apiKey = document.getElementById('openaiApiKey').value.trim();
            const statusEl = document.getElementById('connectionStatus');

            if (!apiKey) {
                statusEl.textContent = '⚠️ Please enter an API key';
                statusEl.style.color = '#ea580c';
                return;
            }

            statusEl.textContent = '⏳ Testing connection...';
            statusEl.style.color = 'var(--color-neutral-text)';

            try {
                const provider = new LLMProviders.OpenAIProvider(apiKey);
                const result = await provider.validateApiKey();

                if (result.valid) {
                    statusEl.textContent = '✅ Connection successful!';
                    statusEl.style.color = '#16a34a';
                } else {
                    statusEl.textContent = `❌ ${result.error}`;
                    statusEl.style.color = '#dc2626';
                }
            } catch (error) {
                statusEl.textContent = `❌ ${error.message}`;
                statusEl.style.color = '#dc2626';
            }
        }

        // Test Gemini connection
        async function testGeminiConnection() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            const statusEl = document.getElementById('geminiConnectionStatus');

            if (!apiKey) {
                statusEl.textContent = '⚠️ Please enter an API key';
                statusEl.style.color = '#ea580c';
                return;
            }

            statusEl.textContent = '⏳ Testing connection...';
            statusEl.style.color = 'var(--color-neutral-text)';

            try {
                const provider = new LLMProviders.GeminiProvider(apiKey);
                const result = await provider.validateApiKey();

                if (result.valid) {
                    statusEl.textContent = '✅ Connection successful!';
                    statusEl.style.color = '#16a34a';
                } else {
                    statusEl.textContent = `❌ ${result.error}`;
                    statusEl.style.color = '#dc2626';
                }
            } catch (error) {
                statusEl.textContent = `❌ ${error.message}`;
                statusEl.style.color = '#dc2626';
            }
        }

        // Test Anthropic connection
        async function testAnthropicConnection() {
            const apiKey = document.getElementById('anthropicApiKey').value.trim();
            const statusEl = document.getElementById('anthropicConnectionStatus');

            if (!apiKey) {
                statusEl.textContent = '⚠️ Please enter an API key';
                statusEl.style.color = '#ea580c';
                return;
            }

            statusEl.textContent = '⏳ Testing connection...';
            statusEl.style.color = 'var(--color-neutral-text)';

            try {
                const provider = new LLMProviders.AnthropicProvider(apiKey);
                const result = await provider.validateApiKey();

                if (result.valid) {
                    statusEl.textContent = '✅ Connection successful!';
                    statusEl.style.color = '#16a34a';
                } else {
                    statusEl.textContent = `❌ ${result.error}`;
                    statusEl.style.color = '#dc2626';
                }
            } catch (error) {
                statusEl.textContent = `❌ ${error.message}`;
                statusEl.style.color = '#dc2626';
            }
        }

        // Save LLM settings
        async function saveLLMSettings() {
            const provider = document.getElementById('llmProviderSelect').value;

            if (!provider) {
                showToast('Please select a provider', 'error');
                return;
            }

            // Load existing config to preserve other providers
            const existingConfig = localStorage.getItem('llm_config_encrypted');
            const config = existingConfig ? JSON.parse(existingConfig) : {};

            // Update active provider
            config.activeProvider = provider;

            if (provider === 'openai') {
                const apiKey = document.getElementById('openaiApiKey').value.trim();
                const model = document.getElementById('openaiModelSelect').value;

                if (!apiKey) {
                    showToast('Please enter an API key', 'error');
                    return;
                }

                try {
                    // Encrypt API key before storing
                    const encryptedApiKey = await CleansheetCrypto.encrypt(apiKey);

                    config.openai = {
                        apiKey: encryptedApiKey,  // Encrypted
                        model: model
                    };

                    currentProvider = new LLMProviders.OpenAIProvider(apiKey, { model });
                    console.log('[LLM] API key encrypted and saved successfully');
                } catch (error) {
                    console.error('[LLM] Failed to encrypt API key:', error);
                    showToast('Failed to encrypt API key', 'error');
                    return;
                }
            } else if (provider === 'anthropic') {
                const apiKey = document.getElementById('anthropicApiKey').value.trim();
                const model = document.getElementById('anthropicModelSelect').value;

                if (!apiKey) {
                    showToast('Please enter an API key', 'error');
                    return;
                }

                try {
                    // Encrypt API key before storing
                    const encryptedApiKey = await CleansheetCrypto.encrypt(apiKey);

                    config.anthropic = {
                        apiKey: encryptedApiKey,  // Encrypted
                        model: model
                    };

                    currentProvider = new LLMProviders.AnthropicProvider(apiKey, { model });
                    console.log('[LLM] Anthropic API key encrypted and saved successfully');
                } catch (error) {
                    console.error('[LLM] Failed to encrypt Anthropic API key:', error);
                    showToast('Failed to encrypt API key', 'error');
                    return;
                }
            } else if (provider === 'gemini') {
                const apiKey = document.getElementById('geminiApiKey').value.trim();
                const model = document.getElementById('geminiModelSelect').value;

                if (!apiKey) {
                    showToast('Please enter an API key', 'error');
                    return;
                }

                try {
                    // Encrypt API key before storing
                    const encryptedApiKey = await CleansheetCrypto.encrypt(apiKey);

                    config.gemini = {
                        apiKey: encryptedApiKey,  // Encrypted
                        model: model
                    };

                    currentProvider = new LLMProviders.GeminiProvider(apiKey, { model });
                    console.log('[LLM] Gemini API key encrypted and saved successfully');
                } catch (error) {
                    console.error('[LLM] Failed to encrypt Gemini API key:', error);
                    showToast('Failed to encrypt API key', 'error');
                    return;
                }
            }

            // Save to localStorage
            localStorage.setItem('llm_config_encrypted', JSON.stringify(config));

            // Update UI
            document.getElementById('chatEmptyState').style.display = 'none';
            document.getElementById('chatInputContainer').style.display = 'block';

            // Update provider badge
            updateProviderBadge();

            closeLLMSettingsModal();
            showToast('AI Assistant configured!', 'success');
        }

        // Send chat message
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;
            if (!currentProvider) {
                showToast('Please configure AI Assistant first', 'error');
                openLLMSettingsModal();
                return;
            }

            // Clear input
            input.value = '';

            // Add user message to UI
            addMessageToUI('user', message);

            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });

            // Show typing indicator
            const typingId = addTypingIndicator();

            try {
                let assistantMessage = '';

                // Stream response
                await currentProvider.streamChat(
                    conversationHistory,
                    (chunk) => {
                        assistantMessage += chunk;
                        updateStreamingMessage(typingId, assistantMessage);
                    }
                );

                // Remove typing indicator
                removeTypingIndicator(typingId);

                // Add complete message to conversation history
                conversationHistory.push({ role: 'assistant', content: assistantMessage });

                // Track usage with actual provider name
                const providerName = currentProvider.getName().toLowerCase();
                trackLLMUsage(providerName, assistantMessage);

            } catch (error) {
                removeTypingIndicator(typingId);
                addMessageToUI('system', `Error: ${error.message}`);
                console.error('LLM chat error:', error);
            }
        }

        // Add message to UI
        function addMessageToUI(role, content) {
            const messagesContainer = document.getElementById('chatMessages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'chat-message-avatar';
            avatarDiv.innerHTML = role === 'user' ? '<i class="ph ph-user"></i>' :
                                  role === 'assistant' ? '<i class="ph ph-robot"></i>' :
                                  '<i class="ph ph-warning"></i>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';
            contentDiv.textContent = content;

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add typing indicator
        function addTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const id = 'typing-' + Date.now();

            const messageDiv = document.createElement('div');
            messageDiv.id = id;
            messageDiv.className = 'chat-message assistant';
            messageDiv.innerHTML = `
                <div class="chat-message-avatar">
                    <i class="ph ph-robot"></i>
                </div>
                <div class="chat-message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return id;
        }

        // Update streaming message
        function updateStreamingMessage(typingId, content) {
            const messageEl = document.getElementById(typingId);
            if (!messageEl) {
                // Create new message element
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.id = typingId;
                messageDiv.className = 'chat-message assistant';
                messageDiv.innerHTML = `
                    <div class="chat-message-avatar">
                        <i class="ph ph-robot"></i>
                    </div>
                    <div class="chat-message-content">${content}</div>
                `;
                messagesContainer.appendChild(messageDiv);
            } else {
                // Update existing typing indicator with content
                const contentDiv = messageEl.querySelector('.chat-message-content');
                contentDiv.textContent = content;
            }

            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator(typingId) {
            const messageEl = document.getElementById(typingId);
            if (messageEl) {
                messageEl.removeAttribute('id'); // Keep the message, just remove the ID
            }
        }

        // Handle Enter key in chat input
        function handleChatInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Track LLM usage (informational only)
        function trackLLMUsage(provider, response) {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const usage = JSON.parse(localStorage.getItem('llm_usage') || '{}');

            if (usage.month !== currentMonth) {
                usage.month = currentMonth;
                usage[provider] = { messages: 0, tokens: 0, cost: 0 };
            }

            if (!usage[provider]) {
                usage[provider] = { messages: 0, tokens: 0, cost: 0 };
            }

            // Increment message count
            usage[provider].messages++;

            // Estimate tokens (rough: ~4 chars per token)
            const estimatedTokens = Math.ceil(response.length / 4);
            usage[provider].tokens += estimatedTokens;

            // Estimate cost (OpenAI GPT-4o: $0.005 per 1k tokens output)
            const costPer1k = 0.005;
            usage[provider].cost += (estimatedTokens / 1000) * costPer1k;

            localStorage.setItem('llm_usage', JSON.stringify(usage));
        }

        // ============================================
        // Canvas Interaction API for LLM
        // ============================================

        // Get current canvas state for LLM context
        function getCanvasContext() {
            const context = {
                viewMode: currentViewMode,
                persona: currentPersona,
                activeTab: document.querySelector('.canvas-tab.active')?.dataset.tab || 'home',
                canvasVisible: document.getElementById('canvasModal')?.classList.contains('active') || false
            };

            // Safely access data arrays from localStorage or global scope
            // These might not be in scope, so we read directly from localStorage

            // Job Opportunities
            try {
                const jobs = typeof userJobs !== 'undefined' ? userJobs :
                    JSON.parse(localStorage.getItem('cleansheet_jobs') || '[]');

                if (jobs && jobs.length > 0) {
                    context.jobOpportunities = jobs.map(j => ({
                        id: j.id,
                        title: j.title || 'Untitled',
                        company: j.company || 'Unknown Company',
                        status: j.status || 'active',
                        dateApplied: j.dateApplied || null
                    }));
                } else {
                    context.jobOpportunities = [];
                }
            } catch (e) {
                console.warn('[Canvas Context] Error loading jobs:', e);
                context.jobOpportunities = [];
            }

            // Experiences (FULL proof chain context)
            try {
                const experiences = typeof userExperiences !== 'undefined' ? userExperiences :
                    JSON.parse(localStorage.getItem('cleansheet_experiences') || '[]');

                if (experiences && experiences.length > 0) {
                    context.experiences = experiences.map(e => ({
                        id: e.id,
                        role: e.role || e.title || 'Untitled',
                        company: e.organizationName || e.company || 'Unknown',
                        location: e.location || null,
                        startDate: e.startDate || null,
                        endDate: e.endDate || null,
                        isCurrent: e.endDate === 'Present' || !e.endDate,
                        description: e.description || null,
                        // Proof chain elements - critical for skill/achievement tracking
                        technologies: e.technologies || [],      // Array of {name, type} or strings
                        keySkills: e.keySkills || [],            // Array of soft/professional skills
                        competencies: e.competencies || [],      // Array of competency areas
                        achievements: e.achievements || []       // Array of measurable accomplishments
                    }));
                } else {
                    context.experiences = [];
                }
            } catch (e) {
                console.warn('[Canvas Context] Error loading experiences:', e);
                context.experiences = [];
            }

            // Goals
            try {
                const goals = typeof userGoals !== 'undefined' ? userGoals :
                    JSON.parse(localStorage.getItem('cleansheet_goals') || '[]');

                if (goals && goals.length > 0) {
                    context.goals = goals.map(g => ({
                        id: g.id,
                        title: g.title || 'Untitled',
                        status: g.status || 'active',
                        targetDate: g.targetDate || null
                    }));
                } else {
                    context.goals = [];
                }
            } catch (e) {
                console.warn('[Canvas Context] Error loading goals:', e);
                context.goals = [];
            }

            // Stories/Portfolio (STAR format - critical proof chain elements)
            try {
                // Try multiple storage keys for compatibility
                let stories = typeof allStories !== 'undefined' ? allStories : null;

                if (!stories) {
                    const storiesData = localStorage.getItem('cleansheet_stories') ||
                                       localStorage.getItem('userStories') ||
                                       localStorage.getItem('behavioralStories') ||
                                       localStorage.getItem('user_stories');
                    stories = storiesData ? JSON.parse(storiesData) : [];
                }

                if (stories && stories.length > 0) {
                    context.stories = stories.map((s, index) => ({
                        id: s.id || index,
                        title: s.title || 'Untitled Story',
                        linkedExperience: s.experience || s.experienceName || null,
                        // STAR format - essential proof elements
                        situation: s.situation || null,
                        task: s.task || null,
                        action: s.action || null,
                        result: s.result || null,
                        competencies: s.competencies || [],
                        createdAt: s.createdAt || null,
                        updatedAt: s.updatedAt || null
                    }));
                } else {
                    context.stories = [];
                }
            } catch (e) {
                console.warn('[Canvas Context] Error loading stories:', e);
                context.stories = [];
            }

            // Counts for quick reference
            context.counts = {
                jobs: context.jobOpportunities.length,
                activeJobs: context.jobOpportunities.filter(j => j.status !== 'rejected' && j.status !== 'not-interesting').length,
                experiences: context.experiences.length,
                goals: context.goals.length,
                stories: context.stories.length
            };

            // Bookmarks for learner view
            try {
                if (currentViewMode === 'learner') {
                    const bookmarks = typeof userBookmarks !== 'undefined' ? userBookmarks :
                        JSON.parse(localStorage.getItem('cleansheet_bookmarks') || '[]');
                    context.bookmarks = {
                        total: bookmarks.length || 0
                    };
                }
            } catch (e) {
                console.warn('[Canvas Context] Error loading bookmarks:', e);
            }

            return context;
        }

        // System prompt with canvas interaction capabilities
        const CANVAS_SYSTEM_PROMPT = `You are an AI assistant for Career Canvas, a career management platform.

CONTEXT PROVIDED TO YOU:
With each user message, you receive comprehensive structured data including:

**Job Opportunities:** id, title, company, status, dateApplied

**Experiences (FULL PROOF CHAIN):**
- Basic: id, role, company, location, dates, description
- Technologies: Array of technical skills/tools (e.g., Python, Excel, AWS) with proficiency levels
- Key Skills: Array of soft/professional skills (e.g., Leadership, Communication)
- Competencies: Array of competency areas (e.g., Project Management, Data Analysis)
- Achievements: Array of measurable accomplishments and outcomes

**Portfolio Stories (STAR FORMAT):**
- Title and linked experience
- Situation: Context and background
- Task: Objective and challenge
- Action: Specific steps taken
- Result: Measurable outcomes
- Competencies demonstrated

**Goals:** id, title, status, targetDate

**Summary Counts:** Quick reference for all categories

This context is COMPLETE and ACCURATE. Trust this data - don't assume or hallucinate information.

IMPORTANT: When asked about skills or experience with specific technologies (e.g., "How many years of Excel experience?"),
scan through ALL experiences and their technologies arrays to calculate accurate totals based on date ranges.

AVAILABLE ACTIONS (use sparingly):
You can include actions in your responses using JSON code blocks:
\`\`\`json
{
  "action": "navigate",
  "params": {"view": "learner"}
}
\`\`\`

Action types:
- navigate: Switch views ONLY if user explicitly requests it {"view": "seeker"|"learner"}
  * "seeker" = Job search view (job opportunities, applications, interview prep)
  * "learner" = Learning view (goals, portfolio, skill development)
  * Note: Other views are not yet implemented and will be blocked
- showToast: Display brief notifications {"message": "text", "type": "success"|"info"|"error"}
- openModal: Open forms ONLY when user asks to create something {"modal": "addJob"|"addExperience"|"addStory"|"addGoal"|"addDocument"}

CRITICAL GUIDELINES:
1. Answer questions using the context data provided - it contains everything you need
2. Only execute actions (navigate, openModal) when the user explicitly requests them
3. Don't navigate between views unless the user uses words like "switch to", "show me", "go to"
4. If you lack information to answer, ask clarifying questions - don't guess
5. Focus on providing advice and answering questions rather than taking actions
6. Be conversational and helpful, but don't proactively manipulate the interface

Your role is to assist with career advice and answer questions about the user's canvas data.`;

        // Enhanced sendChatMessage with canvas context
        const originalSendChatMessage = sendChatMessage;
        sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;
            if (!currentProvider) {
                showToast('Please configure AI Assistant first', 'error');
                openLLMSettingsModal();
                return;
            }

            // Clear input
            input.value = '';

            // Add user message to UI
            addMessageToUI('user', message);

            // Inject canvas context into conversation
            const canvasContext = getCanvasContext();

            // Format context as structured JSON for LLM
            const contextMessage = `[CANVAS CONTEXT]
${JSON.stringify(canvasContext, null, 2)}
[END CONTEXT]`;

            // Build messages array with system prompt and context
            const messages = [
                { role: 'system', content: CANVAS_SYSTEM_PROMPT }
            ];

            // Add conversation history (skip old system prompts)
            messages.push(...conversationHistory.filter(m => m.role !== 'system'));

            // Add current user message with context
            messages.push({ role: 'user', content: `${contextMessage}\n\n${message}` });

            // Update conversation history (without system prompt)
            conversationHistory.push({ role: 'user', content: message });

            // Show typing indicator
            const typingId = addTypingIndicator();

            try {
                let assistantMessage = '';

                // Stream response
                await currentProvider.streamChat(
                    messages,
                    (chunk) => {
                        assistantMessage += chunk;
                        updateStreamingMessage(typingId, assistantMessage);
                    }
                );

                // Remove typing indicator
                removeTypingIndicator(typingId);

                // Add complete message to conversation history
                conversationHistory.push({ role: 'assistant', content: assistantMessage });

                // Parse and execute any actions in the response
                await executeCanvasActions(assistantMessage);

                // Track usage with actual provider name
                const providerName = currentProvider.getName().toLowerCase();
                trackLLMUsage(providerName, assistantMessage);

            } catch (error) {
                removeTypingIndicator(typingId);
                addMessageToUI('system', `Error: ${error.message}`);
                console.error('LLM chat error:', error);
            }
        };

        // Validate if an action should be executed based on context and user intent
        function canExecuteAction(actionType, params, currentContext) {
            console.log('[Action Guard] Validating action:', actionType, params);

            if (actionType === 'navigate') {
                // Check if target view is valid
                const validViews = ['seeker', 'learner'];
                if (!validViews.includes(params.view)) {
                    console.warn('[Action Guard] BLOCKED - Invalid view:', params.view, '(only seeker and learner are implemented)');
                    addMessageToUI('system', `⚠ Navigation to "${params.view}" is not available. Valid views: seeker, learner`);
                    return false;
                }

                // Don't navigate if already in the requested view
                if (currentContext.viewMode === params.view) {
                    console.warn('[Action Guard] BLOCKED - Already in requested view:', params.view);
                    addMessageToUI('system', `ℹ Already in ${params.view} view`);
                    return false;
                }

                // Check last user message for explicit navigation intent
                const lastUserMessage = conversationHistory.length > 0
                    ? conversationHistory[conversationHistory.length - 1].content.toLowerCase()
                    : '';
                const navigationKeywords = ['switch', 'show me', 'go to', 'navigate', 'open', 'view', 'take me to', 'move to'];
                const hasNavigationIntent = navigationKeywords.some(kw => lastUserMessage.includes(kw));

                if (!hasNavigationIntent) {
                    console.warn('[Action Guard] BLOCKED - No explicit navigation intent in user message');
                    addMessageToUI('system', `ℹ Navigation requires explicit user request (use words like "switch to" or "show me")`);
                    return false;
                }

                console.log('[Action Guard] APPROVED - Navigation to:', params.view);
                return true;
            }

            if (actionType === 'openModal') {
                // Check if modal function exists
                const modalFunctions = {
                    'addJob': 'addJobOpportunity',
                    'addExperience': 'showExperienceForm',
                    'addStory': 'showStoryForm',
                    'addGoal': 'showGoalForm',
                    'addDocument': 'showDocumentForm'
                };

                const functionName = modalFunctions[params.modal];
                if (!functionName || typeof window[functionName] !== 'function') {
                    console.warn('[Action Guard] BLOCKED - Modal function not available:', params.modal);
                    addMessageToUI('system', `⚠ Cannot open "${params.modal}" - function not available`);
                    return false;
                }

                console.log('[Action Guard] APPROVED - Open modal:', params.modal);
                return true;
            }

            // Allow showToast actions (minimal risk)
            if (actionType === 'showToast') {
                return true;
            }

            console.log('[Action Guard] APPROVED - Action type:', actionType);
            return true;
        }

        // Parse and execute canvas actions from LLM response
        async function executeCanvasActions(message) {
            console.log('[Canvas Action] Parsing message for actions...');

            // Look for JSON code blocks with actions (more flexible regex)
            const jsonBlockRegex = /```json\s*([\s\S]*?)```/g;
            let match;
            let foundActions = false;

            while ((match = jsonBlockRegex.exec(message)) !== null) {
                try {
                    const jsonText = match[1].trim();
                    console.log('[Canvas Action] Found JSON block:', jsonText);

                    const actionData = JSON.parse(jsonText);

                    if (actionData.action) {
                        foundActions = true;
                        console.log('[Canvas Action] Executing:', actionData.action, actionData.params);

                        // Get current context for validation
                        const currentContext = getCanvasContext();

                        // Validate action before executing
                        if (!canExecuteAction(actionData.action, actionData.params || {}, currentContext)) {
                            console.warn('[Canvas Action] Action blocked by guard');
                            continue; // Skip this action and continue with next
                        }

                        switch (actionData.action) {
                            case 'navigate':
                                if (actionData.params?.view) {
                                    console.log('[Canvas Action] Navigating to:', actionData.params.view);
                                    // Use switchViewMode function for proper view switching
                                    try {
                                        switchViewMode(actionData.params.view);
                                        addMessageToUI('system', `✓ Switched to ${actionData.params.view} view`);
                                        showToast(`Switched to ${actionData.params.view} view`, 'success');
                                    } catch (error) {
                                        console.error('[Canvas Action] Navigation failed:', error);
                                        addMessageToUI('system', `✗ Failed to switch view: ${error.message}`);
                                    }
                                }
                                break;

                            case 'showToast':
                                if (actionData.params?.message) {
                                    const type = actionData.params.type || 'info';
                                    showToast(actionData.params.message, type);
                                }
                                break;

                            case 'openModal':
                                if (actionData.params?.modal) {
                                    console.log('[Canvas Action] Opening modal:', actionData.params.modal);
                                    try {
                                        switch (actionData.params.modal) {
                                            case 'addJob':
                                                if (typeof addJobOpportunity === 'function') {
                                                    addJobOpportunity();
                                                    addMessageToUI('system', `✓ Opened add job modal`);
                                                    showToast('Add Job modal opened', 'success');
                                                } else {
                                                    throw new Error('addJobOpportunity function not found');
                                                }
                                                break;

                                            case 'addExperience':
                                                if (typeof showExperienceForm === 'function') {
                                                    showExperienceForm();
                                                    addMessageToUI('system', `✓ Opened add experience form`);
                                                    showToast('Add Experience form opened', 'success');
                                                } else {
                                                    throw new Error('showExperienceForm function not found');
                                                }
                                                break;

                                            case 'addStory':
                                                if (typeof showStoryForm === 'function') {
                                                    showStoryForm();
                                                    addMessageToUI('system', `✓ Opened add story form`);
                                                    showToast('Add Story form opened', 'success');
                                                } else {
                                                    throw new Error('showStoryForm function not found');
                                                }
                                                break;

                                            default:
                                                console.warn('[Canvas Action] Unknown modal:', actionData.params.modal);
                                                addMessageToUI('system', `✗ Unknown modal: ${actionData.params.modal}`);
                                        }
                                    } catch (error) {
                                        console.error('[Canvas Action] Failed to open modal:', error);
                                        addMessageToUI('system', `✗ Failed to open modal: ${error.message}`);
                                    }
                                }
                                break;

                            default:
                                console.warn('[Canvas Action] Unknown action:', actionData.action);
                        }
                    }
                } catch (error) {
                    console.error('[Canvas Action] Failed to parse action:', error, 'JSON text:', match[1]);
                }
            }

            if (!foundActions) {
                console.log('[Canvas Action] No actions found in message');
            }
        }

        // ============================================
        // End Canvas Interaction API
        // ============================================

        // ============================================
        // End LLM Integration Functions
        // ============================================

        // Canvas Modal Functions
        function showPremiumAlert(featureName, description) {
            alert(`${featureName} (Premium Feature)\n\n${description}\n\nUpgrade to premium to unlock this feature.`);
        }

        function openCanvasModal() {
            document.getElementById('canvasModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Restore left panel collapsed/expanded state
            restoreLeftPanelState();

            // Initialize left panel user name and status bar
            updateLeftPanelUserName();
            updateLeftPanelStatusBar();

            // Initialize LLM system (wrapped in try-catch to prevent blocking mindmap)
            try {
                initializeLLM();
            } catch (error) {
                console.error('[LLM Init] Error initializing LLM:', error);
            }

            // FIXED: Load all user data and counts BEFORE initializing mindmap
            console.log('[Canvas Init] Loading user data and counts first...');

            // Load job opportunities and get count
            loadUserJobs();
            const activeJobsCount = userJobs.filter(job =>
                job.status !== 'rejected' && job.status !== 'not-interested'
            ).length;

            // Load all user data
            loadStories();
            loadUserExperiences();
            loadUserGoals();
            loadUserPortfolio();

            // Update all counts in personaData BEFORE rendering mindmap
            let allStories = [];
            try {
                allStories = JSON.parse(localStorage.getItem('userStories') || '[]');
            } catch(e) {
                console.warn('[Canvas Init] Invalid userStories JSON, using empty array');
            }

            const storedExperiences = localStorage.getItem('cleansheet_experiences');
            let experiencesCount = 0;
            try {
                experiencesCount = storedExperiences ? JSON.parse(storedExperiences).length : 0;
            } catch(e) {
                console.warn('[Canvas Init] Invalid cleansheet_experiences JSON, count = 0');
            }

            console.log('[Canvas Init] Counts before mindmap:', {
                jobs: activeJobsCount,
                stories: allStories.length,
                experiences: experiencesCount,
                goals: userGoals.length,
                portfolio: userPortfolioProjects.length
            });

            // Update counts in personaData structure
            if (personaData[currentPersona] && personaData[currentPersona].children) {
                personaData[currentPersona].children.forEach(child => {
                    switch(child.name) {
                        case 'Job Opportunities':
                            child.count = activeJobsCount;
                            break;
                        case 'Interview Prep':
                            child.count = allStories.length;
                            break;
                        case 'Career Experience':
                            child.count = experiencesCount;
                            break;
                        case 'Goals':
                            child.count = userGoals.length;
                            break;
                        case 'Portfolio':
                            child.count = userPortfolioProjects.length;
                            break;
                    }
                });
            }

            // Initialize demo data
            initializeDemoDocuments();
            initializeDemoForms();
            initializeDemoTableRelationships();

            // Update feature visibility on modal open
            updateFeatureVisibility();

            // Add click-outside-to-close handler for slideout
            const slideout = document.getElementById('interviewSlideout');
            slideout.addEventListener('click', function(event) {
                // Close if clicking on the slideout background (not the content)
                if (event.target === slideout) {
                    closeInterviewSlideout();
                }
            });

            // FIXED: Initialize mindmap with correct counts (no timeout needed)
            console.log('[Canvas Init] Initializing mindmap with pre-loaded counts...');
            initializeMindmap(currentPersona);
        }

        function closeCanvasModal() {
            document.getElementById('canvasModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            // Clear the mindmap
            d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();
        }

        // Projects View Functions
        let projectFolders = [];
        let currentFolderId = null;

        function showProjectsView() {
            // Hide mindmap and other views, show projects view
            document.getElementById('canvas-mindmap').style.display = 'none';
            document.getElementById('projects-view').style.display = 'flex';

            // Load project structure
            loadProjectStructure();
            renderFolderTree();
            navigateToFolder(null); // Show root level
        }

        function loadProjectStructure() {
            const saved = localStorage.getItem('projectFolders');
            if (saved) {
                projectFolders = JSON.parse(saved);
            } else {
                // Initialize with demo structure
                projectFolders = [
                    {
                        id: 'acme-corp',
                        name: 'Acme Corporation',
                        type: 'folder',
                        parentId: null,
                        created: new Date('2025-09-15').toISOString(),
                        modified: new Date('2025-10-06').toISOString(),
                        sharedWith: ['AM', 'JS']
                    },
                    {
                        id: 'vendors',
                        name: 'Vendors',
                        type: 'folder',
                        parentId: null,
                        created: new Date('2025-09-20').toISOString(),
                        modified: new Date('2025-10-05').toISOString(),
                        sharedWith: ['AM']
                    },
                    {
                        id: 'acme-docs',
                        name: 'Q4 Proposal',
                        type: 'document',
                        parentId: 'acme-corp',
                        created: new Date('2025-10-01').toISOString(),
                        modified: new Date('2025-10-05').toISOString(),
                        sharedWith: ['AM', 'JS', 'TR']
                    },
                    {
                        id: 'acme-table',
                        name: 'Customer Contacts',
                        type: 'table',
                        parentId: 'acme-corp',
                        created: new Date('2025-09-20').toISOString(),
                        modified: new Date('2025-10-06').toISOString(),
                        sharedWith: ['AM', 'JS']
                    },
                    {
                        id: 'acme-report',
                        name: 'Sales Dashboard',
                        type: 'report',
                        parentId: 'acme-corp',
                        created: new Date('2025-10-03').toISOString(),
                        modified: new Date('2025-10-06').toISOString(),
                        sharedWith: ['AM']
                    },
                    {
                        id: 'vendor-form',
                        name: 'Vendor Information Form',
                        type: 'form',
                        parentId: 'vendors',
                        created: new Date('2025-09-28').toISOString(),
                        modified: new Date('2025-09-28').toISOString(),
                        sharedWith: []
                    }
                ];
                saveProjectStructure();
            }
        }

        function saveProjectStructure() {
            localStorage.setItem('projectFolders', JSON.stringify(projectFolders));
        }

        function renderFolderTree() {
            const container = document.getElementById('folderTree');
            const rootFolders = projectFolders.filter(item => item.parentId === null && item.type === 'folder');

            let html = renderFolderTreeLevel(rootFolders, 0);
            container.innerHTML = html;
        }

        function renderFolderTreeLevel(folders, depth) {
            let html = '';
            folders.forEach(folder => {
                const indent = depth * 16;
                const isActive = currentFolderId === folder.id;
                const children = projectFolders.filter(item => item.parentId === folder.id && item.type === 'folder');

                html += `
                    <div style="margin-bottom: 4px;">
                        <div onclick="navigateToFolder('${folder.id}')" style="padding: 8px; padding-left: ${indent + 8}px; cursor: pointer; border-radius: 4px; background: ${isActive ? '#e3f2fd' : 'transparent'}; color: ${isActive ? 'var(--color-primary-blue)' : 'var(--color-dark)'}; display: flex; align-items: center; gap: 8px; transition: background 0.2s;" onmouseover="if(!this.style.background.includes('e3f2fd')) this.style.background='#f8f9fa'" onmouseout="if(!this.style.background.includes('e3f2fd')) this.style.background='transparent'">
                            <i class="ph ph-folder" style="font-size: 16px;"></i>
                            <span style="flex: 1; font-weight: ${isActive ? '600' : '400'};">${folder.name}</span>
                        </div>
                        ${children.length > 0 ? renderFolderTreeLevel(children, depth + 1) : ''}
                    </div>
                `;
            });
            return html;
        }

        function navigateToFolder(folderId) {
            currentFolderId = folderId;
            renderFolderTree();
            renderBreadcrumb();
            renderFileTable();
        }

        function renderBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');

            if (currentFolderId === null) {
                breadcrumb.innerHTML = '<i class="ph ph-house" style="font-size: 16px;"></i> <span style="font-weight: 600;">All Projects</span>';
                return;
            }

            const path = [];
            let folder = projectFolders.find(f => f.id === currentFolderId);
            while (folder) {
                path.unshift(folder);
                folder = projectFolders.find(f => f.id === folder.parentId);
            }

            let html = '<span onclick="navigateToFolder(null)" style="cursor: pointer; color: var(--color-primary-blue);"><i class="ph ph-house" style="font-size: 16px;"></i></span>';
            path.forEach((item, index) => {
                html += ' <i class="ph ph-caret-right" style="font-size: 12px; color: var(--color-neutral-text-muted);"></i> ';
                if (index === path.length - 1) {
                    html += `<span style="font-weight: 600;">${item.name}</span>`;
                } else {
                    html += `<span onclick="navigateToFolder('${item.id}')" style="cursor: pointer; color: var(--color-primary-blue);">${item.name}</span>`;
                }
            });

            breadcrumb.innerHTML = html;
        }

        function renderFileTable() {
            const tbody = document.getElementById('fileTableBody');
            const items = projectFolders.filter(item => item.parentId === currentFolderId);

            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 40px; text-align: center; color: var(--color-neutral-text-muted);">
                            <i class="ph ph-folder-open" style="font-size: 48px; margin-bottom: 8px;"></i>
                            <p>This folder is empty</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            items.forEach(item => {
                const icon = getItemIcon(item.type);
                const typeName = item.type.charAt(0).toUpperCase() + item.type.slice(1);
                const createdDate = new Date(item.created).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const modifiedDate = new Date(item.modified).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const sharedAvatars = item.sharedWith.map(initials =>
                    `<div style="width: 24px; height: 24px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: var(--color-primary-blue);">${initials}</div>`
                ).join('');

                html += `
                    <tr style="border-bottom: 1px solid var(--color-neutral-border); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="${item.type === 'folder' ? `navigateToFolder('${item.id}')` : `openProjectItem('${item.id}')`}">
                        <td style="padding: 12px 16px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="ph ${icon}" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                <span style="font-weight: 500; color: var(--color-dark);">${item.name}</span>
                            </div>
                        </td>
                        <td style="padding: 12px 16px; color: var(--color-neutral-text);">
                            ${typeName}
                        </td>
                        <td style="padding: 12px 16px; color: var(--color-neutral-text);">
                            ${createdDate}
                        </td>
                        <td style="padding: 12px 16px; color: var(--color-neutral-text);">
                            ${modifiedDate}
                        </td>
                        <td style="padding: 12px 16px;">
                            <div style="display: flex; gap: 4px; align-items: center;">
                                ${sharedAvatars}
                                ${item.sharedWith.length === 0 ? '<span style="color: var(--color-neutral-text-muted); font-size: 12px;">—</span>' : ''}
                            </div>
                        </td>
                        <td style="padding: 12px 16px;">
                            <div style="display: flex; gap: 4px;">
                                <button onclick="event.stopPropagation(); deleteProjectItem('${item.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;" title="Delete">
                                    <i class="ph ph-trash" style="font-size: 14px; color: #dc2626;"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function getItemIcon(type) {
            const icons = {
                'folder': 'ph-folder',
                'document': 'ph-file-text',
                'table': 'ph-table',
                'form': 'ph-note-pencil',
                'report': 'ph-chart-line',
                'template': 'ph-file-doc',
                'workflow': 'ph-flow-arrow'
            };
            return icons[type] || 'ph-file';
        }

        function createNewFolder() {
            const folderName = prompt('Enter folder name:');
            if (!folderName) return;

            const newFolder = {
                id: Date.now().toString(),
                name: folderName,
                type: 'folder',
                parentId: currentFolderId,
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                sharedWith: []
            };

            projectFolders.push(newFolder);
            saveProjectStructure();
            renderFolderTree();
            renderFileTable();
        }

        function addItemToCurrentFolder() {
            alert('Add Item functionality coming soon! This will allow you to link existing documents, tables, forms, reports, templates, and workflows to this folder.');
        }

        function deleteProjectItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            // Remove item and all its children recursively
            function removeItemAndChildren(id) {
                const children = projectFolders.filter(item => item.parentId === id);
                children.forEach(child => removeItemAndChildren(child.id));
                projectFolders = projectFolders.filter(item => item.id !== id);
            }

            removeItemAndChildren(itemId);
            saveProjectStructure();
            renderFolderTree();
            renderFileTable();
        }

        function openProjectItem(itemId) {
            const item = projectFolders.find(f => f.id === itemId);
            if (!item) return;

            alert(`Open ${item.type}: ${item.name}\n\nFunctionality coming soon to open the actual ${item.type} editor!`);
        }

        function toggleIntegrationSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const caret = document.getElementById(`${sectionId}-caret`);

            if (content.style.display === 'none' || content.style.display === '') {
                // Open section
                content.style.display = 'block';
                caret.style.transform = 'rotate(180deg)';
            } else {
                // Close section
                content.style.display = 'none';
                caret.style.transform = 'rotate(0deg)';
            }
        }

        function toggleIntegrationCategory(categoryId) {
            const content = document.getElementById(`${categoryId}-category-content`);
            const caret = document.getElementById(`${categoryId}-category-caret`);

            if (content.style.display === 'none' || content.style.display === '') {
                // Open category
                content.style.display = 'block';
                caret.style.transform = 'rotate(180deg)';
            } else {
                // Close category
                content.style.display = 'none';
                caret.style.transform = 'rotate(0deg)';
            }
        }

        function toggleCleansheetAI() {
            const toggle = document.getElementById('cleansheetAiToggle');
            const brokerSection = document.getElementById('aiBrokerSection');
            const aiBox = document.getElementById('cleansheetAiBox');

            if (toggle.checked) {
                // Show AI Broker selection and highlight the box
                brokerSection.style.display = 'block';
                aiBox.style.background = '#e3f2fd';
                aiBox.style.borderColor = 'var(--color-primary-blue)';
                aiBox.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.2)';
            } else {
                // Hide AI Broker selection and remove highlight
                brokerSection.style.display = 'none';
                aiBox.style.background = 'white';
                aiBox.style.borderColor = 'var(--color-neutral-border)';
                aiBox.style.boxShadow = 'none';
            }
        }

        function updateNodeCounts() {
            // Redraw the visualization to update counts
            d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();
            if (currentViewMode === 'learner') {
                initializeLearnerNetwork(currentPersona);
            } else {
                initializeMindmap(currentPersona);
            }
        }

        // NEW: Selective badge update function - no full re-rendering
        function updateBadgesOnly() {
            console.log('[D3 Badges] updateBadgesOnly called for persona:', currentPersona);

            // Skip if no mindmap is currently rendered
            if (d3.select('#canvas-mindmap svg').empty()) {
                console.log('[D3 Badges] No mindmap rendered, skipping badge update');
                return;
            }

            // Load current counts from localStorage
            const storedGoals = localStorage.getItem(`userGoals_${currentPersona}`);
            const goalsCount = storedGoals ? JSON.parse(storedGoals).length : 0;

            const storedPortfolio = localStorage.getItem(`userPortfolio_${currentPersona}`);
            const portfolioCount = storedPortfolio ? JSON.parse(storedPortfolio).length : 0;

            const storedJobs = localStorage.getItem('jobOpportunities_' + currentPersona);
            const jobsCount = storedJobs ? JSON.parse(storedJobs).filter(job =>
                job.status !== 'rejected' && job.status !== 'not-interested'
            ).length : 0;

            const storedExperiences = localStorage.getItem('cleansheet_experiences');
            const experiencesCount = storedExperiences ? JSON.parse(storedExperiences).length : 0;

            // FIXED: Use same fallback pattern as rest of app for stories
            let storiesData = localStorage.getItem('cleansheet_stories');
            if (!storiesData) {
                storiesData = localStorage.getItem('behavioralStories');
            }
            const allStories = storiesData ? JSON.parse(storiesData) : [];
            const storiesCount = allStories.length;

            // Update counts in personaData structure
            if (personaData[currentPersona] && personaData[currentPersona].children) {
                personaData[currentPersona].children.forEach(child => {
                    switch(child.name) {
                        case 'Goals':
                            child.count = goalsCount;
                            break;
                        case 'Portfolio':
                            child.count = portfolioCount;
                            break;
                        case 'Job Opportunities':
                            child.count = jobsCount;
                            break;
                        case 'Career Experience':
                            child.count = experiencesCount;
                            break;
                        case 'Interview Prep':
                            child.count = storiesCount;
                            break;
                    }
                });
            }

            // Update badges for each target node
            const targetNodes = ['Goals', 'Portfolio', 'Job Opportunities', 'Career Experience', 'Interview Prep'];
            const countMap = {
                'Goals': goalsCount,
                'Portfolio': portfolioCount,
                'Job Opportunities': jobsCount,
                'Career Experience': experiencesCount,
                'Interview Prep': storiesCount
            };

            targetNodes.forEach(nodeName => {
                const count = countMap[nodeName];
                console.log(`[D3 Badges] Updating ${nodeName}: ${count}`);

                // Find the node element
                const nodeElements = d3.select('#canvas-mindmap')
                    .selectAll('.mindmap-node')
                    .filter(function(d) {
                        return d && d.data && d.data.name === nodeName;
                    });

                nodeElements.each(function(d) {
                    const nodeGroup = d3.select(this);
                    const existingBadge = nodeGroup.select('.count-badge');

                    if (count > 0) {
                        // Create or update badge
                        if (existingBadge.empty()) {
                            // Create new badge
                            console.log(`[D3 Badges] Creating new badge for ${nodeName} with count ${count}`);

                            const countText = count.toString();
                            const badgeWidth = countText.length === 1 ? 18 : (countText.length === 2 ? 22 : 26);
                            const badgeHeight = 18;
                            const xOffset = d.data.premium ? -42 : -10;

                            const countBadge = nodeGroup.append('g')
                                .attr('class', 'count-badge')
                                .attr('transform', `translate(${180/2 - badgeWidth + xOffset}, ${-50/2 + 5})`);

                            // Background rect
                            countBadge.append('rect')
                                .attr('width', badgeWidth)
                                .attr('height', badgeHeight)
                                .attr('rx', 9)
                                .style('fill', '#0066CC')
                                .style('stroke', 'white')
                                .style('stroke-width', '1.5px');

                            // White count text
                            countBadge.append('text')
                                .attr('x', badgeWidth / 2)
                                .attr('y', badgeHeight / 2 + 4)
                                .attr('text-anchor', 'middle')
                                .style('font-family', 'var(--font-family-ui)')
                                .style('font-size', '11px')
                                .style('font-weight', '700')
                                .style('fill', 'white')
                                .text(countText);

                        } else {
                            // Update existing badge
                            console.log(`[D3 Badges] Updating existing badge for ${nodeName} with count ${count}`);
                            const countText = count.toString();
                            const badgeWidth = countText.length === 1 ? 18 : (countText.length === 2 ? 22 : 26);

                            // Update badge width and repositioning
                            const xOffset = d.data.premium ? -42 : -10;
                            existingBadge.attr('transform', `translate(${180/2 - badgeWidth + xOffset}, ${-50/2 + 5})`);

                            // Update rectangle width
                            existingBadge.select('rect').attr('width', badgeWidth);

                            // Update text
                            existingBadge.select('text')
                                .attr('x', badgeWidth / 2)
                                .text(countText);
                        }
                    } else {
                        // Remove badge if count is 0
                        if (!existingBadge.empty()) {
                            console.log(`[D3 Badges] Removing badge for ${nodeName} (count = 0)`);
                            existingBadge.remove();
                        }
                    }
                });
            });

            console.log('[D3 Badges] Badge update completed');
        }

        function switchPersona(persona) {
            currentPersona = persona;

            // Hide tooltip when switching personas
            guidanceTooltip.hide();

            // Update active button styling
            document.querySelectorAll('.persona-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = 'rgba(255, 255, 255, 0.7)';
            });
            const activeBtn = document.querySelector(`[data-persona="${persona}"]`);
            activeBtn.classList.add('active');
            activeBtn.style.background = 'var(--color-primary-blue)';
            activeBtn.style.color = 'white';

            // Update profile info
            updateProfileInfo(persona);

            // Load user data for new persona
            loadUserJobs();
            loadStories();
            loadUserExperiences();
            loadUserGoals();
            loadUserPortfolio();

            // Reload documents for new persona (if documents slideout is visible)
            if (document.getElementById('documentsContent') &&
                document.getElementById('documentsContent').style.display === 'block') {
                loadDocuments();
            }

            // Clear and redraw mindmap
            d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();
            initializeMindmap(persona);
        }

        // Profile dropdown functions
        function toggleProfileDropdown() {
            // Close any open slideouts first
            const slideout = document.getElementById('interviewSlideout');
            if (slideout && slideout.classList.contains('active')) {
                slideout.classList.remove('active');
            }

            // Close about dropdown if open
            const aboutDropdown = document.getElementById('aboutDropdown');
            if (aboutDropdown && aboutDropdown.classList.contains('active')) {
                aboutDropdown.classList.remove('active');
            }

            // Then toggle the profile dropdown
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        // Toggle About dropdown
        function toggleAboutDropdown() {
            // Close interview slideout if open
            closeInterviewSlideout();

            // Close profile dropdown if open
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileDropdown && profileDropdown.classList.contains('active')) {
                profileDropdown.classList.remove('active');
            }

            // Toggle the about dropdown
            const dropdown = document.getElementById('aboutDropdown');
            dropdown.classList.toggle('active');
        }

        // Mobile main menu toggle function
        function toggleMobileMainMenu() {
            const dropdown = document.getElementById('mobileMainMenuDropdown');
            const icon = document.getElementById('mobileMenuIcon');

            if (!dropdown) {
                console.error('Mobile menu dropdown not found');
                return;
            }

            const isActive = dropdown.classList.contains('active');

            if (isActive) {
                dropdown.classList.remove('active');
                if (icon) icon.className = 'ph ph-list';
            } else {
                // Close profile dropdown if open
                const profileDropdown = document.getElementById('profileDropdown');
                if (profileDropdown && profileDropdown.classList.contains('active')) {
                    profileDropdown.classList.remove('active');
                }

                dropdown.classList.add('active');
                if (icon) icon.className = 'ph ph-x';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const profileCircle = document.querySelector('.profile-circle');
            const profileDropdown = document.getElementById('profileDropdown');
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            const mobileMenuDropdown = document.getElementById('mobileMainMenuDropdown');
            const aboutDropdown = document.getElementById('aboutDropdown');

            // Close profile dropdown if clicking outside
            if (profileCircle && !profileCircle.contains(event.target)) {
                profileDropdown.classList.remove('active');
            }

            // Close about dropdown if clicking outside
            const aboutButton = event.target.closest('.main-menu-item');
            const aboutDropdownElement = event.target.closest('.about-dropdown');
            if (aboutDropdown && !aboutDropdownElement && (!aboutButton || !aboutButton.onclick || aboutButton.onclick.toString().indexOf('toggleAboutDropdown') === -1)) {
                aboutDropdown.classList.remove('active');
            }

            // Close mobile menu dropdown if clicking outside
            if (mobileMenuToggle && !mobileMenuToggle.contains(event.target) &&
                mobileMenuDropdown && !mobileMenuDropdown.contains(event.target)) {
                mobileMenuDropdown.classList.remove('active');
                const icon = document.getElementById('mobileMenuIcon');
                if (icon) {
                    icon.className = 'ph ph-list';
                }
            }
        });

        function updateProfileInfo(persona) {
            const personaInfo = {
                'retail-manager': {
                    name: 'Alex Martinez',
                    role: 'Retail Manager',
                    initials: 'AM'
                },
                'chemist': {
                    name: 'Dr. Sarah Chen',
                    role: 'Research Chemist',
                    initials: 'SC'
                },
                'new-graduate': {
                    name: 'Jordan Kim',
                    role: 'New Graduate',
                    initials: 'JK'
                },
                'data-analyst': {
                    name: 'Riley Patel',
                    role: 'Data Analyst',
                    initials: 'RP'
                }
            };

            const info = personaInfo[persona];
            if (info) {
                document.getElementById('profileInitials').textContent = info.initials;
                document.getElementById('profileName').textContent = info.name;
                document.getElementById('profileRole').textContent = info.role;
            }
        }

        function openProfileSettings() {
            document.getElementById('profileDropdown').classList.remove('active');

            // Load current profile data
            const profile = loadProfile();
            document.getElementById('profileFirstName').value = profile.firstName;
            document.getElementById('profileLastName').value = profile.lastName;
            document.getElementById('profileProfession').value = profile.profession;
            document.getElementById('profileGoal').value = profile.goal;
            document.getElementById('profileEmail').value = profile.email || '';

            // Check if this is an example profile and show/hide notice
            checkAndShowExampleProfileNotice(profile);

            // Show modal
            document.getElementById('profileModal').style.display = 'flex';
        }

        function checkAndShowExampleProfileNotice(profile) {
            const exampleNames = [
                'Marcus Thompson',
                'Dr. Sarah Chen',
                'Sarah Chen',
                'Sara Chen',
                'Jordan Kim',
                'Alex Martinez',
                'Jamie Rodriguez'
            ];
            const isExampleProfile = exampleNames.some(name => {
                const parts = name.split(' ');
                // Handle "Dr. Sarah Chen" format
                if (parts.length === 3 && parts[0] === 'Dr.') {
                    return profile.firstName === parts[1] && profile.lastName === parts[2];
                }
                // Handle "FirstName LastName" format
                const [firstName, lastName] = parts;
                return profile.firstName === firstName && profile.lastName === (lastName || '');
            });

            // Show example profile notice if it's an example profile
            const notice = document.getElementById('exampleProfileNotice');
            if (notice) {
                notice.style.display = isExampleProfile ? 'block' : 'none';
            }

            // Show profile request invitation if it's NOT an example profile
            const invitation = document.getElementById('profileRequestInvitation');
            if (invitation) {
                invitation.style.display = isExampleProfile ? 'none' : 'block';
            }
        }

        function clearExampleProfile() {
            if (confirm('This will clear the example profile data and all associated experiences, stories, goals, projects, and job opportunities. Are you sure you want to start fresh?')) {
                // Clear all data
                localStorage.removeItem('cleansheet_profile');
                localStorage.removeItem('cleansheet_experiences');
                localStorage.removeItem('cleansheet_stories');
                localStorage.removeItem('behavioralStories');
                localStorage.removeItem(`userGoals_${currentPersona}`);
                localStorage.removeItem(`userPortfolio_${currentPersona}`);
                localStorage.removeItem('jobOpportunities');
                localStorage.removeItem(`jobOpportunities_${currentPersona}`);

                // Clear profile form
                document.getElementById('profileFirstName').value = '';
                document.getElementById('profileLastName').value = '';
                document.getElementById('profileProfession').value = '';
                document.getElementById('profileGoal').value = '';
                document.getElementById('profileEmail').value = '';

                // Hide the example profile notice and show the profile request invitation
                const notice = document.getElementById('exampleProfileNotice');
                if (notice) notice.style.display = 'none';

                const invitation = document.getElementById('profileRequestInvitation');
                if (invitation) invitation.style.display = 'block';

                // Refresh the mindmap to show empty state
                refreshMindmap();

                alert('Example profile cleared! You can now start building your own career canvas.');
            }
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function loadProfile() {
            const defaultProfile = {
                firstName: 'Alex',
                lastName: 'Martinez',
                profession: 'Retail Manager',
                goal: 'Transition from retail management into business analytics or operations management roles in tech companies'
            };

            const saved = localStorage.getItem('cleansheet_profile');
            return saved ? JSON.parse(saved) : defaultProfile;
        }

        function saveProfile() {
            const profile = {
                firstName: document.getElementById('profileFirstName').value.trim(),
                lastName: document.getElementById('profileLastName').value.trim(),
                profession: document.getElementById('profileProfession').value.trim(),
                goal: document.getElementById('profileGoal').value.trim(),
                email: document.getElementById('profileEmail').value.trim()
            };

            // Validate required fields
            if (!profile.firstName || !profile.lastName) {
                alert('Please enter both first and last name.');
                return;
            }

            // Save to localStorage (instant, works offline)
            localStorage.setItem('cleansheet_profile', JSON.stringify(profile));

            // Sync to cloud if authenticated (debounced)
            if (isAuthenticated && sync) {
                sync.hybridSave('profile', profile, 2000).catch(err => {
                    console.error('Profile cloud sync failed:', err);
                });
            }

            // Update UI
            updateProfileDisplay(profile);

            // Refresh D3 mindmap with new profile data
            refreshMindmap();

            // Update feature visibility (Technical tab, etc.) based on new settings
            updateFeatureVisibility();

            // Close modal
            closeProfileModal();
        }

        // Prompt Builder Functions
        function openPromptBuilder() {
            // Close profile dropdown if open
            document.getElementById('profileDropdown').classList.remove('active');

            // Reset form
            document.getElementById('promptAssetType').value = 'cover-letter';
            document.getElementById('promptLength').value = 'medium';
            document.getElementById('interviewType').value = 'behavioral';
            document.getElementById('itemCount').value = '10';
            document.getElementById('promptContext').value = '';
            document.getElementById('includeExperiences').checked = true;
            document.getElementById('includeStories').checked = true;
            document.getElementById('includeGoals').checked = true;
            document.getElementById('includePortfolio').checked = true;
            document.getElementById('promptCopiedMessage').style.display = 'none';

            // Initialize section visibility based on asset type
            updatePromptSections();

            // Add event listener for asset type changes
            const assetTypeSelect = document.getElementById('promptAssetType');
            assetTypeSelect.removeEventListener('change', updatePromptSections);
            assetTypeSelect.addEventListener('change', updatePromptSections);

            // Show/hide job opportunity section based on subscription tier
            const subscriptionTier = localStorage.getItem('subscription_tier') || 'seeker';
            const jobOpportunitySection = document.getElementById('jobOpportunitySection');
            if (subscriptionTier === 'seeker') {
                jobOpportunitySection.style.display = 'flex';

                // Populate job opportunities dropdown
                const jobSelect = document.getElementById('promptJobOpportunity');
                jobSelect.innerHTML = '<option value="">None - General prompt</option>';

                // Add active job opportunities (not rejected or not-interested)
                const activeJobs = userJobs.filter(job =>
                    job.status !== 'rejected' && job.status !== 'not-interested'
                );

                activeJobs.forEach((job, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${job.title} at ${job.company}`;
                    jobSelect.appendChild(option);
                });

                // Reset selection
                jobSelect.value = '';

                // Add event listener to update attach button state when job selection changes
                jobSelect.removeEventListener('change', updateAttachButtonState);
                jobSelect.addEventListener('change', updateAttachButtonState);

                // Show attach prompt button for seekers
                const attachButton = document.getElementById('attachPromptButton');
                attachButton.style.display = 'flex';
                updateAttachButtonState(); // Initialize button state
            } else {
                // Hide for member and learner tiers
                jobOpportunitySection.style.display = 'none';

                // Hide attach prompt button for non-seekers
                const attachButton = document.getElementById('attachPromptButton');
                attachButton.style.display = 'none';
            }

            // Show modal
            document.getElementById('promptBuilderModal').style.display = 'flex';
        }

        function updateAttachButtonState() {
            const jobSelect = document.getElementById('promptJobOpportunity');
            const attachButton = document.getElementById('attachPromptButton');

            if (jobSelect.value === '') {
                // Disabled state - no job selected
                attachButton.disabled = true;
                attachButton.style.cursor = 'not-allowed';
                attachButton.style.opacity = '0.5';
                attachButton.style.borderColor = 'var(--color-neutral-border)';
                attachButton.style.color = 'var(--color-neutral-text)';
            } else {
                // Enabled state - job selected
                attachButton.disabled = false;
                attachButton.style.cursor = 'pointer';
                attachButton.style.opacity = '1';
                attachButton.style.borderColor = '#16a34a';
                attachButton.style.color = '#16a34a';
            }
        }

        function updatePromptSections() {
            const assetType = document.getElementById('promptAssetType').value;
            const isInterviewPrep = assetType === 'interview-prep';

            // Toggle sections based on asset type
            document.getElementById('interviewTypeSection').style.display = isInterviewPrep ? 'flex' : 'none';
            document.getElementById('itemCountSection').style.display = isInterviewPrep ? 'flex' : 'none';
            document.getElementById('lengthSection').style.display = isInterviewPrep ? 'none' : 'flex';
        }

        function closePromptBuilder() {
            document.getElementById('promptBuilderModal').style.display = 'none';
        }

        function openPromptBuilderForJob() {
            if (!currentJobDetail) {
                alert('No job selected. Please select a job first.');
                return;
            }

            // Open the prompt builder modal (this sets up the form)
            openPromptBuilder();

            // If user is a Seeker, pre-select the current job
            const subscriptionTier = localStorage.getItem('subscription_tier') || 'seeker';
            if (subscriptionTier === 'seeker') {
                const jobSelect = document.getElementById('promptJobOpportunity');

                // Find the index of the current job in the active jobs list
                const activeJobs = userJobs.filter(job =>
                    job.status !== 'rejected' && job.status !== 'not-interested'
                );

                const jobIndex = activeJobs.findIndex(job =>
                    job.title === currentJobDetail.title &&
                    job.company === currentJobDetail.company &&
                    job.location === currentJobDetail.location
                );

                if (jobIndex !== -1) {
                    // Set the dropdown to the current job
                    jobSelect.value = jobIndex.toString();

                    // Update the attach button state
                    updateAttachButtonState();
                }
            }
        }

        function openSubscriptionModal() {
            // Close any open slideouts first
            closeInterviewSlideout();

            document.getElementById('subscriptionModal').style.display = 'flex';
            // Close profile dropdown
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) dropdown.classList.remove('active');

            // Initialize selected plan based on localStorage (default to seeker)
            const currentPlan = localStorage.getItem('subscription_tier') || 'seeker';
            selectPlan(currentPlan);
        }

        function closeSubscriptionModal() {
            document.getElementById('subscriptionModal').style.display = 'none';

            // Update left panel status bar when modal closes (in case tier changed)
            updateLeftPanelUserName();
            updateLeftPanelSyncStatus();
        }

        function closeSubscriptionModalOnOutsideClick(event) {
            // Close modal if clicking on the backdrop (not the modal content)
            if (event.target === event.currentTarget) {
                closeSubscriptionModal();
            }
        }

        // Toggle Engagements Section
        function toggleEngagementsSection() {
            const grid = document.getElementById('engagementsGrid');
            const icon = document.getElementById('engagementsToggleIcon');

            if (grid.style.display === 'none') {
                grid.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                grid.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Quick Start Modal Functions
        window.openRapidOnboardingModal = function() {
            // Close any open slideouts first
            closeInterviewSlideout();

            document.getElementById('rapidOnboardingModal').style.display = 'flex';

            // Clear form fields
            document.getElementById('rapidOnboardingFirstName').value = '';
            document.getElementById('rapidOnboardingLastName').value = '';
            document.getElementById('rapidOnboardingProfession').value = '';
            document.getElementById('rapidOnboardingGoal').value = '';
        };

        window.closeRapidOnboardingModal = function() {
            document.getElementById('rapidOnboardingModal').style.display = 'none';
        };

        window.toggleProfileRequestFields = function() {
            const checkbox = document.getElementById('requestProfileCheckbox');
            const fields = document.getElementById('profileRequestFields');

            if (checkbox.checked) {
                fields.style.display = 'block';
            } else {
                fields.style.display = 'none';
            }
        };

        window.saveRapidOnboardingProfile = async function() {
            // Get form values
            const firstName = document.getElementById('rapidOnboardingFirstName').value.trim();
            const lastName = document.getElementById('rapidOnboardingLastName').value.trim();
            const profession = document.getElementById('rapidOnboardingProfession').value.trim();
            const goal = document.getElementById('rapidOnboardingGoal').value.trim();

            // Validate required fields
            if (!firstName || !lastName) {
                alert('Please enter your first and last name.');
                return;
            }

            // Clear any existing example profile data before creating new profile
            localStorage.removeItem(`userGoals_${currentPersona}`);
            localStorage.removeItem(`userPortfolio_${currentPersona}`);
            localStorage.removeItem(`jobOpportunities_${currentPersona}`);
            localStorage.removeItem('applicationMaterials');
            localStorage.removeItem('cleansheet_experiences');
            localStorage.removeItem(`careerExperiences_${currentPersona}`); // Legacy key
            localStorage.removeItem('cleansheet_stories');
            localStorage.removeItem('behavioralStories');

            // Save profile
            const profile = {
                firstName: firstName,
                lastName: lastName,
                profession: profession,
                goal: goal
            };

            localStorage.setItem('cleansheet_profile', JSON.stringify(profile));

            // Show welcome message
            alert(`Welcome, ${firstName}! Your profile has been created. Start building your career canvas by clicking on any of the sections in the mindmap.`);

            // Update UI
            updateProfileDisplay(profile);

            // Reload data from localStorage (will be empty after clearing)
            loadUserExperiences();
            loadCareerExperiences(); // Re-render experiences UI
            loadStories();
            loadUserGoals();
            loadUserPortfolio();
            loadUserJobs();

            // Reset all counts to zero after clearing data
            updateExperienceCount(0);
            updateStoryCount(0);
            updateGoalsCount(0);
            updatePortfolioCount(0);
            updateJobOpportunitiesCount(0);

            refreshMindmap();

            // Close modal
            closeRapidOnboardingModal();
        };

        // Erasure Request Modal Functions
        window.openErasureRequestModal = function() {
            // Close profile dropdown menu
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileDropdown) {
                profileDropdown.classList.remove('active');
            }

            document.getElementById('erasureRequestModal').style.display = 'flex';

            // Clear form fields
            document.getElementById('erasureRequestName').value = '';
            document.getElementById('erasureRequestEmail').value = '';
        };

        window.closeErasureRequestModal = function() {
            document.getElementById('erasureRequestModal').style.display = 'none';
        };

        window.submitErasureRequest = async function() {
            // Get form values
            const name = document.getElementById('erasureRequestName').value.trim();
            const email = document.getElementById('erasureRequestEmail').value.trim();

            // Validate required fields
            if (!name) {
                alert('Please enter your full name.');
                return;
            }

            if (!email) {
                alert('Please enter your email address.');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }

            try {
                // Submit erasure request via blob storage workflow
                await submitErasureRequestWithBlob(name, email);

                console.log('Erasure request submitted successfully via blob storage');

                // Show confirmation message
                alert(`Erasure Request Submitted\n\nYour request has been received. You will receive a confirmation email at ${email} shortly.\n\nYou must respond to the confirmation email to verify your identity. Upon confirmation, Cleansheet will erase all records within 30 days.\n\nThis action is irreversible.`);

                // Close modal
                closeErasureRequestModal();

            } catch (error) {
                console.error('Error submitting erasure request:', error);
                alert(`Failed to submit erasure request. Please try again or contact privacy@cleansheet.dev directly.\n\nError: ${error.message}`);
            }
        };

        // Quick Start Example Profile Loader
        window.loadQuickStartExample = function(profileType) {
            // Close the Quick Start modal
            closeRapidOnboardingModal();

            // Load the example profile using the existing function
            loadExampleProfile(profileType);
        };

        // Slideout Profile Request Functions
        window.toggleProfileRequestForm = function() {
            const form = document.getElementById('profileRequestFormContainer');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                // Clear fields when opening
                document.getElementById('slideoutProfileEmail').value = '';
                document.getElementById('slideoutProfileLinkedIn').value = '';
            } else {
                form.style.display = 'none';
            }
        };

        window.submitSlideoutProfileRequest = async function() {
            const email = document.getElementById('slideoutProfileEmail').value.trim();
            const linkedIn = document.getElementById('slideoutProfileLinkedIn').value.trim();

            // Validate required fields
            if (!email) {
                alert('Please enter your email address.');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }

            // LinkedIn URL is mandatory
            if (!linkedIn) {
                alert('Please enter your LinkedIn profile URL.');
                return;
            }

            // Acknowledgement checkbox is mandatory
            const acknowledgement = document.getElementById('slideoutAcknowledgement').checked;
            if (!acknowledgement) {
                alert('You must acknowledge and agree to the terms before requesting a profile.');
                return;
            }

            try {
                // Get current profile info for context
                const profile = loadProfile();

                // Submit profile request via blob storage workflow
                await submitProfileRequestWithBlob({
                    email: email,
                    linkedIn: linkedIn,
                    firstName: profile.firstName || '',
                    lastName: profile.lastName || '',
                    profession: profile.profession || '',
                    source: 'career_experience_slideout'
                });

                console.log('Profile request submitted successfully from slideout via blob storage');

                // Close the form
                toggleProfileRequestForm();

                // Show confirmation modal
                openProfileRequestConfirmationModal();

            } catch (error) {
                console.error('Error submitting profile request:', error);
                alert(`Failed to submit profile request. Please try again or contact support at privacy@cleansheet.dev.\n\nError: ${error.message}`);
            }
        };

        // Profile Request Confirmation Modal Functions
        window.openProfileRequestConfirmationModal = function() {
            document.getElementById('profileRequestConfirmationModal').style.display = 'flex';
        };

        window.closeProfileRequestConfirmationModal = function() {
            document.getElementById('profileRequestConfirmationModal').style.display = 'none';
        };

        // Subscription Profile Request Modal Functions
        window.openSubscriptionProfileRequestModal = function() {
            document.getElementById('subscriptionProfileRequestModal').style.display = 'flex';
            // Clear form fields
            document.getElementById('subProfileEmail').value = '';
            document.getElementById('subProfileLinkedIn').value = '';
        };

        window.closeSubscriptionProfileRequestModal = function() {
            document.getElementById('subscriptionProfileRequestModal').style.display = 'none';
        };

        // Handle subscription profile request form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('subscriptionProfileRequestForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const email = document.getElementById('subProfileEmail').value.trim();
                    const linkedIn = document.getElementById('subProfileLinkedIn').value.trim();

                    if (!email || !linkedIn) {
                        alert('Please fill in all required fields.');
                        return;
                    }

                    // Validate email format
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        alert('Please enter a valid email address.');
                        return;
                    }

                    // Validate LinkedIn URL
                    if (!linkedIn.includes('linkedin.com')) {
                        alert('Please enter a valid LinkedIn profile URL.');
                        return;
                    }

                    // Acknowledgement checkbox is mandatory
                    const acknowledgement = document.getElementById('subscriptionAcknowledgement').checked;
                    if (!acknowledgement) {
                        alert('You must acknowledge and agree to the terms before requesting a profile.');
                        return;
                    }

                    try {
                        // Submit profile request via blob storage workflow
                        await submitProfileRequestWithBlob({
                            email: email,
                            linkedIn: linkedIn,
                            source: 'subscription_modal'
                        });

                        console.log('Profile request submitted successfully from subscription modal via blob storage');

                        // Close the request modal
                        closeSubscriptionProfileRequestModal();

                        // Show confirmation modal
                        openProfileRequestConfirmationModal();

                    } catch (error) {
                        console.error('Error submitting profile request:', error);
                        alert(`Failed to submit profile request. Please try again or contact support at privacy@cleansheet.dev.\n\nError: ${error.message}`);
                    }
                });
            }
        });

        // Coaching Inquiry Modal Functions
        window.openCoachingInquiryModal = function(source) {
            const modal = document.getElementById('coachingInquiryModal');
            const emptyProfileWarning = document.getElementById('coachingEmptyProfileWarning');
            const experienceWarning = document.getElementById('coachingExperienceWarning');
            const form = document.getElementById('coachingInquiryForm');

            // Store the source for form submission
            modal.setAttribute('data-inquiry-source', source || 'general_inquiry');

            // Load experiences directly from localStorage to ensure we have current data
            let currentExperiences = [];
            try {
                const expData = localStorage.getItem('cleansheet_experiences');
                if (expData) {
                    currentExperiences = JSON.parse(expData);
                }
            } catch (e) {
                console.error('Error loading experiences:', e);
                currentExperiences = [];
            }

            // Get profile from window or load from localStorage
            let currentProfile = window.profile;
            if (!currentProfile) {
                const saved = localStorage.getItem('cleansheet_profile');
                currentProfile = saved ? JSON.parse(saved) : {
                    firstName: 'Alex',
                    lastName: 'Martinez',
                    profession: 'Retail Manager'
                };
            }

            console.log('[Coaching Modal] Experience count:', currentExperiences.length);
            console.log('[Coaching Modal] Source:', source);

            // Clear form fields
            document.getElementById('coachingInquiryEmail').value = currentProfile.email || '';
            document.getElementById('coachingInquiryNotes').value = '';
            document.getElementById('coachingInquiryAcknowledgement').checked = false;

            // Customize modal content based on source
            const modalIcon = document.getElementById('coachingModalIcon');
            const modalTitle = document.getElementById('coachingModalTitle');
            const modalDescription = document.getElementById('coachingModalDescription');
            const acknowledgementLabel = document.getElementById('coachingAcknowledgementLabel');
            const acknowledgementText = document.getElementById('coachingAcknowledgementText');

            if (source === 'consulting_services') {
                // Consulting engagement customization
                modalIcon.className = 'ph ph-briefcase';
                modalIcon.style.color = '#7c3aed';
                modalTitle.textContent = 'Request Consulting Engagement';
                modalDescription.textContent = 'Connect with our consulting team to discuss digital transformation, data pipeline architecture, systems integration, or other enterprise technical challenges.';

                // Update acknowledgement for consulting context
                acknowledgementLabel.style.background = '#faf5ff';
                acknowledgementLabel.style.borderColor = '#7c3aed';
                acknowledgementText.style.color = '#581c87';
                acknowledgementText.innerHTML = 'I acknowledge that I am sharing my information with Cleansheet to <strong>facilitate the service discovery process</strong>, and I agree to the <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer" style="color: #7c3aed; text-decoration: underline; font-weight: 600;">Terms of Service</a>. *';

                // Hide profile warnings for consulting (not relevant)
                emptyProfileWarning.style.display = 'none';
                experienceWarning.style.display = 'none';
                console.log('[Coaching Modal] Consulting mode - no profile warnings');
            } else if (source === 'recruiter_partnership') {
                // Recruiter partnership customization
                modalIcon.className = 'ph ph-handshake';
                modalIcon.style.color = '#16a34a';
                modalTitle.textContent = 'Partnership Inquiry';
                modalDescription.textContent = 'Connect with our business development team to explore partnership opportunities. We are in early stages and welcome conversations about how we might collaborate with recruitment professionals and agencies.';

                // Update acknowledgement for partnership context
                acknowledgementLabel.style.background = '#f0fdf4';
                acknowledgementLabel.style.borderColor = '#16a34a';
                acknowledgementText.style.color = '#14532d';
                acknowledgementText.innerHTML = 'I acknowledge that I am sharing my information with Cleansheet to <strong>explore potential partnership opportunities</strong>, and I agree to the <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer" style="color: #16a34a; text-decoration: underline; font-weight: 600;">Terms of Service</a>. *';

                // Hide profile warnings for partnerships (not relevant)
                emptyProfileWarning.style.display = 'none';
                experienceWarning.style.display = 'none';
                console.log('[Coaching Modal] Partnership mode - no profile warnings');
            } else if (source === 'professional_services') {
                // Professional services customization
                modalIcon.className = 'ph ph-kanban';
                modalIcon.style.color = '#f59e0b';
                modalTitle.textContent = 'Professional Services Inquiry';
                modalDescription.textContent = 'Connect with our team to learn more about the Cleansheet Professional canvas for digital transformation, project management, ML pipeline orchestration, and collaborative authoring workflows.';

                // Update acknowledgement for professional services context
                acknowledgementLabel.style.background = '#fff8e1';
                acknowledgementLabel.style.borderColor = '#f59e0b';
                acknowledgementText.style.color = '#b45309';
                acknowledgementText.innerHTML = 'I acknowledge that I am sharing my information with Cleansheet to <strong>learn about Professional services and pricing</strong>, and I agree to the <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer" style="color: #f59e0b; text-decoration: underline; font-weight: 600;">Terms of Service</a>. *';

                // Hide profile warnings for professional services (not relevant)
                emptyProfileWarning.style.display = 'none';
                experienceWarning.style.display = 'none';
                console.log('[Coaching Modal] Professional services mode - no profile warnings');
            } else {
                // Career coaching/services customization
                modalIcon.className = 'ph ph-chalkboard-teacher';
                modalIcon.style.color = 'var(--color-primary-blue)';
                modalTitle.textContent = 'Request Coaching Session';
                modalDescription.textContent = 'Connect with a Cleansheet Success Manager to discuss your career goals and coaching needs.';

                // Reset acknowledgement to coaching context
                acknowledgementLabel.style.background = '#e3f2fd';
                acknowledgementLabel.style.borderColor = 'var(--color-primary-blue)';
                acknowledgementText.style.color = '#0c4a6e';
                acknowledgementText.innerHTML = 'I acknowledge that I am sharing my profile information with Cleansheet to <strong>facilitate the coach match process</strong>, and I agree to the <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary-blue); text-decoration: underline; font-weight: 600;">Terms of Service</a>. *';

                // Show appropriate warning based on experience count
                if (currentExperiences.length === 0) {
                    // No experiences at all - show red empty profile warning
                    emptyProfileWarning.style.display = 'block';
                    experienceWarning.style.display = 'none';
                    console.log('[Coaching Modal] Showing empty profile warning (0 experiences)');
                } else if (currentExperiences.length < 4) {
                    // Has some experiences but fewer than 4 - show yellow recommendation
                    emptyProfileWarning.style.display = 'none';
                    experienceWarning.style.display = 'block';
                    console.log('[Coaching Modal] Showing experience warning (1-3 experiences)');
                } else {
                    // Profile is complete enough (4+ experiences)
                    emptyProfileWarning.style.display = 'none';
                    experienceWarning.style.display = 'none';
                    console.log('[Coaching Modal] No warnings - profile is complete (4+ experiences)');
                }
            }

            modal.style.display = 'flex';
        };

        window.closeCoachingInquiryModal = function() {
            document.getElementById('coachingInquiryModal').style.display = 'none';
        };

        window.openCoachingInquiryConfirmationModal = function() {
            document.getElementById('coachingInquiryConfirmationModal').style.display = 'flex';
        };

        window.closeCoachingInquiryConfirmationModal = function() {
            document.getElementById('coachingInquiryConfirmationModal').style.display = 'none';
        };

        // Handle coaching inquiry form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('coachingInquiryForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const email = document.getElementById('coachingInquiryEmail').value.trim();
                    const notes = document.getElementById('coachingInquiryNotes').value.trim();
                    const acknowledgement = document.getElementById('coachingInquiryAcknowledgement').checked;

                    // Validation
                    if (!email) {
                        alert('Please provide your email address.');
                        return;
                    }

                    if (!acknowledgement) {
                        alert('You must acknowledge and agree to share your profile information and the Terms of Service.');
                        return;
                    }

                    try {
                        // Get the inquiry source from the modal's data attribute
                        const modal = document.getElementById('coachingInquiryModal');
                        const inquirySource = modal.getAttribute('data-inquiry-source') || 'general_inquiry';
                        console.log('[Coaching Inquiry] Service type:', inquirySource);

                        // Load full profile data from localStorage (not window objects which may be stale)
                        const currentPersona = window.currentPersona || 'career-changer';
                        const currentProfile = JSON.parse(localStorage.getItem('cleansheet_profile') || '{}');
                        const currentExperiences = JSON.parse(localStorage.getItem('cleansheet_experiences') || '[]');
                        const currentStories = JSON.parse(localStorage.getItem(`userStories_${currentPersona}`) || '[]');
                        const currentGoals = JSON.parse(localStorage.getItem(`userGoals_${currentPersona}`) || '[]');
                        const currentPortfolio = JSON.parse(localStorage.getItem(`userPortfolio_${currentPersona}`) || '[]');
                        const currentJobOpportunities = JSON.parse(localStorage.getItem(`userJobs_${currentPersona}`) || '[]');

                        console.log('[Coaching Inquiry] Profile data loaded from localStorage:');
                        console.log('  - Experiences:', currentExperiences.length);
                        console.log('  - Stories:', currentStories.length);
                        console.log('  - Goals:', currentGoals.length);
                        console.log('  - Portfolio:', currentPortfolio.length);
                        console.log('  - Job Opportunities:', currentJobOpportunities.length);

                        // Prepare coaching inquiry data
                        const inquiryData = {
                            email: email,
                            notes: notes,
                            serviceType: inquirySource,
                            experienceCount: currentExperiences.length,
                            storyCount: currentStories.length,
                            goalCount: currentGoals.length,
                            portfolioCount: currentPortfolio.length,
                            jobCount: currentJobOpportunities.length,
                            hasProfile: !!currentProfile.firstName || !!currentProfile.lastName || !!currentProfile.profession,
                            persona: currentPersona
                        };

                        // Get metadata
                        const browserMetadata = getBrowserMetadata();
                        const ipAddress = await getClientIPAddress();

                        // Wrap in blob data structure with FULL profile data
                        const blobData = {
                            metadata: {
                                requestType: 'coachingInquiry',
                                ipAddress: ipAddress,
                                browserType: browserMetadata.browserType,
                                userAgent: browserMetadata.userAgent,
                                platform: browserMetadata.platform,
                                language: browserMetadata.language,
                                requestDate: new Date().toISOString(),
                                source: inquirySource,
                                persona: currentPersona
                            },
                            inquiry: inquiryData,
                            profile: currentProfile,
                            experiences: currentExperiences,
                            stories: currentStories,
                            goals: currentGoals,
                            portfolio: currentPortfolio,
                            jobOpportunities: currentJobOpportunities
                        };

                        // Upload blob
                        const blobName = await uploadProfileBlob(email, blobData);
                        console.log('Coaching inquiry blob uploaded:', blobName);

                        // Create table reference
                        await createProfileBlobTableReference(
                            email,
                            blobName,
                            'coachingInquiry',
                            {
                                serviceType: inquirySource,
                                experienceCount: currentExperiences.length,
                                storyCount: currentStories.length,
                                goalCount: currentGoals.length,
                                portfolioCount: currentPortfolio.length,
                                jobCount: currentJobOpportunities.length,
                                hasNotes: !!notes,
                                persona: currentPersona
                            }
                        );

                        console.log('Coaching inquiry submitted successfully via blob storage');

                        // Close inquiry modal
                        closeCoachingInquiryModal();

                        // Show confirmation modal
                        openCoachingInquiryConfirmationModal();

                    } catch (error) {
                        console.error('Error submitting coaching inquiry:', error);
                        alert(`Failed to submit coaching inquiry. Please try again or contact support at coaching@cleansheet.dev.\n\nError: ${error.message}`);
                    }
                });
            }
        });

        function openCoachPreviewModal() {
            const modal = document.getElementById('coachPreviewModal');
            const iframe = document.getElementById('coachPreviewFrame');
            iframe.src = 'cleansheet-coach.html?embed=true';
            modal.style.display = 'flex';
        }

        function closeCoachPreviewModal() {
            const modal = document.getElementById('coachPreviewModal');
            const iframe = document.getElementById('coachPreviewFrame');
            modal.style.display = 'none';
            iframe.src = ''; // Clear iframe to stop any running scripts
        }

        function openAboutModal() {
            document.getElementById('aboutModal').style.display = 'flex';
        }

        function closeAboutModal() {
            document.getElementById('aboutModal').style.display = 'none';
        }

        function selectPlan(plan) {
            // Update plan card styles
            const memberCard = document.getElementById('memberPlanCard');
            const learnerCard = document.getElementById('learnerPlanCard');
            const seekerCard = document.getElementById('seekerPlanCard');

            // Reset all cards to inactive state
            memberCard.style.border = '2px solid var(--color-neutral-border)';
            memberCard.style.boxShadow = 'none';
            learnerCard.style.border = '2px solid var(--color-neutral-border)';
            learnerCard.style.boxShadow = 'none';
            seekerCard.style.border = '2px solid var(--color-neutral-border)';
            seekerCard.style.boxShadow = 'none';

            // Highlight selected card
            if (plan === 'member') {
                memberCard.style.border = '2px solid var(--color-primary-blue)';
                memberCard.style.boxShadow = '0 4px 12px rgba(0, 102, 204, 0.3)';
            } else if (plan === 'learner') {
                learnerCard.style.border = '2px solid var(--color-primary-blue)';
                learnerCard.style.boxShadow = '0 4px 12px rgba(0, 102, 204, 0.3)';
            } else if (plan === 'seeker') {
                seekerCard.style.border = '2px solid var(--color-primary-blue)';
                seekerCard.style.boxShadow = '0 4px 12px rgba(0, 102, 204, 0.3)';
            }

            // Update button states
            updatePlanButtons(plan);

            // Store selected plan in localStorage
            localStorage.setItem('subscription_tier', plan);

            // Apply viewport settings for new tier
            applyViewportForTier();

            // Update the subscription tier badge in the welcome header
            updateSubscriptionTierDisplay();

            // Update left panel status bar (tier badge and sync status)
            updateLeftPanelUserName();
            updateLeftPanelSyncStatus();

            // Refresh the mindmap to show/hide nodes based on new tier
            if (typeof currentViewMode !== 'undefined' && currentViewMode) {
                refreshMindmap();
            }

            // Update feature visibility (Technical tab, etc.)
            updateFeatureVisibility();

            // Update cloud sync button
            updateCloudSyncButton();

            // Show success toast
            const planNames = { member: 'Member', learner: 'Learner', seeker: 'Job Seeker' };
            console.log(`Selected plan: ${planNames[plan]}`);
        }

        function updatePlanButtons(currentPlan) {
            const memberBtn = document.getElementById('memberPlanButton');
            const learnerBtn = document.getElementById('learnerPlanButton');
            const seekerBtn = document.getElementById('seekerPlanButton');

            // Define button styles
            const currentPlanStyle = {
                background: 'white',
                border: '2px solid var(--color-primary-blue)',
                color: 'var(--color-primary-blue)',
                text: 'Current Plan',
                cursor: 'default'
            };

            const subscribeStyle = {
                background: 'var(--color-primary-blue)',
                border: 'none',
                color: 'white',
                text: 'Subscribe',
                cursor: 'pointer'
            };

            // Reset all buttons to Subscribe state with hover effects
            [memberBtn, learnerBtn, seekerBtn].forEach(btn => {
                btn.style.background = subscribeStyle.background;
                btn.style.border = subscribeStyle.border;
                btn.style.color = subscribeStyle.color;
                btn.textContent = subscribeStyle.text;
                btn.style.cursor = subscribeStyle.cursor;

                // Re-enable hover effects
                btn.onmouseover = function() {
                    if (this.style.cursor === 'pointer') {
                        this.style.background = 'var(--color-accent-blue)';
                    }
                };
                btn.onmouseout = function() {
                    if (this.style.cursor === 'pointer') {
                        this.style.background = 'var(--color-primary-blue)';
                    }
                };
            });

            // Set current plan button
            let currentBtn;
            if (currentPlan === 'member') currentBtn = memberBtn;
            else if (currentPlan === 'learner') currentBtn = learnerBtn;
            else if (currentPlan === 'seeker') currentBtn = seekerBtn;

            if (currentBtn) {
                currentBtn.style.background = currentPlanStyle.background;
                currentBtn.style.border = currentPlanStyle.border;
                currentBtn.style.color = currentPlanStyle.color;
                currentBtn.textContent = currentPlanStyle.text;
                currentBtn.style.cursor = currentPlanStyle.cursor;

                // Disable hover effects for current plan
                currentBtn.onmouseover = null;
                currentBtn.onmouseout = null;
            }
        }

        function updateSubscriptionTierDisplay() {
            const tierBadge = document.getElementById('subscriptionTierBadge');
            if (!tierBadge) return;

            const currentTier = localStorage.getItem('subscription_tier') || 'seeker';
            const tierNames = {
                member: 'Member',
                learner: 'Learner',
                seeker: 'Job Seeker'
            };

            // Update badge text
            tierBadge.textContent = tierNames[currentTier] || 'Job Seeker';

            // Update badge color based on tier
            const tierColors = {
                member: '#16a34a',     // Green for free tier
                learner: '#0066CC',    // Primary blue for learner
                seeker: '#9333ea'      // Purple for seeker
            };

            tierBadge.style.background = tierColors[currentTier] || '#16a34a';
        }

        // Helper function to build prompt text
        function buildPromptText() {
            const assetType = document.getElementById('promptAssetType').value;
            const length = document.getElementById('promptLength').value;
            const interviewType = document.getElementById('interviewType').value;
            const itemCount = document.getElementById('itemCount').value;
            const additionalContext = document.getElementById('promptContext').value.trim();
            const includeExperiences = document.getElementById('includeExperiences').checked;
            const includeStories = document.getElementById('includeStories').checked;
            const includeGoals = document.getElementById('includeGoals').checked;
            const includePortfolio = document.getElementById('includePortfolio').checked;

            // Get selected job opportunity (Seekers only)
            const subscriptionTier = localStorage.getItem('subscription_tier') || 'seeker';
            const jobOpportunitySelect = document.getElementById('promptJobOpportunity');
            const selectedJobIndex = jobOpportunitySelect.value;
            let selectedJob = null;
            if (selectedJobIndex !== '' && subscriptionTier === 'seeker') {
                const activeJobs = userJobs.filter(job =>
                    job.status !== 'rejected' && job.status !== 'not-interested'
                );
                selectedJob = activeJobs[parseInt(selectedJobIndex)];
            }

            // Get profile data
            const profile = loadProfile();

            // Get asset type name
            const assetTypeNames = {
                'cover-letter': 'Cover Letter',
                'resume': 'Resume',
                'linkedin-summary': 'LinkedIn Summary',
                'interview-prep': 'Interview Preparation',
                'networking-email': 'Networking Email',
                'personal-statement': 'Personal Statement'
            };

            // Get length description
            const lengthDescriptions = {
                'short': 'short (1 paragraph, 100-150 words)',
                'medium': 'medium length (2-3 paragraphs, 250-400 words)',
                'long': 'long (4-5 paragraphs, 500-750 words)',
                'comprehensive': 'comprehensive and detailed (1000+ words)'
            };

            // Build the prompt based on asset type
            let prompt = '';

            if (assetType === 'interview-prep') {
                // Special handling for interview preparation
                const interviewTypeDesc = interviewType === 'behavioral'
                    ? 'behavioral interview questions (focusing on leadership, teamwork, problem-solving, and STAR story responses)'
                    : 'technical interview questions (focusing on skills, tools, technical knowledge, and problem-solving abilities)';

                prompt = `Please generate ${itemCount} ${interviewTypeDesc} based on the following career profile data.\n\n`;

                // Add target job opportunity if selected
                if (selectedJob) {
                    prompt += `TARGET JOB OPPORTUNITY:\n`;
                    prompt += `Position: ${selectedJob.title}\n`;
                    prompt += `Company: ${selectedJob.company}\n`;
                    if (selectedJob.location) {
                        prompt += `Location: ${selectedJob.location}\n`;
                    }
                    if (selectedJob.salary) {
                        prompt += `Salary: ${selectedJob.salary}\n`;
                    }
                    prompt += `\nIMPORTANT INSTRUCTIONS FOR TARGET COMPANY:\n`;
                    prompt += `1. Research ${selectedJob.company}'s tools, technologies, and practices relevant to the ${selectedJob.title} role\n`;
                    prompt += `2. Research ${selectedJob.company}'s cultural patterns, values, and principles (e.g., Amazon's Leadership Principles, Google's work culture, etc.)\n`;
                    prompt += `3. Tailor the interview questions to align with ${selectedJob.company}'s known interview style and expectations\n`;
                    prompt += `4. Include questions that demonstrate knowledge of ${selectedJob.company}'s specific technologies, methodologies, and business domains\n\n`;
                    prompt += `Please generate questions that would help prepare specifically for an interview at ${selectedJob.company} for the ${selectedJob.title} position.\n\n`;
                }
            } else {
                // Standard handling for other asset types
                prompt = `Please generate a ${lengthDescriptions[length]} ${assetTypeNames[assetType]} based on the following career profile data.\n\n`;

                // Add target job opportunity if selected
                if (selectedJob) {
                    prompt += `TARGET JOB OPPORTUNITY:\n`;
                    prompt += `Position: ${selectedJob.title}\n`;
                    prompt += `Company: ${selectedJob.company}\n`;
                    if (selectedJob.location) {
                        prompt += `Location: ${selectedJob.location}\n`;
                    }
                    if (selectedJob.salary) {
                        prompt += `Salary: ${selectedJob.salary}\n`;
                    }
                    prompt += `\nIMPORTANT: Before generating the ${assetTypeNames[assetType]}, please research:\n`;
                    prompt += `1. ${selectedJob.company}'s tools, technologies, and practices relevant to the ${selectedJob.title} role\n`;
                    prompt += `2. ${selectedJob.company}'s cultural patterns, values, and principles (e.g., Amazon's Leadership Principles, Google's work culture, etc.)\n`;
                    prompt += `3. ${selectedJob.company}'s known priorities and what they value in candidates for this role\n\n`;
                    prompt += `Please tailor this ${assetTypeNames[assetType]} specifically for the ${selectedJob.title} position at ${selectedJob.company}, incorporating relevant cultural values and technical knowledge.\n\n`;
                }
            }

            // Add additional context if provided
            if (additionalContext) {
                prompt += `ADDITIONAL CONTEXT:\n${additionalContext}\n\n`;
            }

            // Add profile summary
            prompt += `PROFILE SUMMARY:\n`;
            prompt += `Name: ${profile.firstName} ${profile.lastName}\n`;
            if (profile.profession) {
                prompt += `Current Role: ${profile.profession}\n`;
            }

            // Add career goals if requested
            if (includeGoals && profile.goal) {
                prompt += `\nCAREER GOALS:\n${profile.goal}\n`;
            }

            // Build profile data object to include
            const profileData = {
                userFirstName: profile.firstName,
                userLastName: profile.lastName,
                userOccupation: profile.profession || '',
                userGoals: profile.goal
                    ? (Array.isArray(profile.goal)
                        ? profile.goal
                        : profile.goal.split(',').map(g => g.trim()).filter(g => g))
                    : []
            };

            // Add experiences if requested
            if (includeExperiences && userExperiences.length > 0) {
                profileData.experiences = userExperiences;
                prompt += `\nWORK EXPERIENCES: See JSON data below\n`;
            }

            // Add stories if requested
            const behavioralStories = JSON.parse(localStorage.getItem('behavioralStories') || '[]');
            if (includeStories && behavioralStories.length > 0) {
                profileData.stories = behavioralStories;
                prompt += `\nSTAR STORIES: See JSON data below\n`;
            }

            // Add portfolio if requested
            if (includePortfolio && userPortfolioProjects.length > 0) {
                profileData.portfolio = userPortfolioProjects;
                prompt += `\nPORTFOLIO PROJECTS: See JSON data below\n`;
            }

            // Add selected job opportunity if provided
            if (selectedJob) {
                profileData.targetJobOpportunity = selectedJob;
                prompt += `\nTARGET JOB OPPORTUNITY: See JSON data below\n`;
            }

            // Add JSON data
            prompt += `\n${'='.repeat(80)}\nCOMPLETE PROFILE DATA (JSON):\n${'='.repeat(80)}\n\n`;
            prompt += JSON.stringify(profileData, null, 2);

            prompt += `\n\n${'='.repeat(80)}\n`;

            if (assetType === 'interview-prep') {
                // Closing instructions for interview prep
                prompt += `Please use this career profile data to generate ${itemCount} ${interviewType === 'behavioral' ? 'behavioral' : 'technical'} interview questions with suggested answers.`;
                if (selectedJob) {
                    prompt += ` Remember to incorporate ${selectedJob.company}'s specific tools, practices, and cultural values (such as leadership principles or core values) into the questions.`;
                }
                prompt += ` For each question, provide:\n`;
                prompt += `1. The interview question\n`;
                prompt += `2. Key points to cover in the answer\n`;
                prompt += `3. A sample response using the candidate's experience from the profile data\n`;
                if (interviewType === 'behavioral') {
                    prompt += `4. STAR format breakdown (Situation, Task, Action, Result) where applicable\n`;
                }
            } else {
                // Closing instructions for other asset types
                prompt += `Please use this career profile data to generate a compelling ${assetTypeNames[assetType]}.`;
                if (selectedJob) {
                    prompt += ` Make sure to tailor the content specifically for the ${selectedJob.title} position at ${selectedJob.company}, incorporating their cultural values and technical requirements.`;
                }
            }

            if (additionalContext) {
                prompt += ` Pay special attention to the additional context provided above.`;
            }
            prompt += `\n${'='.repeat(80)}`;

            return prompt;
        }

        function generateAndCopyPrompt() {
            const prompt = buildPromptText();

            // Copy to clipboard
            navigator.clipboard.writeText(prompt).then(() => {
                // Show success message
                const successMsg = document.getElementById('promptCopiedMessage');
                successMsg.style.display = 'block';

                // Close modal after 1.5 seconds
                setTimeout(() => {
                    closePromptBuilder();
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy prompt:', err);
                alert('Failed to copy prompt to clipboard. Please try again.');
            });
        }

        function downloadPrompt() {
            const prompt = buildPromptText();

            // Get profile and asset type for filename
            const profile = loadProfile();
            const assetType = document.getElementById('promptAssetType').value;

            // Create timestamp (YYYY-MM-DD-HHMMSS format)
            const now = new Date();
            const timestamp = now.getFullYear() +
                '-' + String(now.getMonth() + 1).padStart(2, '0') +
                '-' + String(now.getDate()).padStart(2, '0') +
                '-' + String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0') +
                String(now.getSeconds()).padStart(2, '0');

            // Create filename: cleansheet-prompt-[asset-type]-[name]-[timestamp].txt
            const assetTypeSlug = assetType.replace(/-/g, '_');
            const nameSlug = `${profile.firstName}_${profile.lastName}`.toLowerCase().replace(/\s+/g, '_');
            const filename = `cleansheet-prompt-${assetTypeSlug}-${nameSlug}-${timestamp}.txt`;

            // Create download
            const promptBlob = new Blob([prompt], { type: 'text/plain' });
            const url = URL.createObjectURL(promptBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // Show success message
            const successMsg = document.getElementById('promptCopiedMessage');
            successMsg.innerHTML = '<i class="ph ph-check-circle" style="margin-right: 6px;"></i>Prompt downloaded successfully!';
            successMsg.style.display = 'block';

            // Hide message after 2 seconds
            setTimeout(() => {
                successMsg.style.display = 'none';
                successMsg.innerHTML = '<i class="ph ph-check-circle" style="margin-right: 6px;"></i>Prompt copied to clipboard!';
            }, 2000);
        }

        function attachPromptToJob() {
            // Check if button is disabled
            const attachButton = document.getElementById('attachPromptButton');
            if (attachButton.disabled) {
                alert('Please select a job opportunity first.');
                return;
            }

            // Get selected job
            const jobOpportunitySelect = document.getElementById('promptJobOpportunity');
            const selectedJobIndex = jobOpportunitySelect.value;

            if (selectedJobIndex === '') {
                alert('Please select a job opportunity first.');
                return;
            }

            // Get the actual job from userJobs array (filtered for active jobs)
            const activeJobs = userJobs.filter(job =>
                job.status !== 'rejected' && job.status !== 'not-interested'
            );
            const selectedJob = activeJobs[parseInt(selectedJobIndex)];

            if (!selectedJob) {
                alert('Selected job not found.');
                return;
            }

            // Build the prompt
            const prompt = buildPromptText();

            // Get asset type for labeling
            const assetType = document.getElementById('promptAssetType').value;
            const assetTypeNames = {
                'cover-letter': 'Cover Letter',
                'resume': 'Resume',
                'linkedin-summary': 'LinkedIn Summary',
                'interview-prep': 'Interview Preparation',
                'networking-email': 'Networking Email',
                'personal-statement': 'Personal Statement'
            };

            // Create timestamp
            const now = new Date();
            const timestamp = now.toISOString();

            // Build asset type display name with interview type if applicable
            let displayName = assetTypeNames[assetType];
            if (assetType === 'interview-prep') {
                const interviewType = document.getElementById('interviewType').value;
                const itemCount = document.getElementById('itemCount').value;
                const interviewTypeLabel = interviewType === 'behavioral' ? 'Behavioral' : 'Technical';
                displayName = `${interviewTypeLabel} Interview Preparation (${itemCount} items)`;
            }

            // Create prompt attachment object
            const promptAttachment = {
                id: Date.now().toString(),
                assetType: assetType,
                assetTypeName: displayName,
                prompt: prompt,
                timestamp: timestamp,
                dateCreated: new Date().toLocaleDateString(),
                timeCreated: new Date().toLocaleTimeString()
            };

            // Store additional metadata for interview prep
            if (assetType === 'interview-prep') {
                promptAttachment.interviewType = document.getElementById('interviewType').value;
                promptAttachment.itemCount = document.getElementById('itemCount').value;
            }

            // Find the job in the original userJobs array and attach the prompt
            const jobIndex = userJobs.findIndex(job =>
                job.title === selectedJob.title &&
                job.company === selectedJob.company &&
                job.location === selectedJob.location
            );

            if (jobIndex === -1) {
                alert('Could not attach prompt to job.');
                return;
            }

            // Initialize attachedPrompts array if it doesn't exist
            if (!userJobs[jobIndex].attachedPrompts) {
                userJobs[jobIndex].attachedPrompts = [];
            }

            // Add the prompt attachment
            userJobs[jobIndex].attachedPrompts.push(promptAttachment);

            // Save to localStorage
            saveUserJobs();

            // Update currentJobDetail if this is the job being viewed
            if (currentJobDetail &&
                currentJobDetail.title === selectedJob.title &&
                currentJobDetail.company === selectedJob.company &&
                currentJobDetail.location === selectedJob.location) {
                // Update currentJobDetail with the new prompt
                currentJobDetail = userJobs[jobIndex];

                // Refresh the prompts display in the job detail modal
                populateJobApplicationMaterials(currentJobDetail);
            }

            // Show success message
            const successMsg = document.getElementById('promptCopiedMessage');
            successMsg.innerHTML = `<i class="ph ph-check-circle" style="margin-right: 6px;"></i>Prompt attached to ${selectedJob.title} at ${selectedJob.company}!`;
            successMsg.style.display = 'block';

            // Hide message and close modal after 2 seconds
            setTimeout(() => {
                successMsg.style.display = 'none';
                successMsg.innerHTML = '<i class="ph ph-check-circle" style="margin-right: 6px;"></i>Prompt copied to clipboard!';
                closePromptBuilder();
            }, 2000);
        }

        function updateProfileDisplay(profile) {
            // Update profile name in dropdown
            document.getElementById('profileName').textContent = `${profile.firstName} ${profile.lastName}`;

            // Update profile role in dropdown
            document.getElementById('profileRole').textContent = profile.profession || 'No profession set';

            // Update profile initials in avatar
            const initials = `${profile.firstName.charAt(0)}${profile.lastName.charAt(0)}`.toUpperCase();
            document.getElementById('profileInitials').textContent = initials;

            // Update welcome message with first name
            const welcomeMsg = document.getElementById('welcomeMessage');
            if (welcomeMsg) {
                welcomeMsg.textContent = `Welcome, ${profile.firstName}!`;
            }
        }

        // Initialize profile on page load
        function initializeProfile() {
            const profile = loadProfile();
            updateProfileDisplay(profile);
        }

        // Refresh mindmap with updated profile data
        function refreshMindmap() {
            // Clear existing mindmap
            d3.select('#canvas-mindmap').selectAll('*').remove();

            // Reinitialize with current persona
            initializeMindmap(currentPersona);
        }

        function openSettings() {
            alert('Settings coming soon! This will allow you to configure preferences, notifications, privacy settings, and application behavior.');
            document.getElementById('profileDropdown').classList.remove('active');
        }

        // Example Profiles Data
        const exampleProfiles = {
            'career-changer': {
                "userFirstName":"Marcus",
                "userLastName":"Thompson",
                "userOccupation":"Store Manager",
                "userGoals":"Transition from retail management into business analytics or operations management roles in tech companies.",
                "goals": [
                    {
                        "title": "Complete Google Data Analytics Professional Certificate",
                        "targetDate": "2025-06-30",
                        "category": "Education & Certifications",
                        "milestones": ["Finish Coursera enrollment", "Complete 3 courses by March", "Build capstone project", "Earn certificate"],
                        "status": "In Progress",
                        "progress": 45,
                        "currentMilestone": "Complete 3 courses by March",
                        "completedMilestones": ["Finish Coursera enrollment"],
                        "smart": {
                            "specific": "Complete all 8 courses in the Google Data Analytics Professional Certificate program on Coursera, including hands-on projects and the capstone",
                            "measurable": "Track completion of 8 courses, pass all graded assignments with 80%+ scores, complete capstone project, earn certificate",
                            "achievable": "Allocate 8-10 hours per week, leverage existing Excel skills, use retail data from current role for practice exercises",
                            "relevant": "Essential credential for transitioning from retail management to business analytics roles, demonstrates commitment to data-driven decision making",
                            "timebound": "Complete by June 30, 2025 (6 months, ~1.3 courses per month)"
                        },
                        "metrics": {
                            "coursesCompleted": 3,
                            "coursesTotal": 8,
                            "hoursInvested": 67,
                            "averageGrade": 87
                        }
                    },
                    {
                        "title": "Build 3 business analytics portfolio projects using real retail data",
                        "targetDate": "2025-08-31",
                        "category": "Portfolio Development",
                        "milestones": ["Sales forecasting model", "Customer segmentation analysis", "Inventory optimization dashboard"],
                        "status": "In Progress",
                        "progress": 33,
                        "currentMilestone": "Sales forecasting model",
                        "completedMilestones": [],
                        "smart": {
                            "specific": "Create three distinct analytics projects using anonymized retail data: (1) Sales forecasting using time-series analysis, (2) Customer segmentation with clustering algorithms, (3) Interactive Power BI inventory optimization dashboard",
                            "measurable": "Each project must include documentation, code/formulas, visualizations, insights, and measurable business impact. Host code on GitHub, publish dashboards online",
                            "achievable": "Use data from current Store Manager role (with proper anonymization), leverage Google certificate skills, dedicate weekends to development",
                            "relevant": "Portfolio projects demonstrate practical application of analytics skills and domain expertise in retail, addressing common interview case studies",
                            "timebound": "Complete by August 31, 2025 (one project every 2 months)"
                        },
                        "metrics": {
                            "projectsCompleted": 1,
                            "projectsTotal": 3,
                            "githubCommits": 47,
                            "portfolioViews": 0
                        }
                    },
                    {
                        "title": "Land Business Analyst or Operations Analyst role at tech company",
                        "targetDate": "2025-12-31",
                        "category": "Career Transition",
                        "milestones": ["Apply to 50+ positions", "Get 5+ interviews", "Receive offer", "Negotiate compensation"],
                        "status": "Not Started",
                        "progress": 0,
                        "currentMilestone": "Apply to 50+ positions",
                        "completedMilestones": [],
                        "smart": {
                            "specific": "Secure full-time Business Analyst or Operations Analyst position at a technology company (software, cloud, e-commerce) with minimum $85K salary and growth opportunities",
                            "measurable": "Apply to 50+ relevant positions, maintain 10%+ interview conversion rate, receive at least 2 offers, negotiate compensation package including base salary, benefits, and equity",
                            "achievable": "Leverage completed Google certificate, portfolio projects, 6+ years management experience, and transferable skills in operations and data analysis",
                            "relevant": "This is the primary career transition goal that all education and portfolio development activities support, enabling long-term career growth in analytics/tech",
                            "timebound": "Secure offer by December 31, 2025 (begin active job search after portfolio completion in September 2025)"
                        },
                        "metrics": {
                            "applicationsSubmitted": 0,
                            "applicationsTarget": 50,
                            "interviewsScheduled": 0,
                            "interviewsTarget": 5,
                            "offersReceived": 0,
                            "networkingConnections": 0
                        }
                    }
                ],
                "portfolio": [
                    {
                        "name": "Power BI Sales Performance Dashboard",
                        "description": "Interactive dashboard analyzing 3 years of retail sales data across 15 store locations. Features KPI tracking, trend analysis, YoY comparisons, and predictive forecasting using Excel and Power BI.",
                        "link": "",
                        "technologies": ["Power BI", "Excel", "DAX", "SQL"],
                        "skills": ["Data Visualization", "Business Intelligence", "Statistical Analysis", "KPI Development"],
                        "competencies": ["Data Analysis", "Business Strategy", "Performance Management"]
                    },
                    {
                        "name": "Excel VBA Inventory Optimization System",
                        "description": "Automated inventory management system using Excel VBA that analyzes sales patterns, calculates optimal stock levels, and generates reorder recommendations. Reduced overstock by 22% and stockouts by 35%.",
                        "link": "",
                        "technologies": ["Excel VBA", "Macros", "Pivot Tables"],
                        "skills": ["Programming", "Process Automation", "Data Analysis", "Problem Solving"],
                        "competencies": ["Process Optimization", "Analytical Thinking", "Innovation"]
                    }
                ],
                "jobOpportunities": [
                    {
                        "title": "Business Analyst",
                        "company": "Microsoft",
                        "location": "Redmond, WA",
                        "url": "https://careers.microsoft.com",
                        "status": "applied",
                        "closeDate": "2025-02-28",
                        "salary": "$85K-$110K",
                        "notes": "Applied via company website. Recruiter reached out for screening call next week.",
                        "todos": [
                            {"id": 1, "task": "Research Microsoft's retail partnerships", "date": "2025-01-25", "completed": false},
                            {"id": 2, "task": "Prepare STAR stories for phone screening", "date": "2025-01-27", "completed": false},
                            {"id": 3, "task": "Review SQL and data analysis concepts", "date": "2025-01-26", "completed": false}
                        ],
                        "skills": ["SQL", "Excel", "Data Analysis", "Business Strategy"],
                        "competencies": ["Analytical Thinking", "Stakeholder Management", "Project Management"]
                    },
                    {
                        "title": "Operations Analyst",
                        "company": "Amazon",
                        "location": "Seattle, WA",
                        "url": "https://amazon.jobs",
                        "status": "interviewing",
                        "closeDate": "2025-02-15",
                        "salary": "$90K-$115K",
                        "notes": "First round interview completed. Waiting for second round scheduling.",
                        "todos": [
                            {"id": 1, "task": "Prepare for behavioral interview round", "date": "2025-01-22", "completed": true},
                            {"id": 2, "task": "Research Amazon's Leadership Principles", "date": "2025-01-20", "completed": true},
                            {"id": 3, "task": "Prepare case study on supply chain optimization", "date": "2025-01-28", "completed": false},
                            {"id": 4, "task": "Send thank you email to interviewers", "date": "2025-01-23", "completed": false}
                        ],
                        "skills": ["Data Analysis", "Process Improvement", "SQL", "Python"],
                        "competencies": ["Operations Management", "Problem Solving", "Strategic Thinking"]
                    },
                    {
                        "title": "Retail Analytics Specialist",
                        "company": "Target Corporate",
                        "location": "Minneapolis, MN",
                        "url": "https://corporate.target.com/careers",
                        "status": "interested",
                        "closeDate": "2025-03-15",
                        "salary": "$75K-$95K",
                        "notes": "Internal posting. Spoke with hiring manager at last company meeting. Strong referral from district manager.",
                        "todos": [
                            {"id": 1, "task": "Update resume highlighting analytics projects", "date": "2025-01-30", "completed": false},
                            {"id": 2, "task": "Schedule informational interview with current analyst", "date": "2025-02-01", "completed": false}
                        ],
                        "skills": ["Retail Operations", "Data Analysis", "Power BI", "Excel"],
                        "competencies": ["Retail Domain Expertise", "Data-Driven Decision Making", "Business Strategy"]
                    },
                    {
                        "title": "Data Analyst",
                        "company": "Walmart Global Tech",
                        "location": "Bentonville, AR (Remote)",
                        "url": "https://careers.walmart.com",
                        "status": "interested",
                        "closeDate": "2025-03-31",
                        "salary": "$80K-$105K",
                        "notes": "Role focuses on retail analytics and supply chain optimization. Aligns perfectly with my retail background.",
                        "todos": [
                            {"id": 1, "task": "Complete Python for Data Analysis course", "date": "2025-02-10", "completed": false},
                            {"id": 2, "task": "Build retail forecasting project for portfolio", "date": "2025-02-20", "completed": false}
                        ],
                        "skills": ["Python", "SQL", "Tableau", "Statistics"],
                        "competencies": ["Data Analysis", "Forecasting", "Retail Operations"]
                    }
                ],
                "experiences":[{"organizationName":"Target Corporation","role":"Store Manager","location":"Minneapolis, MN","startDate":"2019-03-01","endDate":"","description":"Lead store operations for high-volume location with 85+ team members. Manage P&L, inventory, staffing, and customer experience initiatives. Increased sales by 18% and improved employee retention by 25%.","technologies":[{"name":"Excel","type":"Core"},{"name":"Power BI","type":"Peripheral"},{"name":"Workday","type":"Peripheral"},{"name":"Square POS","type":"Core"},{"name":"Kronos","type":"Peripheral"}],"keySkills":["P&L Management","Team Leadership","Inventory Management","Customer Service","Data-Driven Decision Making","Conflict Resolution","Performance Management"],"competencies":["Operations Management","Strategic Planning","Financial Analysis","Process Improvement","Change Management"],"projectTypes":["Operational Efficiency","Team Development","Sales Growth","Customer Experience Enhancement"],"internalStakeholders":["District Manager","HR Business Partner","Regional Operations Team","Loss Prevention"],"externalStakeholders":["Customers","Vendors","Local Community Organizations"],"achievements":["Increased store revenue by 18% year-over-year","Reduced employee turnover by 25%","Achieved top 10% ranking in district for customer satisfaction","Led successful holiday season with record-breaking sales"]},{"organizationName":"Target Corporation","role":"Assistant Store Manager","location":"St. Paul, MN","startDate":"2016-06-01","endDate":"2019-02-28","description":"Supported store manager in daily operations, focusing on merchandising, inventory control, and team development. Managed team of 30+ in-store fulfillment and sales associates.","technologies":[{"name":"Excel","type":"Core"},{"name":"Workday","type":"Peripheral"},{"name":"Square POS","type":"Core"}],"keySkills":["Team Leadership","Merchandising","Inventory Control","Training & Development","Problem Solving"],"competencies":["Operations Management","People Management","Process Optimization"],"projectTypes":["Operational Efficiency","Team Development","Inventory Management"],"internalStakeholders":["Store Manager","Department Supervisors","HR Team"],"externalStakeholders":["Customers","Delivery Partners"],"achievements":["Reduced inventory shrinkage by 15%","Implemented new onboarding program reducing training time by 20%","Promoted to Store Manager after 2.5 years"]},{"organizationName":"Best Buy","role":"Department Supervisor","location":"Bloomington, MN","startDate":"2014-01-15","endDate":"2016-05-31","description":"Supervised electronics department with team of 12 sales associates. Managed inventory, scheduling, and sales performance. Achieved top sales performance in region.","technologies":[{"name":"Excel","type":"Core"},{"name":"Retail Management Systems","type":"Core"}],"keySkills":["Sales Management","Team Leadership","Customer Service","Product Knowledge","Performance Coaching"],"competencies":["Team Leadership","Sales Strategy","Customer Experience Design"],"projectTypes":["Sales Growth","Team Development","Customer Experience Enhancement"],"internalStakeholders":["Assistant Store Manager","Other Department Supervisors","Sales Team"],"externalStakeholders":["Customers","Electronics Vendors"],"achievements":["Exceeded sales targets by average of 25% quarterly","Developed 3 team members who were promoted to leadership roles","Won 'Department of the Year' award 2015"]}],"stories":[{"title":"Crisis Management During System Outage","experienceIndex":0,"experienceName":"Store Manager - Target Corporation","situation":"Our store's POS system crashed during Black Friday with over 300 customers in the store and lines at every register.","task":"Maintain customer satisfaction, protect revenue, and keep my 85-person team calm during the crisis.","action":"Activated backup manual processing, assigned team roles, personally communicated with customers, set up dedicated issue station, and empowered team leads to make decisions.","result":"Processed $150K in manual transactions with zero errors, maintained 4.2/5 satisfaction score, received district commendation and three positive customer reviews.","competencies":["Crisis Management","Leadership","Customer Service","Problem Solving"],"createdAt":"2025-01-15T10:00:00.000Z","updatedAt":"2025-01-15T10:00:00.000Z"},{"title":"Leading Digital Transformation","experienceIndex":1,"experienceName":"Assistant Store Manager - Target Corporation","situation":"Corporate mandated new in-store fulfillment technology but team had limited tech experience and high resistance to change.","task":"Lead implementation, train 30+ associates, achieve 95% on-time pickup rate within 60 days.","action":"Created phased training program, identified champions, gathered daily feedback, created visual aids, tracked metrics daily, celebrated wins publicly.","result":"Achieved 97% rate in 45 days (beat target early), zero customer complaints, became model for 8 other stores, two champions promoted.","competencies":["Change Management","Training & Development","Project Management","Technology Adoption"],"createdAt":"2025-01-15T10:10:00.000Z","updatedAt":"2025-01-15T10:10:00.000Z"},{"title":"Reducing Employee Turnover Through Data","experienceIndex":2,"experienceName":"Department Supervisor - Best Buy","situation":"Electronics department had 45% annual turnover vs 32% store average, costing significant money in training and lost sales knowledge.","task":"Reduce turnover by 10+ percentage points within one year while maintaining sales performance.","action":"Analyzed exit interviews and team surveys, identified root causes (scheduling conflicts, lack of growth opportunities), implemented flexible scheduling system, created advancement paths with skills training, started monthly one-on-ones, launched peer mentorship program.","result":"Reduced turnover to 29% in 10 months (16 point improvement), saved approximately $50K in training costs, improved team engagement scores from 65% to 82%, promoted 3 team members to leadership roles, approach became model for other departments.","competencies":["Data Analysis","Process Improvement","People Management","Strategic Planning"],"createdAt":"2025-01-15T10:05:00.000Z","updatedAt":"2025-01-15T10:05:00.000Z"}]},
            'product-manager': {
                "userFirstName":"Sarah",
                "userLastName":"Chen",
                "userOccupation":"Senior Research Scientist",
                "userGoals":"Leverage analytical chemistry expertise to transition into data science and computational chemistry roles in pharmaceutical or biotech industries.",
                "goals": [
                    {
                        "title": "Complete Machine Learning Specialization and apply to pharmaceutical R&D",
                        "targetDate": "2025-07-31",
                        "category": "Skills Development",
                        "milestones": ["Finish Coursera ML courses", "Build 2 pharma-focused ML projects", "Present at company tech talk"],
                        "status": "In Progress",
                        "progress": 60,
                        "currentMilestone": "Build 2 pharma-focused ML projects",
                        "completedMilestones": ["Finish Coursera ML courses"],
                        "smart": {
                            "specific": "Complete Andrew Ng's Machine Learning Specialization (3 courses), build two pharmaceutical-focused ML projects (drug response prediction and molecular property prediction), present findings at Moderna's internal tech talk",
                            "measurable": "Complete all 3 courses with passing grades, build and document 2 ML models with >85% accuracy, deliver 30-minute presentation to 20+ attendees",
                            "achievable": "Leverage existing Python skills and chemistry domain knowledge, dedicate 6-8 hours weekly, use publicly available pharma datasets from ChEMBL and PubChem",
                            "relevant": "ML skills are increasingly essential for computational chemistry and data science roles in pharma, demonstrates initiative to expand beyond traditional analytical chemistry",
                            "timebound": "Complete by July 31, 2025 (7 months total: 3 months for courses, 3 months for projects, 1 month for presentation prep)"
                        },
                        "metrics": {
                            "coursesCompleted": 3,
                            "coursesTotal": 3,
                            "projectsCompleted": 1,
                            "projectsTotal": 2,
                            "presentationDate": "2025-07-15",
                            "modelAccuracy": 87
                        }
                    },
                    {
                        "title": "Publish computational chemistry paper in peer-reviewed journal",
                        "targetDate": "2025-09-30",
                        "category": "Research & Publications",
                        "milestones": ["Complete data analysis", "Write manuscript", "Submit to journal", "Address reviewer comments"],
                        "status": "In Progress",
                        "progress": 55,
                        "currentMilestone": "Write manuscript",
                        "completedMilestones": ["Complete data analysis"],
                        "smart": {
                            "specific": "Author and publish peer-reviewed paper on 'Machine Learning Approaches for HPLC Method Development in mRNA Analysis' in Journal of Pharmaceutical Sciences or similar Q1 journal",
                            "measurable": "Complete manuscript (5,000-7,000 words), submit to target journal, respond to peer review within 2 weeks, achieve acceptance for publication",
                            "achievable": "Leverage existing HPLC automation work and ML projects, collaborate with Moderna colleagues for co-authorship, allocate 10 hours weekly to writing",
                            "relevant": "Publications demonstrate thought leadership in computational chemistry, strengthen PhD credentials, significantly enhance competitiveness for data science roles in pharma",
                            "timebound": "Submit by June 30, achieve publication by September 30, 2025 (accounting for 8-12 week peer review cycle)"
                        },
                        "metrics": {
                            "manuscriptProgress": 65,
                            "wordsWritten": 3850,
                            "targetWords": 6000,
                            "coAuthors": 3,
                            "figuresCompleted": 4,
                            "figuresTotal": 6
                        }
                    },
                    {
                        "title": "Transition to Data Scientist or Computational Chemist role",
                        "targetDate": "2026-03-31",
                        "category": "Career Transition",
                        "milestones": ["Network with 10 data scientists in pharma", "Apply to 30+ positions", "Get 3+ interviews", "Receive offer"],
                        "status": "Not Started",
                        "progress": 0,
                        "currentMilestone": "Network with 10 data scientists in pharma",
                        "completedMilestones": [],
                        "smart": {
                            "specific": "Secure Senior Data Scientist or Computational Chemist position at pharmaceutical or biotech company (Pfizer, Moderna, BioNTech, Merck, Genentech) with minimum $140K salary, focusing on ML applications in drug discovery",
                            "measurable": "Network with 10+ data scientists through informational interviews, apply to 30+ relevant positions, achieve 10%+ interview rate, receive at least 2 competitive offers",
                            "achievable": "Leverage PhD, 8+ years pharma experience, ML specialization, published paper, strong Python portfolio, and internal Moderna network for referrals",
                            "relevant": "This is the culminating career goal that leverages all skill development and publication efforts, enabling transition from wet-lab analytical chemistry to computational roles with higher impact and compensation",
                            "timebound": "Begin networking September 2025, active job search January 2026, accept offer by March 31, 2026 (allows for 3-month search after publication)"
                        },
                        "metrics": {
                            "networkingMeetings": 0,
                            "networkingTarget": 10,
                            "applicationsSubmitted": 0,
                            "applicationsTarget": 30,
                            "interviewsScheduled": 0,
                            "interviewsTarget": 3,
                            "offersReceived": 0,
                            "linkedInConnections": 847
                        }
                    }
                ],
                "portfolio": [
                    {
                        "name": "Python HPLC Data Analysis Pipeline",
                        "description": "Automated data processing pipeline for high-performance liquid chromatography (HPLC) data. Uses Python, pandas, and scikit-learn for peak detection, integration, and quality assessment. Processes 100+ samples per run with 98% accuracy.",
                        "link": "https://github.com/sarahchen/hplc-analysis",
                        "technologies": ["Python", "pandas", "scikit-learn", "NumPy", "matplotlib", "SciPy"],
                        "skills": ["Data Processing", "Algorithm Development", "Scientific Computing", "Automation"],
                        "competencies": ["Data Science", "Analytical Chemistry", "Software Development"]
                    },
                    {
                        "name": "R Shiny Dashboard for Lab Metrics",
                        "description": "Interactive dashboard built with R Shiny for real-time monitoring of laboratory performance metrics. Tracks instrument uptime, sample throughput, quality control results, and generates automated reports. Reduced manual reporting time by 10 hours/week.",
                        "link": "https://github.com/sarahchen/lab-dashboard",
                        "technologies": ["R", "Shiny", "ggplot2", "dplyr", "tidyverse", "plotly"],
                        "skills": ["Data Visualization", "Dashboard Development", "Statistical Analysis", "Business Intelligence"],
                        "competencies": ["Data Analytics", "Process Improvement", "Technical Communication"]
                    }
                ],
                "jobOpportunities": [
                    {
                        "title": "Senior Data Scientist",
                        "company": "Pfizer",
                        "location": "Cambridge, MA",
                        "url": "https://pfizer.wd1.myworkdayjobs.com",
                        "status": "applied",
                        "closeDate": "2025-02-20",
                        "salary": "$140K-$170K",
                        "notes": "Applied through internal referral from former colleague. Role focuses on predictive modeling for drug discovery.",
                        "todos": [
                            {"id": 1, "task": "Prepare case study on pharma data analysis", "date": "2025-01-24", "completed": false},
                            {"id": 2, "task": "Review machine learning fundamentals", "date": "2025-01-23", "completed": true},
                            {"id": 3, "task": "Research Pfizer's AI/ML initiatives", "date": "2025-01-26", "completed": false}
                        ],
                        "skills": ["Python", "Machine Learning", "Statistical Analysis", "Data Visualization"],
                        "competencies": ["Data Science", "Pharmaceutical Domain Knowledge", "Scientific Research"]
                    },
                    {
                        "title": "Computational Chemist",
                        "company": "Moderna",
                        "location": "Cambridge, MA",
                        "url": "https://modernatx.com/careers",
                        "status": "interviewing",
                        "closeDate": "2025-02-10",
                        "salary": "$135K-$165K",
                        "notes": "Internal opportunity. Hiring manager is familiar with my mRNA work. Technical interview scheduled for next week.",
                        "todos": [
                            {"id": 1, "task": "Review molecular dynamics concepts", "date": "2025-01-21", "completed": true},
                            {"id": 2, "task": "Prepare presentation on HPLC automation project", "date": "2025-01-25", "completed": false},
                            {"id": 3, "task": "Practice Python coding exercises", "date": "2025-01-24", "completed": false},
                            {"id": 4, "task": "Send updated portfolio to hiring manager", "date": "2025-01-22", "completed": true}
                        ],
                        "skills": ["Python", "Molecular Modeling", "Data Analysis", "HPLC"],
                        "competencies": ["Computational Chemistry", "Scientific Computing", "Drug Development"]
                    },
                    {
                        "title": "Machine Learning Engineer - Drug Discovery",
                        "company": "BioNTech",
                        "location": "Mainz, Germany (Remote)",
                        "url": "https://biontech.de/careers",
                        "status": "interested",
                        "closeDate": "2025-03-01",
                        "salary": "€120K-€150K",
                        "notes": "Exciting opportunity to apply ML to mRNA drug discovery. Remote-friendly with occasional travel to Germany.",
                        "todos": [
                            {"id": 1, "task": "Complete deep learning specialization", "date": "2025-02-15", "completed": false},
                            {"id": 2, "task": "Build RNA structure prediction project", "date": "2025-02-28", "completed": false}
                        ],
                        "skills": ["Python", "TensorFlow", "PyTorch", "Machine Learning", "Bioinformatics"],
                        "competencies": ["Machine Learning", "Drug Discovery", "Computational Biology"]
                    },
                    {
                        "title": "Principal Data Analyst",
                        "company": "Merck",
                        "location": "Boston, MA",
                        "url": "https://jobs.merck.com",
                        "status": "interested",
                        "closeDate": "2025-03-15",
                        "salary": "$130K-$160K",
                        "notes": "Hybrid analytical/computational role supporting clinical trials. Strong fit for my chemistry and data science background.",
                        "todos": [
                            {"id": 1, "task": "Tailor resume for clinical trials experience", "date": "2025-02-05", "completed": false},
                            {"id": 2, "task": "Network with Merck data analysts on LinkedIn", "date": "2025-02-01", "completed": false}
                        ],
                        "skills": ["Statistical Analysis", "R", "Python", "Clinical Data", "Regulatory"],
                        "competencies": ["Data Analysis", "Clinical Research", "Regulatory Affairs"]
                    }
                ],
                "experiences":[{"organizationName":"Moderna Therapeutics","role":"Senior Research Scientist","location":"Cambridge, MA","startDate":"2020-09-01","endDate":"","description":"Lead analytical chemistry research for mRNA vaccine development. Design and execute complex analytical methods for quality control and process optimization. Collaborate with cross-functional teams on formulation development.","technologies":[{"name":"HPLC","type":"Core"},{"name":"Mass Spectrometry","type":"Core"},{"name":"Python","type":"Peripheral"},{"name":"R","type":"Peripheral"},{"name":"ChemDraw","type":"Core"},{"name":"LabVIEW","type":"Peripheral"},{"name":"JMP Statistical Software","type":"Core"},{"name":"Electronic Lab Notebook","type":"Core"},{"name":"MATLAB","type":"Peripheral"}],"keySkills":["Analytical Method Development","Data Analysis","Technical Writing","Problem Solving","Cross-Functional Collaboration","Quality Control","Statistical Analysis"],"competencies":["Scientific Research","Data Analytics","Technical Leadership","Regulatory Compliance","Project Management"],"projectTypes":["Research & Development","Method Validation","Process Optimization","Regulatory Submission"],"internalStakeholders":["Process Development Team","Quality Assurance","Regulatory Affairs","Manufacturing Operations","R&D Leadership"],"externalStakeholders":["FDA Reviewers","Equipment Vendors","Contract Research Organizations","Academic Collaborators"],"achievements":["Developed novel analytical method reducing testing time by 40%","Authored 6 peer-reviewed publications","Led successful FDA submission with zero deficiencies","Mentored 4 junior scientists","Received Moderna Innovation Award 2022"]},{"organizationName":"Pfizer Inc.","role":"Research Scientist","location":"Groton, CT","startDate":"2017-07-01","endDate":"2020-08-31","description":"Conducted analytical chemistry research supporting small molecule drug discovery. Developed and validated analytical methods for compound characterization. Collaborated with medicinal chemistry and biology teams.","technologies":[{"name":"HPLC","type":"Core"},{"name":"Mass Spectrometry","type":"Core"},{"name":"NMR Spectroscopy","type":"Core"},{"name":"ChemDraw","type":"Core"},{"name":"JMP Statistical Software","type":"Peripheral"},{"name":"Electronic Lab Notebook","type":"Core"}],"keySkills":["Analytical Chemistry","Method Development","Data Interpretation","Technical Documentation","Collaboration","Spectroscopy"],"competencies":["Scientific Research","Analytical Problem Solving","Technical Communication","Quality Systems"],"projectTypes":["Research & Development","Method Development","Compound Characterization"],"internalStakeholders":["Medicinal Chemistry Team","Biology Team","DMPK Group","Quality Control"],"externalStakeholders":["CROs","Equipment Vendors","Academic Partners"],"achievements":["Developed 15+ analytical methods for drug discovery compounds","Co-authored 4 scientific publications","Trained 8 new team members on analytical instrumentation","Contributed to 2 IND submissions"]},{"organizationName":"University of Connecticut","role":"Postdoctoral Research Associate","location":"Storrs, CT","startDate":"2015-08-01","endDate":"2017-06-30","description":"Conducted independent research in analytical chemistry. Developed novel mass spectrometry methods for metabolomics research. Mentored graduate and undergraduate students.","technologies":[{"name":"Mass Spectrometry","type":"Core"},{"name":"HPLC","type":"Core"},{"name":"R","type":"Peripheral"},{"name":"Python","type":"Peripheral"},{"name":"Origin","type":"Core"},{"name":"ChemDraw","type":"Core"}],"keySkills":["Research Design","Data Analysis","Scientific Writing","Grant Writing","Mentoring","Instrumentation"],"competencies":["Scientific Research","Independent Research","Technical Leadership","Academic Writing"],"projectTypes":["Research","Method Development","Publication"],"internalStakeholders":["Principal Investigator","Graduate Students","Department Faculty","Core Facility Staff"],"externalStakeholders":["Funding Agencies","Journal Editors","Scientific Community"],"achievements":["Published 5 first-author papers in high-impact journals","Secured $50K in independent research funding","Presented research at 3 international conferences","Mentored 6 students"]},{"organizationName":"University of California, Berkeley","role":"PhD Candidate","location":"Berkeley, CA","startDate":"2010-09-01","endDate":"2015-07-31","description":"Doctoral research in analytical chemistry focusing on mass spectrometry method development. Taught undergraduate chemistry labs and mentored undergraduates.","technologies":[{"name":"Mass Spectrometry","type":"Core"},{"name":"HPLC","type":"Core"},{"name":"MATLAB","type":"Peripheral"},{"name":"Origin","type":"Core"},{"name":"ChemDraw","type":"Core"}],"keySkills":["Research","Data Analysis","Scientific Writing","Teaching","Experimental Design"],"competencies":["Scientific Research","Critical Thinking","Technical Communication","Teaching"],"projectTypes":["Research","Teaching","Publication"],"internalStakeholders":["Thesis Advisor","Thesis Committee","Lab Members","Undergraduate Students"],"externalStakeholders":["Scientific Community","Funding Agencies"],"achievements":["Published 8 peer-reviewed papers","Received NSF Graduate Research Fellowship","Won best poster award at ACS National Meeting","Graduated with distinction"]}],"stories":[{"title":"FDA Submission with Zero Deficiencies","experienceIndex":0,"experienceName":"Senior Research Scientist - Moderna Therapeutics","situation":"Company needed to submit critical analytical data package for mRNA vaccine to FDA with extremely tight timeline during pandemic.","task":"Lead analytical characterization and compile comprehensive data package meeting all regulatory requirements within 6 weeks.","action":"Assembled cross-functional team, created detailed project plan, ran validation studies in parallel, implemented rigorous quality checks, coordinated with regulatory affairs, worked extended hours to meet deadline.","result":"Submitted complete package on time with zero deficiencies noted by FDA, contributing to accelerated approval. Received Innovation Award and became go-to person for regulatory submissions.","competencies":["Project Management","Regulatory Compliance","Technical Leadership","Attention to Detail"],"createdAt":"2025-01-15T10:00:00.000Z","updatedAt":"2025-01-15T10:00:00.000Z"},{"title":"Novel Method Reducing Testing Time 40%","experienceIndex":1,"experienceName":"Research Scientist - Pfizer Inc.","situation":"Standard HPLC method for small molecule purity testing took 45 minutes per sample, creating bottleneck in drug discovery workflow with 50+ daily samples.","task":"Develop faster analytical method without compromising data quality or regulatory requirements.","action":"Researched ultra-performance chromatography, designed new method using shorter column and optimized gradient, validated against existing method with 50+ test compounds, demonstrated equivalent performance with statistical analysis, trained discovery chemistry team.","result":"Reduced testing time to 27 minutes (40% improvement), increased daily throughput by 67%, maintained method robustness, published method in peer-reviewed journal with 200+ citations, approach adopted across Pfizer research sites.","competencies":["Innovation","Analytical Problem Solving","Technical Expertise","Process Optimization"],"createdAt":"2025-01-15T10:05:00.000Z","updatedAt":"2025-01-15T10:05:00.000Z"},{"title":"Mentoring Graduate Student to First Publication","experienceIndex":2,"experienceName":"Postdoctoral Research Associate - University of Connecticut","situation":"First-year graduate student struggled with mass spectrometry techniques and data interpretation, lacking confidence and risking dropping out of the program.","task":"Mentor student to proficiency and guide them to their first publication while managing my own research timeline.","action":"Created structured learning plan with weekly goals, scheduled regular coaching sessions, provided hands-on training on instrumentation, taught data analysis in R and Python, encouraged questions and independent thinking, gave progressively challenging projects, provided detailed feedback on writing, advocated for their work at lab meetings.","result":"Student became proficient in 5 months vs typical 10-12 months, contributed key results to collaborative study, gained confidence to present at departmental seminar, co-authored first-author publication in high-impact journal, continued to PhD with strong foundation. I was recognized with department mentorship award.","competencies":["Mentoring","Patience","Technical Communication","Leadership"],"createdAt":"2025-01-15T10:10:00.000Z","updatedAt":"2025-01-15T10:10:00.000Z"}]},
            'new-graduate': {
                "userFirstName":"Jamie",
                "userLastName":"Rodriguez",
                "userOccupation":"Software Engineering Intern",
                "userGoals":"Launch career in software development or cloud engineering, building practical skills while contributing to meaningful projects.",
                "goals": [
                    {
                        "title": "Land first full-time Software Engineer role at tech company",
                        "targetDate": "2025-05-31",
                        "category": "Career Launch",
                        "milestones": ["Apply to 100+ positions", "Get 10+ interviews", "Receive 2+ offers", "Accept position"],
                        "status": "In Progress",
                        "progress": 35,
                        "currentMilestone": "Get 10+ interviews",
                        "completedMilestones": ["Apply to 100+ positions"],
                        "smart": {
                            "specific": "Secure full-time Software Engineer or Cloud Engineer position at technology company (Google, Microsoft, AWS, Shopify, or similar) with minimum $100K salary, offering mentorship, growth opportunities, and modern tech stack",
                            "measurable": "Apply to 100+ relevant positions, achieve 10%+ interview conversion rate, receive at least 2 competitive offers with written compensation details, compare total compensation packages",
                            "achievable": "Leverage CS degree (3.7 GPA), internship experience, portfolio projects, open-source contributions, campus recruiting connections, and active job search during graduation semester",
                            "relevant": "First full-time role establishes career foundation and trajectory, provides income stability, offers structured learning environment for new graduate transitioning from academic to professional software development",
                            "timebound": "Accept offer by May 31, 2025 (before graduation), ideally start June/July 2025, application period January-April 2025"
                        },
                        "metrics": {
                            "applicationsSubmitted": 112,
                            "applicationsTarget": 100,
                            "phoneScreens": 14,
                            "technicalInterviews": 6,
                            "onsiteInterviews": 2,
                            "offersReceived": 0,
                            "targetOffers": 2
                        }
                    },
                    {
                        "title": "Contribute to open-source project and build network",
                        "targetDate": "2025-04-30",
                        "category": "Professional Development",
                        "milestones": ["Identify project", "Make 10+ contributions", "Connect with 5 maintainers", "Present at meetup"],
                        "status": "In Progress",
                        "progress": 70,
                        "currentMilestone": "Present at meetup",
                        "completedMilestones": ["Identify project", "Make 10+ contributions", "Connect with 5 maintainers"],
                        "smart": {
                            "specific": "Contribute 10+ meaningful code commits to React or ROS open-source project, build relationships with 5 project maintainers, present 'Getting Started with Open Source' talk at Austin Python/JavaScript meetup",
                            "measurable": "Track GitHub contributions (issues, PRs, code reviews), document merged pull requests, schedule 5 virtual coffee chats with maintainers, deliver 20-minute presentation to 30+ attendees",
                            "achievable": "Leverage existing React and ROS experience from portfolio projects, dedicate 5-8 hours weekly to OSS, attend local meetups monthly, join project Slack/Discord communities",
                            "relevant": "OSS contributions demonstrate real-world collaboration skills, build public technical profile, provide talking points for interviews, expand professional network beyond campus, establish online presence",
                            "timebound": "Complete by April 30, 2025 (before graduation): contributions by March 31, networking ongoing, presentation in April"
                        },
                        "metrics": {
                            "contributionsCompleted": 13,
                            "contributionsTarget": 10,
                            "pullRequestsMerged": 8,
                            "issuesClosed": 5,
                            "maintainerConnections": 5,
                            "meetupPresentation": null,
                            "githubStars": 47
                        }
                    },
                    {
                        "title": "Learn cloud architecture and earn AWS Solutions Architect certification",
                        "targetDate": "2025-08-31",
                        "category": "Skills Development",
                        "milestones": ["Complete AWS training", "Build 3 cloud projects", "Pass certification exam"],
                        "status": "Not Started",
                        "progress": 0,
                        "currentMilestone": "Complete AWS training",
                        "completedMilestones": [],
                        "smart": {
                            "specific": "Earn AWS Certified Solutions Architect - Associate certification (SAA-C03), complete AWS training through A Cloud Guru or AWS SkillBuilder, build three production-grade cloud projects (serverless API, containerized app, infrastructure-as-code deployment)",
                            "measurable": "Complete 40+ hours AWS training courses, pass practice exams with 80%+ scores, build and document 3 cloud projects with CI/CD pipelines, pass certification exam with 720+ score",
                            "achievable": "Leverage software engineering fundamentals and Docker experience, use AWS free tier for practice, dedicate 10 hours weekly post-graduation with full-time job income for certification costs ($150)",
                            "relevant": "Cloud skills are essential for modern software engineering roles, AWS certification significantly increases marketability and salary potential, aligns with interest in Cloud Engineer career path",
                            "timebound": "Complete by August 31, 2025 (3 months post-graduation): training by June 30, projects by July 31, certification by August 31"
                        },
                        "metrics": {
                            "trainingHoursCompleted": 0,
                            "trainingHoursTarget": 40,
                            "practiceExamScore": 0,
                            "projectsCompleted": 0,
                            "projectsTarget": 3,
                            "certificationScheduled": false,
                            "awsServicesUsed": 0
                        }
                    }
                ],
                "portfolio": [
                    {
                        "name": "E-Commerce Web Application (MERN Stack)",
                        "description": "Full-stack e-commerce platform with product catalog, shopping cart, user authentication, payment processing (Stripe), and admin dashboard. Built with React, Node.js, Express, and MongoDB. Deployed on AWS with CI/CD pipeline.",
                        "link": "https://github.com/jrodriguez/ecommerce-platform",
                        "technologies": ["React", "Node.js", "Express", "MongoDB", "Stripe API", "AWS", "Docker", "Git"],
                        "skills": ["Full Stack Development", "API Design", "Database Design", "Authentication", "Payment Integration"],
                        "competencies": ["Software Engineering", "Web Development", "Cloud Deployment"]
                    },
                    {
                        "name": "RoboCup Autonomous Robot Navigation System",
                        "description": "Computer vision and autonomous navigation system for RoboCup competition robot. Implemented using Python, ROS, and OpenCV. Features real-time object detection, path planning, and obstacle avoidance. Led team to 3rd place finish.",
                        "link": "https://github.com/ut-robotics/robocup-2024",
                        "technologies": ["Python", "ROS", "OpenCV", "Linux", "C++", "Git"],
                        "skills": ["Computer Vision", "Robotics", "Algorithm Development", "Team Leadership", "Systems Integration"],
                        "competencies": ["Technical Leadership", "Problem Solving", "Project Management"]
                    }
                ],
                "jobOpportunities": [
                    {
                        "title": "Junior Software Engineer",
                        "company": "Google",
                        "location": "Austin, TX",
                        "url": "https://careers.google.com",
                        "status": "applied",
                        "closeDate": "2025-02-15",
                        "salary": "$110K-$135K",
                        "notes": "Applied through campus recruiting. Resume passed initial screening. Waiting for response on coding challenge.",
                        "todos": [
                            {"id": 1, "task": "Practice LeetCode medium problems", "date": "2025-01-24", "completed": false},
                            {"id": 2, "task": "Review system design basics", "date": "2025-01-26", "completed": false},
                            {"id": 3, "task": "Prepare questions about Google's culture", "date": "2025-01-25", "completed": false}
                        ],
                        "skills": ["Python", "Java", "Data Structures", "Algorithms", "System Design"],
                        "competencies": ["Software Engineering", "Problem Solving", "Computer Science Fundamentals"]
                    },
                    {
                        "title": "Software Developer",
                        "company": "Microsoft",
                        "location": "Redmond, WA",
                        "url": "https://careers.microsoft.com",
                        "status": "interviewing",
                        "closeDate": "2025-02-28",
                        "salary": "$105K-$130K",
                        "notes": "Completed phone screen. Scheduled for virtual onsite (4 rounds) next week. Excited about Azure team opportunity.",
                        "todos": [
                            {"id": 1, "task": "Study Azure services overview", "date": "2025-01-23", "completed": true},
                            {"id": 2, "task": "Practice coding in VS Code environment", "date": "2025-01-25", "completed": false},
                            {"id": 3, "task": "Prepare behavioral stories using STAR", "date": "2025-01-24", "completed": false},
                            {"id": 4, "task": "Research interviewers on LinkedIn", "date": "2025-01-26", "completed": false}
                        ],
                        "skills": ["C#", ".NET", "Azure", "JavaScript", "SQL"],
                        "competencies": ["Software Development", "Cloud Computing", "Web Development"]
                    },
                    {
                        "title": "Cloud Engineer - Entry Level",
                        "company": "Amazon Web Services",
                        "location": "Seattle, WA",
                        "url": "https://amazon.jobs",
                        "status": "interested",
                        "closeDate": "2025-03-15",
                        "salary": "$100K-$125K",
                        "notes": "Dream role working directly on AWS services. Requires strong systems knowledge and some cloud experience. Need to build cloud portfolio projects.",
                        "todos": [
                            {"id": 1, "task": "Complete AWS Cloud Practitioner certification", "date": "2025-02-15", "completed": false},
                            {"id": 2, "task": "Build serverless application on AWS", "date": "2025-02-28", "completed": false},
                            {"id": 3, "task": "Network with AWS engineers at meetup", "date": "2025-02-10", "completed": false}
                        ],
                        "skills": ["AWS", "Python", "Linux", "Networking", "Distributed Systems"],
                        "competencies": ["Cloud Computing", "Systems Engineering", "DevOps"]
                    },
                    {
                        "title": "Full Stack Developer",
                        "company": "Shopify",
                        "location": "Remote",
                        "url": "https://shopify.com/careers",
                        "status": "interested",
                        "closeDate": "2025-03-31",
                        "salary": "$95K-$120K",
                        "notes": "Remote-first company with great culture. Role focuses on Ruby/React stack. Would be great experience with e-commerce at scale.",
                        "todos": [
                            {"id": 1, "task": "Learn Ruby and Rails fundamentals", "date": "2025-02-20", "completed": false},
                            {"id": 2, "task": "Contribute to Shopify open source projects", "date": "2025-02-28", "completed": false},
                            {"id": 3, "task": "Build e-commerce feature showcase", "date": "2025-03-10", "completed": false}
                        ],
                        "skills": ["Ruby", "Rails", "React", "JavaScript", "PostgreSQL"],
                        "competencies": ["Full Stack Development", "E-Commerce", "Web Development"]
                    }
                ],
                "experiences":[{"organizationName":"TechStart Accelerator","role":"Software Engineering Intern","location":"Austin, TX","startDate":"2024-06-01","endDate":"2024-08-31","description":"Summer internship building full-stack web applications for startup clients. Worked on team of 4 interns developing React-based customer portal with Node.js backend. Participated in agile development process.","technologies":[{"name":"React","type":"Core"},{"name":"Node.js","type":"Core"},{"name":"JavaScript","type":"Core"},{"name":"Git","type":"Core"},{"name":"PostgreSQL","type":"Peripheral"},{"name":"Docker","type":"Peripheral"},{"name":"AWS","type":"Peripheral"},{"name":"Jira","type":"Peripheral"}],"keySkills":["Web Development","Problem Solving","Collaboration","Code Review","Debugging","API Development"],"competencies":["Software Development","Agile Methodology","Technical Communication","Learning Agility"],"projectTypes":["Agile","Web Application Development","API Development"],"internalStakeholders":["Engineering Manager","Senior Developers","Product Manager","Other Interns"],"externalStakeholders":["Startup Clients","End Users"],"achievements":["Delivered 3 major features ahead of schedule","Reduced page load time by 30% through optimization","Received offer for full-time position post-graduation","Presented final project to company leadership"]},{"organizationName":"University of Texas at Austin","role":"Computer Science Teaching Assistant","location":"Austin, TX","startDate":"2023-08-01","endDate":"2024-05-31","description":"Teaching assistant for Introduction to Programming (CS50). Held weekly office hours, graded assignments, and mentored 25 students. Created supplemental learning materials.","technologies":[{"name":"Python","type":"Core"},{"name":"Java","type":"Core"},{"name":"Git","type":"Core"},{"name":"Linux","type":"Peripheral"}],"keySkills":["Teaching","Communication","Mentoring","Problem Solving","Patience","Code Review"],"competencies":["Technical Communication","Mentoring","Knowledge Transfer","Empathy"],"projectTypes":["Teaching","Content Development","Student Support"],"internalStakeholders":["Course Professor","Other TAs","CS Department Staff"],"externalStakeholders":["Students"],"achievements":["Maintained 4.8/5.0 student satisfaction rating","Created 10+ tutorial videos with 500+ views","Helped 5 students improve from D to B grades","Nominated for Outstanding TA Award"]},{"organizationName":"UT Austin Robotics Club","role":"Software Team Lead","location":"Austin, TX","startDate":"2022-09-01","endDate":"2024-05-31","description":"Led team of 8 students developing autonomous robot for RoboCup competition. Designed computer vision and navigation systems. Coordinated with hardware and design teams.","technologies":[{"name":"Python","type":"Core"},{"name":"ROS","type":"Core"},{"name":"OpenCV","type":"Core"},{"name":"Git","type":"Core"},{"name":"Linux","type":"Core"},{"name":"C++","type":"Peripheral"},{"name":"MATLAB","type":"Peripheral"}],"keySkills":["Team Leadership","Project Management","Computer Vision","Robotics","Problem Solving","Collaboration"],"competencies":["Technical Leadership","Project Management","Systems Integration","Team Collaboration"],"projectTypes":["Robotics","Competition","Team Project"],"internalStakeholders":["Club President","Hardware Team","Mechanical Team","Faculty Advisor"],"externalStakeholders":["RoboCup Competition Organizers","Corporate Sponsors"],"achievements":["Led team to 3rd place finish at RoboCup 2024","Secured $5000 in corporate sponsorship","Grew software team from 3 to 8 members","Published technical writeup with 1000+ downloads"]},{"organizationName":"Local Coffee Shop","role":"Barista","location":"Austin, TX","startDate":"2021-06-01","endDate":"2023-08-31","description":"Part-time barista while attending university. Provided excellent customer service, managed cash register, opened and closed shop. Trained new employees.","technologies":[{"name":"Square POS","type":"Core"},{"name":"Excel","type":"Peripheral"}],"keySkills":["Customer Service","Communication","Time Management","Multitasking","Training","Reliability"],"competencies":["Customer Service","Work Ethic","Adaptability","Interpersonal Skills"],"projectTypes":["Customer Service","Operations"],"internalStakeholders":["Shop Manager","Co-workers"],"externalStakeholders":["Customers"],"achievements":["Employee of the Month 3 times","Trained 7 new baristas","Maintained 4.9/5 customer rating","Managed peak hours independently"]},{"organizationName":"University of Texas at Austin","role":"Bachelor of Science in Computer Science","location":"Austin, TX","startDate":"2020-08-01","endDate":"2024-05-31","description":"Graduated with honors, GPA 3.7/4.0. Relevant coursework: Data Structures, Algorithms, Software Engineering, Database Systems, Computer Networks, Machine Learning, Cloud Computing.","technologies":[{"name":"Python","type":"Core"},{"name":"Java","type":"Core"},{"name":"C++","type":"Peripheral"},{"name":"JavaScript","type":"Core"},{"name":"SQL","type":"Core"},{"name":"Git","type":"Core"},{"name":"Linux","type":"Core"}],"keySkills":["Programming","Algorithm Design","Data Structures","Problem Solving","Research","Academic Writing"],"competencies":["Computer Science Fundamentals","Critical Thinking","Learning Agility","Academic Excellence"],"projectTypes":["Academic Projects","Research","Coursework"],"internalStakeholders":["Professors","Classmates","Academic Advisors"],"externalStakeholders":[],"achievements":["Graduated with Honors (3.7 GPA)","Dean's List 6 semesters","Completed 5 major course projects","Member of Upsilon Pi Epsilon (CS Honor Society)"]}],"stories":[{"title":"Optimizing Application Performance","experienceIndex":0,"experienceName":"Software Engineering Intern - TechStart Accelerator","situation":"Customer portal had 8-second page load times causing user complaints and increased bounce rate.","task":"Investigate performance issues and implement optimizations to improve user experience.","action":"Used browser dev tools to profile performance, identified unnecessary API calls and unoptimized images, implemented lazy loading, added caching, optimized database queries, reduced bundle size with code splitting.","result":"Reduced page load time to 2.8 seconds (65% improvement), decreased bounce rate by 40%, received praise from client, techniques adopted as team standards.","competencies":["Problem Solving","Performance Optimization","Technical Analysis","Initiative"],"createdAt":"2025-01-15T10:00:00.000Z","updatedAt":"2025-01-15T10:00:00.000Z"},{"title":"Leading Team to RoboCup 3rd Place","experienceIndex":2,"experienceName":"Software Team Lead - UT Austin Robotics Club","situation":"Team had never placed in top 5 at RoboCup and struggled with coordination between hardware and software.","task":"Lead software development and coordinate with other teams to achieve competitive performance.","action":"Implemented agile methodology with weekly sprints, created shared documentation system, established integration testing schedule, organized joint meetings with hardware team, mentored new members, managed project timeline.","result":"Achieved 3rd place finish (team's best ever), all software modules delivered on time, grew team from 3 to 8 members, published technical writeup downloaded 1000+ times, secured $5K in sponsorship.","competencies":["Technical Leadership","Project Management","Team Collaboration","Systems Integration"],"createdAt":"2025-01-15T10:05:00.000Z","updatedAt":"2025-01-15T10:05:00.000Z"},{"title":"Helping Struggling Students Succeed","experienceIndex":1,"experienceName":"Computer Science Teaching Assistant - UT Austin","situation":"Five students in my section were failing mid-semester with D grades, risking dropping the course.","task":"Help these students improve their understanding and grades while maintaining fairness to all students.","action":"Scheduled individual meetings to understand their challenges, created personalized study plans, held extra office hours, connected them with peer study groups, provided additional practice problems, broke down complex concepts into simpler explanations.","result":"All five students improved to B grades by end of semester, received thank-you emails from students and parents, nominated for Outstanding TA Award, created supplemental materials now used by other TAs.","competencies":["Mentoring","Patience","Communication","Empathy","Problem Solving"],"createdAt":"2025-01-15T10:10:00.000Z","updatedAt":"2025-01-15T10:10:00.000Z"}]}
        };

        // Privacy Advisory Toggle
        function toggleAdvisory() {
            const content = document.getElementById('advisoryContent');
            const icon = document.getElementById('advisoryToggleIcon');
            const isExpanded = content.style.display !== 'none';

            if (isExpanded) {
                // Collapse
                content.style.display = 'none';
                icon.style.transform = 'rotate(180deg)';
                icon.classList.remove('ph-caret-up');
                icon.classList.add('ph-caret-down');
                localStorage.setItem('advisoryCollapsed', 'true');
            } else {
                // Expand
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                icon.classList.remove('ph-caret-down');
                icon.classList.add('ph-caret-up');
                localStorage.setItem('advisoryCollapsed', 'false');
            }
        }

        function toggleWelcomePanel() {
            const content = document.getElementById('welcomeContent');
            const icon = document.getElementById('welcomeToggleIcon');
            const isExpanded = content.style.display !== 'none';

            if (isExpanded) {
                // Collapse
                content.style.display = 'none';
                icon.style.transform = 'rotate(180deg)';
                icon.classList.remove('ph-caret-up');
                icon.classList.add('ph-caret-down');
                localStorage.setItem('welcomePanelCollapsed', 'true');
            } else {
                // Expand
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                icon.classList.remove('ph-caret-down');
                icon.classList.add('ph-caret-up');
                localStorage.setItem('welcomePanelCollapsed', 'false');
            }
        }

        // Restore advisory state on page load
        function restoreAdvisoryState() {
            const isCollapsed = localStorage.getItem('advisoryCollapsed') === 'true';
            if (isCollapsed) {
                const content = document.getElementById('advisoryContent');
                const icon = document.getElementById('advisoryToggleIcon');
                if (content && icon) {
                    content.style.display = 'none';
                    icon.style.transform = 'rotate(180deg)';
                    icon.classList.remove('ph-caret-up');
                    icon.classList.add('ph-caret-down');
                }
            }
        }

        // Restore welcome panel state on page load
        function restoreWelcomePanelState() {
            const isCollapsed = localStorage.getItem('welcomePanelCollapsed') === 'true';
            if (isCollapsed) {
                const content = document.getElementById('welcomeContent');
                const icon = document.getElementById('welcomeToggleIcon');
                if (content && icon) {
                    content.style.display = 'none';
                    icon.style.transform = 'rotate(180deg)';
                    icon.classList.remove('ph-caret-up');
                    icon.classList.add('ph-caret-down');
                }
            }
        }

        // Call restore functions when page loads
        document.addEventListener('DOMContentLoaded', function() {
            restoreAdvisoryState();
            restoreWelcomePanelState();
            updateSubscriptionTierDisplay();
        });

        // Canvas Tab Navigation
        function switchCanvasTab(tab) {
            // Close any open slideouts when switching tabs
            closeInterviewSlideout();

            // Remove active class from all tabs (both desktop and mobile)
            document.querySelectorAll('.main-menu-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to clicked tab (search both desktop and mobile)
            const desktopButton = document.querySelector(`.main-menu-nav-items .main-menu-item[onclick*="'${tab}'"]`);
            const mobileButton = document.querySelector(`.main-menu-dropdown .main-menu-item[onclick*="'${tab}'"]`);

            if (desktopButton) desktopButton.classList.add('active');
            if (mobileButton) mobileButton.classList.add('active');

            // Get content containers
            const canvasBody = document.getElementById('canvasBody');
            const pathsView = document.getElementById('pathsView');
            const rolesView = document.getElementById('rolesView');
            const libraryView = document.getElementById('libraryView');
            const canvasDescription = document.querySelector('.canvas-description');
            const mobileMenu = document.getElementById('mobile-menu'); // Mobile menu grid

            // Hide all views PROPERLY
            if (canvasBody) canvasBody.style.display = 'none'; // FIXED: Was 'flex', should be 'none'
            if (pathsView) pathsView.style.display = 'none';
            if (rolesView) rolesView.style.display = 'none';
            if (libraryView) libraryView.style.display = 'none';
            if (mobileMenu) mobileMenu.classList.remove('show-for-canvas'); // Hide mobile menu initially

            // Show selected view
            if (tab === 'canvas') {
                // Canvas is the default view - show canvas body, description, and mobile menu
                canvasBody.style.display = 'flex';
                if (canvasDescription) {
                    canvasDescription.style.display = 'block';
                    canvasDescription.classList.remove('hidden-for-other-tabs');
                }
                if (mobileMenu) mobileMenu.classList.add('show-for-canvas'); // Show mobile menu for canvas
            } else if (tab === 'paths') {
                // Hide description and mobile menu completely for Paths view
                if (canvasDescription) canvasDescription.classList.add('hidden-for-other-tabs');
                // Mobile menu already hidden by removing class above
                if (pathsView) {
                    pathsView.style.display = 'flex';
                    if (!pathsView.hasAttribute('data-loaded')) {
                        loadPathsView();
                        pathsView.setAttribute('data-loaded', 'true');
                    }
                }
            } else if (tab === 'roles') {
                // Hide description and mobile menu completely for Roles view
                if (canvasDescription) canvasDescription.classList.add('hidden-for-other-tabs');
                // Mobile menu already hidden by removing class above
                if (rolesView) {
                    rolesView.style.display = 'flex';
                    if (!rolesView.hasAttribute('data-loaded')) {
                        loadRolesView();
                        rolesView.setAttribute('data-loaded', 'true');
                    }
                }
            } else if (tab === 'library') {
                // Hide description and mobile menu completely for Library view
                if (canvasDescription) canvasDescription.classList.add('hidden-for-other-tabs');
                // Mobile menu already hidden by removing class above
                if (libraryView) {
                    libraryView.style.display = 'flex';
                    if (!libraryView.hasAttribute('data-loaded')) {
                        loadLibraryView();
                        libraryView.setAttribute('data-loaded', 'true');
                    }
                }
            }
        }

        function loadPathsView() {
            const container = document.getElementById('pathsView');
            container.innerHTML = '<iframe src="career-paths.html" style="width: 100%; height: 100%; border: none; background: white;"></iframe>';
        }

        function loadRolesView() {
            const container = document.getElementById('rolesView');
            container.innerHTML = '<iframe src="role-translator.html" style="width: 100%; height: 100%; border: none; background: white;"></iframe>';
        }

        function loadLibraryView() {
            const container = document.getElementById('libraryView');
            container.innerHTML = '<iframe src="corpus/index.html" style="width: 100%; height: 100%; border: none; background: white;" onload="handleLibraryLoad(this)" onerror="handleLibraryError()"></iframe>';
        }

        function handleLibraryLoad(iframe) {
            // Successfully loaded corpus/index.html
            console.log('Library loaded successfully');
        }

        function handleLibraryError() {
            // Fallback if corpus/index.html doesn't exist
            const container = document.getElementById('libraryView');
            container.innerHTML = `
                <div style="padding: 40px; text-align: center; background: white; border-radius: 12px; margin: 24px;">
                    <i class="ph ph-books" style="font-size: 64px; color: var(--color-primary-blue); margin-bottom: 24px; display: block;"></i>
                    <h3 style="font-family: var(--font-family-ui); font-size: 24px; color: var(--color-dark); margin-bottom: 16px;">Learning Library</h3>
                    <p style="font-family: var(--font-family-body); font-size: 16px; color: var(--color-neutral-text); max-width: 600px; margin: 0 auto; line-height: 1.6;">
                        Access curated learning resources, courses, and content aligned with your career goals. Browse by skill, role, or career path to build your professional knowledge.
                    </p>
                    <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text-light); margin-top: 24px;">
                        Run <code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-family: monospace;">python generate_corpus_index.py</code> to generate the library content.
                    </p>
                </div>
            `;
        }

        // Projects View Mobile Functions
        function toggleProjectsSidebar() {
            const sidebar = document.getElementById('projects-sidebar');
            const backdrop = document.getElementById('projects-sidebar-backdrop');

            if (sidebar && backdrop) {
                const isOpen = sidebar.classList.contains('open');

                if (isOpen) {
                    // Close sidebar
                    sidebar.classList.remove('open');
                    backdrop.style.display = 'none';
                } else {
                    // Open sidebar
                    sidebar.classList.add('open');
                    backdrop.style.display = 'block';
                }
            }
        }

        // Mobile Menu Functions - Placeholder implementations for tier-gated features

        function openPortfolioSlideout() {
            // Placeholder for Portfolio feature (learner+ tiers)
            console.log('[Mobile Menu] Opening Portfolio slideout');
            // TODO: Implement Portfolio slideout functionality
            alert('Portfolio feature coming soon!');
        }

        // Swipe-to-close functionality for slideouts (supports both side and bottom sheets)
        function initializeSwipeToClose() {
            // Find all slideout elements
            const slideouts = document.querySelectorAll('.interview-slideout');

            slideouts.forEach(slideout => {
                let startX = 0;
                let startY = 0;
                let currentX = 0;
                let currentY = 0;
                let isDragging = false;
                let startTime = 0;
                let isBottomSheet = false;

                // Touch start - capture initial position
                slideout.addEventListener('touchstart', (e) => {
                    // Only handle swipes if slideout is active
                    if (!slideout.classList.contains('active')) return;

                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    currentX = startX;
                    currentY = startY;
                    startTime = Date.now();
                    isDragging = false;

                    // Detect if we're in bottom sheet mode (small screen)
                    isBottomSheet = window.innerWidth <= 480;

                    slideout.classList.add('swiping');
                }, { passive: true });

                // Touch move - track drag distance
                slideout.addEventListener('touchmove', (e) => {
                    if (!slideout.classList.contains('active')) return;

                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;

                    if (isBottomSheet) {
                        // Bottom sheet: handle downward swipes
                        const deltaY = currentY - startY;

                        // Only allow downward swipes (positive deltaY)
                        if (deltaY > 0) {
                            isDragging = true;

                            // Apply resistance - swipe becomes harder as you drag further
                            const resistance = Math.min(deltaY / 2, slideout.offsetHeight * 0.4);
                            slideout.style.transform = `translateY(${resistance}px)`;

                            // Prevent page scrolling during swipe
                            e.preventDefault();
                        }
                    } else {
                        // Side slideout: handle rightward swipes
                        const deltaX = currentX - startX;

                        // Only allow rightward swipes (positive deltaX)
                        if (deltaX > 0) {
                            isDragging = true;

                            // Apply resistance - swipe becomes harder as you drag further
                            const resistance = Math.min(deltaX / 2, slideout.offsetWidth * 0.4);
                            slideout.style.transform = `translateX(${resistance}px)`;

                            // Prevent page scrolling during swipe
                            e.preventDefault();
                        }
                    }
                }, { passive: false });

                // Touch end - determine close or snap back
                slideout.addEventListener('touchend', (e) => {
                    if (!slideout.classList.contains('active') || !isDragging) {
                        slideout.classList.remove('swiping');
                        return;
                    }

                    let shouldClose = false;
                    const deltaTime = Date.now() - startTime;

                    slideout.classList.remove('swiping');

                    if (isBottomSheet) {
                        // Bottom sheet close logic
                        const deltaY = currentY - startY;
                        const velocity = deltaY / deltaTime; // pixels per millisecond
                        const closeThreshold = slideout.offsetHeight * 0.3;

                        shouldClose = deltaY > closeThreshold || (velocity > 0.5 && deltaY > 50);
                    } else {
                        // Side slideout close logic
                        const deltaX = currentX - startX;
                        const velocity = deltaX / deltaTime; // pixels per millisecond
                        const closeThreshold = slideout.offsetWidth * 0.3;

                        shouldClose = deltaX > closeThreshold || (velocity > 0.5 && deltaX > 50);
                    }

                    if (shouldClose) {
                        // Close the slideout
                        slideout.classList.add('snap-close');

                        // Wait for animation to complete, then properly close
                        setTimeout(() => {
                            slideout.classList.remove('snap-close', 'active');
                            slideout.style.transform = '';

                            // Remove backdrop if it exists
                            const backdrop = document.querySelector('.bottom-sheet-backdrop');
                            if (backdrop) {
                                backdrop.classList.remove('active');
                                setTimeout(() => backdrop.remove(), 300);
                            }

                            console.log('[Swipe] Slideout closed via swipe gesture');
                        }, 300);
                    } else {
                        // Snap back to original position
                        slideout.classList.add('snap-back');

                        setTimeout(() => {
                            slideout.classList.remove('snap-back');
                            slideout.style.transform = '';
                        }, 300);
                    }

                    isDragging = false;
                }, { passive: true });

                // Handle touch cancel (e.g., phone call, notification)
                slideout.addEventListener('touchcancel', (e) => {
                    if (isDragging) {
                        slideout.classList.remove('swiping');
                        slideout.classList.add('snap-back');

                        setTimeout(() => {
                            slideout.classList.remove('snap-back');
                            slideout.style.transform = '';
                        }, 300);
                    }
                    isDragging = false;
                }, { passive: true });
            });

            console.log('[Swipe] Initialized swipe-to-close for', slideouts.length, 'slideouts');
        }

        // Bottom sheet backdrop management
        function createBottomSheetBackdrop() {
            // Only create backdrop for small screens
            if (window.innerWidth > 480) return null;

            // Remove any existing backdrop
            const existingBackdrop = document.querySelector('.bottom-sheet-backdrop');
            if (existingBackdrop) existingBackdrop.remove();

            // Create new backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'bottom-sheet-backdrop';
            backdrop.onclick = () => {
                // Close slideout when backdrop is tapped
                const activeSlideout = document.querySelector('.interview-slideout.active');
                if (activeSlideout) {
                    activeSlideout.classList.remove('active');
                    backdrop.classList.remove('active');
                    setTimeout(() => backdrop.remove(), 300);
                }
            };

            document.body.appendChild(backdrop);

            // Activate backdrop after a short delay for animation
            setTimeout(() => backdrop.classList.add('active'), 10);

            return backdrop;
        }

        // Enhanced slideout opening for bottom sheet support
        function openSlideoutWithBottomSheetSupport(slideoutId) {
            const slideout = document.getElementById(slideoutId);
            if (!slideout) return;

            // Track which slideout is currently open
            if (slideoutId === 'interviewSlideout') {
                currentSlideout = 'interview-prep';
            } else {
                currentSlideout = slideoutId;
            }

            // Create backdrop for small screens
            const isSmallScreen = window.innerWidth <= 480;
            if (isSmallScreen) {
                createBottomSheetBackdrop();
            }

            // Open the slideout
            slideout.classList.add('active');

            console.log('[Bottom Sheet] Opened slideout with backdrop support:', slideoutId);
        }

        // Conditional D3 Loading for Performance Optimization
        function initializeConditionalD3Loading() {
            const isMobile = window.innerWidth <= 768;
            const mindmapContainer = document.getElementById('canvas-mindmap');

            if (!mindmapContainer) {
                console.log('[D3 Loading] Mindmap container not found');
                return;
            }

            if (isMobile) {
                // Mobile: Don't load D3, use simple text-based navigation
                console.log('[D3 Loading] Mobile detected - skipping D3 mindmap loading');

                // Ensure D3 is hidden, but only show mobile menu if canvas tab is active
                mindmapContainer.style.display = 'none';
                const mobileMenu = document.getElementById('mobile-menu');
                if (mobileMenu) {
                    // Check if canvas tab is currently active before showing mobile menu
                    const canvasTabActive = document.querySelector('.main-menu-item.active[onclick*="canvas"]');
                    if (canvasTabActive) {
                        mobileMenu.classList.add('show-for-canvas');
                    } else {
                        mobileMenu.classList.remove('show-for-canvas');
                    }
                }

                // Add mobile performance message if needed
                mindmapContainer.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: var(--color-neutral-background); border-radius: 12px; margin: 24px;">
                        <i class="ph ph-device-mobile" style="font-size: 48px; color: var(--color-primary-blue); margin-bottom: 16px; display: block;"></i>
                        <h3 style="font-family: var(--font-family-ui); font-size: 18px; color: var(--color-dark); margin-bottom: 12px;">Mobile Optimized Experience</h3>
                        <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); line-height: 1.5; max-width: 300px; margin: 0 auto;">
                            Use the menu grid below to access your career management tools. The interactive mindmap is available on desktop for advanced navigation.
                        </p>
                    </div>
                `;

            } else {
                // Desktop: Load full D3 mindmap
                console.log('[D3 Loading] Desktop detected - initializing full D3 mindmap');

                // Clear any mobile content from mindmap container
                mindmapContainer.innerHTML = '';

                // Ensure D3 is visible and mobile menu is hidden
                mindmapContainer.style.display = 'block';
                const mobileMenu = document.getElementById('mobile-menu');
                if (mobileMenu) {
                    mobileMenu.classList.remove('show-for-canvas');
                }

                // Initialize D3 mindmap with current persona
                if (typeof initializeMindmap === 'function') {
                    const persona = currentPersona || 'retail-manager'; // Use global currentPersona variable
                    initializeMindmap(persona);
                } else {
                    console.warn('[D3 Loading] initializeMindmap function not found');
                }
            }

            // Handle window resize to switch between modes
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const wasMobile = isMobile;
                    const nowMobile = window.innerWidth <= 768;

                    // Only reinitialize if mobile state changed
                    if (wasMobile !== nowMobile) {
                        console.log('[D3 Loading] Screen size changed, reinitializing...');
                        initializeConditionalD3Loading();
                    }
                }, 250);
            });

            console.log('[D3 Loading] Conditional D3 loading initialized for', isMobile ? 'mobile' : 'desktop');
        }

        // Lazy loading for off-screen content
        function initializeLazyLoading() {
            // Intersection Observer for lazy loading
            const observerOptions = {
                root: null,
                rootMargin: '50px',
                threshold: 0.1
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const target = entry.target;

                        // Handle different types of lazy-loaded content
                        if (target.classList.contains('lazy-load-images')) {
                            loadImagesInElement(target);
                        }

                        if (target.classList.contains('lazy-load-slideout')) {
                            preloadSlideoutContent(target);
                        }

                        // Stop observing once loaded
                        observer.unobserve(target);
                    }
                });
            }, observerOptions);

            // Observe elements marked for lazy loading
            document.querySelectorAll('.lazy-load').forEach(element => {
                observer.observe(element);
            });

            console.log('[Lazy Loading] Initialized lazy loading observer');
        }

        // Helper function to load images
        function loadImagesInElement(element) {
            const images = element.querySelectorAll('img[data-src]');
            images.forEach(img => {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                img.classList.add('loaded');
            });
        }

        // Helper function to preload slideout content
        function preloadSlideoutContent(slideout) {
            console.log('[Lazy Loading] Preloading slideout content:', slideout.id);
            // Add specific preloading logic here as needed
        }

        // Long-press context menus for mobile
        function initializeLongPressContextMenus() {
            // Only enable on touch devices
            if (!('ontouchstart' in window)) {
                console.log('[Long Press] Not a touch device, skipping long-press menus');
                return;
            }

            let longPressTimer = null;
            let isLongPress = false;
            let touchStartTime = 0;

            // Add long-press to story cards
            document.addEventListener('touchstart', (e) => {
                const storyCard = e.target.closest('.story-card, .mobile-file-card, .job-card');
                if (!storyCard) return;

                touchStartTime = Date.now();
                isLongPress = false;

                // Start long-press timer (500ms)
                longPressTimer = setTimeout(() => {
                    isLongPress = true;
                    showContextMenu(e, storyCard);

                    // Add haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }, 500);

            }, { passive: true });

            // Cancel long-press on touch move or end
            document.addEventListener('touchmove', (e) => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }

                // If it was a long press, prevent the default click
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                    isLongPress = false;
                }
            }, { passive: false });

            console.log('[Long Press] Initialized long-press context menus');
        }

        // Show context menu for cards
        function showContextMenu(event, card) {
            // Remove any existing context menu
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) existingMenu.remove();

            // Determine card type and available actions
            const actions = getContextMenuActions(card);
            if (actions.length === 0) return;

            // Create context menu
            const menu = document.createElement('div');
            menu.className = 'context-menu';

            // Position near touch point but ensure it stays in viewport
            const touch = event.touches[0];
            const menuWidth = 200;
            const menuHeight = actions.length * 48 + 16; // 48px per item + padding

            let left = touch.clientX - menuWidth / 2;
            let top = touch.clientY - menuHeight - 10; // Above finger

            // Adjust position to stay in viewport
            left = Math.max(16, Math.min(left, window.innerWidth - menuWidth - 16));
            top = Math.max(16, Math.min(top, window.innerHeight - menuHeight - 16));

            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;

            // Add actions to menu
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = 'context-menu-item';
                button.innerHTML = `<i class="ph ${action.icon}"></i><span>${action.label}</span>`;
                button.onclick = () => {
                    action.handler(card);
                    menu.remove();
                };
                menu.appendChild(button);
            });

            // Add to page
            document.body.appendChild(menu);

            // Add backdrop to close menu
            const backdrop = document.createElement('div');
            backdrop.className = 'context-menu-backdrop';
            backdrop.onclick = () => {
                menu.remove();
                backdrop.remove();
            };
            document.body.appendChild(backdrop);

            // Animate in
            setTimeout(() => {
                menu.classList.add('active');
                backdrop.classList.add('active');
            }, 10);

            console.log('[Long Press] Showed context menu for:', card.className);
        }

        // Get available actions for different card types
        function getContextMenuActions(card) {
            const actions = [];

            // Common actions for all cards
            actions.push({
                icon: 'ph-pencil',
                label: 'Edit',
                handler: (card) => {
                    console.log('[Context Menu] Edit action for card:', card);
                    // Find and trigger existing edit functionality
                    const editButton = card.querySelector('[onclick*="edit"], .edit-btn, .story-action-btn');
                    if (editButton) editButton.click();
                }
            });

            actions.push({
                icon: 'ph-share-network',
                label: 'Share',
                handler: (card) => {
                    console.log('[Context Menu] Share action for card:', card);
                    // Implement sharing logic or find existing share button
                    const shareButton = card.querySelector('[onclick*="share"], .share-btn');
                    if (shareButton) shareButton.click();
                    else alert('Sharing functionality coming soon!');
                }
            });

            // Add copy action for stories
            if (card.classList.contains('story-card')) {
                actions.push({
                    icon: 'ph-copy',
                    label: 'Copy Text',
                    handler: (card) => {
                        const textContent = card.querySelector('.story-text, .story-description, p');
                        if (textContent) {
                            navigator.clipboard.writeText(textContent.textContent).then(() => {
                                console.log('[Context Menu] Copied story text');
                                // Show toast notification if available
                                if (typeof showToast === 'function') {
                                    showToast('Text copied to clipboard!', 'success');
                                }
                            });
                        }
                    }
                });
            }

            actions.push({
                icon: 'ph-trash',
                label: 'Delete',
                handler: (card) => {
                    console.log('[Context Menu] Delete action for card:', card);
                    // Find and trigger existing delete functionality
                    const deleteButton = card.querySelector('[onclick*="delete"], .delete-btn, [onclick*="remove"]');
                    if (deleteButton) deleteButton.click();
                }
            });

            return actions;
        }

        // One-handed usage optimization
        function initializeOneHandedOptimization() {
            // Detect large mobile devices (typically > 5.5")
            const isLargeMobile = window.innerWidth >= 375 && window.innerWidth <= 480 && window.innerHeight >= 667;

            if (!isLargeMobile) {
                console.log('[One Handed] Not a large mobile device, skipping one-handed optimizations');
                return;
            }

            // Add one-handed class to body
            document.body.classList.add('one-handed-mode');

            // Create thumb zone indicator (optional visual aid)
            createThumbZoneIndicator();

            // Optimize floating action buttons
            optimizeFloatingButtons();

            // Add reachability helpers
            addReachabilityHelpers();

            console.log('[One Handed] Initialized one-handed usage optimizations');
        }

        // Create visual indicator of the comfortable thumb zone
        function createThumbZoneIndicator() {
            // Only show in development mode (can be removed in production)
            if (localStorage.getItem('show_thumb_zone') !== 'true') return;

            const indicator = document.createElement('div');
            indicator.className = 'thumb-zone-indicator';
            indicator.style.cssText = `
                position: fixed;
                bottom: 0;
                right: 0;
                width: 120px;
                height: 120px;
                border: 2px dashed rgba(0, 102, 204, 0.3);
                border-radius: 50%;
                pointer-events: none;
                z-index: 999;
                opacity: 0.5;
            `;
            document.body.appendChild(indicator);
        }

        // Optimize floating action buttons for thumb reach
        function optimizeFloatingButtons() {
            // Move primary action buttons to thumb-friendly positions
            const primaryButtons = document.querySelectorAll('.add-story-btn, .primary-action-btn');

            primaryButtons.forEach(button => {
                // Ensure buttons are positioned for easy thumb access
                const rect = button.getBoundingClientRect();
                const thumbReach = window.innerHeight - 120; // Comfortable thumb reach zone

                if (rect.top < thumbReach) {
                    // Button might be hard to reach, add accessibility hint
                    button.style.position = 'relative';
                    button.setAttribute('data-thumb-hint', 'Use long-press for easier access');
                }
            });
        }

        // Add reachability helpers for difficult-to-reach elements
        function addReachabilityHelpers() {
            // Pull-to-refresh style gesture for accessing top elements
            let pullStartY = 0;
            let isPulling = false;

            document.addEventListener('touchstart', (e) => {
                // Only activate if touching near bottom of screen
                const touchY = e.touches[0].clientY;
                if (touchY > window.innerHeight * 0.7) {
                    pullStartY = touchY;
                    isPulling = false;
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (pullStartY === 0) return;

                const currentY = e.touches[0].clientY;
                const pullDistance = currentY - pullStartY;

                // Detect upward pull gesture (negative pullDistance)
                if (pullDistance < -50 && !isPulling) {
                    isPulling = true;
                    showReachabilityMenu();
                }
            }, { passive: true });

            document.addEventListener('touchend', () => {
                pullStartY = 0;
                isPulling = false;
            }, { passive: true });
        }

        // Show reachability menu for hard-to-reach actions
        function showReachabilityMenu() {
            // Remove any existing reachability menu
            const existingMenu = document.querySelector('.reachability-menu');
            if (existingMenu) existingMenu.remove();

            // Create menu with top-level actions
            const menu = document.createElement('div');
            menu.className = 'reachability-menu';

            // Position at bottom of screen for thumb access
            menu.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                padding: 20px 24px;
                transform: translateY(100%);
                transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            `;

            // Add quick actions
            const actions = [
                { icon: 'ph-plus', label: 'Add New', action: () => console.log('Add action') },
                { icon: 'ph-funnel', label: 'Filter', action: () => console.log('Filter action') },
                { icon: 'ph-magnifying-glass', label: 'Search', action: () => console.log('Search action') },
                { icon: 'ph-gear', label: 'Settings', action: () => console.log('Settings action') }
            ];

            actions.forEach(actionItem => {
                const button = document.createElement('button');
                button.className = 'reachability-button';
                button.innerHTML = `<i class="ph ${actionItem.icon}"></i><span>${actionItem.label}</span>`;
                button.onclick = () => {
                    actionItem.action();
                    menu.remove();
                };
                menu.appendChild(button);
            });

            // Add close hint
            const hint = document.createElement('div');
            hint.style.cssText = `
                text-align: center;
                padding-top: 12px;
                font-size: 12px;
                color: var(--color-neutral-text-light);
                border-top: 1px solid var(--color-neutral-border);
                margin-top: 12px;
            `;
            hint.textContent = 'Tap anywhere to close';
            menu.appendChild(hint);

            // Add to page
            document.body.appendChild(menu);

            // Animate in
            setTimeout(() => {
                menu.style.transform = 'translateY(0)';
            }, 10);

            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.3);
                z-index: 9999;
            `;
            backdrop.onclick = () => {
                menu.style.transform = 'translateY(100%)';
                setTimeout(() => {
                    menu.remove();
                    backdrop.remove();
                }, 300);
            };
            document.body.appendChild(backdrop);

            console.log('[One Handed] Showed reachability menu');
        }

        // Mobile Menu Dynamic Generation with Feature Flagging
        function generateMobileMenu() {
            const mobileMenuGrid = document.getElementById('mobile-menu-grid');
            if (!mobileMenuGrid) return;

            // Define all possible mobile menu items with their configurations
            const mobileMenuItems = [
                {
                    name: 'Career Experience',
                    icon: 'ph-suitcase',
                    onclick: 'openCareerExperienceSlideout()',
                    alwaysAvailable: true
                },
                {
                    name: 'Interview Prep',
                    icon: 'ph-chats-circle',
                    onclick: 'openInterviewPrepSlideout()',
                    alwaysAvailable: true
                },
                {
                    name: 'Job Opportunities',
                    icon: 'ph-briefcase',
                    onclick: 'openJobOpportunitiesSlideout()'
                },
                {
                    name: 'Goals',
                    icon: 'ph-target',
                    onclick: 'openGoalsSlideout()'
                },
                {
                    name: 'Portfolio',
                    icon: 'ph-folder-open',
                    onclick: 'openPortfolioSlideout()',
                    premiumDescription: 'Showcase your projects, publications, and accomplishments. Create a professional portfolio website and generate case studies to demonstrate your expertise.'
                }
            ];

            // Clear existing menu
            mobileMenuGrid.innerHTML = '';

            // Generate menu items based on subscription tier
            mobileMenuItems.forEach(item => {
                const isAvailable = item.alwaysAvailable || shouldShowNode(item.name);

                // Create button element
                const button = document.createElement('button');
                button.className = isAvailable ? 'mobile-menu-item' : 'mobile-menu-item mobile-menu-item-premium';

                // Set onclick behavior
                if (isAvailable) {
                    button.setAttribute('onclick', item.onclick);
                } else {
                    button.setAttribute('onclick', `showPremiumAlert('${item.name}', '${item.premiumDescription || 'Premium feature available with higher subscription tier.'}')`);
                }

                // Create button content
                button.innerHTML = `
                    <i class="ph ${item.icon}"></i>
                    <span>${item.name}</span>
                `;

                // Add to grid
                mobileMenuGrid.appendChild(button);
            });
        }

        // Example Profiles Functions (kept for backward compatibility with Quick Start)
        function loadExampleProfile(profileType) {

            // Get the example profile data
            const profileData = exampleProfiles[profileType];

            if (!profileData) {
                alert('Example profile not found.');
                return;
            }

            // Set current persona to match the profile type so example docs/diagrams load correctly
            currentPersona = profileType;
            localStorage.setItem('cleansheet_currentPersona', profileType);

            // Clear existing data before loading example profile
            localStorage.removeItem(`userGoals_${currentPersona}`);
            localStorage.removeItem(`userPortfolio_${currentPersona}`);
            localStorage.removeItem(`jobOpportunities_${currentPersona}`);
            localStorage.removeItem('applicationMaterials');
            localStorage.removeItem(`interview_documents_${currentPersona}`);
            localStorage.removeItem(`diagrams_${currentPersona}`);
            localStorage.removeItem(`whiteboards_${currentPersona}`);

            // Load profile data
            const profile = {
                firstName: profileData.userFirstName,
                lastName: profileData.userLastName,
                profession: profileData.userOccupation,
                goal: profileData.userGoals
            };
            localStorage.setItem('cleansheet_profile', JSON.stringify(profile));

            // Load experiences
            localStorage.setItem('cleansheet_experiences', JSON.stringify(profileData.experiences));

            // Load stories
            if (profileData.stories && profileData.stories.length > 0) {
                localStorage.setItem('cleansheet_stories', JSON.stringify(profileData.stories));
                localStorage.setItem('behavioralStories', JSON.stringify(profileData.stories));
            }

            // Load goals
            if (profileData.goals && profileData.goals.length > 0) {
                localStorage.setItem(`userGoals_${currentPersona}`, JSON.stringify(profileData.goals));
            }

            // Load portfolio
            if (profileData.portfolio && profileData.portfolio.length > 0) {
                localStorage.setItem(`userPortfolio_${currentPersona}`, JSON.stringify(profileData.portfolio));
            }

            // Load job opportunities
            if (profileData.jobOpportunities && profileData.jobOpportunities.length > 0) {
                localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(profileData.jobOpportunities));
            }

            // Load example documents for this persona
            const exampleDocs = exampleDocuments[currentPersona] || [];
            if (exampleDocs.length > 0) {
                localStorage.setItem(`interview_documents_${currentPersona}`, JSON.stringify(exampleDocs));
            }

            // Load example diagrams for this persona
            const exampleDiags = exampleDiagrams[currentPersona] || [];
            if (exampleDiags.length > 0) {
                localStorage.setItem(`diagrams_${currentPersona}`, JSON.stringify(exampleDiags));
            }

            // Calculate active jobs count (excluding rejected and not-interested)
            const activeJobsCount = (profileData.jobOpportunities || []).filter(job =>
                job.status !== 'rejected' && job.status !== 'not-interested'
            ).length;

            // Update UI
            updateProfileDisplay(profile);
            loadUserExperiences();
            updateExperienceCount(profileData.experiences.length);
            updateStoryCount(profileData.stories ? profileData.stories.length : 0);
            updateGoalsCount(profileData.goals ? profileData.goals.length : 0);
            updatePortfolioCount(profileData.portfolio ? profileData.portfolio.length : 0);
            updateJobOpportunitiesCount(activeJobsCount);
            refreshMindmap();

            // Show success message
            const goalsCount = profileData.goals ? profileData.goals.length : 0;
            const portfolioCount = profileData.portfolio ? profileData.portfolio.length : 0;
            const jobsCount = profileData.jobOpportunities ? profileData.jobOpportunities.length : 0;

            alert(`Loaded example profile: ${profile.firstName} ${profile.lastName}\n\n${profileData.experiences.length} experiences, ${profileData.stories ? profileData.stories.length : 0} stories, ${goalsCount} goals, ${portfolioCount} portfolio projects, and ${jobsCount} job opportunities imported.`);
        }

        // Store restore data globally for modal processing
        let pendingImportData = null;

        // Open Restore Mode Modal
        function openImportModeModal(data) {
            // Store data for processing
            pendingImportData = data;

            // Populate summary
            const summaryDiv = document.getElementById('importSummary');
            const storiesCount = (data.behavioralStories || data.stories || []).length;
            const goalsCount = (data.goals || []).length;
            const portfolioCount = (data.portfolio || []).length;
            const jobsCount = (data.jobOpportunities || []).length;

            summaryDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="ph ph-user" style="color: var(--color-primary-blue);"></i>
                    <strong>Profile:</strong> ${data.userFirstName} ${data.userLastName}${data.userEmail ? ` (${data.userEmail})` : ''}
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="ph ph-briefcase" style="color: var(--color-primary-blue);"></i>
                    <strong>${data.experiences.length}</strong> experiences
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="ph ph-chat-circle-text" style="color: var(--color-primary-blue);"></i>
                    <strong>${storiesCount}</strong> stories
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="ph ph-target" style="color: var(--color-primary-blue);"></i>
                    <strong>${goalsCount}</strong> goals
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="ph ph-folder-open" style="color: var(--color-primary-blue);"></i>
                    <strong>${portfolioCount}</strong> portfolio projects
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="ph ph-suitcase" style="color: var(--color-primary-blue);"></i>
                    <strong>${jobsCount}</strong> job opportunities
                </div>
            `;

            // Show modal
            document.getElementById('importModeModal').style.display = 'flex';
        }

        // Close Restore Mode Modal
        function closeImportModeModal() {
            document.getElementById('importModeModal').style.display = 'none';
            pendingImportData = null;
        }

        // Process Restore with Selected Mode
        function processImportWithMode(overwriteMode) {
            if (!pendingImportData) {
                alert('No import data available.');
                return;
            }

            const data = pendingImportData;
            closeImportModeModal();

            // Continue with import logic
            const importMode = overwriteMode;

            if (importMode) {
                // OVERWRITE MODE - Clear all existing data first
                localStorage.removeItem('cleansheet_profile');
                localStorage.removeItem('cleansheet_experiences');
                localStorage.removeItem('behavioralStories');
                localStorage.removeItem('cleansheet_stories');
                localStorage.removeItem('jobOpportunities');
                localStorage.removeItem(`jobOpportunities_${currentPersona}`);
                localStorage.removeItem('applicationMaterials');
                localStorage.removeItem(`userGoals_${currentPersona}`);
                localStorage.removeItem(`userPortfolio_${currentPersona}`);
                localStorage.removeItem(`interview_documents_${currentPersona}`);
                localStorage.removeItem(`diagrams_${currentPersona}`);
                localStorage.removeItem(`whiteboards_${currentPersona}`);
                localStorage.removeItem(`markdown_${currentPersona}`);
                localStorage.removeItem(`plantuml_${currentPersona}`);
                localStorage.removeItem(`code_${currentPersona}`);
                localStorage.removeItem(`mermaid_${currentPersona}`);
                localStorage.removeItem(`presentations_${currentPersona}`);
                localStorage.removeItem(`user_latex_documents_${currentPersona}`);
            }

            // Import profile data
            const profile = {
                firstName: data.userFirstName,
                lastName: data.userLastName,
                profession: data.userOccupation || '',
                goal: data.userGoals || '',
                email: data.userEmail || ''
            };
            localStorage.setItem('cleansheet_profile', JSON.stringify(profile));

            // Import experiences
            const newExperiences = data.experiences.map(exp => ({
                id: exp.id || `exp_${Date.now()}_${Math.random()}`,
                role: exp.role || exp.title || '',
                organizationName: exp.organizationName || exp.company || '',
                location: exp.location || '',
                startDate: exp.startDate || '',
                endDate: exp.endDate || '',
                description: exp.description || '',
                technologies: exp.technologies || [],
                careerPaths: exp.careerPaths || [],
                functionalRoles: exp.functionalRoles || [],
                skills: exp.skills || exp.keySkills || [],
                keySkills: exp.keySkills || exp.skills || [],
                competencies: exp.competencies || [],
                projectTypes: exp.projectTypes || [],
                internalStakeholders: exp.internalStakeholders || [],
                externalStakeholders: exp.externalStakeholders || [],
                achievements: exp.achievements || []
            }));

            if (!importMode) {
                // UPDATE MODE - Merge with existing experiences
                const existingExperiences = JSON.parse(localStorage.getItem('cleansheet_experiences') || '[]');
                const mergedExperiences = [...existingExperiences, ...newExperiences];
                localStorage.setItem('cleansheet_experiences', JSON.stringify(mergedExperiences));
            } else {
                // OVERWRITE MODE - Replace experiences
                localStorage.setItem('cleansheet_experiences', JSON.stringify(newExperiences));
            }

            // Import stories
            const newStories = data.behavioralStories || data.stories || [];
            if (!importMode) {
                // UPDATE MODE - Merge with existing stories
                const existingStories = JSON.parse(localStorage.getItem('behavioralStories') || '[]');
                const mergedStories = [...existingStories, ...newStories];
                localStorage.setItem('cleansheet_stories', JSON.stringify(mergedStories));
                localStorage.setItem('behavioralStories', JSON.stringify(mergedStories));
            } else {
                // OVERWRITE MODE - Replace stories
                localStorage.setItem('cleansheet_stories', JSON.stringify(newStories));
                localStorage.setItem('behavioralStories', JSON.stringify(newStories));
            }

            // Import goals
            const newGoals = data.goals || [];
            if (newGoals.length > 0) {
                if (!importMode) {
                    // UPDATE MODE - Merge with existing goals
                    const existingGoals = JSON.parse(localStorage.getItem(`userGoals_${currentPersona}`) || '[]');
                    const mergedGoals = [...existingGoals, ...newGoals];
                    localStorage.setItem(`userGoals_${currentPersona}`, JSON.stringify(mergedGoals));
                } else {
                    // OVERWRITE MODE - Replace goals
                    localStorage.setItem(`userGoals_${currentPersona}`, JSON.stringify(newGoals));
                }
            }

            // Import portfolio
            const newPortfolio = data.portfolio || [];
            if (newPortfolio.length > 0) {
                if (!importMode) {
                    // UPDATE MODE - Merge with existing portfolio
                    const existingPortfolio = JSON.parse(localStorage.getItem(`userPortfolio_${currentPersona}`) || '[]');
                    const mergedPortfolio = [...existingPortfolio, ...newPortfolio];
                    localStorage.setItem(`userPortfolio_${currentPersona}`, JSON.stringify(mergedPortfolio));
                } else {
                    // OVERWRITE MODE - Replace portfolio
                    localStorage.setItem(`userPortfolio_${currentPersona}`, JSON.stringify(newPortfolio));
                }
            }

            // Import diagrams
            const newDiagrams = data.diagrams || [];
            if (newDiagrams.length > 0) {
                if (!importMode) {
                    // UPDATE MODE - Merge with existing diagrams
                    const existingDiagrams = JSON.parse(localStorage.getItem(`diagrams_${currentPersona}`) || '[]');
                    const mergedDiagrams = [...existingDiagrams, ...newDiagrams];
                    localStorage.setItem(`diagrams_${currentPersona}`, JSON.stringify(mergedDiagrams));
                } else {
                    // OVERWRITE MODE - Replace diagrams
                    localStorage.setItem(`diagrams_${currentPersona}`, JSON.stringify(newDiagrams));
                }
            }

            // Import documents
            const newDocuments = data.documents || [];
            if (newDocuments.length > 0) {
                if (!importMode) {
                    // UPDATE MODE - Merge with existing documents
                    const existingDocuments = JSON.parse(localStorage.getItem(`interview_documents_${currentPersona}`) || '[]');
                    const mergedDocuments = [...existingDocuments, ...newDocuments];
                    localStorage.setItem(`interview_documents_${currentPersona}`, JSON.stringify(mergedDocuments));
                } else {
                    // OVERWRITE MODE - Replace documents
                    localStorage.setItem(`interview_documents_${currentPersona}`, JSON.stringify(newDocuments));
                }
            }

            // Import whiteboards
            const newWhiteboards = data.whiteboards || [];
            if (newWhiteboards.length > 0) {
                if (!importMode) {
                    // UPDATE MODE - Merge with existing whiteboards
                    const existingWhiteboards = JSON.parse(localStorage.getItem(`whiteboards_${currentPersona}`) || '[]');
                    const mergedWhiteboards = [...existingWhiteboards, ...newWhiteboards];
                    localStorage.setItem(`whiteboards_${currentPersona}`, JSON.stringify(mergedWhiteboards));
                } else {
                    // OVERWRITE MODE - Replace whiteboards
                    localStorage.setItem(`whiteboards_${currentPersona}`, JSON.stringify(newWhiteboards));
                }
            }

            // Import markdown documents
            const newMarkdown = data.markdown || [];
            if (newMarkdown.length > 0) {
                if (!importMode) {
                    const existingMarkdown = JSON.parse(localStorage.getItem(`markdown_${currentPersona}`) || '[]');
                    const mergedMarkdown = [...existingMarkdown, ...newMarkdown];
                    localStorage.setItem(`markdown_${currentPersona}`, JSON.stringify(mergedMarkdown));
                } else {
                    localStorage.setItem(`markdown_${currentPersona}`, JSON.stringify(newMarkdown));
                }
            }

            // Import PlantUML diagrams
            const newPlantUML = data.plantuml || [];
            if (newPlantUML.length > 0) {
                if (!importMode) {
                    const existingPlantUML = JSON.parse(localStorage.getItem(`plantuml_${currentPersona}`) || '[]');
                    const mergedPlantUML = [...existingPlantUML, ...newPlantUML];
                    localStorage.setItem(`plantuml_${currentPersona}`, JSON.stringify(mergedPlantUML));
                } else {
                    localStorage.setItem(`plantuml_${currentPersona}`, JSON.stringify(newPlantUML));
                }
            }

            // Import code snippets
            const newCode = data.code || [];
            if (newCode.length > 0) {
                if (!importMode) {
                    const existingCode = JSON.parse(localStorage.getItem(`code_${currentPersona}`) || '[]');
                    const mergedCode = [...existingCode, ...newCode];
                    localStorage.setItem(`code_${currentPersona}`, JSON.stringify(mergedCode));
                } else {
                    localStorage.setItem(`code_${currentPersona}`, JSON.stringify(newCode));
                }
            }

            // Import Mermaid diagrams
            const newMermaid = data.mermaid || [];
            if (newMermaid.length > 0) {
                if (!importMode) {
                    const existingMermaid = JSON.parse(localStorage.getItem(`mermaid_${currentPersona}`) || '[]');
                    const mergedMermaid = [...existingMermaid, ...newMermaid];
                    localStorage.setItem(`mermaid_${currentPersona}`, JSON.stringify(mergedMermaid));
                } else {
                    localStorage.setItem(`mermaid_${currentPersona}`, JSON.stringify(newMermaid));
                }
            }

            // Import presentations
            const newPresentations = data.presentations || [];
            if (newPresentations.length > 0) {
                if (!importMode) {
                    const existingPresentations = JSON.parse(localStorage.getItem(`presentations_${currentPersona}`) || '[]');
                    const mergedPresentations = [...existingPresentations, ...newPresentations];
                    localStorage.setItem(`presentations_${currentPersona}`, JSON.stringify(mergedPresentations));
                } else {
                    localStorage.setItem(`presentations_${currentPersona}`, JSON.stringify(newPresentations));
                }
            }

            // Import LaTeX documents
            const newLatex = data.latex || [];
            if (newLatex.length > 0) {
                if (!importMode) {
                    const existingLatex = JSON.parse(localStorage.getItem(`user_latex_documents_${currentPersona}`) || '[]');
                    const mergedLatex = [...existingLatex, ...newLatex];
                    localStorage.setItem(`user_latex_documents_${currentPersona}`, JSON.stringify(mergedLatex));
                } else {
                    localStorage.setItem(`user_latex_documents_${currentPersona}`, JSON.stringify(newLatex));
                }
            }

            // Import job opportunities
            const newJobOpportunities = data.jobOpportunities || [];
            if (newJobOpportunities.length > 0) {
                if (!importMode) {
                    // UPDATE MODE - Merge with existing job opportunities
                    const existingJobs = JSON.parse(localStorage.getItem(`jobOpportunities_${currentPersona}`) || '[]');
                    const mergedJobs = [...existingJobs, ...newJobOpportunities];
                    localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(mergedJobs));
                } else {
                    // OVERWRITE MODE - Replace job opportunities
                    localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(newJobOpportunities));
                }
            }

            // Show success message
            const mode = importMode ? 'OVERWRITE' : 'UPDATE';
            alert(`Successfully imported (${mode} mode):\n- Profile: ${profile.firstName} ${profile.lastName}\n- ${newExperiences.length} experiences\n- ${newStories.length} stories\n- ${newGoals.length} goals\n- ${newPortfolio.length} portfolio projects\n- ${newDiagrams.length} diagrams\n- ${newDocuments.length} documents\n- ${newWhiteboards.length} whiteboards\n- ${newMarkdown.length} markdown docs\n- ${newPlantUML.length} plantuml diagrams\n- ${newCode.length} code snippets\n- ${newMermaid.length} mermaid diagrams\n- ${newPresentations.length} presentations\n- ${newJobOpportunities.length} job opportunities\n\nPage will refresh to update the canvas.`);

            // Refresh page to update all badge numbers and UI
            window.location.reload();
        }

        // Restore Canvas Data from Backup
        function importCanvasData() {
            document.getElementById('profileDropdown').classList.remove('active');

            const fileInput = document.getElementById('jsonFileInput');
            fileInput.value = ''; // Reset input

            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Validate JSON structure
                        if (!data.userFirstName || !data.userLastName || !data.experiences) {
                            alert('Invalid JSON format. Please ensure the file contains userFirstName, userLastName, and experiences fields.');
                            return;
                        }

                        // Show restore mode selection modal
                        openImportModeModal(data);

                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            fileInput.click();
        }

        // Backup Canvas Data to JSON
        async function exportCanvasDataWithOptions(includeApiKeys = false, password = null) {
            document.getElementById('profileDropdown').classList.remove('active');

            try {
                // Get profile data
                const profile = loadProfile();

                // Get experiences from localStorage
                const experiencesJson = localStorage.getItem('cleansheet_experiences');
                const experiences = experiencesJson ? JSON.parse(experiencesJson) : [];

                // Get stories from localStorage (check both keys for backwards compatibility)
                let storiesJson = localStorage.getItem('cleansheet_stories');
                if (!storiesJson) {
                    storiesJson = localStorage.getItem('behavioralStories');
                }
                const stories = storiesJson ? JSON.parse(storiesJson) : [];

                // Get goals from localStorage
                const goalsJson = localStorage.getItem(`userGoals_${currentPersona}`);
                const goals = goalsJson ? JSON.parse(goalsJson) : [];

                // Get portfolio from localStorage
                const portfolioJson = localStorage.getItem(`userPortfolio_${currentPersona}`);
                const portfolio = portfolioJson ? JSON.parse(portfolioJson) : [];

                // Get diagrams from localStorage
                const diagramsJson = localStorage.getItem(`diagrams_${currentPersona}`);
                const diagrams = diagramsJson ? JSON.parse(diagramsJson) : [];

                // Get documents from localStorage
                const documentsJson = localStorage.getItem(`interview_documents_${currentPersona}`);
                const documents = documentsJson ? JSON.parse(documentsJson) : [];

                // Get whiteboards from localStorage
                const whiteboardsJson = localStorage.getItem(`whiteboards_${currentPersona}`);
                const whiteboards = whiteboardsJson ? JSON.parse(whiteboardsJson) : [];

                // Get new asset types from localStorage
                const markdownJson = localStorage.getItem(`markdown_${currentPersona}`);
                const markdown = markdownJson ? JSON.parse(markdownJson) : [];

                const plantumlJson = localStorage.getItem(`plantuml_${currentPersona}`);
                const plantuml = plantumlJson ? JSON.parse(plantumlJson) : [];

                const codeJson = localStorage.getItem(`code_${currentPersona}`);
                const code = codeJson ? JSON.parse(codeJson) : [];

                const mermaidJson = localStorage.getItem(`mermaid_${currentPersona}`);
                const mermaid = mermaidJson ? JSON.parse(mermaidJson) : [];

                const presentationsJson = localStorage.getItem(`presentations_${currentPersona}`);
                const presentations = presentationsJson ? JSON.parse(presentationsJson) : [];

                // Get LaTeX documents from localStorage
                const latexJson = localStorage.getItem(`user_latex_documents_${currentPersona}`);
                const latex = latexJson ? JSON.parse(latexJson) : [];

                // Get job opportunities from localStorage
                const jobOpportunitiesJson = localStorage.getItem(`jobOpportunities_${currentPersona}`);
                const jobOpportunities = jobOpportunitiesJson ? JSON.parse(jobOpportunitiesJson) : [];

                // Format experiences to match the schema
                const formattedExperiences = experiences.map((exp, index) => ({
                    id: exp.id || `exp_${Date.now()}_${index}`,
                    organizationName: exp.organizationName || exp.organization || exp.company || '',
                    role: exp.role || exp.title || exp.name || '',
                    location: exp.location || '',
                    startDate: exp.startDate || '',
                    endDate: exp.endDate || '',
                    description: exp.description || '',
                    technologies: exp.technologies || [],
                    careerPaths: exp.careerPaths || [],
                    functionalRoles: exp.functionalRoles || [],
                    skills: exp.skills || exp.keySkills || [],
                    keySkills: exp.keySkills || exp.skills || [],
                    competencies: exp.competencies || [],
                    projectTypes: exp.projectTypes || [],
                    internalStakeholders: exp.internalStakeholders || [],
                    externalStakeholders: exp.externalStakeholders || [],
                    achievements: exp.achievements || []
                }));

                // Create export object
                const exportData = {
                    userFirstName: profile.firstName,
                    userLastName: profile.lastName,
                    userOccupation: profile.profession,
                    userGoals: profile.goal,
                    userEmail: profile.email,
                    experiences: formattedExperiences,
                    stories: stories,
                    goals: goals,
                    portfolio: portfolio,
                    diagrams: diagrams,
                    documents: documents,
                    whiteboards: whiteboards,
                    markdown: markdown,
                    plantuml: plantuml,
                    code: code,
                    mermaid: mermaid,
                    presentations: presentations,
                    latex: latex,
                    jobOpportunities: jobOpportunities,
                    exportDate: new Date().toISOString(),
                    version: '4.1'
                };

                // Handle API key backup if requested
                if (includeApiKeys && password) {
                    try {
                        console.log('[Backup] Including API keys with password protection');

                        // Load encrypted LLM config from localStorage
                        const llmConfigEncrypted = localStorage.getItem('llm_config_encrypted');

                        if (llmConfigEncrypted) {
                            const llmConfig = JSON.parse(llmConfigEncrypted);
                            const providers = [];

                            // Decrypt and re-encrypt API keys for each provider
                            const apiKeysData = {};

                            // Process OpenAI keys if configured
                            if (llmConfig.openai?.apiKey) {
                                try {
                                    // Decrypt with device key
                                    const decryptedKey = await CleansheetCrypto.decrypt(llmConfig.openai.apiKey);

                                    // Re-encrypt with password
                                    const passwordEncryptedKey = await CleansheetCrypto.encryptWithPassword(decryptedKey, password);

                                    apiKeysData.openai = {
                                        apiKey: passwordEncryptedKey,
                                        model: llmConfig.openai.model
                                    };
                                    providers.push('openai');
                                    console.log('[Backup] Included OpenAI API key');
                                } catch (error) {
                                    console.error('[Backup] Failed to process OpenAI key:', error);
                                }
                            }

                            // Process Anthropic keys if configured
                            if (llmConfig.anthropic?.apiKey) {
                                try {
                                    // Decrypt with device key
                                    const decryptedKey = await CleansheetCrypto.decrypt(llmConfig.anthropic.apiKey);

                                    // Re-encrypt with password
                                    const passwordEncryptedKey = await CleansheetCrypto.encryptWithPassword(decryptedKey, password);

                                    apiKeysData.anthropic = {
                                        apiKey: passwordEncryptedKey,
                                        model: llmConfig.anthropic.model
                                    };
                                    providers.push('anthropic');
                                    console.log('[Backup] Included Anthropic API key');
                                } catch (error) {
                                    console.error('[Backup] Failed to process Anthropic key:', error);
                                }
                            }

                            // Process Gemini keys if configured
                            if (llmConfig.gemini?.apiKey) {
                                try {
                                    // Decrypt with device key
                                    const decryptedKey = await CleansheetCrypto.decrypt(llmConfig.gemini.apiKey);

                                    // Re-encrypt with password
                                    const passwordEncryptedKey = await CleansheetCrypto.encryptWithPassword(decryptedKey, password);

                                    apiKeysData.gemini = {
                                        apiKey: passwordEncryptedKey,
                                        model: llmConfig.gemini.model
                                    };
                                    providers.push('gemini');
                                    console.log('[Backup] Included Gemini API key');
                                } catch (error) {
                                    console.error('[Backup] Failed to process Gemini key:', error);
                                }
                            }

                            // Add other providers (Azure) when they're implemented

                            if (providers.length > 0) {
                                exportData.apiKeysEncrypted = {
                                    data: apiKeysData,
                                    providers: providers,
                                    activeProvider: llmConfig.activeProvider,
                                    encrypted: true
                                };

                                console.log('[Backup] Successfully added encrypted API keys for:', providers.join(', '));
                            }
                        } else {
                            console.log('[Backup] No LLM config found to backup');
                        }
                    } catch (error) {
                        console.error('[Backup] Error processing API keys:', error);
                        alert('Warning: Failed to backup API keys: ' + error.message + '\n\nContinuing with backup without API keys.');
                    }
                }

                // Create download
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `cleansheet-canvas-${profile.firstName}-${profile.lastName}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                let successMessage = `Successfully exported:\n- Profile: ${profile.firstName} ${profile.lastName}\n- ${formattedExperiences.length} experiences\n- ${stories.length} stories\n- ${goals.length} goals\n- ${portfolio.length} portfolio projects\n- ${diagrams.length} diagrams\n- ${documents.length} documents\n- ${whiteboards.length} whiteboards\n- ${markdown.length} markdown docs\n- ${plantuml.length} plantuml diagrams\n- ${code.length} code snippets\n- ${mermaid.length} mermaid diagrams\n- ${presentations.length} presentations\n- ${latex.length} LaTeX documents\n- ${jobOpportunities.length} job opportunities`;

                // Add API key info if included
                if (includeApiKeys && exportData.apiKeysEncrypted && exportData.apiKeysEncrypted.providers.length > 0) {
                    successMessage += `\n\n🔒 API keys included (password-protected) for: ${exportData.apiKeysEncrypted.providers.join(', ')}`;
                }

                alert(successMessage);

            } catch (error) {
                alert('Error exporting data: ' + error.message);
            }
        }

        // Data Management Modal Functions
        function openDataManagementModal() {
            // Close profile dropdown
            document.getElementById('profileDropdown').classList.remove('active');
            // Close any open slideouts
            closeInterviewSlideout();
            // Open the data management modal
            document.getElementById('dataManagementModal').style.display = 'flex';
        }

        function closeDataManagementModal() {
            document.getElementById('dataManagementModal').style.display = 'none';
        }

        function handleBackupFromModal() {
            // Close the data management modal
            closeDataManagementModal();
            // Open the backup options modal
            document.getElementById('backupOptionsModal').style.display = 'flex';
            // Reset form
            document.getElementById('includeApiKeysCheckbox').checked = false;
            document.getElementById('backupPassword').value = '';
            document.getElementById('backupPasswordConfirm').value = '';
            document.getElementById('apiKeyPasswordSection').style.display = 'none';
        }

        function closeBackupOptionsModal() {
            document.getElementById('backupOptionsModal').style.display = 'none';
        }

        function toggleApiKeyPassword() {
            const checkbox = document.getElementById('includeApiKeysCheckbox');
            const passwordSection = document.getElementById('apiKeyPasswordSection');
            passwordSection.style.display = checkbox.checked ? 'block' : 'none';
        }

        async function executeBackupWithOptions() {
            const includeApiKeys = document.getElementById('includeApiKeysCheckbox').checked;
            let backupPassword = null;

            // If including API keys, validate password
            if (includeApiKeys) {
                const password = document.getElementById('backupPassword').value;
                const confirmPassword = document.getElementById('backupPasswordConfirm').value;

                // Validate password
                if (!password || password.length < 8) {
                    alert('Password must be at least 8 characters long');
                    return;
                }

                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }

                backupPassword = password;
            }

            // Close the modal
            closeBackupOptionsModal();

            // Call modified export function with options
            await exportCanvasDataWithOptions(includeApiKeys, backupPassword);
        }

        // Restore state management
        let pendingRestoreData = null;
        let pendingRestoreMode = null;
        let restorePasswordAttempts = 0;
        const MAX_RESTORE_ATTEMPTS = 3;

        function handleRestoreFromModal(mode) {
            // Close the data management modal
            closeDataManagementModal();

            // Create and trigger file input
            const fileInput = document.getElementById('jsonFileInput');
            fileInput.value = ''; // Reset input

            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Validate JSON structure
                        if (!data.userFirstName || !data.userLastName || !data.experiences) {
                            alert('Invalid JSON format. Please ensure the file contains userFirstName, userLastName, and experiences fields.');
                            return;
                        }

                        // Check if backup contains encrypted API keys
                        if (data.apiKeysEncrypted && data.apiKeysEncrypted.encrypted && data.apiKeysEncrypted.providers && data.apiKeysEncrypted.providers.length > 0) {
                            console.log('[Restore] Backup contains encrypted API keys for:', data.apiKeysEncrypted.providers.join(', '));

                            // Store data and mode for later use
                            pendingRestoreData = data;
                            pendingRestoreMode = mode;
                            restorePasswordAttempts = 0;

                            // Show password modal
                            showRestorePasswordModal(data.apiKeysEncrypted.providers);
                        } else {
                            console.log('[Restore] No encrypted API keys in backup, proceeding with normal import');

                            // Process import directly based on mode
                            pendingImportData = data;
                            if (mode === 'overwrite') {
                                processImportWithMode(true); // true = overwrite
                            } else if (mode === 'update') {
                                processImportWithMode(false); // false = update/merge
                            }
                        }

                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            fileInput.click();
        }

        function showRestorePasswordModal(providers) {
            // Set providers list
            document.getElementById('restoreProvidersList').textContent = providers.join(', ');

            // Reset form
            document.getElementById('restorePassword').value = '';
            document.getElementById('restorePasswordError').style.display = 'none';
            document.getElementById('restoreAttemptsRemaining').textContent = MAX_RESTORE_ATTEMPTS - restorePasswordAttempts;

            // Show modal
            document.getElementById('restorePasswordModal').style.display = 'flex';
        }

        function closeRestorePasswordModal() {
            document.getElementById('restorePasswordModal').style.display = 'none';
            pendingRestoreData = null;
            pendingRestoreMode = null;
            restorePasswordAttempts = 0;
        }

        async function attemptRestoreWithPassword() {
            const password = document.getElementById('restorePassword').value;

            // Validate password input
            if (!password || password.length < 8) {
                showRestorePasswordError('Password must be at least 8 characters long');
                return;
            }

            try {
                console.log('[Restore] Attempting to decrypt API keys...');

                // Try to decrypt the API keys
                const decryptedKeys = await decryptApiKeysFromBackup(pendingRestoreData.apiKeysEncrypted, password);

                if (decryptedKeys) {
                    console.log('[Restore] Successfully decrypted API keys');

                    // Re-encrypt with device keys and save to localStorage
                    await saveDecryptedKeysToConfig(decryptedKeys, pendingRestoreData.apiKeysEncrypted.activeProvider);

                    // Save data and mode to local variables BEFORE closing modal (which resets them)
                    const dataToRestore = { ...pendingRestoreData };
                    const restoreMode = pendingRestoreMode;

                    // Close password modal (this resets pendingRestoreData and pendingRestoreMode)
                    closeRestorePasswordModal();

                    // Continue with normal import (without apiKeysEncrypted field)
                    delete dataToRestore.apiKeysEncrypted;

                    pendingImportData = dataToRestore;
                    if (restoreMode === 'overwrite') {
                        processImportWithMode(true);
                    } else if (restoreMode === 'update') {
                        processImportWithMode(false);
                    }

                    showToast('API keys restored successfully', 'success');
                }
            } catch (error) {
                console.error('[Restore] Decryption failed:', error);

                restorePasswordAttempts++;
                const attemptsLeft = MAX_RESTORE_ATTEMPTS - restorePasswordAttempts;

                document.getElementById('restoreAttemptsRemaining').textContent = attemptsLeft;

                if (attemptsLeft > 0) {
                    showRestorePasswordError(`Incorrect password. ${attemptsLeft} attempt${attemptsLeft > 1 ? 's' : ''} remaining.`);
                } else {
                    showRestorePasswordError('Maximum attempts reached. Please choose "Restore Without Keys" to continue.');
                    // Disable the unlock button
                    document.querySelector('#restorePasswordModal button[onclick="attemptRestoreWithPassword()"]').disabled = true;
                }
            }
        }

        function showRestorePasswordError(message) {
            const errorDiv = document.getElementById('restorePasswordError');
            const errorText = document.getElementById('restorePasswordErrorText');
            errorText.innerHTML = `<i class="ph ph-warning" style="margin-right: 4px;"></i> ${message}`;
            errorDiv.style.display = 'block';
        }

        async function decryptApiKeysFromBackup(apiKeysEncrypted, password) {
            const decryptedKeys = {};

            for (const provider of apiKeysEncrypted.providers) {
                if (apiKeysEncrypted.data[provider] && apiKeysEncrypted.data[provider].apiKey) {
                    try {
                        // Decrypt with password
                        const decryptedKey = await CleansheetCrypto.decryptWithPassword(
                            apiKeysEncrypted.data[provider].apiKey,
                            password
                        );

                        decryptedKeys[provider] = {
                            apiKey: decryptedKey,
                            model: apiKeysEncrypted.data[provider].model
                        };
                    } catch (error) {
                        console.error(`[Restore] Failed to decrypt ${provider} key:`, error);
                        throw error; // Re-throw to trigger password retry
                    }
                }
            }

            return decryptedKeys;
        }

        async function saveDecryptedKeysToConfig(decryptedKeys, activeProvider) {
            // Get current config or create new one
            let llmConfig = {};
            const existingConfig = localStorage.getItem('llm_config_encrypted');
            if (existingConfig) {
                llmConfig = JSON.parse(existingConfig);
            }

            // Re-encrypt each key with device encryption
            for (const provider in decryptedKeys) {
                const encryptedKey = await CleansheetCrypto.encrypt(decryptedKeys[provider].apiKey);

                llmConfig[provider] = {
                    apiKey: encryptedKey,
                    model: decryptedKeys[provider].model
                };
            }

            // Set active provider
            llmConfig.activeProvider = activeProvider;

            // Save to localStorage
            localStorage.setItem('llm_config_encrypted', JSON.stringify(llmConfig));

            console.log('[Restore] API keys re-encrypted and saved to localStorage');
        }

        function restoreWithoutKeys() {
            console.log('[Restore] User chose to restore without API keys');

            // Validate we have pending data
            if (!pendingRestoreData) {
                console.error('[Restore] No pending restore data found');
                alert('Error: No restore data available. Please try importing again.');
                closeRestorePasswordModal();
                return;
            }

            if (!pendingRestoreMode) {
                console.error('[Restore] No pending restore mode found');
                alert('Error: Restore mode not specified. Please try importing again.');
                closeRestorePasswordModal();
                return;
            }

            console.log('[Restore] Restore mode:', pendingRestoreMode);
            console.log('[Restore] Has data:', !!pendingRestoreData);

            // Save data and mode to local variables BEFORE closing modal (which resets them)
            const dataToRestore = { ...pendingRestoreData };
            const restoreMode = pendingRestoreMode;

            // Close password modal (this resets pendingRestoreData and pendingRestoreMode)
            closeRestorePasswordModal();

            // Continue with normal import (without apiKeysEncrypted field)
            delete dataToRestore.apiKeysEncrypted;

            console.log('[Restore] Prepared data for import (keys removed)');

            pendingImportData = dataToRestore;

            console.log('[Restore] Calling processImportWithMode with mode:', restoreMode);
            if (restoreMode === 'overwrite') {
                processImportWithMode(true);
            } else if (restoreMode === 'update') {
                processImportWithMode(false);
            } else {
                console.error('[Restore] Unknown restore mode:', restoreMode);
                alert('Error: Unknown restore mode. Please try importing again.');
                return;
            }

            console.log('[Restore] Import process initiated');
            showToast('Data restored without API keys', 'info');
        }

        // Install App Modal Functions
        function openInstallAppModal() {
            document.getElementById('profileDropdown').classList.remove('active');
            document.getElementById('installAppModal').style.display = 'flex';

            // Check install status and update UI
            updateInstallStatus();
        }

        function closeInstallAppModal() {
            document.getElementById('installAppModal').style.display = 'none';
        }

        function updateInstallStatus() {
            const installReady = document.getElementById('installReady');
            const installComplete = document.getElementById('installComplete');
            const installNotAvailable = document.getElementById('installNotAvailable');
            const manualInstructions = document.getElementById('manualInstructions');

            // Hide all status divs first
            installReady.style.display = 'none';
            installComplete.style.display = 'none';
            installNotAvailable.style.display = 'none';
            manualInstructions.style.display = 'none';

            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true) {
                // App is already installed
                installComplete.style.display = 'block';
                console.log('[PWA] App is already installed');
                return;
            }

            // Check if install prompt is available
            if (window.deferredPrompt) {
                // Install is available
                installReady.style.display = 'block';
                console.log('[PWA] Install prompt available');
            } else {
                // Install not available - show manual instructions
                installNotAvailable.style.display = 'block';
                manualInstructions.style.display = 'block';
                console.log('[PWA] Install prompt not available - showing manual instructions');
            }
        }

        function triggerPWAInstall() {
            if (!window.deferredPrompt) {
                console.log('[PWA] No install prompt available');
                alert('Install is not available at this time. Please try the manual installation instructions below.');
                return;
            }

            // Show the install prompt
            window.deferredPrompt.prompt();

            // Wait for the user to respond to the prompt
            window.deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('[PWA] User accepted the install prompt');

                    // Update UI to show installed state
                    document.getElementById('installReady').style.display = 'none';
                    document.getElementById('installComplete').style.display = 'block';

                    // Track with analytics
                    if (window.appInsights) {
                        appInsights.trackEvent({
                            name: 'PWA_Install_Accepted',
                            properties: {
                                timestamp: new Date().toISOString(),
                                source: 'in-app-modal'
                            }
                        });
                    }
                } else {
                    console.log('[PWA] User dismissed the install prompt');

                    // Track with analytics
                    if (window.appInsights) {
                        appInsights.trackEvent({
                            name: 'PWA_Install_Dismissed',
                            properties: {
                                timestamp: new Date().toISOString(),
                                source: 'in-app-modal'
                            }
                        });
                    }
                }

                // Clear the deferred prompt
                window.deferredPrompt = null;
            });
        }

        // Update experience count in D3 mindmap
        function updateExperienceCount(count) {
            // Update the personaData structure for current persona
            if (personaData[currentPersona] && personaData[currentPersona].children) {
                const careerExpNode = personaData[currentPersona].children.find(c => c.name === 'Career Experience');
                if (careerExpNode) {
                    careerExpNode.count = count;
                    console.log('[Badges] Updated Career Experience count to:', count, 'for persona:', currentPersona);
                }
            }
        }

        function updateStoryCount(count) {
            // Update the personaData structure for Interview Prep
            if (personaData[currentPersona] && personaData[currentPersona].children) {
                const interviewPrepNode = personaData[currentPersona].children.find(c => c.name === 'Interview Prep');
                if (interviewPrepNode) {
                    interviewPrepNode.count = count;
                    console.log('[Badges] Updated Interview Prep count to:', count, 'for persona:', currentPersona);
                }
            }
        }

        function updateGoalsCount(count) {
            // Update the personaData structure for Goals
            if (personaData[currentPersona] && personaData[currentPersona].children) {
                const goalsNode = personaData[currentPersona].children.find(c => c.name === 'Goals');
                if (goalsNode) {
                    goalsNode.count = count;
                    console.log('[Badges] Updated Goals count to:', count, 'for persona:', currentPersona);
                }
            }
        }

        function updateJobOpportunitiesCount(count) {
            console.log('[Count Update] updateJobOpportunitiesCount called with count:', count, 'for persona:', currentPersona);
            // Update the personaData structure for Job Opportunities
            if (personaData[currentPersona] && personaData[currentPersona].children) {
                const jobOpportunitiesNode = personaData[currentPersona].children.find(c => c.name === 'Job Opportunities');
                if (jobOpportunitiesNode) {
                    console.log('[Count Update] Found Job Opportunities node, setting count from', jobOpportunitiesNode.count, 'to', count);
                    jobOpportunitiesNode.count = count;
                    console.log('[Badges] Updated Job Opportunities count to:', count, 'for persona:', currentPersona);
                } else {
                    console.log('[Count Update] Job Opportunities node NOT found in personaData');
                }
            } else {
                console.log('[Count Update] personaData not available for persona:', currentPersona);
            }
        }

        // Main menu functions
        function setActiveMenu(clickedItem) {
            // Remove active class from all menu items
            document.querySelectorAll('.main-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            // Add active class to clicked item
            clickedItem.classList.add('active');

            // Get menu name
            const menuName = clickedItem.querySelector('span').textContent;

            // Show/hide appropriate view
            const homeView = document.getElementById('homeView');
            const jobSearchView = document.getElementById('jobSearchView');
            const libraryView = document.getElementById('libraryView');

            // Hide all views first
            homeView.style.display = 'none';
            jobSearchView.style.display = 'none';
            libraryView.style.display = 'none';

            if (menuName === 'Job Search') {
                jobSearchView.style.display = 'block';
                loadJobSearchView();
            } else if (menuName === 'Library') {
                libraryView.style.display = 'block';
                loadLibraryView();
            } else if (menuName === 'Home') {
                homeView.style.display = 'contents';
                // Hide projects view if it was open
                document.getElementById('projects-view').style.display = 'none';
                document.getElementById('canvas-mindmap').style.display = 'block';
                // Redraw mindmap when returning to Home view
                d3.select('#canvas-mindmap').selectAll('*').remove();

            // Hide any active tooltips when mindmap is cleared
            guidanceTooltip.hide();
                if (currentViewMode === 'seeker' || currentViewMode === 'professional') {
                    setTimeout(() => initializeMindmap(currentPersona), 50);
                } else {
                    setTimeout(() => initializeLearnerNetwork(currentPersona), 50);
                }
            } else if (menuName === 'Projects') {
                homeView.style.display = 'contents';
                // showProjectsView() is called by the onclick handler
            } else {
                // Reset to home if unimplemented section
                homeView.style.display = 'contents';
                document.querySelector('.main-menu-item').classList.add('active');
                clickedItem.classList.remove('active');
                alert(`${menuName} section coming soon! This is a demo of the Canvas interface navigation.`);
            }
        }

        function loadJobSearchView() {
            const container = document.getElementById('jobSearchView');

            container.innerHTML = `
                <div style="max-width: 1400px; margin: 0 auto;">
                    <!-- My Job Search Collapsible Section -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; overflow: hidden;">
                        <div onclick="toggleJobSearchSankey()" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-neutral-border);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="ph ph-funnel" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                                <div>
                                    <h3 style="font-family: var(--font-family-ui); font-size: 20px; color: var(--color-dark); margin: 0;">My Job Search Pipeline</h3>
                                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); margin: 4px 0 0 0;">Track your job search progress</p>
                                </div>
                            </div>
                            <i class="ph ph-caret-down" id="sankeyToggleIcon" style="font-size: 24px; color: var(--color-neutral-text); transition: transform 0.3s;"></i>
                        </div>
                        <div id="sankeyContainer" style="display: none; padding: 32px 20px;">
                            <div id="jobSearchSankey" style="width: 100%; height: 400px;"></div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h2 style="font-family: var(--font-family-ui); font-size: 28px; color: var(--color-dark); margin: 0 0 8px 0;">Job Search Aggregator</h2>
                            <p style="font-family: var(--font-family-body); color: var(--color-neutral-text-light); margin: 0;">Search across multiple job boards and configure automated alerts</p>
                        </div>
                        <button onclick="openAlertSettings()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px;">
                            <i class="ph ph-bell"></i>
                            Configure Alerts
                        </button>
                    </div>

                    <!-- Search Bar -->
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 120px; gap: 12px;">
                            <input type="text" placeholder="Job title, keywords..." style="padding: 12px 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 14px;">
                            <input type="text" placeholder="Location" style="padding: 12px 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; font-family: var(--font-family-body); font-size: 14px;">
                            <button style="padding: 12px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 8px; font-family: var(--font-family-ui); font-weight: 600; cursor: pointer; font-size: 14px;">
                                <i class="ph ph-magnifying-glass"></i> Search
                            </button>
                        </div>
                    </div>

                    <!-- Job Board Sources -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        ${renderJobBoard('LinkedIn', 'ph-linkedin-logo', '#0077B5', 847, true)}
                        ${renderJobBoard('Indeed', 'ph-briefcase', '#2164F3', 1203, true)}
                        ${renderJobBoard('Glassdoor', 'ph-building', '#0CAA41', 523, false)}
                        ${renderJobBoard('ZipRecruiter', 'ph-suitcase', '#1472E8', 412, true)}
                        ${renderJobBoard('Monster', 'ph-file-text', '#6E46AE', 289, false)}
                        ${renderJobBoard('CareerBuilder', 'ph-briefcase-metal', '#0B7A3E', 356, false)}
                    </div>

                    <!-- Recent Alerts -->
                    <div style="margin-top: 32px; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="font-family: var(--font-family-ui); font-size: 18px; color: var(--color-dark); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-bell-ringing"></i>
                            Active Job Alerts
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${renderAlertCard('Data Analyst', 'Remote', 'Daily', 3)}
                            ${renderAlertCard('Business Analyst', 'Minneapolis, MN', 'Weekly', 0)}
                            ${renderAlertCard('Operations Manager', 'Twin Cities Metro', 'Daily', 7)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderJobBoard(name, icon, color, count, enabled) {
            return `
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${color}; ${!enabled ? 'opacity: 0.6;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: ${color}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                                <i class="ph ${icon}"></i>
                            </div>
                            <div>
                                <h4 style="font-family: var(--font-family-ui); font-size: 18px; color: var(--color-dark); margin: 0 0 4px 0;">${name}</h4>
                                <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); margin: 0;">${count.toLocaleString()} jobs found</p>
                            </div>
                        </div>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleJobBoard('${name}', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                        </label>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="searchJobBoard('${name}')" style="flex: 1; padding: 8px 16px; background: ${color}; color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-weight: 600; cursor: pointer; font-size: 13px; ${!enabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${!enabled ? 'disabled' : ''}>
                            View Results
                        </button>
                        <button onclick="configureSource('${name}')" style="padding: 8px 12px; background: var(--color-neutral-background); color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer;">
                            <i class="ph ph-gear"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAlertCard(title, location, frequency, newJobs) {
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--color-neutral-background); border-radius: 8px; border: 1px solid var(--color-neutral-border);">
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${title}</div>
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light);">
                            <i class="ph ph-map-pin"></i> ${location} · ${frequency} alerts
                        </div>
                    </div>
                    ${newJobs > 0 ? `
                        <div style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600;">
                            ${newJobs} new
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 8px; margin-left: 16px;">
                        <button onclick="editAlert('${title}')" style="padding: 6px 12px; background: white; color: var(--color-primary-blue); border: 1px solid var(--color-primary-blue); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Edit
                        </button>
                        <button onclick="deleteAlert('${title}')" style="padding: 6px 12px; background: white; color: #c33; border: 1px solid #c33; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Delete
                        </button>
                    </div>
                </div>
            `;
        }

        // Job search action functions
        function openAlertSettings() {
            alert('Alert Configuration:\n\nConfigure automated job alerts based on:\n• Keywords and job titles\n• Location preferences\n• Salary ranges\n• Company size and industry\n• Remote/hybrid/on-site preferences\n• Frequency (instant, daily, weekly)\n\nAlerts will be sent via email and push notifications.');
        }

        function toggleJobBoard(name, enabled) {
            console.log(`${name} ${enabled ? 'enabled' : 'disabled'}`);
            loadJobSearchView();
        }

        function searchJobBoard(name) {
            alert(`Opening ${name} search results...\n\nThis would display job listings from ${name} matching your current search criteria.`);
        }

        function configureSource(name) {
            alert(`Configure ${name} Settings:\n\n• API credentials\n• Search parameters\n• Auto-apply preferences\n• Salary range filters\n• Experience level requirements`);
        }

        function editAlert(title) {
            alert(`Edit Alert: ${title}\n\nModify search criteria, location, frequency, and notification preferences.`);
        }

        function deleteAlert(title) {
            if (confirm(`Delete alert for "${title}"?`)) {
                alert('Alert deleted successfully.');
            }
        }

        // Job Search Sankey Functions
        let sankeyExpanded = false;

        function toggleJobSearchSankey() {
            sankeyExpanded = !sankeyExpanded;
            const container = document.getElementById('sankeyContainer');
            const icon = document.getElementById('sankeyToggleIcon');

            if (sankeyExpanded) {
                container.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
                // Initialize Sankey diagram
                setTimeout(() => initializeJobSearchSankey(), 100);
            } else {
                container.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function initializeJobSearchSankey() {
            const container = document.getElementById('jobSearchSankey');
            if (!container) return;

            // Clear any existing content
            d3.select('#jobSearchSankey').selectAll('*').remove();

            const width = container.clientWidth;
            const height = 400;

            // Calculate total found from enabled job boards
            const totalFound = 847 + 1203 + 412; // 2462 jobs from enabled boards

            // Cleansheet color scheme - professional blues with accent colors
            const data = {
                nodes: [
                    { name: 'Found' },        // 0
                    { name: 'Interested' },   // 1
                    { name: 'Applied' },      // 2
                    { name: 'Interviewing' }, // 3
                    { name: 'Offer' }         // 4
                ],
                links: [
                    { source: 0, target: 1, value: 150, color: '#B3D9FF' },  // Light blue
                    { source: 1, target: 2, value: 80, color: '#80BFFF' },   // Medium blue
                    { source: 2, target: 3, value: 25, color: '#4D9FFF' },   // Primary blue
                    { source: 3, target: 4, value: 3, color: '#0066CC' }     // Cleansheet primary blue
                ]
            };

            // Create SVG
            const svg = d3.select('#jobSearchSankey')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Define gradient for each link
            const defs = svg.append('defs');

            data.links.forEach((link, i) => {
                const gradient = defs.append('linearGradient')
                    .attr('id', `gradient-${i}`)
                    .attr('gradientUnits', 'userSpaceOnUse');

                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', link.color)
                    .attr('stop-opacity', 0.6);

                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', link.color)
                    .attr('stop-opacity', 0.3);
            });

            // Create Sankey generator
            const sankey = d3.sankey()
                .nodeWidth(15)  // Thin vertical bars
                .nodePadding(50)  // Generous spacing
                .extent([[80, 20], [width - 200, height - 20]]);

            // Generate Sankey layout
            const { nodes, links } = sankey({
                nodes: data.nodes.map(d => Object.assign({}, d)),
                links: data.links.map(d => Object.assign({}, d))
            });

            // Custom link path generator for smooth curves
            const linkPath = d3.linkHorizontal()
                .source(d => [d.source.x1, d.y0])
                .target(d => [d.target.x0, d.y1]);

            // Draw links with gradient fills
            svg.append('g')
                .selectAll('path')
                .data(links)
                .join('path')
                .attr('d', d => {
                    // Create smooth S-curve path
                    const sourceX = d.source.x1;
                    const targetX = d.target.x0;
                    const sourceY = d.y0;
                    const targetY = d.y1;
                    const sourceHeight = d.width;

                    const path = d3.path();
                    const midX = (sourceX + targetX) / 2;

                    path.moveTo(sourceX, sourceY);
                    path.bezierCurveTo(midX, sourceY, midX, targetY, targetX, targetY);
                    path.lineTo(targetX, targetY + sourceHeight);
                    path.bezierCurveTo(midX, targetY + sourceHeight, midX, sourceY + sourceHeight, sourceX, sourceY + sourceHeight);
                    path.closePath();

                    return path.toString();
                })
                .attr('fill', (d, i) => `url(#gradient-${i})`)
                .attr('opacity', 0.7)
                .on('mouseover', function() {
                    d3.select(this).attr('opacity', 0.9);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('opacity', 0.7);
                })
                .append('title')
                .text(d => `${d.source.name} → ${d.target.name}\n${d.value} jobs`);

            // Draw nodes as thin bars
            svg.append('g')
                .selectAll('rect')
                .data(nodes)
                .join('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', '#0066CC')
                .attr('opacity', 0.8);

            // Add stage labels to the left
            svg.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .attr('x', d => d.x0 - 10)
                .attr('y', d => (d.y0 + d.y1) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'end')
                .attr('font-family', 'var(--font-family-ui)')
                .attr('font-size', '14px')
                .attr('font-weight', '600')
                .attr('fill', '#333')
                .text(d => d.name);

            // Add count labels to the right
            svg.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .attr('x', d => d.x1 + 10)
                .attr('y', d => (d.y0 + d.y1) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'start')
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '18px')
                .attr('font-weight', '700')
                .attr('fill', '#0066CC')
                .text(d => {
                    if (d.name === 'Found') return totalFound.toLocaleString();
                    return d.value.toLocaleString();
                });

            // Add conversion percentages below count labels
            svg.append('g')
                .selectAll('text')
                .data(nodes.filter((d, i) => i > 0))
                .join('text')
                .attr('x', d => d.x1 + 10)
                .attr('y', d => (d.y0 + d.y1) / 2 + 18)
                .attr('text-anchor', 'start')
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '11px')
                .attr('font-weight', '400')
                .attr('fill', '#666')
                .text((d, i) => {
                    const conversions = [6.1, 53.3, 31.3, 12.0];
                    return `${conversions[i].toFixed(1)}% conv.`;
                });
        }

        // Close modal on background click
        document.getElementById('canvasModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCanvasModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCanvasModal();

                // Close any active modals
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                }
            }
        });

        // D3 Learner Network - Force-Directed Layout
        function initializeLearnerNetwork(persona) {
            const container = document.getElementById('canvas-mindmap');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Get persona data
            const data = getFilteredPersonaData(persona);
            if (!data) return;

            // Create network data
            const networkData = {
                nodes: [],
                links: []
            };

            // Add center node (learner)
            networkData.nodes.push({
                id: 'center',
                label: data.name,
                tier: 'center',
                x: width / 2,
                y: height / 2
            });

            // Two-tier structure: Center → Features (used by all view modes now)
            // In Personal mode with children: Three-tier structure: Center → Features → Children
            // For Finance and Shopping in Personal mode: Start collapsed, expand on click
            data.children.forEach((feature, idx) => {
                const featureId = `feature-${idx}`;
                const hasChildren = feature.children && feature.children.length > 0;
                const shouldStartCollapsed = currentViewMode === 'personal' &&
                    (feature.name === 'Finance' || feature.name === 'Shopping');

                networkData.nodes.push({
                    id: featureId,
                    label: feature.name,
                    tier: 'primary',
                    count: feature.count,
                    icon: feature.icon,
                    data: feature,
                    expanded: !shouldStartCollapsed,  // Track expansion state
                    hasChildren: hasChildren
                });

                // Link feature directly to center
                networkData.links.push({
                    source: 'center',
                    target: featureId
                });

                // Add child nodes if they exist AND (not Finance/Shopping OR already expanded)
                if (hasChildren && !shouldStartCollapsed) {
                    feature.children.forEach((child, childIdx) => {
                        const childId = `child-${idx}-${childIdx}`;
                        networkData.nodes.push({
                            id: childId,
                            label: child.name,
                            tier: 'tertiary',
                            count: child.count,
                            icon: child.icon,
                            data: child,
                            parentId: featureId
                        });

                        // Link child to parent feature
                        networkData.links.push({
                            source: featureId,
                            target: childId
                        });
                    });
                }
            });

            // Set initial positions for Personal mode to ensure viewport fit
            if (currentViewMode === 'personal') {
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = 180; // Distance from center to primary nodes
                const childRadius = 100; // Distance from primary to tertiary nodes

                networkData.nodes.forEach((node, i) => {
                    if (node.tier === 'center') {
                        node.x = centerX;
                        node.y = centerY;
                    } else if (node.tier === 'primary') {
                        // Arrange primary nodes in circle around center
                        const primaryNodes = networkData.nodes.filter(n => n.tier === 'primary');
                        const index = primaryNodes.indexOf(node);
                        const angle = (index / primaryNodes.length) * 2 * Math.PI - Math.PI / 2;
                        node.x = centerX + Math.cos(angle) * radius;
                        node.y = centerY + Math.sin(angle) * radius;
                    }
                });

                // Position child nodes around their parents
                networkData.links.forEach(link => {
                    const sourceNode = networkData.nodes.find(n => n.id === link.source);
                    const targetNode = networkData.nodes.find(n => n.id === link.target);

                    if (targetNode && targetNode.tier === 'tertiary' && sourceNode && sourceNode.x) {
                        // Get all children of this parent
                        const parentLinks = networkData.links.filter(l => l.source === sourceNode.id);
                        const childNodes = parentLinks.map(l => networkData.nodes.find(n => n.id === l.target));
                        const childIndex = childNodes.indexOf(targetNode);

                        // Calculate angle for this child
                        const baseAngle = Math.atan2(sourceNode.y - centerY, sourceNode.x - centerX);
                        const spreadAngle = Math.PI / 3; // 60 degree spread
                        const startAngle = baseAngle - spreadAngle / 2;
                        const angle = startAngle + (childIndex / (childNodes.length - 1 || 1)) * spreadAngle;

                        targetNode.x = sourceNode.x + Math.cos(angle) * childRadius;
                        targetNode.y = sourceNode.y + Math.sin(angle) * childRadius;
                    }
                });
            }

            // Function to toggle node expansion (for Finance and Shopping in Personal mode)
            function toggleNodeExpansion(clickedNode, networkData, nodeSelection, linkSelection, simulation) {
                // Collapse all other primary nodes with children
                networkData.nodes.filter(n => n.tier === 'primary' && n.hasChildren && n.id !== clickedNode.id)
                    .forEach(n => {
                        if (n.expanded) {
                            n.expanded = false;
                            // Remove child nodes and links
                            const childNodesToRemove = networkData.nodes.filter(child => child.parentId === n.id);
                            childNodesToRemove.forEach(child => {
                                const childIndex = networkData.nodes.indexOf(child);
                                if (childIndex > -1) networkData.nodes.splice(childIndex, 1);
                            });
                            networkData.links = networkData.links.filter(l => l.source.id !== n.id && l.target.id !== n.id);
                        }
                    });

                // Toggle the clicked node
                clickedNode.expanded = !clickedNode.expanded;

                if (clickedNode.expanded) {
                    // Add children
                    const feature = data.children.find(f => f.name === clickedNode.label);
                    if (feature && feature.children) {
                        const idx = data.children.indexOf(feature);
                        const centerX = width / 2;
                        const centerY = height / 2;
                        const childRadius = 100;

                        feature.children.forEach((child, childIdx) => {
                            const childId = `child-${idx}-${childIdx}`;
                            const childNode = {
                                id: childId,
                                label: child.name,
                                tier: 'tertiary',
                                count: child.count,
                                icon: child.icon,
                                data: child,
                                parentId: clickedNode.id
                            };

                            // Position child near parent
                            const baseAngle = Math.atan2(clickedNode.y - centerY, clickedNode.x - centerX);
                            const spreadAngle = Math.PI / 3;
                            const startAngle = baseAngle - spreadAngle / 2;
                            const angle = startAngle + (childIdx / (feature.children.length - 1 || 1)) * spreadAngle;

                            childNode.x = clickedNode.x + Math.cos(angle) * childRadius;
                            childNode.y = clickedNode.y + Math.sin(angle) * childRadius;

                            networkData.nodes.push(childNode);
                            networkData.links.push({
                                source: clickedNode.id,
                                target: childId
                            });
                        });
                    }
                } else {
                    // Remove children
                    const childNodesToRemove = networkData.nodes.filter(child => child.parentId === clickedNode.id);
                    childNodesToRemove.forEach(child => {
                        const childIndex = networkData.nodes.indexOf(child);
                        if (childIndex > -1) networkData.nodes.splice(childIndex, 1);
                    });
                    networkData.links = networkData.links.filter(l => {
                        const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                        const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                        return sourceId !== clickedNode.id;
                    });
                }

                // Update D3 visualization
                updateVisualization();
            }

            function updateVisualization() {
                // Update links - use proper D3 data join pattern
                const linkGroup = svg.selectAll('g').filter(function() {
                    return d3.select(this).selectAll('line').size() > 0;
                }).empty() ? svg.append('g') : svg.selectAll('g').filter(function() {
                    return d3.select(this).selectAll('line').size() > 0;
                });

                const linkUpdate = linkGroup.selectAll('line')
                    .data(networkData.links, d => {
                        const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                        const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                        return `${sourceId}-${targetId}`;
                    });

                linkUpdate.exit().transition().duration(300).style('opacity', 0).remove();

                const linkEnter = linkUpdate.enter()
                    .append('line')
                    .attr('stroke', 'rgba(34, 197, 94, 0.3)')
                    .attr('stroke-width', 2)
                    .style('opacity', 0);

                linkEnter.transition().duration(300).style('opacity', 1);

                // Merge for positioning updates
                const linkMerged = linkEnter.merge(linkUpdate);

                // Update nodes
                const nodeUpdate = svg.selectAll('g.network-node')
                    .data(networkData.nodes, d => d.id);

                nodeUpdate.exit().transition().duration(300).style('opacity', 0).remove();

                const nodeEnter = nodeUpdate.enter()
                    .append('g')
                    .attr('class', d => `network-node ${d.tier}`)
                    .style('opacity', 0)
                    .call(d3.drag()
                        .on('start', dragstarted)
                        .on('drag', dragged)
                        .on('end', dragended));

                // Add rectangles
                nodeEnter.each(function(d) {
                    const g = d3.select(this);
                    const rectWidth = d.icon ? 150 : 130;
                    g.append('rect')
                        .attr('width', rectWidth)
                        .attr('height', 35)
                        .attr('x', -rectWidth / 2)
                        .attr('y', -17.5)
                        .attr('fill', 'rgba(34, 197, 94, 0.2)')
                        .attr('rx', 6)
                        .style('cursor', 'pointer');

                    // Add icon
                    if (d.icon) {
                        g.append('foreignObject')
                            .attr('width', 20)
                            .attr('height', 20)
                            .attr('x', -70)
                            .attr('y', -10)
                            .append('xhtml:div')
                            .style('width', '20px')
                            .style('height', '20px')
                            .style('display', 'flex')
                            .style('align-items', 'center')
                            .style('justify-content', 'center')
                            .style('pointer-events', 'none')
                            .html(`<i class="ph ${d.icon}" style="font-size: 16px; color: #16a34a;"></i>`);
                    }

                    // Add text
                    g.append('text')
                        .attr('dy', '0.35em')
                        .attr('x', d.icon ? -46 : 0)
                        .attr('text-anchor', d.icon ? 'start' : 'middle')
                        .attr('font-family', 'var(--font-family-ui)')
                        .attr('font-size', '12px')
                        .attr('font-weight', '500')
                        .attr('fill', '#1a1a1a')
                        .attr('pointer-events', 'none')
                        .text(d.label);
                });

                // Add click handlers for new tertiary nodes
                nodeEnter.filter(d => d.tier === 'tertiary')
                    .on('click', function(event, d) {
                        event.stopPropagation();
                        handleFeatureClick(d.label);
                    })
                    .on('mouseover', function() {
                        d3.select(this).select('rect')
                            .transition().duration(200)
                            .attr('fill', 'rgba(34, 197, 94, 0.4)');
                    })
                    .on('mouseout', function() {
                        d3.select(this).select('rect')
                            .transition().duration(200)
                            .attr('fill', 'rgba(34, 197, 94, 0.2)');
                    });

                nodeEnter.transition().duration(300).style('opacity', 1);

                // Update simulation with new data
                simulation.nodes(networkData.nodes);
                simulation.force('link').links(networkData.links);

                // Update positions in tick function
                simulation.on('tick', () => {
                    linkMerged
                        .attr('x1', d => {
                            const source = typeof d.source === 'object' ? d.source : networkData.nodes.find(n => n.id === d.source);
                            return source ? source.x : 0;
                        })
                        .attr('y1', d => {
                            const source = typeof d.source === 'object' ? d.source : networkData.nodes.find(n => n.id === d.source);
                            return source ? source.y : 0;
                        })
                        .attr('x2', d => {
                            const target = typeof d.target === 'object' ? d.target : networkData.nodes.find(n => n.id === d.target);
                            return target ? target.x : 0;
                        })
                        .attr('y2', d => {
                            const target = typeof d.target === 'object' ? d.target : networkData.nodes.find(n => n.id === d.target);
                            return target ? target.y : 0;
                        });

                    svg.selectAll('g.network-node')
                        .attr('transform', d => `translate(${d.x},${d.y})`);
                });

                simulation.alpha(0.3).restart();
            }

            // Create SVG
            const svg = d3.select('#canvas-mindmap')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height]);

            // Create force simulation with adjusted parameters for three tiers
            const simulation = d3.forceSimulation(networkData.nodes)
                .force('link', d3.forceLink(networkData.links)
                    .id(d => d.id)
                    .distance(d => {
                        // Personal mode: shorter distances for tighter layout
                        if (currentViewMode === 'personal') {
                            if (d.source.tier === 'center') return 120;  // Center to primary
                            return 80;  // Primary to tertiary (children)
                        }
                        // Learner mode: original distances
                        if (d.source.tier === 'center') return 150;
                        return 200;
                    })
                    .strength(currentViewMode === 'personal' ? 0.5 : 0.3))
                .force('charge', d3.forceManyBody().strength(currentViewMode === 'personal' ? -150 : -300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => {
                    if (d.tier === 'center') return 75;
                    if (d.tier === 'secondary') return 85;
                    return 75;
                }));

            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(networkData.links)
                .join('line')
                .attr('stroke', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(0, 102, 204, 0.3)')
                .attr('stroke-width', 2);

            // Create nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(networkData.nodes)
                .join('g')
                .attr('class', d => `network-node ${d.tier}`)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add rectangles for all nodes
            node.each(function(d) {
                const g = d3.select(this);

                if (d.tier === 'center') {
                    g.append('rect')
                        .attr('width', 140)
                        .attr('height', 40)
                        .attr('x', -70)
                        .attr('y', -20)
                        .attr('fill', currentViewMode === 'personal' ? '#16a34a' : 'var(--color-primary-blue)')
                        .attr('rx', 6);
                } else if (d.tier === 'secondary') {
                    // Secondary nodes (Professional/Personal in Learner mode) - larger, darker
                    g.append('rect')
                        .attr('width', 150)
                        .attr('height', 45)
                        .attr('x', -75)
                        .attr('y', -22.5)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.5)' : 'rgba(0, 102, 204, 0.5)')
                        .attr('rx', 6)
                        .style('cursor', 'pointer');
                } else if (d.tier === 'primary') {
                    // Primary nodes (Professional/Personal mode features) - standard size
                    const width = currentViewMode === 'personal' && d.icon ? 160 : 140;
                    g.append('rect')
                        .attr('width', width)
                        .attr('height', 40)
                        .attr('x', -width / 2)
                        .attr('y', -20)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(0, 102, 204, 0.3)')
                        .attr('rx', 6)
                        .style('cursor', 'pointer');
                } else {
                    // Tertiary nodes (Learner mode features) - smaller, lighter
                    const width = currentViewMode === 'personal' && d.icon ? 150 : 130;
                    g.append('rect')
                        .attr('width', width)
                        .attr('height', 35)
                        .attr('x', -width / 2)
                        .attr('y', -17.5)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(0, 102, 204, 0.2)')
                        .attr('rx', 6)
                        .style('cursor', 'pointer');
                }
            });

            // Add icons for Personal mode nodes
            if (currentViewMode === 'personal') {
                node.filter(d => d.icon)
                    .append('foreignObject')
                    .attr('width', 20)
                    .attr('height', 20)
                    .attr('x', d => {
                        if (d.tier === 'primary') return -75;
                        if (d.tier === 'tertiary') return -70;
                        return -75;
                    })
                    .attr('y', d => {
                        if (d.tier === 'primary') return -10;
                        if (d.tier === 'tertiary') return -10;
                        return -10;
                    })
                    .append('xhtml:div')
                    .style('width', '20px')
                    .style('height', '20px')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('justify-content', 'center')
                    .style('pointer-events', 'none')
                    .html(d => `<i class="ph ${d.icon}" style="font-size: 16px; color: #16a34a;"></i>`);
            }

            // Add labels
            node.append('text')
                .attr('dy', '0.35em')
                .attr('x', d => {
                    // Position text after icon with small gap
                    if (currentViewMode === 'personal' && d.icon) {
                        if (d.tier === 'primary') return -75 + 24;  // Icon left edge + icon width + 4px gap
                        if (d.tier === 'tertiary') return -70 + 24;  // Icon left edge + icon width + 4px gap
                    }
                    return 0;
                })
                .attr('text-anchor', d => {
                    // Left-align text if icon exists in Personal mode
                    if (currentViewMode === 'personal' && d.icon) {
                        return 'start';
                    }
                    return 'middle';
                })
                .attr('font-family', 'var(--font-family-ui)')
                .attr('font-size', d => {
                    if (d.tier === 'center') return '14px';
                    if (d.tier === 'secondary') return '13px';
                    if (d.tier === 'primary') return '13px';
                    return '12px';
                })
                .attr('font-weight', d => d.tier === 'secondary' ? '700' : '600')
                .attr('fill', d => d.tier === 'center' ? 'white' : 'var(--color-neutral-text)')
                .attr('pointer-events', 'none')
                .text(d => d.label);

            // Count badges removed per user request

            // Shared click handler function for features
            function handleFeatureClick(nodeName) {
                if (nodeName === 'Career Experience') {
                    openCareerExperienceSlideout();
                } else if (nodeName === 'Goals') {
                    openGoalsSlideout();
                } else if (nodeName === 'Portfolio') {
                    openPortfolioSlideout();
                } else if (nodeName === 'Projects') {
                    openProjectsSlideout();
                } else if (nodeName === 'Code Snippets') {
                    openCodeSnippetsSlideout();
                } else if (nodeName === 'My Library') {
                    openMyLibrarySlideout();
                } else if (nodeName === 'My Notes') {
                    openMyNotesSlideout();
                } else if (nodeName === 'Shopping') {
                    openShoppingSlideout();
                } else if (nodeName === 'Finance') {
                    openFinanceSlideout();
                } else if (nodeName === 'Calendar') {
                    openCalendarSlideout();
                } else if (nodeName === 'Recipes') {
                    openRecipesSlideout();
                } else if (['Insurance', 'Cash Flow', 'Assets', 'Liabilities', 'Investments'].includes(nodeName)) {
                    // Finance child nodes - open Finance slideout with section context
                    openFinanceSlideout(nodeName);
                } else if (['Grocery', 'Home', 'Internet', 'Gifts'].includes(nodeName)) {
                    // Shopping child nodes - open Shopping slideout with section context
                    openShoppingSlideout(nodeName);
                }
            }

            // Click handler for primary nodes (Professional/Personal mode features)
            node.filter(d => d.tier === 'primary')
                .on('click', function(event, d) {
                    event.stopPropagation();

                    // In Personal mode, if node has children (Finance/Shopping), toggle expansion
                    if (currentViewMode === 'personal' && d.hasChildren) {
                        toggleNodeExpansion(d, networkData, node, link, simulation);
                    } else {
                        handleFeatureClick(d.label);
                    }
                })
                .on('mouseover', function(event, d) {
                    console.log('D3 mouseover triggered for node:', d.label);

                    // Visual hover effect
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.5)' : 'rgba(0, 102, 204, 0.5)');

                    // Show simple guidance tooltip
                    let tooltipText = null;
                    if (d.label === 'Job Opportunities') {
                        tooltipText = 'Opportunities you are pursuing appear here';
                    } else if (d.label === 'Career Experience') {
                        tooltipText = 'Your work history and professional background';
                    } else if (d.label === 'Goals') {
                        tooltipText = 'Set and track SMART career goals';
                    } else if (d.label === 'Skills & Competencies') {
                        tooltipText = 'Technical and professional skills you possess';
                    } else if (d.label === 'Portfolio') {
                        tooltipText = 'Projects and work samples to showcase your abilities';
                    } else if (d.label === 'Interview Prep') {
                        tooltipText = 'Practice questions and preparation materials';
                    }

                    console.log('Tooltip text for', d.label, ':', tooltipText);
                    console.log('Mouse position:', event.pageX, event.pageY);

                    if (tooltipText) {
                        guidanceTooltip.show(tooltipText, event.pageX, event.pageY);
                    }
                })
                .on('mouseout', function() {
                    console.log('D3 mouseout triggered');

                    // Visual hover effect
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(0, 102, 204, 0.3)');

                    // Hide tooltip
                    guidanceTooltip.hide();
                });

            // Click handler for tertiary nodes (Learner mode features / Personal mode child nodes)
            node.filter(d => d.tier === 'tertiary')
                .on('click', function(event, d) {
                    event.stopPropagation();
                    handleFeatureClick(d.label);
                })
                .on('mouseover', function(event, d) {
                    console.log('D3 tertiary node mouseover triggered for:', d.label);

                    // Visual hover effect
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.4)' : 'rgba(0, 102, 204, 0.4)');

                    // Simple guidance tooltip for child nodes
                    console.log('Showing "Click to view details" tooltip at:', event.pageX, event.pageY);
                    guidanceTooltip.show('Click to view details', event.pageX, event.pageY);
                })
                .on('mouseout', function() {
                    console.log('D3 tertiary node mouseout triggered');

                    // Visual hover effect
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(0, 102, 204, 0.2)');

                    // Hide tooltip
                    guidanceTooltip.hide();
                });

            // Hover handlers for secondary nodes (Learner mode categories - non-clickable)
            node.filter(d => d.tier === 'secondary')
                .on('mouseover', function() {
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.65)' : 'rgba(0, 102, 204, 0.65)');
                })
                .on('mouseout', function() {
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('fill', currentViewMode === 'personal' ? 'rgba(34, 197, 94, 0.5)' : 'rgba(0, 102, 204, 0.5)');
                });

            // Update positions on tick
            simulation.on('tick', () => {
                link.attr('x1', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    // Get dimensions based on source tier
                    let rectWidth, rectHeight;
                    if (d.source.tier === 'center') {
                        rectWidth = 70; rectHeight = 20;
                    } else if (d.source.tier === 'secondary') {
                        rectWidth = 75; rectHeight = 22.5;
                    } else if (d.source.tier === 'primary') {
                        rectWidth = 70; rectHeight = 20;
                    } else {
                        rectWidth = 65; rectHeight = 17.5;
                    }

                    const angle = Math.atan2(dy, dx);
                    const rectAngle = Math.atan2(rectHeight, rectWidth);
                    let offset;
                    if (Math.abs(angle) < rectAngle || Math.abs(angle) > Math.PI - rectAngle) {
                        offset = rectWidth / Math.abs(Math.cos(angle));
                    } else {
                        offset = rectHeight / Math.abs(Math.sin(angle));
                    }
                    return d.source.x + (dx / dist) * offset;
                })
                .attr('y1', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    let rectWidth, rectHeight;
                    if (d.source.tier === 'center') {
                        rectWidth = 70; rectHeight = 20;
                    } else if (d.source.tier === 'secondary') {
                        rectWidth = 75; rectHeight = 22.5;
                    } else if (d.source.tier === 'primary') {
                        rectWidth = 70; rectHeight = 20;
                    } else {
                        rectWidth = 65; rectHeight = 17.5;
                    }

                    const angle = Math.atan2(dy, dx);
                    const rectAngle = Math.atan2(rectHeight, rectWidth);
                    let offset;
                    if (Math.abs(angle) < rectAngle || Math.abs(angle) > Math.PI - rectAngle) {
                        offset = rectWidth / Math.abs(Math.cos(angle));
                    } else {
                        offset = rectHeight / Math.abs(Math.sin(angle));
                    }
                    return d.source.y + (dy / dist) * offset;
                })
                .attr('x2', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    // Get dimensions based on target tier
                    let rectWidth, rectHeight;
                    if (d.target.tier === 'center') {
                        rectWidth = 70; rectHeight = 20;
                    } else if (d.target.tier === 'secondary') {
                        rectWidth = 75; rectHeight = 22.5;
                    } else if (d.target.tier === 'primary') {
                        rectWidth = 70; rectHeight = 20;
                    } else {
                        rectWidth = 65; rectHeight = 17.5;
                    }

                    const angle = Math.atan2(dy, dx);
                    const rectAngle = Math.atan2(rectHeight, rectWidth);
                    let offset;
                    if (Math.abs(angle) < rectAngle || Math.abs(angle) > Math.PI - rectAngle) {
                        offset = rectWidth / Math.abs(Math.cos(angle));
                    } else {
                        offset = rectHeight / Math.abs(Math.sin(angle));
                    }
                    return d.target.x - (dx / dist) * offset;
                })
                .attr('y2', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    let rectWidth, rectHeight;
                    if (d.target.tier === 'center') {
                        rectWidth = 70; rectHeight = 20;
                    } else if (d.target.tier === 'secondary') {
                        rectWidth = 75; rectHeight = 22.5;
                    } else if (d.target.tier === 'primary') {
                        rectWidth = 70; rectHeight = 20;
                    } else {
                        rectWidth = 65; rectHeight = 17.5;
                    }

                    const angle = Math.atan2(dy, dx);
                    const rectAngle = Math.atan2(rectHeight, rectWidth);
                    let offset;
                    if (Math.abs(angle) < rectAngle || Math.abs(angle) > Math.PI - rectAngle) {
                        offset = rectWidth / Math.abs(Math.cos(angle));
                    } else {
                        offset = rectHeight / Math.abs(Math.sin(angle));
                    }
                    return d.target.y - (dy / dist) * offset;
                });

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag functions
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        }

        // D3 Mindmap Initialization - Tree Layout (Left to Right)
        function initializeMindmap(persona) {
            const container = document.getElementById('canvas-mindmap');

            // FIXED: Always clear existing mindmap content to prevent duplicates
            d3.select('#canvas-mindmap').selectAll('*').remove();

            const width = container.clientWidth;
            const height = container.clientHeight;

            // Reset expanded node
            expandedNode = null;

            // Get persona-specific data (filtered based on view mode)
            const data = getFilteredPersonaData(persona);
            if (!data) return;

            // Get user profile data
            const profile = loadProfile();

            // Mindmap data structure - keep all children for D3 to see
            const mindmapData = {
                name: `${profile.firstName} ${profile.lastName}'s Canvas`,
                goal: profile.goal || data.goal,
                children: data.children // Keep full data structure
            };

            // Create SVG that fits container perfectly
            const svg = d3.select('#canvas-mindmap')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`)
                .style('max-width', '100%')
                .style('max-height', '100%');

            // Add gradient definition for premium badges
            const defs = svg.append('defs');
            const gradient = defs.append('linearGradient')
                .attr('id', 'premium-gradient')
                .attr('x1', '0%')
                .attr('y1', '0%')
                .attr('x2', '100%')
                .attr('y2', '0%');

            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', '#FFD700')
                .attr('stop-opacity', 1);

            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', '#FFA500')
                .attr('stop-opacity', 1);

            // Create a group for zoom/pan - center root node horizontally
            const g = svg.append('g')
                .attr('transform', `translate(150, ${height / 2})`);

            // Create hierarchy - D3 will now see all children
            const root = d3.hierarchy(mindmapData);
            root.x0 = 0; // Centered at transform origin
            root.y0 = 0;

            // Now collapse second-level children (hide grandchildren initially)
            if (root.children) {
                root.children.forEach(child => {
                    if (child.children) {
                        child._children = child.children;
                        child.children = null;
                    }
                });
            }

            // Define constants for rectangles
            const rootWidth = 140;
            const rootHeight = 60;
            const childWidth = 180;
            const childHeight = 50;
            const grandchildWidth = 250;
            const grandchildHeight = 40;

            // Create groups for links and nodes
            const linkGroup = g.append('g').attr('class', 'links');
            const nodeGroup = g.append('g').attr('class', 'nodes');

            // Function to update the tree
            function update(source) {
                // Count visible nodes to calculate needed height (for internal calculations only)
                const visibleNodes = root.descendants();
                const neededHeight = Math.max(height, visibleNodes.length * 60);
                const neededWidth = Math.max(width, 1000);

                // FIXED: Don't dynamically resize SVG - keep it constrained to container
                // This prevents scrollbars from appearing

                // Create tree layout with FIXED node spacing using nodeSize
                const treeLayout = d3.tree()
                    .nodeSize([60, 220]) // [vertical spacing, horizontal spacing] - FIXED distances
                    .separation((a, b) => {
                        // More separation for grandchildren
                        if (a.depth === 2 && b.depth === 2) {
                            return a.parent === b.parent ? 1.0 : 1.3;
                        }
                        // Standard separation for other levels
                        return a.parent === b.parent ? 1.0 : 1.5;
                    });

                const treeData = treeLayout(root);
                const nodes = treeData.descendants();
                const links = treeData.links();

                // Update links
                const link = linkGroup
                    .selectAll('path')
                    .data(links, d => d.target.id || (d.target.id = ++i));

                // Enter new links
                const linkEnter = link.enter()
                    .insert('path', 'g')
                    .attr('class', 'mindmap-link')
                    .attr('d', d => {
                        const o = {x: source.x0, y: source.y0};
                        return diagonal(o, o);
                    });

                // Update existing links
                const linkUpdate = linkEnter.merge(link);
                linkUpdate.transition()
                    .duration(500)
                    .attr('d', d => diagonal(d.source, d.target));

                // Remove old links
                link.exit()
                    .transition()
                    .duration(500)
                    .attr('d', d => {
                        const o = {x: source.x, y: source.y};
                        return diagonal(o, o);
                    })
                    .remove();

                // Update nodes
                const node = nodeGroup
                    .selectAll('g')
                    .data(nodes, d => d.id || (d.id = ++i));

                // Enter new nodes
                const nodeEnter = node.enter()
                    .append('g')
                    .attr('class', d => `mindmap-node ${d.depth === 0 ? 'root' : d.depth === 1 ? 'child' : 'grandchild'}`)
                    .attr('transform', d => `translate(${source.y0}, ${source.x0})`);

                // Add rectangles
                nodeEnter.append('rect')
                    .attr('width', d => d.depth === 0 ? rootWidth : d.depth === 1 ? childWidth : grandchildWidth)
                    .attr('height', d => d.depth === 0 ? rootHeight : d.depth === 1 ? childHeight : grandchildHeight)
                    .attr('x', d => d.depth === 0 ? -rootWidth/2 : d.depth === 1 ? -childWidth/2 : -grandchildWidth/2)
                    .attr('y', d => d.depth === 0 ? -rootHeight/2 : d.depth === 1 ? -childHeight/2 : -grandchildHeight/2);

                // Add icons for depth 1 nodes (categories)
                const iconMap = {
                    // Seeker mode icons
                    'Job Opportunities': 'ph-briefcase',
                    'Career Experience': 'ph-suitcase',
                    'Goals': 'ph-target',
                    'Portfolio': 'ph-folder-open',
                    'Interview Prep': 'ph-chats-circle',
                    // Professional mode icons
                    'Documents': 'ph-file-text',
                    'Tables': 'ph-table',
                    'Forms': 'ph-clipboard-text',
                    'Reports': 'ph-chart-bar',
                    'Templates': 'ph-note-blank',
                    'Pipelines': 'ph-flow-arrow',
                    'Workflows': 'ph-git-branch'
                };

                nodeEnter.each(function(d) {
                    if (d.depth === 1) {
                        const iconClass = iconMap[d.data.name];
                        if (iconClass) {
                            d3.select(this)
                                .append('foreignObject')
                                .attr('width', 20)
                                .attr('height', 20)
                                .attr('x', -childWidth/2 + 8)
                                .attr('y', -10)
                                .html(`<i class="ph ${iconClass}" style="font-size: 20px; color: #0066CC;"></i>`);
                        }

                        // FIXED: Badge creation moved to separate updateBadgesOnly() function called after tree creation
                        // This ensures proper timing and prevents inconsistent initial display
                    }
                });

                // Add text labels
                nodeEnter.append('text')
                    .attr('dy', '0.35em')
                    .attr('x', 0)
                    .each(function(d) {
                        const text = d3.select(this);
                        const label = d.data.name;
                        const count = d.data.count;

                        if (d.depth === 0) {
                            text.text(label);
                            const maxWidth = rootWidth - 20;
                            // Use setTimeout to ensure text is rendered before wrapping
                            setTimeout(() => {
                                wrapText(text, maxWidth, 3); // Max 3 lines for root
                            }, 10);
                        } else if (d.depth === 1) {
                            // Shift text to the right to make room for icon
                            text.attr('x', 15);
                            const maxWidth = childWidth - 70;
                            text.text(label);
                            wrapText(text, maxWidth, 2); // Max 2 lines for categories

                            // Count badge removed per user request
                        } else {
                            // Grandchild nodes (third level) - truncate long text
                            const maxWidth = grandchildWidth - 20;
                            const maxChars = 50; // Character limit
                            const truncatedLabel = label.length > maxChars ? label.substring(0, maxChars) + '...' : label;
                            text.text(truncatedLabel);
                            wrapText(text, maxWidth, 2); // Max 2 lines
                        }
                    });

                // Click handler for second-level nodes
                nodeEnter.on('click', function(event, d) {
                    event.stopPropagation();
                    if (d.depth === 1) {
                        // Check if this is a premium node
                        const nodeName = d.data.name;
                        const isPremium = d.data.premium;

                        if (isPremium) {
                            // Show premium feature description
                            let description = '';
                            if (nodeName === 'Job Opportunities') {
                                description = 'Track and manage your job applications across multiple companies. Get AI-powered recommendations, set up custom alerts, and visualize your job search pipeline with interactive dashboards.';
                            } else if (nodeName === 'Goals') {
                                description = 'Set and track career goals with skill development plans. Get personalized learning recommendations and track your progress toward technical and professional competencies.';
                            } else if (nodeName === 'Portfolio') {
                                description = 'Showcase your projects, publications, and accomplishments. Create a professional portfolio website and generate case studies to demonstrate your expertise.';
                            } else if (nodeName === 'Interview Prep') {
                                description = 'Practice behavioral and technical interview questions. Get AI-powered feedback on your STAR stories and access a library of common interview questions for your target roles.';
                            }
                            alert(`${nodeName} (Premium Feature)\n\n${description}\n\nUpgrade to premium to unlock this feature.`);
                        } else if (nodeName === 'Career Experience') {
                            openCareerExperienceSlideout();
                        } else if (nodeName === 'Interview Prep') {
                            openInterviewPrepSlideout();
                        } else if (nodeName === 'Goals') {
                            openGoalsSlideout();
                        } else if (nodeName === 'Portfolio') {
                            openPortfolioSlideout();
                        } else if (nodeName === 'Tables') {
                            // Tables opens slideout with table type cards
                            openTablesSlideout();
                        } else if (nodeName === 'Forms') {
                            openFormsSlideout();
                        } else if (nodeName === 'Documents') {
                            openDocumentsSlideout();
                        } else if (nodeName === 'Reports') {
                            openReportsSlideout();
                        } else if (nodeName === 'Templates') {
                            openTemplatesSlideout();
                        } else if (nodeName === 'Pipelines') {
                            openPipelinesSlideout();
                        } else if (nodeName === 'Workflows') {
                            openWorkflowsSlideout();
                        } else {
                            // Other nodes expand normally
                            toggleNode(d);
                        }
                    } else if (d.depth === 2) {
                        // Third-level node clicked
                        const parentName = d.parent.data.name;
                        const nodeName = d.data.name;

                        // Close any open slideout when level 2 node is clicked
                        closeInterviewSlideout();

                        // Interview Prep child nodes no longer open slideout (handled by parent)
                        // Other depth 2 nodes can be handled here if needed
                    }
                });

                // Update existing nodes
                const nodeUpdate = nodeEnter.merge(node);
                nodeUpdate.transition()
                    .duration(500)
                    .attr('transform', d => `translate(${d.y}, ${d.x})`);

                // Ensure all depth 1 nodes have icons (handles nodes that existed before)
                nodeUpdate.each(function(d) {
                    if (d.depth === 1) {
                        const nodeElement = d3.select(this);
                        // Check if icon already exists
                        if (nodeElement.select('foreignObject').empty()) {
                            const iconClass = iconMap[d.data.name];
                            if (iconClass) {
                                nodeElement
                                    .append('foreignObject')
                                    .attr('width', 20)
                                    .attr('height', 20)
                                    .attr('x', -childWidth/2 + 8)
                                    .attr('y', -10)
                                    .html(`<i class="ph ${iconClass}" style="font-size: 20px; color: #0066CC;"></i>`);
                            }
                        }
                    }
                });

                // Update cursor for all nodes based on whether they have children
                nodeUpdate.style('cursor', d => {
                    if (d.depth === 1 && (d.children || d._children)) {
                        return 'pointer';
                    }
                    // Interview Prep children are no longer clickable (parent opens slideout)
                    return 'default';
                });

                // Update rect styling for expanded/collapsed state
                nodeUpdate.select('rect')
                    .attr('class', d => {
                        if (d.depth === 1) {
                            // Expanded if has visible children, collapsed otherwise (including no children)
                            return d.children ? 'expanded' : 'collapsed';
                        }
                        return '';
                    });

                // Remove old nodes
                node.exit()
                    .transition()
                    .duration(500)
                    .attr('transform', d => `translate(${source.y}, ${source.x})`)
                    .remove();

                // Store old positions for transitions
                nodes.forEach(d => {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }

            // Link diagonal function
            function diagonal(s, d) {
                const sourceX = s.y + (s.depth === 0 ? rootWidth/2 : s.depth === 1 ? childWidth/2 : grandchildWidth/2);
                const sourceY = s.x;
                const targetX = d.y - (d.depth === 1 ? childWidth/2 : grandchildWidth/2);
                const targetY = d.x;

                const midX = (sourceX + targetX) / 2;
                return `M ${sourceX} ${sourceY} C ${midX} ${sourceY}, ${midX} ${targetY}, ${targetX} ${targetY}`;
            }

            // Toggle node function - only one second-level node open at a time
            function toggleNode(d) {
                console.log('toggleNode called for:', d.data.name);
                console.log('Before toggle - children:', d.children, '_children:', d._children);

                if (!d._children && !d.children) {
                    console.log('No children to toggle - opening slideout for:', d.data.name);
                    // Open the appropriate slideout for leaf nodes
                    const nodeName = d.data.name;
                    if (nodeName === 'Job Opportunities') {
                        openJobOpportunitiesSlideout();
                    } else if (nodeName === 'Career Experience') {
                        openCareerExperienceSlideout();
                    } else if (nodeName === 'Interview Prep') {
                        openInterviewPrepSlideout();
                    } else if (nodeName === 'Goals') {
                        openGoalsSlideout();
                    } else if (nodeName === 'Portfolio') {
                        openPortfolioSlideout();
                    }
                    return; // No children to toggle
                }

                // If this node is being opened
                if (d._children) {
                    console.log('Opening node, _children has', d._children.length, 'items');

                    // Close any other open second-level nodes
                    root.children.forEach(child => {
                        if (child !== d && child.children) {
                            console.log('Closing other node:', child.data.name);
                            child._children = child.children;
                            child.children = null;
                        }
                    });

                    // Open this node
                    d.children = d._children;
                    d._children = null;
                    expandedNode = d;
                    console.log('After opening - children:', d.children);
                } else {
                    console.log('Closing node');
                    // Close this node
                    d._children = d.children;
                    d.children = null;
                    expandedNode = null;
                }

                console.log('Calling update()');
                update(d);
            }

            // Text wrapping function with optional line limit
            function wrapText(text, maxWidth, maxLines = 999) {
                const originalText = text.text();
                console.log('wrapText called with:', originalText, 'maxWidth:', maxWidth, 'maxLines:', maxLines);

                const textNode = text.node();
                const words = originalText.split(/\s+/).reverse();
                let word;
                let line = [];
                let lineNumber = 0;
                const lineHeight = 1.1;
                const y = text.attr('y') || 0;
                const dy = 0.35;

                text.text(null);
                let tspan = text.append('tspan')
                    .attr('x', 0)
                    .attr('y', y);

                while (word = words.pop()) {
                    // Stop if we've reached max lines
                    if (lineNumber >= maxLines) {
                        console.log('Reached max lines:', maxLines);
                        break;
                    }

                    line.push(word);
                    const testText = line.join(' ');
                    tspan.text(testText);

                    // Use setTimeout to ensure text is rendered before measuring
                    const textLength = tspan.node().getComputedTextLength();
                    console.log('Testing text:', testText, 'length:', textLength, 'maxWidth:', maxWidth);

                    if (textLength > maxWidth && line.length > 1) {
                        line.pop();
                        console.log('Breaking line at:', line.join(' '));

                        // If this would be the last line, add ellipsis
                        if (lineNumber === maxLines - 1 && words.length > 0) {
                            tspan.text(line.join(' ') + '...');
                        } else {
                            tspan.text(line.join(' '));
                        }

                        line = [word];
                        lineNumber++;

                        if (lineNumber < maxLines) {
                            tspan = text.append('tspan')
                                .attr('x', 0)
                                .attr('y', y)
                                .attr('dy', lineNumber * lineHeight + 'em')
                                .text(word);
                        }
                    }
                }

                console.log('Final line count:', lineNumber + 1);

                // Center multi-line text vertically
                const spans = text.selectAll('tspan');
                const numLines = spans.size();
                if (numLines > 1) {
                    spans.attr('dy', function(d, i) {
                        return (i - (numLines - 1) / 2) * lineHeight + dy + 'em';
                    });
                } else {
                    spans.attr('dy', dy + 'em');
                }
            }

            // Initialize counter for node IDs
            let i = 0;

            // Initial render
            update(root);

            // FIXED: Add badges after initial tree creation to ensure consistent display
            setTimeout(() => updateBadgesOnly(), 50);

            // Add zoom behavior with pan constraints
            const zoom = d3.zoom()
                .scaleExtent([0.5, 2])
                .on('zoom', (event) => {
                    let transform = event.transform;

                    // FIXED: Add pan constraints to keep mindmap visible on desktop
                    if (window.innerWidth > 768) { // Only apply constraints on desktop
                        const scale = transform.k;
                        const svgWidth = svg.node().clientWidth;
                        const svgHeight = svg.node().clientHeight;

                        // Calculate scaled content bounds (rough estimate)
                        const contentWidth = 800 * scale; // Approximate mindmap width
                        const contentHeight = 400 * scale; // Approximate mindmap height

                        // Constraint limits - allow 20% of content to go off-screen
                        const minX = -contentWidth * 0.8;
                        const maxX = svgWidth - contentWidth * 0.2;
                        const minY = -contentHeight * 0.8;
                        const maxY = svgHeight - contentHeight * 0.2;

                        // Constrain transform
                        transform = d3.zoomIdentity
                            .translate(
                                Math.max(minX, Math.min(maxX, transform.x)),
                                Math.max(minY, Math.min(maxY, transform.y))
                            )
                            .scale(scale);
                    }

                    g.attr('transform', transform);
                });

            svg.call(zoom);
        }

        // ========================================
        // Interview Prep Slideout Functions
        // ========================================

        let currentSlideout = '';
        let currentInterviewCategory = '';
        let currentEditingStoryId = null;
        let behavioralStories = JSON.parse(localStorage.getItem('behavioralStories') || '[]');

        // Example behavioral stories for each persona
        const exampleStories = {
            'retail-manager': [
                {
                    title: 'Managing Peak Season Staffing Crisis',
                    experience: 'RetailMart Store Manager (2019-2024)',
                    situation: 'During Black Friday weekend, three team members called in sick, leaving us severely understaffed during our busiest period. Customer traffic was 40% above forecast, and we risked long wait times and poor customer experience.',
                    task: 'As Store Manager, I needed to ensure we maintained service standards while managing an exhausted team and preventing further burnout.',
                    action: 'I immediately called in off-duty staff offering premium pay, reorganized floor coverage to prioritize high-traffic areas, and personally worked checkout and stocking alongside the team. I implemented 15-minute rotation breaks to prevent burnout and communicated transparently with customers about wait times.',
                    result: 'We processed 2,300 transactions over the weekend with 92% customer satisfaction scores (above our 85% target). Team morale remained strong, and we exceeded sales targets by 18%. Two team members later mentioned this experience in their positive reviews.',
                    competencies: ['Crisis Management', 'Leadership', 'Customer Service', 'Team Building']
                },
                {
                    title: 'Implementing Data-Driven Inventory System',
                    experience: 'RetailMart Store Manager (2019-2024)',
                    situation: 'Our store consistently had 22% inventory shrinkage (far above the 8% company benchmark) and frequent stockouts of popular items. Manual tracking was error-prone, and the team resisted changing established processes.',
                    task: 'I was tasked with reducing shrinkage to under 10% within six months while improving product availability.',
                    action: 'I taught myself Excel pivot tables and Power BI to analyze shrinkage patterns. I discovered 60% of losses occurred during restocking shifts. I implemented a barcode scanning system, trained staff on cycle counting procedures, and created a daily dashboard showing real-time inventory accuracy by department.',
                    result: 'Inventory shrinkage dropped to 7.5% within four months, saving $45,000 annually. Product availability improved from 83% to 94%. My analytics approach was adopted by 12 other stores in the district, and I was asked to lead regional training sessions.',
                    competencies: ['Data Analysis', 'Problem Solving', 'Change Management', 'Process Improvement']
                },
                {
                    title: 'Developing Team Member Into Assistant Manager',
                    experience: 'RetailMart Store Manager (2019-2024)',
                    situation: 'My Assistant Manager left abruptly, and corporate wanted to hire externally. I had a promising team member, Sarah, who had leadership potential but lacked confidence and formal management training.',
                    task: 'I needed to convince corporate to give Sarah a chance while rapidly developing her management capabilities.',
                    action: 'I created a 90-day development plan with weekly coaching sessions covering P&L basics, conflict resolution, and scheduling. I gradually delegated responsibilities—first shift leadership, then inventory management, finally full store operations during my vacation. I documented her progress with specific metrics and presented the case to regional management.',
                    result: 'Sarah was promoted to Assistant Manager after 12 weeks and became one of the top-performing AMs in the region. She later implemented a mentorship program that reduced turnover by 30%. This demonstrated my commitment to developing talent and influenced corporate to prioritize internal promotions.',
                    competencies: ['Mentoring', 'Talent Development', 'Advocacy', 'Influence']
                }
            ],
            'chemist': [
                {
                    title: 'Resolving Critical Production Quality Issue',
                    experience: 'PharmaCorp Senior Chemist (2020-2024)',
                    situation: 'A key pharmaceutical intermediate was failing quality control with 15% out-of-spec batches, threatening to delay a major product launch. The existing team had been troubleshooting for three weeks without identifying the root cause, and manufacturing was considering halting production.',
                    task: 'As lead chemist, I needed to identify the contamination source and implement a fix within one week to avoid missing regulatory deadlines.',
                    action: 'I formed a cross-functional team including process engineers and QC analysts. We used Design of Experiments (DOE) methodology to isolate variables. I discovered trace metal contamination from a newly installed reactor gasket. I worked with vendors to source compliant materials, validated the fix with 20 test batches, and updated SOPs to prevent recurrence.',
                    result: 'Production resumed within five days with zero OOS results in subsequent batches. The launch proceeded on schedule, generating $8M in first-year revenue. My systematic troubleshooting approach was adopted as standard protocol for quality investigations.',
                    competencies: ['Problem Solving', 'Technical Expertise', 'Cross-functional Collaboration', 'Quality Management']
                },
                {
                    title: 'Leading Lab Through Regulatory Audit',
                    experience: 'PharmaCorp Senior Chemist (2020-2024)',
                    situation: 'An unexpected FDA audit was scheduled with only two weeks notice. Our lab had several documentation gaps, and the junior staff had no audit experience. Previous audits at other sites had resulted in warning letters.',
                    task: 'I needed to prepare the team, ensure documentation compliance, and represent the lab during inspector interviews without disrupting ongoing critical experiments.',
                    action: 'I conducted daily mock audits, reviewed and corrected 200+ batch records, created an audit response guide, and coached junior chemists on answering inspector questions precisely. I organized 24/7 coverage to maintain experiments while accommodating audit schedules, and I personally handled the most technical questions.',
                    result: 'We completed the audit with zero 483 observations—a rare outcome. The inspector commended our documentation quality and technical knowledge. My audit prep materials were adopted company-wide, and I was invited to train teams at three other facilities.',
                    competencies: ['Regulatory Compliance', 'Leadership Under Pressure', 'Communication', 'Attention to Detail']
                },
                {
                    title: 'Optimizing Synthesis Route to Reduce Costs',
                    experience: 'PharmaCorp Senior Chemist (2020-2024)',
                    situation: 'Our flagship product had a synthesis route using expensive platinum catalysts, making production costs 40% above competitors. Management pressured us to cut costs without compromising quality, or they would outsource manufacturing overseas.',
                    task: 'I proposed developing an alternative synthesis route that could reduce material costs by at least 25% while maintaining API purity specifications.',
                    action: 'I screened 15 alternative catalysts through literature review and small-scale experiments, identifying a nickel-based catalyst with promising results. I scaled the reaction through pilot batches, optimized reaction conditions using statistical models, and validated that API quality met all specs. I prepared economic analysis showing $1.2M annual savings.',
                    result: 'The new route was implemented, reducing material costs by 32% and cutting reaction time by 20%. Manufacturing remained in-house, preserving 40 jobs. I received the company Innovation Award and was promoted to Principal Chemist. The process was patented with me as lead inventor.',
                    competencies: ['Innovation', 'Cost Optimization', 'Technical Problem Solving', 'Strategic Thinking']
                }
            ],
            'new-graduate': [
                {
                    title: 'Leading Team Project Under Tight Deadline',
                    experience: 'University Capstone Project (2024)',
                    situation: 'Our team of five CS students was assigned to build a React-based inventory management system for a local nonprofit. Two weeks before the deadline, one team member dropped out due to personal issues, leaving critical backend work incomplete.',
                    task: 'As project lead, I needed to redistribute work, complete the backend API integration, and ensure we delivered a working product for our client and course grade.',
                    action: 'I held an emergency team meeting to reassess scope and cut non-essential features. I personally learned Node.js/Express over a weekend to complete the REST API, integrated it with our React frontend, and implemented error handling. I reorganized our GitHub workflow with clearer task assignments and daily stand-ups to track progress.',
                    result: 'We delivered the system on time with all core features working. The nonprofit deployed it successfully and reported 30% time savings in inventory tracking. Our professor gave us an A and used our project as an example for future classes. I learned to adapt quickly and lead through adversity.',
                    competencies: ['Leadership', 'Adaptability', 'Technical Learning', 'Project Management']
                },
                {
                    title: 'Resolving Database Performance Issue',
                    experience: 'University Database Course Project (2023)',
                    situation: 'My course project—a book recommendation system—worked well with sample data but became unusably slow (30+ second queries) when testing with the full dataset of 100,000 books. The assignment deadline was in three days.',
                    task: 'I needed to identify and fix the performance bottleneck without restructuring my entire database schema.',
                    action: 'I used PostgreSQL EXPLAIN ANALYZE to identify that my recommendation algorithm was doing full table scans without indexes. I researched database optimization techniques, added composite indexes on frequently queried columns, and rewrote my most expensive query to use JOIN instead of subqueries. I tested with progressively larger datasets to validate improvements.',
                    result: 'Query times dropped from 30+ seconds to under 2 seconds, making the app responsive. I received a 98% on the project, and the professor asked me to present my optimization approach to the class. This taught me the importance of performance testing and proper indexing strategies.',
                    competencies: ['Problem Solving', 'Performance Optimization', 'Database Design', 'Self-Learning']
                },
                {
                    title: 'Organizing Community Coding Workshop',
                    experience: 'Computer Science Club VP (2023-2024)',
                    situation: 'Our CS club had low engagement (only 12 regular members) and limited visibility on campus. The club president wanted to increase membership and community impact, but we had no budget for events.',
                    task: 'As VP, I proposed organizing a free "Intro to Web Development" workshop for non-CS students to build interest and demonstrate value.',
                    action: 'I recruited three club members as co-instructors, designed a 3-hour curriculum teaching HTML/CSS/JavaScript basics, secured a computer lab through the CS department, and promoted the event through social media and flyering. I created a beginner-friendly project (personal portfolio page) that students could complete during the session.',
                    result: 'We had 45 attendees, with 30 completing projects and 18 joining the club afterward. The workshop became a quarterly event, and club membership grew to 60+ students. I developed public speaking skills and learned to make technical concepts accessible to beginners.',
                    competencies: ['Event Planning', 'Communication', 'Curriculum Design', 'Community Building']
                }
            ],
            'data-analyst': [
                {
                    title: 'Uncovering Revenue Leakage Through Data Analysis',
                    experience: 'TechCorp Business Analyst (2021-2024)',
                    situation: 'Our SaaS company was growing revenue 20% year-over-year, but profit margins were declining. Leadership suspected operational inefficiencies but had no specific insights. I was asked to investigate as part of a quarterly business review.',
                    task: 'I needed to analyze billing data, usage metrics, and customer accounts to identify where we were losing money and provide actionable recommendations.',
                    action: 'I combined data from Salesforce, Stripe, and our usage database using SQL joins, then analyzed patterns in Python. I discovered that 12% of enterprise customers were exceeding contracted usage limits without being billed for overages due to a bug in our metering system. I created visualizations in Tableau showing $340K in annual lost revenue and presented findings to the executive team with a remediation plan.',
                    result: 'Engineering fixed the metering bug within two weeks, and we implemented automated overage billing. We recovered $85K in back charges (with customer approval) and prevented future leakage. My analysis directly contributed to returning to 35% profit margins. I received a performance bonus and was promoted to Senior Analyst.',
                    competencies: ['Data Analysis', 'Problem Solving', 'Business Impact', 'Executive Communication']
                },
                {
                    title: 'Building Predictive Churn Model',
                    experience: 'TechCorp Business Analyst (2021-2024)',
                    situation: 'Customer churn was increasing from 5% to 8% monthly, and the customer success team was overwhelmed trying to prevent cancellations reactively. We needed to identify at-risk customers earlier.',
                    task: 'I proposed building a machine learning model to predict churn risk 30 days in advance, allowing proactive outreach to high-risk accounts.',
                    action: 'I extracted 18 months of customer behavior data (login frequency, feature usage, support tickets, NPS scores) and used Python scikit-learn to train a random forest classifier. I identified key churn indicators: customers with <2 logins/week and no use of core features had 60% churn probability. I built a dashboard in Power BI showing risk scores and worked with Customer Success to design intervention workflows.',
                    result: 'The model achieved 78% accuracy in predicting churn. Customer Success focused on the top 50 at-risk accounts monthly, reducing churn from 8% to 5.5% within three months—saving ~$200K in annual recurring revenue. The churn model became a core part of our CS strategy.',
                    competencies: ['Machine Learning', 'Predictive Analytics', 'Stakeholder Collaboration', 'Business Strategy']
                },
                {
                    title: 'Streamlining Reporting Process with Automation',
                    experience: 'TechCorp Business Analyst (2021-2024)',
                    situation: 'Our analytics team spent 20 hours per month manually creating executive reports by pulling data from multiple systems, copying into Excel, and formatting charts. This tedious work prevented us from doing deeper analysis.',
                    task: 'I wanted to automate the reporting process to free up time for strategic work and reduce human error.',
                    action: 'I learned Python pandas and built an automated pipeline that pulled data from our data warehouse via SQL, performed calculations, generated charts with matplotlib, and exported formatted Excel reports. I scheduled the script to run weekly via cron job and created documentation so others could maintain it. I also built a Slack bot to notify stakeholders when reports were ready.',
                    result: 'Report generation time dropped from 20 hours to 30 minutes of review time monthly, saving 230+ hours annually. Error rates decreased from ~5% to near zero. The executive team received reports faster and more consistently. My automation approach was adopted for three other recurring reports, and I led a lunch-and-learn teaching colleagues Python automation basics.',
                    competencies: ['Process Automation', 'Python Programming', 'Efficiency Improvement', 'Knowledge Sharing']
                }
            ]
        };

        // New function: Open Interview Prep with tabbed view
        function openInterviewPrepSlideout(initialTab = 'behavioral') {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');
                const interviewPrepContent = document.getElementById('interviewPrepContent');

                // Hide all content sections
                hideAllContentSections();

                // Show interview prep content with tabs
                interviewPrepContent.style.display = 'flex';

                titleEl.textContent = 'Interview Preparation';

                // Update feature visibility (show/hide Mock Interviews and Whiteboards for seeker tier)
                updateFeatureVisibility();

                // Load all content
                loadStories();
                loadDiagrams();
                loadInterviewDocuments();
                loadMockSessions();
                loadWhiteboards();

                // Switch to the requested initial tab
                switchInterviewTab(initialTab);
            });
        }

        // Open Interview Prep filtered to a specific experience
        function openInterviewPrepFiltered(experienceIndex) {
            // Clear any existing filters first
            selectedExperienceFilters.clear();

            // Add the selected experience to the filter
            selectedExperienceFilters.add(experienceIndex);

            // Open the interview prep slideout
            openInterviewPrepSlideout();

            // Update the filter UI to reflect the selection
            updateFilterCount();

            // The stories will be automatically filtered by loadStories()
        }

        function openAssetsFilteredByExperience(experienceId) {
            // Set pending filter to be applied when assets tab loads
            pendingAssetsFilter = {
                type: 'experience',
                id: experienceId
            };

            // Open the interview prep slideout directly to the assets tab
            // This will call loadAllAssets() which will pick up pendingAssetsFilter
            openInterviewPrepSlideout('assets');
        }

        function openAssetsFilteredByPortfolio(portfolioId) {
            // Set pending filter to be applied when assets tab loads
            pendingAssetsFilter = {
                type: 'portfolio',
                id: portfolioId
            };

            // Open the interview prep slideout directly to the assets tab
            // This will call loadAllAssets() which will pick up pendingAssetsFilter
            openInterviewPrepSlideout('assets');
        }

        // Open Interview Prep and navigate directly to a specific whiteboard
        function openWhiteboardFromLink(whiteboardId) {
            // Open the interview prep slideout
            openInterviewPrepSlideout();

            // Small delay to ensure DOM is ready
            setTimeout(() => {
                // Switch to Whiteboards tab
                switchInterviewTab('whiteboards');

                // Small delay before opening the whiteboard editor
                setTimeout(() => {
                    // Open the specific whiteboard
                    openWhiteboardEditor(whiteboardId);
                }, 100);
            }, 100);
        }

        // Show linked items (diagrams/documents/whiteboards) within experience/portfolio cards
        function showLinkedItemsInCard(linkType, linkId, itemType) {
            // Find all cards and locate the one matching this linkId
            const container = linkType === 'experience'
                ? document.getElementById('experiencesContainer')
                : document.getElementById('portfolioProjectsContainer');

            if (!container) return;

            // Find the card - look for the one with matching ID or title in the header
            const cards = container.querySelectorAll('.experience-card, .story-card');
            let targetCard = null;

            for (let card of cards) {
                const titleEl = card.querySelector('.exp-title');
                if (titleEl && (titleEl.textContent.includes(linkId) || card.dataset.id === linkId)) {
                    targetCard = card;
                    break;
                }
            }

            if (!targetCard) return;

            // Check if linked items section already exists
            let linkedSection = targetCard.querySelector('.linked-items-section');

            if (linkedSection) {
                // If clicking the same type, toggle visibility
                const currentType = linkedSection.dataset.itemType;
                if (currentType === itemType && linkedSection.style.display !== 'none') {
                    linkedSection.style.display = 'none';
                    return;
                } else {
                    linkedSection.dataset.itemType = itemType;
                }
            } else {
                // Create new linked items section
                linkedSection = document.createElement('div');
                linkedSection.className = 'linked-items-section';
                linkedSection.dataset.itemType = itemType;
                linkedSection.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--color-neutral-border);';
                targetCard.appendChild(linkedSection);
            }

            // Load the items based on type
            const stored = localStorage.getItem(`${itemType}_${currentPersona}`);
            let items = stored ? JSON.parse(stored) : [];

            // Special handling for documents (uses different key name)
            if (itemType === 'documents') {
                const docStored = localStorage.getItem(`interview_documents_${currentPersona}`);
                items = docStored ? JSON.parse(docStored) : [];
            }

            // Filter items to this specific link
            items = items.filter(item =>
                item.linkedType === linkType &&
                (item.linkedId === linkId || (item.linkedId && item.linkedId.includes(linkId)))
            );

            // Render the items
            const itemTypeLabel = itemType.charAt(0).toUpperCase() + itemType.slice(0, -1);
            const iconMap = {
                'diagrams': 'ph-flow-arrow',
                'documents': 'ph-file-text',
                'whiteboards': 'ph-chalkboard'
            };
            const colorMap = {
                'diagrams': { bg: '#fef3c7', text: '#d97706' },
                'documents': { bg: '#fce7f3', text: '#be123c' },
                'whiteboards': { bg: '#f0fdf4', text: '#16a34a' }
            };

            linkedSection.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <h4 style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="ph ${iconMap[itemType]}" style="font-size: 16px; color: ${colorMap[itemType].text};"></i>
                        Linked ${itemTypeLabel}s (${items.length})
                    </h4>
                    <button onclick="event.stopPropagation(); this.closest('.linked-items-section').style.display='none'" style="padding: 4px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer;">
                        Close
                    </button>
                </div>
                ${items.length === 0
                    ? `<div style="text-align: center; padding: 20px; color: var(--color-neutral-text); font-family: var(--font-family-body); font-size: 12px;">No ${itemType} linked to this ${linkType}.</div>`
                    : `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                        ${items.map(item => `
                            <div style="padding: 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; background: white; display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 32px; height: 32px; background: ${colorMap[itemType].bg}; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="ph ${iconMap[itemType]}" style="font-size: 16px; color: ${colorMap[itemType].text};"></i>
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${escapeHtml(item.name || 'Untitled')}
                                        </div>
                                    </div>
                                </div>
                                ${item.description ? `
                                    <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                        ${escapeHtml(item.description)}
                                    </div>
                                ` : ''}
                                <div style="display: flex; gap: 4px; margin-top: auto;">
                                    ${itemType === 'diagrams' ? `
                                        <button onclick="event.stopPropagation(); openDiagramById('${item.id}')" style="flex: 1; padding: 6px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                            <i class="ph ph-flow-arrow" style="font-size: 12px;"></i>
                                            Open
                                        </button>
                                    ` : itemType === 'documents' ? `
                                        <button onclick="event.stopPropagation(); openDocumentById('${item.id}')" style="flex: 1; padding: 6px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                            <i class="ph ph-file-text" style="font-size: 12px;"></i>
                                            Open
                                        </button>
                                    ` : itemType === 'whiteboards' ? `
                                        <button onclick="event.stopPropagation(); openWhiteboardById('${item.id}')" style="flex: 1; padding: 6px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                            <i class="ph ph-chalkboard" style="font-size: 12px;"></i>
                                            Open
                                        </button>
                                    ` : ''}
                                    <button onclick="event.stopPropagation(); edit${itemTypeLabel}ById('${item.id}')" style="flex: 1; padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 10px; cursor: pointer;">
                                        <i class="ph ph-pencil-simple"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); delete${itemTypeLabel}ById('${item.id}')" style="flex: 1; padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 10px; cursor: pointer; color: #dc2626;">
                                        <i class="ph ph-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>`
                }
            `;

            linkedSection.style.display = 'block';
        }

        // Show whiteboards filtered by experience within the experience card
        function openWhiteboardsFilteredByExperience(experienceId) {
            event.stopPropagation();
            showLinkedItemsInCard('experience', experienceId, 'whiteboards');
        }

        // Show whiteboards filtered by portfolio within the portfolio card
        function openWhiteboardsFilteredByPortfolio(portfolioId) {
            event.stopPropagation();
            showLinkedItemsInCard('portfolio', portfolioId, 'whiteboards');
        }

        // Show diagrams filtered by experience within the experience card
        function openDiagramsFilteredByExperience(experienceId) {
            event.stopPropagation();
            showLinkedItemsInCard('experience', experienceId, 'diagrams');
        }

        // Show diagrams filtered by portfolio within the portfolio card
        function openDiagramsFilteredByPortfolio(portfolioId) {
            event.stopPropagation();
            showLinkedItemsInCard('portfolio', portfolioId, 'diagrams');
        }

        // Show documents filtered by experience within the experience card
        function openDocumentsFilteredByExperience(experienceId) {
            event.stopPropagation();
            showLinkedItemsInCard('experience', experienceId, 'documents');
        }

        // Show documents filtered by portfolio within the portfolio card
        function openDocumentsFilteredByPortfolio(portfolioId) {
            event.stopPropagation();
            showLinkedItemsInCard('portfolio', portfolioId, 'documents');
        }

        // Function to switch between interview tabs
        function switchInterviewTab(tab) {
            const behavioralContent = document.getElementById('behavioralContent');
            const assetsContent = document.getElementById('assetsContent');
            const diagramsContent = document.getElementById('diagramsContent');
            const documentsContent = document.getElementById('documentsContent');
            const mockContent = document.getElementById('mockContent');
            const whiteboardsContent = document.getElementById('whiteboardsContent');
            const interviewPrepContent = document.getElementById('interviewPrepContent');
            const tabs = interviewPrepContent.querySelectorAll('.tech-tab');

            // Hide all content sections
            behavioralContent.style.display = 'none';
            assetsContent.style.display = 'none';
            diagramsContent.style.display = 'none';
            documentsContent.style.display = 'none';
            mockContent.style.display = 'none';
            whiteboardsContent.style.display = 'none';

            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('active'));

            // Show selected content and activate tab
            if (tab === 'behavioral') {
                behavioralContent.style.display = 'flex';
                tabs[0].classList.add('active');
            } else if (tab === 'assets') {
                assetsContent.style.display = 'flex';
                document.getElementById('assetsTab').classList.add('active');
                loadAllAssets();
            } else if (tab === 'diagrams') {
                diagramsContent.style.display = 'flex';
                document.getElementById('diagramsTab').classList.add('active');
                loadDiagrams();
            } else if (tab === 'documents') {
                documentsContent.style.display = 'flex';
                document.getElementById('documentsTab').classList.add('active');
                loadInterviewDocuments();
            } else if (tab === 'whiteboards') {
                whiteboardsContent.style.display = 'flex';
                document.getElementById('whiteboardsMainTab').classList.add('active');
                loadWhiteboards();
            } else if (tab === 'mock') {
                mockContent.style.display = 'flex';
                document.getElementById('mockInterviewsTab').classList.add('active');
                loadMockSessions();
            }
        }

        // Assets Tab Functions (Unified Documents, Diagrams, Whiteboards)
        let selectedAssetsExperienceFilters = new Set();
        let selectedAssetsPortfolioFilters = new Set();
        let pendingAssetsFilter = null; // Store filter to apply on next load
        let assetsSortColumn = 'lastModified'; // Default sort column
        let assetsSortDirection = 'desc'; // Default sort direction (newest first)
        let assetsNameFilter = ''; // Search/filter by name
        let allLoadedAssets = []; // Store all assets for filtering/sorting

        function loadAllAssets(filterType = null, filterId = null) {
            // Check for pending filter if no parameters provided
            if (!filterType && !filterId && pendingAssetsFilter) {
                filterType = pendingAssetsFilter.type;
                filterId = pendingAssetsFilter.id;
                pendingAssetsFilter = null; // Clear after using
            }

            console.log('=== LOADING ALL ASSETS ===');
            console.log('Persona:', currentPersona);
            console.log('Filter:', filterType, filterId);

            const tableBody = document.getElementById('assetsTableBody');
            const emptyState = document.getElementById('assetsEmptyState');

            // Load all seven asset types
            const documentsStored = localStorage.getItem(`interview_documents_${currentPersona}`);
            let documents = documentsStored ? JSON.parse(documentsStored) : [];

            const diagramsStored = localStorage.getItem(`diagrams_${currentPersona}`);
            let diagrams = diagramsStored ? JSON.parse(diagramsStored) : [];

            const whiteboardsStored = localStorage.getItem(`whiteboards_${currentPersona}`);
            let whiteboards = whiteboardsStored ? JSON.parse(whiteboardsStored) : [];

            const markdownStored = localStorage.getItem(`markdown_${currentPersona}`);
            let markdown = markdownStored ? JSON.parse(markdownStored) : [];

            const plantumlStored = localStorage.getItem(`plantuml_${currentPersona}`);
            let plantuml = plantumlStored ? JSON.parse(plantumlStored) : [];

            const codeStored = localStorage.getItem(`code_${currentPersona}`);
            let code = codeStored ? JSON.parse(codeStored) : [];

            const mermaidStored = localStorage.getItem(`mermaid_${currentPersona}`);
            let mermaid = mermaidStored ? JSON.parse(mermaidStored) : [];

            const presentationsStored = localStorage.getItem(`presentations_${currentPersona}`);
            let presentations = presentationsStored ? JSON.parse(presentationsStored) : [];

            const latexStored = localStorage.getItem(`user_latex_documents_${currentPersona}`);
            let latexDocuments = latexStored ? JSON.parse(latexStored) : [];

            // Combine all assets with type indicators
            let allAssets = [
                ...documents.map(d => ({ ...d, assetType: 'Document', icon: 'ph-file-text' })),
                ...diagrams.map(d => ({ ...d, assetType: 'Diagram', icon: 'ph-flow-arrow' })),
                ...whiteboards.map(w => ({ ...w, assetType: 'Whiteboard', icon: 'ph-chalkboard' })),
                ...markdown.map(m => ({ ...m, assetType: 'Markdown', icon: 'ph-markdown-logo' })),
                ...plantuml.map(p => ({ ...p, assetType: 'PlantUML', icon: 'ph-plant' })),
                ...code.map(c => ({ ...c, assetType: 'Code', icon: 'ph-code' })),
                ...mermaid.map(m => ({ ...m, assetType: 'Mermaid', icon: 'ph-fish' })),
                ...presentations.map(p => ({ ...p, assetType: 'Presentation', icon: 'ph-presentation' })),
                ...latexDocuments.map(l => ({
                    ...l,
                    assetType: l.type === 'cv' ? 'CV' : 'LaTeX',
                    icon: l.type === 'cv' ? 'ph-user-circle-gear' : 'ph-math-operations'
                }))
            ];

            // Apply tier-based filtering (hide advanced asset types for Learner tier)
            const currentTier = getCurrentSubscriptionTier();
            if (currentTier === 'learner') {
                allAssets = allAssets.filter(a =>
                    a.assetType !== 'Whiteboard' &&
                    a.assetType !== 'Markdown' &&
                    a.assetType !== 'Code'
                );
                console.log('[Tier Features] Filtered out Whiteboard, Markdown, and Code assets for Learner tier');
            }

            // Apply badge-click filter if provided
            if (filterType && filterId) {
                allAssets = allAssets.filter(a =>
                    a.linkedType === filterType && a.linkedId === filterId
                );
            }

            // Apply dropdown experience filter
            if (selectedAssetsExperienceFilters.size > 0) {
                loadUserExperiences();
                allAssets = allAssets.filter(a => {
                    if (a.linkedType !== 'experience') return false;
                    const expIndex = userExperiences.findIndex(exp =>
                        (exp.id && exp.id === a.linkedId) ||
                        (exp.title && exp.title === a.linkedId) ||
                        (exp.role && a.linkedId && a.linkedId.includes(exp.role))
                    );
                    return expIndex !== -1 && selectedAssetsExperienceFilters.has(expIndex);
                });
            }

            // Apply dropdown portfolio filter
            if (selectedAssetsPortfolioFilters.size > 0) {
                const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
                const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];
                allAssets = allAssets.filter(a => {
                    if (a.linkedType !== 'portfolio') return false;
                    const portIndex = portfolioItems.findIndex(item =>
                        (item.id && item.id === a.linkedId) ||
                        (item.name && item.name === a.linkedId) ||
                        (item.title && item.title === a.linkedId)
                    );
                    return portIndex !== -1 && selectedAssetsPortfolioFilters.has(portIndex);
                });
            }

            // Store all assets for filtering/sorting
            allLoadedAssets = allAssets;

            // Apply name filter
            if (assetsNameFilter) {
                allAssets = allAssets.filter(asset => {
                    const name = (asset.name || 'Untitled').toLowerCase();
                    return name.includes(assetsNameFilter.toLowerCase());
                });
            }

            // Apply sorting
            allAssets = sortAssetsList(allAssets, assetsSortColumn, assetsSortDirection);

            // Populate filter dropdowns
            populateAssetsExperienceFilter();
            populateAssetsPortfolioFilter();

            // Show/hide empty state
            if (allAssets.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // Populate table
            tableBody.innerHTML = allAssets.map(asset => {
                const linkedText = asset.linkedType === 'none' || !asset.linkedName
                    ? '<span style="color: var(--color-neutral-text); font-style: italic;">Not linked</span>'
                    : `<span style="color: var(--color-dark);">${asset.linkedName}</span>`;

                const typeColor = {
                    'Document': '#0066CC',
                    'Diagram': '#16a34a',
                    'Whiteboard': '#f59e0b',
                    'Markdown': '#7c3aed',
                    'PlantUML': '#0891b2',
                    'Code': '#dc2626',
                    'Mermaid': '#2563eb',
                    'Presentation': '#10b981'
                }[asset.assetType];

                // Format last modified date with timestamp (dd-mmm-yy at hh:mm)
                const lastModifiedDate = asset.lastModified || asset.created;
                let formattedDate = 'Unknown';
                if (lastModifiedDate) {
                    const date = new Date(lastModifiedDate);

                    // Format: dd-mmm-yy at hh:mm
                    const day = String(date.getDate()).padStart(2, '0');
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const month = monthNames[date.getMonth()];
                    const year = String(date.getFullYear()).slice(-2);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');

                    formattedDate = `${day}-${month}-${year} at ${hours}:${minutes}`;
                }

                return `
                    <tr style="border-bottom: 1px solid var(--color-neutral-border);">
                        <td style="padding: 12px 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="ph ${asset.icon}" style="font-size: 18px; color: ${typeColor};"></i>
                                <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);">${asset.name || 'Untitled'}</span>
                            </div>
                        </td>
                        <td style="padding: 12px 16px;">
                            <span style="display: inline-block; padding: 4px 8px; background: ${typeColor}15; color: ${typeColor}; border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600;">${asset.assetType}</span>
                        </td>
                        <td style="padding: 12px 16px;">
                            <span style="font-family: var(--font-family-body); font-size: 12px;">${linkedText}</span>
                        </td>
                        <td style="padding: 12px 16px;">
                            <span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">${formattedDate}</span>
                        </td>
                        <td style="padding: 12px 16px; text-align: right;">
                            <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                <button onclick="openAssetByTypeAndId('${asset.assetType}', '${asset.id}')" style="padding: 6px 10px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-dark);" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                    <i class="ph ph-pencil-simple" style="font-size: 14px;"></i>
                                    Edit
                                </button>
                                <button onclick="editAssetMetadata('${asset.assetType}', '${asset.id}')" style="padding: 6px 10px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-dark);" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                    <i class="ph ph-info" style="font-size: 14px;"></i>
                                    Info
                                </button>
                                <button onclick="deleteAssetByTypeAndId('${asset.assetType}', '${asset.id}')" style="padding: 6px 10px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: #dc2626;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                    <i class="ph ph-trash" style="font-size: 14px;"></i>
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            console.log('Loaded', allAssets.length, 'total assets');
        }

        // Sorting function for assets
        function sortAssetsList(assets, column, direction) {
            return assets.sort((a, b) => {
                let valA, valB;

                switch(column) {
                    case 'name':
                        valA = (a.name || 'Untitled').toLowerCase();
                        valB = (b.name || 'Untitled').toLowerCase();
                        break;
                    case 'type':
                        valA = a.assetType;
                        valB = b.assetType;
                        break;
                    case 'linkedTo':
                        valA = a.linkedName || '';
                        valB = b.linkedName || '';
                        break;
                    case 'lastModified':
                        valA = new Date(a.lastModified || a.created || 0).getTime();
                        valB = new Date(b.lastModified || b.created || 0).getTime();
                        break;
                    default:
                        return 0;
                }

                if (direction === 'asc') {
                    return valA > valB ? 1 : valA < valB ? -1 : 0;
                } else {
                    return valA < valB ? 1 : valA > valB ? -1 : 0;
                }
            });
        }

        // Sort table by clicking column header
        function sortAssetsTable(column) {
            // Toggle direction if clicking same column, otherwise default to asc
            if (assetsSortColumn === column) {
                assetsSortDirection = assetsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                assetsSortColumn = column;
                assetsSortDirection = column === 'lastModified' ? 'desc' : 'asc'; // Default newest first for dates
            }

            // Update sort icons
            const icons = {
                'name': 'sortIconName',
                'type': 'sortIconType',
                'linkedTo': 'sortIconLinkedTo',
                'lastModified': 'sortIconLastModified'
            };

            // Reset all icons to neutral
            Object.values(icons).forEach(iconId => {
                const icon = document.getElementById(iconId);
                if (icon) {
                    icon.className = 'ph ph-caret-up-down';
                    icon.style.opacity = '0.3';
                }
            });

            // Set active icon
            const activeIcon = document.getElementById(icons[column]);
            if (activeIcon) {
                activeIcon.className = assetsSortDirection === 'asc' ? 'ph ph-caret-up' : 'ph ph-caret-down';
                activeIcon.style.opacity = '1';
            }

            // Reload table with new sort
            loadAllAssets();
        }

        // Filter assets by name
        function filterAssetsByName() {
            const searchInput = document.getElementById('assetsSearchInput');
            const clearBtn = document.getElementById('assetsClearSearchBtn');

            assetsNameFilter = searchInput.value.trim();

            // Show/hide clear button
            if (assetsNameFilter) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }

            // Reload table with filter
            loadAllAssets();
        }

        // Clear search filter
        function clearAssetsSearch() {
            const searchInput = document.getElementById('assetsSearchInput');
            const clearBtn = document.getElementById('assetsClearSearchBtn');

            searchInput.value = '';
            assetsNameFilter = '';
            clearBtn.style.display = 'none';

            // Reload table without filter
            loadAllAssets();
        }

        function openAssetByTypeAndId(assetType, assetId) {
            console.log('=== OPENING ASSET BY TYPE ===');
            console.log('Asset Type:', assetType);
            console.log('Asset ID:', assetId);
            if (assetType === 'Document') {
                openDocumentByIdQuill(assetId);
            } else if (assetType === 'LaTeX') {
                openLatexEditor(assetId);
            } else if (assetType === 'CV') {
                openLatexEditor(assetId);
            } else if (assetType === 'Diagram') {
                openDiagramByIdDrawio(assetId);
            } else if (assetType === 'Whiteboard') {
                openWhiteboardById(assetId);
            } else if (assetType === 'Code') {
                openCodeByIdMonaco(assetId);
            } else if (assetType === 'Markdown') {
                openMarkdownByIdMonaco(assetId);
            } else if (assetType === 'PlantUML') {
                alert('PlantUML editor coming soon!');
            } else if (assetType === 'Mermaid') {
                alert('Mermaid editor coming soon!');
            } else if (assetType === 'Presentation') {
                openPresentationByIdReveal(assetId);
            }
        }

        function deleteAssetByTypeAndId(assetType, assetId) {
            if (!confirm(`Are you sure you want to delete this ${assetType.toLowerCase()}?`)) return;

            console.log('Deleting asset:', assetType, assetId);

            const storageKeyMap = {
                'Document': 'interview_documents',
                'LaTeX': 'user_latex_documents',
                'Diagram': 'diagrams',
                'Whiteboard': 'whiteboards',
                'Markdown': 'markdown',
                'PlantUML': 'plantuml',
                'Code': 'code',
                'Mermaid': 'mermaid',
                'Presentation': 'presentations'
            };

            const storageKey = storageKeyMap[assetType];
            if (storageKey) {
                const stored = localStorage.getItem(`${storageKey}_${currentPersona}`);
                let items = stored ? JSON.parse(stored) : [];
                items = items.filter(item => item.id !== assetId);
                localStorage.setItem(`${storageKey}_${currentPersona}`, JSON.stringify(items));
            }

            // Reload the assets view
            loadAllAssets();
        }

        // Unified Asset Modal State
        let currentUnifiedAssetType = 'Document';
        let currentUnifiedAssetLinkType = 'none';
        let currentUnifiedAssetId = null;
        let unifiedAssetSkills = [];
        let unifiedAssetTechnologies = [];
        let unifiedAssetCompetencies = [];
        let isEditingAsset = false;

        function openAssetCreationModal() {
            // Reset state
            isEditingAsset = false;
            currentUnifiedAssetId = null;
            currentUnifiedAssetType = 'Document';
            currentUnifiedAssetLinkType = 'none';
            unifiedAssetSkills = [];
            unifiedAssetTechnologies = [];
            unifiedAssetCompetencies = [];

            // Clear form
            document.getElementById('unifiedAssetName').value = '';
            document.getElementById('unifiedAssetDescription').value = '';
            document.getElementById('unifiedAssetSkillInput').value = '';
            document.getElementById('unifiedAssetTechInput').value = '';
            document.getElementById('unifiedAssetCompInput').value = '';

            // Reset type selector
            setUnifiedAssetType('Document');
            setUnifiedAssetLinkType('none');

            // Show asset type selector
            const assetTypeSection = document.querySelector('[style*="Asset Type"]')?.parentElement;
            if (assetTypeSection) assetTypeSection.style.display = 'flex';

            // Update UI
            renderUnifiedAssetTags();
            document.getElementById('unifiedAssetModalTitle').textContent = 'Create Asset';
            document.querySelector('#unifiedAssetModal .modal-footer button:last-child').innerHTML = '<i class="ph ph-floppy-disk" style="margin-right: 6px;"></i> Create & Open';

            // Show modal
            document.getElementById('unifiedAssetModal').style.display = 'flex';
        }

        function editAssetMetadata(assetType, assetId) {
            console.log('Editing asset metadata:', assetType, assetId);

            // Load asset data
            const storageKeyMap = {
                'Document': 'interview_documents',
                'Diagram': 'diagrams',
                'Whiteboard': 'whiteboards',
                'Markdown': 'markdown',
                'PlantUML': 'plantuml',
                'Code': 'code',
                'Mermaid': 'mermaid',
                'Presentation': 'presentations'
            };

            const storageKey = storageKeyMap[assetType];
            const stored = localStorage.getItem(`${storageKey}_${currentPersona}`);
            const assets = stored ? JSON.parse(stored) : [];
            const asset = assets.find(a => a.id === assetId);

            if (!asset) {
                alert('Asset not found');
                return;
            }

            // Set edit mode
            isEditingAsset = true;
            currentUnifiedAssetId = assetId;
            currentUnifiedAssetType = assetType;

            // Populate form
            document.getElementById('unifiedAssetName').value = asset.name || '';
            document.getElementById('unifiedAssetDescription').value = asset.description || '';

            // Set linked type
            currentUnifiedAssetLinkType = asset.linkedType || 'none';
            setUnifiedAssetLinkType(currentUnifiedAssetLinkType);

            // If linked, select the item
            if (asset.linkedType && asset.linkedType !== 'none' && asset.linkedId) {
                setTimeout(() => {
                    const select = document.getElementById('unifiedAssetLinkSelect');
                    if (select) {
                        select.value = asset.linkedId;
                    }
                }, 100);
            }

            // Populate tags
            unifiedAssetSkills = asset.skills || [];
            unifiedAssetTechnologies = asset.technologies || [];
            unifiedAssetCompetencies = asset.competencies || [];

            // Hide asset type selector
            const assetTypeSection = document.querySelector('label').parentElement;
            for (let el of document.querySelectorAll('label')) {
                if (el.textContent.includes('Asset Type')) {
                    el.parentElement.style.display = 'none';
                    break;
                }
            }

            // Update UI
            renderUnifiedAssetTags();
            document.getElementById('unifiedAssetModalTitle').textContent = 'Edit Asset Info';
            document.querySelector('#unifiedAssetModal .modal-footer button:last-child').innerHTML = '<i class="ph ph-floppy-disk" style="margin-right: 6px;"></i> Save Changes';

            // Show modal
            document.getElementById('unifiedAssetModal').style.display = 'flex';
        }

        function closeUnifiedAssetModal() {
            document.getElementById('unifiedAssetModal').style.display = 'none';
        }

        function setUnifiedAssetType(type) {
            currentUnifiedAssetType = type;

            // Update button styles
            const types = ['Document', 'LaTeX', 'CV', 'Diagram', 'Whiteboard', 'Markdown', 'Code', 'Presentation'];
            types.forEach(t => {
                const btn = document.getElementById(`assetType${t}`);
                if (btn) { // Check if button exists
                    if (t === type) {
                        btn.style.background = 'var(--color-primary-blue)';
                        btn.style.color = 'white';
                        btn.style.borderColor = 'var(--color-primary-blue)';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--color-dark)';
                        btn.style.borderColor = 'var(--color-neutral-border)';
                    }
                }
            });
        }

        function setUnifiedAssetLinkType(type) {
            currentUnifiedAssetLinkType = type;
            const select = document.getElementById('unifiedAssetLinkSelect');

            // Update button styles
            ['experience', 'portfolio', 'none'].forEach(t => {
                const btn = document.getElementById(`unifiedAssetLinkType${t.charAt(0).toUpperCase() + t.slice(1)}`);
                if (t === type) {
                    btn.style.background = 'var(--color-primary-blue)';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'var(--color-primary-blue)';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = 'var(--color-dark)';
                    btn.style.borderColor = 'var(--color-neutral-border)';
                }
            });

            // Show/hide select dropdown
            if (type === 'none') {
                select.style.display = 'none';
            } else {
                select.style.display = 'block';
                populateUnifiedAssetLinkOptions(type);
            }
        }

        function populateUnifiedAssetLinkOptions(type) {
            const select = document.getElementById('unifiedAssetLinkSelect');
            select.innerHTML = '<option value="">Select an item...</option>';

            if (type === 'experience') {
                loadUserExperiences();
                userExperiences.forEach(exp => {
                    const option = document.createElement('option');
                    option.value = exp.id || exp.title;
                    option.textContent = `${exp.title || exp.role} at ${exp.company}`;
                    select.appendChild(option);
                });
            } else if (type === 'portfolio') {
                const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
                const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];
                portfolioItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id || item.name || item.title;
                    option.textContent = item.name || item.title;
                    select.appendChild(option);
                });
            }
        }

        function addUnifiedAssetTag(tagType) {
            let inputId, arrayRef;

            if (tagType === 'skill') {
                inputId = 'unifiedAssetSkillInput';
                arrayRef = unifiedAssetSkills;
            } else if (tagType === 'tech') {
                inputId = 'unifiedAssetTechInput';
                arrayRef = unifiedAssetTechnologies;
            } else if (tagType === 'comp') {
                inputId = 'unifiedAssetCompInput';
                arrayRef = unifiedAssetCompetencies;
            }

            const input = document.getElementById(inputId);
            const value = input.value.trim();

            if (value && !arrayRef.includes(value)) {
                arrayRef.push(value);
                input.value = '';
                renderUnifiedAssetTags();
            }
        }

        function removeUnifiedAssetTag(tagType, value) {
            if (tagType === 'skill') {
                unifiedAssetSkills = unifiedAssetSkills.filter(s => s !== value);
            } else if (tagType === 'tech') {
                unifiedAssetTechnologies = unifiedAssetTechnologies.filter(t => t !== value);
            } else if (tagType === 'comp') {
                unifiedAssetCompetencies = unifiedAssetCompetencies.filter(c => c !== value);
            }
            renderUnifiedAssetTags();
        }

        function renderUnifiedAssetTags() {
            // Render skills
            const skillContainer = document.getElementById('unifiedAssetSkillTags');
            if (unifiedAssetSkills.length === 0) {
                skillContainer.innerHTML = '<span style="color: var(--color-neutral-text); font-family: var(--font-family-body); font-size: 12px; font-style: italic;">No skills added yet</span>';
            } else {
                skillContainer.innerHTML = unifiedAssetSkills.map(skill => `
                    <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #e3f2fd; color: var(--color-primary-blue); border-radius: 4px; font-family: var(--font-family-body); font-size: 12px; font-weight: 500;">
                        ${skill}
                        <i class="ph ph-x" onclick="removeUnifiedAssetTag('skill', '${skill}')" style="cursor: pointer; font-size: 14px;"></i>
                    </span>
                `).join('');
            }

            // Render technologies
            const techContainer = document.getElementById('unifiedAssetTechTags');
            if (unifiedAssetTechnologies.length === 0) {
                techContainer.innerHTML = '<span style="color: var(--color-neutral-text); font-family: var(--font-family-body); font-size: 12px; font-style: italic;">No technologies added yet</span>';
            } else {
                techContainer.innerHTML = unifiedAssetTechnologies.map(tech => `
                    <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #dcfce7; color: #16a34a; border-radius: 4px; font-family: var(--font-family-body); font-size: 12px; font-weight: 500;">
                        ${tech}
                        <i class="ph ph-x" onclick="removeUnifiedAssetTag('tech', '${tech}')" style="cursor: pointer; font-size: 14px;"></i>
                    </span>
                `).join('');
            }

            // Render competencies
            const compContainer = document.getElementById('unifiedAssetCompTags');
            if (unifiedAssetCompetencies.length === 0) {
                compContainer.innerHTML = '<span style="color: var(--color-neutral-text); font-family: var(--font-family-body); font-size: 12px; font-style: italic;">No competencies added yet</span>';
            } else {
                compContainer.innerHTML = unifiedAssetCompetencies.map(comp => `
                    <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #fef3c7; color: #f59e0b; border-radius: 4px; font-family: var(--font-family-body); font-size: 12px; font-weight: 500;">
                        ${comp}
                        <i class="ph ph-x" onclick="removeUnifiedAssetTag('comp', '${comp}')" style="cursor: pointer; font-size: 14px;"></i>
                    </span>
                `).join('');
            }
        }

        function saveUnifiedAsset() {
            console.log('=== SAVE UNIFIED ASSET ===');
            console.log('isEditingAsset:', isEditingAsset);
            console.log('currentUnifiedAssetId:', currentUnifiedAssetId);
            console.log('currentUnifiedAssetType:', currentUnifiedAssetType);

            const name = document.getElementById('unifiedAssetName').value.trim();
            const description = document.getElementById('unifiedAssetDescription').value.trim();

            if (!name) {
                alert('Please enter a name for the asset');
                return;
            }

            // Get link details
            let linkedId = '';
            let linkedName = '';
            if (currentUnifiedAssetLinkType !== 'none') {
                const select = document.getElementById('unifiedAssetLinkSelect');
                linkedId = select.value;
                linkedName = select.options[select.selectedIndex]?.text || '';
            }

            const now = new Date().toISOString();
            let assetId;
            let asset;

            // Check if we're editing or creating
            if (isEditingAsset) {
                console.log('>>> EDITING MODE');
                // EDITING MODE: Update existing asset
                assetId = currentUnifiedAssetId;

                // Load existing asset from localStorage
                const storageKeyMap = {
                    'Document': `interview_documents_${currentPersona}`,
                    'LaTeX': `user_latex_documents_${currentPersona}`,
                    'Diagram': `diagrams_${currentPersona}`,
                    'Whiteboard': `whiteboards_${currentPersona}`,
                    'Markdown': `markdown_${currentPersona}`,
                    'Code': `code_${currentPersona}`,
                    'PlantUML': `plantuml_${currentPersona}`,
                    'Mermaid': `mermaid_${currentPersona}`,
                    'Presentation': `presentations_${currentPersona}`
                };

                const storageKey = storageKeyMap[currentUnifiedAssetType];
                const stored = localStorage.getItem(storageKey);
                const assets = stored ? JSON.parse(stored) : [];
                const existingAsset = assets.find(a => a.id === assetId);

                if (!existingAsset) {
                    alert('Asset not found!');
                    return;
                }

                // Update only the metadata fields (preserve content, diagramData, etc.)
                asset = {
                    ...existingAsset,
                    name: name,
                    description: description,
                    linkedType: currentUnifiedAssetLinkType,
                    linkedId: linkedId,
                    linkedName: linkedName,
                    skills: unifiedAssetSkills,
                    technologies: unifiedAssetTechnologies,
                    competencies: unifiedAssetCompetencies,
                    lastModified: now
                    // Keep original created date and content fields
                };

                // Update asset in array
                const assetIndex = assets.findIndex(a => a.id === assetId);
                assets[assetIndex] = asset;
                localStorage.setItem(storageKey, JSON.stringify(assets));

                console.log('Updated asset metadata:', currentUnifiedAssetType, assetId);

                // Close modal and refresh table (don't open editor)
                closeUnifiedAssetModal();
                loadAllAssets();
                return;

            } else {
                console.log('>>> CREATION MODE');
                // CREATION MODE: Create new asset object
                assetId = Date.now().toString();
                asset = {
                    id: assetId,
                    name: name,
                    description: description,
                    linkedType: currentUnifiedAssetLinkType,
                    linkedId: linkedId,
                    linkedName: linkedName,
                    skills: unifiedAssetSkills,
                    technologies: unifiedAssetTechnologies,
                    competencies: unifiedAssetCompetencies,
                    created: now,
                    lastModified: now
                };
            }

            // Save based on type
            if (currentUnifiedAssetType === 'Document') {
                asset.content = '';  // Empty document content
                const stored = localStorage.getItem(`interview_documents_${currentPersona}`);
                const documents = stored ? JSON.parse(stored) : [];
                documents.push(asset);
                localStorage.setItem(`interview_documents_${currentPersona}`, JSON.stringify(documents));

                // Close modal and open editor
                closeUnifiedAssetModal();
                openDocumentByIdQuill(assetId);

            } else if (currentUnifiedAssetType === 'LaTeX') {
                asset.content = getDefaultLatexTemplate();  // Default LaTeX template
                const stored = localStorage.getItem(`user_latex_documents_${currentPersona}`);
                const latexDocs = stored ? JSON.parse(stored) : [];
                latexDocs.push(asset);
                localStorage.setItem(`user_latex_documents_${currentPersona}`, JSON.stringify(latexDocs));

                // Close modal and open editor
                closeUnifiedAssetModal();
                openLatexEditor(assetId);

            } else if (currentUnifiedAssetType === 'CV') {
                // Create CV document with AltaCV template and enhanced schema
                asset.name = asset.name.replace('New Document', 'New Professional CV');
                asset.content = getAltaCVTemplate();  // CV template
                asset.tags = ['cv', 'resume', 'professional'];
                // Add CV-specific fields
                asset.type = 'cv';
                asset.cvTemplate = 'altacv';
                asset.personalInfo = null;
                asset.sections = ['experience', 'projects', 'skills', 'education', 'certifications'];
                asset.colorScheme = { primary: '#8F0D0D', heading: '#2E2E2E', accent: '#E7D192', text: '#666666' };

                const stored = localStorage.getItem(`user_latex_documents_${currentPersona}`);
                const latexDocs = stored ? JSON.parse(stored) : [];
                latexDocs.push(asset);
                localStorage.setItem(`user_latex_documents_${currentPersona}`, JSON.stringify(latexDocs));

                // Close modal and open editor
                closeUnifiedAssetModal();
                openLatexEditor(assetId);

            } else if (currentUnifiedAssetType === 'Diagram') {
                asset.diagramData = null;  // Empty diagram
                const stored = localStorage.getItem(`diagrams_${currentPersona}`);
                const diagrams = stored ? JSON.parse(stored) : [];
                diagrams.push(asset);
                localStorage.setItem(`diagrams_${currentPersona}`, JSON.stringify(diagrams));

                // Close modal and open editor
                closeUnifiedAssetModal();
                openDiagramByIdDrawio(assetId);

            } else if (currentUnifiedAssetType === 'Whiteboard') {
                asset.canvasData = null;  // Empty whiteboard
                const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
                const whiteboards = stored ? JSON.parse(stored) : [];
                whiteboards.push(asset);
                localStorage.setItem(`whiteboards_${currentPersona}`, JSON.stringify(whiteboards));

                // Close modal and open editor
                closeUnifiedAssetModal();
                openWhiteboardById(assetId);

            } else if (currentUnifiedAssetType === 'Markdown') {
                // Store in localStorage and open Monaco editor
                asset.content = '# Welcome\n\nStart writing your markdown here...';  // Default markdown content
                const stored = localStorage.getItem(`markdown_${currentPersona}`);
                const markdownDocs = stored ? JSON.parse(stored) : [];
                markdownDocs.push(asset);
                localStorage.setItem(`markdown_${currentPersona}`, JSON.stringify(markdownDocs));

                closeUnifiedAssetModal();
                openMarkdownByIdMonaco(assetId);

            } else if (currentUnifiedAssetType === 'PlantUML') {
                // Placeholder: Store in localStorage but show coming soon message
                asset.content = '';  // Empty PlantUML content
                const stored = localStorage.getItem(`plantuml_${currentPersona}`);
                const plantumlDocs = stored ? JSON.parse(stored) : [];
                plantumlDocs.push(asset);
                localStorage.setItem(`plantuml_${currentPersona}`, JSON.stringify(plantumlDocs));

                closeUnifiedAssetModal();
                alert('PlantUML editor coming soon! Your asset has been saved and will be editable once the feature is implemented.');

            } else if (currentUnifiedAssetType === 'Code') {
                // Store in localStorage and open Monaco editor
                asset.content = '';  // Empty code content
                asset.language = 'javascript';  // Default language
                const stored = localStorage.getItem(`code_${currentPersona}`);
                const codeSnippets = stored ? JSON.parse(stored) : [];
                codeSnippets.push(asset);
                localStorage.setItem(`code_${currentPersona}`, JSON.stringify(codeSnippets));

                closeUnifiedAssetModal();
                openCodeByIdMonaco(assetId);

            } else if (currentUnifiedAssetType === 'Mermaid') {
                // Placeholder: Store in localStorage but show coming soon message
                asset.content = '';  // Empty Mermaid content
                const stored = localStorage.getItem(`mermaid_${currentPersona}`);
                const mermaidDocs = stored ? JSON.parse(stored) : [];
                mermaidDocs.push(asset);
                localStorage.setItem(`mermaid_${currentPersona}`, JSON.stringify(mermaidDocs));

                closeUnifiedAssetModal();
                alert('Mermaid diagram editor coming soon! Your asset has been saved and will be editable once the feature is implemented.');

            } else if (currentUnifiedAssetType === 'Presentation') {
                // Create presentation with default title slide
                asset.slides = [
                    {
                        id: Date.now().toString(),
                        type: 'title',
                        content: `# ${name}\n## Subtitle or Tagline\n\nYour Name | ${new Date().toLocaleDateString()}`
                    }
                ];
                asset.theme = 'white';  // Default Reveal.js theme
                asset.transition = 'slide';  // Default transition

                const stored = localStorage.getItem(`presentations_${currentPersona}`);
                const presentations = stored ? JSON.parse(stored) : [];
                presentations.push(asset);
                localStorage.setItem(`presentations_${currentPersona}`, JSON.stringify(presentations));

                closeUnifiedAssetModal();
                openPresentationByIdReveal(assetId);
            }

            console.log('Created new asset:', currentUnifiedAssetType, assetId);
        }

        // Handle Enter key in tag inputs
        document.addEventListener('DOMContentLoaded', function() {
            ['unifiedAssetSkillInput', 'unifiedAssetTechInput', 'unifiedAssetCompInput'].forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const tagType = inputId.includes('Skill') ? 'skill' : inputId.includes('Tech') ? 'tech' : 'comp';
                            addUnifiedAssetTag(tagType);
                        }
                    });
                }
            });

            // Initialize Monaco Editor loader
            if (typeof require !== 'undefined' && require.config) {
                require.config({
                    paths: {
                        'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs'
                    }
                });
            }
        });

        // Monaco Code Editor Functions
        let monacoEditor = null;
        let currentEditingCodeId = null;
        let autoSaveCodeInterval = null;

        function openCodeByIdMonaco(id) {
            console.log('=== OPENING CODE SNIPPET ===');
            console.log('[Code] ID:', id);

            const stored = localStorage.getItem(`code_${currentPersona}`);
            const codeSnippets = stored ? JSON.parse(stored) : [];
            const codeSnippet = codeSnippets.find(c => c.id === id);

            if (!codeSnippet) {
                console.error('[Code] Not found with ID:', id);
                alert('Code snippet not found');
                return;
            }

            console.log('[Code] Found:', {
                id: codeSnippet.id,
                name: codeSnippet.name,
                language: codeSnippet.language,
                contentLength: codeSnippet.content ? codeSnippet.content.length : 0
            });

            currentEditingCodeId = id;

            // Show editor
            document.getElementById('codeEditor').style.display = 'flex';
            document.getElementById('codeEditorTitle').textContent = codeSnippet.name || 'Untitled Code';
            document.getElementById('codeLanguageSelect').value = codeSnippet.language || 'javascript';

            // Initialize Monaco editor if not already done
            if (!monacoEditor) {
                require(['vs/editor/editor.main'], function() {
                    console.log('[Code] Monaco loaded, creating editor');
                    monacoEditor = monaco.editor.create(document.getElementById('monacoEditorContainer'), {
                        value: codeSnippet.content || '',
                        language: codeSnippet.language || 'javascript',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        fontSize: 14,
                        minimap: { enabled: true },
                        scrollBeyondLastLine: false,
                        wordWrap: 'on',
                        lineNumbers: 'on',
                        renderWhitespace: 'selection',
                        tabSize: 4,
                        insertSpaces: true
                    });

                    // Start auto-save
                    startCodeAutoSave();

                    console.log('[Code] ✅ Editor initialized');
                });
            } else {
                // Editor already exists, just update content and language
                monacoEditor.setValue(codeSnippet.content || '');
                monaco.editor.setModelLanguage(monacoEditor.getModel(), codeSnippet.language || 'javascript');
                console.log('[Code] Editor content updated');

                // Restart auto-save
                startCodeAutoSave();
            }
        }

        function closeCodeEditor() {
            console.log('=== CLOSING CODE EDITOR ===');

            // Stop auto-save
            if (autoSaveCodeInterval) {
                clearInterval(autoSaveCodeInterval);
                autoSaveCodeInterval = null;
            }

            // Save one last time before closing
            if (currentEditingCodeId && monacoEditor) {
                saveCodeContent();
            }

            // Hide editor
            document.getElementById('codeEditor').style.display = 'none';
            currentEditingCodeId = null;

            // Reload assets list to show updated last modified time
            if (typeof loadAllAssets === 'function') {
                loadAllAssets();
            }

            console.log('[Code] ✅ Editor closed');
        }

        function changeCodeLanguage() {
            if (!monacoEditor) return;

            const newLanguage = document.getElementById('codeLanguageSelect').value;
            monaco.editor.setModelLanguage(monacoEditor.getModel(), newLanguage);

            // Save the language change
            if (currentEditingCodeId) {
                const stored = localStorage.getItem(`code_${currentPersona}`);
                let codeSnippets = stored ? JSON.parse(stored) : [];
                const index = codeSnippets.findIndex(c => c.id === currentEditingCodeId);

                if (index !== -1) {
                    codeSnippets[index].language = newLanguage;
                    codeSnippets[index].lastModified = new Date().toISOString();
                    localStorage.setItem(`code_${currentPersona}`, JSON.stringify(codeSnippets));
                    console.log('[Code] Language changed to:', newLanguage);
                }
            }
        }

        function startCodeAutoSave() {
            // Clear any existing interval
            if (autoSaveCodeInterval) {
                clearInterval(autoSaveCodeInterval);
            }

            // Auto-save every 2 seconds
            autoSaveCodeInterval = setInterval(() => {
                if (currentEditingCodeId && monacoEditor) {
                    saveCodeContent();
                }
            }, 2000);

            console.log('[Code] Auto-save started');
        }

        function saveCodeContent() {
            if (!currentEditingCodeId || !monacoEditor) {
                console.warn('[Code] No code ID or editor to save');
                return;
            }

            const content = monacoEditor.getValue();

            try {
                const stored = localStorage.getItem(`code_${currentPersona}`);
                let codeSnippets = stored ? JSON.parse(stored) : [];
                const index = codeSnippets.findIndex(c => c.id === currentEditingCodeId);

                if (index !== -1) {
                    codeSnippets[index].content = content;
                    codeSnippets[index].lastModified = new Date().toISOString();
                    localStorage.setItem(`code_${currentPersona}`, JSON.stringify(codeSnippets));
                    console.log('[Code] ✅ Auto-saved, content length:', content.length);
                }
            } catch (error) {
                console.error('[Code] ❌ Error saving:', error);
            }
        }

        function editCodeMetadata() {
            if (!currentEditingCodeId) return;

            const stored = localStorage.getItem(`code_${currentPersona}`);
            const codeSnippets = stored ? JSON.parse(stored) : [];
            const codeSnippet = codeSnippets.find(c => c.id === currentEditingCodeId);

            if (!codeSnippet) return;

            // For now, use a simple prompt to edit name and description
            const newName = prompt('Code Snippet Name:', codeSnippet.name);
            if (newName === null) return; // User cancelled

            const newDescription = prompt('Description:', codeSnippet.description);
            if (newDescription === null) return; // User cancelled

            // Update metadata
            const index = codeSnippets.findIndex(c => c.id === currentEditingCodeId);
            if (index !== -1) {
                codeSnippets[index].name = newName.trim() || 'Untitled Code';
                codeSnippets[index].description = newDescription.trim();
                codeSnippets[index].lastModified = new Date().toISOString();
                localStorage.setItem(`code_${currentPersona}`, JSON.stringify(codeSnippets));

                // Update title in editor
                document.getElementById('codeEditorTitle').textContent = newName || 'Untitled Code';

                console.log('[Code] Metadata updated');
            }
        }

        // Monaco Markdown Editor Functions
        let monacoMarkdownEditor = null;
        let currentEditingMarkdownId = null;
        let autoSaveMarkdownInterval = null;

        function openMarkdownByIdMonaco(id) {
            console.log('=== OPENING MARKDOWN DOCUMENT ===');
            console.log('[Markdown] ID:', id);

            const stored = localStorage.getItem(`markdown_${currentPersona}`);
            const markdownDocs = stored ? JSON.parse(stored) : [];
            const markdownDoc = markdownDocs.find(m => m.id === id);

            if (!markdownDoc) {
                console.error('[Markdown] Not found with ID:', id);
                alert('Markdown document not found');
                return;
            }

            console.log('[Markdown] Found:', {
                id: markdownDoc.id,
                name: markdownDoc.name,
                contentLength: markdownDoc.content ? markdownDoc.content.length : 0
            });

            currentEditingMarkdownId = id;

            // Show editor
            document.getElementById('markdownEditor').style.display = 'flex';
            document.getElementById('markdownEditorTitle').textContent = markdownDoc.name || 'Untitled Markdown';

            // Initialize Monaco editor if not already done
            if (!monacoMarkdownEditor) {
                require(['vs/editor/editor.main'], function() {
                    console.log('[Markdown] Monaco loaded, creating editor');
                    monacoMarkdownEditor = monaco.editor.create(document.getElementById('monacoMarkdownEditorContainer'), {
                        value: markdownDoc.content || '# Welcome\n\nStart writing your markdown here...',
                        language: 'markdown',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        fontSize: 14,
                        minimap: { enabled: true },
                        scrollBeyondLastLine: false,
                        wordWrap: 'on',
                        lineNumbers: 'on',
                        renderWhitespace: 'selection',
                        tabSize: 2,
                        insertSpaces: true
                    });

                    // Update preview on content change
                    monacoMarkdownEditor.onDidChangeModelContent(() => {
                        updateMarkdownPreview();
                    });

                    // Initial preview render
                    updateMarkdownPreview();

                    // Start auto-save
                    startMarkdownAutoSave();

                    // Setup scroll synchronization
                    const previewContainer = document.getElementById('markdownPreview').parentElement;
                    let isEditorScrolling = false;
                    let isPreviewScrolling = false;

                    // Sync preview scroll when editor scrolls
                    monacoMarkdownEditor.onDidScrollChange((e) => {
                        if (isPreviewScrolling) return;
                        isEditorScrolling = true;

                        const editorScrollTop = e.scrollTop;
                        const editorScrollHeight = monacoMarkdownEditor.getScrollHeight();
                        const editorViewportHeight = monacoMarkdownEditor.getLayoutInfo().height;

                        const scrollPercentage = editorScrollTop / (editorScrollHeight - editorViewportHeight);
                        previewContainer.scrollTop = scrollPercentage * (previewContainer.scrollHeight - previewContainer.clientHeight);

                        setTimeout(() => { isEditorScrolling = false; }, 100);
                    });

                    // Sync editor scroll when preview scrolls
                    previewContainer.addEventListener('scroll', () => {
                        if (isEditorScrolling) return;
                        isPreviewScrolling = true;

                        const scrollPercentage = previewContainer.scrollTop / (previewContainer.scrollHeight - previewContainer.clientHeight);
                        const editorScrollHeight = monacoMarkdownEditor.getScrollHeight();
                        const editorViewportHeight = monacoMarkdownEditor.getLayoutInfo().height;
                        const targetScrollTop = scrollPercentage * (editorScrollHeight - editorViewportHeight);

                        monacoMarkdownEditor.setScrollTop(targetScrollTop);

                        setTimeout(() => { isPreviewScrolling = false; }, 100);
                    });

                    console.log('[Markdown] ✅ Editor initialized with scroll sync');
                });
            } else {
                // Editor already exists, just update content
                monacoMarkdownEditor.setValue(markdownDoc.content || '# Welcome\n\nStart writing your markdown here...');
                console.log('[Markdown] Editor content updated');

                // Update preview
                updateMarkdownPreview();

                // Restart auto-save
                startMarkdownAutoSave();
            }
        }

        function closeMarkdownEditor() {
            console.log('=== CLOSING MARKDOWN EDITOR ===');

            // Stop auto-save
            if (autoSaveMarkdownInterval) {
                clearInterval(autoSaveMarkdownInterval);
                autoSaveMarkdownInterval = null;
            }

            // Save one last time before closing
            if (currentEditingMarkdownId && monacoMarkdownEditor) {
                saveMarkdownContent();
            }

            // Hide editor
            document.getElementById('markdownEditor').style.display = 'none';
            currentEditingMarkdownId = null;

            // Reload assets list to show updated last modified time
            if (typeof loadAllAssets === 'function') {
                loadAllAssets();
            }

            console.log('[Markdown] ✅ Editor closed');
        }

        function startMarkdownAutoSave() {
            // Clear any existing interval
            if (autoSaveMarkdownInterval) {
                clearInterval(autoSaveMarkdownInterval);
            }

            // Auto-save every 2 seconds
            autoSaveMarkdownInterval = setInterval(() => {
                if (currentEditingMarkdownId && monacoMarkdownEditor) {
                    saveMarkdownContent();
                }
            }, 2000);

            console.log('[Markdown] Auto-save started');
        }

        function saveMarkdownContent() {
            if (!currentEditingMarkdownId || !monacoMarkdownEditor) {
                console.warn('[Markdown] No markdown ID or editor to save');
                return;
            }

            const content = monacoMarkdownEditor.getValue();

            try {
                const stored = localStorage.getItem(`markdown_${currentPersona}`);
                let markdownDocs = stored ? JSON.parse(stored) : [];
                const index = markdownDocs.findIndex(m => m.id === currentEditingMarkdownId);

                if (index !== -1) {
                    markdownDocs[index].content = content;
                    markdownDocs[index].lastModified = new Date().toISOString();
                    localStorage.setItem(`markdown_${currentPersona}`, JSON.stringify(markdownDocs));
                    console.log('[Markdown] ✅ Auto-saved, content length:', content.length);
                }
            } catch (error) {
                console.error('[Markdown] ❌ Error saving:', error);
            }
        }

        // ========================================
        // PRESENTATION EDITOR (REVEAL.JS) FUNCTIONS
        // ========================================

        let currentEditingPresentationId = null;
        let currentSlideIndex = 0;
        let revealInstance = null;
        let autoSavePresentationInterval = null;

        // Color Harmony Generation
        function hexToHSL(hex) {
            // Convert hex to RGB
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return { h: 0, s: 0, l: 50 };

            let r = parseInt(result[1], 16) / 255;
            let g = parseInt(result[2], 16) / 255;
            let b = parseInt(result[3], 16) / 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }

            return {
                h: Math.round(h * 360),
                s: Math.round(s * 100),
                l: Math.round(l * 100)
            };
        }

        function hslToHex(h, s, l) {
            s /= 100;
            l /= 100;

            const c = (1 - Math.abs(2 * l - 1)) * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = l - c / 2;
            let r = 0, g = 0, b = 0;

            if (h >= 0 && h < 60) {
                r = c; g = x; b = 0;
            } else if (h >= 60 && h < 120) {
                r = x; g = c; b = 0;
            } else if (h >= 120 && h < 180) {
                r = 0; g = c; b = x;
            } else if (h >= 180 && h < 240) {
                r = 0; g = x; b = c;
            } else if (h >= 240 && h < 300) {
                r = x; g = 0; b = c;
            } else if (h >= 300 && h < 360) {
                r = c; g = 0; b = x;
            }

            const toHex = (n) => {
                const hex = Math.round((n + m) * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };

            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        function generateComplementaryColors(baseColor) {
            const hsl = hexToHSL(baseColor);

            // Generate 4 complementary colors using different harmony rules
            return {
                primary: baseColor,
                // Complementary (opposite on color wheel)
                secondary: hslToHex((hsl.h + 180) % 360, hsl.s, hsl.l),
                // Triadic (120 degrees apart)
                accent1: hslToHex((hsl.h + 120) % 360, hsl.s, hsl.l),
                // Triadic (240 degrees apart)
                accent2: hslToHex((hsl.h + 240) % 360, hsl.s, hsl.l),
                // Analogous (30 degrees offset, lighter)
                light: hslToHex((hsl.h + 30) % 360, Math.max(hsl.s - 20, 20), Math.min(hsl.l + 30, 90))
            };
        }

        // Font families for presentations
        const PRESENTATION_FONTS = [
            { name: 'Barlow', value: 'Barlow, sans-serif' },
            { name: 'Questrial', value: 'Questrial, sans-serif' },
            { name: 'Arial', value: 'Arial, sans-serif' },
            { name: 'Helvetica', value: 'Helvetica, sans-serif' },
            { name: 'Georgia', value: 'Georgia, serif' },
            { name: 'Times New Roman', value: '"Times New Roman", serif' },
            { name: 'Courier New', value: '"Courier New", monospace' },
            { name: 'Verdana', value: 'Verdana, sans-serif' },
            { name: 'Trebuchet MS', value: '"Trebuchet MS", sans-serif' },
            { name: 'Palatino', value: 'Palatino, serif' }
        ];

        // Slide Templates
        const SLIDE_TEMPLATES = {
            title: {
                name: 'Title Slide',
                icon: 'ph-text-aa',
                content: `# Presentation Title
## Subtitle or Tagline

Your Name | Date`
            },
            content: {
                name: 'Content',
                icon: 'ph-list-bullets',
                content: `## Slide Title

- Key point 1
- Key point 2
- Key point 3

<!-- .element: class="fragment" -->
- Animated point`
            },
            twoColumn: {
                name: 'Two Column',
                icon: 'ph-columns',
                content: `## Two Column Layout

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div>

### Left Column
- Point 1
- Point 2

</div>
<div>

### Right Column
- Point A
- Point B

</div>
</div>`
            },
            imageText: {
                name: 'Image + Text',
                icon: 'ph-image',
                content: `## Title

<div style="display: flex; align-items: center; gap: 30px;">
<div style="flex: 1;">

- Key point 1
- Key point 2
- Key point 3

</div>
<div style="flex: 1;">

![Image Description](https://via.placeholder.com/400x300)

</div>
</div>`
            },
            quote: {
                name: 'Quote',
                icon: 'ph-quotes',
                content: `> "Insert your inspirational quote here"

— Author Name`
            },
            code: {
                name: 'Code',
                icon: 'ph-code',
                content: `## Code Example

\`\`\`javascript
function example() {
    console.log('Hello, World!');
    return true;
}
\`\`\`

Explanation of the code`
            },
            section: {
                name: 'Section Break',
                icon: 'ph-text-t',
                content: `# Section Title

---

Next Topic`
            },
            blank: {
                name: 'Blank',
                icon: 'ph-note-blank',
                content: `## New Slide

Start typing...`
            }
        };

        function getTemplateContent(templateKey) {
            return SLIDE_TEMPLATES[templateKey]?.content || SLIDE_TEMPLATES.blank.content;
        }

        function showTemplateSelector(callback) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: 11000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 600px;
                width: 90%;
            `;

            const title = document.createElement('h3');
            title.textContent = 'Choose Slide Template';
            title.style.cssText = `
                font-family: var(--font-family-ui);
                font-size: 18px;
                font-weight: 600;
                margin: 0 0 20px 0;
                color: var(--color-dark);
            `;
            content.appendChild(title);

            const grid = document.createElement('div');
            grid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            `;

            Object.keys(SLIDE_TEMPLATES).forEach(key => {
                const template = SLIDE_TEMPLATES[key];
                const btn = document.createElement('button');
                btn.style.cssText = `
                    padding: 16px 12px;
                    background: white;
                    border: 2px solid var(--color-neutral-border);
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.2s;
                `;
                btn.onmouseover = () => {
                    btn.style.borderColor = 'var(--color-primary-blue)';
                    btn.style.background = '#e3f2fd';
                };
                btn.onmouseout = () => {
                    btn.style.borderColor = 'var(--color-neutral-border)';
                    btn.style.background = 'white';
                };
                btn.onclick = () => {
                    document.body.removeChild(modal);
                    callback(key);
                };

                const icon = document.createElement('i');
                icon.className = `ph ${template.icon}`;
                icon.style.cssText = `
                    font-size: 24px;
                    color: var(--color-primary-blue);
                `;

                const name = document.createElement('span');
                name.textContent = template.name;
                name.style.cssText = `
                    font-family: var(--font-family-ui);
                    font-size: 11px;
                    font-weight: 600;
                    color: var(--color-dark);
                    text-align: center;
                `;

                btn.appendChild(icon);
                btn.appendChild(name);
                grid.appendChild(btn);
            });

            content.appendChild(grid);

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.cssText = `
                width: 100%;
                padding: 10px;
                background: white;
                border: 1px solid var(--color-neutral-border);
                border-radius: 6px;
                font-family: var(--font-family-ui);
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
            `;
            cancelBtn.onclick = () => document.body.removeChild(modal);
            content.appendChild(cancelBtn);

            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function showStyleCustomizer() {
            if (!currentEditingPresentationId) return;

            const stored = localStorage.getItem(`presentations_${currentPersona}`);
            const presentations = stored ? JSON.parse(stored) : [];
            const presentation = presentations.find(p => p.id === currentEditingPresentationId);
            if (!presentation) return;

            // Initialize custom style if not exists
            if (!presentation.customStyle) {
                presentation.customStyle = {
                    enabled: false,
                    baseColor: '#0066CC',
                    backgroundColor: '#ffffff',
                    textColor: '#333333',
                    fontFamily: 'Barlow, sans-serif',
                    colors: generateComplementaryColors('#0066CC')
                };
            }

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: 11000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow-y: auto;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 700px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
            `;

            content.innerHTML = `
                <h3 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: var(--color-dark);">
                    Custom Style Settings
                </h3>

                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- Enable Custom Style -->
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #f5f5f7; border-radius: 8px;">
                        <input type="checkbox" id="customStyleEnabled" ${presentation.customStyle.enabled ? 'checked' : ''}
                            style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="customStyleEnabled" style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); cursor: pointer;">
                            Enable Custom Style (overrides theme)
                        </label>
                    </div>

                    <!-- Font Family -->
                    <div>
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">
                            Font Family
                        </label>
                        <select id="customFontFamily" style="width: 100%; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; cursor: pointer;">
                            ${PRESENTATION_FONTS.map(font =>
                                `<option value="${font.value}" ${presentation.customStyle.fontFamily === font.value ? 'selected' : ''}>${font.name}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <!-- Base Color Picker -->
                    <div>
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">
                            Base Color (generates complementary colors)
                        </label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="color" id="customBaseColor" value="${presentation.customStyle.baseColor}"
                                style="width: 60px; height: 40px; border: 2px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer;">
                            <input type="text" id="customBaseColorHex" value="${presentation.customStyle.baseColor}"
                                style="flex: 1; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: monospace; font-size: 14px;">
                            <button onclick="regenerateColors()" style="padding: 10px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">
                                Generate
                            </button>
                        </div>
                    </div>

                    <!-- Color Palette Preview -->
                    <div id="colorPalettePreview">
                        <!-- Will be populated by JavaScript -->
                    </div>

                    <!-- Background Color -->
                    <div>
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">
                            Background Color
                        </label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="color" id="customBackgroundColor" value="${presentation.customStyle.backgroundColor}"
                                style="width: 60px; height: 40px; border: 2px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer;">
                            <input type="text" id="customBackgroundColorHex" value="${presentation.customStyle.backgroundColor}"
                                style="flex: 1; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: monospace; font-size: 14px;">
                        </div>
                    </div>

                    <!-- Text Color -->
                    <div>
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">
                            Text Color
                        </label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="color" id="customTextColor" value="${presentation.customStyle.textColor}"
                                style="width: 60px; height: 40px; border: 2px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer;">
                            <input type="text" id="customTextColorHex" value="${presentation.customStyle.textColor}"
                                style="flex: 1; padding: 10px 12px; border: 2px solid var(--color-neutral-border); border-radius: 6px; font-family: monospace; font-size: 14px;">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; margin-top: 10px;">
                        <button onclick="saveCustomStyle()" style="flex: 1; padding: 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                            Apply Style
                        </button>
                        <button onclick="closeStyleCustomizer()" style="flex: 1; padding: 12px; background: white; color: var(--color-dark); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            // Add event listeners for color sync
            content.querySelector('#customBaseColor').addEventListener('input', (e) => {
                content.querySelector('#customBaseColorHex').value = e.target.value;
            });
            content.querySelector('#customBaseColorHex').addEventListener('input', (e) => {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                    content.querySelector('#customBaseColor').value = e.target.value;
                }
            });
            content.querySelector('#customBackgroundColor').addEventListener('input', (e) => {
                content.querySelector('#customBackgroundColorHex').value = e.target.value;
            });
            content.querySelector('#customBackgroundColorHex').addEventListener('input', (e) => {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                    content.querySelector('#customBackgroundColor').value = e.target.value;
                }
            });
            content.querySelector('#customTextColor').addEventListener('input', (e) => {
                content.querySelector('#customTextColorHex').value = e.target.value;
            });
            content.querySelector('#customTextColorHex').addEventListener('input', (e) => {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                    content.querySelector('#customTextColor').value = e.target.value;
                }
            });

            // Define global functions BEFORE appending modal
            window.updateColorPalettePreview = function(colors) {
                const preview = document.getElementById('colorPalettePreview');
                if (!preview) return;

                const colorRoles = [
                    { key: 'primary', label: 'Primary', desc: 'Main brand color' },
                    { key: 'secondary', label: 'Secondary', desc: 'Complementary accent' },
                    { key: 'accent1', label: 'Accent 1', desc: 'Triadic harmony' },
                    { key: 'accent2', label: 'Accent 2', desc: 'Triadic harmony' },
                    { key: 'light', label: 'Light', desc: 'Backgrounds/subtle' }
                ];

                preview.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; padding: 16px; background: #f5f5f7; border-radius: 8px;">
                        ${colorRoles.map(role => `
                            <div style="text-align: center;">
                                <div style="width: 100%; height: 60px; background: ${colors[role.key]}; border-radius: 6px; border: 2px solid var(--color-neutral-border); margin-bottom: 8px;"></div>
                                <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-dark); margin-bottom: 2px;">${role.label}</div>
                                <div style="font-family: monospace; font-size: 10px; color: var(--color-neutral-text);">${colors[role.key]}</div>
                                <div style="font-family: var(--font-family-body); font-size: 9px; color: var(--color-neutral-text); margin-top: 4px;">${role.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            };

            window.regenerateColors = function() {
                const baseColor = document.getElementById('customBaseColor').value;
                const colors = generateComplementaryColors(baseColor);
                window.updateColorPalettePreview(colors);
            };

            window.saveCustomStyle = function() {
                const stored = localStorage.getItem(`presentations_${currentPersona}`);
                let presentations = stored ? JSON.parse(stored) : [];
                const index = presentations.findIndex(p => p.id === currentEditingPresentationId);

                if (index !== -1) {
                    const baseColor = document.getElementById('customBaseColor').value;
                    presentations[index].customStyle = {
                        enabled: document.getElementById('customStyleEnabled').checked,
                        baseColor: baseColor,
                        backgroundColor: document.getElementById('customBackgroundColor').value,
                        textColor: document.getElementById('customTextColor').value,
                        fontFamily: document.getElementById('customFontFamily').value,
                        colors: generateComplementaryColors(baseColor)
                    };
                    presentations[index].lastModified = new Date().toISOString();
                    localStorage.setItem(`presentations_${currentPersona}`, JSON.stringify(presentations));

                    console.log('[Presentation] Custom style saved');
                    document.body.removeChild(modal);
                    updateRevealPreview();
                }
            };

            window.closeStyleCustomizer = function() {
                document.body.removeChild(modal);
            };

            modal.appendChild(content);
            document.body.appendChild(modal);
            modal.id = 'styleCustomizerModal';

            // Show color palette after modal is in DOM
            window.updateColorPalettePreview(presentation.customStyle.colors);
        }

        function openPresentationByIdReveal(id) {
            console.log('=== OPENING PRESENTATION ===');
            console.log('[Presentation] ID:', id);

            const stored = localStorage.getItem(`presentations_${currentPersona}`);
            const presentations = stored ? JSON.parse(stored) : [];
            const presentation = presentations.find(p => p.id === id);

            if (!presentation) {
                console.error('[Presentation] Not found with ID:', id);
                alert('Presentation not found');
                return;
            }

            console.log('[Presentation] Found:', {
                id: presentation.id,
                name: presentation.name,
                slideCount: presentation.slides ? presentation.slides.length : 0
            });

            currentEditingPresentationId = id;
            currentSlideIndex = 0;

            // Show editor
            document.getElementById('presentationEditor').style.display = 'flex';
            document.getElementById('presentationEditorTitle').textContent = presentation.name || 'Untitled Presentation';

            // Set theme and transition
            document.getElementById('presentationThemeSelect').value = presentation.theme || 'white';
            document.getElementById('presentationTransitionSelect').value = presentation.transition || 'slide';

            // Load first slide
            if (presentation.slides && presentation.slides.length > 0) {
                loadSlide(0);
            }

            // Render slides list
            renderSlidesList();

            // Initialize Reveal.js
            initializeReveal();

            // Start auto-save
            startPresentationAutoSave();

            console.log('[Presentation] ✅ Editor opened');
        }

        function closePresentationEditor() {
            console.log('=== CLOSING PRESENTATION EDITOR ===');

            // Stop auto-save
            if (autoSavePresentationInterval) {
                clearInterval(autoSavePresentationInterval);
                autoSavePresentationInterval = null;
            }

            // Save one last time before closing
            if (currentEditingPresentationId) {
                savePresentationSilently();
            }

            // Destroy Reveal instance
            if (revealInstance) {
                try {
                    revealInstance.destroy();
                    revealInstance = null;
                } catch (e) {
                    console.warn('[Presentation] Error destroying Reveal:', e);
                }
            }

            // Hide editor
            document.getElementById('presentationEditor').style.display = 'none';
            currentEditingPresentationId = null;
            currentSlideIndex = 0;

            // Reload assets list
            if (typeof loadAllAssets === 'function') {
                loadAllAssets();
            }

            console.log('[Presentation] ✅ Editor closed');
        }

        function savePresentationSilently() {
            if (!currentEditingPresentationId) {
                console.warn('[Presentation] No presentation ID to save');
                return;
            }

            try {
                const stored = localStorage.getItem(`presentations_${currentPersona}`);
                let presentations = stored ? JSON.parse(stored) : [];
                const index = presentations.findIndex(p => p.id === currentEditingPresentationId);

                if (index !== -1) {
                    // Save current slide content
                    const slideContent = document.getElementById('slideContentTextarea').value;
                    presentations[index].slides[currentSlideIndex].content = slideContent;
                    presentations[index].lastModified = new Date().toISOString();

                    localStorage.setItem(`presentations_${currentPersona}`, JSON.stringify(presentations));
                    console.log('[Presentation] ✅ Auto-saved, slide:', currentSlideIndex);
                }
            } catch (error) {
                console.error('[Presentation] ❌ Error saving:', error);
            }
        }

        function startPresentationAutoSave() {
            // Clear any existing interval
            if (autoSavePresentationInterval) {
                clearInterval(autoSavePresentationInterval);
            }

            // Auto-save every 2 seconds
            autoSavePresentationInterval = setInterval(() => {
                if (currentEditingPresentationId) {
                    savePresentationSilently();
                }
            }, 2000);

            console.log('[Presentation] Auto-save started');
        }

        function addSlideToPresentation() {
            if (!currentEditingPresentationId) return;

            // Show template selector
            showTemplateSelector((templateKey) => {
                const stored = localStorage.getItem(`presentations_${currentPersona}`);
                let presentations = stored ? JSON.parse(stored) : [];
                const index = presentations.findIndex(p => p.id === currentEditingPresentationId);

                if (index !== -1) {
                    // Save current slide first
                    savePresentationSilently();

                    // Add new slide with selected template
                    const newSlide = {
                        id: Date.now().toString(),
                        type: templateKey,
                        content: getTemplateContent(templateKey)
                    };
                    presentations[index].slides.push(newSlide);
                    presentations[index].lastModified = new Date().toISOString();
                    localStorage.setItem(`presentations_${currentPersona}`, JSON.stringify(presentations));

                    // Switch to new slide
                    currentSlideIndex = presentations[index].slides.length - 1;
                    loadSlide(currentSlideIndex);
                    renderSlidesList();
                    updateRevealPreview();

                    console.log('[Presentation] ✅ Added new slide with template:', templateKey);
                }
            });
        }

        function deleteSlideFromPresentation(slideIndex) {
            if (!currentEditingPresentationId) return;

            const stored = localStorage.getItem(`presentations_${currentPersona}`);
            let presentations = stored ? JSON.parse(stored) : [];
            const index = presentations.findIndex(p => p.id === currentEditingPresentationId);

            if (index !== -1 && presentations[index].slides.length > 1) {
                if (!confirm('Delete this slide?')) return;

                presentations[index].slides.splice(slideIndex, 1);
                presentations[index].lastModified = new Date().toISOString();
                localStorage.setItem(`presentations_${currentPersona}`, JSON.stringify(presentations));

                // Adjust current slide index
                if (currentSlideIndex >= presentations[index].slides.length) {
                    currentSlideIndex = presentations[index].slides.length - 1;
                }

                loadSlide(currentSlideIndex);
                renderSlidesList();
                updateRevealPreview();

                console.log('[Presentation] ✅ Deleted slide', slideIndex);
            } else {
                alert('Cannot delete the last slide');
            }
        }

        function selectSlide(slideIndex) {
            // Save current slide first
            savePresentationSilently();

            // Switch to selected slide
            currentSlideIndex = slideIndex;
            loadSlide(slideIndex);
        }

        function loadSlide(slideIndex) {
            if (!currentEditingPresentationId) return;

            const stored = localStorage.getItem(`presentations_${currentPersona}`);
            const presentations = stored ? JSON.parse(stored) : [];
            const presentation = presentations.find(p => p.id === currentEditingPresentationId);

            if (presentation && presentation.slides[slideIndex]) {
                const slide = presentation.slides[slideIndex];
                document.getElementById('slideContentTextarea').value = slide.content || '';
                document.getElementById('currentSlideNumber').textContent =
                    `Slide ${slideIndex + 1} of ${presentation.slides.length}`;

                // Update active state in slides list
                renderSlidesList();
                updateRevealPreview();
            }
        }

        function renderSlidesList() {
            if (!currentEditingPresentationId) return;

            const stored = localStorage.getItem(`presentations_${currentPersona}`);
            const presentations = stored ? JSON.parse(stored) : [];
            const presentation = presentations.find(p => p.id === currentEditingPresentationId);

            if (!presentation) return;

            const slidesList = document.getElementById('slidesList');
            slidesList.innerHTML = '';

            presentation.slides.forEach((slide, index) => {
                const slideItem = document.createElement('div');
                slideItem.style.cssText = `
                    padding: 12px;
                    background: ${index === currentSlideIndex ? 'var(--color-primary-blue)' : 'white'};
                    color: ${index === currentSlideIndex ? 'white' : 'var(--color-dark)'};
                    border: 1px solid ${index === currentSlideIndex ? 'var(--color-primary-blue)' : 'var(--color-neutral-border)'};
                    border-radius: 6px;
                    cursor: pointer;
                    font-family: var(--font-family-ui);
                    font-size: 12px;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    transition: all 0.2s;
                `;

                slideItem.onclick = () => selectSlide(index);

                const slideNumber = document.createElement('span');
                slideNumber.textContent = `Slide ${index + 1}`;
                slideItem.appendChild(slideNumber);

                if (presentation.slides.length > 1) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="ph ph-x"></i>';
                    deleteBtn.style.cssText = `
                        background: none;
                        border: none;
                        color: ${index === currentSlideIndex ? 'white' : 'var(--color-neutral-text)'};
                        font-size: 16px;
                        cursor: pointer;
                        padding: 4px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteSlideFromPresentation(index);
                    };
                    slideItem.appendChild(deleteBtn);
                }

                slidesList.appendChild(slideItem);
            });
        }

        function updateRevealPreview() {
            if (!currentEditingPresentationId) return;

            const stored = localStorage.getItem(`presentations_${currentPersona}`);
            const presentations = stored ? JSON.parse(stored) : [];
            const presentation = presentations.find(p => p.id === currentEditingPresentationId);

            if (!presentation) {
                console.warn('[Presentation] Presentation not found for preview update');
                return;
            }

            // Get current slide content
            const slideContent = document.getElementById('slideContentTextarea').value;

            // Update slides array with current content
            if (presentation.slides[currentSlideIndex]) {
                presentation.slides[currentSlideIndex].content = slideContent;
            }

            console.log('[Presentation] Updating preview, total slides:', presentation.slides.length);
            console.log('[Presentation] Current slide index:', currentSlideIndex);

            // Regenerate preview HTML - create sections dynamically for better rendering
            const previewSlides = document.getElementById('previewSlides');
            previewSlides.innerHTML = ''; // Clear first

            presentation.slides.forEach((slide, index) => {
                const section = document.createElement('section');
                section.setAttribute('data-markdown', '');

                const textarea = document.createElement('textarea');
                textarea.setAttribute('data-template', '');
                textarea.textContent = slide.content;

                section.appendChild(textarea);
                previewSlides.appendChild(section);
            });

            console.log('[Presentation] Preview HTML updated with', presentation.slides.length, 'slides');

            // Always reinitialize Reveal for markdown to be properly rendered
            setTimeout(() => {
                initializeReveal();
            }, 100);
        }

        function initializeReveal() {
            const previewContainer = document.getElementById('revealPreview');

            if (typeof Reveal === 'undefined') {
                console.error('[Presentation] Reveal.js not loaded');
                return;
            }

            console.log('[Presentation] Initializing Reveal.js...');

            try {
                if (revealInstance) {
                    try {
                        revealInstance.destroy();
                        console.log('[Presentation] Previous instance destroyed');
                    } catch (e) {
                        console.warn('[Presentation] Error destroying previous instance:', e);
                    }
                    revealInstance = null;
                }

                const revealElement = previewContainer.querySelector('.reveal');
                if (!revealElement) {
                    console.error('[Presentation] .reveal element not found');
                    return;
                }

                revealInstance = new Reveal(revealElement, {
                    embedded: true,
                    width: 960,
                    height: 700,
                    margin: 0.1,
                    minScale: 0.2,
                    maxScale: 2.0,
                    controls: true,
                    progress: true,
                    center: true,
                    hash: false,
                    slideNumber: true,
                    transition: document.getElementById('presentationTransitionSelect').value || 'slide',
                    plugins: [ RevealMarkdown ]
                });

                revealInstance.initialize().then(() => {
                    console.log('[Presentation] ✅ Reveal initialized, navigating to slide:', currentSlideIndex);
                    revealInstance.slide(currentSlideIndex, 0, 0);

                    // Apply custom styles if enabled
                    applyCustomStyles();
                }).catch(error => {
                    console.error('[Presentation] ❌ Error during initialization:', error);
                });

            } catch (error) {
                console.error('[Presentation] ❌ Error initializing Reveal:', error);
            }
        }

        function applyCustomStyles() {
            if (!currentEditingPresentationId) return;

            const stored = localStorage.getItem(`presentations_${currentPersona}`);
            const presentations = stored ? JSON.parse(stored) : [];
            const presentation = presentations.find(p => p.id === currentEditingPresentationId);

            if (!presentation || !presentation.customStyle || !presentation.customStyle.enabled) {
                // Remove custom style if exists
                const existingStyle = document.getElementById('customPresentationStyle');
                if (existingStyle) existingStyle.remove();
                return;
            }

            const style = presentation.customStyle;
            const colors = style.colors;

            // Remove existing custom style
            const existingStyle = document.getElementById('customPresentationStyle');
            if (existingStyle) existingStyle.remove();

            // Create new style element
            const styleElement = document.createElement('style');
            styleElement.id = 'customPresentationStyle';
            styleElement.textContent = `
                /* Custom Presentation Styles */
                #revealPreview .reveal {
                    font-family: ${style.fontFamily} !important;
                }

                #revealPreview .reveal .slides {
                    background: ${style.backgroundColor} !important;
                }

                #revealPreview .reveal h1,
                #revealPreview .reveal h2,
                #revealPreview .reveal h3,
                #revealPreview .reveal h4,
                #revealPreview .reveal h5,
                #revealPreview .reveal h6 {
                    color: ${colors.primary} !important;
                    font-family: ${style.fontFamily} !important;
                }

                #revealPreview .reveal p,
                #revealPreview .reveal li,
                #revealPreview .reveal td,
                #revealPreview .reveal th {
                    color: ${style.textColor} !important;
                    font-family: ${style.fontFamily} !important;
                }

                #revealPreview .reveal a {
                    color: ${colors.secondary} !important;
                }

                #revealPreview .reveal a:hover {
                    color: ${colors.accent1} !important;
                }

                #revealPreview .reveal code {
                    background: ${colors.light} !important;
                    color: ${style.textColor} !important;
                }

                #revealPreview .reveal blockquote {
                    border-left: 5px solid ${colors.accent1} !important;
                    background: ${colors.light} !important;
                }

                #revealPreview .reveal .controls {
                    color: ${colors.primary} !important;
                }

                #revealPreview .reveal .progress {
                    background: ${colors.light} !important;
                }

                #revealPreview .reveal .progress span {
                    background: ${colors.primary} !important;
                }

                #revealPreview .reveal section {
                    background: ${style.backgroundColor} !important;
                }

                #revealPreview .reveal strong,
                #revealPreview .reveal b {
                    color: ${colors.accent2} !important;
                }

                #revealPreview .reveal em,
                #revealPreview .reveal i {
                    color: ${colors.secondary} !important;
                }
            `;

            document.head.appendChild(styleElement);
            console.log('[Presentation] ✅ Custom styles applied');
        }

        function changePresentationTheme() {
            const theme = document.getElementById('presentationThemeSelect').value;

            // Update theme stylesheet
            const themeLink = document.getElementById('revealTheme');
            if (themeLink) {
                themeLink.href = `https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/theme/${theme}.css`;
            }

            // Save theme to presentation
            if (currentEditingPresentationId) {
                const stored = localStorage.getItem(`presentations_${currentPersona}`);
                let presentations = stored ? JSON.parse(stored) : [];
                const index = presentations.findIndex(p => p.id === currentEditingPresentationId);

                if (index !== -1) {
                    presentations[index].theme = theme;
                    presentations[index].lastModified = new Date().toISOString();
                    localStorage.setItem(`presentations_${currentPersona}`, JSON.stringify(presentations));
                    console.log('[Presentation] Theme changed to:', theme);
                }
            }
        }

        function changePresentationTransition() {
            const transition = document.getElementById('presentationTransitionSelect').value;

            // Save transition to presentation
            if (currentEditingPresentationId) {
                const stored = localStorage.getItem(`presentations_${currentPersona}`);
                let presentations = stored ? JSON.parse(stored) : [];
                const index = presentations.findIndex(p => p.id === currentEditingPresentationId);

                if (index !== -1) {
                    presentations[index].transition = transition;
                    presentations[index].lastModified = new Date().toISOString();
                    localStorage.setItem(`presentations_${currentPersona}`, JSON.stringify(presentations));
                    console.log('[Presentation] Transition changed to:', transition);

                    // Update Reveal instance
                    if (revealInstance) {
                        revealInstance.configure({ transition: transition });
                    }
                }
            }
        }

        function startPresentationMode() {
            if (!currentEditingPresentationId) return;

            // Save current state
            savePresentationSilently();

            const stored = localStorage.getItem(`presentations_${currentPersona}`);
            const presentations = stored ? JSON.parse(stored) : [];
            const presentation = presentations.find(p => p.id === currentEditingPresentationId);

            if (!presentation) return;

            // Create full-screen presentation window
            const presentWindow = window.open('', '_blank', 'width=1920,height=1080,fullscreen=yes');

            if (!presentWindow) {
                alert('Please allow popups to start presentation mode');
                return;
            }

            // Build presentation HTML
            const slidesHTML = presentation.slides.map(slide => {
                return `<section data-markdown><textarea data-template>${slide.content}</textarea></section>`;
            }).join('\n');

            // Generate custom style CSS if enabled
            let customStyleCSS = '';
            if (presentation.customStyle && presentation.customStyle.enabled) {
                const style = presentation.customStyle;
                const colors = style.colors;
                customStyleCSS = `
        /* Custom Presentation Styles */
        .reveal {
            font-family: ${style.fontFamily} !important;
        }

        .reveal .slides {
            background: ${style.backgroundColor} !important;
        }

        .reveal h1,
        .reveal h2,
        .reveal h3 {
            color: ${colors.primary} !important;
        }

        .reveal p,
        .reveal li {
            color: ${style.textColor} !important;
        }

        .reveal a {
            color: ${colors.secondary} !important;
        }

        .reveal a:hover {
            color: ${colors.accent1} !important;
        }

        .reveal code {
            background: ${colors.light} !important;
            color: ${style.textColor} !important;
        }

        .reveal pre {
            background: ${colors.light} !important;
        }

        .reveal blockquote {
            border-left: 5px solid ${colors.accent1} !important;
            background: ${colors.light} !important;
        }

        .reveal strong {
            color: ${colors.accent2} !important;
        }

        .reveal .controls {
            color: ${colors.primary} !important;
        }

        .reveal .progress {
            background: ${colors.light} !important;
        }

        .reveal .progress span {
            background: ${colors.primary} !important;
        }`;
            }

            const htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>${presentation.name}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/theme/${presentation.theme || 'white'}.css">
    <style>
        .reveal { font-family: 'Barlow', sans-serif; }
        ${customStyleCSS}
    </style>
</head>
<body>
    <div class="reveal">
        <div class="slides">
            ${slidesHTML}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/dist/reveal.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.0.4/plugin/markdown/markdown.js"><\/script>
    <script>
        Reveal.initialize({
            controls: true,
            progress: true,
            center: true,
            hash: true,
            transition: '${presentation.transition || 'slide'}',
            plugins: [ RevealMarkdown ]
        });
    <\/script>
</body>
</html>`;
            presentWindow.document.write(htmlContent);
            presentWindow.document.close();

            console.log('[Presentation] ✅ Presentation mode started with custom styles:', presentation.customStyle?.enabled || false);
        }

        // PlantUML encoder function
        function encodePlantUML(plantumlCode) {
            // PlantUML uses a custom base64-like encoding
            const encode64 = (data) => {
                let r = '';
                for (let i = 0; i < data.length; i += 3) {
                    if (i + 2 === data.length) {
                        r += append3bytes(data.charCodeAt(i), data.charCodeAt(i + 1), 0);
                    } else if (i + 1 === data.length) {
                        r += append3bytes(data.charCodeAt(i), 0, 0);
                    } else {
                        r += append3bytes(data.charCodeAt(i), data.charCodeAt(i + 1), data.charCodeAt(i + 2));
                    }
                }
                return r;
            };

            const append3bytes = (b1, b2, b3) => {
                const c1 = b1 >> 2;
                const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
                const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
                const c4 = b3 & 0x3F;
                let r = '';
                r += encode6bit(c1 & 0x3F);
                r += encode6bit(c2 & 0x3F);
                r += encode6bit(c3 & 0x3F);
                r += encode6bit(c4 & 0x3F);
                return r;
            };

            const encode6bit = (b) => {
                if (b < 10) return String.fromCharCode(48 + b);
                b -= 10;
                if (b < 26) return String.fromCharCode(65 + b);
                b -= 26;
                if (b < 26) return String.fromCharCode(97 + b);
                b -= 26;
                if (b === 0) return '-';
                if (b === 1) return '_';
                return '?';
            };

            // Compress using a simple deflate-like algorithm (simplified)
            const utf8Encode = unescape(encodeURIComponent(plantumlCode));

            // Use pako if available, otherwise use uncompressed
            if (typeof pako !== 'undefined') {
                const compressed = pako.deflate(utf8Encode, { level: 9 });
                return encode64(String.fromCharCode.apply(null, compressed));
            } else {
                // Fallback: just encode without compression
                return encode64(utf8Encode);
            }
        }

        // Simple built-in markdown parser (no external dependencies)
        function parseMarkdown(markdown) {
            let html = markdown;

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Process code blocks first (to protect them from other transformations)
            const codeBlocks = [];
            let diagramCounter = 0;
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
                const trimmedCode = code.trim();

                console.log('[Markdown] Code block detected, language:', lang, 'length:', trimmedCode.length);

                // Handle Mermaid diagrams
                if (lang && lang.toLowerCase() === 'mermaid') {
                    console.log('[Markdown] Rendering Mermaid diagram');
                    const mermaidId = `mermaid-${Date.now()}-${diagramCounter++}`;
                    codeBlocks.push(`<div class="mermaid-diagram" id="${mermaidId}" data-diagram="${escapeHtml(trimmedCode)}" style="background: white; padding: 20px; border-radius: 8px; margin: 16px 0;"><div class="mermaid">${trimmedCode}</div></div>`);
                    return placeholder;
                }

                // Handle PlantUML diagrams
                if (lang && (lang.toLowerCase() === 'plantuml' || lang.toLowerCase() === 'puml')) {
                    console.log('[Markdown] Rendering PlantUML diagram');
                    const encodedUml = encodePlantUML(trimmedCode);
                    const plantUmlUrl = `https://www.plantuml.com/plantuml/svg/${encodedUml}`;
                    console.log('[Markdown] PlantUML URL:', plantUmlUrl);
                    codeBlocks.push(`<div style="background: white; padding: 20px; border-radius: 8px; margin: 16px 0; text-align: center;"><img src="${plantUmlUrl}" alt="PlantUML Diagram" style="max-width: 100%; height: auto;" onerror="this.parentElement.innerHTML='<p style=\\'color:red\\'>Error loading PlantUML diagram. Check console for URL.</p>'"></div>`);
                    return placeholder;
                }

                // Regular code block
                codeBlocks.push(`<pre><code>${escapeHtml(trimmedCode)}</code></pre>`);
                return placeholder;
            });

            // Inline code (but protect placeholders)
            html = html.replace(/`([^`]+)`/g, (match, code) => {
                // Don't process if this looks like a placeholder
                if (code.includes('__CODE_BLOCK_')) return match;
                return `<code>${code}</code>`;
            });

            // Process tables before line-by-line processing
            const tables = [];
            const tableRegex = /^\|.+\|\s*\n\|[-:\s|]+\|\s*\n(?:\|.+\|\s*\n?)+/gm;
            html = html.replace(tableRegex, (match) => {
                const placeholder = `__TABLE_${tables.length}__`;
                const lines = match.trim().split('\n');

                if (lines.length < 2) {
                    tables.push(match); // Invalid table, keep as-is
                    return placeholder;
                }

                // Parse header
                const headerCells = lines[0].split('|').filter(cell => cell.trim()).map(cell => cell.trim());

                // Parse alignment row (optional, skip for now)
                const alignments = lines[1].split('|').filter(cell => cell.trim()).map(cell => {
                    const c = cell.trim();
                    if (c.startsWith(':') && c.endsWith(':')) return 'center';
                    if (c.endsWith(':')) return 'right';
                    return 'left';
                });

                // Parse data rows
                const dataRows = lines.slice(2).map(line =>
                    line.split('|').filter(cell => cell.trim()).map(cell => cell.trim())
                );

                // Build HTML table
                let tableHtml = '<table style="width: 100%; border-collapse: collapse; margin: 16px 0; font-family: var(--font-family-body); font-size: 14px;">';

                // Header
                tableHtml += '<thead><tr style="background: rgba(255, 255, 255, 0.1); border-bottom: 2px solid rgba(255, 255, 255, 0.2);">';
                headerCells.forEach((cell, i) => {
                    const align = alignments[i] || 'left';
                    tableHtml += `<th style="padding: 12px; text-align: ${align}; font-family: var(--font-family-ui); font-weight: 600; color: white;">${cell}</th>`;
                });
                tableHtml += '</tr></thead>';

                // Body
                tableHtml += '<tbody>';
                dataRows.forEach(row => {
                    tableHtml += '<tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">';
                    row.forEach((cell, i) => {
                        const align = alignments[i] || 'left';
                        tableHtml += `<td style="padding: 12px; text-align: ${align}; color: white;">${cell}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                tableHtml += '</tbody></table>';

                tables.push(tableHtml);
                return placeholder;
            });

            // Split into lines for line-by-line processing
            const lines = html.split('\n');
            const processed = [];
            let inList = false;
            let listType = null;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];

                // Skip processing if line contains a code block or table placeholder
                if (line.includes('__CODE_BLOCK_') || line.includes('__TABLE_')) {
                    if (inList) {
                        processed.push(`</${listType}>`);
                        inList = false;
                        listType = null;
                    }
                    processed.push(line);
                    continue;
                }

                // Headings
                if (line.match(/^(#{1,6})\s+(.+)$/)) {
                    const level = RegExp.$1.length;
                    const text = RegExp.$2;
                    line = `<h${level}>${text}</h${level}>`;
                }
                // Horizontal rule
                else if (line.match(/^[-*_]{3,}$/)) {
                    line = '<hr>';
                }
                // Unordered list
                else if (line.match(/^[-*]\s+(.+)$/)) {
                    if (!inList || listType !== 'ul') {
                        if (inList) processed.push(`</${listType}>`);
                        processed.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    line = `<li>${RegExp.$1}</li>`;
                }
                // Ordered list
                else if (line.match(/^\d+\.\s+(.+)$/)) {
                    if (!inList || listType !== 'ol') {
                        if (inList) processed.push(`</${listType}>`);
                        processed.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    line = `<li>${RegExp.$1}</li>`;
                }
                // Blockquote
                else if (line.match(/^>\s+(.+)$/)) {
                    line = `<blockquote>${RegExp.$1}</blockquote>`;
                }
                // Normal paragraph
                else if (line.trim() !== '') {
                    if (inList) {
                        processed.push(`</${listType}>`);
                        inList = false;
                        listType = null;
                    }
                    line = `<p>${line}</p>`;
                } else {
                    if (inList) {
                        processed.push(`</${listType}>`);
                        inList = false;
                        listType = null;
                    }
                }

                processed.push(line);
            }

            if (inList) {
                processed.push(`</${listType}>`);
            }

            html = processed.join('\n');

            // Bold (but exclude code block placeholders)
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Skip __ bold processing for now, will do after code blocks restored

            // Italic
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            // Skip _ italic processing for now, will do after code blocks restored

            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

            // Images
            html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');

            // Restore code blocks BEFORE processing __ and _ patterns
            codeBlocks.forEach((block, i) => {
                html = html.replace(`__CODE_BLOCK_${i}__`, block);
            });

            // Restore tables
            tables.forEach((table, i) => {
                html = html.replace(`__TABLE_${i}__`, table);
            });

            // Now process __ and _ patterns (after code blocks restored)
            html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
            html = html.replace(/_(.+?)_/g, '<em>$1</em>');

            return html;
        }

        function updateMarkdownPreview() {
            if (!monacoMarkdownEditor) {
                console.warn('[Markdown] Editor not initialized');
                return;
            }

            const markdownContent = monacoMarkdownEditor.getValue();
            const previewElement = document.getElementById('markdownPreview');

            if (!previewElement) {
                console.error('[Markdown] Preview element not found');
                return;
            }

            try {
                // Use built-in markdown parser
                previewElement.innerHTML = parseMarkdown(markdownContent);

                // Render Mermaid diagrams
                if (window.mermaid) {
                    setTimeout(() => {
                        const mermaidElements = previewElement.querySelectorAll('.mermaid');
                        if (mermaidElements.length > 0) {
                            mermaid.run({
                                nodes: mermaidElements,
                                suppressErrors: false
                            }).then(() => {
                                console.log('[Markdown] ✅ Mermaid diagrams rendered:', mermaidElements.length);
                            }).catch(err => {
                                console.error('[Markdown] ❌ Mermaid render error:', err);
                            });
                        }
                    }, 100);
                }

                console.log('[Markdown] ✅ Preview updated, content length:', markdownContent.length);
            } catch (error) {
                console.error('[Markdown] ❌ Error rendering preview:', error);
                previewElement.innerHTML = `<p style="color: #f48771;">Error rendering markdown: ${error.message}</p>`;
            }
        }

        function editMarkdownMetadata() {
            if (!currentEditingMarkdownId) return;

            const stored = localStorage.getItem(`markdown_${currentPersona}`);
            const markdownDocs = stored ? JSON.parse(stored) : [];
            const markdownDoc = markdownDocs.find(m => m.id === currentEditingMarkdownId);

            if (!markdownDoc) return;

            // For now, use a simple prompt to edit name and description
            const newName = prompt('Markdown Document Name:', markdownDoc.name);
            if (newName === null) return; // User cancelled

            const newDescription = prompt('Description:', markdownDoc.description);
            if (newDescription === null) return; // User cancelled

            // Update metadata
            const index = markdownDocs.findIndex(m => m.id === currentEditingMarkdownId);
            if (index !== -1) {
                markdownDocs[index].name = newName.trim() || 'Untitled Markdown';
                markdownDocs[index].description = newDescription.trim();
                markdownDocs[index].lastModified = new Date().toISOString();
                localStorage.setItem(`markdown_${currentPersona}`, JSON.stringify(markdownDocs));

                // Update title in editor
                document.getElementById('markdownEditorTitle').textContent = newName || 'Untitled Markdown';

                console.log('[Markdown] Metadata updated');
            }
        }

        function populateAssetsExperienceFilter() {
            loadUserExperiences();
            const container = document.getElementById('assetsExperienceFilterOptions');
            if (!container) return;

            container.innerHTML = ''; // Clear existing content

            if (userExperiences.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No experiences found</div>';
                return;
            }

            // Load all assets to count linked items (using correct storage keys)
            const allAssets = [];

            // Load documents
            const storedDc = localStorage.getItem(`interview_documents_${currentPersona}`);
            if (storedDc) allAssets.push(...JSON.parse(storedDc));

            // Load diagrams (correct key: diagrams not interview_diagrams)
            const storedDg = localStorage.getItem(`diagrams_${currentPersona}`);
            if (storedDg) allAssets.push(...JSON.parse(storedDg));

            // Load whiteboards
            const storedWb = localStorage.getItem(`whiteboards_${currentPersona}`);
            if (storedWb) allAssets.push(...JSON.parse(storedWb));

            // Load markdown
            const storedMd = localStorage.getItem(`markdown_${currentPersona}`);
            if (storedMd) allAssets.push(...JSON.parse(storedMd));

            // Load code
            const storedCd = localStorage.getItem(`code_${currentPersona}`);
            if (storedCd) allAssets.push(...JSON.parse(storedCd));

            // Load plantuml
            const storedPu = localStorage.getItem(`plantuml_${currentPersona}`);
            if (storedPu) allAssets.push(...JSON.parse(storedPu));

            // Load mermaid
            const storedMm = localStorage.getItem(`mermaid_${currentPersona}`);
            if (storedMm) allAssets.push(...JSON.parse(storedMm));

            // Sort by most recent (matching Stories tab behavior)
            const sortedExperiences = [...userExperiences].sort((a, b) => {
                const dateA = a.startDate || '0000-00-00';
                const dateB = b.startDate || '0000-00-00';
                return dateB.localeCompare(dateA);
            });

            sortedExperiences.forEach((exp, sortIndex) => {
                // Get original index from userExperiences array
                const originalIndex = userExperiences.indexOf(exp);
                const checked = selectedAssetsExperienceFilters.has(originalIndex) ? 'checked' : '';
                const displayName = exp.title || exp.role || 'Untitled Experience';
                const company = exp.company || '';

                // Count assets linked to this experience (matching loadAllAssets filter logic)
                const linkedCount = allAssets.filter(asset => {
                    if (asset.linkedType !== 'experience') return false;
                    // Use same findIndex logic as loadAllAssets to map linkedId to index
                    const assetExpIndex = userExperiences.findIndex(e =>
                        (e.id && e.id === asset.linkedId) ||
                        (e.title && e.title === asset.linkedId) ||
                        (e.role && asset.linkedId && asset.linkedId.includes(e.role))
                    );
                    return assetExpIndex === originalIndex;
                }).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="assetsExpFilter_${originalIndex}" ${checked} onchange="toggleAssetsExperienceFilterItem(${originalIndex})" style="margin-right: 8px;">
                    <label for="assetsExpFilter_${originalIndex}" style="cursor: pointer; font-family: var(--font-family-body); font-size: 12px; color: ${hasItems ? 'var(--color-dark)' : '#999999'};">${displayName}${company ? ` (${company})` : ''} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function populateAssetsPortfolioFilter() {
            const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
            const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];
            const container = document.getElementById('assetsPortfolioFilterOptions');
            if (!container) return;

            container.innerHTML = ''; // Clear existing content

            if (portfolioItems.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No portfolio items found</div>';
                return;
            }

            // Load all assets to count linked items (using correct storage keys)
            const allAssets = [];

            // Load documents
            const storedDc = localStorage.getItem(`interview_documents_${currentPersona}`);
            if (storedDc) allAssets.push(...JSON.parse(storedDc));

            // Load diagrams (correct key: diagrams not interview_diagrams)
            const storedDg = localStorage.getItem(`diagrams_${currentPersona}`);
            if (storedDg) allAssets.push(...JSON.parse(storedDg));

            // Load whiteboards
            const storedWb = localStorage.getItem(`whiteboards_${currentPersona}`);
            if (storedWb) allAssets.push(...JSON.parse(storedWb));

            // Load markdown
            const storedMd = localStorage.getItem(`markdown_${currentPersona}`);
            if (storedMd) allAssets.push(...JSON.parse(storedMd));

            // Load code
            const storedCd = localStorage.getItem(`code_${currentPersona}`);
            if (storedCd) allAssets.push(...JSON.parse(storedCd));

            // Load plantuml
            const storedPu = localStorage.getItem(`plantuml_${currentPersona}`);
            if (storedPu) allAssets.push(...JSON.parse(storedPu));

            // Load mermaid
            const storedMm = localStorage.getItem(`mermaid_${currentPersona}`);
            if (storedMm) allAssets.push(...JSON.parse(storedMm));


            portfolioItems.forEach((item, index) => {
                const checked = selectedAssetsPortfolioFilters.has(index) ? 'checked' : '';
                const displayName = item.name || item.title || 'Untitled Portfolio Item';

                // Count assets linked to this portfolio item (matching loadAllAssets filter logic)
                const linkedCount = allAssets.filter(asset => {
                    if (asset.linkedType !== 'portfolio') return false;

                    // Handle legacy data where linkedId is string "undefined"
                    // In this case, we can't match reliably, so skip these assets
                    if (asset.linkedId === "undefined" || asset.linkedId === undefined) {
                        return false;
                    }

                    // Use same findIndex logic as loadAllAssets to map linkedId to index
                    const assetPortIndex = portfolioItems.findIndex(p =>
                        (p.id && p.id === asset.linkedId) ||
                        (p.name && p.name === asset.linkedId) ||
                        (p.title && p.title === asset.linkedId)
                    );
                    return assetPortIndex === index;
                }).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="assetsPortFilter_${index}" ${checked} onchange="toggleAssetsPortfolioFilterItem(${index})" style="margin-right: 8px;">
                    <label for="assetsPortFilter_${index}" style="cursor: pointer; font-family: var(--font-family-body); font-size: 12px; color: ${hasItems ? 'var(--color-dark)' : '#999999'};">${displayName} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function toggleAssetsExperienceFilter() {
            const dropdown = document.getElementById('assetsExperienceFilterDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                populateAssetsExperienceFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function toggleAssetsPortfolioFilter() {
            const dropdown = document.getElementById('assetsPortfolioFilterDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                populateAssetsPortfolioFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function toggleAssetsExperienceFilterItem(index) {
            if (selectedAssetsExperienceFilters.has(index)) {
                selectedAssetsExperienceFilters.delete(index);
            } else {
                selectedAssetsExperienceFilters.add(index);
            }

            // Update filter count badge
            const countBadge = document.getElementById('assetsExperienceFilterCount');
            if (selectedAssetsExperienceFilters.size > 0) {
                countBadge.textContent = selectedAssetsExperienceFilters.size;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }

            loadAllAssets();
        }

        function toggleAssetsPortfolioFilterItem(index) {
            if (selectedAssetsPortfolioFilters.has(index)) {
                selectedAssetsPortfolioFilters.delete(index);
            } else {
                selectedAssetsPortfolioFilters.add(index);
            }

            // Update filter count badge
            const countBadge = document.getElementById('assetsPortfolioFilterCount');
            if (selectedAssetsPortfolioFilters.size > 0) {
                countBadge.textContent = selectedAssetsPortfolioFilters.size;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }

            loadAllAssets();
        }

        function clearAssetsExperienceFilter() {
            selectedAssetsExperienceFilters.clear();
            const countBadge = document.getElementById('assetsExperienceFilterCount');
            countBadge.style.display = 'none';
            populateAssetsExperienceFilter();
            loadAllAssets();
        }

        function clearAssetsPortfolioFilter() {
            selectedAssetsPortfolioFilters.clear();
            const countBadge = document.getElementById('assetsPortfolioFilterCount');
            countBadge.style.display = 'none';
            populateAssetsPortfolioFilter();
            loadAllAssets();
        }

        // Legacy function (no longer called from mindmap)
        function openInterviewSlideout(category) {
            currentSlideout = 'interview-prep';
            currentInterviewCategory = category;
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');
            const behavioralContent = document.getElementById('behavioralContent');

            // Update title based on category
            const titles = {
                'Behavioral': 'Behavioral Interview Stories'
            };

            titleEl.textContent = titles[category] || 'Interview Preparation';

            // Hide all content sections
            hideAllContentSections();

            // Show appropriate content
            if (category === 'Behavioral') {
                behavioralContent.style.display = 'flex';
                loadStories();
            }

            // Show slideout
            slideout.classList.add('active');
        }

        function closeInterviewSlideout() {
            currentSlideout = '';
            const slideout = document.getElementById('interviewSlideout');
            slideout.classList.remove('active');

            // Reset profile request form to collapsed state
            const profileRequestForm = document.getElementById('profileRequestFormContainer');
            if (profileRequestForm) {
                profileRequestForm.style.display = 'none';
            }
        }

        // Left panel collapse state - start expanded
        let leftPanelCollapsed = false;

        // Toggle Left Panel
        function toggleLeftPanel() {
            const body = document.getElementById('canvasBody');
            const toggle = document.getElementById('leftPanelToggle');
            const icon = toggle.querySelector('i');

            leftPanelCollapsed = !leftPanelCollapsed;

            if (leftPanelCollapsed) {
                body.classList.add('left-collapsed');
                icon.className = 'ph ph-caret-right';
                localStorage.setItem('leftPanelCollapsed', 'true');
            } else {
                body.classList.remove('left-collapsed');
                icon.className = 'ph ph-caret-left';
                localStorage.setItem('leftPanelCollapsed', 'false');
                // Update user name and status bar when expanding
                updateLeftPanelUserName();
                updateLeftPanelStatusBar();
            }
        }

        // Restore left panel state on page load
        function restoreLeftPanelState() {
            const isCollapsed = localStorage.getItem('leftPanelCollapsed') === 'true';
            if (isCollapsed) {
                const body = document.getElementById('canvasBody');
                const toggle = document.getElementById('leftPanelToggle');
                const icon = toggle.querySelector('i');

                if (body && toggle && icon) {
                    leftPanelCollapsed = true;
                    body.classList.add('left-collapsed');
                    icon.className = 'ph ph-caret-right';
                }
            }
        }

        // Update user name in left panel
        function updateLeftPanelUserName() {
            const profileData = JSON.parse(localStorage.getItem('cleansheet_profile') || '{}');
            const firstName = profileData.firstName || 'User';

            const userNameEl = document.getElementById('leftPanelUserName');
            if (userNameEl) {
                userNameEl.textContent = firstName;
            }

            // Update subscription tier badge
            const currentTier = localStorage.getItem('subscription_tier') || 'seeker';
            const tierBadge = document.getElementById('leftPanelTierBadge');

            if (tierBadge) {
                const tierNames = {
                    member: 'Member',
                    learner: 'Learner',
                    seeker: 'Job Seeker'
                };

                const tierColors = {
                    member: '#16a34a',     // Green for free tier
                    learner: '#0066CC',    // Primary blue for learner
                    seeker: '#ea580c'      // Orange for job seeker
                };

                tierBadge.textContent = tierNames[currentTier] || 'Job Seeker';
                tierBadge.style.background = tierColors[currentTier] || '#ea580c';
            }
        }

        // Handle auth status click in left panel
        async function handleAuthStatusClick() {
            const authenticated = typeof isAuthenticated !== 'undefined' && isAuthenticated;

            if (authenticated) {
                // Open sign out confirmation modal
                openSignOutModal();
            } else {
                // Sign in directly
                await auth.signIn();
            }
        }

        // Update authentication status in left panel
        function updateLeftPanelAuthStatus() {
            const authStatusEl = document.getElementById('leftPanelAuthStatus');
            const authIconEl = document.getElementById('leftPanelAuthIcon');
            const authLabelEl = document.getElementById('leftPanelAuthLabel');
            const authDetailEl = document.getElementById('leftPanelAuthDetail');

            if (!authStatusEl || !authIconEl || !authLabelEl || !authDetailEl) return;

            // Check if authenticated
            const authenticated = typeof isAuthenticated !== 'undefined' && isAuthenticated;
            const user = typeof currentUser !== 'undefined' ? currentUser : null;

            // Make clickable and add handler
            authStatusEl.classList.add('clickable');
            authStatusEl.onclick = handleAuthStatusClick;

            // Remove all auth state classes
            authStatusEl.classList.remove('auth-authenticated', 'auth-not-authenticated');

            if (authenticated && user) {
                // Authenticated state
                authStatusEl.classList.add('auth-authenticated');
                authIconEl.className = 'ph ph-check-circle';
                authLabelEl.textContent = 'Signed in';
                authDetailEl.textContent = user.email || '';
            } else {
                // Not authenticated state
                authStatusEl.classList.add('auth-not-authenticated');
                authIconEl.className = 'ph ph-user-circle';
                authLabelEl.textContent = 'Not signed in';
                authDetailEl.textContent = '';
            }
        }

        // Update sync status in left panel
        function updateLeftPanelSyncStatus(state = null) {
            const syncStatusEl = document.getElementById('leftPanelSyncStatus');
            const syncIconEl = document.getElementById('leftPanelSyncIcon');
            const syncLabelEl = document.getElementById('leftPanelSyncLabel');
            const syncDetailEl = document.getElementById('leftPanelSyncDetail');

            if (!syncStatusEl || !syncIconEl || !syncLabelEl || !syncDetailEl) return;

            // Check subscription tier
            const currentTier = localStorage.getItem('subscription_tier') || 'seeker';
            const isMember = currentTier === 'member';

            // Check if authenticated
            const authenticated = typeof isAuthenticated !== 'undefined' && isAuthenticated;

            // Remove all sync state classes
            syncStatusEl.classList.remove('sync-syncing', 'sync-synced', 'sync-error', 'sync-disabled', 'member-disabled');

            // Member tier - show disabled state
            if (isMember) {
                syncStatusEl.classList.add('sync-disabled', 'member-disabled');
                syncIconEl.className = 'ph ph-cloud-slash';
                syncLabelEl.textContent = 'Cloud sync';
                syncDetailEl.textContent = '';
                return;
            }

            // Not authenticated - show disabled state
            if (!authenticated) {
                syncStatusEl.classList.add('sync-disabled');
                syncIconEl.className = 'ph ph-cloud-slash';
                syncLabelEl.textContent = 'Sync disabled';
                syncDetailEl.textContent = 'Sign in to enable';
                return;
            }

            // Authenticated - show sync state
            if (state === 'syncing') {
                syncStatusEl.classList.add('sync-syncing');
                syncIconEl.className = 'ph ph-cloud-arrow-up';
                syncLabelEl.textContent = 'Syncing...';
                syncDetailEl.textContent = '';
            } else if (state === 'error') {
                syncStatusEl.classList.add('sync-error');
                syncIconEl.className = 'ph ph-cloud-warning';
                syncLabelEl.textContent = 'Sync failed';
                syncDetailEl.textContent = 'Retry available';
            } else {
                // Synced or idle state
                syncStatusEl.classList.add('sync-synced');
                syncIconEl.className = 'ph ph-cloud-check';
                syncLabelEl.textContent = 'Synced';

                // Get last sync time
                const lastSync = localStorage.getItem('cleansheet_last_modified');
                if (lastSync) {
                    const syncDate = new Date(lastSync);
                    const now = new Date();
                    const diffMs = now - syncDate;
                    const diffMins = Math.floor(diffMs / 60000);

                    if (diffMins < 1) {
                        syncDetailEl.textContent = 'Just now';
                    } else if (diffMins < 60) {
                        syncDetailEl.textContent = `${diffMins}m ago`;
                    } else {
                        const diffHours = Math.floor(diffMins / 60);
                        syncDetailEl.textContent = `${diffHours}h ago`;
                    }
                } else {
                    syncDetailEl.textContent = '';
                }
            }
        }

        // Update all status indicators in left panel
        function updateLeftPanelStatusBar() {
            updateLeftPanelAuthStatus();
            updateLeftPanelSyncStatus();
        }

        // Track selected experience filters
        let selectedExperienceFilters = new Set();

        function toggleExperienceFilter() {
            const dropdown = document.getElementById('experienceFilterDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                // Populate the dropdown when opening
                populateExperienceFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function populateExperienceFilter() {
            const container = document.getElementById('experienceFilterOptions');
            container.innerHTML = '';

            // Load user experiences
            loadUserExperiences();

            if (userExperiences.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No experiences found</div>';
                return;
            }

            // Load stories to count linked items
            let storiesData = localStorage.getItem('cleansheet_stories');
            if (!storiesData) {
                storiesData = localStorage.getItem('behavioralStories');
            }
            const allStories = storiesData ? JSON.parse(storiesData) : [];

            // Sort by most recent
            const sortedExperiences = [...userExperiences].sort((a, b) => {
                const dateA = a.startDate || '0000-00-00';
                const dateB = b.startDate || '0000-00-00';
                return dateB.localeCompare(dateA);
            });

            sortedExperiences.forEach((exp, index) => {
                const displayText = `${exp.role || exp.title || 'Unknown Role'} - ${exp.organizationName || exp.company || 'Unknown Company'}`;
                const originalIndex = userExperiences.indexOf(exp);
                const isChecked = selectedExperienceFilters.has(originalIndex);

                // Count stories linked to this experience
                const linkedCount = allStories.filter(story => story.experienceIndex === originalIndex).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="expFilter_${originalIndex}" ${isChecked ? 'checked' : ''} onchange="updateExperienceFilter(${originalIndex})">
                    <label for="expFilter_${originalIndex}" style="color: ${hasItems ? 'inherit' : '#999999'};">${escapeHtml(displayText)} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function updateExperienceFilter(experienceIndex) {
            const checkbox = document.getElementById(`expFilter_${experienceIndex}`);

            if (checkbox.checked) {
                selectedExperienceFilters.add(experienceIndex);
            } else {
                selectedExperienceFilters.delete(experienceIndex);
            }

            updateFilterCount();
            loadStories();
        }

        function clearExperienceFilter() {
            selectedExperienceFilters.clear();
            updateFilterCount();
            populateExperienceFilter();
            loadStories();
        }

        function updateFilterCount() {
            const countBadge = document.getElementById('filterCount');
            const count = selectedExperienceFilters.size;

            if (count > 0) {
                countBadge.textContent = count;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        // Close all filter dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            // Check if click is inside any filter container
            const isInsideFilterContainer = event.target.closest('.experience-filter-container');

            if (!isInsideFilterContainer) {
                // Close all filter dropdowns (Stories tab only has experience filter now)
                const dropdowns = [
                    'experienceFilterDropdown',
                    'assetsExperienceFilterDropdown',
                    'assetsPortfolioFilterDropdown'
                ];

                dropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        dropdown.style.display = 'none';
                    }
                });
            }
        });

        // ============= PORTFOLIO FILTER FOR STORIES =============
        let selectedPortfolioFilters = new Set();

        function togglePortfolioFilter() {
            const dropdown = document.getElementById('portfolioFilterDropdown');
            if (!dropdown) return; // Element no longer exists (removed from Stories tab)

            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                populatePortfolioFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function populatePortfolioFilter() {
            const container = document.getElementById('portfolioFilterOptions');
            if (!container) return; // Element no longer exists (removed from Stories tab)

            container.innerHTML = '';

            // Load portfolio items
            const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
            const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];

            if (portfolioItems.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No portfolio items found</div>';
                return;
            }

            // Load stories to count linked items
            let storiesData = localStorage.getItem('cleansheet_stories');
            if (!storiesData) {
                storiesData = localStorage.getItem('behavioralStories');
            }
            const allStories = storiesData ? JSON.parse(storiesData) : [];

            portfolioItems.forEach((item, index) => {
                const displayText = item.name || item.title || 'Unknown Project';
                const isChecked = selectedPortfolioFilters.has(index);

                // Count stories linked to this portfolio item
                const linkedCount = allStories.filter(story => story.portfolioIndex === index).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="portFilter_${index}" ${isChecked ? 'checked' : ''} onchange="updatePortfolioFilter(${index})">
                    <label for="portFilter_${index}" style="color: ${hasItems ? 'inherit' : '#999999'};">${escapeHtml(displayText)} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function updatePortfolioFilter(portfolioIndex) {
            const checkbox = document.getElementById(`portFilter_${portfolioIndex}`);

            if (checkbox.checked) {
                selectedPortfolioFilters.add(portfolioIndex);
            } else {
                selectedPortfolioFilters.delete(portfolioIndex);
            }

            updatePortfolioFilterCount();
            loadStories();
        }

        function clearPortfolioFilter() {
            selectedPortfolioFilters.clear();
            updatePortfolioFilterCount();
            populatePortfolioFilter();
            loadStories();
        }

        function updatePortfolioFilterCount() {
            const countBadge = document.getElementById('portfolioFilterCount');
            if (!countBadge) return; // Element no longer exists (removed from Stories tab)

            const count = selectedPortfolioFilters.size;

            if (count > 0) {
                countBadge.textContent = count;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        // ============= DIAGRAM FILTERS =============
        let selectedDiagramExperienceFilters = new Set();
        let selectedDiagramPortfolioFilters = new Set();

        function toggleDiagramExperienceFilter() {
            const dropdown = document.getElementById('diagramExperienceFilterDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                populateDiagramExperienceFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function populateDiagramExperienceFilter() {
            const container = document.getElementById('diagramExperienceFilterOptions');
            container.innerHTML = '';

            loadUserExperiences();

            if (userExperiences.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No experiences found</div>';
                return;
            }

            // Load diagrams to count linked items
            const stored = localStorage.getItem(`diagrams_${currentPersona}`);
            const allDiagrams = stored ? JSON.parse(stored) : [];

            const sortedExperiences = [...userExperiences].sort((a, b) => {
                const dateA = a.startDate || '0000-00-00';
                const dateB = b.startDate || '0000-00-00';
                return dateB.localeCompare(dateA);
            });

            sortedExperiences.forEach((exp, index) => {
                const displayText = `${exp.role || exp.title || 'Unknown Role'} - ${exp.organizationName || exp.company || 'Unknown Company'}`;
                const originalIndex = userExperiences.indexOf(exp);
                const isChecked = selectedDiagramExperienceFilters.has(originalIndex);

                // Count diagrams linked to this experience
                const linkedCount = allDiagrams.filter(d =>
                    d.linkedType === 'experience' &&
                    ((exp.id && exp.id === d.linkedId) ||
                     (exp.title && d.linkedId && d.linkedId.includes(exp.title)) ||
                     (exp.role && d.linkedId && d.linkedId.includes(exp.role)))
                ).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="diagramExpFilter_${originalIndex}" ${isChecked ? 'checked' : ''} onchange="updateDiagramExperienceFilter(${originalIndex})">
                    <label for="diagramExpFilter_${originalIndex}" style="color: ${hasItems ? 'inherit' : '#999999'};">${escapeHtml(displayText)} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function updateDiagramExperienceFilter(experienceIndex) {
            const checkbox = document.getElementById(`diagramExpFilter_${experienceIndex}`);

            if (checkbox.checked) {
                selectedDiagramExperienceFilters.add(experienceIndex);
            } else {
                selectedDiagramExperienceFilters.delete(experienceIndex);
            }

            updateDiagramExperienceFilterCount();
            loadDiagrams();
        }

        function clearDiagramExperienceFilter() {
            selectedDiagramExperienceFilters.clear();
            updateDiagramExperienceFilterCount();
            populateDiagramExperienceFilter();
            loadDiagrams();
        }

        function updateDiagramExperienceFilterCount() {
            const countBadge = document.getElementById('diagramExperienceFilterCount');
            const count = selectedDiagramExperienceFilters.size;

            if (count > 0) {
                countBadge.textContent = count;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        function toggleDiagramPortfolioFilter() {
            const dropdown = document.getElementById('diagramPortfolioFilterDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                populateDiagramPortfolioFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function populateDiagramPortfolioFilter() {
            const container = document.getElementById('diagramPortfolioFilterOptions');
            container.innerHTML = '';

            const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
            const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];

            if (portfolioItems.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No portfolio items found</div>';
                return;
            }

            // Load diagrams to count linked items
            const stored = localStorage.getItem(`diagrams_${currentPersona}`);
            const allDiagrams = stored ? JSON.parse(stored) : [];

            portfolioItems.forEach((item, index) => {
                const displayText = item.name || item.title || 'Unknown Project';
                const isChecked = selectedDiagramPortfolioFilters.has(index);

                // Count diagrams linked to this portfolio item
                const linkedCount = allDiagrams.filter(d =>
                    d.linkedType === 'portfolio' &&
                    ((item.id && item.id === d.linkedId) ||
                     (item.name && item.name === d.linkedId) ||
                     (item.title && item.title === d.linkedId))
                ).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="diagramPortFilter_${index}" ${isChecked ? 'checked' : ''} onchange="updateDiagramPortfolioFilter(${index})">
                    <label for="diagramPortFilter_${index}" style="color: ${hasItems ? 'inherit' : '#999999'};">${escapeHtml(displayText)} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function updateDiagramPortfolioFilter(portfolioIndex) {
            const checkbox = document.getElementById(`diagramPortFilter_${portfolioIndex}`);

            if (checkbox.checked) {
                selectedDiagramPortfolioFilters.add(portfolioIndex);
            } else {
                selectedDiagramPortfolioFilters.delete(portfolioIndex);
            }

            updateDiagramPortfolioFilterCount();
            loadDiagrams();
        }

        function clearDiagramPortfolioFilter() {
            selectedDiagramPortfolioFilters.clear();
            updateDiagramPortfolioFilterCount();
            populateDiagramPortfolioFilter();
            loadDiagrams();
        }

        function updateDiagramPortfolioFilterCount() {
            const countBadge = document.getElementById('diagramPortfolioFilterCount');
            const count = selectedDiagramPortfolioFilters.size;

            if (count > 0) {
                countBadge.textContent = count;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        // ============= DOCUMENT FILTERS =============
        let selectedDocumentExperienceFilters = new Set();
        let selectedDocumentPortfolioFilters = new Set();

        function toggleDocumentExperienceFilter() {
            const dropdown = document.getElementById('documentExperienceFilterDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                populateDocumentExperienceFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function populateDocumentExperienceFilter() {
            const container = document.getElementById('documentExperienceFilterOptions');
            container.innerHTML = '';

            loadUserExperiences();

            if (userExperiences.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No experiences found</div>';
                return;
            }

            // Load documents to count linked items
            const stored = localStorage.getItem(`interview_documents_${currentPersona}`);
            const allDocuments = stored ? JSON.parse(stored) : [];

            const sortedExperiences = [...userExperiences].sort((a, b) => {
                const dateA = a.startDate || '0000-00-00';
                const dateB = b.startDate || '0000-00-00';
                return dateB.localeCompare(dateA);
            });

            sortedExperiences.forEach((exp, index) => {
                const displayText = `${exp.role || exp.title || 'Unknown Role'} - ${exp.organizationName || exp.company || 'Unknown Company'}`;
                const originalIndex = userExperiences.indexOf(exp);
                const isChecked = selectedDocumentExperienceFilters.has(originalIndex);

                // Count documents linked to this experience
                const linkedCount = allDocuments.filter(d =>
                    d.linkedType === 'experience' &&
                    ((exp.id && exp.id === d.linkedId) ||
                     (exp.title && d.linkedId && d.linkedId.includes(exp.title)) ||
                     (exp.role && d.linkedId && d.linkedId.includes(exp.role)))
                ).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="documentExpFilter_${originalIndex}" ${isChecked ? 'checked' : ''} onchange="updateDocumentExperienceFilter(${originalIndex})">
                    <label for="documentExpFilter_${originalIndex}" style="color: ${hasItems ? 'inherit' : '#999999'};">${escapeHtml(displayText)} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function updateDocumentExperienceFilter(experienceIndex) {
            const checkbox = document.getElementById(`documentExpFilter_${experienceIndex}`);

            if (checkbox.checked) {
                selectedDocumentExperienceFilters.add(experienceIndex);
            } else {
                selectedDocumentExperienceFilters.delete(experienceIndex);
            }

            updateDocumentExperienceFilterCount();
            loadInterviewDocuments();
        }

        function clearDocumentExperienceFilter() {
            selectedDocumentExperienceFilters.clear();
            updateDocumentExperienceFilterCount();
            populateDocumentExperienceFilter();
            loadInterviewDocuments();
        }

        function updateDocumentExperienceFilterCount() {
            const countBadge = document.getElementById('documentExperienceFilterCount');
            const count = selectedDocumentExperienceFilters.size;

            if (count > 0) {
                countBadge.textContent = count;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        function toggleDocumentPortfolioFilter() {
            const dropdown = document.getElementById('documentPortfolioFilterDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                populateDocumentPortfolioFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function populateDocumentPortfolioFilter() {
            const container = document.getElementById('documentPortfolioFilterOptions');
            container.innerHTML = '';

            const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
            const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];

            if (portfolioItems.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No portfolio items found</div>';
                return;
            }

            // Load documents to count linked items
            const stored = localStorage.getItem(`interview_documents_${currentPersona}`);
            const allDocuments = stored ? JSON.parse(stored) : [];

            portfolioItems.forEach((item, index) => {
                const displayText = item.name || item.title || 'Unknown Project';
                const isChecked = selectedDocumentPortfolioFilters.has(index);

                // Count documents linked to this portfolio item
                const linkedCount = allDocuments.filter(d =>
                    d.linkedType === 'portfolio' &&
                    ((item.id && item.id === d.linkedId) ||
                     (item.name && item.name === d.linkedId) ||
                     (item.title && item.title === d.linkedId))
                ).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="documentPortFilter_${index}" ${isChecked ? 'checked' : ''} onchange="updateDocumentPortfolioFilter(${index})">
                    <label for="documentPortFilter_${index}" style="color: ${hasItems ? 'inherit' : '#999999'};">${escapeHtml(displayText)} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function updateDocumentPortfolioFilter(portfolioIndex) {
            const checkbox = document.getElementById(`documentPortFilter_${portfolioIndex}`);

            if (checkbox.checked) {
                selectedDocumentPortfolioFilters.add(portfolioIndex);
            } else {
                selectedDocumentPortfolioFilters.delete(portfolioIndex);
            }

            updateDocumentPortfolioFilterCount();
            loadInterviewDocuments();
        }

        function clearDocumentPortfolioFilter() {
            selectedDocumentPortfolioFilters.clear();
            updateDocumentPortfolioFilterCount();
            populateDocumentPortfolioFilter();
            loadInterviewDocuments();
        }

        function updateDocumentPortfolioFilterCount() {
            const countBadge = document.getElementById('documentPortfolioFilterCount');
            const count = selectedDocumentPortfolioFilters.size;

            if (count > 0) {
                countBadge.textContent = count;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        // ============= WHITEBOARD FILTERS =============
        let selectedWhiteboardExperienceFilters = new Set();
        let selectedWhiteboardPortfolioFilters = new Set();

        function toggleWhiteboardExperienceFilter() {
            const dropdown = document.getElementById('whiteboardExperienceFilterDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                populateWhiteboardExperienceFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function populateWhiteboardExperienceFilter() {
            const container = document.getElementById('whiteboardExperienceFilterOptions');
            container.innerHTML = '';

            loadUserExperiences();

            if (userExperiences.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No experiences found</div>';
                return;
            }

            // Load whiteboards to count linked items
            const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
            const allWhiteboards = stored ? JSON.parse(stored) : [];

            const sortedExperiences = [...userExperiences].sort((a, b) => {
                const dateA = a.startDate || '0000-00-00';
                const dateB = b.startDate || '0000-00-00';
                return dateB.localeCompare(dateA);
            });

            sortedExperiences.forEach((exp, index) => {
                const displayText = `${exp.role || exp.title || 'Unknown Role'} - ${exp.organizationName || exp.company || 'Unknown Company'}`;
                const originalIndex = userExperiences.indexOf(exp);
                const isChecked = selectedWhiteboardExperienceFilters.has(originalIndex);

                // Count whiteboards linked to this experience
                const linkedCount = allWhiteboards.filter(wb =>
                    wb.linkedType === 'experience' &&
                    ((exp.id && exp.id === wb.linkedId) ||
                     (exp.title && wb.linkedId && wb.linkedId.includes(exp.title)) ||
                     (exp.role && wb.linkedId && wb.linkedId.includes(exp.role)))
                ).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="whiteboardExpFilter_${originalIndex}" ${isChecked ? 'checked' : ''} onchange="updateWhiteboardExperienceFilter(${originalIndex})">
                    <label for="whiteboardExpFilter_${originalIndex}" style="color: ${hasItems ? 'inherit' : '#999999'};">${escapeHtml(displayText)} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function updateWhiteboardExperienceFilter(experienceIndex) {
            const checkbox = document.getElementById(`whiteboardExpFilter_${experienceIndex}`);

            if (checkbox.checked) {
                selectedWhiteboardExperienceFilters.add(experienceIndex);
            } else {
                selectedWhiteboardExperienceFilters.delete(experienceIndex);
            }

            updateWhiteboardExperienceFilterCount();
            loadWhiteboards();
        }

        function clearWhiteboardExperienceFilter() {
            selectedWhiteboardExperienceFilters.clear();
            updateWhiteboardExperienceFilterCount();
            populateWhiteboardExperienceFilter();
            loadWhiteboards();
        }

        function updateWhiteboardExperienceFilterCount() {
            const countBadge = document.getElementById('whiteboardExperienceFilterCount');
            const count = selectedWhiteboardExperienceFilters.size;

            if (count > 0) {
                countBadge.textContent = count;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        function toggleWhiteboardPortfolioFilter() {
            const dropdown = document.getElementById('whiteboardPortfolioFilterDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (!isVisible) {
                populateWhiteboardPortfolioFilter();
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function populateWhiteboardPortfolioFilter() {
            const container = document.getElementById('whiteboardPortfolioFilterOptions');
            container.innerHTML = '';

            const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
            const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];

            if (portfolioItems.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--color-neutral-text); font-size: 12px;">No portfolio items found</div>';
                return;
            }

            // Load whiteboards to count linked items
            const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
            const allWhiteboards = stored ? JSON.parse(stored) : [];

            portfolioItems.forEach((item, index) => {
                const displayText = item.name || item.title || 'Unknown Project';
                const isChecked = selectedWhiteboardPortfolioFilters.has(index);

                // Count whiteboards linked to this portfolio item
                const linkedCount = allWhiteboards.filter(wb =>
                    wb.linkedType === 'portfolio' &&
                    ((item.id && item.id === wb.linkedId) ||
                     (item.name && item.name === wb.linkedId) ||
                     (item.title && item.title === wb.linkedId))
                ).length;
                const hasItems = linkedCount > 0;

                const option = document.createElement('div');
                option.className = 'experience-filter-option';
                option.innerHTML = `
                    <input type="checkbox" id="whiteboardPortFilter_${index}" ${isChecked ? 'checked' : ''} onchange="updateWhiteboardPortfolioFilter(${index})">
                    <label for="whiteboardPortFilter_${index}" style="color: ${hasItems ? 'inherit' : '#999999'};">${escapeHtml(displayText)} ${linkedCount > 0 ? `(${linkedCount})` : ''}</label>
                `;
                container.appendChild(option);
            });
        }

        function updateWhiteboardPortfolioFilter(portfolioIndex) {
            const checkbox = document.getElementById(`whiteboardPortFilter_${portfolioIndex}`);

            if (checkbox.checked) {
                selectedWhiteboardPortfolioFilters.add(portfolioIndex);
            } else {
                selectedWhiteboardPortfolioFilters.delete(portfolioIndex);
            }

            updateWhiteboardPortfolioFilterCount();
            loadWhiteboards();
        }

        function clearWhiteboardPortfolioFilter() {
            selectedWhiteboardPortfolioFilters.clear();
            updateWhiteboardPortfolioFilterCount();
            populateWhiteboardPortfolioFilter();
            loadWhiteboards();
        }

        function updateWhiteboardPortfolioFilterCount() {
            const countBadge = document.getElementById('whiteboardPortfolioFilterCount');
            const count = selectedWhiteboardPortfolioFilters.size;

            if (count > 0) {
                countBadge.textContent = count;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        // ============= CLEAR ALL FILTERS WRAPPER FUNCTIONS =============

        function clearAllStoriesFilters() {
            selectedExperienceFilters.clear();
            selectedPortfolioFilters.clear();
            updateFilterCount();
            updatePortfolioFilterCount();
            populateExperienceFilter();
            populatePortfolioFilter();
            loadStories();
        }

        function clearAllDiagramFilters() {
            selectedDiagramExperienceFilters.clear();
            selectedDiagramPortfolioFilters.clear();
            updateDiagramExperienceFilterCount();
            updateDiagramPortfolioFilterCount();
            populateDiagramExperienceFilter();
            populateDiagramPortfolioFilter();
            loadDiagrams();
        }

        function clearAllDocumentFilters() {
            selectedDocumentExperienceFilters.clear();
            selectedDocumentPortfolioFilters.clear();
            updateDocumentExperienceFilterCount();
            updateDocumentPortfolioFilterCount();
            populateDocumentExperienceFilter();
            populateDocumentPortfolioFilter();
            loadInterviewDocuments();
        }

        function clearAllWhiteboardFilters() {
            selectedWhiteboardExperienceFilters.clear();
            selectedWhiteboardPortfolioFilters.clear();
            updateWhiteboardExperienceFilterCount();
            updateWhiteboardPortfolioFilterCount();
            populateWhiteboardExperienceFilter();
            populateWhiteboardPortfolioFilter();
            loadWhiteboards();
        }

        function loadStories() {
            const container = document.getElementById('storiesContainer');
            container.innerHTML = '';

            // Load stories from imported profile data (cleansheet_stories) or fall back to behavioralStories
            let storiesData = localStorage.getItem('cleansheet_stories');
            if (!storiesData) {
                storiesData = localStorage.getItem('behavioralStories');
            }

            let allStories = storiesData ? JSON.parse(storiesData) : [];

            // Apply experience filter if any selected
            if (selectedExperienceFilters.size > 0) {
                allStories = allStories.filter(story => {
                    const expIndex = story.experienceIndex;
                    return expIndex !== undefined && selectedExperienceFilters.has(expIndex);
                });
            }

            // Apply portfolio filter if any selected
            if (selectedPortfolioFilters.size > 0) {
                allStories = allStories.filter(story => {
                    const portIndex = story.portfolioIndex;
                    return portIndex !== undefined && selectedPortfolioFilters.has(portIndex);
                });
            }

            const hasActiveFilters = selectedExperienceFilters.size > 0 || selectedPortfolioFilters.size > 0;

            if (allStories.length === 0) {
                const emptyMessage = hasActiveFilters
                    ? `<div style="text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-file-text" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No stories match the selected filters.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Try adjusting your filter.</p>
                        <button onclick="clearAllStoriesFilters()" style="margin-top: 16px; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">Clear Filter</button>
                    </div>`
                    : `<div style="text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-file-text" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No stories yet. Import your JSON data or click "Add New Story" to create your first STAR story.</p>
                    </div>`;
                container.innerHTML = emptyMessage;
                return;
            }

            allStories.forEach((story, index) => {
                const card = document.createElement('div');
                card.className = 'story-card';

                // Handle both imported format (experienceName) and legacy format (experience)
                const experienceDisplay = story.experienceName || story.experience || '';

                card.innerHTML = `
                    <div class="story-card-header">
                        <div>
                            <h3 class="story-title">${escapeHtml(story.title)}</h3>
                        </div>
                        <div class="story-actions">
                            <button class="story-action-btn" onclick="editStory(${index})" title="Edit">
                                <i class="ph ph-pencil-simple"></i>
                            </button>
                            <button class="story-action-btn delete" onclick="deleteStory(${index})" title="Delete">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>

                    ${experienceDisplay ? `<div class="story-experience">Related to: ${escapeHtml(experienceDisplay)}</div>` : ''}

                    <div class="story-section">
                        <div class="story-section-label">Situation</div>
                        <div class="story-section-text">${escapeHtml(story.situation)}</div>
                    </div>

                    <div class="story-section">
                        <div class="story-section-label">Task</div>
                        <div class="story-section-text">${escapeHtml(story.task)}</div>
                    </div>

                    <div class="story-section">
                        <div class="story-section-label">Action</div>
                        <div class="story-section-text">${escapeHtml(story.action)}</div>
                    </div>

                    <div class="story-section">
                        <div class="story-section-label">Result</div>
                        <div class="story-section-text">${escapeHtml(story.result)}</div>
                    </div>

                    ${story.competencies && story.competencies.length > 0 ? `
                        <div class="story-competencies">
                            ${story.competencies.map(comp => `<span class="competency-tag">${escapeHtml(comp)}</span>`).join('')}
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });

            // Update the story count in the D3 mindmap (get total count from localStorage, not filtered)
            let totalStoriesData = localStorage.getItem('cleansheet_stories');
            if (!totalStoriesData) {
                totalStoriesData = localStorage.getItem('behavioralStories');
            }
            const totalStories = totalStoriesData ? JSON.parse(totalStoriesData) : [];
            updateStoryCount(totalStories.length);
            updateBadgesOnly(); // FIXED: Use selective badge update instead of full re-render
        }

        function openStoryForm(editIndex = null) {
            const modal = document.getElementById('storyFormModal');
            const form = document.getElementById('storyForm');
            const formTitle = document.getElementById('formTitle');

            // Populate experience dropdown from Career Experience node
            populateExperienceDropdown();

            if (editIndex !== null) {
                // Edit mode - load from cleansheet_stories or behavioralStories
                currentEditingStoryId = editIndex;
                formTitle.textContent = 'Edit Story';

                let storiesData = localStorage.getItem('cleansheet_stories');
                if (!storiesData) {
                    storiesData = localStorage.getItem('behavioralStories');
                }
                const allStories = storiesData ? JSON.parse(storiesData) : [];
                const story = allStories[editIndex];

                if (story) {
                    document.getElementById('storyTitle').value = story.title || '';
                    document.getElementById('storyExperience').value = story.experienceName || story.experience || '';
                    document.getElementById('storySituation').value = story.situation || '';
                    document.getElementById('storyTask').value = story.task || '';
                    document.getElementById('storyAction').value = story.action || '';
                    document.getElementById('storyResult').value = story.result || '';
                    document.getElementById('storyCompetencies').value = story.competencies ? story.competencies.join(', ') : '';
                }
            } else {
                // Add mode
                currentEditingStoryId = null;
                formTitle.textContent = 'Add New Story';
                form.reset();
            }

            modal.classList.add('active');
        }

        function closeStoryForm() {
            const modal = document.getElementById('storyFormModal');
            modal.classList.remove('active');
            currentEditingStoryId = null;
        }

        function openStoryFormForExperience(experienceIndex) {
            // Open the story form
            openStoryForm();

            // Pre-select the experience in the dropdown
            loadUserExperiences();
            if (experienceIndex >= 0 && experienceIndex < userExperiences.length) {
                const exp = userExperiences[experienceIndex];
                const displayText = `${exp.role || exp.title} - ${exp.organizationName || exp.company}`;

                // Set the dropdown value after a short delay to ensure dropdown is populated
                setTimeout(() => {
                    const select = document.getElementById('storyExperience');
                    select.value = displayText;

                    // Also store the experienceIndex for when the story is saved
                    select.setAttribute('data-experience-index', experienceIndex);
                }, 50);
            }
        }

        function populateExperienceDropdown() {
            const select = document.getElementById('storyExperience');

            // Clear existing options (except first placeholder)
            select.innerHTML = '<option value="">Select an experience...</option>';

            // Load experiences from imported profile data (cleansheet_experiences) or fall back to legacy key
            let experiencesData = localStorage.getItem('cleansheet_experiences');
            if (!experiencesData) {
                experiencesData = localStorage.getItem('careerExperiences_' + currentPersona);
            }

            if (experiencesData) {
                try {
                    const experiences = JSON.parse(experiencesData);

                    // Sort by start date (most recent first)
                    const sortedExperiences = [...experiences].sort((a, b) => {
                        const dateA = a.startDate || '0000-00-00';
                        const dateB = b.startDate || '0000-00-00';
                        return dateB.localeCompare(dateA);
                    });

                    // Populate dropdown with formatted experience entries
                    sortedExperiences.forEach(exp => {
                        const option = document.createElement('option');
                        // Format: "Role - Organization"
                        const displayText = `${exp.role || exp.name} - ${exp.organizationName || exp.organization}`;
                        option.value = displayText;
                        option.textContent = displayText;
                        select.appendChild(option);
                    });
                } catch (e) {
                    console.error('Error loading experiences for dropdown:', e);
                }
            }
        }

        function saveStory(event) {
            event.preventDefault();

            const experienceValue = document.getElementById('storyExperience').value;

            // Find the experience index in the loaded experiences
            let experienceIndex = -1;
            let experiencesData = localStorage.getItem('cleansheet_experiences');
            if (!experiencesData) {
                experiencesData = localStorage.getItem('careerExperiences_' + currentPersona);
            }

            if (experiencesData && experienceValue) {
                try {
                    const experiences = JSON.parse(experiencesData);
                    experienceIndex = experiences.findIndex(exp => {
                        const displayText = `${exp.role || exp.name} - ${exp.organizationName || exp.organization}`;
                        return displayText === experienceValue;
                    });
                } catch (e) {
                    console.error('Error finding experience index:', e);
                }
            }

            const story = {
                title: document.getElementById('storyTitle').value.trim(),
                experience: experienceValue,
                experienceName: experienceValue, // Store both formats for compatibility
                experienceIndex: experienceIndex, // Store index for linking to loaded profile
                situation: document.getElementById('storySituation').value.trim(),
                task: document.getElementById('storyTask').value.trim(),
                action: document.getElementById('storyAction').value.trim(),
                result: document.getElementById('storyResult').value.trim(),
                competencies: document.getElementById('storyCompetencies').value
                    .split(',')
                    .map(c => c.trim())
                    .filter(c => c),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Load current stories from cleansheet_stories (imported) or behavioralStories (legacy)
            let storiesData = localStorage.getItem('cleansheet_stories');
            if (!storiesData) {
                storiesData = localStorage.getItem('behavioralStories');
            }
            const allStories = storiesData ? JSON.parse(storiesData) : [];

            if (currentEditingStoryId !== null) {
                // Update existing story
                allStories[currentEditingStoryId] = story;
            } else {
                // Add new story
                allStories.push(story);
            }

            // Save to localStorage (use cleansheet_stories key)
            localStorage.setItem('cleansheet_stories', JSON.stringify(allStories));
            // Also save to legacy key for backwards compatibility
            localStorage.setItem('behavioralStories', JSON.stringify(allStories));

            // Sync to cloud if authenticated (debounced)
            if (isAuthenticated && sync) {
                sync.hybridSave('stories', allStories, 2000).catch(err => {
                    console.error('Stories cloud sync failed:', err);
                });
            }

            // Reload stories
            loadStories();

            // Close form
            closeStoryForm();
        }

        function editStory(index) {
            openStoryForm(index);
        }

        function deleteStory(index) {
            if (confirm('Are you sure you want to delete this story?')) {
                // Load current stories
                let storiesData = localStorage.getItem('cleansheet_stories');
                if (!storiesData) {
                    storiesData = localStorage.getItem('behavioralStories');
                }
                const allStories = storiesData ? JSON.parse(storiesData) : [];

                // Remove story
                allStories.splice(index, 1);

                // Save updated stories
                localStorage.setItem('cleansheet_stories', JSON.stringify(allStories));
                localStorage.setItem('behavioralStories', JSON.stringify(allStories));

                loadStories();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // Technical Interview Prep Functions
        // ========================================

        // Removed switchTechTab() and loadTechnicalContent() - no longer needed with flat tab structure

        function loadMockSessions() {
            const container = document.getElementById('mockContainer');
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                    <i class="ph ph-video-camera" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                    <p style="font-family: var(--font-family-ui); font-size: 15px;">Schedule and track mock interview sessions.</p>
                    <p style="font-size: 13px; margin-top: 8px;">Coming soon: Book sessions with mentors, record feedback, and review performance.</p>
                </div>
            `;
        }

        function loadDiagrams(filterType = null, filterId = null) {
            const container = document.getElementById('diagramsContainer');
            const stored = localStorage.getItem(`diagrams_${currentPersona}`);
            let diagrams = stored ? JSON.parse(stored) : [];

            // Apply badge-click filter if provided (from Experience/Portfolio cards)
            if (filterType && filterId) {
                diagrams = diagrams.filter(d =>
                    d.linkedType === filterType && d.linkedId === filterId
                );
            }

            // Apply dropdown experience filter if any selected
            if (selectedDiagramExperienceFilters.size > 0) {
                loadUserExperiences();
                diagrams = diagrams.filter(d => {
                    if (d.linkedType !== 'experience') return false;
                    // Find the experience by ID or name
                    const expIndex = userExperiences.findIndex(exp =>
                        (exp.id && exp.id === d.linkedId) ||
                        (exp.title && exp.title === d.linkedId) ||
                        (exp.role && d.linkedId && d.linkedId.includes(exp.role))
                    );
                    return expIndex !== -1 && selectedDiagramExperienceFilters.has(expIndex);
                });
            }

            // Apply dropdown portfolio filter if any selected
            if (selectedDiagramPortfolioFilters.size > 0) {
                const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
                const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];
                diagrams = diagrams.filter(d => {
                    if (d.linkedType !== 'portfolio') return false;
                    const portIndex = portfolioItems.findIndex(item =>
                        (item.id && item.id === d.linkedId) ||
                        (item.name && item.name === d.linkedId) ||
                        (item.title && item.title === d.linkedId)
                    );
                    return portIndex !== -1 && selectedDiagramPortfolioFilters.has(portIndex);
                });
            }

            const hasDropdownFilters = selectedDiagramExperienceFilters.size > 0 || selectedDiagramPortfolioFilters.size > 0;
            const hasActiveFilters = (filterType && filterId) || hasDropdownFilters;

            if (diagrams.length === 0) {
                const emptyMessage = hasActiveFilters
                    ? `<div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-flow-arrow" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No diagrams match the selected filters.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Try adjusting your filter.</p>
                        <button onclick="clearAllDiagramFilters()" style="margin-top: 16px; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">Clear Filter</button>
                    </div>`
                    : `<div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-flow-arrow" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">Create system diagrams and architectural designs.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Click "Add Diagram" to create your first diagram.</p>
                    </div>`;

                container.innerHTML = emptyMessage;
                return;
            }

            // Add filter indicator if badge-click filtering is active
            let filterBanner = '';
            if (filterType && filterId) {
                filterBanner = `
                    <div style="padding: 12px 16px; margin-bottom: 16px; background: #e3f2fd; border: 1px solid var(--color-primary-blue); border-radius: 8px; display: flex; align-items: center; justify-content: space-between; gap: 12px; grid-column: 1/-1;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="ph ${filterType === 'experience' ? 'ph-briefcase' : 'ph-folder-open'}" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-primary-blue);">
                                Filtered by ${filterType} (${diagrams.length} diagram${diagrams.length === 1 ? '' : 's'})
                            </span>
                        </div>
                        <button onclick="clearAllDiagramFilters()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-x" style="font-size: 14px;"></i>
                            Clear Filter
                        </button>
                    </div>
                `;
            }

            // Display diagrams as cards
            container.innerHTML = filterBanner + diagrams.map(d => `
                <div class="story-card" style="padding: 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="ph ph-flow-arrow" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h4 style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${d.name || 'Untitled Diagram'}
                                </h4>
                                <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin: 0; word-wrap: break-word; overflow-wrap: break-word;">
                                    ${d.description || 'No description'}
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; flex-shrink: 0;">
                            <button onclick="event.stopPropagation(); openDiagramById('${d.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Open Diagram">
                                <i class="ph ph-flow-arrow" style="font-size: 14px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); editDiagramById('${d.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Edit Info">
                                <i class="ph ph-pencil-simple" style="font-size: 14px; color: var(--color-neutral-text);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteDiagramById('${d.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Delete Diagram">
                                <i class="ph ph-trash" style="font-size: 14px; color: #dc2626;"></i>
                            </button>
                        </div>
                    </div>
                    ${d.linkedType && d.linkedType !== 'none' ? `
                        <div style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #f5f5f7; border-radius: 4px;">
                            <i class="ph ${d.linkedType === 'experience' ? 'ph-briefcase' : 'ph-folder-open'}" style="font-size: 12px; color: var(--color-neutral-text);"></i>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">
                                Linked to ${d.linkedType}: ${d.linkedName || 'Unknown'}
                            </span>
                        </div>
                    ` : ''}
                    <div style="padding-top: 8px; border-top: 1px solid var(--color-neutral-border);">
                        <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-muted);">
                            ${d.lastModified ? 'Modified ' + new Date(d.lastModified).toLocaleDateString() : 'Created ' + new Date(d.created).toLocaleDateString()}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function loadInterviewDocuments(filterType = null, filterId = null) {
            console.log('=== LOADING INTERVIEW DOCUMENTS ===');
            console.log('Persona:', currentPersona);
            console.log('Filter:', filterType, filterId);
            const container = document.getElementById('interviewDocumentsContainer');
            console.log('Container found:', !!container);
            const stored = localStorage.getItem(`interview_documents_${currentPersona}`);
            console.log('Stored data:', stored);
            let documents = stored ? JSON.parse(stored) : [];
            console.log('Documents count:', documents.length);

            // Apply badge-click filter if provided (from Experience/Portfolio cards)
            if (filterType && filterId) {
                documents = documents.filter(d =>
                    d.linkedType === filterType && d.linkedId === filterId
                );
            }

            // Apply dropdown experience filter if any selected
            if (selectedDocumentExperienceFilters.size > 0) {
                loadUserExperiences();
                documents = documents.filter(d => {
                    if (d.linkedType !== 'experience') return false;
                    const expIndex = userExperiences.findIndex(exp =>
                        (exp.id && exp.id === d.linkedId) ||
                        (exp.title && exp.title === d.linkedId) ||
                        (exp.role && d.linkedId && d.linkedId.includes(exp.role))
                    );
                    return expIndex !== -1 && selectedDocumentExperienceFilters.has(expIndex);
                });
            }

            // Apply dropdown portfolio filter if any selected
            if (selectedDocumentPortfolioFilters.size > 0) {
                const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
                const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];
                documents = documents.filter(d => {
                    if (d.linkedType !== 'portfolio') return false;
                    const portIndex = portfolioItems.findIndex(item =>
                        (item.id && item.id === d.linkedId) ||
                        (item.name && item.name === d.linkedId) ||
                        (item.title && item.title === d.linkedId)
                    );
                    return portIndex !== -1 && selectedDocumentPortfolioFilters.has(portIndex);
                });
            }

            const hasDropdownFilters = selectedDocumentExperienceFilters.size > 0 || selectedDocumentPortfolioFilters.size > 0;
            const hasActiveFilters = (filterType && filterId) || hasDropdownFilters;

            if (documents.length === 0) {
                const emptyMessage = hasActiveFilters
                    ? `<div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-file-text" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No documents match the selected filters.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Try adjusting your filter.</p>
                        <button onclick="clearAllDocumentFilters()" style="margin-top: 16px; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">Clear Filter</button>
                    </div>`
                    : `<div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-file-text" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">Store interview-related documents and notes.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Click "Add Document" to create your first document.</p>
                    </div>`;

                container.innerHTML = emptyMessage;
                return;
            }

            // Add filter indicator if badge-click filtering is active
            let filterBanner = '';
            if (filterType && filterId) {
                filterBanner = `
                    <div style="padding: 12px 16px; margin-bottom: 16px; background: #e3f2fd; border: 1px solid var(--color-primary-blue); border-radius: 8px; display: flex; align-items: center; justify-content: space-between; gap: 12px; grid-column: 1/-1;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="ph ${filterType === 'experience' ? 'ph-briefcase' : 'ph-folder-open'}" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-primary-blue);">
                                Filtered by ${filterType} (${documents.length} document${documents.length === 1 ? '' : 's'})
                            </span>
                        </div>
                        <button onclick="clearAllDocumentFilters()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-x" style="font-size: 14px;"></i>
                            Clear Filter
                        </button>
                    </div>
                `;
            }

            // Display documents as cards
            container.innerHTML = filterBanner + documents.map(d => `
                <div class="story-card" style="padding: 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="ph ph-file-text" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h4 style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${d.name || 'Untitled Document'}
                                </h4>
                                <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin: 0; word-wrap: break-word; overflow-wrap: break-word;">
                                    ${d.description || 'No description'}
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; flex-shrink: 0;">
                            <button onclick="event.stopPropagation(); openDocumentById('${d.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Open Document">
                                <i class="ph ph-file-text" style="font-size: 14px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); editDocumentById('${d.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Edit Info">
                                <i class="ph ph-pencil-simple" style="font-size: 14px; color: var(--color-neutral-text);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteDocumentById('${d.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Delete Document">
                                <i class="ph ph-trash" style="font-size: 14px; color: #dc2626;"></i>
                            </button>
                        </div>
                    </div>
                    ${d.linkedType && d.linkedType !== 'none' ? `
                        <div style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #f5f5f7; border-radius: 4px;">
                            <i class="ph ${d.linkedType === 'experience' ? 'ph-briefcase' : 'ph-folder-open'}" style="font-size: 12px; color: var(--color-neutral-text);"></i>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">
                                Linked to ${d.linkedType}: ${d.linkedName || 'Unknown'}
                            </span>
                        </div>
                    ` : ''}
                    <div style="padding-top: 8px; border-top: 1px solid var(--color-neutral-border);">
                        <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-muted);">
                            ${d.lastModified ? 'Modified ' + new Date(d.lastModified).toLocaleDateString() : 'Created ' + new Date(d.created).toLocaleDateString()}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // ===== DIAGRAM CRUD =====
        let currentDiagramId = null;
        let currentDiagramLinkType = 'none';

        function addDiagram() {
            // Reset form
            document.getElementById('diagramName').value = '';
            document.getElementById('diagramDescription').value = '';
            document.getElementById('diagramModalTitle').textContent = 'Create Diagram';
            currentDiagramId = null;
            currentDiagramLinkType = 'none';

            // Reset link type buttons
            setDiagramLinkType('none');

            // Show modal
            document.getElementById('diagramModal').style.display = 'flex';
        }

        function closeDiagramModal() {
            document.getElementById('diagramModal').style.display = 'none';
            currentDiagramId = null;
        }

        function setDiagramLinkType(type) {
            currentDiagramLinkType = type;

            // Update button styles
            const experienceBtn = document.getElementById('diagramLinkTypeExperience');
            const portfolioBtn = document.getElementById('diagramLinkTypePortfolio');
            const noneBtn = document.getElementById('diagramLinkTypeNone');
            const select = document.getElementById('diagramLinkSelect');

            experienceBtn.style.background = 'white';
            experienceBtn.style.color = 'var(--color-dark)';
            experienceBtn.style.borderColor = 'var(--color-neutral-border)';

            portfolioBtn.style.background = 'white';
            portfolioBtn.style.color = 'var(--color-dark)';
            portfolioBtn.style.borderColor = 'var(--color-neutral-border)';

            noneBtn.style.background = 'white';
            noneBtn.style.color = 'var(--color-dark)';
            noneBtn.style.borderColor = 'var(--color-neutral-border)';

            if (type === 'experience') {
                experienceBtn.style.background = 'var(--color-primary-blue)';
                experienceBtn.style.color = 'white';
                experienceBtn.style.borderColor = 'var(--color-primary-blue)';

                loadUserExperiences();
                const experiences = userExperiences;

                select.innerHTML = '<option value="">Select an experience...</option>' +
                    experiences.map(exp =>
                        `<option value="${exp.id || exp.title}">${exp.title || exp.role || 'Untitled'} at ${exp.company || 'Unknown'}</option>`
                    ).join('');
                select.style.display = 'block';
            } else if (type === 'portfolio') {
                portfolioBtn.style.background = 'var(--color-primary-blue)';
                portfolioBtn.style.color = 'white';
                portfolioBtn.style.borderColor = 'var(--color-primary-blue)';

                const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
                const portfolio = portfolioData ? JSON.parse(portfolioData) : [];

                select.innerHTML = '<option value="">Select a portfolio item...</option>' +
                    portfolio.map(item =>
                        `<option value="${item.id || item.name}">${item.name || item.title || 'Untitled'}</option>`
                    ).join('');
                select.style.display = 'block';
            } else {
                noneBtn.style.background = 'var(--color-primary-blue)';
                noneBtn.style.color = 'white';
                noneBtn.style.borderColor = 'var(--color-primary-blue)';
                select.style.display = 'none';
            }
        }

        function saveDiagramMetadata() {
            const name = document.getElementById('diagramName').value.trim();
            const description = document.getElementById('diagramDescription').value.trim();
            const linkSelect = document.getElementById('diagramLinkSelect');
            const linkedId = linkSelect.value;
            const linkedName = linkedId ? linkSelect.options[linkSelect.selectedIndex].text : '';

            if (!name) {
                alert('Please enter a diagram name.');
                return;
            }

            const stored = localStorage.getItem(`diagrams_${currentPersona}`);
            let diagrams = stored ? JSON.parse(stored) : [];

            if (currentDiagramId) {
                // Update existing
                const index = diagrams.findIndex(d => d.id === currentDiagramId);
                if (index !== -1) {
                    diagrams[index].name = name;
                    diagrams[index].description = description;
                    diagrams[index].linkedType = currentDiagramLinkType;
                    diagrams[index].linkedId = linkedId;
                    diagrams[index].linkedName = linkedName;
                    diagrams[index].lastModified = new Date().toISOString();
                }
            } else {
                // Create new
                const newDiagram = {
                    id: Date.now().toString(),
                    name: name,
                    description: description,
                    linkedType: currentDiagramLinkType,
                    linkedId: linkedId,
                    linkedName: linkedName,
                    diagramData: null, // Will store draw.io/excalidraw data
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                diagrams.push(newDiagram);
            }

            localStorage.setItem(`diagrams_${currentPersona}`, JSON.stringify(diagrams));
            closeDiagramModal();
            loadDiagrams();
        }

        function editDiagramById(id) {
            const stored = localStorage.getItem(`diagrams_${currentPersona}`);
            const diagrams = stored ? JSON.parse(stored) : [];
            const diagram = diagrams.find(d => d.id === id);

            if (!diagram) return;

            currentDiagramId = id;
            document.getElementById('diagramName').value = diagram.name;
            document.getElementById('diagramDescription').value = diagram.description || '';
            document.getElementById('diagramModalTitle').textContent = 'Edit Diagram';

            setDiagramLinkType(diagram.linkedType || 'none');
            if (diagram.linkedId) {
                document.getElementById('diagramLinkSelect').value = diagram.linkedId;
            }

            document.getElementById('diagramModal').style.display = 'flex';
        }

        function deleteDiagramById(id) {
            if (!confirm('Are you sure you want to delete this diagram? This cannot be undone.')) {
                return;
            }

            const stored = localStorage.getItem(`diagrams_${currentPersona}`);
            let diagrams = stored ? JSON.parse(stored) : [];
            diagrams = diagrams.filter(d => d.id !== id);
            localStorage.setItem(`diagrams_${currentPersona}`, JSON.stringify(diagrams));

            loadDiagrams();
        }

        function openDiagramById(id) {
            // Mock function - diagram editor not yet implemented
            const stored = localStorage.getItem(`diagrams_${currentPersona}`);
            const diagrams = stored ? JSON.parse(stored) : [];
            const diagram = diagrams.find(d => d.id === id);
            const diagramName = diagram ? diagram.name : 'Diagram';

            showToast(`Opening "${diagramName}" in diagram editor... (Feature coming soon)`, 'info');
        }

        // ===== DOCUMENT CRUD =====
        let currentDocumentId = null;
        let currentDocumentLinkType = 'none';

        function addDocument() {
            // Reset form
            document.getElementById('documentName').value = '';
            document.getElementById('documentDescription').value = '';
            document.getElementById('documentModalTitle').textContent = 'Create Document';
            currentDocumentId = null;
            currentDocumentLinkType = 'none';

            // Reset link type buttons
            setDocumentLinkType('none');

            // Show modal
            document.getElementById('documentModal').style.display = 'flex';
        }

        function closeDocumentModal() {
            document.getElementById('documentModal').style.display = 'none';
            currentDocumentId = null;
        }

        function setDocumentLinkType(type) {
            currentDocumentLinkType = type;

            // Update button styles
            const experienceBtn = document.getElementById('documentLinkTypeExperience');
            const portfolioBtn = document.getElementById('documentLinkTypePortfolio');
            const noneBtn = document.getElementById('documentLinkTypeNone');
            const select = document.getElementById('documentLinkSelect');

            experienceBtn.style.background = 'white';
            experienceBtn.style.color = 'var(--color-dark)';
            experienceBtn.style.borderColor = 'var(--color-neutral-border)';

            portfolioBtn.style.background = 'white';
            portfolioBtn.style.color = 'var(--color-dark)';
            portfolioBtn.style.borderColor = 'var(--color-neutral-border)';

            noneBtn.style.background = 'white';
            noneBtn.style.color = 'var(--color-dark)';
            noneBtn.style.borderColor = 'var(--color-neutral-border)';

            if (type === 'experience') {
                experienceBtn.style.background = 'var(--color-primary-blue)';
                experienceBtn.style.color = 'white';
                experienceBtn.style.borderColor = 'var(--color-primary-blue)';

                loadUserExperiences();
                const experiences = userExperiences;

                select.innerHTML = '<option value="">Select an experience...</option>' +
                    experiences.map(exp =>
                        `<option value="${exp.id || exp.title}">${exp.title || exp.role || 'Untitled'} at ${exp.company || 'Unknown'}</option>`
                    ).join('');
                select.style.display = 'block';
            } else if (type === 'portfolio') {
                portfolioBtn.style.background = 'var(--color-primary-blue)';
                portfolioBtn.style.color = 'white';
                portfolioBtn.style.borderColor = 'var(--color-primary-blue)';

                const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
                const portfolio = portfolioData ? JSON.parse(portfolioData) : [];

                select.innerHTML = '<option value="">Select a portfolio item...</option>' +
                    portfolio.map(item =>
                        `<option value="${item.id || item.name}">${item.name || item.title || 'Untitled'}</option>`
                    ).join('');
                select.style.display = 'block';
            } else {
                noneBtn.style.background = 'var(--color-primary-blue)';
                noneBtn.style.color = 'white';
                noneBtn.style.borderColor = 'var(--color-primary-blue)';
                select.style.display = 'none';
            }
        }

        function saveDocumentMetadata() {
            console.log('=== SAVING DOCUMENT METADATA ===');
            const name = document.getElementById('documentName').value.trim();
            const description = document.getElementById('documentDescription').value.trim();
            const linkSelect = document.getElementById('documentLinkSelect');
            const linkedId = linkSelect.value;
            const linkedName = linkedId ? linkSelect.options[linkSelect.selectedIndex].text : '';

            console.log('Document name:', name);
            console.log('Document description:', description);

            if (!name) {
                alert('Please enter a document name.');
                return;
            }

            const stored = localStorage.getItem(`interview_documents_${currentPersona}`);
            let documents = stored ? JSON.parse(stored) : [];
            console.log('Existing documents:', documents.length);

            if (currentDocumentId) {
                // Update existing
                const index = documents.findIndex(d => d.id === currentDocumentId);
                if (index !== -1) {
                    documents[index].name = name;
                    documents[index].description = description;
                    documents[index].linkedType = currentDocumentLinkType;
                    documents[index].linkedId = linkedId;
                    documents[index].linkedName = linkedName;
                    documents[index].lastModified = new Date().toISOString();
                }
            } else {
                // Create new
                const newDocument = {
                    id: Date.now().toString(),
                    name: name,
                    description: description,
                    linkedType: currentDocumentLinkType,
                    linkedId: linkedId,
                    linkedName: linkedName,
                    content: '', // Empty editor content (will be populated on first edit)
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                documents.push(newDocument);
                console.log('Created new document with ID:', newDocument.id);
            }

            localStorage.setItem(`interview_documents_${currentPersona}`, JSON.stringify(documents));
            console.log('Saved documents to localStorage:', documents.length);
            closeDocumentModal();
            console.log('Calling loadInterviewDocuments()...');
            loadInterviewDocuments();
        }

        function editLatexById(id) {
            console.log('editLatexById called with id:', id);
            // Open the LaTeX editor with this document
            openLatexEditor(id);
        }

        function editDocumentById(id) {
            const stored = localStorage.getItem(`interview_documents_${currentPersona}`);
            const documents = stored ? JSON.parse(stored) : [];
            const doc = documents.find(d => d.id === id);

            if (!doc) return;

            currentDocumentId = id;
            document.getElementById('documentName').value = doc.name;
            document.getElementById('documentDescription').value = doc.description || '';
            document.getElementById('documentModalTitle').textContent = 'Edit Document';

            setDocumentLinkType(doc.linkedType || 'none');
            if (doc.linkedId) {
                document.getElementById('documentLinkSelect').value = doc.linkedId;
            }

            document.getElementById('documentModal').style.display = 'flex';
        }

        function deleteDocumentById(id) {
            if (!confirm('Are you sure you want to delete this document? This cannot be undone.')) {
                return;
            }

            const stored = localStorage.getItem(`interview_documents_${currentPersona}`);
            let documents = stored ? JSON.parse(stored) : [];
            documents = documents.filter(d => d.id !== id);
            localStorage.setItem(`interview_documents_${currentPersona}`, JSON.stringify(documents));

            loadInterviewDocuments();
        }

        // Document editor variables are now defined in quill-document-editor.js

        // Wrapper functions that use the new Quill editor
        function openDocumentById(id) {
            openDocumentByIdQuill(id);
        }

        function closeDocumentEditor() {
            closeDocumentEditorQuill();
        }

        function saveDocumentContentSilently() {
            saveDocumentContentSilentlyQuill();
        }

        // Wrapper functions for Draw.io diagram editor
        function openDiagramById(id) {
            openDiagramByIdDrawio(id);
        }

        function closeDiagramEditor() {
            closeDiagramEditorDrawio();
        }

        // Deprecated OLD functions removed to fix AMD conflicts





        function saveDocumentContent() {
            saveDocumentContentSilently();
            showToast('Document saved', 'success');
        }

        function editDocumentMetadata() {
            if (!currentEditingDocumentId) return;

            // Close the editor temporarily
            document.getElementById('documentEditor').style.display = 'none';

            // Open the metadata modal
            editDocumentById(currentEditingDocumentId);

            // Note: When the metadata modal closes, we'll need to reopen the editor
            // This will be handled in closeDocumentModal
        }

        function loadWhiteboards(filterType = null, filterId = null) {
            console.log('=== LOADING WHITEBOARDS LIST ===');
            console.log('Persona:', currentPersona);
            console.log('Filter:', filterType, filterId);
            const container = document.getElementById('whiteboardsContainer');
            const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
            let whiteboards = stored ? JSON.parse(stored) : [];
            console.log('Total whiteboards:', whiteboards.length);
            whiteboards.forEach(wb => {
                const hasData = !!wb.canvasData;
                const dataType = hasData ? (wb.canvasData.trim().startsWith('{') ? 'JSON (Excalidraw)' : 'XML (draw.io)') : 'none';
                console.log(`- ${wb.name} (ID: ${wb.id}): format=${dataType}, dataSize=${wb.canvasData?.length || 0} bytes`);
            });

            // Apply badge-click filter if provided (from Experience/Portfolio cards)
            if (filterType && filterId) {
                whiteboards = whiteboards.filter(wb =>
                    wb.linkedType === filterType && wb.linkedId === filterId
                );
                console.log('Filtered whiteboards:', whiteboards.length);
            }

            // Apply dropdown experience filter if any selected
            if (selectedWhiteboardExperienceFilters.size > 0) {
                loadUserExperiences();
                whiteboards = whiteboards.filter(wb => {
                    if (wb.linkedType !== 'experience') return false;
                    const expIndex = userExperiences.findIndex(exp =>
                        (exp.id && exp.id === wb.linkedId) ||
                        (exp.title && exp.title === wb.linkedId) ||
                        (exp.role && wb.linkedId && wb.linkedId.includes(exp.role))
                    );
                    return expIndex !== -1 && selectedWhiteboardExperienceFilters.has(expIndex);
                });
            }

            // Apply dropdown portfolio filter if any selected
            if (selectedWhiteboardPortfolioFilters.size > 0) {
                const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
                const portfolioItems = portfolioData ? JSON.parse(portfolioData) : [];
                whiteboards = whiteboards.filter(wb => {
                    if (wb.linkedType !== 'portfolio') return false;
                    const portIndex = portfolioItems.findIndex(item =>
                        (item.id && item.id === wb.linkedId) ||
                        (item.name && item.name === wb.linkedId) ||
                        (item.title && item.title === wb.linkedId)
                    );
                    return portIndex !== -1 && selectedWhiteboardPortfolioFilters.has(portIndex);
                });
            }

            const hasDropdownFilters = selectedWhiteboardExperienceFilters.size > 0 || selectedWhiteboardPortfolioFilters.size > 0;
            const hasActiveFilters = (filterType && filterId) || hasDropdownFilters;

            if (whiteboards.length === 0) {
                const emptyMessage = hasActiveFilters
                    ? `<div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-chalkboard" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No whiteboards match the selected filters.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Try adjusting your filter.</p>
                        <button onclick="clearAllWhiteboardFilters()" style="margin-top: 16px; padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer;">Clear Filter</button>
                    </div>`
                    : `<div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-chalkboard" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">Practice whiteboard coding and system design problems.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Click "Add Whiteboard" to create your first collaborative whiteboard.</p>
                    </div>`;

                container.innerHTML = emptyMessage;
                return;
            }

            // Add filter indicator if badge-click filtering is active
            let filterBanner = '';
            if (filterType && filterId) {
                filterBanner = `
                    <div style="padding: 12px 16px; margin-bottom: 16px; background: #e3f2fd; border: 1px solid var(--color-primary-blue); border-radius: 8px; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="ph ${filterType === 'experience' ? 'ph-briefcase' : 'ph-folder-open'}" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-primary-blue);">
                                Filtered by ${filterType} (${whiteboards.length} whiteboard${whiteboards.length === 1 ? '' : 's'})
                            </span>
                        </div>
                        <button onclick="clearAllWhiteboardFilters()" style="padding: 6px 12px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph ph-x" style="font-size: 14px;"></i>
                            Clear Filter
                        </button>
                    </div>
                `;
            }

            // Display whiteboards as cards
            container.innerHTML = filterBanner + whiteboards.map(wb => `
                <div class="story-card" style="padding: 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="ph ph-chalkboard" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h4 style="font-family: var(--font-family-ui); font-size: 15px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${wb.name || 'Untitled Whiteboard'}
                                </h4>
                                <p style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${wb.description || 'No description'}
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; flex-shrink: 0;">
                            <button onclick="event.stopPropagation(); openWhiteboardById('${wb.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Open Whiteboard">
                                <i class="ph ph-chalkboard" style="font-size: 14px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); editWhiteboardById('${wb.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Edit Info">
                                <i class="ph ph-pencil-simple" style="font-size: 14px; color: var(--color-neutral-text);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteWhiteboardById('${wb.id}')" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Delete Whiteboard">
                                <i class="ph ph-trash" style="font-size: 14px; color: #dc2626;"></i>
                            </button>
                        </div>
                    </div>
                    ${wb.linkedType && wb.linkedType !== 'none' ? `
                        <div style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #f5f5f7; border-radius: 4px;">
                            <i class="ph ${wb.linkedType === 'experience' ? 'ph-briefcase' : 'ph-folder-open'}" style="font-size: 12px; color: var(--color-neutral-text);"></i>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">
                                Linked to ${wb.linkedType}: ${wb.linkedName || 'Unknown'}
                            </span>
                        </div>
                    ` : ''}
                    <div style="padding-top: 8px; border-top: 1px solid var(--color-neutral-border);">
                        <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-muted);">
                            ${wb.lastModified ? 'Modified ' + new Date(wb.lastModified).toLocaleDateString() : 'Created ' + new Date(wb.created).toLocaleDateString()}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function addMockSession() {
            // Load user profile
            const profile = loadProfile();

            // Pre-fill email if available from previous requests
            const previousRequest = localStorage.getItem('cleansheet_profile_request');
            if (previousRequest) {
                const requestData = JSON.parse(previousRequest);
                document.getElementById('sessionEmail').value = requestData.email || '';
            }

            // Clear notes field
            document.getElementById('sessionNotes').value = '';

            // Show modal
            document.getElementById('sessionRequestModal').style.display = 'flex';
        }

        function closeSessionRequestModal() {
            document.getElementById('sessionRequestModal').style.display = 'none';
        }

        // Enhanced Consent Tracking System

        /**
         * Captures comprehensive consent data for transaction-level tracking
         * @param {string} serviceType - The type of service (coaching, consulting, partnership, profileBuilding, erasure, session)
         * @param {object} checkboxStates - Current state of consent checkboxes
         * @param {object} additionalContext - Any additional context for the consent
         * @returns {object} Complete consent data structure
         */
        function captureConsentData(serviceType, checkboxStates = {}, additionalContext = {}) {
            return {
                consentVersion: "2025.1",
                consentTimestamp: new Date().toISOString(),
                serviceType: serviceType,
                specificConsents: buildSpecificConsents(serviceType, checkboxStates),
                contextualAgreements: getContextualAgreements(serviceType, additionalContext),
                legalBasis: "consent", // GDPR Article 6(1)(a)
                consentText: getConsentText(serviceType), // Store actual text user saw
                termsOfService: {
                    agreed: checkboxStates.termsAccepted || false,
                    version: "current",
                    url: "https://cleansheet.info/terms-of-service.html"
                }
            };
        }

        /**
         * Builds specific consent details based on service type and checkbox states
         */
        function buildSpecificConsents(serviceType, checkboxStates) {
            const consents = {
                dataProcessing: {
                    agreed: true, // Implied by form submission
                    purpose: getDataProcessingPurpose(serviceType),
                    scope: getDataScope(serviceType),
                    retention: getRetentionPolicy(serviceType)
                },
                dataSharing: {
                    agreed: checkboxStates.sharing || false,
                    withWhom: getDataSharingRecipients(serviceType),
                    purpose: getDataSharingPurpose(serviceType)
                }
            };

            // Add service-specific consents
            switch (serviceType) {
                case 'profileBuilding':
                    consents.aiProcessing = {
                        agreed: checkboxStates.acknowledgement || false,
                        type: "AI-assisted open source search",
                        authorization: "explicit"
                    };
                    consents.selfCertification = {
                        agreed: checkboxStates.acknowledgement || false,
                        statement: "requesting profile only for myself"
                    };
                    break;

                case 'coaching':
                    consents.profileSharing = {
                        agreed: checkboxStates.coaching || false,
                        purpose: "coach match process",
                        recipients: ["Cleansheet coaching team"]
                    };
                    break;

                case 'session':
                    consents.profileSharing = {
                        agreed: checkboxStates.mockInterview || false,
                        purpose: "mock interview coaching",
                        recipients: ["Cleansheet coaching team"]
                    };
                    break;

                case 'erasure':
                    consents.dataRights = {
                        agreed: true, // Implied by erasure request submission
                        rightExercised: "erasure",
                        acknowledgment: "GDPR Article 17 right to erasure"
                    };
                    break;
            }

            return consents;
        }

        /**
         * Gets contextual agreements based on service type
         */
        function getContextualAgreements(serviceType, additionalContext) {
            const agreements = {
                serviceType: serviceType,
                specificAuthorizations: []
            };

            switch (serviceType) {
                case 'profileBuilding':
                    agreements.specificAuthorizations = [
                        "AI-assisted open source search based on profile information",
                        "Profile enhancement using publicly available data"
                    ];
                    break;

                case 'coaching':
                    agreements.specificAuthorizations = [
                        "Profile sharing with coaching team for matching",
                        "Experience data analysis for coach selection"
                    ];
                    break;

                case 'consulting':
                    agreements.specificAuthorizations = [
                        "Profile analysis for service discovery",
                        "Skills assessment for consulting opportunities"
                    ];
                    break;

                case 'partnership':
                    agreements.specificAuthorizations = [
                        "Profile evaluation for partnership opportunities",
                        "Business alignment assessment"
                    ];
                    break;

                case 'session':
                    agreements.specificAuthorizations = [
                        "Profile sharing for mock interview coach matching",
                        "Career data analysis for coaching preparation"
                    ];
                    break;

                case 'erasure':
                    agreements.specificAuthorizations = [
                        "Data deletion across all Cleansheet systems",
                        "Permanent removal of personal information"
                    ];
                    break;
            }

            if (additionalContext.persona) {
                agreements.personaContext = additionalContext.persona;
            }

            return agreements;
        }

        /**
         * Helper functions for consent data building
         */
        function getDataProcessingPurpose(serviceType) {
            const purposes = {
                'profileBuilding': 'AI-assisted profile enhancement and open source search',
                'coaching': 'facilitate the coach match process',
                'consulting': 'facilitate the service discovery process',
                'partnership': 'explore potential partnership opportunities',
                'session': 'mock interview coaching and coach matching',
                'erasure': 'data deletion and privacy rights fulfillment'
            };
            return purposes[serviceType] || 'service delivery';
        }

        function getDataScope(serviceType) {
            const scopes = {
                'profileBuilding': ['profile', 'experiences', 'contact_info', 'browser_metadata'],
                'coaching': ['profile', 'experiences', 'portfolio', 'job_opportunities', 'goals', 'stories'],
                'consulting': ['profile', 'experiences', 'skills', 'contact_info'],
                'partnership': ['profile', 'experiences', 'professional_info', 'contact_info'],
                'session': ['profile', 'experiences', 'portfolio', 'job_opportunities'],
                'erasure': ['all_personal_data']
            };
            return scopes[serviceType] || ['profile'];
        }

        function getDataSharingRecipients(serviceType) {
            const recipients = {
                'profileBuilding': ['Cleansheet AI systems', 'Profile enhancement services'],
                'coaching': ['Cleansheet coaching team', 'Matched coaches'],
                'consulting': ['Cleansheet consulting team', 'Service delivery team'],
                'partnership': ['Cleansheet partnership team', 'Business development team'],
                'session': ['Cleansheet coaching team', 'Mock interview coaches'],
                'erasure': ['No data sharing - deletion only']
            };
            return recipients[serviceType] || ['Cleansheet team'];
        }

        function getDataSharingPurpose(serviceType) {
            const purposes = {
                'profileBuilding': 'profile enhancement and improvement',
                'coaching': 'coach matching and service delivery',
                'consulting': 'service discovery and consulting delivery',
                'partnership': 'partnership evaluation and collaboration',
                'session': 'mock interview coaching and preparation',
                'erasure': 'no sharing - data deletion'
            };
            return purposes[serviceType] || 'service delivery';
        }

        function getRetentionPolicy(serviceType) {
            const policies = {
                'profileBuilding': 'retained until profile delivery or 90 days maximum',
                'coaching': 'retained for duration of coaching relationship plus 1 year',
                'consulting': 'retained for duration of consulting relationship plus 2 years',
                'partnership': 'retained for duration of partnership evaluation plus 1 year',
                'session': 'retained until session completion plus 30 days',
                'erasure': 'immediate deletion upon verification'
            };
            return policies[serviceType] || 'as per Privacy Policy';
        }

        function getConsentText(serviceType) {
            // This captures the actual consent text shown to the user
            const texts = {
                'profileBuilding': 'I acknowledge that I am requesting a profile only for myself, I authorize Cleansheet to perform an AI-assisted open source search based on my current profile and the information provided in this form, and I agree to the Terms of Service.',
                'coaching': 'I acknowledge that I am sharing my profile information with Cleansheet to facilitate the coach match process, and I agree to the Terms of Service.',
                'consulting': 'I acknowledge that I am sharing my information with Cleansheet to facilitate the service discovery process, and I agree to the Terms of Service.',
                'partnership': 'I acknowledge that I am sharing my information with Cleansheet to explore potential partnership opportunities, and I agree to the Terms of Service.',
                'session': 'I consent to sharing my profile, career experiences, job opportunities, and portfolio with Cleansheet\'s coaching team for the purpose of matching me with an appropriate mock interview coach.',
                'erasure': 'I request the deletion of my personal data in accordance with my privacy rights.'
            };
            return texts[serviceType] || 'I agree to the processing of my data for the requested service.';
        }

        /**
         * Maps request source to service type for consent tracking
         */
        function getServiceTypeFromSource(source) {
            const sourceToServiceMap = {
                'coaching': 'coaching',
                'consulting': 'consulting',
                'partnership': 'partnership',
                'slideout': 'profileBuilding',
                'subscription': 'profileBuilding',
                'modal': 'profileBuilding'
            };
            return sourceToServiceMap[source] || 'profileBuilding';
        }

        /**
         * Gets current checkbox states for consent tracking
         */
        function getCurrentCheckboxStates(serviceType) {
            const states = {};

            switch (serviceType) {
                case 'profileBuilding':
                    const slideoutAck = document.getElementById('slideoutAcknowledgement');
                    const subscriptionAck = document.getElementById('subscriptionAcknowledgement');
                    states.acknowledgement = (slideoutAck && slideoutAck.checked) || (subscriptionAck && subscriptionAck.checked) || false;
                    states.termsAccepted = states.acknowledgement; // Terms acceptance is implied in acknowledgement
                    break;

                case 'coaching':
                case 'consulting':
                case 'partnership':
                    const coachingAck = document.getElementById('coachingInquiryAcknowledgement');
                    states.coaching = coachingAck && coachingAck.checked || false;
                    states.termsAccepted = states.coaching; // Terms acceptance is implied
                    break;

                case 'session':
                    const mockInterviewConsent = document.getElementById('mockInterviewConsent');
                    states.mockInterview = mockInterviewConsent && mockInterviewConsent.checked || false;
                    states.sharing = states.mockInterview;
                    break;

                case 'erasure':
                    states.termsAccepted = true; // Implied by erasure request submission
                    break;
            }

            return states;
        }

        async function submitSessionRequest() {
            // Get form values
            const email = document.getElementById('sessionEmail').value.trim();
            const notes = document.getElementById('sessionNotes').value.trim();

            // Validate email
            if (!email) {
                alert('Please enter your email address.');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }

            try {
                // Load profile data
                const profile = loadProfile();

                // Load career experiences
                let experiences = [];
                try {
                    const expData = localStorage.getItem('cleansheet_experiences') ||
                                   localStorage.getItem('careerExperiences_' + currentPersona);
                    if (expData) {
                        experiences = JSON.parse(expData);
                    }
                } catch (e) {
                    console.error('Error loading experiences:', e);
                }

                // Load portfolio
                let portfolio = [];
                try {
                    const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
                    if (portfolioData) {
                        portfolio = JSON.parse(portfolioData);
                    }
                } catch (e) {
                    console.error('Error loading portfolio:', e);
                }

                // Load job opportunities
                let jobOpportunities = [];
                try {
                    const jobsData = localStorage.getItem(`jobOpportunities_${currentPersona}`);
                    if (jobsData) {
                        jobOpportunities = JSON.parse(jobsData);
                    }
                } catch (e) {
                    console.error('Error loading job opportunities:', e);
                }

                // Truncate and summarize data to fit Azure Table Storage 64KB property limit
                // Keep only essential fields, limit to first 5 items of each category
                const summarizeExperiences = (exps) => {
                    return exps.slice(0, 5).map(exp => ({
                        title: exp.title || exp.role || '',
                        company: exp.company || '',
                        startDate: exp.startDate || '',
                        endDate: exp.endDate || '',
                        skills: Array.isArray(exp.skills) ? exp.skills.slice(0, 10).join(', ') : ''
                    }));
                };

                const summarizePortfolio = (items) => {
                    return items.slice(0, 5).map(item => ({
                        name: item.name || item.title || '',
                        description: (item.description || '').substring(0, 200),
                        technologies: Array.isArray(item.technologies) ? item.technologies.slice(0, 10).join(', ') : '',
                        url: item.url || item.github || ''
                    }));
                };

                const summarizeJobs = (jobs) => {
                    return jobs.slice(0, 5).map(job => ({
                        title: job.title || job.position || '',
                        company: job.company || '',
                        status: job.status || '',
                        appliedDate: job.appliedDate || job.date || ''
                    }));
                };

                const experiencesSummary = summarizeExperiences(experiences);
                const portfolioSummary = summarizePortfolio(portfolio);
                const jobsSummary = summarizeJobs(jobOpportunities);

                // Generate unique RowKey: timestamp + random suffix
                const timestamp = new Date().toISOString().replace(/[-:]/g, '').replace(/\..+/, '');
                const randomSuffix = Math.random().toString(36).substring(2, 8);
                const rowKey = `${timestamp}_${randomSuffix}`;

                // Capture consent data for this session request
                const checkboxStates = getCurrentCheckboxStates('session');
                const consentData = captureConsentData('session', checkboxStates, {
                    persona: currentPersona,
                    experienceCount: experiences.length,
                    portfolioCount: portfolio.length,
                    jobOpportunitiesCount: jobOpportunities.length
                });

                // Create Table Storage entity with summarized data and consent tracking
                const entity = {
                    PartitionKey: 'SessionRequest',
                    RowKey: rowKey,
                    requestType: 'SessionRequest',
                    email: email,
                    firstName: profile.firstName || '',
                    lastName: profile.lastName || '',
                    profession: profile.profession || '',
                    careerGoal: (profile.goal || '').substring(0, 500), // Truncate long goals
                    notes: notes.substring(0, 1000), // Truncate notes
                    experienceCount: experiences.length,
                    portfolioCount: portfolio.length,
                    jobOpportunitiesCount: jobOpportunities.length,
                    careerExperience: JSON.stringify(experiencesSummary),
                    portfolio: JSON.stringify(portfolioSummary),
                    jobOpportunities: JSON.stringify(jobsSummary),
                    requestDate: new Date().toISOString(),
                    status: 'pending',
                    // Enhanced consent tracking
                    consentData: JSON.stringify(consentData),
                    consentVersion: consentData.consentVersion,
                    consentTimestamp: consentData.consentTimestamp,
                    legalBasis: consentData.legalBasis,
                    dataProcessingPurpose: consentData.specificConsents.dataProcessing.purpose,
                    consentedToSharing: consentData.specificConsents.profileSharing ? consentData.specificConsents.profileSharing.agreed : false
                };

                // POST to Azure Table Storage
                const response = await fetch(PROFILE_REQUEST_TABLE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json;odata=nometadata'
                    },
                    body: JSON.stringify(entity)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Table Storage error: ${response.status} - ${errorText}`);
                }

                console.log('Session request submitted successfully to Table Storage');

                // Close modal
                closeSessionRequestModal();

                // Show success message
                alert(`Session Request Submitted!\n\nThank you for your interest in mock interview coaching. We've received your request and will review your profile.\n\nWe'll contact you at ${email} as soon as we have a coach available who matches your requirements.\n\nThis is a preview service, so response times may vary.`);

                // Track in Application Insights if available
                if (window.appInsights) {
                    appInsights.trackEvent({
                        name: 'Session_Request_Submitted',
                        properties: {
                            persona: currentPersona,
                            experienceCount: experiences.length,
                            portfolioCount: portfolio.length,
                            jobOpportunitiesCount: jobOpportunities.length,
                            hasNotes: notes.length > 0,
                            timestamp: new Date().toISOString()
                        }
                    });
                }

            } catch (error) {
                console.error('Error submitting session request:', error);
                alert(`Error submitting request: ${error.message}\n\nPlease try again. If the problem persists, contact support.`);
            }
        }

        // ========================================
        // Profile Blob Storage Functions
        // ========================================

        /**
         * Gets browser metadata for request tracking
         * @returns {object} - Browser type and user agent info
         */
        function getBrowserMetadata() {
            const ua = navigator.userAgent;
            let browserType = 'Unknown';

            if (ua.includes('Firefox/')) {
                browserType = 'Firefox';
            } else if (ua.includes('Chrome/') && !ua.includes('Edg/')) {
                browserType = 'Chrome';
            } else if (ua.includes('Safari/') && !ua.includes('Chrome/')) {
                browserType = 'Safari';
            } else if (ua.includes('Edg/')) {
                browserType = 'Edge';
            } else if (ua.includes('OPR/') || ua.includes('Opera/')) {
                browserType = 'Opera';
            }

            return {
                browserType: browserType,
                userAgent: ua,
                platform: navigator.platform,
                language: navigator.language
            };
        }

        /**
         * Gets client IP address (best effort - requires external service)
         * Returns 'unavailable' if cannot be determined client-side
         * @returns {Promise<string>} - IP address or 'unavailable'
         */
        async function getClientIPAddress() {
            try {
                // Use ipify service to get public IP address
                const response = await fetch('https://api.ipify.org?format=json', {
                    timeout: 3000 // 3 second timeout
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.ip || 'unavailable';
                }
            } catch (error) {
                console.warn('Could not fetch IP address:', error);
            }
            return 'unavailable';
        }

        /**
         * Submits an erasure request using blob storage workflow
         * @param {string} name - User's full name
         * @param {string} email - User's email address
         * @returns {Promise<void>}
         */
        async function submitErasureRequestWithBlob(name, email) {
            try {
                // Get browser metadata
                const browserMetadata = getBrowserMetadata();

                // Get IP address (async, with fallback)
                const ipAddress = await getClientIPAddress();

                // Capture consent data for this erasure request
                const checkboxStates = getCurrentCheckboxStates('erasure');
                const consentData = captureConsentData('erasure', checkboxStates, {
                    persona: currentPersona,
                    requestedName: name,
                    ipAddress: ipAddress
                });

                // Wrap erasure request data with metadata and consent tracking
                const blobData = {
                    metadata: {
                        requestType: 'erasureRequest',
                        ipAddress: ipAddress,
                        browserType: browserMetadata.browserType,
                        userAgent: browserMetadata.userAgent,
                        platform: browserMetadata.platform,
                        language: browserMetadata.language,
                        requestDate: new Date().toISOString()
                    },
                    request: {
                        name: name,
                        email: email,
                        status: 'pending'
                    },
                    // Enhanced consent tracking for erasure requests
                    consentData: consentData
                };

                console.log('Submitting erasure request via blob storage...');
                console.log('Name:', name);
                console.log('Email:', email);
                console.log('IP Address:', ipAddress);
                console.log('Browser:', browserMetadata.browserType);

                // Upload blob to Azure Blob Storage
                const blobName = await uploadProfileBlob(email, blobData);
                console.log('✓ Erasure request blob uploaded:', blobName);

                // Create table reference entry with consent metadata
                await createProfileBlobTableReference(
                    email,
                    blobName,
                    'erasureRequest',  // requestType in table
                    {
                        name: name,
                        status: 'pending',
                        browserType: browserMetadata.browserType,
                        // Enhanced consent tracking in table
                        consentVersion: consentData.consentVersion,
                        consentTimestamp: consentData.consentTimestamp,
                        legalBasis: consentData.legalBasis,
                        rightExercised: 'erasure',
                        dataProcessingPurpose: consentData.specificConsents.dataProcessing.purpose
                    }
                );
                console.log('✓ Erasure request table entry created');

                return { success: true, blobName: blobName };

            } catch (error) {
                console.error('Failed to submit erasure request via blob storage:', error);
                throw error; // Re-throw to let caller handle UI feedback
            }
        }

        /**
         * Submits a profile request using blob storage workflow
         * @param {object} requestData - Request data (email, linkedIn, firstName, lastName, profession, source)
         * @returns {Promise<void>}
         */
        async function submitProfileRequestWithBlob(requestData) {
            try {
                // Get browser metadata
                const browserMetadata = getBrowserMetadata();

                // Get IP address (async, with fallback)
                const ipAddress = await getClientIPAddress();

                // Get current profile data for context
                const profile = loadProfile();
                const experiences = JSON.parse(localStorage.getItem('cleansheet_experiences') || '[]');

                // Determine service type from source for proper consent tracking
                const serviceType = getServiceTypeFromSource(requestData.source);

                // Capture consent data for this profile request
                const checkboxStates = getCurrentCheckboxStates(serviceType);
                const consentData = captureConsentData(serviceType, checkboxStates, {
                    persona: currentPersona,
                    experienceCount: experiences.length,
                    hasGoal: !!profile.goal,
                    hasProfession: !!profile.profession,
                    source: requestData.source,
                    ipAddress: ipAddress
                });

                // Wrap request data with metadata and consent tracking
                const blobData = {
                    metadata: {
                        requestType: 'profileRequest',
                        ipAddress: ipAddress,
                        browserType: browserMetadata.browserType,
                        userAgent: browserMetadata.userAgent,
                        platform: browserMetadata.platform,
                        language: browserMetadata.language,
                        requestDate: new Date().toISOString(),
                        source: requestData.source || 'unknown',
                        serviceType: serviceType
                    },
                    request: {
                        email: requestData.email,
                        linkedIn: requestData.linkedIn,
                        firstName: requestData.firstName || profile.firstName || '',
                        lastName: requestData.lastName || profile.lastName || '',
                        profession: requestData.profession || profile.profession || '',
                        goal: profile.goal || ''
                    },
                    profileSummary: {
                        experienceCount: experiences.length,
                        hasGoal: !!profile.goal,
                        hasProfession: !!profile.profession,
                        persona: currentPersona
                    },
                    // Enhanced consent tracking for profile requests
                    consentData: consentData
                };

                console.log('Submitting profile request via blob storage...');
                console.log('Email:', requestData.email);
                console.log('Source:', requestData.source);
                console.log('IP Address:', ipAddress);
                console.log('Browser:', browserMetadata.browserType);

                // Upload blob to Azure Blob Storage
                const blobName = await uploadProfileBlob(requestData.email, blobData);
                console.log('✓ Profile request blob uploaded:', blobName);

                // Create table reference entry with consent metadata
                await createProfileBlobTableReference(
                    requestData.email,
                    blobName,
                    'profileRequest',  // requestType in table
                    {
                        firstName: blobData.request.firstName,
                        lastName: blobData.request.lastName,
                        profession: blobData.request.profession,
                        linkedInURL: requestData.linkedIn,
                        source: requestData.source,
                        browserType: browserMetadata.browserType,
                        experienceCount: experiences.length,
                        // Enhanced consent tracking in table
                        serviceType: serviceType,
                        consentVersion: consentData.consentVersion,
                        consentTimestamp: consentData.consentTimestamp,
                        legalBasis: consentData.legalBasis,
                        dataProcessingPurpose: consentData.specificConsents.dataProcessing.purpose,
                        consentedToProcessing: true,
                        consentedToAI: consentData.specificConsents.aiProcessing ? consentData.specificConsents.aiProcessing.agreed : false,
                        specificAuthorizations: JSON.stringify(consentData.contextualAgreements.specificAuthorizations)
                    }
                );
                console.log('✓ Profile request table entry created');

                // Store request locally for reference
                const localRequest = {
                    email: requestData.email,
                    linkedIn: requestData.linkedIn,
                    firstName: blobData.request.firstName,
                    lastName: blobData.request.lastName,
                    profession: blobData.request.profession,
                    requestDate: blobData.metadata.requestDate,
                    status: 'submitted',
                    blobName: blobName
                };
                localStorage.setItem('cleansheet_profile_request', JSON.stringify(localRequest));

                return { success: true, blobName: blobName };

            } catch (error) {
                console.error('Failed to submit profile request via blob storage:', error);

                // Store failed request locally
                const failedRequest = {
                    email: requestData.email,
                    linkedIn: requestData.linkedIn,
                    requestDate: new Date().toISOString(),
                    status: 'failed',
                    error: error.message
                };
                localStorage.setItem('cleansheet_profile_request', JSON.stringify(failedRequest));

                throw error; // Re-throw to let caller handle UI feedback
            }
        }

        /**
         * Collects complete profile data from localStorage for blob storage
         * Returns a comprehensive JSON object with all user data (not truncated/summarized)
         */
        function collectFullProfileData() {
            const profile = JSON.parse(localStorage.getItem('cleansheet_profile') || '{}');
            const experiences = JSON.parse(localStorage.getItem('cleansheet_experiences') || '[]');
            const stories = JSON.parse(localStorage.getItem(`userStories_${currentPersona}`) || '[]');
            const goals = JSON.parse(localStorage.getItem(`userGoals_${currentPersona}`) || '[]');
            const portfolio = JSON.parse(localStorage.getItem(`userPortfolio_${currentPersona}`) || '[]');
            const jobOpportunities = JSON.parse(localStorage.getItem(`userJobs_${currentPersona}`) || '[]');

            // Collect all asset types metadata (not full content to keep size reasonable)
            const documents = JSON.parse(localStorage.getItem(`interview_documents_${currentPersona}`) || '[]');
            const diagrams = JSON.parse(localStorage.getItem(`diagrams_${currentPersona}`) || '[]');
            const whiteboards = JSON.parse(localStorage.getItem(`user_whiteboards_${currentPersona}`) || '[]');
            const codeSnippets = JSON.parse(localStorage.getItem(`user_code_snippets_${currentPersona}`) || '[]');
            const photos = JSON.parse(localStorage.getItem(`user_photos_${currentPersona}`) || '[]');
            const pdfs = JSON.parse(localStorage.getItem(`user_pdfs_${currentPersona}`) || '[]');
            const links = JSON.parse(localStorage.getItem(`user_links_${currentPersona}`) || '[]');

            // Strip full content from documents to reduce size (keep metadata only)
            const documentMetadata = documents.map(doc => ({
                id: doc.id,
                name: doc.name,
                description: doc.description,
                linkedType: doc.linkedType,
                linkedId: doc.linkedId,
                linkedName: doc.linkedName,
                created: doc.created,
                lastModified: doc.lastModified,
                contentLength: doc.content ? doc.content.length : 0
            }));

            return {
                metadata: {
                    exportDate: new Date().toISOString(),
                    persona: currentPersona,
                    version: '1.0'
                },
                profile: profile,
                experiences: experiences,
                stories: stories,
                goals: goals,
                portfolio: portfolio,
                jobOpportunities: jobOpportunities,
                assets: {
                    documents: documentMetadata,
                    diagrams: diagrams,
                    whiteboards: whiteboards,
                    codeSnippets: codeSnippets,
                    photos: photos,
                    pdfs: pdfs,
                    links: links
                }
            };
        }

        /**
         * Uploads profile data as JSON blob to Azure Blob Storage
         * @param {string} email - User's email address (used in blob path)
         * @param {object} profileData - Complete profile data object
         * @returns {Promise<string>} - Blob name (path) on success
         */
        async function uploadProfileBlob(email, profileData) {
            // Validate blob container URL is configured
            if (PROFILE_BLOB_CONTAINER_URL === 'REPLACE_WITH_SAS_URL_FROM_SCRIPT') {
                throw new Error('PROFILE_BLOB_CONTAINER_URL not configured. Run azure-create-profile-blobs.sh and update the constant.');
            }

            // Generate unique blob name: {email}/{timestamp}_{randomId}.json
            const timestamp = new Date().toISOString().replace(/[-:]/g, '').replace(/\..+/, '');
            const randomId = Math.random().toString(36).substring(2, 9);
            const blobName = `${email}/${timestamp}_${randomId}.json`;

            // Convert profile data to JSON string
            const jsonData = JSON.stringify(profileData, null, 2);
            const jsonSize = new Blob([jsonData]).size;

            // Enforce 10MB size limit (client-side check)
            const MAX_SIZE = 10 * 1024 * 1024; // 10MB
            if (jsonSize > MAX_SIZE) {
                throw new Error(`Profile data too large: ${(jsonSize / 1024 / 1024).toFixed(2)}MB exceeds 10MB limit`);
            }

            console.log(`Uploading profile blob: ${blobName} (${(jsonSize / 1024).toFixed(2)} KB)`);

            // Construct full blob URL (container URL + blob name)
            const blobUrl = `${PROFILE_BLOB_CONTAINER_URL.split('?')[0]}/${blobName}?${PROFILE_BLOB_CONTAINER_URL.split('?')[1]}`;

            // Upload to Azure Blob Storage using PUT request
            const response = await fetch(blobUrl, {
                method: 'PUT',
                headers: {
                    'x-ms-blob-type': 'BlockBlob',
                    'Content-Type': 'application/json',
                    'x-ms-meta-email': email,
                    'x-ms-meta-persona': currentPersona,
                    'x-ms-meta-exportdate': new Date().toISOString()
                },
                body: jsonData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Blob upload failed: ${response.status} - ${errorText}`);
            }

            console.log(`✓ Blob uploaded successfully: ${blobName}`);
            return blobName;
        }

        /**
         * Creates a table entry in ProfileRequests referencing a blob
         * @param {string} email - User's email
         * @param {string} blobName - Blob path returned from uploadProfileBlob()
         * @param {string} requestType - Type of request (e.g., 'FullProfileExport', 'SessionRequestWithBlob')
         * @param {object} metadata - Additional metadata to store in table (optional)
         * @returns {Promise<void>}
         */
        async function createProfileBlobTableReference(email, blobName, requestType, metadata = {}) {
            // Generate unique RowKey matching blob naming convention
            const timestamp = blobName.split('/')[1].split('_')[0]; // Extract timestamp from blobName
            const randomId = blobName.split('_')[1].replace('.json', ''); // Extract randomId
            const rowKey = `${timestamp}_${randomId}`;

            // Create table entity with blob reference
            const entity = {
                PartitionKey: 'ProfileRequest',
                RowKey: rowKey,
                requestType: requestType, // Defines backend processing logic
                email: email,
                blobName: blobName, // Reference to blob location
                requestDate: new Date().toISOString(),
                persona: currentPersona,
                status: 'pending',
                ...metadata // Merge any additional metadata
            };

            console.log('Creating table entry with blob reference:', entity);

            // POST to Azure Table Storage
            const response = await fetch(PROFILE_REQUEST_TABLE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json;odata=nometadata'
                },
                body: JSON.stringify(entity)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Table entry creation failed: ${response.status} - ${errorText}`);
            }

            console.log('✓ Table entry created successfully');
        }

        /**
         * Test workflow: Export full profile to blob storage
         * This function exercises the complete blob upload workflow:
         * 1. Collect full profile data from localStorage
         * 2. Upload JSON blob to Azure Blob Storage
         * 3. Create table reference entry in ProfileRequests
         *
         * Usage: Open browser console and run: testFullProfileExport('your@email.com')
         */
        window.testFullProfileExport = async function(email) {
            if (!email) {
                console.error('❌ Email required. Usage: testFullProfileExport("your@email.com")');
                return;
            }

            console.log('========================================');
            console.log('Starting Full Profile Export Test');
            console.log('========================================');

            try {
                // Step 1: Collect profile data
                console.log('Step 1: Collecting profile data...');
                const profileData = collectFullProfileData();
                const dataSize = new Blob([JSON.stringify(profileData)]).size;
                console.log(`✓ Profile data collected: ${(dataSize / 1024).toFixed(2)} KB`);
                console.log('  - Experiences:', profileData.experiences.length);
                console.log('  - Stories:', profileData.stories.length);
                console.log('  - Goals:', profileData.goals.length);
                console.log('  - Portfolio:', profileData.portfolio.length);
                console.log('  - Job Opportunities:', profileData.jobOpportunities.length);

                // Step 2: Upload blob
                console.log('\nStep 2: Uploading profile blob to Azure...');
                const blobName = await uploadProfileBlob(email, profileData);
                console.log(`✓ Blob uploaded: ${blobName}`);

                // Step 3: Create table reference
                console.log('\nStep 3: Creating table reference entry...');
                await createProfileBlobTableReference(email, blobName, 'FullProfileExport', {
                    experienceCount: profileData.experiences.length,
                    storyCount: profileData.stories.length,
                    goalCount: profileData.goals.length,
                    portfolioCount: profileData.portfolio.length,
                    jobCount: profileData.jobOpportunities.length
                });

                console.log('\n========================================');
                console.log('✓ Full Profile Export Test SUCCESSFUL');
                console.log('========================================');
                console.log(`\nBlob Name: ${blobName}`);
                console.log(`Email: ${email}`);
                console.log(`Size: ${(dataSize / 1024).toFixed(2)} KB`);
                console.log('\nTo verify:');
                console.log('1. Check Azure Table Storage ProfileRequests table for new entry');
                console.log('2. Use account key to read blob (SAS token is write-only)');
                console.log(`\naz storage blob show --account-name storageb681 --account-key "$ACCOUNT_KEY" --container-name profileblobs --name "${blobName}"`);

            } catch (error) {
                console.error('\n========================================');
                console.error('❌ Full Profile Export Test FAILED');
                console.error('========================================');
                console.error('Error:', error.message);
                console.error('Details:', error);
            }
        };

        // Log test function availability on page load
        console.log('%c[Cleansheet Profile Blob Storage]', 'color: #0066CC; font-weight: bold;');
        console.log('Test function available: testFullProfileExport(email)');
        console.log('Example: testFullProfileExport("test@example.com")');
        console.log('Before testing, run: ./azure-create-profile-blobs.sh');
        console.log('Then update PROFILE_BLOB_CONTAINER_URL constant with the generated SAS URL');

        // ========================================
        // Whiteboard Functions
        // ========================================

        let currentWhiteboardId = null;
        let currentWhiteboardLinkType = 'none';

        function addWhiteboard() {
            // Reset form
            document.getElementById('whiteboardName').value = '';
            document.getElementById('whiteboardDescription').value = '';
            document.getElementById('whiteboardModalTitle').textContent = 'Create Whiteboard';
            currentWhiteboardId = null;
            currentWhiteboardLinkType = 'none';

            // Reset link type buttons
            setWhiteboardLinkType('none');

            // Show modal
            document.getElementById('whiteboardModal').style.display = 'flex';
        }

        function closeWhiteboardModal() {
            document.getElementById('whiteboardModal').style.display = 'none';
            currentWhiteboardId = null;
        }

        function setWhiteboardLinkType(type) {
            currentWhiteboardLinkType = type;

            // Update button styles
            const experienceBtn = document.getElementById('linkTypeExperience');
            const portfolioBtn = document.getElementById('linkTypePortfolio');
            const noneBtn = document.getElementById('linkTypeNone');
            const select = document.getElementById('whiteboardLinkSelect');

            experienceBtn.style.background = 'white';
            experienceBtn.style.color = 'var(--color-dark)';
            experienceBtn.style.borderColor = 'var(--color-neutral-border)';

            portfolioBtn.style.background = 'white';
            portfolioBtn.style.color = 'var(--color-dark)';
            portfolioBtn.style.borderColor = 'var(--color-neutral-border)';

            noneBtn.style.background = 'white';
            noneBtn.style.color = 'var(--color-dark)';
            noneBtn.style.borderColor = 'var(--color-neutral-border)';

            if (type === 'experience') {
                experienceBtn.style.background = 'var(--color-primary-blue)';
                experienceBtn.style.color = 'white';
                experienceBtn.style.borderColor = 'var(--color-primary-blue)';

                // Use the already-loaded and normalized userExperiences array
                loadUserExperiences(); // Ensure experiences are loaded and normalized
                const experiences = userExperiences;

                select.innerHTML = '<option value="">Select an experience...</option>' +
                    experiences.map(exp =>
                        `<option value="${exp.id || exp.title}">${exp.title || exp.role || 'Untitled'} at ${exp.company || 'Unknown'}</option>`
                    ).join('');
                select.style.display = 'block';
            } else if (type === 'portfolio') {
                portfolioBtn.style.background = 'var(--color-primary-blue)';
                portfolioBtn.style.color = 'white';
                portfolioBtn.style.borderColor = 'var(--color-primary-blue)';

                // Load portfolio
                const portfolioData = localStorage.getItem(`userPortfolio_${currentPersona}`);
                const portfolio = portfolioData ? JSON.parse(portfolioData) : [];

                select.innerHTML = '<option value="">Select a portfolio item...</option>' +
                    portfolio.map(item =>
                        `<option value="${item.id || item.name}">${item.name || item.title || 'Untitled'}</option>`
                    ).join('');
                select.style.display = 'block';
            } else {
                noneBtn.style.background = 'var(--color-primary-blue)';
                noneBtn.style.color = 'white';
                noneBtn.style.borderColor = 'var(--color-primary-blue)';
                select.style.display = 'none';
            }
        }

        function saveWhiteboardMetadata() {
            const name = document.getElementById('whiteboardName').value.trim();
            const description = document.getElementById('whiteboardDescription').value.trim();
            const linkSelect = document.getElementById('whiteboardLinkSelect');
            const linkedId = linkSelect.value;
            const linkedName = linkedId ? linkSelect.options[linkSelect.selectedIndex].text : '';

            if (!name) {
                alert('Please enter a whiteboard name.');
                return;
            }

            // Get existing whiteboards
            const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
            let whiteboards = stored ? JSON.parse(stored) : [];

            if (currentWhiteboardId) {
                // Update existing
                const index = whiteboards.findIndex(wb => wb.id === currentWhiteboardId);
                if (index !== -1) {
                    whiteboards[index].name = name;
                    whiteboards[index].description = description;
                    whiteboards[index].linkedType = currentWhiteboardLinkType;
                    whiteboards[index].linkedId = linkedId;
                    whiteboards[index].linkedName = linkedName;
                    whiteboards[index].lastModified = new Date().toISOString();
                    console.log('Updated whiteboard:', whiteboards[index]);
                }
            } else {
                // Create new
                const newWhiteboard = {
                    id: Date.now().toString(),
                    name: name,
                    description: description,
                    linkedType: currentWhiteboardLinkType,
                    linkedId: linkedId,
                    linkedName: linkedName,
                    canvasData: null, // Will store whiteboard.js data
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                whiteboards.push(newWhiteboard);
                currentWhiteboardId = newWhiteboard.id;
                console.log('Created new whiteboard:', newWhiteboard);
            }

            // Save to localStorage
            localStorage.setItem(`whiteboards_${currentPersona}`, JSON.stringify(whiteboards));
            console.log('Saved to localStorage, opening editor for ID:', currentWhiteboardId);

            // Close modal and open editor
            closeWhiteboardModal();

            // Use setTimeout to ensure modal is closed before opening editor
            setTimeout(() => {
                openWhiteboardEditor(currentWhiteboardId);
            }, 100);
        }

        function saveWhiteboardMetadataOnly() {
            const name = document.getElementById('whiteboardName').value.trim();
            const description = document.getElementById('whiteboardDescription').value.trim();
            const linkSelect = document.getElementById('whiteboardLinkSelect');
            const linkedId = linkSelect.value;
            const linkedName = linkedId ? linkSelect.options[linkSelect.selectedIndex].text : '';

            if (!name) {
                alert('Please enter a whiteboard name.');
                return;
            }

            // Get existing whiteboards
            const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
            let whiteboards = stored ? JSON.parse(stored) : [];

            if (currentWhiteboardId) {
                // Update existing
                const index = whiteboards.findIndex(wb => wb.id === currentWhiteboardId);
                if (index !== -1) {
                    whiteboards[index].name = name;
                    whiteboards[index].description = description;
                    whiteboards[index].linkedType = currentWhiteboardLinkType;
                    whiteboards[index].linkedId = linkedId;
                    whiteboards[index].linkedName = linkedName;
                    whiteboards[index].lastModified = new Date().toISOString();
                    console.log('Updated whiteboard:', whiteboards[index]);
                }
            } else {
                // Create new
                const newWhiteboard = {
                    id: Date.now().toString(),
                    name: name,
                    description: description,
                    linkedType: currentWhiteboardLinkType,
                    linkedId: linkedId,
                    linkedName: linkedName,
                    canvasData: null, // Will store whiteboard.js data
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                whiteboards.push(newWhiteboard);
                currentWhiteboardId = newWhiteboard.id;
                console.log('Created new whiteboard:', newWhiteboard);
            }

            // Save to localStorage
            localStorage.setItem(`whiteboards_${currentPersona}`, JSON.stringify(whiteboards));
            console.log('Saved to localStorage');

            // Close modal and reload list
            closeWhiteboardModal();
            loadWhiteboards();
        }

        function editWhiteboardById(id) {
            const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
            const whiteboards = stored ? JSON.parse(stored) : [];
            const whiteboard = whiteboards.find(wb => wb.id === id);

            if (!whiteboard) return;

            currentWhiteboardId = id;
            document.getElementById('whiteboardName').value = whiteboard.name;
            document.getElementById('whiteboardDescription').value = whiteboard.description || '';
            document.getElementById('whiteboardModalTitle').textContent = 'Edit Whiteboard';

            // Set link type
            setWhiteboardLinkType(whiteboard.linkedType || 'none');
            if (whiteboard.linkedId) {
                document.getElementById('whiteboardLinkSelect').value = whiteboard.linkedId;
            }

            document.getElementById('whiteboardModal').style.display = 'flex';
        }

        function deleteWhiteboardById(id) {
            if (!confirm('Are you sure you want to delete this whiteboard? This cannot be undone.')) {
                return;
            }

            const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
            let whiteboards = stored ? JSON.parse(stored) : [];
            whiteboards = whiteboards.filter(wb => wb.id !== id);
            localStorage.setItem(`whiteboards_${currentPersona}`, JSON.stringify(whiteboards));

            loadWhiteboards();
        }

        function openWhiteboardById(id) {
            openWhiteboardEditor(id);
        }

        function shareWhiteboardById(id) {
            const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
            const whiteboards = stored ? JSON.parse(stored) : [];
            const whiteboard = whiteboards.find(wb => wb.id === id);

            if (!whiteboard) return;

            // For now, just copy a shareable link to clipboard
            const shareUrl = `${window.location.origin}/whiteboard-viewer.html?id=${id}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('Shareable link copied to clipboard!\n\nNote: This is a demo. In production, this would generate a secure shareable link.');
            }).catch(() => {
                alert(`Share this whiteboard:\n${shareUrl}\n\nNote: This is a demo URL.`);
            });
        }

        function openWhiteboardEditor(id) {
            console.log('=== OPENING WHITEBOARD ===');
            console.log('Requested ID:', id);

            const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
            const whiteboards = stored ? JSON.parse(stored) : [];
            console.log('Total whiteboards:', whiteboards.length);
            console.log('All whiteboard IDs:', whiteboards.map(wb => ({ id: wb.id, name: wb.name })));

            const whiteboard = whiteboards.find(wb => wb.id === id);

            if (!whiteboard) {
                console.error('Whiteboard not found with ID:', id);
                return;
            }

            console.log('Found whiteboard:', whiteboard.name);
            console.log('Has canvasData:', !!whiteboard.canvasData);
            if (whiteboard.canvasData) {
                console.log('Canvas data length:', whiteboard.canvasData.length);
                console.log('First 100 chars:', whiteboard.canvasData.substring(0, 100));
            }

            currentWhiteboardId = id;

            // Update editor title
            const titleEl = document.getElementById('whiteboardEditorTitle');
            console.log('Title element:', titleEl);
            if (titleEl) {
                titleEl.textContent = whiteboard.name;
            }

            // Show editor
            const editorEl = document.getElementById('whiteboardEditor');
            console.log('Editor element:', editorEl);
            if (editorEl) {
                editorEl.style.display = 'flex';
                console.log('Editor display set to flex');
            } else {
                console.error('Editor element not found!');
            }

            // Initialize whiteboard.js
            initializeWhiteboardJS(whiteboard);
        }

        function closeWhiteboardEditor() {
            console.log('Closing whiteboard editor');

            // CRITICAL: Clear timer BEFORE nulling state variables
            // This prevents any pending auto-save from running after state is cleared
            if (excalidrawAutoSaveTimer) {
                clearTimeout(excalidrawAutoSaveTimer);
                excalidrawAutoSaveTimer = null;
            }

            // Save current whiteboard state one final time
            saveWhiteboardCanvas();

            // Clear the container completely (removes iframe from DOM)
            const container = document.getElementById('whiteboardCanvasContainer');
            if (container) {
                container.innerHTML = '';
            }

            // Clear all state variables AFTER container is cleared
            // This ensures no messages from old iframe can trigger saves
            excalidrawIframe = null;
            currentWhiteboardId = null;
            currentExcalidrawSession = null;
            currentWhiteboardTool = 'draw';
            shapeDrawing = false;
            tempShape = null;

            console.log('All whiteboard state cleared');

            // Hide editor
            const editorEl = document.getElementById('whiteboardEditor');
            if (editorEl) {
                editorEl.style.display = 'none';
            }

            // Reload whiteboards list
            console.log('Reloading whiteboards list');
            loadWhiteboards();
        }

        function editWhiteboardMetadata() {
            if (!currentWhiteboardId) return;

            // Close editor temporarily and open metadata modal
            document.getElementById('whiteboardEditor').style.display = 'none';
            editWhiteboardById(currentWhiteboardId);
        }

        function shareWhiteboard() {
            if (!currentWhiteboardId) return;
            shareWhiteboardById(currentWhiteboardId);
        }

        let excalidrawIframe = null;
        let excalidrawAutoSaveTimer = null;
        let currentExcalidrawData = null;
        let currentExcalidrawSession = null; // Track which session is active
        let isLoadingWhiteboard = false; // Flag to prevent saves during load

        // draw.io Whiteboard URL (Sketch mode optimized for tech professionals)
        const DRAWIO_WHITEBOARD_URL = 'https://embed.diagrams.net/?' + new URLSearchParams({
            embed: '1',              // Enable embed mode
            proto: 'json',           // Use JSON protocol for messages
            ui: 'sketch',            // Sketch mode - whiteboard-style interface
            sketch: '1',             // Enable sketch/rough drawing style
            dark: 'auto',            // Auto dark mode based on system preference
            spin: '1',               // Show loading spinner
            saveAndExit: '0',        // Hide "Save and Exit" button
            libraries: '1',          // Enable shape libraries
            noSaveBtn: '1',          // Hide Save button (we have autosave)
            noExitBtn: '1',          // Hide Exit button (we have Back button)
            libs: 'general;basic;arrows2;flowchart;aws4;azure;gcp2;network;cisco;uml;er;sitemap;mockups',
            grid: '1',               // Enable grid for precision
            rulers: '1',             // Show rulers
            autosave: '1'            // Enable autosave
        });

        // Get empty whiteboard XML template
        function getEmptyWhiteboardXML() {
            return `<mxGraphModel>
  <root>
    <mxCell id="0"/>
    <mxCell id="1" parent="0"/>
  </root>
</mxGraphModel>`;
        }

        function initializeWhiteboardJS(whiteboard) {
            isLoadingWhiteboard = true;
            const container = document.getElementById('whiteboardCanvasContainer');

            // Generate unique session ID for this whiteboard instance
            const sessionId = whiteboard.id + '_' + Date.now();
            currentExcalidrawSession = sessionId;

            // Clear container
            container.innerHTML = '';

            console.log('[Whiteboard] Initializing draw.io Sketch mode for:', whiteboard.id, 'session:', sessionId);

            // Create iframe for draw.io
            const iframe = document.createElement('iframe');
            iframe.id = 'drawioIframe';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.allow = 'clipboard-read; clipboard-write';
            iframe.dataset.sessionId = sessionId;
            iframe.dataset.whiteboardId = whiteboard.id; // Store whiteboard ID for validation

            // Use draw.io sketch mode
            iframe.src = DRAWIO_WHITEBOARD_URL;

            container.appendChild(iframe);
            excalidrawIframe = iframe; // Keep variable name for compatibility

            // draw.io will send 'init' event when ready, handled by message listener
            iframe.onload = () => {
                console.log('[Whiteboard] draw.io iframe loaded for session:', sessionId);
            };
        }

        // Setup postMessage listener for draw.io
        window.addEventListener('message', (event) => {
            // Only accept messages from diagrams.net
            if (!event.origin.includes('diagrams.net')) return;

            // CRITICAL: Validate message is from the CURRENT active iframe
            if (!excalidrawIframe || event.source !== excalidrawIframe.contentWindow) {
                console.log('[Whiteboard] Ignoring message from non-active iframe');
                return;
            }

            try {
                const msg = JSON.parse(event.data);
                console.log('[Whiteboard] Message received:', msg.event || msg.action);

                switch (msg.event) {
                    case 'init':
                        // draw.io is ready, send initial diagram data
                        console.log('[Whiteboard] draw.io ready (init event)');

                        // Verify this is still the active session
                        const sessionId = excalidrawIframe.dataset.sessionId;
                        if (currentExcalidrawSession !== sessionId) {
                            console.log('[Whiteboard] Session changed, aborting load for:', sessionId);
                            return;
                        }

                        // Get whiteboard data
                        const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
                        const whiteboards = stored ? JSON.parse(stored) : [];
                        const whiteboard = whiteboards.find(wb => wb.id === currentWhiteboardId);

                        let xmlData = getEmptyWhiteboardXML();

                        // Load saved XML data if exists
                        if (whiteboard && whiteboard.canvasData) {
                            try {
                                // Check if it's old Excalidraw JSON or new draw.io XML
                                if (whiteboard.canvasData.trim().startsWith('{')) {
                                    console.log('[Whiteboard] Old Excalidraw data detected, starting fresh');
                                    xmlData = getEmptyWhiteboardXML();
                                } else {
                                    xmlData = whiteboard.canvasData;
                                    console.log('[Whiteboard] Loading saved XML data');
                                }
                            } catch (e) {
                                console.error('[Whiteboard] Error parsing saved data:', e);
                            }
                        } else {
                            console.log('[Whiteboard] No saved data, starting with blank canvas');
                        }

                        // Send load message to draw.io
                        excalidrawIframe.contentWindow.postMessage(JSON.stringify({
                            action: 'load',
                            xml: xmlData,
                            autosave: 1,
                            modified: 0
                        }), '*');

                        isLoadingWhiteboard = false;
                        console.log('[Whiteboard] Scene data sent to draw.io');
                        break;

                    case 'load':
                        // Diagram loaded successfully
                        console.log('[Whiteboard] Diagram loaded, size:', msg.width, 'x', msg.height);
                        break;

                    case 'autosave':
                        // Auto-save triggered by draw.io
                        console.log('[Whiteboard] Auto-save triggered');
                        if (msg.xml && currentWhiteboardId && !isLoadingWhiteboard) {
                            saveDrawioWhiteboard(msg.xml);
                        }
                        break;

                    case 'save':
                        // User clicked Save button (shouldn't happen with noSaveBtn=1)
                        console.log('[Whiteboard] Save button clicked');
                        if (msg.xml && currentWhiteboardId) {
                            saveDrawioWhiteboard(msg.xml);
                        }
                        break;

                    case 'exit':
                        // User requested exit
                        console.log('[Whiteboard] Exit requested');
                        closeWhiteboardEditor();
                        break;

                    default:
                        console.log('[Whiteboard] Unhandled event:', msg.event);
                }
            } catch (error) {
                console.error('[Whiteboard] Error handling message:', error);
            }
        });

        // Save whiteboard XML silently (called by autosave)
        function saveDrawioWhiteboard(xmlData) {
            console.log('=== SAVING WHITEBOARD ===');
            console.log('[Whiteboard] ID:', currentWhiteboardId);

            if (!currentWhiteboardId) {
                console.warn('[Whiteboard] No whiteboard ID to save');
                return;
            }

            if (!xmlData) {
                console.warn('[Whiteboard] No XML data to save');
                return;
            }

            try {
                const stored = localStorage.getItem(`whiteboards_${currentPersona}`);
                let whiteboards = stored ? JSON.parse(stored) : [];
                console.log('[Whiteboard] Total whiteboards in storage:', whiteboards.length);

                const index = whiteboards.findIndex(wb => wb.id === currentWhiteboardId);
                console.log('[Whiteboard] Index:', index);

                if (index === -1) {
                    console.warn('[Whiteboard] Not found in localStorage with ID:', currentWhiteboardId);
                    return;
                }

                console.log('[Whiteboard] Found to update:', {
                    id: whiteboards[index].id,
                    name: whiteboards[index].name,
                    oldDataLength: whiteboards[index].canvasData ? whiteboards[index].canvasData.length : 0
                });

                // Save whiteboard XML
                console.log('[Whiteboard] New data length:', xmlData.length);
                console.log('[Whiteboard] Data preview:', xmlData.substring(0, 100));

                whiteboards[index].canvasData = xmlData;
                whiteboards[index].lastModified = new Date().toISOString();

                localStorage.setItem(`whiteboards_${currentPersona}`, JSON.stringify(whiteboards));
                console.log('[Whiteboard] ✅ Saved successfully to localStorage');
            } catch (error) {
                console.error('[Whiteboard] ❌ Error saving:', error);
                console.error('[Whiteboard] Error stack:', error.stack);
            }
        }

        function saveExcalidrawScene() {
            // No longer needed - draw.io autosaves automatically
            // Keep for compatibility but make it a no-op
            console.log('[Whiteboard] saveExcalidrawScene() called - using draw.io autosave instead');
        }

        function saveWhiteboardCanvas() {
            // draw.io autosaves, but we can rely on that
            // This function kept for compatibility
            console.log('[Whiteboard] saveWhiteboardCanvas() called - relying on draw.io autosave');
        }

        function clearWhiteboardCanvas() {
            if (!excalidrawIframe) return;

            if (confirm('Are you sure you want to clear the entire canvas? This cannot be undone.')) {
                // Send empty XML to draw.io
                excalidrawIframe.contentWindow.postMessage(JSON.stringify({
                    action: 'load',
                    xml: getEmptyWhiteboardXML(),
                    autosave: 1,
                    modified: 0
                }), '*');

                console.log('[Whiteboard] Canvas cleared');
            }
        }

        // ========================================
        // Job Opportunities Functions
        // ========================================

        function openJobOpportunitiesSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');
                const jobOpportunitiesContent = document.getElementById('jobOpportunitiesContent');

                titleEl.textContent = 'Job Opportunities';

                // Hide all content sections
                hideAllContentSections();

                // Show job opportunities content
                jobOpportunitiesContent.style.display = 'flex';

                // Load job opportunities for current persona
                loadJobOpportunities();
            });
        }

        // Enhanced job opportunities with skills and competencies
        const exampleJobOpportunities = {
            'retail-manager': [
                { title: 'Operations Manager', company: 'Amazon', location: 'Seattle', salary: '$125K', status: 'interested', skills: ['Excel', 'Data Analysis', 'Process Optimization'], competencies: ['Leadership', 'Operations Management', 'Problem Solving'], isExample: true },
                { title: 'Business Analyst', company: 'Target HQ', location: 'Minneapolis', salary: '$95K', status: 'interested', skills: ['Excel', 'Power BI', 'SQL'], competencies: ['Data Analysis', 'Business Intelligence', 'Communication'], isExample: true },
                { title: 'Data Analyst', company: 'Walmart eCommerce', location: 'Bentonville', salary: '$85K', status: 'interested', skills: ['SQL', 'Python', 'Tableau'], competencies: ['Analytics', 'Critical Thinking', 'Collaboration'], isExample: true },
                { title: 'Supply Chain Analyst', company: 'Nike', location: 'Portland', salary: '$90K', status: 'interested', skills: ['Excel', 'Supply Chain Software', 'Data Visualization'], competencies: ['Logistics', 'Process Improvement', 'Stakeholder Management'], isExample: true },
                { title: 'Ops Coordinator', company: 'Instacart', location: 'San Francisco', salary: '$80K', status: 'interested', skills: ['Project Management', 'Excel', 'Communication'], competencies: ['Organization', 'Multitasking', 'Adaptability'], isExample: true }
            ],
            'chemist': [
                { title: 'Sr Data Scientist', company: 'Pfizer R&D', location: 'Cambridge', salary: '$165K', status: 'interested', skills: ['Python', 'Machine Learning', 'R', 'SQL'], competencies: ['Statistical Analysis', 'Research', 'Scientific Communication'], isExample: true },
                { title: 'Computational Chemist', company: 'Moderna', location: 'Boston', salary: '$155K', status: 'interested', skills: ['Python', 'Molecular Modeling', 'Linux', 'HPC'], competencies: ['Computational Chemistry', 'Problem Solving', 'Collaboration'], isExample: true },
                { title: 'ML Engineer', company: 'Genentech', location: 'South SF', salary: '$180K', status: 'interested', skills: ['Python', 'TensorFlow', 'PyTorch', 'AWS'], competencies: ['Machine Learning', 'Software Engineering', 'Agile Development'], isExample: true },
                { title: 'Bioinformatics Scientist', company: 'Illumina', location: 'San Diego', salary: '$145K', status: 'interested', skills: ['Python', 'R', 'NGS Analysis', 'Bioinformatics Tools'], competencies: ['Genomics', 'Data Analysis', 'Cross-functional Collaboration'], isExample: true },
                { title: 'Research Scientist', company: 'Merck', location: 'Rahway, NJ', salary: '$140K', status: 'interested', skills: ['Python', 'HPLC', 'Spectroscopy', 'R'], competencies: ['Analytical Chemistry', 'Experimental Design', 'Technical Writing'], isExample: true }
            ],
            'new-graduate': [
                { title: 'Junior Full Stack Developer', company: 'StartupCo', location: 'Austin', salary: '$85K', status: 'applied', skills: ['React', 'Node.js', 'JavaScript', 'Git'], competencies: ['Full Stack Development', 'Problem Solving', 'Learning Agility'], isExample: true },
                { title: 'Software Engineer I', company: 'Microsoft', location: 'Redmond', salary: '$120K', status: 'interested', skills: ['C#', '.NET', 'Azure', 'SQL'], competencies: ['Software Development', 'Collaboration', 'Technical Communication'], isExample: true },
                { title: 'Frontend Developer', company: 'Shopify', location: 'Remote', salary: '$95K', status: 'interested', skills: ['React', 'TypeScript', 'CSS', 'Redux'], competencies: ['UI Development', 'Responsive Design', 'User Experience'], isExample: true },
                { title: 'Backend Engineer', company: 'Stripe', location: 'San Francisco', salary: '$130K', status: 'interested', skills: ['Python', 'PostgreSQL', 'REST APIs', 'Docker'], competencies: ['API Development', 'System Design', 'Testing'], isExample: true },
                { title: 'Web Developer', company: 'HubSpot', location: 'Boston', salary: '$90K', status: 'interested', skills: ['JavaScript', 'React', 'Node.js', 'MongoDB'], competencies: ['Web Development', 'Agile', 'Communication'], isExample: true }
            ],
            'data-analyst': [
                { title: 'Senior Data Analyst', company: 'DataCorp', location: 'New York', salary: '$125K', status: 'interviewing', skills: ['SQL', 'Python', 'Tableau', 'Excel'], competencies: ['Data Analysis', 'Business Intelligence', 'Stakeholder Management'], isExample: true },
                { title: 'BI Analyst', company: 'Salesforce', location: 'San Francisco', salary: '$115K', status: 'interested', skills: ['SQL', 'Tableau', 'Power BI', 'ETL'], competencies: ['Business Intelligence', 'Data Visualization', 'Communication'], isExample: true },
                { title: 'Analytics Engineer', company: 'Airbnb', location: 'Remote', salary: '$140K', status: 'interested', skills: ['SQL', 'Python', 'dbt', 'Looker'], competencies: ['Data Modeling', 'Analytics Engineering', 'Collaboration'], isExample: true },
                { title: 'Data Scientist', company: 'Netflix', location: 'Los Gatos', salary: '$155K', status: 'interested', skills: ['Python', 'SQL', 'Machine Learning', 'A/B Testing'], competencies: ['Statistical Analysis', 'Experimentation', 'Product Analytics'], isExample: true },
                { title: 'Product Analyst', company: 'LinkedIn', location: 'Sunnyvale', salary: '$130K', status: 'interested', skills: ['SQL', 'Python', 'Tableau', 'Excel'], competencies: ['Product Analytics', 'Metrics Definition', 'Cross-functional Collaboration'], isExample: true }
            ]
        };

        function loadJobOpportunities() {
            // Load job data
            loadUserJobs();

            // Combine user jobs with example jobs from enhanced data
            const allJobs = [...userJobs];
            const exampleJobs = exampleJobOpportunities[currentPersona] || [];
            allJobs.push(...exampleJobs);

            // Calculate active jobs count (excluding rejected and not-interested)
            const activeJobsCount = allJobs.filter(job =>
                job.status !== 'rejected' && job.status !== 'not-interested'
            ).length;

            // Update the count in the mindmap data structure
            updateJobOpportunitiesCount(activeJobsCount);

            // FIXED: Update badges only instead of full mindmap refresh
            updateBadgesOnly();

            // Load table view
            loadJobTableView(allJobs);
        }

        function loadJobTableView(allJobs) {
            const tableContainer = document.getElementById('jobsTableContainer');
            const tableBody = document.getElementById('jobsTableBody');

            tableBody.innerHTML = '';

            if (allJobs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                            <i class="ph ph-briefcase" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                            <p style="font-family: var(--font-family-ui); font-size: 15px;">No job opportunities yet. Click "Add Job" to track a new opportunity.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const statusLabels = {
                'interested': 'Interested',
                'applied': 'Applied',
                'interviewing': 'Interviewing',
                'offer': 'Offer',
                'rejected': 'Rejected',
                'not-interested': 'Not Interested'
            };

            allJobs.forEach((job, index) => {
                const isUserJob = index < userJobs.length;
                const todos = job.todos || [];

                // Find next action (first incomplete todo with earliest date)
                const nextAction = todos
                    .filter(t => !t.completed && t.date)
                    .sort((a, b) => a.date.localeCompare(b.date))[0];

                let nextActionText = 'No pending tasks';
                let nextActionDate = null;
                let nextActionStatus = 'normal';
                let alertLevel = 'none';

                if (nextAction) {
                    nextActionText = nextAction.task;
                    const actionDate = new Date(nextAction.date);
                    nextActionDate = actionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    actionDate.setHours(0, 0, 0, 0);

                    const daysUntil = Math.floor((actionDate - today) / (1000 * 60 * 60 * 24));

                    if (daysUntil < 0) {
                        nextActionStatus = 'overdue';
                        alertLevel = 'critical';
                    } else if (daysUntil <= 3) {
                        nextActionStatus = 'soon';
                        alertLevel = 'warning';
                    }
                }

                const row = document.createElement('tr');
                if (job.isExample) {
                    row.style.background = '#fafbfc';
                }

                row.innerHTML = `
                    <td>
                        <div class="job-table-position">${escapeHtml(job.title)}</div>
                        ${job.location ? `<div class="job-table-location"><i class="ph ph-map-pin"></i> ${escapeHtml(job.location)}</div>` : ''}
                    </td>
                    <td>
                        <div class="job-table-company">${escapeHtml(job.company)}</div>
                        ${job.isExample ? '<div style="font-size: 10px; color: #999; margin-top: 2px;">Example</div>' : ''}
                    </td>
                    <td style="text-align: center;">
                        ${job.url ? `<a href="${escapeHtml(job.url)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();" title="View job posting" style="color: var(--color-primary-blue); font-size: 16px; text-decoration: none;"><i class="ph ph-link"></i></a>` : '<span style="color: var(--color-neutral-text-light); font-size: 16px;"><i class="ph ph-minus"></i></span>'}
                    </td>
                    <td>
                        <span class="job-table-status job-status ${job.status}">${statusLabels[job.status]}</span>
                    </td>
                    <td>
                        ${job.closeDate ? `
                            <div style="font-size: 12px; font-weight: 500; color: var(--color-dark);">
                                ${new Date(job.closeDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                        ` : `
                            <div style="font-size: 12px; color: var(--color-neutral-text-light); font-style: italic;">
                                No date set
                            </div>
                        `}
                    </td>
                    <td>
                        <div class="job-table-next-action">
                            <div class="job-table-next-action-task">${nextActionText}</div>
                            ${nextActionDate ? `<div class="job-table-next-action-date ${nextActionStatus}">
                                <i class="ph ph-calendar"></i> ${nextActionDate}
                            </div>` : ''}
                        </div>
                    </td>
                    <td class="job-table-alerts">
                        <div class="job-alert-indicator ${alertLevel}">
                            ${alertLevel === 'critical' ? '<i class="ph ph-warning-circle" style="font-size: 16px;"></i>' : alertLevel === 'warning' ? '<i class="ph ph-warning" style="font-size: 16px;"></i>' : ''}
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="job-table-action-btn delete" ${isUserJob ? `onclick="deleteJob(${index})" title="Delete" style="background: none; border: none; color: var(--color-neutral-text); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;"` : `onclick="showDemoDeleteToast()" title="Cannot delete example jobs" style="background: none; border: none; color: var(--color-neutral-text-light); cursor: not-allowed; padding: 4px; border-radius: 4px; opacity: 0.5;"`}>
                                <i class="ph ph-trash" style="font-size: 14px;"></i>
                            </button>
                        </div>
                    </td>
                `;

                // Add click handler to open job detail modal
                row.addEventListener('click', (e) => {
                    // Don't trigger modal if clicking on action buttons
                    if (e.target.closest('.job-table-action-btn')) return;
                    openJobDetail(index, allJobs);
                });

                tableBody.appendChild(row);
            });
        }

        function getJobNextAction(nextAction) {
            if (!nextAction) {
                return {
                    nextActionText: 'No pending tasks',
                    nextActionDate: null,
                    nextActionStatus: 'normal',
                    alertLevel: 'none'
                };
            }

            const today = new Date();
            const due = nextAction.dueDate ? new Date(nextAction.dueDate) : null;

            let nextActionDate = null;
            let nextActionStatus = 'normal';
            let alertLevel = 'normal';

            if (due) {
                const diffTime = due - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    nextActionStatus = 'overdue';
                    alertLevel = 'overdue';
                    nextActionDate = `${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''} overdue`;
                } else if (diffDays === 0) {
                    nextActionStatus = 'due-soon';
                    alertLevel = 'due-soon';
                    nextActionDate = 'Due today';
                } else if (diffDays === 1) {
                    nextActionStatus = 'due-soon';
                    alertLevel = 'due-soon';
                    nextActionDate = 'Due tomorrow';
                } else if (diffDays <= 3) {
                    nextActionStatus = 'due-soon';
                    alertLevel = 'due-soon';
                    nextActionDate = `Due in ${diffDays} days`;
                } else if (diffDays <= 7) {
                    nextActionDate = `Due in ${diffDays} days`;
                } else {
                    nextActionDate = due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            }

            return {
                nextActionText: nextAction.text.length > 40 ? nextAction.text.substring(0, 37) + '...' : nextAction.text,
                nextActionDate,
                nextActionStatus,
                alertLevel
            };
        }

        function getAlertContent(alertLevel, todos) {
            const overdueTasks = todos.filter(todo => {
                if (todo.completed || !todo.dueDate) return false;
                const today = new Date();
                const due = new Date(todo.dueDate);
                return due < today;
            }).length;

            const dueSoonTasks = todos.filter(todo => {
                if (todo.completed || !todo.dueDate) return false;
                const today = new Date();
                const due = new Date(todo.dueDate);
                const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 3;
            }).length;

            switch (alertLevel) {
                case 'overdue':
                    return overdueTasks.toString();
                case 'due-soon':
                    return dueSoonTasks.toString();
                case 'normal':
                    return todos.filter(t => !t.completed).length.toString();
                default:
                    return '0';
            }
        }

        function getAlertTooltip(alertLevel, nextAction) {
            switch (alertLevel) {
                case 'overdue':
                    return `Overdue task: ${nextAction?.text || 'Unknown task'}`;
                case 'due-soon':
                    return `Due soon: ${nextAction?.text || 'Unknown task'}`;
                case 'normal':
                    return 'Active tasks';
                default:
                    return 'No pending tasks';
            }
        }

        // Job Opportunities Management
        let userJobs = [];
        let editingJobIndex = -1;

        function loadUserJobs() {
            const stored = localStorage.getItem('jobOpportunities_' + currentPersona);
            if (stored) {
                try {
                    userJobs = JSON.parse(stored);
                } catch (e) {
                    userJobs = [];
                }
            } else {
                userJobs = [];
            }
        }

        function saveUserJobs() {
            localStorage.setItem('jobOpportunities_' + currentPersona, JSON.stringify(userJobs));
        }

        // Job To-Do List Management
        let currentJobTodos = [];

        function addJobOpportunity() {
            editingJobIndex = -1;
            currentJobTodos = [];
            document.getElementById('jobFormTitle').textContent = 'Add Job Opportunity';
            document.getElementById('jobForm').reset();
            renderJobTodoList();
            document.getElementById('jobFormModal').style.display = 'flex';
        }

        function closeJobForm() {
            document.getElementById('jobFormModal').style.display = 'none';
            document.getElementById('jobForm').reset();
            currentJobTodos = [];
            editingJobIndex = -1;
        }

        function addJobTodo() {
            const taskInput = document.getElementById('todoTaskInput');
            const dateInput = document.getElementById('todoDateInput');

            const task = taskInput.value.trim();
            const date = dateInput.value;

            if (!task) {
                alert('Please enter a task description');
                return;
            }

            currentJobTodos.push({
                id: Date.now(),
                task: task,
                date: date,
                completed: false
            });

            taskInput.value = '';
            dateInput.value = '';
            renderJobTodoList();
        }

        function toggleJobTodo(index) {
            if (index >= 0 && index < currentJobTodos.length) {
                currentJobTodos[index].completed = !currentJobTodos[index].completed;
                renderJobTodoList();
            }
        }

        function deleteJobTodo(index) {
            if (index >= 0 && index < currentJobTodos.length) {
                currentJobTodos.splice(index, 1);
                renderJobTodoList();
            }
        }

        function renderJobTodoList() {
            const container = document.getElementById('jobTodoList');

            if (currentJobTodos.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--color-neutral-text-light); font-size: 12px;">No action items yet. Add one above.</div>';
                return;
            }

            // Sort by date (nulls last), then by completed status
            const sortedTodos = [...currentJobTodos].sort((a, b) => {
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                if (!a.date && b.date) return 1;
                if (a.date && !b.date) return -1;
                if (a.date && b.date) return a.date.localeCompare(b.date);
                return 0;
            });

            container.innerHTML = sortedTodos.map((todo, index) => {
                const originalIndex = currentJobTodos.findIndex(t => t.id === todo.id);
                const dateStr = todo.date ? new Date(todo.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'No date';
                const isOverdue = todo.date && !todo.completed && new Date(todo.date) < new Date();

                return `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: ${todo.completed ? '#f5f5f7' : 'white'}; border: 1px solid var(--color-neutral-border); border-radius: 6px; ${todo.completed ? 'opacity: 0.6;' : ''}">
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleJobTodo(${originalIndex})" style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); ${todo.completed ? 'text-decoration: line-through;' : ''}">${escapeHtml(todo.task)}</div>
                            <div style="font-family: var(--font-family-ui); font-size: 11px; color: ${isOverdue ? '#dc2626' : 'var(--color-neutral-text)'};  font-weight: ${isOverdue ? '600' : '400'};">
                                <i class="ph ${isOverdue ? 'ph-warning' : 'ph-calendar-blank'}"></i> ${dateStr}
                            </div>
                        </div>
                        <button type="button" onclick="deleteJobTodo(${originalIndex})" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; font-size: 14px; color: var(--color-neutral-text); flex-shrink: 0;" title="Delete">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function getNextActionDate(todos) {
            if (!todos || todos.length === 0) return null;

            // Find the earliest incomplete todo with a date
            const incompleteTodos = todos.filter(t => !t.completed && t.date);
            if (incompleteTodos.length === 0) return null;

            incompleteTodos.sort((a, b) => a.date.localeCompare(b.date));
            return incompleteTodos[0].date;
        }

        function saveJob(event) {
            event.preventDefault();

            const nextActionDate = getNextActionDate(currentJobTodos);

            const job = {
                title: document.getElementById('jobTitle').value,
                company: document.getElementById('jobCompany').value,
                location: document.getElementById('jobLocation').value,
                salary: document.getElementById('jobSalary').value,
                status: document.getElementById('jobStatus').value,
                closeDate: document.getElementById('jobCloseDate').value,
                notes: document.getElementById('jobNotes').value,
                url: document.getElementById('jobUrl').value,
                todos: currentJobTodos,
                nextActionDate: nextActionDate
            };

            if (editingJobIndex >= 0) {
                userJobs[editingJobIndex] = job;
            } else {
                userJobs.push(job);
            }

            saveUserJobs();
            closeJobForm();
            loadJobOpportunities();
            updateBadgesOnly();
        }

        function editJob(index) {
            const job = userJobs[index];
            editingJobIndex = index;

            document.getElementById('jobFormTitle').textContent = 'Edit Job Opportunity';
            document.getElementById('jobTitle').value = job.title;
            document.getElementById('jobCompany').value = job.company;
            document.getElementById('jobLocation').value = job.location || '';
            document.getElementById('jobSalary').value = job.salary || '';
            document.getElementById('jobStatus').value = job.status || 'interested';
            document.getElementById('jobCloseDate').value = job.closeDate || '';
            document.getElementById('jobNotes').value = job.notes || '';
            document.getElementById('jobUrl').value = job.url || '';

            // Load todos
            currentJobTodos = job.todos || [];
            renderJobTodoList();

            document.getElementById('jobFormModal').style.display = 'flex';
        }

        function deleteJob(index) {
            if (confirm('Are you sure you want to delete this job opportunity?')) {
                userJobs.splice(index, 1);
                saveUserJobs();
                loadJobOpportunities();
                updateBadgesOnly();
            }
        }

        function showDemoDeleteToast() {
            showToast('Cannot delete example jobs. Try creating your own job opportunity!', 'info');
        }

        // Job Detail Modal Functions
        let currentJobDetail = null;
        let currentJobIndex = -1;
        let currentJobArray = null;

        function openJobDetail(jobIndex, jobArray) {
            currentJobIndex = jobIndex;
            currentJobArray = jobArray;
            currentJobDetail = jobArray[jobIndex];

            const modal = document.getElementById('jobDetailModal');
            populateJobDetailModal(currentJobDetail, jobIndex);
            modal.classList.add('active');
        }

        function closeJobDetail() {
            const modal = document.getElementById('jobDetailModal');
            modal.classList.remove('active');
            currentJobDetail = null;
            currentJobIndex = -1;
            currentJobArray = null;
        }

        function populateJobDetailModal(job, jobIndex) {
            // Set the title
            document.getElementById('jobDetailTitle').textContent = `${job.title} at ${job.company}`;

            // Set the status
            const statusSelect = document.getElementById('jobDetailStatus');
            statusSelect.value = job.status || 'interested';

            // Set the close date
            const closeDateInput = document.getElementById('jobDetailCloseDate');
            closeDateInput.value = job.closeDate || '';

            // Populate job info in view mode
            renderJobInfoView(job);

            // Populate todo checklist
            populateJobTodos(job);

            // Populate attached prompts
            populateJobApplicationMaterials(job);

            // Populate skills and competencies
            populateJobSkills(job.skills || []);
            populateJobCompetencies(job.competencies || []);

            // Fit Analysis - Coming Soon
            const fitScoreCircle = document.getElementById('fitScoreCircle');
            const fitDimensions = document.getElementById('fitDimensions');
            fitScoreCircle.textContent = '?';
            fitScoreCircle.style.backgroundColor = '#e5e5e7';
            fitScoreCircle.nextElementSibling.querySelector('p').textContent = 'Coming Soon';
            fitDimensions.innerHTML = `
                <div style="padding: 20px; text-align: center; background: #f8f9fa; border-radius: 8px; border: 2px dashed var(--color-neutral-border);">
                    <i class="ph ph-target" style="font-size: 32px; color: #ccc; display: block; margin-bottom: 8px;"></i>
                    <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 0;">Analyze how well your skills and experience match this opportunity's requirements.</p>
                </div>
            `;
        }

        function renderJobInfoView(job) {
            const jobDetailInfo = document.getElementById('jobDetailInfo');
            jobDetailInfo.innerHTML = `
                <div>
                    <strong style="color: var(--color-dark);">Job Title:</strong><br>
                    <span id="viewJobTitle">${job.title ? escapeHtml(job.title) : 'Not specified'}</span>
                </div>
                <div>
                    <strong style="color: var(--color-dark);">Company:</strong><br>
                    <span id="viewJobCompany">${job.company ? escapeHtml(job.company) : 'Not specified'}</span>
                </div>
                <div>
                    <strong style="color: var(--color-dark);">Location:</strong><br>
                    <span id="viewJobLocation">${job.location ? escapeHtml(job.location) : 'Not specified'}</span>
                </div>
                <div>
                    <strong style="color: var(--color-dark);">Salary:</strong><br>
                    <span id="viewJobSalary">${job.salary ? escapeHtml(job.salary) : 'Not specified'}</span>
                </div>
                <div style="grid-column: 1 / -1;">
                    <strong style="color: var(--color-dark);">URL:</strong><br>
                    ${job.url ? `<a href="${escapeHtml(job.url)}" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary-blue); text-decoration: none;"><i class="ph ph-link"></i> View Posting</a>` : '<span>Not specified</span>'}
                    <span id="viewJobUrl" style="display: none;">${job.url || ''}</span>
                </div>
                <div style="grid-column: 1 / -1;">
                    <strong style="color: var(--color-dark);">Notes:</strong><br>
                    <span id="viewJobNotes" style="white-space: pre-wrap;">${job.notes ? escapeHtml(job.notes) : 'No notes added'}</span>
                </div>
                <div style="grid-column: 1 / -1; margin-top: 8px;">
                    <button onclick="toggleJobInfoEdit()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;" onmouseover="this.style.background='var(--color-accent-blue)'" onmouseout="this.style.background='var(--color-primary-blue)'">
                        <i class="ph ph-pencil-simple"></i> Edit Job Details
                    </button>
                </div>
            `;
        }

        function renderJobInfoEdit(job) {
            const jobDetailInfo = document.getElementById('jobDetailInfo');
            jobDetailInfo.innerHTML = `
                <div>
                    <label for="editJobTitle" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 4px;">Job Title:</label>
                    <input type="text" id="editJobTitle" value="${job.title ? escapeHtml(job.title) : ''}" style="width: 100%; border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 8px; font-size: 13px;">
                </div>
                <div>
                    <label for="editJobCompany" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 4px;">Company:</label>
                    <input type="text" id="editJobCompany" value="${job.company ? escapeHtml(job.company) : ''}" style="width: 100%; border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 8px; font-size: 13px;">
                </div>
                <div>
                    <label for="editJobLocation" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 4px;">Location:</label>
                    <input type="text" id="editJobLocation" value="${job.location ? escapeHtml(job.location) : ''}" style="width: 100%; border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 8px; font-size: 13px;">
                </div>
                <div>
                    <label for="editJobSalary" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 4px;">Salary:</label>
                    <input type="text" id="editJobSalary" value="${job.salary ? escapeHtml(job.salary) : ''}" style="width: 100%; border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 8px; font-size: 13px;">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label for="editJobUrl" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 4px;">URL:</label>
                    <input type="url" id="editJobUrl" value="${job.url ? escapeHtml(job.url) : ''}" style="width: 100%; border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 8px; font-size: 13px;">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label for="editJobNotes" style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); display: block; margin-bottom: 4px;">Notes:</label>
                    <textarea id="editJobNotes" rows="4" style="width: 100%; border: 1px solid var(--color-neutral-border); border-radius: 6px; padding: 8px; font-size: 13px; font-family: var(--font-family-body); resize: vertical;">${job.notes ? escapeHtml(job.notes) : ''}</textarea>
                </div>
                <div style="grid-column: 1 / -1; margin-top: 8px; display: flex; gap: 8px;">
                    <button onclick="saveJobInfoEdit()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;" onmouseover="this.style.background='var(--color-accent-blue)'" onmouseout="this.style.background='var(--color-primary-blue)'">
                        <i class="ph ph-check"></i> Save Changes
                    </button>
                    <button onclick="cancelJobInfoEdit()" style="padding: 8px 16px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                        <i class="ph ph-x"></i> Cancel
                    </button>
                </div>
            `;
        }

        function toggleJobInfoEdit() {
            if (!currentJobDetail) return;
            renderJobInfoEdit(currentJobDetail);
        }

        function cancelJobInfoEdit() {
            if (!currentJobDetail) return;
            renderJobInfoView(currentJobDetail);
        }

        function saveJobInfoEdit() {
            if (!currentJobDetail || currentJobIndex === -1 || !currentJobArray) return;

            // Get the edited values
            const newTitle = document.getElementById('editJobTitle').value.trim();
            const newCompany = document.getElementById('editJobCompany').value.trim();
            const newLocation = document.getElementById('editJobLocation').value.trim();
            const newSalary = document.getElementById('editJobSalary').value.trim();
            const newUrl = document.getElementById('editJobUrl').value.trim();
            const newNotes = document.getElementById('editJobNotes').value.trim();

            // Update the job object
            currentJobDetail.title = newTitle || 'Untitled Position';
            currentJobDetail.company = newCompany;
            currentJobDetail.location = newLocation;
            currentJobDetail.salary = newSalary;
            currentJobDetail.url = newUrl;
            currentJobDetail.notes = newNotes;

            // Update the array
            currentJobArray[currentJobIndex] = currentJobDetail;

            // Save to localStorage
            localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(currentJobArray));

            // Update the modal title
            document.getElementById('jobDetailTitle').textContent = `${currentJobDetail.title} at ${currentJobDetail.company}`;

            // Refresh the view
            renderJobInfoView(currentJobDetail);

            // Reload the job opportunities table to reflect changes
            loadJobOpportunities();
        }

        function populateJobSkills(skills) {
            const container = document.getElementById('jobDetailSkills');
            if (skills.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic; text-align: center;">No required skills specified</p>';
                return;
            }

            container.innerHTML = skills.map(skill => `
                <div class="skill-comp-item">
                    <span style="font-size: 13px; font-weight: 500;">${escapeHtml(skill)}</span>
                    <button onclick="removeJobSkill('${escapeHtml(skill)}')" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 16px;" title="Remove skill">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
            `).join('');
        }

        function populateJobCompetencies(competencies) {
            const container = document.getElementById('jobDetailCompetencies');
            if (competencies.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic; text-align: center;">No key competencies specified</p>';
                return;
            }

            container.innerHTML = competencies.map(comp => `
                <div class="skill-comp-item">
                    <span style="font-size: 13px; font-weight: 500;">${escapeHtml(comp)}</span>
                    <button onclick="removeJobCompetency('${escapeHtml(comp)}')" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 16px;" title="Remove competency">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
            `).join('');
        }

        function updateJobStatus() {
            if (!currentJobDetail || currentJobIndex < 0) return;

            const newStatus = document.getElementById('jobDetailStatus').value;
            currentJobDetail.status = newStatus;

            // Update in the appropriate array (user jobs vs example jobs)
            if (currentJobIndex < userJobs.length) {
                userJobs[currentJobIndex].status = newStatus;
                saveUserJobs();
            }

            // Reload the job opportunities display
            loadJobOpportunities();
        }

        function updateJobCloseDate() {
            if (!currentJobDetail || currentJobIndex < 0) return;

            const newCloseDate = document.getElementById('jobDetailCloseDate').value;
            currentJobDetail.closeDate = newCloseDate;

            // Update in the appropriate array (user jobs vs example jobs)
            if (currentJobIndex < userJobs.length) {
                userJobs[currentJobIndex].closeDate = newCloseDate;
                saveUserJobs();
            }

            // Reload the job opportunities display to show updated close date
            loadJobOpportunities();
        }

        function addJobSkill() {
            const skill = prompt('Enter a required skill:');
            if (!skill || !currentJobDetail) return;

            if (!currentJobDetail.skills) currentJobDetail.skills = [];
            if (currentJobDetail.skills.includes(skill.trim())) {
                alert('This skill is already listed!');
                return;
            }

            currentJobDetail.skills.push(skill.trim());

            // Update in the appropriate array if it's a user job
            if (currentJobIndex < userJobs.length) {
                if (!userJobs[currentJobIndex].skills) userJobs[currentJobIndex].skills = [];
                userJobs[currentJobIndex].skills.push(skill.trim());
                saveUserJobs();
            }

            populateJobSkills(currentJobDetail.skills);
            loadJobOpportunities();
        }

        function addJobCompetency() {
            const competency = prompt('Enter a key competency:');
            if (!competency || !currentJobDetail) return;

            if (!currentJobDetail.competencies) currentJobDetail.competencies = [];
            if (currentJobDetail.competencies.includes(competency.trim())) {
                alert('This competency is already listed!');
                return;
            }

            currentJobDetail.competencies.push(competency.trim());

            // Update in the appropriate array if it's a user job
            if (currentJobIndex < userJobs.length) {
                if (!userJobs[currentJobIndex].competencies) userJobs[currentJobIndex].competencies = [];
                userJobs[currentJobIndex].competencies.push(competency.trim());
                saveUserJobs();
            }

            populateJobCompetencies(currentJobDetail.competencies);
            loadJobOpportunities();
        }

        function removeJobSkill(skill) {
            if (!currentJobDetail || !currentJobDetail.skills) return;

            currentJobDetail.skills = currentJobDetail.skills.filter(s => s !== skill);

            // Update in the appropriate array if it's a user job
            if (currentJobIndex < userJobs.length && userJobs[currentJobIndex].skills) {
                userJobs[currentJobIndex].skills = userJobs[currentJobIndex].skills.filter(s => s !== skill);
                saveUserJobs();
            }

            populateJobSkills(currentJobDetail.skills);
            loadJobOpportunities();
        }

        function removeJobCompetency(competency) {
            if (!currentJobDetail || !currentJobDetail.competencies) return;

            currentJobDetail.competencies = currentJobDetail.competencies.filter(c => c !== competency);

            // Update in the appropriate array if it's a user job
            if (currentJobIndex < userJobs.length && userJobs[currentJobIndex].competencies) {
                userJobs[currentJobIndex].competencies = userJobs[currentJobIndex].competencies.filter(c => c !== competency);
                saveUserJobs();
            }

            populateJobCompetencies(currentJobDetail.competencies);
            loadJobOpportunities();
        }

        function calculateJobFit(job) {
            // Load user skills and competencies
            loadUserSkillsCompetencies();

            const jobSkills = job.skills || [];
            const jobCompetencies = job.competencies || [];

            // Get user's skills and competencies
            const userSkills = userSkillsCompetencies.filter(item => item.type === 'skill');
            const userComps = userSkillsCompetencies.filter(item => item.type === 'competency');

            // Calculate fit dimensions
            const dimensions = [];

            // Skills Match
            const skillsMatch = calculateMatchScore(jobSkills, userSkills.map(s => s.name));
            dimensions.push({
                name: 'Skills Match',
                score: skillsMatch.percentage,
                details: `${skillsMatch.matches} of ${jobSkills.length} required skills match`,
                color: getScoreColor(skillsMatch.percentage)
            });

            // Competencies Match
            const compMatch = calculateMatchScore(jobCompetencies, userComps.map(c => c.name));
            dimensions.push({
                name: 'Competencies Match',
                score: compMatch.percentage,
                details: `${compMatch.matches} of ${jobCompetencies.length} key competencies match`,
                color: getScoreColor(compMatch.percentage)
            });

            // Experience Level (based on user's skill levels)
            const avgUserLevel = userSkills.length > 0
                ? userSkills.reduce((sum, skill) => sum + (skill.currentLevel || 1), 0) / userSkills.length
                : 1;
            const experienceScore = Math.min(100, (avgUserLevel / 4) * 100);
            dimensions.push({
                name: 'Experience Level',
                score: experienceScore,
                details: `Average skill level: ${avgUserLevel.toFixed(1)}/4`,
                color: getScoreColor(experienceScore)
            });

            // Career Stage Alignment (based on job status and user profile)
            const careerScore = getCareerAlignmentScore(job, currentPersona);
            dimensions.push({
                name: 'Career Stage Fit',
                score: careerScore,
                details: getCareerAlignmentDetails(job, currentPersona),
                color: getScoreColor(careerScore)
            });

            // Calculate overall score (weighted average)
            const overallScore = Math.round(
                (skillsMatch.percentage * 0.4) +
                (compMatch.percentage * 0.3) +
                (experienceScore * 0.2) +
                (careerScore * 0.1)
            );

            // Display the results
            displayJobFitResults(overallScore, dimensions);
        }

        function calculateMatchScore(required, userHas) {
            if (required.length === 0) return { percentage: 100, matches: 0 };

            const matches = required.filter(req =>
                userHas.some(user => user.toLowerCase().includes(req.toLowerCase()) || req.toLowerCase().includes(user.toLowerCase()))
            ).length;

            return {
                percentage: Math.round((matches / required.length) * 100),
                matches: matches
            };
        }

        function getScoreColor(score) {
            if (score >= 80) return '#388e3c'; // Green
            if (score >= 60) return '#f57c00'; // Orange
            if (score >= 40) return '#ff9800'; // Amber
            return '#d32f2f'; // Red
        }

        function getCareerAlignmentScore(job, persona) {
            // Simple heuristic based on persona and job characteristics
            const baseScore = 75;

            // Adjust based on persona-specific factors
            switch (persona) {
                case 'new-graduate':
                    return job.title.toLowerCase().includes('junior') || job.title.toLowerCase().includes('entry') ? 90 : 60;
                case 'data-analyst':
                    return job.title.toLowerCase().includes('analyst') || job.title.toLowerCase().includes('data') ? 90 : 70;
                case 'retail-manager':
                    return job.title.toLowerCase().includes('manager') || job.title.toLowerCase().includes('operations') ? 90 : 65;
                case 'chemist':
                    return job.title.toLowerCase().includes('scientist') || job.title.toLowerCase().includes('research') ? 90 : 55;
                default:
                    return baseScore;
            }
        }

        function getCareerAlignmentDetails(job, persona) {
            switch (persona) {
                case 'new-graduate':
                    return 'Entry-level position analysis';
                case 'data-analyst':
                    return 'Data/analytics role alignment';
                case 'retail-manager':
                    return 'Management/operations alignment';
                case 'chemist':
                    return 'Scientific role alignment';
                default:
                    return 'General career fit assessment';
            }
        }

        function displayJobFitResults(overallScore, dimensions) {
            // Update overall score
            const scoreCircle = document.getElementById('fitScoreCircle');
            scoreCircle.textContent = `${overallScore}%`;
            scoreCircle.style.backgroundColor = getScoreColor(overallScore);

            const scoreDetails = scoreCircle.nextElementSibling;
            let scoreDescription;
            if (overallScore >= 80) scoreDescription = 'Excellent match based on your profile';
            else if (overallScore >= 60) scoreDescription = 'Good match with some development opportunities';
            else if (overallScore >= 40) scoreDescription = 'Moderate fit, consider skill development';
            else scoreDescription = 'Limited match, significant gaps identified';

            scoreDetails.querySelector('p').textContent = scoreDescription;

            // Update dimensions
            const dimensionsContainer = document.getElementById('fitDimensions');
            dimensionsContainer.innerHTML = dimensions.map(dim => `
                <div class="fit-dimension">
                    <div class="dimension-info">
                        <div class="dimension-name">${dim.name}</div>
                        <div class="dimension-details">${dim.details}</div>
                    </div>
                    <div class="dimension-score">
                        <div class="score-bar">
                            <div class="score-bar-fill" style="width: ${dim.score}%; background-color: ${dim.color};"></div>
                        </div>
                        <div class="score-text" style="color: ${dim.color};">${dim.score}%</div>
                    </div>
                </div>
            `).join('');
        }

        // Prompts Functions
        function populateJobApplicationMaterials(job) {
            const container = document.getElementById('jobApplicationMaterials');

            // Get attached prompts from the job object
            const attachedPrompts = job.attachedPrompts || [];

            if (attachedPrompts.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #999; font-style: italic;">
                        <i class="ph ph-file-text" style="font-size: 32px; margin-bottom: 8px; display: block; color: #ccc;"></i>
                        No prompts attached to this opportunity yet.
                        <br><small>Use the "Generate LLM Prompt" feature to create and attach prompts.</small>
                    </div>
                `;
                return;
            }

            // Create table with attached prompts
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; font-family: var(--font-family-body); font-size: 13px;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--color-neutral-border);">
                            <th style="padding: 12px 8px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; color: var(--color-dark);">Type</th>
                            <th style="padding: 12px 8px; text-align: left; font-family: var(--font-family-ui); font-weight: 600; color: var(--color-dark);">Date Generated</th>
                            <th style="padding: 12px 8px; text-align: right; font-family: var(--font-family-ui); font-weight: 600; color: var(--color-dark);">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${attachedPrompts.map((prompt, index) => `
                            <tr style="border-bottom: 1px solid var(--color-neutral-border);">
                                <td style="padding: 12px 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="ph ph-file-text" style="font-size: 18px; color: var(--color-primary-blue);"></i>
                                        <span style="font-weight: 500; color: var(--color-dark);">${prompt.assetTypeName}</span>
                                    </div>
                                </td>
                                <td style="padding: 12px 8px; color: var(--color-neutral-text);">
                                    ${prompt.dateCreated} at ${prompt.timeCreated}
                                </td>
                                <td style="padding: 12px 8px; text-align: right;">
                                    <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                        <button onclick="copyPromptFromJob('${prompt.id}')" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-neutral-text); cursor: pointer; display: flex; align-items: center; gap: 4px;" title="Copy to clipboard">
                                            <i class="ph ph-copy" style="font-size: 14px;"></i>
                                            Copy
                                        </button>
                                        <button onclick="downloadPromptFromJob('${prompt.id}')" style="padding: 6px 12px; background: white; border: 1px solid var(--color-primary-blue); color: var(--color-primary-blue); border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;" title="Download prompt">
                                            <i class="ph ph-download" style="font-size: 14px;"></i>
                                            Download
                                        </button>
                                        <button onclick="deletePromptFromJob('${prompt.id}')" style="padding: 6px 12px; background: white; border: 1px solid #dc2626; color: #dc2626; border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;" title="Delete prompt">
                                            <i class="ph ph-trash" style="font-size: 14px;"></i>
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function copyPromptFromJob(promptId) {
            if (!currentJobDetail) return;

            // Find the prompt in the current job
            const prompt = currentJobDetail.attachedPrompts?.find(p => p.id === promptId);

            if (!prompt) {
                alert('Prompt not found.');
                return;
            }

            // Copy to clipboard
            navigator.clipboard.writeText(prompt.prompt).then(() => {
                alert('Prompt copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy prompt:', err);
                alert('Failed to copy prompt to clipboard. Please try again.');
            });
        }

        function downloadPromptFromJob(promptId) {
            if (!currentJobDetail) return;

            // Find the prompt in the current job
            const prompt = currentJobDetail.attachedPrompts?.find(p => p.id === promptId);

            if (!prompt) {
                alert('Prompt not found.');
                return;
            }

            // Create timestamp for filename
            const now = new Date();
            const timestamp = now.getFullYear() +
                '-' + String(now.getMonth() + 1).padStart(2, '0') +
                '-' + String(now.getDate()).padStart(2, '0') +
                '-' + String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0') +
                String(now.getSeconds()).padStart(2, '0');

            // Create filename
            const profile = loadProfile();
            const assetTypeSlug = prompt.assetType.replace(/-/g, '_');
            const jobSlug = `${currentJobDetail.title}_${currentJobDetail.company}`.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            const filename = `cleansheet-prompt-${assetTypeSlug}-${jobSlug}-${timestamp}.txt`;

            // Create download
            const promptBlob = new Blob([prompt.prompt], { type: 'text/plain' });
            const url = URL.createObjectURL(promptBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Prompt downloaded successfully!');
        }

        function deletePromptFromJob(promptId) {
            if (!currentJobDetail) return;

            if (!confirm('Are you sure you want to delete this prompt? This action cannot be undone.')) {
                return;
            }

            // Find the job in userJobs array
            const jobIndex = userJobs.findIndex(job =>
                job.title === currentJobDetail.title &&
                job.company === currentJobDetail.company &&
                job.location === currentJobDetail.location
            );

            if (jobIndex === -1) {
                alert('Job not found.');
                return;
            }

            // Remove the prompt from the job's attachedPrompts array
            if (userJobs[jobIndex].attachedPrompts) {
                userJobs[jobIndex].attachedPrompts = userJobs[jobIndex].attachedPrompts.filter(p => p.id !== promptId);
            }

            // Save to localStorage
            saveUserJobs();

            // Update currentJobDetail
            currentJobDetail = userJobs[jobIndex];

            // Refresh the prompts display
            populateJobApplicationMaterials(currentJobDetail);

            alert('Prompt deleted successfully!');
        }

        function getApplicationMaterialIcon(type) {
            const icons = {
                'Resume': 'ph-file-text',
                'Cover Letter': 'ph-envelope',
                'Email': 'ph-at'
            };
            return icons[type] || 'ph-file-text';
        }

        function generateJobMaterial() {
            if (!currentJobDetail) return;

            const jobTitle = currentJobDetail.title;
            const jobCompany = currentJobDetail.company;

            // Create modal for material type selection
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 400px; width: 100%;">
                    <h3 style="margin: 0 0 20px 0; font-family: var(--font-family-ui); color: var(--color-dark);">Generate Application Material</h3>
                    <p style="margin: 0 0 20px 0; color: var(--color-neutral-text); font-size: 13px;">
                        Create a customized document for <strong>${escapeHtml(jobTitle)}</strong> at <strong>${escapeHtml(jobCompany)}</strong>
                    </p>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Material Type</label>
                        <select id="materialTypeSelect" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                            <option value="Resume">Resume</option>
                            <option value="Cover Letter">Cover Letter</option>
                            <option value="Email">Email</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="createJobApplicationMaterial()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="ph ph-sparkle"></i> Generate
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function createJobApplicationMaterial() {
            const materialType = document.getElementById('materialTypeSelect').value;
            const modal = document.querySelector('div[style*="position: fixed"]');

            if (!currentJobDetail) {
                alert('No job selected');
                modal.remove();
                return;
            }

            // Create the material
            const jobOpportunityString = `${currentJobDetail.title} - ${currentJobDetail.company}`;
            const newMaterial = {
                type: materialType,
                title: `${materialType} for ${currentJobDetail.title}`,
                jobOpportunity: jobOpportunityString,
                content: generateMaterialContent(materialType, currentJobDetail),
                format: materialType === 'Email' ? 'HTML' : (materialType === 'Resume' ? 'PDF' : 'DOCX'),
                atsOptimized: materialType !== 'Email',
                createdDate: new Date().toISOString()
            };

            // Add to user materials
            loadUserApplicationMaterials();
            userApplicationMaterials.push(newMaterial);
            saveUserApplicationMaterials();

            // Refresh the display
            populateJobApplicationMaterials(currentJobDetail);

            modal.remove();
            alert(`${materialType} generated successfully! In a full implementation, this would create a customized ${materialType.toLowerCase()} tailored to this specific role and company.`);
        }

        function generateMaterialContent(type, job) {
            const templates = {
                'Resume': `Professional ${currentPersona} resume tailored for ${job.title} at ${job.company}. Highlights relevant experience, skills, and achievements that align with the job requirements. Includes contact information, professional summary, work experience, education, and key skills section.`,

                'Cover Letter': `Dear Hiring Manager,\n\nI am writing to express my strong interest in the ${job.title} position at ${job.company}. Based on my background and the role requirements, I believe I would be a valuable addition to your team.\n\n[Personalized content based on job requirements and user profile would be generated here]\n\nThank you for considering my application. I look forward to the opportunity to discuss how my skills and experience can contribute to ${job.company}'s success.\n\nSincerely,\n[Your Name]`,

                'Email': `Subject: Application for ${job.title} Position\n\nDear Hiring Manager,\n\nI hope this email finds you well. I am reaching out to express my interest in the ${job.title} position at ${job.company}.\n\n[Personalized email content would be generated here based on the job requirements and user profile]\n\nI have attached my resume for your review and would welcome the opportunity to discuss this position further.\n\nBest regards,\n[Your Name]`
            };

            return templates[type] || `Generated ${type} content for ${job.title} at ${job.company}`;
        }

        function uploadJobMaterial() {
            if (!currentJobDetail) return;
            alert(`Upload functionality coming soon! This will allow you to upload application materials specifically for ${currentJobDetail.title} at ${currentJobDetail.company}.`);
        }

        function viewApplicationMaterial(index, type) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            // Get the material (this is a simplified version - in reality you'd need to track the filtered materials)
            loadUserApplicationMaterials();
            const exampleMaterials = exampleApplicationMaterials[currentPersona] || [];
            const allMaterials = [...userApplicationMaterials, ...exampleMaterials];
            const material = allMaterials[index];

            if (!material) return;

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; width: 90%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--color-neutral-border); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-family: var(--font-family-ui);">${escapeHtml(material.title)}</h3>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <div style="padding: 20px; overflow-y: auto; flex: 1;">
                        <div style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; white-space: pre-wrap;">
                            ${escapeHtml(material.content)}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function downloadApplicationMaterial(index, type) {
            alert(`Download ${type} functionality coming soon! In a full implementation, this would download the material as a properly formatted document.`);
        }

        function deleteApplicationMaterial(index, type) {
            if (!confirm(`Are you sure you want to delete this ${type}?`)) return;

            // Remove from user materials (this is simplified - you'd need proper index tracking)
            loadUserApplicationMaterials();
            if (index < userApplicationMaterials.length) {
                userApplicationMaterials.splice(index, 1);
                saveUserApplicationMaterials();
                populateJobApplicationMaterials(currentJobDetail);
            }
        }

        // Job Todo Checklist Functions
        let userJobTodos = {};  // Will store todos by job identifier

        function getJobIdentifier(job) {
            return `${job.title}-${job.company}`.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
        }

        function loadJobTodos() {
            const stored = localStorage.getItem(`jobTodos_${currentPersona}`);
            userJobTodos = stored ? JSON.parse(stored) : {};
        }

        function saveJobTodos() {
            localStorage.setItem(`jobTodos_${currentPersona}`, JSON.stringify(userJobTodos));
        }

        function populateJobTodos(job) {
            const container = document.getElementById('jobDetailTodoList');

            let todos = job.todos || [];

            if (todos.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #999; font-style: italic;">
                        <i class="ph ph-check-square" style="font-size: 32px; margin-bottom: 8px; display: block; color: #ccc;"></i>
                        No action items yet.
                        <br><small>Click "Add Task" below to get started.</small>
                    </div>
                `;
                return;
            }

            // Sort todos by date and completion status
            todos.sort((a, b) => {
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                if (a.date && b.date) {
                    return new Date(a.date) - new Date(b.date);
                }
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
            });

            container.innerHTML = todos.map((todo, index) => {
                const isOverdue = todo.date && !todo.completed && new Date(todo.date) < new Date();
                const itemClass = `job-todo-item ${todo.completed ? 'completed' : ''}`;

                // Current status
                const status = todo.status || 'not-started';

                return `
                    <div class="${itemClass}" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${todo.completed ? '#f5f5f7' : 'white'}; border: 1px solid var(--color-neutral-border); border-radius: 6px; ${todo.completed ? 'opacity: 0.6;' : ''}">
                        <input
                            type="checkbox"
                            ${todo.completed ? 'checked' : ''}
                            onchange="toggleJobTodoComplete(${index})"
                            style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;"
                        >
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark); ${todo.completed ? 'text-decoration: line-through;' : ''}">${escapeHtml(todo.task)}</div>
                            <div style="display: flex; gap: 8px; align-items: center; margin-top: 4px; flex-wrap: wrap;">
                                <select onchange="updateJobTodoStatus(${index}, this.value)" style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; cursor: pointer; background: white;">
                                    <option value="not-started" ${status === 'not-started' ? 'selected' : ''}>Not Started</option>
                                    <option value="in-progress" ${status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="blocked" ${status === 'blocked' ? 'selected' : ''}>Blocked</option>
                                    <option value="completed" ${status === 'completed' ? 'selected' : ''}>Completed</option>
                                </select>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <i class="ph ${isOverdue ? 'ph-warning' : 'ph-calendar-blank'}" style="font-size: 14px; color: ${isOverdue ? '#dc2626' : 'var(--color-neutral-text)'};"></i>
                                    <input
                                        type="date"
                                        value="${todo.date || ''}"
                                        onchange="updateJobTodoDate(${index}, this.value)"
                                        style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; cursor: pointer; background: white; color: ${isOverdue ? '#dc2626' : 'var(--color-dark)'}; font-weight: ${isOverdue ? '600' : '400'};"
                                    >
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="editJobTodoInDetail(${index})" title="Edit task" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-pencil-simple" style="font-size: 14px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="deleteJobTodoInDetail(${index})" title="Delete task" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-trash" style="font-size: 14px; color: #dc2626;"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateJobTodoStatus(index, newStatus) {
            if (!currentJobDetail || !currentJobArray || currentJobIndex === -1) return;

            if (!currentJobDetail.todos) currentJobDetail.todos = [];

            const todo = currentJobDetail.todos[index];

            // Update status
            todo.status = newStatus;

            // Sync completed flag with status
            todo.completed = (newStatus === 'completed');

            // Update in array
            currentJobArray[currentJobIndex] = currentJobDetail;

            // Save to localStorage
            localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(currentJobArray));

            // Refresh the display
            populateJobTodos(currentJobDetail);

            // Reload job opportunities to update next action
            loadJobOpportunities();
        }

        function updateJobTodoDate(index, newDate) {
            if (!currentJobDetail || !currentJobArray || currentJobIndex === -1) return;

            if (!currentJobDetail.todos) currentJobDetail.todos = [];

            const todo = currentJobDetail.todos[index];

            // Update date
            todo.date = newDate || null;

            // Update in array
            currentJobArray[currentJobIndex] = currentJobDetail;

            // Save to localStorage
            localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(currentJobArray));

            // Refresh the display
            populateJobTodos(currentJobDetail);

            // Reload job opportunities to update next action
            loadJobOpportunities();
        }

        function toggleJobTodoComplete(index) {
            if (!currentJobDetail || !currentJobArray || currentJobIndex === -1) return;

            if (!currentJobDetail.todos) currentJobDetail.todos = [];

            const todo = currentJobDetail.todos[index];

            // Toggle the completed status
            todo.completed = !todo.completed;

            // Update status based on completed flag
            if (todo.completed) {
                todo.status = 'completed';
            } else {
                // If unchecking, set to in-progress (assumes they're working on it)
                todo.status = 'in-progress';
            }

            // Update in array
            currentJobArray[currentJobIndex] = currentJobDetail;

            // Save to localStorage
            localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(currentJobArray));

            // Refresh the display
            populateJobTodos(currentJobDetail);

            // Reload job opportunities to update next action
            loadJobOpportunities();
        }

        function addJobTodoInDetail() {
            if (!currentJobDetail || !currentJobArray || currentJobIndex === -1) return;

            const task = prompt('Enter task description:');
            if (!task || task.trim() === '') return;

            if (!currentJobDetail.todos) currentJobDetail.todos = [];

            const newTodo = {
                id: Date.now(),
                task: task.trim(),
                date: null,  // Date can be set via inline date picker
                status: 'not-started',
                completed: false
            };

            currentJobDetail.todos.push(newTodo);

            // Update in array
            currentJobArray[currentJobIndex] = currentJobDetail;

            // Save to localStorage
            localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(currentJobArray));

            // Refresh the display
            populateJobTodos(currentJobDetail);

            // Reload job opportunities to update next action
            loadJobOpportunities();
        }

        function editJobTodoInDetail(index) {
            if (!currentJobDetail || !currentJobArray || currentJobIndex === -1) return;
            if (!currentJobDetail.todos || !currentJobDetail.todos[index]) return;

            const todo = currentJobDetail.todos[index];

            const task = prompt('Edit task description:', todo.task);
            if (task === null) return; // User cancelled

            // Update the todo (status and date are now handled inline)
            currentJobDetail.todos[index].task = task.trim() || todo.task;

            // Update in array
            currentJobArray[currentJobIndex] = currentJobDetail;

            // Save to localStorage
            localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(currentJobArray));

            // Refresh the display
            populateJobTodos(currentJobDetail);

            // Reload job opportunities to update next action
            loadJobOpportunities();
        }

        function deleteJobTodoInDetail(index) {
            if (!currentJobDetail || !currentJobArray || currentJobIndex === -1) return;
            if (!currentJobDetail.todos || !currentJobDetail.todos[index]) return;

            if (!confirm('Are you sure you want to delete this task?')) return;

            // Remove the todo
            currentJobDetail.todos.splice(index, 1);

            // Update in array
            currentJobArray[currentJobIndex] = currentJobDetail;

            // Save to localStorage
            localStorage.setItem(`jobOpportunities_${currentPersona}`, JSON.stringify(currentJobArray));

            // Refresh the display
            populateJobTodos(currentJobDetail);

            // Reload job opportunities to update next action
            loadJobOpportunities();
        }

        function generateDefaultTodos(job) {
            const baseDate = new Date();
            const addDays = (days) => {
                const date = new Date(baseDate);
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0];
            };

            const defaultTodos = [
                { text: 'Review job description and requirements thoroughly', priority: 'high', dueDate: addDays(1), completed: false },
                { text: 'Research company culture and recent news', priority: 'high', dueDate: addDays(2), completed: false },
                { text: 'Tailor resume for this specific role', priority: 'high', dueDate: addDays(3), completed: false },
                { text: 'Write personalized cover letter', priority: 'high', dueDate: addDays(4), completed: false },
                { text: 'Submit application through company website', priority: 'high', dueDate: addDays(7), completed: false },
                { text: 'Follow up on application status', priority: 'medium', dueDate: addDays(14), completed: false },
                { text: 'Prepare for potential phone screening', priority: 'medium', dueDate: addDays(10), completed: false },
                { text: 'Research interview questions for this role', priority: 'medium', dueDate: addDays(10), completed: false },
                { text: 'Prepare behavioral interview stories', priority: 'medium', dueDate: addDays(12), completed: false },
                { text: 'Connect with employees on LinkedIn', priority: 'low', dueDate: addDays(5), completed: false }
            ];

            return defaultTodos;
        }

        function getDueStatus(dueDate) {
            if (!dueDate) return { class: 'normal', itemClass: '' };

            const today = new Date();
            const due = new Date(dueDate);
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return { class: 'overdue', itemClass: 'overdue' };
            } else if (diffDays <= 3) {
                return { class: 'due-soon', itemClass: 'due-soon' };
            } else {
                return { class: 'normal', itemClass: '' };
            }
        }

        function formatDueDate(dueDate) {
            const today = new Date();
            const due = new Date(dueDate);
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return `${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''} ago`;
            } else if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Tomorrow';
            } else if (diffDays <= 7) {
                return `in ${diffDays} days`;
            } else {
                return due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        function toggleJobTodo(index) {
            if (!currentJobDetail) return;

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];

            if (todos[index]) {
                todos[index].completed = !todos[index].completed;
                userJobTodos[jobId] = todos;
                saveJobTodos();
                populateJobTodos(currentJobDetail);
            }
        }

        function addJobTodo() {
            if (!currentJobDetail) return;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 100%;">
                    <h3 style="margin: 0 0 20px 0; font-family: var(--font-family-ui); color: var(--color-dark);">Add Application Task</h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Task Description</label>
                        <input type="text" id="todoText" placeholder="e.g., Follow up with hiring manager" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Due Date</label>
                            <input type="date" id="todoDueDate" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Priority</label>
                            <select id="todoPriority" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="saveJobTodo()" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="ph ph-plus"></i> Add Task
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function saveJobTodo() {
            const text = document.getElementById('todoText').value.trim();
            const dueDate = document.getElementById('todoDueDate').value;
            const priority = document.getElementById('todoPriority').value;
            const modal = document.querySelector('div[style*="position: fixed"]');

            if (!text) {
                alert('Please enter a task description');
                return;
            }

            const jobId = getJobIdentifier(currentJobDetail);
            if (!userJobTodos[jobId]) userJobTodos[jobId] = [];

            const newTodo = {
                text: text,
                dueDate: dueDate || null,
                priority: priority,
                completed: false,
                createdDate: new Date().toISOString()
            };

            userJobTodos[jobId].push(newTodo);
            saveJobTodos();
            populateJobTodos(currentJobDetail);

            modal.remove();
        }

        function editJobTodo(index) {
            if (!currentJobDetail) return;

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];
            const todo = todos[index];

            if (!todo) return;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 100%;">
                    <h3 style="margin: 0 0 20px 0; font-family: var(--font-family-ui); color: var(--color-dark);">Edit Application Task</h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Task Description</label>
                        <input type="text" id="editTodoText" value="${escapeHtml(todo.text)}" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Due Date</label>
                            <input type="date" id="editTodoDueDate" value="${todo.dueDate || ''}" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Priority</label>
                            <select id="editTodoPriority" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                                <option value="low" ${todo.priority === 'low' ? 'selected' : ''}>Low</option>
                                <option value="medium" ${todo.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                <option value="high" ${todo.priority === 'high' ? 'selected' : ''}>High</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="updateJobTodo(${index})" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="ph ph-check"></i> Update Task
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function updateJobTodo(index) {
            const text = document.getElementById('editTodoText').value.trim();
            const dueDate = document.getElementById('editTodoDueDate').value;
            const priority = document.getElementById('editTodoPriority').value;
            const modal = document.querySelector('div[style*="position: fixed"]');

            if (!text) {
                alert('Please enter a task description');
                return;
            }

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];

            if (todos[index]) {
                todos[index].text = text;
                todos[index].dueDate = dueDate || null;
                todos[index].priority = priority;
                userJobTodos[jobId] = todos;
                saveJobTodos();
                populateJobTodos(currentJobDetail);
            }

            modal.remove();
        }

        function deleteJobTodo(index) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];

            if (todos[index]) {
                todos.splice(index, 1);
                userJobTodos[jobId] = todos;
                saveJobTodos();
                populateJobTodos(currentJobDetail);
            }
        }

        function setJobDeadlines() {
            if (!currentJobDetail) return;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 400px; width: 100%;">
                    <h3 style="margin: 0 0 20px 0; font-family: var(--font-family-ui); color: var(--color-dark);">Set Application Deadlines</h3>
                    <p style="margin: 0 0 20px 0; color: var(--color-neutral-text); font-size: 13px;">
                        Automatically set due dates for all tasks based on a target application date.
                    </p>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">Target Application Date</label>
                        <input type="date" id="targetApplicationDate" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;">
                        <small style="color: var(--color-neutral-text-light); font-size: 11px;">Tasks will be scheduled to complete before this date</small>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 8px 16px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="applyJobDeadlines()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="ph ph-calendar"></i> Set Deadlines
                        </button>
                    </div>
                </div>
            `;

            // Set default date to one week from today
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 7);

            document.body.appendChild(modal);
            document.getElementById('targetApplicationDate').value = defaultDate.toISOString().split('T')[0];
        }

        function applyJobDeadlines() {
            const targetDate = document.getElementById('targetApplicationDate').value;
            const modal = document.querySelector('div[style*="position: fixed"]');

            if (!targetDate) {
                alert('Please select a target application date');
                return;
            }

            const jobId = getJobIdentifier(currentJobDetail);
            const todos = userJobTodos[jobId] || [];

            if (todos.length === 0) {
                alert('No tasks found to set deadlines for');
                modal.remove();
                return;
            }

            // Calculate working backwards from target date
            const target = new Date(targetDate);
            const today = new Date();
            const daysAvailable = Math.ceil((target - today) / (1000 * 60 * 60 * 24));

            if (daysAvailable < 1) {
                alert('Target date must be in the future');
                return;
            }

            // Assign deadlines based on priority and task type
            todos.forEach((todo, index) => {
                if (todo.completed) return; // Don't change completed tasks

                let dayOffset;
                const text = todo.text.toLowerCase();

                // Assign based on task content and priority
                if (text.includes('review') || text.includes('research company')) {
                    dayOffset = Math.max(1, Math.floor(daysAvailable * 0.1));
                } else if (text.includes('resume') || text.includes('tailor')) {
                    dayOffset = Math.max(2, Math.floor(daysAvailable * 0.3));
                } else if (text.includes('cover letter')) {
                    dayOffset = Math.max(3, Math.floor(daysAvailable * 0.4));
                } else if (text.includes('submit') || text.includes('apply')) {
                    dayOffset = Math.max(1, Math.floor(daysAvailable * 0.9));
                } else if (text.includes('follow up')) {
                    dayOffset = daysAvailable + 7; // After application
                } else if (text.includes('prepare') || text.includes('interview')) {
                    dayOffset = Math.max(3, Math.floor(daysAvailable * 0.8));
                } else {
                    // Default based on priority
                    switch (todo.priority) {
                        case 'high':
                            dayOffset = Math.max(1, Math.floor(daysAvailable * 0.5));
                            break;
                        case 'medium':
                            dayOffset = Math.max(2, Math.floor(daysAvailable * 0.7));
                            break;
                        default:
                            dayOffset = Math.max(3, Math.floor(daysAvailable * 0.6));
                    }
                }

                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + dayOffset);
                todo.dueDate = dueDate.toISOString().split('T')[0];
            });

            userJobTodos[jobId] = todos;
            saveJobTodos();
            populateJobTodos(currentJobDetail);

            modal.remove();
            alert(`Deadlines set for ${todos.filter(t => !t.completed).length} tasks based on ${targetDate} target date.`);
        }

        // Career Experience Management
        let userExperiences = [];

        // Example experiences for each persona
        const exampleExperiences = {
            'retail-manager': [
                {
                    organizationName: 'RetailMart',
                    role: 'Store Manager',
                    location: 'Denver, CO',
                    startDate: '2019-03',
                    endDate: '2024-02',
                    description: 'Managed daily operations of high-volume retail location with 25+ staff members. Oversaw inventory, scheduling, customer service, and P&L.',
                    technologies: [
                        { name: 'Excel', type: 'Core' },
                        { name: 'POS Systems', type: 'Core' },
                        { name: 'Inventory Management Software', type: 'Core' },
                        { name: 'Scheduling Tools', type: 'Peripheral' }
                    ],
                    keySkills: ['Team Leadership', 'P&L Management', 'Customer Service', 'Inventory Control', 'Staff Training'],
                    competencies: ['Operations Management', 'Process Improvement', 'Performance Analytics', 'Stakeholder Communication'],
                    projectTypes: ['Process Optimization', 'Team Development', 'Customer Experience Enhancement'],
                    internalStakeholders: ['Regional Manager', 'HR Department', 'Loss Prevention Team'],
                    externalStakeholders: ['Customers', 'Vendors', 'Local Community'],
                    achievements: [
                        'Increased store revenue by 23% year-over-year',
                        'Reduced employee turnover by 40% through improved training',
                        'Maintained 95%+ customer satisfaction score'
                    ]
                },
                {
                    organizationName: 'QuickMart',
                    role: 'Assistant Store Manager',
                    location: 'Denver, CO',
                    startDate: '2016-06',
                    endDate: '2019-02',
                    description: 'Supported store operations and managed shifts. Supervised 10+ employees, handled customer escalations, and assisted with inventory management.',
                    technologies: [
                        { name: 'Excel', type: 'Core' },
                        { name: 'POS Systems', type: 'Core' },
                        { name: 'Inventory Software', type: 'Peripheral' }
                    ],
                    keySkills: ['Shift Management', 'Customer Service', 'Team Supervision', 'Problem Solving', 'Cash Handling'],
                    competencies: ['Operations Support', 'Conflict Resolution', 'Team Coordination', 'Sales Performance'],
                    projectTypes: ['Customer Service Improvement', 'Team Training', 'Loss Prevention'],
                    internalStakeholders: ['Store Manager', 'District Manager', 'Loss Prevention'],
                    externalStakeholders: ['Customers', 'Vendors'],
                    achievements: [
                        'Promoted to Store Manager after 2.5 years',
                        'Reduced shrinkage by 15% through improved procedures',
                        'Consistently achieved top 3 in customer satisfaction surveys'
                    ]
                },
                {
                    organizationName: 'FreshFoods Grocery',
                    role: 'Department Supervisor',
                    location: 'Colorado Springs, CO',
                    startDate: '2014-08',
                    endDate: '2016-05',
                    description: 'Supervised produce department with 6 team members. Managed ordering, merchandising, quality control, and customer service.',
                    technologies: [
                        { name: 'Excel', type: 'Peripheral' },
                        { name: 'Ordering Systems', type: 'Core' }
                    ],
                    keySkills: ['Inventory Management', 'Merchandising', 'Quality Control', 'Team Leadership', 'Vendor Relations'],
                    competencies: ['Department Operations', 'Product Knowledge', 'Loss Prevention', 'Customer Engagement'],
                    projectTypes: ['Process Standardization', 'Quality Improvement', 'Sales Growth'],
                    internalStakeholders: ['Store Manager', 'Other Department Supervisors'],
                    externalStakeholders: ['Produce Vendors', 'Customers'],
                    achievements: [
                        'Increased department sales by 18%',
                        'Reduced spoilage by 25% through better rotation',
                        'Trained 3 employees who went on to supervisor roles'
                    ]
                }
            ],
            'chemist': [
                {
                    organizationName: 'PharmaTech Labs',
                    role: 'Research Chemist',
                    location: 'Boston, MA',
                    startDate: '2020-06',
                    endDate: '2024-01',
                    description: 'Conducted analytical chemistry research for pharmaceutical development. Designed experiments, analyzed compounds, and collaborated with cross-functional teams.',
                    technologies: [
                        { name: 'HPLC', type: 'Core' },
                        { name: 'Mass Spectrometry', type: 'Core' },
                        { name: 'Python', type: 'Peripheral' },
                        { name: 'ChemDraw', type: 'Core' },
                        { name: 'Lab Information Management Systems', type: 'Peripheral' }
                    ],
                    keySkills: ['Analytical Chemistry', 'Data Analysis', 'Technical Writing', 'Lab Safety', 'Quality Control'],
                    competencies: ['Scientific Research', 'Problem Solving', 'Regulatory Compliance', 'Cross-functional Collaboration'],
                    projectTypes: ['Research & Development', 'Quality Assurance', 'Method Validation'],
                    internalStakeholders: ['Principal Scientist', 'Quality Team', 'R&D Leadership'],
                    externalStakeholders: ['Regulatory Agencies', 'Contract Labs', 'Equipment Vendors'],
                    achievements: [
                        'Published 3 peer-reviewed papers in analytical chemistry journals',
                        'Developed new testing method reducing analysis time by 35%',
                        'Led successful FDA audit with zero findings'
                    ]
                },
                {
                    organizationName: 'BioTech Research Inc',
                    role: 'Associate Chemist',
                    location: 'Cambridge, MA',
                    startDate: '2018-09',
                    endDate: '2020-05',
                    description: 'Performed laboratory analysis and quality control testing. Maintained lab equipment, documented procedures, and supported senior researchers.',
                    technologies: [
                        { name: 'GC-MS', type: 'Core' },
                        { name: 'HPLC', type: 'Core' },
                        { name: 'Spectroscopy', type: 'Core' },
                        { name: 'LabWare LIMS', type: 'Peripheral' }
                    ],
                    keySkills: ['Laboratory Techniques', 'Quality Control', 'Documentation', 'Equipment Maintenance', 'Sample Preparation'],
                    competencies: ['Analytical Testing', 'GLP/GMP Compliance', 'Technical Documentation', 'Lab Safety'],
                    projectTypes: ['Quality Control', 'Method Development Support', 'Equipment Validation'],
                    internalStakeholders: ['Senior Chemists', 'Quality Manager', 'Lab Technicians'],
                    externalStakeholders: ['Equipment Vendors', 'Calibration Services'],
                    achievements: [
                        'Maintained 99.5% accuracy rate on quality control samples',
                        'Reduced instrument downtime by 30% through preventive maintenance',
                        'Trained 5 new lab technicians on analytical methods'
                    ]
                },
                {
                    organizationName: 'University Research Lab',
                    role: 'Graduate Research Assistant',
                    location: 'Boston, MA',
                    startDate: '2016-08',
                    endDate: '2018-05',
                    description: 'Conducted graduate research in organic chemistry. Synthesized compounds, performed characterization, and assisted with undergraduate teaching.',
                    technologies: [
                        { name: 'NMR Spectroscopy', type: 'Core' },
                        { name: 'Chromatography', type: 'Core' },
                        { name: 'ChemDraw', type: 'Core' }
                    ],
                    keySkills: ['Organic Synthesis', 'Compound Characterization', 'Literature Research', 'Scientific Writing', 'Teaching'],
                    competencies: ['Research Design', 'Data Analysis', 'Academic Collaboration', 'Presentation Skills'],
                    projectTypes: ['Academic Research', 'Teaching Assistant', 'Thesis Research'],
                    internalStakeholders: ['Thesis Advisor', 'Lab Group Members', 'Undergraduate Students'],
                    externalStakeholders: ['Academic Conferences', 'Journal Reviewers'],
                    achievements: [
                        'Published 2 first-author papers in peer-reviewed journals',
                        'Received departmental teaching excellence award',
                        'Completed Master of Science in Chemistry with honors'
                    ]
                }
            ],
            'new-graduate': [
                {
                    organizationName: 'State University',
                    role: 'Computer Science Student',
                    location: 'Austin, TX',
                    startDate: '2020-08',
                    endDate: '2024-05',
                    description: 'Bachelor of Science in Computer Science. Completed coursework in algorithms, data structures, web development, and databases. Participated in hackathons and coding competitions.',
                    technologies: [
                        { name: 'Python', type: 'Core' },
                        { name: 'Java', type: 'Core' },
                        { name: 'JavaScript', type: 'Core' },
                        { name: 'React', type: 'Peripheral' },
                        { name: 'SQL', type: 'Core' },
                        { name: 'Git', type: 'Core' }
                    ],
                    keySkills: ['Object-Oriented Programming', 'Algorithm Design', 'Web Development', 'Database Design', 'Agile Methodology'],
                    competencies: ['Software Development', 'Problem Solving', 'Technical Communication', 'Team Collaboration'],
                    projectTypes: ['Capstone Project', 'Hackathons', 'Academic Research'],
                    internalStakeholders: ['Academic Advisors', 'Professors', 'Student Teams'],
                    externalStakeholders: ['Industry Mentors', 'Open Source Community'],
                    achievements: [
                        'Graduated Magna Cum Laude with 3.8 GPA',
                        'Won 1st place at regional hackathon for mobile app development',
                        'Completed 3-month internship at tech startup'
                    ]
                },
                {
                    organizationName: 'TechStart Inc',
                    role: 'Software Engineering Intern',
                    location: 'Austin, TX',
                    startDate: '2023-06',
                    endDate: '2023-08',
                    description: '12-week summer internship developing web applications. Built features for customer-facing portal, fixed bugs, and participated in code reviews.',
                    technologies: [
                        { name: 'React', type: 'Core' },
                        { name: 'Node.js', type: 'Core' },
                        { name: 'MongoDB', type: 'Core' },
                        { name: 'Git', type: 'Core' },
                        { name: 'Docker', type: 'Peripheral' }
                    ],
                    keySkills: ['Full Stack Development', 'Agile Workflow', 'Code Review', 'RESTful APIs', 'Testing'],
                    competencies: ['Software Engineering', 'Team Collaboration', 'Problem Solving', 'Communication'],
                    projectTypes: ['Feature Development', 'Bug Fixes', 'Code Refactoring'],
                    internalStakeholders: ['Engineering Manager', 'Senior Developers', 'Product Manager'],
                    externalStakeholders: ['End Users'],
                    achievements: [
                        'Shipped 5 new features to production',
                        'Received full-time job offer upon graduation',
                        'Reduced page load time by 40% through optimization'
                    ]
                },
                {
                    organizationName: 'University IT Department',
                    role: 'Student Web Developer',
                    location: 'Austin, TX',
                    startDate: '2022-01',
                    endDate: '2024-05',
                    description: 'Part-time web development position maintaining university websites. Updated content, fixed issues, and built new pages for campus departments.',
                    technologies: [
                        { name: 'HTML/CSS', type: 'Core' },
                        { name: 'JavaScript', type: 'Core' },
                        { name: 'WordPress', type: 'Core' },
                        { name: 'PHP', type: 'Peripheral' }
                    ],
                    keySkills: ['Web Development', 'Content Management', 'Responsive Design', 'Customer Service', 'Time Management'],
                    competencies: ['Web Design', 'Technical Support', 'Project Management', 'Stakeholder Communication'],
                    projectTypes: ['Website Maintenance', 'New Site Development', 'Accessibility Compliance'],
                    internalStakeholders: ['IT Manager', 'Campus Departments', 'Web Team'],
                    externalStakeholders: ['Students', 'Faculty', 'Website Visitors'],
                    achievements: [
                        'Maintained 20+ department websites',
                        'Improved accessibility compliance across all sites',
                        'Balanced work with full-time coursework (20 hours/week)'
                    ]
                }
            ],
            'data-analyst': [
                {
                    organizationName: 'FinServe Corp',
                    role: 'Business Intelligence Analyst',
                    location: 'Chicago, IL',
                    startDate: '2021-01',
                    endDate: null,
                    description: 'Analyze business data to drive strategic decisions. Build dashboards, perform statistical analysis, and present insights to leadership.',
                    technologies: [
                        { name: 'SQL', type: 'Core' },
                        { name: 'Python', type: 'Core' },
                        { name: 'Tableau', type: 'Core' },
                        { name: 'Power BI', type: 'Peripheral' },
                        { name: 'Excel', type: 'Core' },
                        { name: 'R', type: 'Peripheral' }
                    ],
                    keySkills: ['Data Analysis', 'Data Visualization', 'Statistical Modeling', 'Business Intelligence', 'Stakeholder Communication'],
                    competencies: ['Business Analytics', 'Strategic Planning', 'Data Storytelling', 'Process Improvement'],
                    projectTypes: ['Dashboard Development', 'Predictive Analytics', 'Business Reporting'],
                    internalStakeholders: ['Finance Team', 'Executive Leadership', 'Product Managers'],
                    externalStakeholders: ['External Auditors', 'Business Partners'],
                    achievements: [
                        'Built executive dashboard used by C-suite for strategic decisions',
                        'Identified $2M in cost savings through data analysis',
                        'Reduced reporting time by 60% through automation'
                    ]
                },
                {
                    organizationName: 'RetailCo Analytics',
                    role: 'Data Analyst',
                    location: 'Minneapolis, MN',
                    startDate: '2019-06',
                    endDate: '2020-12',
                    description: 'Analyzed retail sales data to identify trends and opportunities. Created reports for merchandising teams and supported inventory optimization initiatives.',
                    technologies: [
                        { name: 'SQL', type: 'Core' },
                        { name: 'Excel', type: 'Core' },
                        { name: 'Tableau', type: 'Core' },
                        { name: 'Python', type: 'Peripheral' }
                    ],
                    keySkills: ['SQL Queries', 'Data Visualization', 'Report Building', 'Trend Analysis', 'Excel Modeling'],
                    competencies: ['Retail Analytics', 'Business Reporting', 'Data Quality', 'Stakeholder Collaboration'],
                    projectTypes: ['Sales Analysis', 'Inventory Reporting', 'Trend Forecasting'],
                    internalStakeholders: ['Merchandising Team', 'Store Operations', 'Marketing'],
                    externalStakeholders: ['Vendor Partners'],
                    achievements: [
                        'Created automated weekly sales dashboard saving 10 hours/week',
                        'Identified underperforming products leading to $500K savings',
                        'Supported successful launch of 3 new product categories'
                    ]
                },
                {
                    organizationName: 'State University',
                    role: 'Business Analytics Student',
                    location: 'Chicago, IL',
                    startDate: '2017-08',
                    endDate: '2019-05',
                    description: 'Completed Master of Science in Business Analytics. Coursework in statistics, machine learning, data visualization, and business strategy.',
                    technologies: [
                        { name: 'R', type: 'Core' },
                        { name: 'Python', type: 'Core' },
                        { name: 'SQL', type: 'Core' },
                        { name: 'Tableau', type: 'Core' },
                        { name: 'SAS', type: 'Peripheral' }
                    ],
                    keySkills: ['Statistical Analysis', 'Machine Learning', 'Data Mining', 'Predictive Modeling', 'Data Visualization'],
                    competencies: ['Quantitative Analysis', 'Research Methods', 'Business Intelligence', 'Technical Communication'],
                    projectTypes: ['Capstone Projects', 'Case Studies', 'Group Projects'],
                    internalStakeholders: ['Faculty Advisors', 'Project Teams', 'Career Services'],
                    externalStakeholders: ['Industry Partners', 'Guest Speakers'],
                    achievements: [
                        'Graduated with 3.9 GPA',
                        'Won 2nd place in analytics case competition',
                        'Completed capstone project for Fortune 500 company'
                    ]
                }
            ]
        };

        function loadUserExperiences() {
            // DIAGNOSTIC: Log what we're looking for
            console.log('[DIAGNOSTIC] loadUserExperiences called');
            console.log('[DIAGNOSTIC] currentPersona variable:', currentPersona);

            // Load from cleansheet_experiences (imported data) or fall back to legacy key
            let stored = localStorage.getItem('cleansheet_experiences');
            try {
                console.log('[DIAGNOSTIC] Checking cleansheet_experiences:', stored ? `Found ${JSON.parse(stored).length} items` : 'null/undefined');
            } catch(e) {
                console.log('[DIAGNOSTIC] Checking cleansheet_experiences: Invalid JSON');
            }

            if (!stored) {
                const legacyKey = 'careerExperiences_' + currentPersona;
                stored = localStorage.getItem(legacyKey);
                try {
                    console.log(`[DIAGNOSTIC] Checking ${legacyKey}:`, stored ? `Found ${JSON.parse(stored).length} items` : 'null/undefined');
                } catch(e) {
                    console.log(`[DIAGNOSTIC] Checking ${legacyKey}: Invalid JSON`);
                }
            }

            // Also check user_experiences key that forceSyncDown might have used
            const userExpData = localStorage.getItem('user_experiences');
            if (userExpData) {
                try {
                    console.log('[DIAGNOSTIC] WARNING: user_experiences key exists with', JSON.parse(userExpData).length, 'items but was not checked!');
                } catch(e) {
                    console.log('[DIAGNOSTIC] WARNING: user_experiences key exists but contains invalid JSON');
                }
            }

            if (stored) {
                try {
                    userExperiences = JSON.parse(stored);
                    // Normalize data structure (handle both old and new formats)
                    userExperiences = userExperiences.map((exp, index) => {
                        const titleValue = exp.title || exp.role || exp.name || 'Untitled';
                        return {
                        id: exp.id || `${titleValue.replace(/[^a-zA-Z0-9]/g, '_')}_${index}`,  // Generate stable ID if not present
                        title: titleValue,  // Map to title field
                        role: exp.role || exp.name || '',
                        company: exp.company || exp.organizationName || exp.organization || '',  // Map to company field
                        organizationName: exp.organizationName || exp.organization || '',
                        location: exp.location || '',
                        startDate: exp.startDate || '',
                        endDate: exp.endDate || '',
                        description: exp.description || '',
                        technologies: exp.technologies || [],
                        keySkills: exp.keySkills || [],
                        competencies: exp.competencies || [],
                        achievements: exp.achievements || [],
                        projectTypes: exp.projectTypes || [],
                        internalStakeholders: exp.internalStakeholders || [],
                        externalStakeholders: exp.externalStakeholders || []
                    };
                    });
                } catch (e) {
                    userExperiences = [];
                }
            } else {
                userExperiences = [];
            }
        }

        function saveUserExperiences() {
            localStorage.setItem('cleansheet_experiences', JSON.stringify(userExperiences));
            // Also save to legacy key for backwards compatibility
            localStorage.setItem('careerExperiences_' + currentPersona, JSON.stringify(userExperiences));

            // Sync to cloud if authenticated (debounced)
            if (isAuthenticated && sync) {
                sync.hybridSave('experiences', userExperiences, 2000).catch(err => {
                    console.error('Experiences cloud sync failed:', err);
                });
            }
        }

        function openCareerExperienceSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');
                const careerExperienceContent = document.getElementById('careerExperienceContent');

                titleEl.textContent = 'Career Experience';

                // Hide all content sections
                hideAllContentSections();

                // Show career experience content
                careerExperienceContent.style.display = 'flex';

                // Ensure profile request form is collapsed
                const profileRequestForm = document.getElementById('profileRequestFormContainer');
                if (profileRequestForm) {
                    profileRequestForm.style.display = 'none';
                }

                loadCareerExperiences();

                // Update the count in personaData for D3 display
                updateExperienceCount(userExperiences.length);
                updateBadgesOnly(); // FIXED: Use selective badge update instead of full re-render
            });
        }

        function loadCareerExperiences() {
            const container = document.getElementById('experiencesContainer');
            container.innerHTML = '';

            loadUserExperiences();

            // Load behavioral stories to count them per experience
            const behavioralStories = JSON.parse(localStorage.getItem('behavioralStories') || '[]');

            // Sort experiences by start date (most recent first)
            const sortedExperiences = [...userExperiences].sort((a, b) => {
                const dateA = a.startDate || '0000-00-00';
                const dateB = b.startDate || '0000-00-00';
                return dateB.localeCompare(dateA);
            });

            if (sortedExperiences.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-briefcase" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No career experiences yet. Import your JSON data or click "Add Experience" to manually add your work history.</p>
                    </div>
                `;
                return;
            }

            // Display all experiences
            sortedExperiences.forEach((exp, sortedIndex) => {
                // Find the original index in userExperiences array
                // Use a more robust matching approach
                const originalIndex = userExperiences.findIndex(e => {
                    // First try exact object reference match
                    if (e === exp) return true;

                    // Fall back to field matching (handle both field name formats)
                    const roleMatch = (e.role === exp.role || e.title === exp.title);
                    const companyMatch = (e.organizationName === exp.organizationName ||
                                         e.organizationName === exp.company ||
                                         e.company === exp.organizationName ||
                                         e.company === exp.company);
                    return roleMatch && companyMatch && e.startDate === exp.startDate;
                });

                // Safety check - if not found, skip this experience
                if (originalIndex === -1) {
                    console.warn('Could not find original index for experience:', exp);
                    return;
                }

                const startDate = exp.startDate ? new Date(exp.startDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short' }) : '';
                const endDate = exp.endDate ? new Date(exp.endDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short' }) : 'Present';

                // Count stories associated with this experience
                const storyCount = behavioralStories.filter(story => story.experienceIndex === originalIndex).length;

                // Count ALL assets linked to this experience
                const storedWb = localStorage.getItem(`whiteboards_${currentPersona}`);
                const allWhiteboards = storedWb ? JSON.parse(storedWb) : [];

                const storedDg = localStorage.getItem(`diagrams_${currentPersona}`);
                const allDiagrams = storedDg ? JSON.parse(storedDg) : [];

                const storedDc = localStorage.getItem(`interview_documents_${currentPersona}`);
                const allDocuments = storedDc ? JSON.parse(storedDc) : [];

                const storedMd = localStorage.getItem(`markdown_${currentPersona}`);
                const allMarkdown = storedMd ? JSON.parse(storedMd) : [];

                const storedCode = localStorage.getItem(`code_${currentPersona}`);
                const allCode = storedCode ? JSON.parse(storedCode) : [];

                const storedPuml = localStorage.getItem(`plantuml_${currentPersona}`);
                const allPlantUML = storedPuml ? JSON.parse(storedPuml) : [];

                const storedMermaid = localStorage.getItem(`mermaid_${currentPersona}`);
                const allMermaid = storedMermaid ? JSON.parse(storedMermaid) : [];

                // Count all linked assets
                const linkedAssets = [
                    ...allWhiteboards,
                    ...allDiagrams,
                    ...allDocuments,
                    ...allMarkdown,
                    ...allCode,
                    ...allPlantUML,
                    ...allMermaid
                ].filter(asset =>
                    asset.linkedType === 'experience' &&
                    asset.linkedId === (exp.id || exp.title)
                );

                const card = document.createElement('div');
                card.className = 'experience-card';

                card.innerHTML = `
                    <div class="experience-card-header">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div class="exp-title">${escapeHtml(exp.title || exp.role || 'Untitled Position')}</div>
                                ${storyCount > 0 ? `<span onclick="openInterviewPrepFiltered(${originalIndex})" style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #e3f2fd; border-radius: 12px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-primary-blue); cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.background='#e3f2fd'; this.style.color='var(--color-primary-blue)';" title="Click to view ${storyCount} STAR ${storyCount === 1 ? 'story' : 'stories'} for this experience"><i class="ph ph-star" style="font-size: 12px;"></i>${storyCount}</span>` : ''}
                                ${linkedAssets.length > 0 ? `<span onclick="openAssetsFilteredByExperience('${exp.id || exp.title}')" style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #f0fdf4; border-radius: 12px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: #16a34a; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#16a34a'; this.style.color='white';" onmouseout="this.style.background='#f0fdf4'; this.style.color='#16a34a';" title="Click to view ${linkedAssets.length} asset${linkedAssets.length === 1 ? '' : 's'} for this experience"><i class="ph ph-folder-open" style="font-size: 12px;"></i>${linkedAssets.length}</span>` : ''}
                                <button onclick="openStoryFormForExperience(${originalIndex})" style="display: inline-flex; align-items: center; justify-content: center; width: 17px; height: 17px; padding: 0; background: white; border: 1px solid var(--color-primary-blue); border-radius: 50%; color: var(--color-primary-blue); font-size: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='var(--color-primary-blue)';" title="Add STAR story for this experience"><i class="ph ph-plus" style="font-size: 10px;"></i></button>
                            </div>
                            <div class="exp-company">${escapeHtml(exp.company || exp.organizationName || '')}${exp.location ? ' • ' + escapeHtml(exp.location) : ''}</div>
                            <div class="exp-dates">${startDate} - ${endDate}</div>
                        </div>
                        <div class="story-actions">
                            <button class="story-action-btn" onclick="editExperienceRecord(${originalIndex})" title="Edit">
                                <i class="ph ph-pencil-simple"></i>
                            </button>
                            <button class="story-action-btn delete" onclick="deleteExperienceRecord(${originalIndex})" title="Delete">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${exp.description ? `<div class="exp-description">${escapeHtml(exp.description)}</div>` : ''}
                    ${exp.technologies && exp.technologies.length > 0 ? `
                        <div class="exp-section">
                            <div class="exp-section-label">Technologies</div>
                            <div class="exp-tags">
                                ${exp.technologies.map(tech => `<span class="exp-tag ${tech.type ? tech.type.toLowerCase() : ''}">${escapeHtml(tech.name || tech)}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${(exp.keySkills || exp.skills) && (exp.keySkills || exp.skills).length > 0 ? `
                        <div class="exp-section">
                            <div class="exp-section-label">Key Skills</div>
                            <div class="exp-tags">
                                ${(exp.keySkills || exp.skills).map(skill => `<span class="exp-tag">${escapeHtml(skill)}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${exp.competencies && exp.competencies.length > 0 ? `
                        <div class="exp-section">
                            <div class="exp-section-label">Competencies</div>
                            <div class="exp-tags">
                                ${exp.competencies.map(comp => `<span class="exp-tag">${escapeHtml(comp)}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${exp.achievements && exp.achievements.length > 0 ? `
                        <div class="exp-section">
                            <div class="exp-section-label">Achievements</div>
                            <ul class="exp-list">
                                ${exp.achievements.map(achievement => `<li>${escapeHtml(achievement)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
        }

        // Experience Modal State
        let editingExperienceIndex = -1;
        let currentExperienceTechnologies = [];
        let currentExperienceSkills = [];
        let currentExperienceCompetencies = [];
        let currentExperienceAchievements = [];

        function addExperienceRecord() {
            editingExperienceIndex = -1;
            currentExperienceTechnologies = [];
            currentExperienceSkills = [];
            currentExperienceCompetencies = [];
            currentExperienceAchievements = [];

            document.getElementById('experienceModalTitle').textContent = 'Add Experience';
            document.getElementById('experienceForm').reset();
            document.getElementById('expTechList').innerHTML = '';
            document.getElementById('expSkillList').innerHTML = '';
            document.getElementById('expCompetencyList').innerHTML = '';
            document.getElementById('expAchievementList').innerHTML = '';

            document.getElementById('experienceModal').style.display = 'flex';
        }

        function editExperienceRecord(index) {
            // Validate index
            if (index < 0 || index >= userExperiences.length) {
                console.error('Invalid experience index:', index, 'userExperiences.length:', userExperiences.length);
                alert('Error: Could not find experience to edit. Please try refreshing the page.');
                return;
            }

            editingExperienceIndex = index;
            const exp = userExperiences[index];

            document.getElementById('experienceModalTitle').textContent = 'Edit Experience';

            // Populate basic fields (handle both field name formats)
            document.getElementById('expRole').value = exp.title || exp.role || '';
            document.getElementById('expOrganization').value = exp.company || exp.organizationName || '';
            document.getElementById('expLocation').value = exp.location || '';
            document.getElementById('expDescription').value = exp.description || '';

            // Handle dates
            if (exp.startDate) {
                const startDate = new Date(exp.startDate);
                document.getElementById('expStartMonth').value = String(startDate.getMonth() + 1).padStart(2, '0');
                document.getElementById('expStartYear').value = startDate.getFullYear();
            } else {
                document.getElementById('expStartMonth').value = '';
                document.getElementById('expStartYear').value = '';
            }

            if (exp.endDate) {
                const endDate = new Date(exp.endDate);
                document.getElementById('expEndMonth').value = String(endDate.getMonth() + 1).padStart(2, '0');
                document.getElementById('expEndYear').value = endDate.getFullYear();
                document.getElementById('expCurrentRole').checked = false;
                document.getElementById('expEndMonth').disabled = false;
                document.getElementById('expEndYear').disabled = false;
            } else {
                document.getElementById('expEndMonth').value = '';
                document.getElementById('expEndYear').value = '';
                document.getElementById('expCurrentRole').checked = true;
                document.getElementById('expEndMonth').disabled = true;
                document.getElementById('expEndYear').disabled = true;
            }

            // Populate technologies (normalize to object format)
            currentExperienceTechnologies = (exp.technologies || []).map(tech => {
                if (typeof tech === 'string') {
                    return { name: tech, type: 'Core' };
                }
                return tech;
            });
            renderTechnologies();

            // Populate skills (handle both field names)
            currentExperienceSkills = exp.keySkills || exp.skills || [];
            renderSkills();

            // Populate competencies
            currentExperienceCompetencies = exp.competencies || [];
            renderCompetencies();

            // Populate achievements
            currentExperienceAchievements = exp.achievements || [];
            renderAchievements();

            // Open the modal
            document.getElementById('experienceModal').style.display = 'flex';
        }

        function closeExperienceModal() {
            document.getElementById('experienceModal').style.display = 'none';
        }

        function toggleEndDate() {
            const checkbox = document.getElementById('expCurrentRole');
            const endMonthInput = document.getElementById('expEndMonth');
            const endYearInput = document.getElementById('expEndYear');

            endMonthInput.disabled = checkbox.checked;
            endYearInput.disabled = checkbox.checked;

            if (checkbox.checked) {
                endMonthInput.value = '';
                endYearInput.value = '';
            }
        }

        // Technology Management
        function addTechnology() {
            const nameInput = document.getElementById('expTechName');
            const typeSelect = document.getElementById('expTechType');
            const name = nameInput.value.trim();

            if (!name) return;

            currentExperienceTechnologies.push({
                name: name,
                type: typeSelect.value
            });

            nameInput.value = '';
            renderTechnologies();
        }

        function removeTechnology(index) {
            currentExperienceTechnologies.splice(index, 1);
            renderTechnologies();
        }

        function renderTechnologies() {
            const container = document.getElementById('expTechList');
            container.innerHTML = currentExperienceTechnologies.map((tech, index) => {
                // Handle both string and object formats
                const techName = typeof tech === 'string' ? tech : (tech.name || tech);
                const techType = typeof tech === 'object' && tech.type ? tech.type : 'Core';
                const bgColor = techType === 'Core' ? '#e3f2fd' : '#f5f5f7';
                const typeClass = techType.toLowerCase();

                return `
                    <span class="exp-tag ${typeClass}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: ${bgColor}; border-radius: 4px; font-size: 12px; font-family: var(--font-family-body);">
                        ${techName}
                        <i class="ph ph-x" onclick="removeTechnology(${index})" style="cursor: pointer; font-size: 14px; opacity: 0.6;"></i>
                    </span>
                `;
            }).join('');
        }

        // Skill Management
        function addSkill() {
            const nameInput = document.getElementById('expSkillName');
            const name = nameInput.value.trim();

            if (!name) return;

            currentExperienceSkills.push(name);
            nameInput.value = '';
            renderSkills();
        }

        function removeSkill(index) {
            currentExperienceSkills.splice(index, 1);
            renderSkills();
        }

        function renderSkills() {
            const container = document.getElementById('expSkillList');
            container.innerHTML = currentExperienceSkills.map((skill, index) => `
                <span class="exp-tag" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: #f5f5f7; border-radius: 4px; font-size: 12px; font-family: var(--font-family-body);">
                    ${skill}
                    <i class="ph ph-x" onclick="removeSkill(${index})" style="cursor: pointer; font-size: 14px; opacity: 0.6;"></i>
                </span>
            `).join('');
        }

        // Competency Management
        function addCompetency() {
            const nameInput = document.getElementById('expCompetencyName');
            const name = nameInput.value.trim();

            if (!name) return;

            currentExperienceCompetencies.push(name);
            nameInput.value = '';
            renderCompetencies();
        }

        function removeCompetency(index) {
            currentExperienceCompetencies.splice(index, 1);
            renderCompetencies();
        }

        function renderCompetencies() {
            const container = document.getElementById('expCompetencyList');
            container.innerHTML = currentExperienceCompetencies.map((comp, index) => `
                <span class="exp-tag" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: #f5f5f7; border-radius: 4px; font-size: 12px; font-family: var(--font-family-body);">
                    ${comp}
                    <i class="ph ph-x" onclick="removeCompetency(${index})" style="cursor: pointer; font-size: 14px; opacity: 0.6;"></i>
                </span>
            `).join('');
        }

        // Achievement Management
        function addAchievement() {
            const textInput = document.getElementById('expAchievementText');
            const text = textInput.value.trim();

            if (!text) return;

            currentExperienceAchievements.push(text);
            textInput.value = '';
            renderAchievements();
        }

        function removeAchievement(index) {
            currentExperienceAchievements.splice(index, 1);
            renderAchievements();
        }

        function renderAchievements() {
            const container = document.getElementById('expAchievementList');
            container.innerHTML = currentExperienceAchievements.map((achievement, index) => `
                <li style="display: flex; align-items: flex-start; gap: 8px; padding: 8px 12px; background: #f5f5f7; border-radius: 4px;">
                    <span style="flex: 1; font-family: var(--font-family-body); font-size: 13px; line-height: 1.5;">${achievement}</span>
                    <i class="ph ph-x" onclick="removeAchievement(${index})" style="cursor: pointer; font-size: 16px; opacity: 0.6; flex-shrink: 0;"></i>
                </li>
            `).join('');
        }

        // Save Experience
        function saveExperience() {
            const role = document.getElementById('expRole').value.trim();
            const organization = document.getElementById('expOrganization').value.trim();
            const location = document.getElementById('expLocation').value.trim();
            const description = document.getElementById('expDescription').value.trim();

            // Get date values from month/year pickers
            const startMonth = document.getElementById('expStartMonth').value;
            const startYear = document.getElementById('expStartYear').value;
            const endMonth = document.getElementById('expCurrentRole').checked ? '' : document.getElementById('expEndMonth').value;
            const endYear = document.getElementById('expCurrentRole').checked ? '' : document.getElementById('expEndYear').value;

            if (!role || !organization) {
                alert('Please fill in the required fields: Role and Organization Name');
                return;
            }

            // Convert month/year to ISO date format
            const startDateISO = (startMonth && startYear) ? `${startYear}-${startMonth}-01` : '';
            const endDateISO = (endMonth && endYear) ? `${endYear}-${endMonth}-01` : '';

            const experience = {
                role: role,
                organizationName: organization,
                location: location,
                startDate: startDateISO,
                endDate: endDateISO,
                description: description,
                technologies: currentExperienceTechnologies,
                keySkills: currentExperienceSkills,
                competencies: currentExperienceCompetencies,
                achievements: currentExperienceAchievements,
                projectTypes: [],
                internalStakeholders: [],
                externalStakeholders: []
            };

            if (editingExperienceIndex === -1) {
                // Adding new experience
                userExperiences.push(experience);
            } else {
                // Editing existing experience
                userExperiences[editingExperienceIndex] = experience;
            }

            saveUserExperiences();
            loadCareerExperiences();
            updateExperienceCount(userExperiences.length);
            updateBadgesOnly(); // FIXED: Use selective badge update instead of full re-render
            closeExperienceModal();
        }

        function deleteExperienceRecord(index) {
            if (confirm('Are you sure you want to delete this experience?')) {
                userExperiences.splice(index, 1);
                saveUserExperiences();
                loadCareerExperiences();
                updateExperienceCount(userExperiences.length);
                updateBadgesOnly(); // FIXED: Use selective badge update instead of full re-render
            }
        }

        function connectLinkedIn() {
            alert('LinkedIn integration coming soon! This will allow you to import your work experience directly from your LinkedIn profile.');
        }

        function uploadResume() {
            alert('Resume upload coming soon! This will parse your resume and automatically extract your work experience, skills, and achievements.');
        }

        // Application Materials Management
        let userApplicationMaterials = [];
        let editingMaterialIndex = -1;

        // Example application materials for each persona
        const exampleApplicationMaterials = {
            'retail-manager': [
                {
                    type: 'Resume',
                    title: 'Cloud Operations Resume',
                    jobOpportunity: 'Cloud Operations Engineer - TechCorp',
                    content: 'Experienced retail operations manager with 5+ years managing store operations, inventory systems, and teams of 15-30 employees. Strong background in data analysis using Excel and Power BI. Seeking to transition technical operations and cloud infrastructure management skills.',
                    format: 'PDF',
                    atsOptimized: true,
                    createdDate: '2024-09-15',
                    isExample: true
                },
                {
                    type: 'Cover Letter',
                    title: 'Cloud Operations Cover Letter',
                    jobOpportunity: 'Cloud Operations Engineer - TechCorp',
                    content: 'Dear Hiring Manager,\n\nI am writing to express my strong interest in the Cloud Operations Engineer position at TechCorp. While my professional background is in retail management, I have developed a strong foundation in technical operations, data analysis, and system optimization that directly translates to cloud operations.\n\nIn my role as Store Manager at RetailMart, I successfully managed complex operational systems including POS infrastructure, inventory management systems, and business analytics platforms. I taught myself Excel, Power BI, and basic SQL to build automated reporting dashboards that reduced manual reporting time by 90% and improved inventory accuracy from 83% to 94%.\n\nMy experience managing 24/7 retail operations has given me deep expertise in incident response, system monitoring, and maintaining high availability - all critical skills for cloud operations. I\'m comfortable working under pressure during peak periods and have consistently maintained 99.5%+ system uptime even during our busiest seasons.\n\nI am currently completing AWS Cloud Practitioner and Solutions Architect Associate certifications to formalize my cloud knowledge. I\'m excited about the opportunity to bring my operational excellence, problem-solving skills, and commitment to reliability to TechCorp\'s cloud infrastructure team.\n\nThank you for considering my application.\n\nSincerely,\n[Your Name]',
                    format: 'DOCX',
                    atsOptimized: true,
                    createdDate: '2024-09-15',
                    isExample: true
                },
                {
                    type: 'Email',
                    title: 'Networking Email to TechCorp Cloud Engineer',
                    jobOpportunity: 'Cloud Operations Engineer - TechCorp',
                    content: 'Subject: Retail Manager → Cloud Operations: Seeking Advice\n\nHi [Name],\n\nI found your profile while researching Cloud Operations Engineers at TechCorp and was impressed by your career path. I\'m currently a Store Manager at RetailMart looking to transition into cloud operations, and I\'d love to learn from your experience.\n\nI\'ve been managing 24/7 retail operations for 5 years, including POS systems, inventory management, and analytics platforms. I\'ve taught myself data analysis (Excel, Power BI, SQL) and am currently studying for AWS certifications. I believe my operational experience and technical aptitude would translate well to cloud operations.\n\nWould you be open to a brief 15-minute call to share your insights on making a similar transition? I\'d love to hear about the skills that matter most in your role and any advice you have for someone with my background.\n\nI understand you\'re busy - even a few sentences via email would be incredibly helpful!\n\nThank you for considering,\n[Your Name]',
                    format: 'HTML',
                    atsOptimized: false,
                    createdDate: '2024-09-16',
                    isExample: true
                }
            ],
            'chemist': [
                {
                    type: 'Resume',
                    title: 'Cloud Computing Resume',
                    jobOpportunity: 'Cloud Solutions Architect - CloudVendor',
                    content: 'Senior Chemist with 4+ years pharmaceutical R&D experience and strong computational background. Extensive experience with scientific computing, data analysis (Python, R), and laboratory automation systems. Seeking to apply analytical rigor and technical expertise to cloud architecture and solutions design.',
                    format: 'PDF',
                    atsOptimized: true,
                    createdDate: '2024-09-12',
                    isExample: true
                },
                {
                    type: 'Cover Letter',
                    title: 'Cloud Architect Cover Letter',
                    jobOpportunity: 'Cloud Solutions Architect - CloudVendor',
                    content: 'Dear Hiring Manager,\n\nI am excited to apply for the Cloud Solutions Architect position at CloudVendor. As a Senior Chemist with extensive experience in computational chemistry and scientific data analysis, I bring a unique combination of analytical thinking, technical depth, and problem-solving skills that translate directly to cloud architecture.\n\nIn my current role at PharmaCorp, I regularly work with large-scale computational workflows processing terabytes of experimental data. I\'ve designed and optimized data pipelines using Python and R, integrated multiple scientific software platforms, and troubleshot complex system performance issues - experiences that mirror the challenges cloud architects face when designing scalable solutions.\n\nMy work has required me to deeply understand distributed computing concepts, resource optimization, and system reliability. When our lab needed to process 10x more molecular simulations for a critical drug discovery project, I architected a workflow that reduced processing time from 3 weeks to 4 days by optimizing parallelization and resource allocation.\n\nI\'ve been systematically building cloud expertise through AWS Solutions Architect certification coursework and hands-on personal projects deploying containerized applications, implementing CI/CD pipelines, and designing multi-tier architectures on AWS.\n\nI\'m eager to bring my analytical rigor, systems thinking, and technical aptitude to help CloudVendor\'s customers design robust, scalable cloud solutions.\n\nThank you for your consideration.\n\nBest regards,\n[Your Name]',
                    format: 'DOCX',
                    atsOptimized: true,
                    createdDate: '2024-09-12',
                    isExample: true
                },
                {
                    type: 'Email',
                    title: 'Cold Outreach to CloudVendor Recruiter',
                    jobOpportunity: 'Cloud Solutions Architect - CloudVendor',
                    content: 'Subject: PhD Chemist → Cloud Solutions Architect: Non-Traditional Background\n\nHi [Recruiter Name],\n\nI\'m reaching out regarding the Cloud Solutions Architect role at CloudVendor (Job #12345). I know my resume shows "Senior Chemist" rather than traditional cloud experience, but I believe my technical background positions me uniquely well for this role.\n\nIn pharmaceutical R&D, I\'ve spent 4+ years designing computational workflows for large-scale data analysis, optimizing distributed computing systems, and troubleshooting complex multi-system integrations - skills that map directly to cloud architecture challenges. I\'m proficient in Python, Linux, Git, and containerization, and I\'m completing my AWS Solutions Architect Associate certification.\n\nI\'ve successfully delivered multiple projects requiring systems thinking and technical depth:\n- Architected data pipeline processing 2TB+ datasets, reducing compute time 75%\n- Integrated 5+ scientific software platforms with automated workflows\n- Led cross-functional teams through technical troubleshooting and optimization\n\nI understand this is a non-traditional background, but I\'m confident my analytical rigor, technical aptitude, and problem-solving approach would bring value to CloudVendor\'s solutions architecture team. Would you be open to a brief conversation to discuss how my experience translates to cloud architecture?\n\nI\'ve attached my resume highlighting the technical parallels. Thank you for considering a candidate with a different path into tech!\n\nBest,\n[Your Name]',
                    format: 'TXT',
                    atsOptimized: false,
                    createdDate: '2024-09-13',
                    isExample: true
                }
            ],
            'new-graduate': [
                {
                    type: 'Resume',
                    title: 'Full Stack Developer Resume',
                    jobOpportunity: 'Junior Full Stack Developer - StartupCo',
                    content: 'Recent Computer Science graduate with strong full-stack development skills and 3 internship experiences. Proficient in React, Node.js, Python, and cloud platforms. Built 5+ personal projects including e-commerce platform and social media dashboard. Seeking entry-level full stack role to apply technical skills and continue learning.',
                    format: 'PDF',
                    atsOptimized: true,
                    createdDate: '2024-09-20',
                    isExample: true
                },
                {
                    type: 'Cover Letter',
                    title: 'Junior Developer Cover Letter',
                    jobOpportunity: 'Junior Full Stack Developer - StartupCo',
                    content: 'Dear Hiring Manager,\n\nI am excited to apply for the Junior Full Stack Developer position at StartupCo. As a recent Computer Science graduate with internship experience and a portfolio of personal projects, I am eager to contribute to your engineering team while continuing to grow my technical skills.\n\nDuring my Software Engineering Internship at TechStart Inc., I contributed to a React-based customer portal serving 10,000+ users. I implemented responsive UI components, integrated RESTful APIs, and wrote comprehensive test suites - resulting in a 20% reduction in reported bugs. This experience taught me the importance of code quality, user-centric design, and collaborative development.\n\nBeyond coursework and internships, I\'ve built several full-stack projects to deepen my skills:\n- E-commerce platform with React frontend, Node.js backend, and PostgreSQL database\n- Real-time chat application using WebSockets and Redis\n- Personal portfolio website with blog CMS (Next.js, Tailwind CSS)\n\nI\'m particularly drawn to StartupCo\'s mission to [mission] and your tech stack. I\'m proficient in React, Node.js, Python, and PostgreSQL, and I\'m comfortable learning new technologies quickly. I\'m excited about the opportunity to work on challenging problems, learn from experienced engineers, and contribute to meaningful products.\n\nThank you for considering my application. I look forward to the opportunity to discuss how I can contribute to StartupCo\'s success.\n\nBest regards,\n[Your Name]',
                    format: 'DOCX',
                    atsOptimized: true,
                    createdDate: '2024-09-20',
                    isExample: true
                },
                {
                    type: 'Email',
                    title: 'Follow-up After Career Fair',
                    jobOpportunity: 'Junior Full Stack Developer - StartupCo',
                    content: 'Subject: Following Up - CS Grad Interested in Junior Full Stack Role\n\nHi [Recruiter Name],\n\nIt was great meeting you at the Tech Career Fair yesterday! I enjoyed learning about StartupCo\'s product roadmap and engineering culture. Your comments about prioritizing code quality and mentorship really resonated with me.\n\nAs mentioned, I\'m a recent CS graduate actively seeking junior full stack roles. I have:\n- 3 internships (including 6-month SWE internship at TechStart Inc.)\n- Strong skills in React, Node.js, Python, PostgreSQL\n- Portfolio of 5+ personal projects demonstrating full-stack capabilities\n- Genuine excitement about building user-focused products\n\nI\'ve attached my resume and would love to continue the conversation about how I could contribute to your team. I\'m particularly interested in the Junior Full Stack Developer role I saw posted on your careers page.\n\nWould you be open to scheduling a brief call next week to discuss the role and answer any questions about my background?\n\nThank you again for your time at the fair!\n\nBest,\n[Your Name]\n\nPortfolio: [URL]\nGitHub: [URL]\nLinkedIn: [URL]',
                    format: 'HTML',
                    atsOptimized: false,
                    createdDate: '2024-09-21',
                    isExample: true
                }
            ],
            'data-analyst': [
                {
                    type: 'Resume',
                    title: 'Data Analyst Resume',
                    jobOpportunity: 'Senior Data Analyst - DataCorp',
                    content: 'Data Analyst with 3+ years experience in business intelligence, data visualization, and analytics. Proficient in SQL, Python, Tableau, and Power BI. Track record of delivering actionable insights that drove business decisions and revenue growth. Seeking senior analyst role to tackle complex analytical challenges.',
                    format: 'PDF',
                    atsOptimized: true,
                    createdDate: '2024-09-18',
                    isExample: true
                },
                {
                    type: 'Cover Letter',
                    title: 'Senior Analyst Cover Letter',
                    jobOpportunity: 'Senior Data Analyst - DataCorp',
                    content: 'Dear Hiring Manager,\n\nI am writing to express my strong interest in the Senior Data Analyst position at DataCorp. With over 3 years of experience delivering business-critical analytics and a proven track record of turning data into actionable insights, I am excited about the opportunity to contribute to your data team.\n\nIn my current role as BI Analyst at TechCorp, I\'ve consistently delivered high-impact analytical projects:\n- Built customer churn prediction model (78% accuracy) that reduced churn from 8% to 5.5%, saving $200K ARR\n- Automated executive reporting pipeline, reducing manual effort from 20 hours to 30 minutes monthly\n- Designed self-service analytics dashboards that democratized data access for 100+ employees\n- Collaborated cross-functionally with Product, Sales, and Customer Success to drive data-informed decisions\n\nI\'m proficient in the full analytics stack: SQL for data extraction and transformation, Python (pandas, scikit-learn) for advanced analysis and modeling, and Tableau/Power BI for visualization and storytelling. More importantly, I understand that great analysis requires both technical skills and business acumen - the ability to ask the right questions, identify meaningful patterns, and communicate insights effectively to non-technical stakeholders.\n\nI\'m particularly excited about DataCorp\'s focus on [specific aspect] and the opportunity to work with [specific technologies/data]. I\'m confident my analytical skills, business mindset, and collaborative approach would make me a strong addition to your team.\n\nThank you for considering my application. I look forward to discussing how I can contribute to DataCorp\'s success.\n\nBest regards,\n[Your Name]',
                    format: 'DOCX',
                    atsOptimized: true,
                    createdDate: '2024-09-18',
                    isExample: true
                },
                {
                    type: 'Email',
                    title: 'Referral Request from Former Colleague',
                    jobOpportunity: 'Senior Data Analyst - DataCorp',
                    content: 'Subject: Quick Favor - DataCorp Senior Analyst Referral?\n\nHey [Former Colleague],\n\nI hope you\'re doing well at DataCorp! I saw you\'ve been there about 6 months now - how are you liking it?\n\nI\'m reaching out because I\'m actively looking for my next role, and I noticed DataCorp has a Senior Data Analyst position open that looks like a great fit for my background. Given that we worked together at TechCorp and you know my analytical skills firsthand, I was hoping you might be willing to refer me?\n\nQuick reminder of what I bring to the table:\n- 3+ years BI/analytics experience\n- Strong SQL, Python, Tableau skills\n- Track record of high-impact projects (churn model, reporting automation, etc.)\n- Collaborative cross-functional approach\n\nI know referrals can be a big ask, so totally understand if the timing isn\'t right. But if you\'d be comfortable putting in a good word, I\'d really appreciate it! I\'ve attached my resume if that helps.\n\nEither way, would love to catch up sometime - it\'s been too long!\n\nThanks for considering,\n[Your Name]',
                    format: 'TXT',
                    atsOptimized: false,
                    createdDate: '2024-09-19',
                    isExample: true
                }
            ]
        };

        function loadUserApplicationMaterials() {
            const stored = localStorage.getItem(`applicationMaterials_${currentPersona}`);
            userApplicationMaterials = stored ? JSON.parse(stored) : [];
        }

        function saveUserApplicationMaterials() {
            localStorage.setItem(`applicationMaterials_${currentPersona}`, JSON.stringify(userApplicationMaterials));
        }

        function openApplicationMaterialsSlideout() {
            loadUserApplicationMaterials();
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');
            const applicationMaterialsContent = document.getElementById('applicationMaterialsContent');

            titleEl.textContent = 'Application Materials';

            // Hide all content sections
            hideAllContentSections();

            // Show application materials content
            applicationMaterialsContent.style.display = 'flex';
            loadApplicationMaterials();

            slideout.classList.add('active');
        }

        function loadApplicationMaterials() {
            const container = document.getElementById('materialsContainer');
            const exampleMaterials = exampleApplicationMaterials[currentPersona] || [];
            const allMaterials = [...userApplicationMaterials, ...exampleMaterials];

            if (allMaterials.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px 20px;">No application materials yet. Click Generate or Upload to add materials.</p>';
                return;
            }

            container.innerHTML = allMaterials.map((material, index) => {
                const isUserMaterial = index < userApplicationMaterials.length;
                const typeColors = {
                    'Resume': '#0066CC',
                    'Cover Letter': '#004C99',
                    'Email': '#1a1a1a'
                };
                const typeColor = typeColors[material.type] || '#666';

                return `
                    <div class="story-card" style="opacity: ${material.isExample ? '0.7' : '1'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                    <span style="background: ${typeColor}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap;">
                                        ${material.type}
                                    </span>
                                    <span style="background: #f5f5f7; color: #666; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">
                                        ${material.format}
                                    </span>
                                    ${material.atsOptimized ? '<span style="background: #e3f2fd; color: #0066CC; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">ATS Optimized</span>' : ''}
                                    ${material.isExample ? '<span style="background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;">Example</span>' : ''}
                                </div>
                                <h4 style="margin: 0 0 4px 0; color: #1a1a1a; font-size: 15px; font-weight: 600;">${material.title}</h4>
                                ${material.jobOpportunity ? `<p style="margin: 0 0 8px 0; color: #666; font-size: 12px;">For: ${material.jobOpportunity}</p>` : ''}
                                <p style="margin: 0; color: #999; font-size: 11px;">Created: ${material.createdDate}</p>
                            </div>
                            ${isUserMaterial ? `
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="downloadMaterial(${index})" style="padding: 6px 10px; background: #f5f5f7; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #666; font-weight: 600;">
                                        <i class="ph ph-download-simple"></i> Download
                                    </button>
                                    <button onclick="deleteMaterial(${index})" style="padding: 6px 10px; background: #fee; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #c33; font-weight: 600;">
                                        <i class="ph ph-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e5e7;">
                            <p style="margin: 0; color: #666; font-size: 13px; line-height: 1.5; max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                ${material.content.substring(0, 200)}${material.content.length > 200 ? '...' : ''}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateMaterial() {
            // Create modal for generation options
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

            const jobOpps = exampleJobOpportunities[currentPersona] || [];
            const jobOptions = jobOpps.map((job, i) => `<option value="${i}">${job.title} - ${job.company}</option>`).join('');

            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; font-family: Questrial, sans-serif; color: #1a1a1a;">Generate Application Material</h3>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #333;">Material Type</label>
                        <select id="materialType" style="width: 100%; padding: 10px; border: 1px solid #e5e5e7; border-radius: 4px; font-family: Barlow, sans-serif; font-size: 14px;">
                            <option value="Resume">Resume</option>
                            <option value="Cover Letter">Cover Letter</option>
                            <option value="Email">Email</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #333;">Job Opportunity</label>
                        <select id="jobOpportunity" style="width: 100%; padding: 10px; border: 1px solid #e5e5e7; border-radius: 4px; font-family: Barlow, sans-serif; font-size: 14px;">
                            <option value="">Select a job opportunity...</option>
                            ${jobOptions}
                        </select>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #333;">Output Format</label>
                        <select id="outputFormat" style="width: 100%; padding: 10px; border: 1px solid #e5e5e7; border-radius: 4px; font-family: Barlow, sans-serif; font-size: 14px;">
                            <option value="PDF">PDF</option>
                            <option value="DOCX">DOCX (Word)</option>
                            <option value="HTML">HTML</option>
                            <option value="MD">Markdown</option>
                            <option value="TXT">Plain Text</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="atsOptimized" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 13px; font-weight: 600; color: #333;">ATS Optimized (Applicant Tracking System)</span>
                        </label>
                        <p style="margin: 4px 0 0 26px; font-size: 12px; color: #666;">Formats the document for better parsing by automated hiring systems</p>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="padding: 10px 20px; background: #f5f5f7; border: none; border-radius: 6px; cursor: pointer; font-family: Questrial, sans-serif; font-size: 14px; font-weight: 600; color: #666;">
                            Cancel
                        </button>
                        <button onclick="executeGenerate(this)" style="padding: 10px 20px; background: #0066CC; border: none; border-radius: 6px; cursor: pointer; font-family: Questrial, sans-serif; font-size: 14px; font-weight: 600; color: white;">
                            <i class="ph ph-sparkle"></i> Generate
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function executeGenerate(button) {
            const modal = button.closest('div[style*="position: fixed"]');
            const materialType = document.getElementById('materialType').value;
            const jobOppIndex = document.getElementById('jobOpportunity').value;
            const outputFormat = document.getElementById('outputFormat').value;
            const atsOptimized = document.getElementById('atsOptimized').checked;

            if (!jobOppIndex) {
                alert('Please select a job opportunity');
                return;
            }

            const jobOpps = exampleJobOpportunities[currentPersona] || [];
            const selectedJob = jobOpps[jobOppIndex];
            const jobTitle = `${selectedJob.title} - ${selectedJob.company}`;

            // Simulate generation (in real implementation, this would call an API)
            const newMaterial = {
                type: materialType,
                title: `${materialType} for ${selectedJob.company}`,
                jobOpportunity: jobTitle,
                content: `Generated ${materialType.toLowerCase()} for ${jobTitle}. This would contain the actual generated content based on your career experience and the job requirements.`,
                format: outputFormat,
                atsOptimized: atsOptimized,
                createdDate: new Date().toISOString().split('T')[0],
                isExample: false
            };

            userApplicationMaterials.push(newMaterial);
            saveUserApplicationMaterials();
            loadApplicationMaterials();
            updateBadgesOnly();
            modal.remove();

            alert(`${materialType} generated successfully! In a full implementation, this would use AI to generate a customized ${materialType.toLowerCase()} based on your experience and the job requirements.`);
        }

        function uploadMaterial() {
            alert('Upload functionality coming soon! This will allow you to upload existing resumes, cover letters, and other application materials in various formats (PDF, DOCX, TXT, etc.).');
        }

        function downloadMaterial(index) {
            const material = userApplicationMaterials[index];
            alert(`Download ${material.title} as ${material.format}\n\nIn a full implementation, this would download the material in the selected format.`);
        }

        function deleteMaterial(index) {
            if (confirm('Are you sure you want to delete this application material?')) {
                userApplicationMaterials.splice(index, 1);
                saveUserApplicationMaterials();
                loadApplicationMaterials();
                updateBadgesOnly();
            }
        }

        // ========================================
        // Goals Functions
        // ========================================

        let userGoals = [];
        let currentGoalIndex = null;

        function loadUserGoals() {
            const stored = localStorage.getItem(`userGoals_${currentPersona}`);
            userGoals = stored ? JSON.parse(stored) : [];
        }

        function saveUserGoals() {
            localStorage.setItem(`userGoals_${currentPersona}`, JSON.stringify(userGoals));
            updateGoalsCount(userGoals.length);
            // FIXED: Use selective badge update instead of full re-rendering
            updateBadgesOnly();
        }

        function openGoalsSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');
                const goalsContent = document.getElementById('goalsContent');

                titleEl.textContent = 'Career Goals';

                // Hide all content sections
                hideAllContentSections();

                // Show goals content
                goalsContent.style.display = 'flex';

                loadGoals();
            });
        }

        function loadGoals() {
            const container = document.getElementById('goalsContainer');
            container.innerHTML = '';

            loadUserGoals();
            updateGoalsCount(userGoals.length);
            updateBadgesOnly(); // FIXED: Use selective badge update instead of full re-render

            if (userGoals.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-target" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No career goals yet. Click "Add Goal" to create a SMART goal for your career development.</p>
                    </div>
                `;
                return;
            }

            // Sort goals by target date (soonest first)
            const sortedGoals = [...userGoals].sort((a, b) => {
                const dateA = a.targetDate || '9999-12-31';
                const dateB = b.targetDate || '9999-12-31';
                return dateA.localeCompare(dateB);
            });

            sortedGoals.forEach((goal, index) => {
                // Find original index
                const originalIndex = userGoals.findIndex(g => g === goal);

                const targetDate = goal.targetDate ? new Date(goal.targetDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'No deadline';

                // Calculate days until target
                const daysUntil = goal.targetDate ? Math.ceil((new Date(goal.targetDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                const isOverdue = daysUntil !== null && daysUntil < 0;
                const isUpcoming = daysUntil !== null && daysUntil >= 0 && daysUntil <= 30;

                // Status color coding
                const statusColors = {
                    'Not Started': '#666666',
                    'In Progress': '#0066CC',
                    'On Hold': '#ff9800',
                    'Completed': '#16a34a'
                };

                const card = document.createElement('div');
                card.className = 'experience-card';
                card.style.borderLeft = `4px solid ${statusColors[goal.status] || '#666666'}`;

                card.innerHTML = `
                    <div class="experience-card-header">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div class="exp-title">${escapeHtml(goal.title)}</div>
                                <span style="padding: 2px 8px; background: ${statusColors[goal.status] || '#666666'}; color: white; border-radius: 12px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600;">${escapeHtml(goal.status)}</span>
                                ${goal.category ? `<span style="padding: 2px 8px; background: #e3f2fd; color: var(--color-primary-blue); border-radius: 12px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600;">${escapeHtml(goal.category)}</span>` : ''}
                            </div>
                            <div class="exp-dates">
                                <i class="ph ph-calendar"></i> Target: ${targetDate}
                                ${isOverdue ? `<span style="color: #dc2626; font-weight: 600; margin-left: 8px;">⚠ Overdue by ${Math.abs(daysUntil)} days</span>` : ''}
                                ${isUpcoming ? `<span style="color: #ff9800; font-weight: 600; margin-left: 8px;">⏰ Due in ${daysUntil} days</span>` : ''}
                            </div>
                        </div>
                        <div class="story-actions">
                            <button class="story-action-btn" onclick="editGoal(${originalIndex})" title="Edit">
                                <i class="ph ph-pencil-simple"></i>
                            </button>
                            <button class="story-action-btn delete" onclick="deleteGoal(${originalIndex})" title="Delete">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    ${goal.progress !== undefined ? `
                        <div style="margin: 12px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark);">Progress</span>
                                <span style="font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-primary-blue);">${goal.progress}%</span>
                            </div>
                            <div style="height: 8px; background: #e5e5e7; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${goal.progress}%; background: ${statusColors[goal.status] || '#0066CC'}; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Notes Section Only -->
                    ${goal.notes ? `
                        <div class="exp-section" style="margin-top: 12px;">
                            <div class="exp-section-label">Notes</div>
                            <div class="exp-description">${escapeHtml(goal.notes)}</div>
                        </div>
                    ` : ''}
                `;

                container.appendChild(card);
            });
        }

        function addGoal() {
            currentGoalIndex = null;
            document.getElementById('goalModalTitle').textContent = 'Add SMART Goal';
            document.getElementById('goalForm').reset();
            document.getElementById('goalProgressValue').textContent = '0';
            document.getElementById('goalModal').style.display = 'flex';
        }

        function editGoal(index) {
            currentGoalIndex = index;
            const goal = userGoals[index];

            document.getElementById('goalModalTitle').textContent = 'Edit SMART Goal';
            document.getElementById('goalTitle').value = goal.title || '';
            document.getElementById('goalCategory').value = goal.category || 'Career Development';
            document.getElementById('goalSpecific').value = goal.specific || '';
            document.getElementById('goalMeasurable').value = goal.measurable || '';
            document.getElementById('goalAchievable').value = goal.achievable || '';
            document.getElementById('goalRelevant').value = goal.relevant || '';
            document.getElementById('goalTargetDate').value = goal.targetDate || '';
            document.getElementById('goalStatus').value = goal.status || 'Not Started';
            document.getElementById('goalProgress').value = goal.progress || 0;
            document.getElementById('goalProgressValue').textContent = goal.progress || 0;
            document.getElementById('goalNotes').value = goal.notes || '';

            document.getElementById('goalModal').style.display = 'flex';
        }

        function closeGoalModal() {
            document.getElementById('goalModal').style.display = 'none';
            currentGoalIndex = null;
        }

        function saveGoal() {
            const title = document.getElementById('goalTitle').value.trim();

            if (!title) {
                alert('Please enter a goal title.');
                return;
            }

            const goalData = {
                title,
                category: document.getElementById('goalCategory').value,
                specific: document.getElementById('goalSpecific').value.trim(),
                measurable: document.getElementById('goalMeasurable').value.trim(),
                achievable: document.getElementById('goalAchievable').value.trim(),
                relevant: document.getElementById('goalRelevant').value.trim(),
                targetDate: document.getElementById('goalTargetDate').value,
                status: document.getElementById('goalStatus').value,
                progress: parseInt(document.getElementById('goalProgress').value),
                notes: document.getElementById('goalNotes').value.trim(),
                createdDate: currentGoalIndex === null ? new Date().toISOString() : (userGoals[currentGoalIndex].createdDate || new Date().toISOString()),
                modifiedDate: new Date().toISOString()
            };

            if (currentGoalIndex === null) {
                userGoals.push(goalData);
            } else {
                userGoals[currentGoalIndex] = goalData;
            }

            saveUserGoals();
            loadGoals();
            closeGoalModal();
        }

        function deleteGoal(index) {
            if (!confirm('Are you sure you want to delete this goal?')) return;

            userGoals.splice(index, 1);
            saveUserGoals();
            loadGoals();
        }

        // ========================================
        // Portfolio Functions
        // ========================================

        let userPortfolioProjects = [];
        let currentPortfolioIndex = null;
        let currentPortfolioTechnologies = [];
        let currentPortfolioSkills = [];
        let currentPortfolioCompetencies = [];

        function loadUserPortfolio() {
            const stored = localStorage.getItem(`userPortfolio_${currentPersona}`);
            userPortfolioProjects = stored ? JSON.parse(stored) : [];
        }

        function saveUserPortfolio() {
            localStorage.setItem(`userPortfolio_${currentPersona}`, JSON.stringify(userPortfolioProjects));
            updatePortfolioCount(userPortfolioProjects.length);
            // FIXED: Use selective badge update instead of full re-rendering
            updateBadgesOnly();
        }

        function openPortfolioSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');
                const portfolioContent = document.getElementById('portfolioContent');

                titleEl.textContent = 'Portfolio';

                // Hide all content sections
                hideAllContentSections();

                // Show portfolio content
                portfolioContent.style.display = 'flex';

                loadPortfolio();
            });
        }

        function loadPortfolio() {
            const container = document.getElementById('portfolioContainer');
            container.innerHTML = '';

            loadUserPortfolio();
            updatePortfolioCount(userPortfolioProjects.length);
            updateBadgesOnly(); // FIXED: Use selective badge update instead of full re-render

            if (userPortfolioProjects.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-folder-open" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-ui); font-size: 15px;">No portfolio projects yet. Click "Add Project" to showcase your work.</p>
                    </div>
                `;
                return;
            }

            // Sort projects by creation date (newest first)
            const sortedProjects = [...userPortfolioProjects].sort((a, b) => {
                const dateA = a.createdDate || '0';
                const dateB = b.createdDate || '0';
                return dateB.localeCompare(dateA);
            });

            sortedProjects.forEach((project, index) => {
                // Find original index
                const originalIndex = userPortfolioProjects.findIndex(p => p === project);

                // Count ALL assets linked to this portfolio project
                const storedWb = localStorage.getItem(`whiteboards_${currentPersona}`);
                const allWhiteboards = storedWb ? JSON.parse(storedWb) : [];

                const storedDg = localStorage.getItem(`diagrams_${currentPersona}`);
                const allDiagrams = storedDg ? JSON.parse(storedDg) : [];

                const storedDc = localStorage.getItem(`interview_documents_${currentPersona}`);
                const allDocuments = storedDc ? JSON.parse(storedDc) : [];

                const storedMd = localStorage.getItem(`markdown_${currentPersona}`);
                const allMarkdown = storedMd ? JSON.parse(storedMd) : [];

                const storedCode = localStorage.getItem(`code_${currentPersona}`);
                const allCode = storedCode ? JSON.parse(storedCode) : [];

                const storedPuml = localStorage.getItem(`plantuml_${currentPersona}`);
                const allPlantUML = storedPuml ? JSON.parse(storedPuml) : [];

                const storedMermaid = localStorage.getItem(`mermaid_${currentPersona}`);
                const allMermaid = storedMermaid ? JSON.parse(storedMermaid) : [];

                // Count all linked assets
                const linkedAssets = [
                    ...allWhiteboards,
                    ...allDiagrams,
                    ...allDocuments,
                    ...allMarkdown,
                    ...allCode,
                    ...allPlantUML,
                    ...allMermaid
                ].filter(asset =>
                    asset.linkedType === 'portfolio' &&
                    asset.linkedId === (project.id || project.name)
                );

                const card = document.createElement('div');
                card.className = 'experience-card';

                card.innerHTML = `
                    <div class="experience-card-header">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div class="exp-title">${escapeHtml(project.name)}</div>
                                ${project.link ? `<a href="${escapeHtml(project.link)}" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; padding: 2px 8px; background: #e3f2fd; color: var(--color-primary-blue); border-radius: 12px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; text-decoration: none; transition: all 0.2s;" onmouseover="this.style.background='var(--color-primary-blue)'; this.style.color='white';" onmouseout="this.style.background='#e3f2fd'; this.style.color='var(--color-primary-blue)';"><i class="ph ph-arrow-square-out" style="font-size: 12px; margin-right: 4px;"></i>View</a>` : ''}
                                ${linkedAssets.length > 0 ? `<span onclick="openAssetsFilteredByPortfolio('${project.id || project.name}')" style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #f0fdf4; border-radius: 12px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: #16a34a; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#16a34a'; this.style.color='white';" onmouseout="this.style.background='#f0fdf4'; this.style.color='#16a34a';" title="Click to view ${linkedAssets.length} asset${linkedAssets.length === 1 ? '' : 's'} for this portfolio item"><i class="ph ph-folder-open" style="font-size: 12px;"></i>${linkedAssets.length}</span>` : ''}
                            </div>
                        </div>
                        <div class="story-actions">
                            <button class="story-action-btn" onclick="editPortfolioProject(${originalIndex})" title="Edit">
                                <i class="ph ph-pencil-simple"></i>
                            </button>
                            <button class="story-action-btn delete" onclick="deletePortfolioProject(${originalIndex})" title="Delete">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>

                    ${project.description ? `<div class="exp-description">${escapeHtml(project.description)}</div>` : ''}
                `;

                container.appendChild(card);
            });
        }

        function addPortfolioProject() {
            currentPortfolioIndex = null;
            currentPortfolioTechnologies = [];
            currentPortfolioSkills = [];
            currentPortfolioCompetencies = [];

            document.getElementById('portfolioModalTitle').textContent = 'Add Portfolio Project';
            document.getElementById('portfolioForm').reset();
            renderPortfolioTechnologies();
            renderPortfolioSkills();
            renderPortfolioCompetencies();
            document.getElementById('portfolioModal').style.display = 'flex';
        }

        function editPortfolioProject(index) {
            currentPortfolioIndex = index;
            const project = userPortfolioProjects[index];

            document.getElementById('portfolioModalTitle').textContent = 'Edit Portfolio Project';
            document.getElementById('portfolioName').value = project.name || '';
            document.getElementById('portfolioLink').value = project.link || '';
            document.getElementById('portfolioDescription').value = project.description || '';

            currentPortfolioTechnologies = project.technologies || [];
            currentPortfolioSkills = project.skills || [];
            currentPortfolioCompetencies = project.competencies || [];

            renderPortfolioTechnologies();
            renderPortfolioSkills();
            renderPortfolioCompetencies();

            document.getElementById('portfolioModal').style.display = 'flex';
        }

        function closePortfolioModal() {
            document.getElementById('portfolioModal').style.display = 'none';
            currentPortfolioIndex = null;
        }

        function savePortfolioProject() {
            const name = document.getElementById('portfolioName').value.trim();

            if (!name) {
                alert('Please enter a project name.');
                return;
            }

            const projectData = {
                id: currentPortfolioIndex === null ? `portfolio_${Date.now()}` : (userPortfolioProjects[currentPortfolioIndex].id || `portfolio_${Date.now()}`),
                name,
                link: document.getElementById('portfolioLink').value.trim(),
                description: document.getElementById('portfolioDescription').value.trim(),
                technologies: currentPortfolioTechnologies,
                skills: currentPortfolioSkills,
                competencies: currentPortfolioCompetencies,
                createdDate: currentPortfolioIndex === null ? new Date().toISOString() : (userPortfolioProjects[currentPortfolioIndex].createdDate || new Date().toISOString()),
                modifiedDate: new Date().toISOString()
            };

            if (currentPortfolioIndex === null) {
                userPortfolioProjects.push(projectData);
            } else {
                userPortfolioProjects[currentPortfolioIndex] = projectData;
            }

            saveUserPortfolio();
            loadPortfolio();
            closePortfolioModal();
        }

        function deletePortfolioProject(index) {
            if (!confirm('Are you sure you want to delete this portfolio project?')) return;

            userPortfolioProjects.splice(index, 1);
            saveUserPortfolio();
            loadPortfolio();
        }

        // Portfolio Tag Management
        function addPortfolioTechnology() {
            const input = document.getElementById('portfolioTechName');
            const name = input.value.trim();

            if (!name) return;

            currentPortfolioTechnologies.push(name);
            input.value = '';
            renderPortfolioTechnologies();
        }

        function removePortfolioTechnology(index) {
            currentPortfolioTechnologies.splice(index, 1);
            renderPortfolioTechnologies();
        }

        function renderPortfolioTechnologies() {
            const container = document.getElementById('portfolioTechList');
            container.innerHTML = currentPortfolioTechnologies.map((tech, index) => `
                <span class="exp-tag" style="cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
                    ${escapeHtml(tech)}
                    <i class="ph ph-x" onclick="removePortfolioTechnology(${index})" style="font-size: 12px; opacity: 0.7;"></i>
                </span>
            `).join('');
        }

        function addPortfolioSkill() {
            const input = document.getElementById('portfolioSkillName');
            const name = input.value.trim();

            if (!name) return;

            currentPortfolioSkills.push(name);
            input.value = '';
            renderPortfolioSkills();
        }

        function removePortfolioSkill(index) {
            currentPortfolioSkills.splice(index, 1);
            renderPortfolioSkills();
        }

        function renderPortfolioSkills() {
            const container = document.getElementById('portfolioSkillList');
            container.innerHTML = currentPortfolioSkills.map((skill, index) => `
                <span class="exp-tag" style="cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
                    ${escapeHtml(skill)}
                    <i class="ph ph-x" onclick="removePortfolioSkill(${index})" style="font-size: 12px; opacity: 0.7;"></i>
                </span>
            `).join('');
        }

        function addPortfolioCompetency() {
            const input = document.getElementById('portfolioCompetencyName');
            const name = input.value.trim();

            if (!name) return;

            currentPortfolioCompetencies.push(name);
            input.value = '';
            renderPortfolioCompetencies();
        }

        function removePortfolioCompetency(index) {
            currentPortfolioCompetencies.splice(index, 1);
            renderPortfolioCompetencies();
        }

        function renderPortfolioCompetencies() {
            const container = document.getElementById('portfolioCompetencyList');
            container.innerHTML = currentPortfolioCompetencies.map((comp, index) => `
                <span class="exp-tag" style="cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
                    ${escapeHtml(comp)}
                    <i class="ph ph-x" onclick="removePortfolioCompetency(${index})" style="font-size: 12px; opacity: 0.7;"></i>
                </span>
            `).join('');
        }

        function updatePortfolioCount(count) {
            // Update the personaData structure for Portfolio
            if (personaData[currentPersona] && personaData[currentPersona].children) {
                const portfolioNode = personaData[currentPersona].children.find(c => c.name === 'Portfolio');
                if (portfolioNode) {
                    portfolioNode.count = count;
                    console.log('[Badges] Updated Portfolio count to:', count, 'for persona:', currentPersona);
                }
            }
        }

        // Projects Management
        let userProjects = [];
        const technologyColors = {
            'React': '#61DAFB', 'Vue': '#42B883', 'Angular': '#DD0031', 'Node.js': '#68A063',
            'Python': '#3776AB', 'JavaScript': '#F7DF1E', 'TypeScript': '#3178C6',
            'Java': '#007396', 'C#': '#239120', 'Ruby': '#CC342D', 'Go': '#00ADD8',
            'PHP': '#777BB4', 'Swift': '#FA7343', 'Kotlin': '#7F52FF',
            'PostgreSQL': '#336791', 'MongoDB': '#47A248', 'MySQL': '#4479A1',
            'Redis': '#DC382D', 'Docker': '#2496ED', 'Kubernetes': '#326CE5',
            'AWS': '#FF9900', 'Azure': '#0089D6', 'GCP': '#4285F4',
            'Git': '#F05032', 'GraphQL': '#E10098', 'REST': '#009688'
        };
        const topicColors = {
            'Web Development': '#0066CC', 'Mobile': '#673AB7', 'Backend': '#4CAF50',
            'Frontend': '#FF9800', 'Full Stack': '#E91E63', 'DevOps': '#00BCD4',
            'Data Science': '#9C27B0', 'Machine Learning': '#3F51B5', 'AI': '#2196F3',
            'Cloud': '#03A9F4', 'Security': '#F44336', 'Testing': '#8BC34A',
            'E-Commerce': '#FF5722', 'Analytics': '#607D8B', 'API': '#795548'
        };

        function loadUserProjects() {
            const stored = localStorage.getItem(`projects_${currentPersona}`);
            userProjects = stored ? JSON.parse(stored) : [];
        }

        function saveUserProjects() {
            localStorage.setItem(`projects_${currentPersona}`, JSON.stringify(userProjects));
        }

        function openProjectsSlideout() {
            loadUserProjects();
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Project Repositories';

                // Hide all content sections
                hideAllContentSections();

                // Show projects content
                document.getElementById('projectsContent').style.display = 'flex';
                loadProjectsCards();
            });
        }

        function loadProjectsCards() {
            const container = document.getElementById('projectsContainer');

            if (userProjects.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px 20px; grid-column: 1/-1;">No project repositories yet. Click Connect Repository to add your local projects.</p>';
                return;
            }

            container.innerHTML = userProjects.map((project, index) => {
                const statusBadgeColors = {
                    'active': 'background: #e8f5e9; color: #2e7d32',
                    'completed': 'background: #e3f2fd; color: #1565c0',
                    'archived': 'background: #f5f5f5; color: #757575',
                    'planning': 'background: #fff3e0; color: #ef6c00'
                };

                const technologies = project.technologies ? project.technologies.split(',').map(t => t.trim()) : [];
                const topics = project.topics ? project.topics.split(',').map(t => t.trim()) : [];

                return `
                    <div class="experience-card" style="cursor: default;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #1a1a1a; font-size: 16px; font-weight: 600;">${project.name}</h4>
                                    <span style="padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; ${statusBadgeColors[project.status]}">
                                        ${project.status.toUpperCase()}
                                    </span>
                                </div>
                                <p style="margin: 0 0 8px 0; color: #666; font-size: 12px; font-family: 'Courier New', monospace;">
                                    <i class="ph ph-folder"></i> ${project.path}
                                </p>
                                ${project.repoUrl ? `
                                    <p style="margin: 0 0 8px 0; color: #0066CC; font-size: 12px;">
                                        <i class="ph ph-git-branch"></i> <a href="${project.repoUrl}" target="_blank" rel="noopener noreferrer" style="color: #0066CC; text-decoration: none;">${project.repoUrl}</a>
                                    </p>
                                ` : ''}
                                ${project.description ? `
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 13px; line-height: 1.5;">
                                        ${project.description}
                                    </p>
                                ` : ''}
                                ${technologies.length > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;">
                                        ${technologies.map(tech => {
                                            const color = technologyColors[tech] || '#999';
                                            return `<span style="background: ${color}20; color: ${color}; border: 1px solid ${color}40; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                                ${tech}
                                            </span>`;
                                        }).join('')}
                                    </div>
                                ` : ''}
                                ${topics.length > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${topics.map(topic => {
                                            const color = topicColors[topic] || '#666';
                                            return `<span style="background: ${color}15; color: ${color}; border: 1px solid ${color}30; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                ${topic}
                                            </span>`;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px; margin-left: 12px;">
                                <button onclick="editProject(${index})" style="padding: 6px 10px; background: #f5f5f7; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #666; font-weight: 600;">
                                    <i class="ph ph-pencil"></i> Edit
                                </button>
                                <button onclick="deleteProject(${index})" style="padding: 6px 10px; background: #fee; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #c33; font-weight: 600;">
                                    <i class="ph ph-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addProjectRepo() {
            document.getElementById('projectFormModal').classList.add('active');
            document.getElementById('projectForm').reset();
            document.getElementById('projectFormTitle').textContent = 'Connect Project Repository';
            document.getElementById('projectForm').dataset.editIndex = '';
        }

        function editProject(index) {
            const project = userProjects[index];
            document.getElementById('projectFormModal').classList.add('active');
            document.getElementById('projectFormTitle').textContent = 'Edit Project Repository';

            document.getElementById('projectName').value = project.name;
            document.getElementById('projectPath').value = project.path;
            document.getElementById('projectRepoUrl').value = project.repoUrl || '';
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectTechnologies').value = project.technologies || '';
            document.getElementById('projectTopics').value = project.topics || '';
            document.getElementById('projectStatus').value = project.status;

            document.getElementById('projectForm').dataset.editIndex = index;
        }

        function closeProjectForm() {
            document.getElementById('projectFormModal').classList.remove('active');
        }

        function saveProject(event) {
            event.preventDefault();

            const projectData = {
                name: document.getElementById('projectName').value,
                path: document.getElementById('projectPath').value,
                repoUrl: document.getElementById('projectRepoUrl').value,
                description: document.getElementById('projectDescription').value,
                technologies: document.getElementById('projectTechnologies').value,
                topics: document.getElementById('projectTopics').value,
                status: document.getElementById('projectStatus').value
            };

            const editIndex = document.getElementById('projectForm').dataset.editIndex;

            if (editIndex !== '') {
                userProjects[parseInt(editIndex)] = projectData;
            } else {
                userProjects.push(projectData);
            }

            saveUserProjects();
            loadProjectsCards();
            updateBadgesOnly();
            closeProjectForm();
        }

        function deleteProject(index) {
            if (confirm('Are you sure you want to remove this project repository connection?')) {
                userProjects.splice(index, 1);
                saveUserProjects();
                loadProjectsCards();
                updateBadgesOnly();
            }
        }

        function scanLocalRepos() {
            alert('Scan Local Directories functionality coming soon! This will automatically detect Git repositories in your specified folders.');
        }

        function openCodeSnippetsSlideout() {
            alert('Code Snippets functionality coming soon! This will allow you to save and organize reusable code snippets with syntax highlighting.');
        }

        function openMyLibrarySlideout() {
            alert('My Library functionality coming soon! This will connect to your Cleansheet Library content for personalized learning resources.');
        }

        // My Notes Management
        let userNotes = [];
        const categoryColors = {
            'learning': { bg: '#e3f2fd', color: '#1565c0', icon: 'ph-graduation-cap' },
            'idea': { bg: '#fff3e0', color: '#ef6c00', icon: 'ph-lightbulb' },
            'question': { bg: '#f3e5f5', color: '#7b1fa2', icon: 'ph-question' },
            'reference': { bg: '#e8f5e9', color: '#2e7d32', icon: 'ph-bookmark' },
            'todo': { bg: '#ffebee', color: '#c62828', icon: 'ph-check-square' },
            'general': { bg: '#f5f5f5', color: '#616161', icon: 'ph-note' }
        };

        function loadUserNotes() {
            const stored = localStorage.getItem(`notes_${currentPersona}`);
            userNotes = stored ? JSON.parse(stored) : [];
        }

        function saveUserNotes() {
            localStorage.setItem(`notes_${currentPersona}`, JSON.stringify(userNotes));
        }

        function openMyNotesSlideout() {
            loadUserNotes();
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'My Notes';

                // Hide all content sections
                hideAllContentSections();

                // Show notes content
                document.getElementById('myNotesContent').style.display = 'flex';
                document.getElementById('notesSearchInput').value = '';
                loadNotesCards();
            });
        }

        // Calendar Management
        let calendarEvents = [];
        let currentCalendarView = 'weekly';
        let currentCalendarDate = new Date();
        let editingEventIndex = -1;

        function loadCalendarEvents() {
            const stored = localStorage.getItem('calendarEvents_' + currentPersona);
            if (stored) {
                try {
                    calendarEvents = JSON.parse(stored);
                } catch (e) {
                    calendarEvents = [];
                }
            } else {
                // Initialize with example events if none exist
                calendarEvents = getExamplePersonalEvents();
            }
        }

        function getExamplePersonalEvents() {
            const today = new Date();
            const year = today.getFullYear();

            return [
                // Birthdays
                {
                    title: "Mom's Birthday",
                    type: 'allday',
                    date: `${year}-03-15`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Call Mom and send flowers',
                    calendar: 'personal'
                },
                {
                    title: "Dad's Birthday",
                    type: 'allday',
                    date: `${year}-07-22`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Plan dinner with family',
                    calendar: 'personal'
                },
                {
                    title: "Sister's Birthday",
                    type: 'allday',
                    date: `${year}-09-08`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: '',
                    calendar: 'personal'
                },
                {
                    title: "Best Friend's Birthday",
                    type: 'allday',
                    date: `${year}-11-12`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Birthday dinner planned',
                    calendar: 'personal'
                },

                // Holidays
                {
                    title: "New Year's Day",
                    type: 'allday',
                    date: `${year}-01-01`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Federal Holiday',
                    calendar: 'personal'
                },
                {
                    title: "Valentine's Day",
                    type: 'allday',
                    date: `${year}-02-14`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Dinner reservation at 7 PM',
                    calendar: 'personal'
                },
                {
                    title: "Memorial Day",
                    type: 'allday',
                    date: `${year}-05-26`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: '',
                    description: 'Federal Holiday - BBQ with family',
                    calendar: 'personal'
                },
                {
                    title: "Independence Day",
                    type: 'allday',
                    date: `${year}-07-04`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Fireworks at the park',
                    calendar: 'personal'
                },
                {
                    title: "Labor Day",
                    type: 'allday',
                    date: `${year}-09-01`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: '',
                    description: 'Federal Holiday',
                    calendar: 'personal'
                },
                {
                    title: "Halloween",
                    type: 'allday',
                    date: `${year}-10-31`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Trick-or-treating with kids',
                    calendar: 'personal'
                },
                {
                    title: "Thanksgiving",
                    type: 'allday',
                    date: `${year}-11-27`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: '',
                    description: 'Dinner at grandparents',
                    calendar: 'personal'
                },
                {
                    title: "Christmas Eve",
                    type: 'allday',
                    date: `${year}-12-24`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Family gathering',
                    calendar: 'personal'
                },
                {
                    title: "Christmas",
                    type: 'allday',
                    date: `${year}-12-25`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Federal Holiday',
                    calendar: 'personal'
                },
                {
                    title: "New Year's Eve",
                    type: 'allday',
                    date: `${year}-12-31`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: '',
                    description: 'Party at Sarah\'s house',
                    calendar: 'personal'
                },

                // Vacations
                {
                    title: "Spring Break Trip",
                    type: 'allday',
                    date: `${year}-03-20`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: 'Miami, FL',
                    description: 'Beach vacation - 7 days',
                    calendar: 'personal'
                },
                {
                    title: "Summer Vacation",
                    type: 'allday',
                    date: `${year}-07-15`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: 'Yellowstone National Park',
                    description: 'Camping and hiking - 10 days',
                    calendar: 'personal'
                },
                {
                    title: "Anniversary Weekend",
                    type: 'allday',
                    date: `${year}-09-20`,
                    startTime: '',
                    endTime: '',
                    recurring: true,
                    recurrence: {
                        pattern: 'yearly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: 'Napa Valley, CA',
                    description: 'Wine country getaway',
                    calendar: 'personal'
                },
                {
                    title: "Thanksgiving Road Trip",
                    type: 'allday',
                    date: `${year}-11-22`,
                    startTime: '',
                    endTime: '',
                    recurring: false,
                    location: 'Denver, CO to Chicago, IL',
                    description: 'Driving to see family',
                    calendar: 'personal'
                },

                // Personal Events
                {
                    title: "Dentist Appointment",
                    type: 'datetime',
                    date: `${year}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate() + 7).padStart(2, '0')}`,
                    startTime: '10:00',
                    endTime: '11:00',
                    recurring: false,
                    location: 'Dr. Smith Dental Office',
                    description: 'Regular cleaning',
                    calendar: 'personal'
                },
                {
                    title: "Gym Session",
                    type: 'datetime',
                    date: `${year}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate() + 1).padStart(2, '0')}`,
                    startTime: '06:30',
                    endTime: '07:30',
                    recurring: true,
                    recurrence: {
                        pattern: 'weekly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: 'LA Fitness',
                    description: 'Morning workout',
                    calendar: 'personal'
                },
                {
                    title: "Book Club Meeting",
                    type: 'datetime',
                    date: `${year}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate() + 14).padStart(2, '0')}`,
                    startTime: '19:00',
                    endTime: '21:00',
                    recurring: true,
                    recurrence: {
                        pattern: 'monthly',
                        interval: '1',
                        endType: 'never'
                    },
                    location: 'Coffee House Downtown',
                    description: 'Discussing "The Great Gatsby"',
                    calendar: 'personal'
                }
            ];
        }

        function saveCalendarEvents() {
            localStorage.setItem('calendarEvents_' + currentPersona, JSON.stringify(calendarEvents));
        }

        function openCalendarSlideout() {
            loadCalendarEvents();
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Calendar';

                // Hide all content sections
                hideAllContentSections();

                // Show calendar content
                document.getElementById('calendarContent').style.display = 'block';
                renderCalendar();
            });
        }

        function switchCalendarView(view) {
            currentCalendarView = view;

            // Update active button states
            document.querySelectorAll('.calendar-view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(view + 'ViewBtn').classList.add('active');

            renderCalendar();
        }

        function navigateCalendar(direction) {
            if (direction === 'prev') {
                if (currentCalendarView === 'daily') {
                    currentCalendarDate.setDate(currentCalendarDate.getDate() - 1);
                } else if (currentCalendarView === 'weekly') {
                    currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
                } else {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                }
            } else if (direction === 'next') {
                if (currentCalendarView === 'daily') {
                    currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
                } else if (currentCalendarView === 'weekly') {
                    currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
                } else {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                }
            } else if (direction === 'today') {
                currentCalendarDate = new Date();
            }

            renderCalendar();
        }

        function renderCalendar() {
            const displayArea = document.getElementById('calendarDisplayArea');
            const dateRangeEl = document.getElementById('calendarDateRange');

            if (currentCalendarView === 'daily') {
                renderDailyView(displayArea, dateRangeEl);
            } else if (currentCalendarView === 'weekly') {
                renderWeeklyView(displayArea, dateRangeEl);
            } else {
                renderMonthlyView(displayArea, dateRangeEl);
            }
        }

        function renderDailyView(container, dateRangeEl) {
            const dateStr = currentCalendarDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            dateRangeEl.textContent = dateStr;

            const dayEvents = getEventsForDate(currentCalendarDate);

            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';

            // Time slots from 6 AM to 10 PM
            for (let hour = 6; hour <= 22; hour++) {
                const timeStr = formatHour(hour);
                const eventsAtHour = dayEvents.filter(e => {
                    if (e.type === 'allday') return hour === 6;
                    if (!e.startTime) return false;
                    const eventHour = parseInt(e.startTime.split(':')[0]);
                    return eventHour === hour;
                });

                html += `
                    <div style="display: flex; border-bottom: 1px solid var(--color-neutral-border); padding: 8px 0;">
                        <div style="width: 80px; font-family: var(--font-family-heading); font-size: 12px; color: var(--color-neutral-text-light); padding-right: 16px; text-align: right;">
                            ${timeStr}
                        </div>
                        <div style="flex: 1;">
                            ${eventsAtHour.map(event => renderEventCard(event, 'daily')).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderWeeklyView(container, dateRangeEl) {
            const weekStart = getWeekStart(currentCalendarDate);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            dateRangeEl.textContent = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--color-neutral-border);">';

            // Day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach((day, index) => {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + index);
                const isToday = isSameDay(date, new Date());

                html += `
                    <div style="background: white; padding: 12px 8px; text-align: center; ${isToday ? 'background: #dcfce7;' : ''}">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase;">
                            ${day}
                        </div>
                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: ${isToday ? '#16a34a' : 'var(--color-neutral-text)'}; margin-top: 4px;">
                            ${date.getDate()}
                        </div>
                    </div>
                `;
            });

            // Day cells with events
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const dayEvents = getEventsForDate(date);

                html += `
                    <div style="background: white; padding: 8px; min-height: 120px; max-height: 300px; overflow-y: auto;">
                        ${dayEvents.map(event => renderEventCard(event, 'weekly')).join('')}
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderMonthlyView(container, dateRangeEl) {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const monthName = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            dateRangeEl.textContent = monthName;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--color-neutral-border);">';

            // Day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                html += `
                    <div style="background: white; padding: 8px; text-align: center; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; color: var(--color-neutral-text-light); text-transform: uppercase;">
                        ${day}
                    </div>
                `;
            });

            // Empty cells before first day
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div style="background: #fafafa; min-height: 100px;"></div>';
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = isSameDay(date, new Date());
                const dayEvents = getEventsForDate(date);

                html += `
                    <div style="background: white; padding: 8px; min-height: 100px; max-height: 150px; overflow-y: auto; ${isToday ? 'border: 2px solid #16a34a;' : ''}">
                        <div style="font-family: var(--font-family-heading); font-size: 14px; font-weight: ${isToday ? '700' : '600'}; color: ${isToday ? '#16a34a' : 'var(--color-neutral-text)'}; margin-bottom: 4px;">
                            ${day}
                        </div>
                        ${dayEvents.map(event => renderEventCard(event, 'monthly')).join('')}
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderEventCard(event, viewMode) {
            const timeStr = event.type === 'allday' ? 'All Day' : event.startTime ? event.startTime + (event.endTime ? ' - ' + event.endTime : '') : '';

            if (viewMode === 'monthly') {
                return `
                    <div onclick="viewEvent(${calendarEvents.indexOf(event)})" style="background: #dcfce7; border-left: 3px solid #16a34a; padding: 4px 6px; margin-bottom: 4px; cursor: pointer; border-radius: 3px;">
                        <div style="font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${event.title}
                        </div>
                    </div>
                `;
            } else if (viewMode === 'weekly') {
                return `
                    <div onclick="viewEvent(${calendarEvents.indexOf(event)})" style="background: #dcfce7; border-left: 3px solid #16a34a; padding: 6px 8px; margin-bottom: 6px; cursor: pointer; border-radius: 4px;">
                        <div style="font-family: var(--font-family-heading); font-size: 10px; color: #16a34a; font-weight: 600; margin-bottom: 2px;">
                            ${timeStr}
                        </div>
                        <div style="font-family: var(--font-family-heading); font-size: 12px; font-weight: 600; color: var(--color-neutral-text);">
                            ${event.title}
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div onclick="viewEvent(${calendarEvents.indexOf(event)})" style="background: #dcfce7; border-left: 3px solid #16a34a; padding: 12px; margin-bottom: 8px; cursor: pointer; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                                    ${event.title}
                                </div>
                                <div style="font-family: var(--font-family-body); font-size: 13px; color: #16a34a; font-weight: 600;">
                                    ${timeStr}
                                </div>
                                ${event.location ? `
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light); margin-top: 4px;">
                                        <i class="ph ph-map-pin"></i> ${event.location}
                                    </div>
                                ` : ''}
                                ${event.description ? `
                                    <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-top: 8px;">
                                        ${event.description}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button onclick="event.stopPropagation(); editEvent(${calendarEvents.indexOf(event)})" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">
                                    <i class="ph ph-pencil-simple" style="font-size: 14px; color: #16a34a;"></i>
                                </button>
                                <button onclick="event.stopPropagation(); shareEventPrompt(${calendarEvents.indexOf(event)})" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer;">
                                    <i class="ph ph-share-network" style="font-size: 14px; color: #16a34a;"></i>
                                </button>
                                <button onclick="event.stopPropagation(); deleteEvent(${calendarEvents.indexOf(event)})" style="padding: 6px; background: #fee; border: 1px solid #fcc; border-radius: 4px; cursor: pointer;">
                                    <i class="ph ph-trash" style="font-size: 14px; color: #c33;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function getEventsForDate(date) {
            return calendarEvents.filter(event => {
                const eventDate = new Date(event.date);
                return isSameDay(eventDate, date);
            });
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function formatHour(hour) {
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:00 ${ampm}`;
        }

        function openAddEventForm() {
            editingEventIndex = -1;
            document.getElementById('eventFormTitle').textContent = 'Add Event';
            document.getElementById('eventForm').reset();
            document.getElementById('eventDate').value = currentCalendarDate.toISOString().split('T')[0];
            document.getElementById('eventFormModal').style.display = 'flex';
        }

        function closeEventForm() {
            document.getElementById('eventFormModal').style.display = 'none';
            editingEventIndex = -1;
        }

        function updateEventTypeFields() {
            const type = document.getElementById('eventType').value;
            const startTimeField = document.getElementById('eventStartTimeField');
            const endTimeField = document.getElementById('eventEndTimeField');
            const dateField = document.getElementById('eventDateField');

            if (type === 'allday') {
                startTimeField.style.display = 'none';
                endTimeField.style.display = 'none';
                dateField.style.display = 'block';
            } else if (type === 'datetime') {
                startTimeField.style.display = 'block';
                endTimeField.style.display = 'block';
                dateField.style.display = 'block';
            } else if (type === 'time') {
                startTimeField.style.display = 'block';
                endTimeField.style.display = 'block';
                dateField.style.display = 'none';
            }
        }

        function toggleRecurringFields() {
            const isRecurring = document.getElementById('eventRecurring').checked;
            document.getElementById('recurringFields').style.display = isRecurring ? 'block' : 'none';
        }

        function toggleRecurrenceEnd() {
            const endType = document.getElementById('recurrenceEndType').value;
            document.getElementById('recurrenceEndDateField').style.display = endType === 'date' ? 'block' : 'none';
            document.getElementById('recurrenceCountField').style.display = endType === 'count' ? 'block' : 'none';
        }

        function saveEvent(e) {
            e.preventDefault();

            const eventData = {
                title: document.getElementById('eventTitle').value,
                type: document.getElementById('eventType').value,
                date: document.getElementById('eventDate').value,
                startTime: document.getElementById('eventStartTime').value,
                endTime: document.getElementById('eventEndTime').value,
                recurring: document.getElementById('eventRecurring').checked,
                location: document.getElementById('eventLocation').value,
                description: document.getElementById('eventDescription').value,
                calendar: document.getElementById('eventCalendar').value
            };

            if (eventData.recurring) {
                eventData.recurrence = {
                    pattern: document.getElementById('recurrencePattern').value,
                    interval: document.getElementById('recurrenceInterval').value,
                    endType: document.getElementById('recurrenceEndType').value,
                    endDate: document.getElementById('recurrenceEndDate').value,
                    count: document.getElementById('recurrenceCount').value
                };
            }

            if (editingEventIndex >= 0) {
                calendarEvents[editingEventIndex] = eventData;
            } else {
                calendarEvents.push(eventData);
            }

            saveCalendarEvents();
            renderCalendar();
            closeEventForm();
        }

        function viewEvent(index) {
            editEvent(index);
        }

        function editEvent(index) {
            const event = calendarEvents[index];
            editingEventIndex = index;

            document.getElementById('eventFormTitle').textContent = 'Edit Event';
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventType').value = event.type;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventStartTime').value = event.startTime || '';
            document.getElementById('eventEndTime').value = event.endTime || '';
            document.getElementById('eventRecurring').checked = event.recurring || false;
            document.getElementById('eventLocation').value = event.location || '';
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('eventCalendar').value = event.calendar || 'personal';

            updateEventTypeFields();
            toggleRecurringFields();

            if (event.recurrence) {
                document.getElementById('recurrencePattern').value = event.recurrence.pattern;
                document.getElementById('recurrenceInterval').value = event.recurrence.interval;
                document.getElementById('recurrenceEndType').value = event.recurrence.endType;
                document.getElementById('recurrenceEndDate').value = event.recurrence.endDate || '';
                document.getElementById('recurrenceCount').value = event.recurrence.count || 10;
                toggleRecurrenceEnd();
            }

            document.getElementById('eventFormModal').style.display = 'flex';
        }

        function deleteEvent(index) {
            if (confirm('Are you sure you want to delete this event?')) {
                calendarEvents.splice(index, 1);
                saveCalendarEvents();
                renderCalendar();
            }
        }

        function shareEventPrompt(index) {
            const event = calendarEvents[index];
            alert(`Share functionality coming soon!\n\nEvent: ${event.title}\nDate: ${event.date}\n\nYou'll be able to share this event via email, text, or social media.`);
        }

        function openCalendarSettings() {
            document.getElementById('calendarSettingsModal').style.display = 'flex';
        }

        function closeCalendarSettings() {
            document.getElementById('calendarSettingsModal').style.display = 'none';
        }

        function switchSettingsTab(tab) {
            document.getElementById('syncSettingsContent').style.display = 'none';
            document.getElementById('exportSettingsContent').style.display = 'none';
            document.getElementById('shareSettingsContent').style.display = 'none';

            document.getElementById('syncTab').style.borderBottom = '2px solid transparent';
            document.getElementById('syncTab').style.color = 'var(--color-neutral-text)';
            document.getElementById('exportTab').style.borderBottom = '2px solid transparent';
            document.getElementById('exportTab').style.color = 'var(--color-neutral-text)';
            document.getElementById('shareTab').style.borderBottom = '2px solid transparent';
            document.getElementById('shareTab').style.color = 'var(--color-neutral-text)';

            if (tab === 'sync') {
                document.getElementById('syncSettingsContent').style.display = 'block';
                document.getElementById('syncTab').style.borderBottom = '2px solid var(--color-primary-blue)';
                document.getElementById('syncTab').style.color = 'var(--color-primary-blue)';
            } else if (tab === 'export') {
                document.getElementById('exportSettingsContent').style.display = 'block';
                document.getElementById('exportTab').style.borderBottom = '2px solid var(--color-primary-blue)';
                document.getElementById('exportTab').style.color = 'var(--color-primary-blue)';
            } else if (tab === 'share') {
                document.getElementById('shareSettingsContent').style.display = 'block';
                document.getElementById('shareTab').style.borderBottom = '2px solid var(--color-primary-blue)';
                document.getElementById('shareTab').style.color = 'var(--color-primary-blue)';
            }
        }

        function connectGoogleCalendar() {
            alert('Google Calendar connection coming soon!\n\nYou\'ll be able to:\n• Two-way sync with Google Calendar\n• Import existing events\n• Auto-sync new events');
        }

        function connectMicrosoftCalendar() {
            alert('Microsoft Calendar connection coming soon!\n\nYou\'ll be able to:\n• Two-way sync with Outlook/Microsoft 365\n• Import existing events\n• Auto-sync new events');
        }

        function connectAppleCalendar() {
            alert('Apple Calendar connection coming soon!\n\nYou\'ll be able to:\n• Two-way sync with iCloud Calendar\n• Import existing events\n• Auto-sync new events');
        }

        function exportCalendar(format) {
            if (calendarEvents.length === 0) {
                alert('No events to export!');
                return;
            }

            let data, filename, mimeType;

            if (format === 'ics') {
                data = generateICS();
                filename = 'cleansheet-calendar.ics';
                mimeType = 'text/calendar';
            } else if (format === 'csv') {
                data = generateCSV();
                filename = 'cleansheet-calendar.csv';
                mimeType = 'text/csv';
            } else if (format === 'json') {
                data = JSON.stringify(calendarEvents, null, 2);
                filename = 'cleansheet-calendar.json';
                mimeType = 'application/json';
            }

            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateICS() {
            let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Cleansheet//Calendar//EN\n';

            calendarEvents.forEach(event => {
                ics += 'BEGIN:VEVENT\n';
                ics += `SUMMARY:${event.title}\n`;
                ics += `DTSTART:${event.date.replace(/-/g, '')}${event.startTime ? 'T' + event.startTime.replace(':', '') + '00' : ''}\n`;
                if (event.endTime) {
                    ics += `DTEND:${event.date.replace(/-/g, '')}T${event.endTime.replace(':', '')}00\n`;
                }
                if (event.location) {
                    ics += `LOCATION:${event.location}\n`;
                }
                if (event.description) {
                    ics += `DESCRIPTION:${event.description}\n`;
                }
                ics += 'END:VEVENT\n';
            });

            ics += 'END:VCALENDAR';
            return ics;
        }

        function generateCSV() {
            let csv = 'Title,Date,Start Time,End Time,Type,Location,Description,Recurring\n';

            calendarEvents.forEach(event => {
                csv += `"${event.title}","${event.date}","${event.startTime || ''}","${event.endTime || ''}","${event.type}","${event.location || ''}","${event.description || ''}","${event.recurring ? 'Yes' : 'No'}"\n`;
            });

            return csv;
        }

        function copyShareLink() {
            const link = document.getElementById('shareLink');
            link.select();
            document.execCommand('copy');
            alert('Share link copied to clipboard!');
        }

        function togglePublicSharing() {
            const isPublic = document.getElementById('sharePublic').checked;
            if (isPublic) {
                alert('Calendar is now publicly accessible. Anyone with the link can view your events.');
            } else {
                alert('Calendar is now private. Only people you invite can view your events.');
            }
        }

        // ============================================
        // Recipes Management
        // ============================================

        let recipes = [];

        function loadRecipes() {
            const stored = localStorage.getItem('cleansheet_recipes_personal');
            if (stored) {
                recipes = JSON.parse(stored);
            } else {
                // Load example recipes
                recipes = getExampleRecipes();
                saveRecipesToStorage();
            }
        }

        function saveRecipesToStorage() {
            localStorage.setItem('cleansheet_recipes_personal', JSON.stringify(recipes));
        }

        // Shopping Management
        let shoppingItems = [];

        function loadShoppingItems() {
            const stored = localStorage.getItem('cleansheet_shopping_personal');
            if (stored) {
                try {
                    shoppingItems = JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to parse shopping items', e);
                    shoppingItems = [];
                }
            }
        }

        function saveShoppingItemsToStorage() {
            localStorage.setItem('cleansheet_shopping_personal', JSON.stringify(shoppingItems));
        }

        function openShoppingSlideout(section = null) {
            loadShoppingItems();
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Shopping';

                // Hide all content sections
                hideAllContentSections();

                // Show shopping content
                document.getElementById('shoppingContent').style.display = 'block';

                // If section is provided, update filter to show that category
                if (section) {
                    const filterSelect = document.getElementById('shoppingFilterSelect');
                    if (filterSelect) {
                        filterSelect.value = section;
                    }
                }

                renderShoppingItems();
                updateShoppingSummary();
            });
        }

        function renderShoppingItems() {
            const container = document.getElementById('shoppingItemsContainer');
            const filterCategory = document.getElementById('shoppingFilterSelect').value;

            const filteredItems = shoppingItems.filter(item => {
                return !filterCategory || item.category === filterCategory;
            });

            if (filteredItems.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text-light); text-align: center; padding: 40px;">No shopping items found. Add an item to get started.</p>';
                return;
            }

            container.innerHTML = filteredItems.map((item, index) => {
                const actualIndex = shoppingItems.indexOf(item);
                const isCompleted = item.completed;
                const bgColor = isCompleted ? '#f5f5f7' : 'white';
                const textDecoration = isCompleted ? 'line-through' : 'none';
                const textColor = isCompleted ? '#999999' : 'var(--color-neutral-text)';

                return `
                    <div style="background: ${bgColor}; border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1; display: flex; align-items: start; gap: 12px;">
                                <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleShoppingItemComplete(${actualIndex})" style="margin-top: 2px; width: 18px; height: 18px; cursor: pointer;">
                                <div style="flex: 1;">
                                    <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: ${textColor}; margin: 0 0 4px 0; text-decoration: ${textDecoration};">
                                        ${item.name}
                                    </h3>
                                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light);">
                                        ${item.category}${item.estimatedCost ? ` • $${item.estimatedCost.toFixed(2)}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="deleteShoppingItem(${actualIndex})" style="padding: 6px 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #ef4444; font-family: var(--font-family-heading); font-size: 11px; font-weight: 600; cursor: pointer;">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </div>
                        </div>

                        ${item.notes ? `
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: ${textColor}; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--color-neutral-border); text-decoration: ${textDecoration};">
                                ${item.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterShoppingItems() {
            renderShoppingItems();
        }

        function updateShoppingSummary() {
            const totalItems = shoppingItems.length;
            const estimatedTotal = shoppingItems.reduce((sum, item) => sum + (item.estimatedCost || 0), 0);

            document.getElementById('totalShoppingItems').textContent = totalItems;
            document.getElementById('estimatedShoppingTotal').textContent = `$${estimatedTotal.toFixed(2)}`;
        }

        function addShoppingItem() {
            const name = prompt('Enter item name:');
            if (!name || !name.trim()) return;

            const category = prompt('Enter category (Grocery, Home, Internet, Gifts):') || 'Grocery';
            const estimatedCostStr = prompt('Enter estimated cost (optional):');
            const estimatedCost = estimatedCostStr ? parseFloat(estimatedCostStr) : 0;
            const notes = prompt('Enter notes (optional):') || '';

            const item = {
                name: name.trim(),
                category: category.trim(),
                estimatedCost,
                notes: notes.trim(),
                completed: false,
                createdAt: new Date().toISOString()
            };

            shoppingItems.push(item);
            saveShoppingItemsToStorage();
            renderShoppingItems();
            updateShoppingSummary();
        }

        function toggleShoppingItemComplete(index) {
            shoppingItems[index].completed = !shoppingItems[index].completed;
            saveShoppingItemsToStorage();
            renderShoppingItems();
        }

        function deleteShoppingItem(index) {
            if (confirm('Are you sure you want to delete this shopping item?')) {
                shoppingItems.splice(index, 1);
                saveShoppingItemsToStorage();
                renderShoppingItems();
                updateShoppingSummary();
            }
        }

        function openRecipesSlideout() {
            loadRecipes();
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Recipes';

                // Hide all content sections
                hideAllContentSections();

                // Show recipes content
                document.getElementById('recipesContent').style.display = 'block';

                populateRecipeFilters();
                renderRecipes();
            });
        }

        function populateRecipeFilters() {
            const cuisines = [...new Set(recipes.map(r => r.cuisine).filter(c => c))].sort();
            const mealTypes = [...new Set(recipes.map(r => r.mealType).filter(m => m))].sort();

            const cuisineSelect = document.getElementById('cuisineFilterSelect');
            const mealTypeSelect = document.getElementById('mealTypeFilterSelect');

            // Clear and repopulate cuisine filter
            cuisineSelect.innerHTML = '<option value="">All Cuisines</option>';
            cuisines.forEach(cuisine => {
                const option = document.createElement('option');
                option.value = cuisine;
                option.textContent = cuisine;
                cuisineSelect.appendChild(option);
            });

            // Clear and repopulate meal type filter
            mealTypeSelect.innerHTML = '<option value="">All Meal Types</option>';
            mealTypes.forEach(mealType => {
                const option = document.createElement('option');
                option.value = mealType;
                option.textContent = mealType;
                mealTypeSelect.appendChild(option);
            });
        }

        function renderRecipes() {
            const container = document.getElementById('recipesContainer');
            const searchTerm = document.getElementById('recipesSearchInput').value.toLowerCase();
            const cuisineFilter = document.getElementById('cuisineFilterSelect').value;
            const mealTypeFilter = document.getElementById('mealTypeFilterSelect').value;

            const filteredRecipes = recipes.filter(recipe => {
                const matchesSearch = !searchTerm ||
                    recipe.name.toLowerCase().includes(searchTerm) ||
                    (recipe.ingredients && recipe.ingredients.toLowerCase().includes(searchTerm)) ||
                    (recipe.notes && recipe.notes.toLowerCase().includes(searchTerm));

                const matchesCuisine = !cuisineFilter || recipe.cuisine === cuisineFilter;
                const matchesMealType = !mealTypeFilter || recipe.mealType === mealTypeFilter;

                return matchesSearch && matchesCuisine && matchesMealType;
            });

            if (filteredRecipes.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text-light); text-align: center; padding: 40px;">No recipes found. Add your first recipe!</p>';
                return;
            }

            container.innerHTML = filteredRecipes.map((recipe, index) => {
                const totalTime = (recipe.prepTime || 0) + (recipe.cookTime || 0);
                return `
                    <div style="background: #dcfce7; border: 1px solid #16a34a; border-radius: 8px; padding: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
                         onclick="viewRecipe(${recipes.indexOf(recipe)})"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(22, 163, 74, 0.15)';"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 8px 0;">
                            ${recipe.name}
                        </h3>

                        ${recipe.cuisine || recipe.mealType ? `
                            <div style="display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap;">
                                ${recipe.cuisine ? `<span style="background: white; padding: 4px 8px; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${recipe.cuisine}</span>` : ''}
                                ${recipe.mealType ? `<span style="background: white; padding: 4px 8px; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${recipe.mealType}</span>` : ''}
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 12px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light);">
                            ${totalTime > 0 ? `
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <i class="ph ph-clock"></i>
                                    <span>${totalTime} min</span>
                                </div>
                            ` : ''}
                            ${recipe.servings ? `
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <i class="ph ph-users"></i>
                                    <span>${recipe.servings} servings</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchRecipes() {
            renderRecipes();
        }

        function filterRecipes() {
            renderRecipes();
        }

        function openAddRecipeForm() {
            document.getElementById('recipeFormTitle').textContent = 'Add Recipe';
            document.getElementById('recipeEditIndex').value = '';
            document.getElementById('recipeName').value = '';
            document.getElementById('recipeCuisine').value = '';
            document.getElementById('recipeMealType').value = '';
            document.getElementById('recipePrepTime').value = '';
            document.getElementById('recipeCookTime').value = '';
            document.getElementById('recipeServings').value = '';
            document.getElementById('recipeIngredients').value = '';
            document.getElementById('recipeInstructions').value = '';
            document.getElementById('recipeNotes').value = '';

            document.getElementById('recipeFormModal').style.display = 'flex';
        }

        function closeRecipeForm() {
            document.getElementById('recipeFormModal').style.display = 'none';
        }

        function saveRecipe() {
            const name = document.getElementById('recipeName').value.trim();
            const cuisine = document.getElementById('recipeCuisine').value.trim();
            const mealType = document.getElementById('recipeMealType').value.trim();
            const prepTime = parseInt(document.getElementById('recipePrepTime').value) || 0;
            const cookTime = parseInt(document.getElementById('recipeCookTime').value) || 0;
            const servings = parseInt(document.getElementById('recipeServings').value) || 0;
            const ingredients = document.getElementById('recipeIngredients').value.trim();
            const instructions = document.getElementById('recipeInstructions').value.trim();
            const notes = document.getElementById('recipeNotes').value.trim();
            const editIndex = document.getElementById('recipeEditIndex').value;

            if (!name) {
                alert('Please enter a recipe name');
                return;
            }

            if (!ingredients) {
                alert('Please enter ingredients');
                return;
            }

            if (!instructions) {
                alert('Please enter instructions');
                return;
            }

            const recipe = {
                name,
                cuisine,
                mealType,
                prepTime,
                cookTime,
                servings,
                ingredients,
                instructions,
                notes,
                createdAt: editIndex ? recipes[editIndex].createdAt : new Date().toISOString()
            };

            if (editIndex !== '') {
                recipes[editIndex] = recipe;
            } else {
                recipes.push(recipe);
            }

            saveRecipesToStorage();
            populateRecipeFilters();
            renderRecipes();
            closeRecipeForm();
        }

        function editRecipe(index) {
            const recipe = recipes[index];

            document.getElementById('recipeFormTitle').textContent = 'Edit Recipe';
            document.getElementById('recipeEditIndex').value = index;
            document.getElementById('recipeName').value = recipe.name;
            document.getElementById('recipeCuisine').value = recipe.cuisine || '';
            document.getElementById('recipeMealType').value = recipe.mealType || '';
            document.getElementById('recipePrepTime').value = recipe.prepTime || '';
            document.getElementById('recipeCookTime').value = recipe.cookTime || '';
            document.getElementById('recipeServings').value = recipe.servings || '';
            document.getElementById('recipeIngredients').value = recipe.ingredients;
            document.getElementById('recipeInstructions').value = recipe.instructions;
            document.getElementById('recipeNotes').value = recipe.notes || '';

            document.getElementById('recipeFormModal').style.display = 'flex';
        }

        function deleteRecipe(index) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                recipes.splice(index, 1);
                saveRecipesToStorage();
                populateRecipeFilters();
                renderRecipes();
            }
        }

        function viewRecipe(index) {
            const recipe = recipes[index];
            const ingredientsList = recipe.ingredients.split('\n').filter(i => i.trim());
            const instructionsList = recipe.instructions.split('\n').filter(i => i.trim());
            const totalTime = (recipe.prepTime || 0) + (recipe.cookTime || 0);

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <div style="position: sticky; top: 0; background: white; z-index: 10; padding: 20px; border-bottom: 1px solid var(--color-neutral-border);">
                        <h2 style="font-family: var(--font-family-heading); font-size: 24px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 8px 0;">
                            ${recipe.name}
                        </h2>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${recipe.cuisine ? `<span style="background: #dcfce7; padding: 6px 12px; border-radius: 4px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">${recipe.cuisine}</span>` : ''}
                            ${recipe.mealType ? `<span style="background: #dcfce7; padding: 6px 12px; border-radius: 4px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">${recipe.mealType}</span>` : ''}
                        </div>
                    </div>

                    <div style="padding: 20px;">
                        ${recipe.prepTime || recipe.cookTime || recipe.servings ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 24px;">
                                ${totalTime > 0 ? `
                                    <div style="text-align: center; padding: 12px; background: var(--color-neutral-background); border-radius: 8px;">
                                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Total Time</div>
                                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: #16a34a;">${totalTime} min</div>
                                    </div>
                                ` : ''}
                                ${recipe.prepTime > 0 ? `
                                    <div style="text-align: center; padding: 12px; background: var(--color-neutral-background); border-radius: 8px;">
                                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Prep Time</div>
                                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: var(--color-neutral-text);">${recipe.prepTime} min</div>
                                    </div>
                                ` : ''}
                                ${recipe.cookTime > 0 ? `
                                    <div style="text-align: center; padding: 12px; background: var(--color-neutral-background); border-radius: 8px;">
                                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Cook Time</div>
                                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: var(--color-neutral-text);">${recipe.cookTime} min</div>
                                    </div>
                                ` : ''}
                                ${recipe.servings > 0 ? `
                                    <div style="text-align: center; padding: 12px; background: var(--color-neutral-background); border-radius: 8px;">
                                        <div style="font-family: var(--font-family-heading); font-size: 11px; text-transform: uppercase; color: var(--color-neutral-text-light); margin-bottom: 4px;">Servings</div>
                                        <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: var(--color-neutral-text);">${recipe.servings}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 12px;">Ingredients</h3>
                        <ul style="margin: 0 0 24px 0; padding-left: 20px;">
                            ${ingredientsList.map(ing => `<li style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 6px;">${ing}</li>`).join('')}
                        </ul>

                        <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 12px;">Instructions</h3>
                        <ol style="margin: 0 0 24px 0; padding-left: 20px;">
                            ${instructionsList.map(inst => `<li style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); margin-bottom: 8px; line-height: 1.5;">${inst}</li>`).join('')}
                        </ol>

                        ${recipe.notes ? `
                            <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 12px;">Notes</h3>
                            <p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); line-height: 1.6; white-space: pre-wrap;">${recipe.notes}</p>
                        ` : ''}
                    </div>

                    <div style="position: sticky; bottom: 0; background: white; border-top: 1px solid var(--color-neutral-border); padding: 16px; display: flex; gap: 8px; justify-content: flex-end;">
                        <button onclick="this.closest('.modal').remove()" style="padding: 10px 20px; background: white; color: var(--color-neutral-text); border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-heading); font-size: 13px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function getExampleRecipes() {
            return [
                {
                    name: 'Classic Chicken Tacos',
                    cuisine: 'Mexican',
                    mealType: 'Dinner',
                    prepTime: 15,
                    cookTime: 20,
                    servings: 4,
                    ingredients: '1 lb chicken breast, diced\n8 small corn tortillas\n1 tbsp olive oil\n1 tsp cumin\n1 tsp chili powder\n1/2 tsp paprika\nSalt and pepper to taste\n1 cup shredded lettuce\n1/2 cup diced tomatoes\n1/2 cup shredded cheese\n1/4 cup sour cream\nFresh cilantro for garnish',
                    instructions: '1. Heat olive oil in a large skillet over medium-high heat\n2. Season chicken with cumin, chili powder, paprika, salt, and pepper\n3. Cook chicken for 8-10 minutes until golden and cooked through\n4. Warm tortillas in a dry skillet for 30 seconds per side\n5. Assemble tacos with chicken, lettuce, tomatoes, cheese, and sour cream\n6. Garnish with fresh cilantro and serve',
                    notes: 'Can substitute chicken with ground beef or black beans for vegetarian option',
                    createdAt: new Date().toISOString()
                },
                {
                    name: 'Spaghetti Carbonara',
                    cuisine: 'Italian',
                    mealType: 'Dinner',
                    prepTime: 10,
                    cookTime: 15,
                    servings: 4,
                    ingredients: '1 lb spaghetti\n6 oz pancetta or bacon, diced\n4 large eggs\n1 cup grated Parmesan cheese\n2 cloves garlic, minced\nSalt and black pepper to taste\nFresh parsley for garnish',
                    instructions: '1. Cook spaghetti according to package directions, reserve 1 cup pasta water\n2. While pasta cooks, crisp pancetta in a large skillet over medium heat\n3. In a bowl, whisk eggs and Parmesan cheese\n4. Add minced garlic to pancetta and cook for 1 minute\n5. Drain pasta and add to skillet with pancetta\n6. Remove from heat, add egg mixture, tossing quickly to create creamy sauce\n7. Add pasta water as needed to achieve desired consistency\n8. Season with salt and pepper, garnish with parsley',
                    notes: 'The key is to work quickly so eggs create a creamy sauce without scrambling',
                    createdAt: new Date().toISOString()
                },
                {
                    name: 'Blueberry Smoothie',
                    cuisine: 'American',
                    mealType: 'Breakfast',
                    prepTime: 5,
                    cookTime: 0,
                    servings: 2,
                    ingredients: '2 cups frozen blueberries\n1 banana\n1 cup Greek yogurt\n1/2 cup milk (dairy or non-dairy)\n1 tbsp honey\n1/2 tsp vanilla extract',
                    instructions: '1. Add all ingredients to blender\n2. Blend on high until smooth and creamy\n3. Add more milk if too thick\n4. Pour into glasses and serve immediately',
                    notes: 'Can add protein powder or spinach for extra nutrition',
                    createdAt: new Date().toISOString()
                },
                {
                    name: 'Chocolate Chip Cookies',
                    cuisine: 'American',
                    mealType: 'Dessert',
                    prepTime: 15,
                    cookTime: 12,
                    servings: 24,
                    ingredients: '2 1/4 cups all-purpose flour\n1 tsp baking soda\n1 tsp salt\n1 cup butter, softened\n3/4 cup granulated sugar\n3/4 cup packed brown sugar\n2 large eggs\n2 tsp vanilla extract\n2 cups chocolate chips',
                    instructions: '1. Preheat oven to 375°F\n2. Mix flour, baking soda, and salt in a bowl\n3. In another bowl, beat butter and both sugars until creamy\n4. Add eggs and vanilla, beat well\n5. Gradually blend in flour mixture\n6. Stir in chocolate chips\n7. Drop rounded tablespoons onto ungreased cookie sheets\n8. Bake 9-11 minutes until golden brown\n9. Cool on sheets for 2 minutes, then transfer to wire racks',
                    notes: 'For chewier cookies, slightly underbake. Store in airtight container for up to 1 week',
                    createdAt: new Date().toISOString()
                }
            ];
        }

        // ============================================
        // Finance Management
        // ============================================

        let financeAccounts = [];

        function loadFinanceAccounts() {
            const stored = localStorage.getItem('cleansheet_finance_personal');
            if (stored) {
                financeAccounts = JSON.parse(stored);
            } else {
                // Load example accounts
                financeAccounts = getExampleFinanceAccounts();
                saveFinanceAccountsToStorage();
            }
        }

        function saveFinanceAccountsToStorage() {
            localStorage.setItem('cleansheet_finance_personal', JSON.stringify(financeAccounts));
        }

        function openFinanceSlideout(section = null) {
            loadFinanceAccounts();
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Finance';

                // Hide all content sections
                hideAllContentSections();

                // Show finance content
                document.getElementById('financeContent').style.display = 'block';

                // If section is provided, update filter to show that section
                if (section) {
                    const filterSelect = document.getElementById('financeFilterSelect');
                    if (filterSelect) {
                        // Map child node names to filter values
                        const sectionMap = {
                            'Insurance': 'Insurance',
                            'Cash Flow': 'Cash Flow',
                            'Assets': 'Asset',
                            'Liabilities': 'Liability',
                            'Investments': 'Investment'
                        };

                        const filterValue = sectionMap[section];
                        if (filterValue) {
                            filterSelect.value = filterValue;
                        }
                    }
                }

                renderFinanceAccounts();
                updateFinanceSummary();
            });
        }

        function renderFinanceAccounts() {
            const container = document.getElementById('financeAccountsContainer');
            const filterType = document.getElementById('financeFilterSelect').value;

            const filteredAccounts = financeAccounts.filter(account => {
                return !filterType || account.type === filterType;
            });

            if (filteredAccounts.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text-light); text-align: center; padding: 40px;">No accounts found. Connect an institution or create a manual account.</p>';
                return;
            }

            container.innerHTML = filteredAccounts.map((account, index) => {
                const isNegative = account.type === 'Liability' || (account.type === 'Cash Flow' && account.subtype === 'Expense');
                const amountColor = isNegative ? '#ef4444' : '#16a34a';
                const bgColor = isNegative ? '#fee2e2' : '#dcfce7';
                const borderColor = isNegative ? '#ef4444' : '#16a34a';

                return `
                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <h3 style="font-family: var(--font-family-heading); font-size: 16px; font-weight: 600; color: var(--color-neutral-text); margin: 0 0 4px 0;">
                                    ${account.name}
                                </h3>
                                <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light);">
                                    ${account.institution || 'Manual Account'} • ${account.type}${account.subtype ? ` - ${account.subtype}` : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-family: var(--font-family-heading); font-size: 20px; font-weight: 600; color: ${amountColor};">
                                    ${isNegative ? '-' : ''}$${Math.abs(account.balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </div>
                            </div>
                        </div>

                        ${account.notes ? `
                            <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-top: 8px; padding-top: 8px; border-top: 1px solid ${borderColor};">
                                ${account.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterFinanceAccounts() {
            renderFinanceAccounts();
        }

        function updateFinanceSummary() {
            const assets = financeAccounts
                .filter(a => a.type === 'Asset' || a.type === 'Investment')
                .reduce((sum, a) => sum + a.balance, 0);

            const liabilities = financeAccounts
                .filter(a => a.type === 'Liability')
                .reduce((sum, a) => sum + a.balance, 0);

            const netWorth = assets - liabilities;

            document.getElementById('totalAssets').textContent = `$${assets.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalLiabilities').textContent = `$${liabilities.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('netWorth').textContent = `$${netWorth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        let connectInstitutionTooltipTimeout;

        function showConnectInstitutionTooltip() {
            clearTimeout(connectInstitutionTooltipTimeout);
            document.getElementById('connectInstitutionTooltip').style.display = 'block';
        }

        function hideConnectInstitutionTooltip() {
            connectInstitutionTooltipTimeout = setTimeout(() => {
                document.getElementById('connectInstitutionTooltip').style.display = 'none';
            }, 200);
        }

        function keepConnectInstitutionTooltip() {
            clearTimeout(connectInstitutionTooltipTimeout);
        }

        function selectInstitution(institution) {
            alert(`Connection to ${institution} would require OAuth integration with a financial data aggregator like Plaid or MX. This is a demo placeholder.`);
            document.getElementById('connectInstitutionTooltip').style.display = 'none';
        }

        let manualAccountTooltipTimeout;

        function showManualAccountTooltip() {
            clearTimeout(manualAccountTooltipTimeout);
            document.getElementById('manualAccountTooltip').style.display = 'block';
        }

        function hideManualAccountTooltip() {
            manualAccountTooltipTimeout = setTimeout(() => {
                document.getElementById('manualAccountTooltip').style.display = 'none';
            }, 200);
        }

        function keepManualAccountTooltip() {
            clearTimeout(manualAccountTooltipTimeout);
        }

        function clearManualAccountTooltipForm() {
            document.getElementById('accountTypeTooltip').value = '';
            document.getElementById('accountNameTooltip').value = '';
            document.getElementById('accountInstitutionTooltip').value = '';
            document.getElementById('accountBalanceTooltip').value = '';
            document.getElementById('accountNotesTooltip').value = '';

            // Hide all type-specific fields
            document.getElementById('assetFieldsTooltip').style.display = 'none';
            document.getElementById('investmentFieldsTooltip').style.display = 'none';
            document.getElementById('cashFlowFieldsTooltip').style.display = 'none';
            document.getElementById('insuranceFieldsTooltip').style.display = 'none';
            document.getElementById('liabilityFieldsTooltip').style.display = 'none';
        }

        function updateAccountTypeFieldsTooltip() {
            const accountType = document.getElementById('accountTypeTooltip').value;

            // Hide all type-specific fields
            document.getElementById('assetFieldsTooltip').style.display = 'none';
            document.getElementById('investmentFieldsTooltip').style.display = 'none';
            document.getElementById('cashFlowFieldsTooltip').style.display = 'none';
            document.getElementById('insuranceFieldsTooltip').style.display = 'none';
            document.getElementById('liabilityFieldsTooltip').style.display = 'none';

            // Show relevant fields based on type
            if (accountType === 'Asset') {
                document.getElementById('assetFieldsTooltip').style.display = 'block';
            } else if (accountType === 'Investment') {
                document.getElementById('investmentFieldsTooltip').style.display = 'block';
            } else if (accountType === 'Cash Flow') {
                document.getElementById('cashFlowFieldsTooltip').style.display = 'block';
            } else if (accountType === 'Insurance') {
                document.getElementById('insuranceFieldsTooltip').style.display = 'block';
            } else if (accountType === 'Liability') {
                document.getElementById('liabilityFieldsTooltip').style.display = 'block';
            }
        }

        function saveFinanceAccountFromTooltip() {
            const type = document.getElementById('accountTypeTooltip').value;
            const name = document.getElementById('accountNameTooltip').value.trim();
            const institution = document.getElementById('accountInstitutionTooltip').value.trim();
            const balance = parseFloat(document.getElementById('accountBalanceTooltip').value) || 0;
            const notes = document.getElementById('accountNotesTooltip').value.trim();

            if (!type) {
                alert('Please select an account type');
                return;
            }

            if (!name) {
                alert('Please enter an account name');
                return;
            }

            const account = {
                type,
                name,
                institution,
                balance,
                notes,
                createdAt: new Date().toISOString()
            };

            // Add type-specific fields
            if (type === 'Asset') {
                account.subtype = document.getElementById('assetCategoryTooltip').value;
            } else if (type === 'Investment') {
                account.subtype = document.getElementById('investmentTypeTooltip').value;
            } else if (type === 'Cash Flow') {
                account.subtype = document.getElementById('cashFlowTypeTooltip').value;
                account.frequency = document.getElementById('cashFlowFrequencyTooltip').value;
            } else if (type === 'Insurance') {
                account.subtype = document.getElementById('insuranceTypeTooltip').value;
                account.policyNumber = document.getElementById('insurancePolicyNumberTooltip').value.trim();
                account.premium = parseFloat(document.getElementById('insurancePremiumTooltip').value) || 0;
            } else if (type === 'Liability') {
                account.subtype = document.getElementById('liabilityTypeTooltip').value;
                account.interestRate = parseFloat(document.getElementById('liabilityInterestRateTooltip').value) || 0;
                account.monthlyPayment = parseFloat(document.getElementById('liabilityPaymentTooltip').value) || 0;
            }

            financeAccounts.push(account);
            saveFinanceAccountsToStorage();
            renderFinanceAccounts();
            updateFinanceSummary();
            clearManualAccountTooltipForm();
            document.getElementById('manualAccountTooltip').style.display = 'none';
        }

        function getExampleFinanceAccounts() {
            return [
                {
                    type: 'Asset',
                    subtype: 'Checking',
                    name: 'Primary Checking',
                    institution: 'Chase',
                    balance: 5280.45,
                    notes: '',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Asset',
                    subtype: 'Savings',
                    name: 'Emergency Fund',
                    institution: 'Ally Bank',
                    balance: 15000.00,
                    notes: 'Target: $20,000',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Investment',
                    subtype: '401(k)',
                    name: 'Employer 401(k)',
                    institution: 'Fidelity',
                    balance: 87650.23,
                    notes: 'Contributing 6% with 3% match',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Asset',
                    subtype: 'Vehicle',
                    name: '2020 Honda Accord',
                    institution: '',
                    balance: 18500.00,
                    notes: 'Current market value',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Liability',
                    subtype: 'Credit Card',
                    name: 'Chase Sapphire Reserve',
                    institution: 'Chase',
                    balance: 1250.80,
                    interestRate: 18.99,
                    monthlyPayment: 250.00,
                    notes: '',
                    createdAt: new Date().toISOString()
                },
                {
                    type: 'Liability',
                    subtype: 'Auto Loan',
                    name: 'Honda Auto Loan',
                    institution: 'Capital One Auto Finance',
                    balance: 12350.00,
                    interestRate: 3.99,
                    monthlyPayment: 385.00,
                    notes: '28 months remaining',
                    createdAt: new Date().toISOString()
                }
            ];
        }

        // Tables Management
        function openTablesSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Tables';

                // Hide all content sections
                hideAllContentSections();

                // Show tables content
                document.getElementById('tablesContent').style.display = 'block';
                loadTableTypeCards();
            });
        }

        function loadTableTypeCards() {
            const container = document.getElementById('tablesContainer');

            // Define table types relevant to different personas
            const tableTypes = [
                {
                    name: 'Contacts',
                    icon: 'ph-address-book',
                    description: 'People and organizations with contact information, roles, and relationships.',
                    columns: ['Name', 'Email', 'Phone', 'Company', 'Role', 'Location', 'Notes']
                },
                {
                    name: 'Customers',
                    icon: 'ph-users',
                    description: 'Customer records with account details, history, and engagement data.',
                    columns: ['Customer ID', 'Name', 'Email', 'Account Type', 'Status', 'Created Date', 'Lifetime Value']
                },
                {
                    name: 'Projects',
                    icon: 'ph-folder',
                    description: 'Project tracking with timelines, resources, and deliverables.',
                    columns: ['Project Name', 'Status', 'Start Date', 'End Date', 'Budget', 'Team', 'Priority']
                },
                {
                    name: 'Tasks',
                    icon: 'ph-check-square',
                    description: 'Task management with assignments, deadlines, and dependencies.',
                    columns: ['Task Name', 'Assigned To', 'Due Date', 'Status', 'Priority', 'Tags', 'Progress']
                },
                {
                    name: 'Inventory',
                    icon: 'ph-package',
                    description: 'Product or asset inventory with quantities, locations, and specifications.',
                    columns: ['Item Name', 'SKU', 'Quantity', 'Location', 'Supplier', 'Cost', 'Last Updated']
                },
                {
                    name: 'Vendors',
                    icon: 'ph-handshake',
                    description: 'Vendor and supplier information with contracts and performance metrics.',
                    columns: ['Vendor Name', 'Contact', 'Services', 'Contract Start', 'Contract End', 'Rating', 'Notes']
                },
                {
                    name: 'Events',
                    icon: 'ph-calendar',
                    description: 'Event planning and scheduling with attendees and logistics.',
                    columns: ['Event Name', 'Date', 'Time', 'Location', 'Attendees', 'Status', 'Budget']
                },
                {
                    name: 'Assets',
                    icon: 'ph-briefcase',
                    description: 'Equipment and resource tracking with maintenance and ownership.',
                    columns: ['Asset Name', 'Type', 'Owner', 'Location', 'Purchase Date', 'Value', 'Status']
                },
                {
                    name: 'Issues',
                    icon: 'ph-warning',
                    description: 'Issue and bug tracking with severity, assignments, and resolutions.',
                    columns: ['Issue ID', 'Title', 'Severity', 'Status', 'Assigned To', 'Created Date', 'Resolved Date']
                },
                {
                    name: 'Expenses',
                    icon: 'ph-receipt',
                    description: 'Expense tracking and reimbursement management.',
                    columns: ['Date', 'Category', 'Amount', 'Vendor', 'Payment Method', 'Status', 'Receipt']
                }
            ];

            container.innerHTML = '';

            tableTypes.forEach(table => {
                const card = document.createElement('div');
                card.style.cssText = 'padding: 20px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px;';

                card.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="ph ${table.icon}" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${table.name}</div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="event.stopPropagation(); editItem('${table.name}')" title="Edit" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-pencil-simple" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteItem('${table.name}')" title="Delete" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                            </button>
                            <button onclick="event.stopPropagation(); shareTable('${table.name}')" title="Share" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                        </div>
                    </div>
                    <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">
                        ${table.description}
                    </div>
                    <div style="margin-top: 4px;">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin-bottom: 8px;">Columns</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${table.columns.map(col => `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${col}</span>`).join('')}
                        </div>
                    </div>
                    <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">SHARED WITH</div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: var(--color-primary-blue);">AM</div>
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #f3e5f5; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: #7b1fa2;">JS</div>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">+ 3 others</span>
                        </div>
                    </div>
                `;

                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = 'var(--color-primary-blue)';
                    card.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.15)';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = 'var(--color-neutral-border)';
                    card.style.boxShadow = 'none';
                });

                card.addEventListener('click', () => {
                    alert(`${table.name} table functionality coming soon!`);
                });

                container.appendChild(card);
            });
        }

        function shareTable(tableName) {
            alert(`Share ${tableName} table functionality coming soon!`);
        }

        // Zoom control functions for ERD
        function showERDZoomControls() {
            const controls = document.getElementById('erdZoomControls');
            if (controls) {
                controls.style.opacity = '1';
                controls.style.pointerEvents = 'auto';
            }
        }

        function hideERDZoomControls() {
            const controls = document.getElementById('erdZoomControls');
            if (controls) {
                controls.style.opacity = '0';
                controls.style.pointerEvents = 'none';
            }
        }

        function updateZoomLevelIndicator(scale) {
            const indicator = document.getElementById('erdZoomLevel');
            if (indicator) {
                const percentage = Math.round(scale * 100);
                indicator.textContent = `${percentage}%`;

                // Color coding for different zoom levels
                if (percentage < 50) {
                    indicator.style.color = '#d32f2f'; // Red for very zoomed out
                } else if (percentage > 200) {
                    indicator.style.color = '#1976d2'; // Blue for very zoomed in
                } else {
                    indicator.style.color = 'var(--color-neutral-text)'; // Default
                }
            }
        }

        function zoomERD(action) {
            const container = document.getElementById('tablesERDContainer');
            const svg = container.querySelector('svg');
            if (!svg || !svg.zoomBehavior) {
                console.warn('ERD zoom not available - no SVG or zoom behavior found');
                return;
            }

            const zoomBehavior = svg.zoomBehavior;
            const svgSelection = d3.select(svg);

            switch (action) {
                case 'in':
                    svgSelection.transition()
                        .duration(300)
                        .call(zoomBehavior.scaleBy, 1.5);
                    break;
                case 'out':
                    svgSelection.transition()
                        .duration(300)
                        .call(zoomBehavior.scaleBy, 1/1.5);
                    break;
                case 'reset':
                    svgSelection.transition()
                        .duration(500)
                        .call(zoomBehavior.transform, d3.zoomIdentity);
                    break;
                case 'fit':
                    // Get bounds of all content
                    const zoomGroup = svg.querySelector('.zoom-group');
                    if (zoomGroup) {
                        try {
                            const bbox = zoomGroup.getBBox();
                            if (bbox.width > 0 && bbox.height > 0) {
                                const containerRect = container.getBoundingClientRect();
                                const padding = 50;
                                const scale = Math.min(
                                    (containerRect.width - padding * 2) / bbox.width,
                                    (containerRect.height - padding * 2) / bbox.height,
                                    2  // Max zoom level for fit
                                );
                                const centerX = containerRect.width / 2;
                                const centerY = containerRect.height / 2;
                                const x = centerX - (bbox.x + bbox.width / 2) * scale;
                                const y = centerY - (bbox.y + bbox.height / 2) * scale;

                                svgSelection.transition()
                                    .duration(750)
                                    .call(zoomBehavior.transform, d3.zoomIdentity.translate(x, y).scale(scale));
                            }
                        } catch (error) {
                            console.log('Fit to screen: content bounds not available, using reset');
                            zoomERD('reset');
                        }
                    }
                    break;
            }
        }

        // Switch between Cards and Relationships views in Tables
        function switchTablesView(view) {
            const cardsTab = document.getElementById('tablesCardsTab');
            const relationshipsTab = document.getElementById('tablesRelationshipsTab');
            const cardsView = document.getElementById('tablesCardsView');
            const relationshipsView = document.getElementById('tablesRelationshipsView');

            if (view === 'cards') {
                // Show cards view
                cardsView.style.display = 'block';
                relationshipsView.style.display = 'none';

                // Update tab styling
                cardsTab.style.borderBottom = '2px solid var(--color-primary-blue)';
                cardsTab.style.color = 'var(--color-primary-blue)';
                cardsTab.style.fontWeight = '600';

                relationshipsTab.style.borderBottom = '2px solid transparent';
                relationshipsTab.style.color = 'var(--color-neutral-text)';
                relationshipsTab.style.fontWeight = '400';
            } else if (view === 'relationships') {
                // Show relationships view
                cardsView.style.display = 'none';
                relationshipsView.style.display = 'block';

                // Update tab styling
                relationshipsTab.style.borderBottom = '2px solid var(--color-primary-blue)';
                relationshipsTab.style.color = 'var(--color-primary-blue)';
                relationshipsTab.style.fontWeight = '600';

                cardsTab.style.borderBottom = '2px solid transparent';
                cardsTab.style.color = 'var(--color-neutral-text)';
                cardsTab.style.fontWeight = '400';

                // Render ERD if not already rendered
                renderTablesERD();
            }
        }

        // Render Entity Relationship Diagram with force-directed layout
        function renderTablesERD() {
            const container = document.getElementById('tablesERDContainer');

            // Clear existing content
            container.innerHTML = '';

            // Load saved relationships from localStorage
            const savedRelationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');

            // Default table nodes (can be extended with saved schemas)
            const defaultNodes = [
                { id: 'contacts', name: 'Contacts', columns: ['ID', 'Name', 'Email', 'Phone', 'Company', 'Role'] },
                { id: 'customers', name: 'Customers', columns: ['Customer_ID', 'Name', 'Email', 'Account_Type', 'Status', 'Contact_ID'] },
                { id: 'projects', name: 'Projects', columns: ['Project_ID', 'Project_Name', 'Status', 'Start_Date', 'End_Date', 'Customer_ID'] },
                { id: 'tasks', name: 'Tasks', columns: ['Task_ID', 'Task_Name', 'Assigned_To_ID', 'Due_Date', 'Status', 'Project_ID'] },
                { id: 'inventory', name: 'Inventory', columns: ['Item_ID', 'Item_Name', 'SKU', 'Quantity', 'Location', 'Supplier_ID'] },
                { id: 'vendors', name: 'Vendors', columns: ['Vendor_ID', 'Vendor_Name', 'Contact', 'Services', 'Contract_Start'] },
                { id: 'events', name: 'Events', columns: ['Event_ID', 'Event_Name', 'Date', 'Time', 'Location', 'Project_ID'] },
                { id: 'assets', name: 'Assets', columns: ['Asset_ID', 'Asset_Name', 'Type', 'Owner_ID', 'Location', 'Vendor_ID'] },
                { id: 'issues', name: 'Issues', columns: ['Issue_ID', 'Title', 'Severity', 'Status', 'Assigned_To_ID', 'Project_ID'] },
                { id: 'expenses', name: 'Expenses', columns: ['Expense_ID', 'Date', 'Amount', 'Vendor_ID', 'Project_ID', 'Submitted_By_ID'] }
            ];

            // Load saved table schemas
            const savedTables = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');

            // Combine default and saved tables
            const allTableNames = new Set([...defaultNodes.map(n => n.id)]);
            savedTables.forEach(t => allTableNames.add(t.tableName));

            // Build nodes array
            const nodes = Array.from(allTableNames).map(tableName => {
                const defaultNode = defaultNodes.find(n => n.id === tableName);
                if (defaultNode) return defaultNode;

                const savedTable = savedTables.find(t => t.tableName === tableName);
                return {
                    id: tableName,
                    name: tableName,
                    columns: savedTable ? savedTable.columns.slice(0, 5).map(c => c.name) : ['No columns']
                };
            });

            // Convert saved relationships to links format
            const links = savedRelationships.map(rel => ({
                source: rel.sourceTable,
                target: rel.targetTable,
                type: rel.type,
                label: rel.label,
                sourceColumns: rel.sourceColumns || [],
                targetColumns: rel.targetColumns || []
            }));

            // If no relationships exist, show a helpful message
            if (links.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--color-neutral-text-light);">
                        <i class="ph ph-arrows-left-right" style="font-size: 64px; margin-bottom: 16px;"></i>
                        <p style="font-family: var(--font-family-body); font-size: 16px; margin: 0 0 8px 0; font-weight: 600;">No Relationships Defined</p>
                        <p style="font-family: var(--font-family-body); font-size: 14px; margin: 0 0 20px 0; text-align: center; max-width: 400px;">
                            Click "Manage Relationships" above to define how your tables connect to each other.
                        </p>
                        <button onclick="openRelationshipManager()" style="padding: 10px 20px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <i class="ph ph-plus"></i> Add First Relationship
                        </button>
                    </div>
                `;
                return;
            }

            // Filter nodes to only include those that are in relationships
            const usedTableNames = new Set();
            links.forEach(link => {
                usedTableNames.add(link.source);
                usedTableNames.add(link.target);
            });
            const filteredNodes = nodes.filter(n => usedTableNames.has(n.id));

            const width = container.clientWidth;
            const height = container.clientHeight;

            // Create SVG with zoom functionality
            const svg = d3.select('#tablesERDContainer')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height])
                .attr('style', 'max-width: 100%; height: auto; cursor: grab;');

            // Create zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 5])
                .on('zoom', (event) => {
                    zoomGroup.attr('transform', event.transform);
                    // Update cursor based on zoom action
                    svg.style('cursor', event.sourceEvent?.type === 'wheel' ? 'zoom-in' : 'grabbing');
                    // Update zoom level indicator
                    updateZoomLevelIndicator(event.transform.k);
                })
                .on('end', () => {
                    svg.style('cursor', 'grab');
                });

            // Apply zoom behavior to SVG
            svg.call(zoom);

            // Create a group for all zoomable content
            const zoomGroup = svg.append('g')
                .attr('class', 'zoom-group');

            // Store zoom behavior for external control
            svg.zoomBehavior = zoom;

            // Create force simulation
            const simulation = d3.forceSimulation(filteredNodes)
                .force('link', d3.forceLink(links)
                    .id(d => d.id)
                    .distance(200)
                    .strength(0.5))
                .force('charge', d3.forceManyBody().strength(-800))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(150));

            // Create arrow marker for directed edges (stays in SVG defs, not zoomGroup)
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 130)
                .attr('refY', 0)
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#0066CC')
                .attr('opacity', 0.6);

            // Draw relationship lines (in zoomGroup)
            const linkGroup = zoomGroup.append('g').attr('class', 'relationships');

            // Create column-level connections
            const columnConnections = [];
            links.forEach(link => {
                if (link.sourceColumns.length > 0 && link.targetColumns.length > 0) {
                    // Create individual column-to-column connections
                    link.sourceColumns.forEach((sourceCol, idx) => {
                        const targetCol = link.targetColumns[idx];
                        if (targetCol) {
                            columnConnections.push({
                                ...link,
                                sourceColumn: sourceCol,
                                targetColumn: targetCol,
                                connectionIndex: idx,
                                totalConnections: link.sourceColumns.length
                            });
                        }
                    });
                } else {
                    // Fallback to table-level connection
                    columnConnections.push({
                        ...link,
                        sourceColumn: null,
                        targetColumn: null,
                        connectionIndex: 0,
                        totalConnections: 1
                    });
                }
            });

            const link = linkGroup.selectAll('path')
                .data(columnConnections)
                .join('path')
                .attr('stroke', d => d.sourceColumn ? '#0066CC' : '#666')
                .attr('stroke-width', d => d.sourceColumn ? 1.5 : 2)
                .attr('stroke-dasharray', d => d.type === 'many-to-one' ? '4,3' : '0')
                .attr('opacity', d => d.sourceColumn ? 0.8 : 0.6)
                .attr('marker-end', 'url(#arrowhead)')
                .attr('fill', 'none');

            // Add relationship labels (one per relationship, not per column)
            const linkLabels = linkGroup.selectAll('text')
                .data(links)
                .join('text')
                .attr('text-anchor', 'middle')
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '10px')
                .attr('fill', '#666')
                .attr('dy', -3)
                .text(d => {
                    if (d.sourceColumns.length > 0 && d.targetColumns.length > 0) {
                        const mappings = d.sourceColumns.map((col, i) =>
                            `${col}→${d.targetColumns[i] || '?'}`
                        ).join(', ');
                        return `${d.label} (${mappings})`;
                    }
                    return d.label;
                });

            // Draw table nodes (in zoomGroup)
            const nodeGroup = zoomGroup.append('g').attr('class', 'tables');

            const node = nodeGroup.selectAll('g')
                .data(filteredNodes)
                .join('g')
                .attr('cursor', 'grab')
                .call(drag(simulation));

            // Calculate node height based on number of columns
            filteredNodes.forEach(n => {
                n.height = 40 + (n.columns.length * 24);
            });

            // Table container (rounded rectangle)
            node.append('rect')
                .attr('width', 240)
                .attr('height', d => d.height)
                .attr('x', -120)
                .attr('y', d => -d.height / 2)
                .attr('rx', 8)
                .attr('ry', 8)
                .attr('fill', 'white')
                .attr('stroke', '#0066CC')
                .attr('stroke-width', 2);

            // Table header background
            node.append('rect')
                .attr('width', 240)
                .attr('height', 40)
                .attr('x', -120)
                .attr('y', d => -d.height / 2)
                .attr('rx', 8)
                .attr('ry', 8)
                .attr('fill', '#e3f2fd');

            // Table header divider
            node.append('line')
                .attr('x1', -120)
                .attr('y1', d => -d.height / 2 + 40)
                .attr('x2', 120)
                .attr('y2', d => -d.height / 2 + 40)
                .attr('stroke', '#0066CC')
                .attr('stroke-width', 2);

            // Table icon
            node.append('foreignObject')
                .attr('width', 20)
                .attr('height', 20)
                .attr('x', -108)
                .attr('y', d => -d.height / 2 + 10)
                .html('<i class="ph ph-table" style="font-size: 20px; color: #0066CC;"></i>');

            // Table name (clickable)
            node.append('text')
                .attr('x', -80)
                .attr('y', d => -d.height / 2 + 25)
                .attr('font-family', 'var(--font-family-heading)')
                .attr('font-size', '16px')
                .attr('font-weight', '600')
                .attr('fill', '#0066CC')
                .attr('cursor', 'pointer')
                .attr('text-decoration', 'underline')
                .text(d => d.name)
                .on('click', function(event, d) {
                    event.stopPropagation();
                    openTableEditor(d.name, d.id);
                })
                .on('mouseover', function() {
                    d3.select(this).attr('fill', '#004C99');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', '#0066CC');
                });

            // Create map of connected columns for highlighting
            const connectedColumns = new Map();
            links.forEach(link => {
                if (link.sourceColumns && link.targetColumns) {
                    // Mark source columns as connected
                    const sourceKey = link.source;
                    if (!connectedColumns.has(sourceKey)) connectedColumns.set(sourceKey, new Set());
                    link.sourceColumns.forEach(col => connectedColumns.get(sourceKey).add(col));

                    // Mark target columns as connected
                    const targetKey = link.target;
                    if (!connectedColumns.has(targetKey)) connectedColumns.set(targetKey, new Set());
                    link.targetColumns.forEach(col => connectedColumns.get(targetKey).add(col));
                }
            });

            // Table columns
            node.each(function(d) {
                const group = d3.select(this);
                const tableConnectedColumns = connectedColumns.get(d.id) || new Set();

                d.columns.forEach((col, idx) => {
                    const y = -d.height / 2 + 40 + (idx * 24) + 16;
                    const isConnected = tableConnectedColumns.has(col);

                    // Column background highlight for connected columns
                    if (isConnected) {
                        group.append('rect')
                            .attr('x', -116)
                            .attr('y', y - 12)
                            .attr('width', 232)
                            .attr('height', 20)
                            .attr('fill', '#e3f2fd')
                            .attr('rx', 3)
                            .attr('opacity', 0.7);
                    }

                    // Connection indicator dot
                    if (isConnected) {
                        group.append('circle')
                            .attr('cx', -104)
                            .attr('cy', y)
                            .attr('r', 3)
                            .attr('fill', '#0066CC')
                            .attr('stroke', 'white')
                            .attr('stroke-width', 1);
                    }

                    // Column name (clickable)
                    group.append('text')
                        .attr('x', -96)
                        .attr('y', y)
                        .attr('font-family', 'var(--font-family-body)')
                        .attr('font-size', '12px')
                        .attr('fill', isConnected ? '#0066CC' : '#333')
                        .attr('font-weight', isConnected ? '600' : '400')
                        .attr('cursor', 'pointer')
                        .text(col)
                        .on('click', function(event) {
                            event.stopPropagation();
                            openColumnEditor(d.name, d.id, col);
                        })
                        .on('mouseover', function() {
                            d3.select(this)
                                .attr('fill', '#004C99')
                                .attr('text-decoration', 'underline');
                        })
                        .on('mouseout', function() {
                            d3.select(this)
                                .attr('fill', isConnected ? '#0066CC' : '#333')
                                .attr('text-decoration', 'none');
                        });

                    // Show key icon for foreign keys (columns ending in _ID) or connected columns
                    if (col.endsWith('_ID') || isConnected) {
                        const iconType = isConnected && !col.endsWith('_ID') ? 'ph-link' : 'ph-key';
                        const iconColor = isConnected ? '#0066CC' : '#666';

                        group.append('foreignObject')
                            .attr('width', 14)
                            .attr('height', 14)
                            .attr('x', 100)
                            .attr('y', y - 10)
                            .html(`<i class="ph ${iconType}" style="font-size: 14px; color: ${iconColor};"></i>`);
                    }
                });
            });

            // Helper function to get column Y position
            function getColumnY(node, columnName) {
                if (!columnName) return 0; // Center of table
                const columnIndex = node.columns.indexOf(columnName);
                if (columnIndex === -1) return 0; // Column not found, use center
                return (-node.height / 2) + 40 + (columnIndex * 24) + 12; // Column center position
            }

            // Helper function to calculate bezier curve for column connections
            function calculateColumnPath(d) {
                const sourceNode = filteredNodes.find(n => n.id === d.source.id || n.id === d.source);
                const targetNode = filteredNodes.find(n => n.id === d.target.id || n.id === d.target);

                if (!sourceNode || !targetNode) return '';

                // Get actual node positions
                const sx = sourceNode.x || 0;
                const sy = sourceNode.y || 0;
                const tx = targetNode.x || 0;
                const ty = targetNode.y || 0;

                // Calculate column-specific positions
                const sourceColumnY = sy + getColumnY(sourceNode, d.sourceColumn);
                const targetColumnY = ty + getColumnY(targetNode, d.targetColumn);

                // Calculate connection points on table edges
                const sourceX = sx + (sx < tx ? 120 : -120); // Right or left edge
                const targetX = tx + (sx < tx ? -120 : 120); // Left or right edge

                // Create bezier curve for smooth column-to-column connections
                const midX = (sourceX + targetX) / 2;
                const offsetY = d.connectionIndex * 8 - (d.totalConnections - 1) * 4; // Spread multiple connections

                return `M ${sourceX},${sourceColumnY + offsetY}
                        C ${midX},${sourceColumnY + offsetY} ${midX},${targetColumnY + offsetY} ${targetX},${targetColumnY + offsetY}`;
            }

            // Update positions on each tick
            simulation.on('tick', () => {
                // Update column-level connection paths
                link.attr('d', d => {
                    if (d.sourceColumn && d.targetColumn) {
                        return calculateColumnPath(d);
                    } else {
                        // Fallback to simple straight line for table-level connections
                        return `M ${d.source.x},${d.source.y} L ${d.target.x},${d.target.y}`;
                    }
                });

                linkLabels
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag behavior
            function drag(simulation) {
                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                    d3.select(this).attr('cursor', 'grabbing');
                }

                function dragged(event) {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }

                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                    d3.select(this).attr('cursor', 'grab');
                }

                return d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended);
            }

            // Add legend
            const legend = svg.append('g')
                .attr('transform', `translate(20, ${height - 80})`);

            legend.append('rect')
                .attr('width', 220)
                .attr('height', 70)
                .attr('rx', 6)
                .attr('fill', 'white')
                .attr('stroke', '#e5e5e7')
                .attr('stroke-width', 1);

            legend.append('text')
                .attr('x', 10)
                .attr('y', 20)
                .attr('font-family', 'var(--font-family-heading)')
                .attr('font-size', '12px')
                .attr('font-weight', '600')
                .attr('fill', '#333')
                .text('Legend');

            legend.append('line')
                .attr('x1', 10)
                .attr('y1', 35)
                .attr('x2', 40)
                .attr('y2', 35)
                .attr('stroke', '#0066CC')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,5')
                .attr('opacity', 0.6);

            legend.append('text')
                .attr('x', 50)
                .attr('y', 39)
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '11px')
                .attr('fill', '#666')
                .text('Many-to-One (Drag to move)');

            legend.append('foreignObject')
                .attr('width', 14)
                .attr('height', 14)
                .attr('x', 10)
                .attr('y', 48)
                .html('<i class="ph ph-key" style="font-size: 14px; color: #666;"></i>');

            legend.append('text')
                .attr('x', 30)
                .attr('y', 60)
                .attr('font-family', 'var(--font-family-body)')
                .attr('font-size', '11px')
                .attr('fill', '#666')
                .text('Foreign Key');
        }

        // Table Wizard Functions
        let tableColumns = [];
        let columnIdCounter = 0;

        function openTableWizard() {
            tableColumns = [];
            columnIdCounter = 0;
            document.getElementById('schemaName').value = 'public';
            document.getElementById('tableName').value = '';
            document.getElementById('tableComment').value = '';
            document.getElementById('ifNotExists').checked = false;
            document.getElementById('temporary').checked = false;
            document.getElementById('unlogged').checked = false;
            document.getElementById('tableColumnsContainer').innerHTML = '';
            document.getElementById('sqlPreview').textContent = '-- Configure table above to see SQL';

            // Add initial id column
            addTableColumn({name: 'id', dataType: 'serial', primaryKey: true, notNull: true});

            openModal('tableWizardModal');
        }

        function addTableColumn(preset = null) {
            const id = columnIdCounter++;
            const col = preset || {
                name: '',
                dataType: 'text',
                notNull: false,
                primaryKey: false,
                unique: false,
                defaultValue: ''
            };

            tableColumns.push({id, ...col});

            const container = document.getElementById('tableColumnsContainer');
            const row = document.createElement('div');
            row.id = `column-${id}`;
            row.style.cssText = 'background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px; display: grid; grid-template-columns: 2fr 1.5fr 0.8fr 0.8fr 0.8fr 0.8fr auto; gap: 12px; align-items: center;';

            row.innerHTML = `
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        Column Name
                        <i class="ph ph-info" title="Name of the column - must be unique within the table" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="text" value="${col.name}" oninput="updateColumnProperty(${id}, 'name', this.value)" placeholder="column_name" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        Data Type
                        <i class="ph ph-info" title="PostgreSQL data type - determines what kind of data can be stored in this column" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <select onchange="handleDataTypeChange(${id}, this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        <option value="text" ${col.dataType === 'text' ? 'selected' : ''}>text</option>
                        <option value="varchar" ${col.dataType === 'varchar' ? 'selected' : ''}>varchar</option>
                        <option value="integer" ${col.dataType === 'integer' ? 'selected' : ''}>integer</option>
                        <option value="bigint" ${col.dataType === 'bigint' ? 'selected' : ''}>bigint</option>
                        <option value="serial" ${col.dataType === 'serial' ? 'selected' : ''}>serial</option>
                        <option value="bigserial" ${col.dataType === 'bigserial' ? 'selected' : ''}>bigserial</option>
                        <option value="boolean" ${col.dataType === 'boolean' ? 'selected' : ''}>boolean</option>
                        <option value="timestamp" ${col.dataType === 'timestamp' ? 'selected' : ''}>timestamp</option>
                        <option value="timestamptz" ${col.dataType === 'timestamptz' ? 'selected' : ''}>timestamptz</option>
                        <option value="date" ${col.dataType === 'date' ? 'selected' : ''}>date</option>
                        <option value="json" ${col.dataType === 'json' ? 'selected' : ''}>json</option>
                        <option value="jsonb" ${col.dataType === 'jsonb' ? 'selected' : ''}>jsonb</option>
                        <option value="uuid" ${col.dataType === 'uuid' ? 'selected' : ''}>uuid</option>
                        <option value="decimal" ${col.dataType === 'decimal' ? 'selected' : ''}>decimal</option>
                        <option value="real" ${col.dataType === 'real' ? 'selected' : ''}>real</option>
                        <option value="generated" ${col.dataType === 'generated' ? 'selected' : ''}>⚡ Generated Column</option>
                    </select>
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        NOT NULL
                        <i class="ph ph-info" title="Column must have a value - NULL values not allowed" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="checkbox" ${col.notNull ? 'checked' : ''} onchange="updateColumnProperty(${id}, 'notNull', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        PRIMARY KEY
                        <i class="ph ph-info" title="Uniquely identifies each row - only one per table, automatically creates index" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="checkbox" ${col.primaryKey ? 'checked' : ''} onchange="updateColumnProperty(${id}, 'primaryKey', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        UNIQUE
                        <i class="ph ph-info" title="All values in this column must be different - NULL values are allowed" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="checkbox" ${col.unique ? 'checked' : ''} onchange="updateColumnProperty(${id}, 'unique', this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                        FOREIGN KEY
                        <i class="ph ph-info" title="References a column in another table - enforces referential integrity" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                    </label>
                    <input type="checkbox" ${col.foreignKey ? 'checked' : ''} onchange="toggleForeignKey(${id}, this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
                <div style="padding-top: 20px;">
                    <button onclick="removeTableColumn(${id})" title="Remove column" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                    </button>
                </div>
            `;

            // Add generated column configuration section (initially hidden)
            const generatedConfigId = `generated-config-${id}`;
            const generatedConfig = document.createElement('div');
            generatedConfig.id = generatedConfigId;
            generatedConfig.style.cssText = 'display: none; background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px; margin-top: 8px; gap: 12px;';
            generatedConfig.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <i class="ph ph-lightning" style="font-size: 20px; color: #f59e0b;"></i>
                    <h4 style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: #92400e; margin: 0;">Generated Column Configuration</h4>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            Result Type
                            <i class="ph ph-info" title="Data type for the computed result" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <select id="genType-${id}" onchange="updateColumnProperty(${id}, 'generatedType', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="text">text</option>
                            <option value="integer">integer</option>
                            <option value="bigint">bigint</option>
                            <option value="decimal">decimal</option>
                            <option value="boolean">boolean</option>
                            <option value="timestamp">timestamp</option>
                            <option value="date">date</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            Expression
                            <i class="ph ph-info" title="SQL expression to calculate this column's value (e.g., price * quantity)" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <input type="text" id="genExpr-${id}" placeholder="(price * quantity)" oninput="updateColumnProperty(${id}, 'generatedExpression', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; font-family: monospace;">
                    </div>
                </div>
                <div style="margin-top: 8px; padding: 8px 12px; background: white; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: #78716c;">
                    <strong>Examples:</strong> (first_name || ' ' || last_name), (price * quantity), (EXTRACT(YEAR FROM birth_date)), (UPPER(email))
                </div>
            `;

            // Add foreign key configuration section (initially hidden)
            const foreignKeyConfigId = `foreignkey-config-${id}`;
            const foreignKeyConfig = document.createElement('div');
            foreignKeyConfig.id = foreignKeyConfigId;
            foreignKeyConfig.style.cssText = 'display: none; background: #f0f9ff; border: 1px solid #0066CC; border-radius: 8px; padding: 16px; margin-top: 8px; gap: 12px;';
            foreignKeyConfig.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <i class="ph ph-link" style="font-size: 20px; color: #0066CC;"></i>
                    <h4 style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; margin: 0; color: var(--color-dark);">Foreign Key Configuration</h4>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            References Table
                            <i class="ph ph-info" title="The table this foreign key points to" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <select id="fkRefTable-${id}" onchange="updateForeignKeyProperty(${id}, 'refTable', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="">Select table...</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            References Column
                            <i class="ph ph-info" title="The column in the referenced table (usually primary key)" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <input type="text" id="fkRefColumn-${id}" value="${col.foreignKey?.refColumn || 'id'}" placeholder="e.g., id" oninput="updateForeignKeyProperty(${id}, 'refColumn', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            ON DELETE
                            <i class="ph ph-info" title="Action when referenced row is deleted" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <select id="fkOnDelete-${id}" onchange="updateForeignKeyProperty(${id}, 'onDelete', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="NO ACTION" ${col.foreignKey?.onDelete === 'NO ACTION' ? 'selected' : ''}>NO ACTION</option>
                            <option value="RESTRICT" ${col.foreignKey?.onDelete === 'RESTRICT' ? 'selected' : ''}>RESTRICT</option>
                            <option value="CASCADE" ${col.foreignKey?.onDelete === 'CASCADE' ? 'selected' : ''}>CASCADE</option>
                            <option value="SET NULL" ${col.foreignKey?.onDelete === 'SET NULL' ? 'selected' : ''}>SET NULL</option>
                            <option value="SET DEFAULT" ${col.foreignKey?.onDelete === 'SET DEFAULT' ? 'selected' : ''}>SET DEFAULT</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 4px;">
                            ON UPDATE
                            <i class="ph ph-info" title="Action when referenced row is updated" style="font-size: 12px; color: var(--color-primary-blue); cursor: help;"></i>
                        </label>
                        <select id="fkOnUpdate-${id}" onchange="updateForeignKeyProperty(${id}, 'onUpdate', this.value)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="NO ACTION" ${col.foreignKey?.onUpdate === 'NO ACTION' ? 'selected' : ''}>NO ACTION</option>
                            <option value="RESTRICT" ${col.foreignKey?.onUpdate === 'RESTRICT' ? 'selected' : ''}>RESTRICT</option>
                            <option value="CASCADE" ${col.foreignKey?.onUpdate === 'CASCADE' ? 'selected' : ''}>CASCADE</option>
                            <option value="SET NULL" ${col.foreignKey?.onUpdate === 'SET NULL' ? 'selected' : ''}>SET NULL</option>
                            <option value="SET DEFAULT" ${col.foreignKey?.onUpdate === 'SET DEFAULT' ? 'selected' : ''}>SET DEFAULT</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 8px; padding: 8px 12px; background: white; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: #78716c;">
                    <strong>Common pattern:</strong> CASCADE deletes related rows, SET NULL keeps rows but clears FK, RESTRICT prevents deletion
                </div>
            `;

            container.appendChild(row);
            container.appendChild(generatedConfig);
            container.appendChild(foreignKeyConfig);

            // Show generated config if this column is generated
            if (col.dataType === 'generated') {
                generatedConfig.style.display = 'block';
            }

            // Show foreign key config if this column is a foreign key
            if (col.foreignKey) {
                foreignKeyConfig.style.display = 'block';
                loadForeignKeyTableOptions(id, col.foreignKey.refTable);
            }

            updateSQLPreview();
        }

        function handleDataTypeChange(id, dataType) {
            const col = tableColumns.find(c => c.id === id);
            if (col) {
                col.dataType = dataType;

                // Show/hide generated column configuration
                const generatedConfig = document.getElementById(`generated-config-${id}`);
                if (generatedConfig) {
                    if (dataType === 'generated') {
                        generatedConfig.style.display = 'block';
                        // Initialize generated properties if not set
                        if (!col.generatedType) col.generatedType = 'text';
                        if (!col.generatedExpression) col.generatedExpression = '';
                    } else {
                        generatedConfig.style.display = 'none';
                    }
                }

                updateSQLPreview();
            }
        }

        function updateColumnProperty(id, property, value) {
            const col = tableColumns.find(c => c.id === id);
            if (col) {
                col[property] = value;
                updateSQLPreview();
            }
        }

        function toggleForeignKey(id, checked) {
            const col = tableColumns.find(c => c.id === id);
            if (col) {
                if (checked) {
                    col.foreignKey = {
                        refTable: '',
                        refColumn: 'id',
                        onDelete: 'NO ACTION',
                        onUpdate: 'NO ACTION'
                    };
                    document.getElementById(`foreignkey-config-${id}`).style.display = 'block';
                    loadForeignKeyTableOptions(id, '');
                } else {
                    delete col.foreignKey;
                    document.getElementById(`foreignkey-config-${id}`).style.display = 'none';
                }
                updateSQLPreview();
            }
        }

        function updateForeignKeyProperty(id, property, value) {
            const col = tableColumns.find(c => c.id === id);
            if (col && col.foreignKey) {
                col.foreignKey[property] = value;
                updateSQLPreview();
            }
        }

        function loadForeignKeyTableOptions(columnId, selectedTable) {
            const select = document.getElementById(`fkRefTable-${columnId}`);
            if (!select) return;

            // Load tables from saved schemas and defaults
            const savedTables = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');
            const defaultTables = ['contacts', 'customers', 'projects', 'tasks', 'vendors', 'expenses', 'users', 'products', 'orders'];

            const allTables = [...defaultTables, ...savedTables.map(t => t.tableName)];
            const uniqueTables = Array.from(new Set(allTables));

            select.innerHTML = '<option value="">Select table...</option>';
            uniqueTables.forEach(tableName => {
                const option = document.createElement('option');
                option.value = tableName;
                option.textContent = tableName;
                if (tableName === selectedTable) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function removeTableColumn(id) {
            const index = tableColumns.findIndex(c => c.id === id);
            if (index !== -1) {
                tableColumns.splice(index, 1);
                document.getElementById(`column-${id}`).remove();

                // Remove generated column config if it exists
                const genConfig = document.getElementById(`generated-config-${id}`);
                if (genConfig) genConfig.remove();

                // Remove foreign key config if it exists
                const fkConfig = document.getElementById(`foreignkey-config-${id}`);
                if (fkConfig) fkConfig.remove();

                updateSQLPreview();
            }
        }

        function updateSQLPreview() {
            const schemaName = document.getElementById('schemaName').value.trim() || 'public';
            const tableName = document.getElementById('tableName').value.trim();
            const comment = document.getElementById('tableComment').value.trim();
            const ifNotExists = document.getElementById('ifNotExists').checked;
            const temporary = document.getElementById('temporary').checked;
            const unlogged = document.getElementById('unlogged').checked;

            if (!tableName || tableColumns.length === 0) {
                document.getElementById('sqlPreview').textContent = '-- Configure table name and add columns to see SQL';
                return;
            }

            let sql = 'CREATE ';
            if (temporary) sql += 'TEMPORARY ';
            if (unlogged) sql += 'UNLOGGED ';
            sql += 'TABLE ';
            if (ifNotExists) sql += 'IF NOT EXISTS ';
            sql += `${schemaName}.${tableName} (\n`;

            const columnDefs = tableColumns.map(col => {
                if (col.dataType === 'generated') {
                    // Generated column syntax
                    const genType = col.generatedType || 'text';
                    const genExpr = col.generatedExpression || '(NULL)';
                    let def = `    ${col.name} ${genType.toUpperCase()} GENERATED ALWAYS AS ${genExpr} STORED`;
                    if (col.notNull) def += ' NOT NULL';
                    if (col.unique) def += ' UNIQUE';
                    return def;
                } else {
                    // Regular column syntax
                    let def = `    ${col.name} ${col.dataType.toUpperCase()}`;
                    if (col.notNull) def += ' NOT NULL';
                    if (col.unique) def += ' UNIQUE';
                    if (col.primaryKey) def += ' PRIMARY KEY';
                    return def;
                }
            });

            // Collect foreign key constraints
            const foreignKeys = tableColumns
                .filter(col => col.foreignKey && col.foreignKey.refTable)
                .map(col => {
                    const fk = col.foreignKey;
                    let constraint = `    CONSTRAINT fk_${tableName}_${col.name} FOREIGN KEY (${col.name}) `;
                    constraint += `REFERENCES ${fk.refTable}(${fk.refColumn})`;
                    if (fk.onDelete && fk.onDelete !== 'NO ACTION') {
                        constraint += ` ON DELETE ${fk.onDelete}`;
                    }
                    if (fk.onUpdate && fk.onUpdate !== 'NO ACTION') {
                        constraint += ` ON UPDATE ${fk.onUpdate}`;
                    }
                    return constraint;
                });

            // Combine columns and constraints
            const allDefs = [...columnDefs, ...foreignKeys];
            sql += allDefs.join(',\n');
            sql += '\n);';

            if (comment) {
                sql += `\n\nCOMMENT ON TABLE ${schemaName}.${tableName} IS '${comment.replace(/'/g, "''")}';`;
            }

            document.getElementById('sqlPreview').textContent = sql;
        }

        function saveTableSchema() {
            const tableName = document.getElementById('tableName').value.trim();
            if (!tableName) {
                alert('Please enter a table name');
                return;
            }
            if (tableColumns.length === 0) {
                alert('Please add at least one column');
                return;
            }

            const schema = {
                schemaName: document.getElementById('schemaName').value.trim() || 'public',
                tableName: tableName,
                comment: document.getElementById('tableComment').value.trim(),
                ifNotExists: document.getElementById('ifNotExists').checked,
                temporary: document.getElementById('temporary').checked,
                unlogged: document.getElementById('unlogged').checked,
                columns: tableColumns.map(col => ({
                    name: col.name,
                    dataType: col.dataType,
                    notNull: col.notNull || false,
                    primaryKey: col.primaryKey || false,
                    unique: col.unique || false,
                    foreignKey: col.foreignKey || null,
                    generatedType: col.generatedType || null,
                    generatedExpression: col.generatedExpression || null
                }))
            };

            // Save to localStorage
            const tables = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');
            tables.push({
                ...schema,
                created: new Date().toISOString()
            });
            localStorage.setItem('postgresTableSchemas', JSON.stringify(tables));

            alert(`Table schema "${tableName}" saved successfully!`);
            closeModal('tableWizardModal');
        }

        function exportTableSQL() {
            const sql = document.getElementById('sqlPreview').textContent;
            if (sql.startsWith('--')) {
                alert('Please configure the table first');
                return;
            }

            const tableName = document.getElementById('tableName').value.trim() || 'table';
            const blob = new Blob([sql], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${tableName}.sql`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Relationship Management Functions
        function openRelationshipManager() {
            openModal('relationshipManagerModal');
            loadTableOptions();
            loadRelationships();
        }

        function loadTableOptions() {
            // Load tables from saved schemas
            const savedTables = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');

            // Also use the hardcoded ERD tables as defaults
            const defaultTables = [
                { tableName: 'contacts' },
                { tableName: 'customers' },
                { tableName: 'projects' },
                { tableName: 'tasks' },
                { tableName: 'vendors' },
                { tableName: 'expenses' }
            ];

            const allTables = [...defaultTables, ...savedTables];
            const uniqueTables = Array.from(new Set(allTables.map(t => t.tableName)));

            const sourceSelect = document.getElementById('sourceTable');
            const targetSelect = document.getElementById('targetTable');

            // Clear existing options except the first one
            sourceSelect.innerHTML = '<option value="">Select table...</option>';
            targetSelect.innerHTML = '<option value="">Select table...</option>';

            // Add table options
            uniqueTables.forEach(tableName => {
                sourceSelect.innerHTML += `<option value="${tableName}">${tableName}</option>`;
                targetSelect.innerHTML += `<option value="${tableName}">${tableName}</option>`;
            });
        }

        function loadRelationships() {
            const relationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');
            const container = document.getElementById('relationshipsList');

            if (relationships.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-neutral-text-light);">
                        <i class="ph ph-arrows-left-right" style="font-size: 48px; margin-bottom: 12px; display: block;"></i>
                        <p style="font-family: var(--font-family-body); font-size: 14px; margin: 0;">No relationships defined yet. Add your first relationship above.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = relationships.map((rel, index) => {
                // Create column mapping display
                let columnMapping = '';
                if (rel.sourceColumns && rel.targetColumns && rel.sourceColumns.length > 0) {
                    // Enhanced relationship with column mappings
                    const mappings = rel.sourceColumns.map((sourceCol, i) =>
                        `${sourceCol} → ${rel.targetColumns[i] || '?'}`
                    ).join(', ');
                    columnMapping = `
                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-primary-blue); background: #f0f8ff; padding: 6px 8px; border-radius: 4px; margin-top: 8px; font-weight: 500;">
                            <i class="ph ph-link" style="margin-right: 4px;"></i>Column mapping: ${mappings}
                        </div>
                    `;
                } else {
                    // Legacy relationship without column mappings
                    columnMapping = `
                        <div style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); background: #fff3cd; padding: 6px 8px; border-radius: 4px; margin-top: 8px; font-style: italic;">
                            <i class="ph ph-warning" style="margin-right: 4px; color: #f59e0b;"></i>Legacy relationship - no column mapping defined
                        </div>
                    `;
                }

                // Add constraint name if available
                let constraintInfo = '';
                if (rel.constraintName) {
                    constraintInfo = `
                        <div style="font-family: var(--font-family-body); font-size: 10px; color: var(--color-neutral-text-light); margin-top: 4px;">
                            <i class="ph ph-key" style="margin-right: 4px;"></i>Constraint: ${rel.constraintName}
                        </div>
                    `;
                }

                return `
                    <div style="background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; align-items: flex-start; justify-content: space-between;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; color: var(--color-dark);">
                                    ${rel.sourceTable}
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 12px; background: #e3f2fd; border-radius: 12px;">
                                    <i class="ph ph-arrow-right" style="font-size: 14px; color: var(--color-primary-blue);"></i>
                                    <span style="font-family: var(--font-family-body); font-size: 11px; font-weight: 600; color: var(--color-primary-blue);">${rel.type.toUpperCase()}</span>
                                </div>
                                <div style="font-family: var(--font-family-heading); font-size: 14px; font-weight: 600; color: var(--color-dark);">
                                    ${rel.targetTable}
                                </div>
                            </div>
                            <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text-light); padding-left: 4px;">
                                <i class="ph ph-quotes" style="margin-right: 4px;"></i>${rel.label}
                            </div>
                            ${columnMapping}
                            ${constraintInfo}
                        </div>
                        <div style="display: flex; gap: 8px; align-self: flex-start;">
                            <button onclick="editRelationship(${index})" style="padding: 6px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; color: var(--color-neutral-text);" title="Edit relationship">
                                <i class="ph ph-pencil"></i> Edit
                            </button>
                            <button onclick="deleteRelationship(${index})" style="padding: 6px 12px; background: white; border: 1px solid #dc2626; border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; color: #dc2626;" title="Delete relationship">
                                <i class="ph ph-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addRelationship() {
            const sourceTable = document.getElementById('sourceTable').value;
            const targetTable = document.getElementById('targetTable').value;
            const type = document.getElementById('relationshipType').value;
            const label = document.getElementById('relationshipLabel').value.trim();

            // Get selected columns from our arrays
            const sourceColumns = [...selectedSourceColumns];
            const targetColumns = [...selectedTargetColumns];

            // Enhanced validation
            if (!sourceTable) {
                alert('Please select a source table');
                return;
            }
            if (!targetTable) {
                alert('Please select a target table');
                return;
            }
            if (sourceTable === targetTable) {
                alert('Source and target tables must be different');
                return;
            }
            if (sourceColumns.length === 0) {
                alert('Please select at least one source column');
                return;
            }
            if (targetColumns.length === 0) {
                alert('Please select at least one target column');
                return;
            }
            if (sourceColumns.length !== targetColumns.length) {
                alert('Source and target must have the same number of columns selected');
                return;
            }
            if (!label) {
                alert('Please enter a relationship label');
                return;
            }

            // Validate column compatibility
            const validationResult = validateColumnCompatibility(sourceTable, sourceColumns, targetTable, targetColumns);
            if (!validationResult.valid) {
                alert(`Column compatibility issue: ${validationResult.message}`);
                return;
            }

            // Check for duplicate relationships
            const relationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');
            const isDuplicate = relationships.some(rel =>
                rel.sourceTable === sourceTable &&
                rel.targetTable === targetTable &&
                JSON.stringify(rel.sourceColumns || []) === JSON.stringify(sourceColumns) &&
                JSON.stringify(rel.targetColumns || []) === JSON.stringify(targetColumns)
            );

            if (isDuplicate) {
                alert('A relationship with these exact column mappings already exists');
                return;
            }

            // Generate constraint name
            const constraintName = generateConstraintName(sourceTable, targetTable, sourceColumns);

            const relationship = {
                id: generateUUID(),
                sourceTable,
                sourceColumns,
                targetTable,
                targetColumns,
                type,
                label,
                constraintName,
                onDelete: 'CASCADE', // Default referential action
                onUpdate: 'CASCADE', // Default referential action
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };

            // Save to localStorage
            relationships.push(relationship);
            localStorage.setItem('tableRelationships', JSON.stringify(relationships));

            // Clear form
            clearRelationshipForm();

            // Reload list
            loadRelationships();

            // Update ERD if it's visible
            if (document.getElementById('tablesRelationshipsView').style.display !== 'none') {
                renderTablesERD();
            }

            // Show success message with details
            const columnMapping = sourceColumns.map((col, i) => `${col} → ${targetColumns[i]}`).join(', ');
            showToast(`Relationship added: ${sourceTable}.${columnMapping} → ${targetTable}`, 'success');
        }

        function clearRelationshipForm() {
            document.getElementById('sourceTable').value = '';
            document.getElementById('targetTable').value = '';
            document.getElementById('relationshipType').value = 'many-to-one';
            document.getElementById('relationshipLabel').value = '';

            // Clear selected columns arrays
            selectedSourceColumns = [];
            selectedTargetColumns = [];

            // Reset column containers
            const sourceContainer = document.getElementById('sourceColumnsContainer');
            const targetContainer = document.getElementById('targetColumnsContainer');

            sourceContainer.innerHTML = 'Select source table first';
            sourceContainer.style.background = '#f8f8f8';
            sourceContainer.style.justifyContent = 'center';
            sourceContainer.style.alignItems = 'center';
            sourceContainer.style.display = 'flex';

            targetContainer.innerHTML = 'Select target table first';
            targetContainer.style.background = '#f8f8f8';
            targetContainer.style.justifyContent = 'center';
            targetContainer.style.alignItems = 'center';
            targetContainer.style.display = 'flex';

            // Reset preview
            document.getElementById('relationshipPreview').textContent = 'MAPS TO';
            document.getElementById('relationshipPreview').style.color = 'var(--color-neutral-text)';
        }

        function validateColumnCompatibility(sourceTable, sourceColumns, targetTable, targetColumns) {
            const sourceTableColumns = getColumnsForRelationships(sourceTable);
            const targetTableColumns = getColumnsForRelationships(targetTable);

            for (let i = 0; i < sourceColumns.length; i++) {
                const sourceCol = sourceTableColumns.find(c => c.name === sourceColumns[i]);
                const targetCol = targetTableColumns.find(c => c.name === targetColumns[i]);

                if (!sourceCol) {
                    return { valid: false, message: `Source column '${sourceColumns[i]}' not found in table '${sourceTable}'` };
                }

                if (!targetCol) {
                    return { valid: false, message: `Target column '${targetColumns[i]}' not found in table '${targetTable}'` };
                }

                // Basic type compatibility check
                const sourceType = normalizeDataType(sourceCol.type);
                const targetType = normalizeDataType(targetCol.type);

                if (sourceType !== targetType) {
                    return {
                        valid: false,
                        message: `Column types don't match: ${sourceColumns[i]} (${sourceCol.type}) → ${targetColumns[i]} (${targetCol.type})`
                    };
                }
            }

            return { valid: true };
        }

        function normalizeDataType(type) {
            // Normalize PostgreSQL data types for compatibility checking
            const typeStr = type.toLowerCase();

            // UUID types
            if (typeStr.includes('uuid')) return 'uuid';

            // Integer types
            if (typeStr.includes('int') || typeStr.includes('serial')) return 'integer';

            // Text/varchar types
            if (typeStr.includes('varchar') || typeStr.includes('char') || typeStr.includes('text')) return 'text';

            // Decimal/numeric types
            if (typeStr.includes('decimal') || typeStr.includes('numeric') || typeStr.includes('money')) return 'numeric';

            // Date/time types
            if (typeStr.includes('timestamp') || typeStr.includes('date') || typeStr.includes('time')) return 'timestamp';

            // Boolean
            if (typeStr.includes('bool')) return 'boolean';

            return typeStr;
        }

        function generateConstraintName(sourceTable, targetTable, sourceColumns) {
            const sourcePrefix = sourceTable.toLowerCase().substring(0, 3);
            const targetPrefix = targetTable.toLowerCase().substring(0, 3);
            const columnSuffix = sourceColumns.length === 1 ?
                sourceColumns[0].substring(0, 4) :
                sourceColumns.length.toString();

            return `fk_${sourcePrefix}_${targetPrefix}_${columnSuffix}`;
        }

        // Column Selection Functions for Relationships
        let selectedSourceColumns = [];
        let selectedTargetColumns = [];

        function updateSourceColumns() {
            const sourceTable = document.getElementById('sourceTable').value;
            const container = document.getElementById('sourceColumnsContainer');

            selectedSourceColumns = [];

            if (!sourceTable) {
                container.innerHTML = 'Select source table first';
                container.style.background = '#f8f8f8';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.display = 'flex';
                updateRelationshipPreview();
                return;
            }

            const columns = getColumnsForRelationships(sourceTable);

            if (columns.length === 0) {
                // Debug: Show what we're looking for
                console.log('Debug: No columns found for sourceTable:', sourceTable);
                console.log('Debug: Available in existing function:', getColumnsForTable(sourceTable));

                container.innerHTML = `No columns found for table "${sourceTable}"<br><small style="color: #666;">Check browser console for debug info</small>`;
                container.style.background = '#fff3cd';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.display = 'flex';
                updateRelationshipPreview();
                return;
            }

            // Create column selection interface
            container.style.background = 'white';
            container.style.justifyContent = 'flex-start';
            container.style.alignItems = 'flex-start';
            container.style.display = 'block';

            container.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${columns.map(column => `
                        <div class="column-selector" data-column="${column.name}" onclick="toggleSourceColumn('${column.name}', this)" style="
                            padding: 6px 12px;
                            border: 1px solid var(--color-neutral-border);
                            border-radius: 16px;
                            background: white;
                            cursor: pointer;
                            font-family: var(--font-family-body);
                            font-size: 12px;
                            color: var(--color-dark);
                            transition: all 0.2s;
                            user-select: none;
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        ">
                            <span style="font-weight: 600;">${column.name}</span>
                            <span style="color: var(--color-neutral-text-light);">(${column.type})</span>
                            ${column.isPrimaryKey ? '<i class="ph ph-key" style="color: var(--color-primary-blue); font-size: 10px;" title="Primary Key"></i>' : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            updateRelationshipPreview();
        }

        function updateTargetColumns() {
            const targetTable = document.getElementById('targetTable').value;
            const container = document.getElementById('targetColumnsContainer');

            selectedTargetColumns = [];

            if (!targetTable) {
                container.innerHTML = 'Select target table first';
                container.style.background = '#f8f8f8';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.display = 'flex';
                updateRelationshipPreview();
                return;
            }

            const columns = getColumnsForRelationships(targetTable);

            if (columns.length === 0) {
                // Debug: Show what we're looking for
                console.log('Debug: No columns found for targetTable:', targetTable);
                console.log('Debug: Available in existing function:', getColumnsForTable(targetTable));

                container.innerHTML = `No columns found for table "${targetTable}"<br><small style="color: #666;">Check browser console for debug info</small>`;
                container.style.background = '#fff3cd';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.display = 'flex';
                updateRelationshipPreview();
                return;
            }

            // Create column selection interface
            container.style.background = 'white';
            container.style.justifyContent = 'flex-start';
            container.style.alignItems = 'flex-start';
            container.style.display = 'block';

            container.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${columns.map(column => `
                        <div class="column-selector" data-column="${column.name}" onclick="toggleTargetColumn('${column.name}', this)" style="
                            padding: 6px 12px;
                            border: 1px solid var(--color-neutral-border);
                            border-radius: 16px;
                            background: white;
                            cursor: pointer;
                            font-family: var(--font-family-body);
                            font-size: 12px;
                            color: var(--color-dark);
                            transition: all 0.2s;
                            user-select: none;
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        ">
                            <span style="font-weight: 600;">${column.name}</span>
                            <span style="color: var(--color-neutral-text-light);">(${column.type})</span>
                            ${column.isPrimaryKey ? '<i class="ph ph-key" style="color: var(--color-primary-blue); font-size: 10px;" title="Primary Key"></i>' : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            // Auto-select primary key columns
            columns.forEach(column => {
                if (column.isPrimaryKey) {
                    const element = container.querySelector(`[data-column="${column.name}"]`);
                    if (element) {
                        toggleTargetColumn(column.name, element);
                    }
                }
            });

            updateRelationshipPreview();
        }

        function toggleSourceColumn(columnName, element) {
            const index = selectedSourceColumns.indexOf(columnName);
            if (index > -1) {
                // Deselect
                selectedSourceColumns.splice(index, 1);
                element.style.background = 'white';
                element.style.borderColor = 'var(--color-neutral-border)';
                element.style.color = 'var(--color-dark)';
            } else {
                // Select
                selectedSourceColumns.push(columnName);
                element.style.background = 'var(--color-primary-blue)';
                element.style.borderColor = 'var(--color-primary-blue)';
                element.style.color = 'white';
            }
            updateRelationshipPreview();
        }

        function toggleTargetColumn(columnName, element) {
            const index = selectedTargetColumns.indexOf(columnName);
            if (index > -1) {
                // Deselect
                selectedTargetColumns.splice(index, 1);
                element.style.background = 'white';
                element.style.borderColor = 'var(--color-neutral-border)';
                element.style.color = 'var(--color-dark)';
            } else {
                // Select
                selectedTargetColumns.push(columnName);
                element.style.background = 'var(--color-primary-blue)';
                element.style.borderColor = 'var(--color-primary-blue)';
                element.style.color = 'white';
            }
            updateRelationshipPreview();
        }

        function updateRelationshipPreview() {
            const sourceTable = document.getElementById('sourceTable').value;
            const targetTable = document.getElementById('targetTable').value;
            const relationshipType = document.getElementById('relationshipType').value;

            const previewDiv = document.getElementById('relationshipPreview');

            if (!sourceTable || !targetTable) {
                previewDiv.textContent = 'MAPS TO';
                previewDiv.style.color = 'var(--color-neutral-text)';
                return;
            }

            let preview = '';
            if (selectedSourceColumns.length > 0 && selectedTargetColumns.length > 0) {
                const sourceText = selectedSourceColumns.join(', ');
                const targetText = selectedTargetColumns.join(', ');
                const typeSymbol = relationshipType === 'many-to-one' ? 'M:1' :
                                 relationshipType === 'one-to-one' ? '1:1' : 'M:M';

                preview = `${sourceText} → (${typeSymbol}) → ${targetText}`;
                previewDiv.style.color = 'var(--color-primary-blue)';
            } else {
                preview = 'SELECT COLUMNS';
                previewDiv.style.color = 'var(--color-neutral-text)';
            }

            previewDiv.textContent = preview;
        }

        // Enhanced getColumnsForRelationships function that works with both stored schemas and defaults
        function getColumnsForRelationships(tableName) {
            // First check stored PostgreSQL schemas
            const savedSchemas = JSON.parse(localStorage.getItem('postgresTableSchemas') || '[]');
            const savedSchema = savedSchemas.find(schema =>
                schema.tableName.toLowerCase() === tableName.toLowerCase()
            );

            if (savedSchema && savedSchema.columns) {
                return savedSchema.columns.map(col => ({
                    name: col.name,
                    type: col.dataType || col.type || 'text',
                    nullable: col.nullable !== false,
                    isPrimaryKey: col.isPrimaryKey || false,
                    isUnique: col.isUnique || false
                }));
            }

            // Use the existing function for default tables but handle case variations
            // Try title case first (what the function expects)
            const titleCaseName = tableName.charAt(0).toUpperCase() + tableName.slice(1).toLowerCase();
            let existingColumns = getColumnsForTable(titleCaseName);

            // If that doesn't work, try the original name
            if (!existingColumns || existingColumns.length === 0) {
                existingColumns = getColumnsForTable(tableName);
            }

            if (existingColumns && existingColumns.length > 0) {
                return existingColumns.map(colName => {
                    // Detect common patterns for primary keys and types
                    const isPrimaryKey = colName.toLowerCase().includes('_id') || colName.toLowerCase() === 'id';
                    const type = isPrimaryKey ? 'uuid' :
                                colName.toLowerCase().includes('date') ? 'date' :
                                colName.toLowerCase().includes('email') ? 'varchar(100)' :
                                colName.toLowerCase().includes('name') ? 'varchar(100)' :
                                colName.toLowerCase().includes('phone') ? 'varchar(20)' :
                                'text';

                    return {
                        name: colName,
                        type: type,
                        isPrimaryKey: isPrimaryKey,
                        nullable: !isPrimaryKey,
                        isUnique: false
                    };
                });
            }

            return [];
        }

        function editRelationship(index) {
            const relationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');
            const rel = relationships[index];

            if (!rel) return;

            // Populate form with existing values
            document.getElementById('sourceTable').value = rel.sourceTable;
            document.getElementById('targetTable').value = rel.targetTable;
            document.getElementById('relationshipType').value = rel.type;
            document.getElementById('relationshipLabel').value = rel.label;

            // Update columns and select them if they exist in the new format
            updateSourceColumns();
            updateTargetColumns();

            // Select the previously saved columns (for enhanced relationships)
            if (rel.sourceColumns && rel.sourceColumns.length > 0) {
                selectedSourceColumns = [...rel.sourceColumns];
                // Re-render and select the columns
                setTimeout(() => {
                    rel.sourceColumns.forEach(columnName => {
                        const element = document.querySelector(`#sourceColumnsContainer [data-column="${columnName}"]`);
                        if (element) {
                            element.style.background = 'var(--color-primary-blue)';
                            element.style.borderColor = 'var(--color-primary-blue)';
                            element.style.color = 'white';
                        }
                    });
                }, 50);
            }

            if (rel.targetColumns && rel.targetColumns.length > 0) {
                selectedTargetColumns = [...rel.targetColumns];
                // Re-render and select the columns
                setTimeout(() => {
                    rel.targetColumns.forEach(columnName => {
                        const element = document.querySelector(`#targetColumnsContainer [data-column="${columnName}"]`);
                        if (element) {
                            element.style.background = 'var(--color-primary-blue)';
                            element.style.borderColor = 'var(--color-primary-blue)';
                            element.style.color = 'white';
                        }
                    });
                }, 50);
            }

            updateRelationshipPreview();

            // Delete the old one (we'll add the edited version when user clicks Add)
            deleteRelationship(index, true);

            // Scroll to top
            document.querySelector('#relationshipManagerModal .modal-body').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRelationship(index, skipConfirm = false) {
            if (!skipConfirm && !confirm('Are you sure you want to delete this relationship?')) {
                return;
            }

            const relationships = JSON.parse(localStorage.getItem('tableRelationships') || '[]');
            relationships.splice(index, 1);
            localStorage.setItem('tableRelationships', JSON.stringify(relationships));

            // Reload list
            loadRelationships();

            // Update ERD if it's visible
            if (document.getElementById('tablesRelationshipsView').style.display !== 'none') {
                renderTablesERD();
            }

            if (!skipConfirm) {
                showToast('Relationship deleted', 'success');
            }
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: ${type === 'success' ? '#16a34a' : '#0066CC'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-family: var(--font-family-body);
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideInUp 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutDown 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Table Guided Setup Functions
        let currentTableGuidedStep = 1;
        let selectedTableTemplate = null;

        const tableTemplates = {
            inventory: {
                name: 'Inventory Management',
                tableName: 'inventory_items',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'item_name', dataType: 'varchar', notNull: true },
                    { name: 'sku', dataType: 'varchar', unique: true },
                    { name: 'quantity', dataType: 'integer', notNull: true },
                    { name: 'location', dataType: 'varchar' },
                    { name: 'supplier', dataType: 'varchar' },
                    { name: 'reorder_point', dataType: 'integer' },
                    { name: 'unit_cost', dataType: 'decimal' },
                    { name: 'last_updated', dataType: 'timestamptz' }
                ]
            },
            calendar: {
                name: 'Event Calendar',
                tableName: 'events',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'event_name', dataType: 'varchar', notNull: true },
                    { name: 'event_date', dataType: 'date', notNull: true },
                    { name: 'event_time', dataType: 'time' },
                    { name: 'attendees', dataType: 'text' },
                    { name: 'location', dataType: 'varchar' },
                    { name: 'status', dataType: 'varchar' },
                    { name: 'reminder_sent', dataType: 'boolean' },
                    { name: 'created_at', dataType: 'timestamptz' }
                ]
            },
            backlog: {
                name: 'Sprint Backlog',
                tableName: 'backlog_items',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'title', dataType: 'varchar', notNull: true },
                    { name: 'description', dataType: 'text' },
                    { name: 'priority', dataType: 'varchar' },
                    { name: 'story_points', dataType: 'integer' },
                    { name: 'assignee', dataType: 'varchar' },
                    { name: 'sprint', dataType: 'varchar' },
                    { name: 'status', dataType: 'varchar', notNull: true },
                    { name: 'created_at', dataType: 'timestamptz' }
                ]
            },
            assets: {
                name: 'Asset Management',
                tableName: 'assets',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'asset_name', dataType: 'varchar', notNull: true },
                    { name: 'asset_type', dataType: 'varchar' },
                    { name: 'owner', dataType: 'varchar' },
                    { name: 'purchase_date', dataType: 'date' },
                    { name: 'purchase_value', dataType: 'decimal' },
                    { name: 'current_value', dataType: 'decimal' },
                    { name: 'location', dataType: 'varchar' },
                    { name: 'status', dataType: 'varchar' }
                ]
            },
            wip: {
                name: 'Work in Progress',
                tableName: 'wip_projects',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'project_name', dataType: 'varchar', notNull: true },
                    { name: 'description', dataType: 'text' },
                    { name: 'status', dataType: 'varchar', notNull: true },
                    { name: 'progress_percent', dataType: 'integer' },
                    { name: 'due_date', dataType: 'date' },
                    { name: 'owner', dataType: 'varchar' },
                    { name: 'started_at', dataType: 'timestamptz' },
                    { name: 'completed_at', dataType: 'timestamptz' }
                ]
            },
            contacts: {
                name: 'Contacts & CRM',
                tableName: 'contacts',
                columns: [
                    { name: 'id', dataType: 'serial', primaryKey: true, notNull: true },
                    { name: 'full_name', dataType: 'varchar', notNull: true },
                    { name: 'email', dataType: 'varchar', unique: true },
                    { name: 'phone', dataType: 'varchar' },
                    { name: 'company', dataType: 'varchar' },
                    { name: 'role', dataType: 'varchar' },
                    { name: 'notes', dataType: 'text' },
                    { name: 'last_contacted', dataType: 'date' },
                    { name: 'created_at', dataType: 'timestamptz' }
                ]
            }
        };

        function openTableGuidedSetup() {
            const modal = document.getElementById('tableGuidedSetupModal');
            currentTableGuidedStep = 1;
            selectedTableTemplate = null;

            // Reset form
            document.getElementById('guidedTableName').value = '';
            document.querySelectorAll('[data-table-template]').forEach(card => card.classList.remove('selected'));

            updateTableGuidedStep(1);
            modal.classList.add('active');
        }

        function closeTableGuidedSetup() {
            const modal = document.getElementById('tableGuidedSetupModal');
            modal.classList.remove('active');
        }

        function selectTableTemplate(template) {
            selectedTableTemplate = template;

            // Update visual selection
            document.querySelectorAll('[data-table-template]').forEach(card => {
                if (card.dataset.tableTemplate === template) {
                    card.classList.add('selected');
                    card.querySelector('.template-check').style.display = 'block';
                } else {
                    card.classList.remove('selected');
                    card.querySelector('.template-check').style.display = 'none';
                }
            });

            // Pre-fill table name in step 2
            const templateData = tableTemplates[template];
            if (templateData) {
                document.getElementById('guidedTableName').value = templateData.tableName;
            }
        }

        function updateTableGuidedStep(step) {
            currentTableGuidedStep = step;

            // Update progress bar
            const progressPercent = (step / 3) * 100;
            document.getElementById('tableGuidedProgressFill').style.width = progressPercent + '%';
            document.getElementById('tableGuidedProgressText').textContent = `Step ${step} of 3`;

            // Update step content visibility
            for (let i = 1; i <= 3; i++) {
                const stepContent = document.getElementById(`tableGuidedStep${i}`);
                if (stepContent) {
                    if (i === step) {
                        stepContent.classList.add('active');
                    } else {
                        stepContent.classList.remove('active');
                    }
                }
            }

            // Update button visibility
            const backBtn = document.getElementById('tableGuidedBackBtn');
            const continueBtn = document.getElementById('tableGuidedContinueBtn');
            const createBtn = document.getElementById('tableGuidedCreateBtn');

            backBtn.style.display = step === 1 ? 'none' : 'block';

            if (step === 3) {
                continueBtn.style.display = 'none';
                createBtn.style.display = 'flex';
                updateTableGuidedReview();
            } else {
                continueBtn.style.display = 'flex';
                createBtn.style.display = 'none';
            }

            // Update step 2 columns preview
            if (step === 2 && selectedTableTemplate) {
                updateColumnsPreview();
            }
        }

        function updateColumnsPreview() {
            const templateData = tableTemplates[selectedTableTemplate];
            if (!templateData) return;

            const container = document.getElementById('guidedColumnsContent');
            container.innerHTML = templateData.columns.map(col => {
                const badges = [];
                if (col.primaryKey) badges.push('<span style="padding: 2px 6px; background: #dbeafe; color: #1e40af; border-radius: 3px; font-size: 9px; font-weight: 600;">PRIMARY KEY</span>');
                if (col.notNull) badges.push('<span style="padding: 2px 6px; background: #fee2e2; color: #991b1b; border-radius: 3px; font-size: 9px; font-weight: 600;">NOT NULL</span>');
                if (col.unique) badges.push('<span style="padding: 2px 6px; background: #fef3c7; color: #92400e; border-radius: 3px; font-size: 9px; font-weight: 600;">UNIQUE</span>');

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: white; border-radius: 6px; border: 1px solid var(--color-neutral-border);">
                        <div style="flex: 1;">
                            <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">${col.name}</span>
                            <span style="margin-left: 12px; font-family: monospace; font-size: 12px; color: var(--color-neutral-text);">${col.dataType.toUpperCase()}</span>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            ${badges.join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTableGuidedReview() {
            const templateData = tableTemplates[selectedTableTemplate];
            const tableName = document.getElementById('guidedTableName').value.trim() || templateData.tableName;

            const reviewContainer = document.getElementById('guidedTableReview');
            reviewContainer.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">Table Name</h5>
                    <div style="font-family: monospace; font-size: 15px; color: var(--color-primary-blue); font-weight: 600;">public.${tableName}</div>
                </div>
                <div>
                    <h5 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0;">Columns (${templateData.columns.length})</h5>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${templateData.columns.map(col => {
                            const badges = [];
                            if (col.primaryKey) badges.push('<span style="padding: 2px 6px; background: #dbeafe; color: #1e40af; border-radius: 3px; font-size: 9px; font-weight: 600;">PK</span>');
                            if (col.notNull) badges.push('<span style="padding: 2px 6px; background: #fee2e2; color: #991b1b; border-radius: 3px; font-size: 9px; font-weight: 600;">NOT NULL</span>');
                            if (col.unique) badges.push('<span style="padding: 2px 6px; background: #fef3c7; color: #92400e; border-radius: 3px; font-size: 9px; font-weight: 600;">UNIQUE</span>');

                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: white; border-radius: 6px;">
                                    <div style="flex: 1;">
                                        <span style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark);">${col.name}</span>
                                        <span style="margin-left: 12px; font-family: monospace; font-size: 12px; color: var(--color-neutral-text);">${col.dataType.toUpperCase()}</span>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        ${badges.join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function nextTableGuidedStep() {
            if (currentTableGuidedStep === 1 && !selectedTableTemplate) {
                alert('Please select a table template');
                return;
            }

            if (currentTableGuidedStep === 2) {
                const tableName = document.getElementById('guidedTableName').value.trim();
                if (!tableName) {
                    alert('Please enter a table name');
                    return;
                }
            }

            if (currentTableGuidedStep < 3) {
                updateTableGuidedStep(currentTableGuidedStep + 1);
            }
        }

        function previousTableGuidedStep() {
            if (currentTableGuidedStep > 1) {
                updateTableGuidedStep(currentTableGuidedStep - 1);
            }
        }

        function createTableFromGuided() {
            const templateData = tableTemplates[selectedTableTemplate];
            const tableName = document.getElementById('guidedTableName').value.trim() || templateData.tableName;

            // Populate the main table wizard with this configuration
            tableColumns = [];
            columnIdCounter = 0;

            document.getElementById('schemaName').value = 'public';
            document.getElementById('tableName').value = tableName;
            document.getElementById('tableComment').value = `${templateData.name} table created via guided setup`;
            document.getElementById('ifNotExists').checked = true;
            document.getElementById('temporary').checked = false;
            document.getElementById('unlogged').checked = false;
            document.getElementById('tableColumnsContainer').innerHTML = '';

            // Add all columns from template
            templateData.columns.forEach(col => {
                addTableColumn(col);
            });

            // Close guided setup and open main wizard
            closeTableGuidedSetup();
            openModal('tableWizardModal');
        }

        // Forms Management
        function openFormsSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Forms';

                // Hide all content sections
                hideAllContentSections();

                // Show forms content
                document.getElementById('formsContent').style.display = 'block';
                loadFormTypeCards();
            });
        }

        function loadFormTypeCards() {
            const container = document.getElementById('formsContainer');

            const formTypes = [
                {
                    name: 'Contact Forms',
                    icon: 'ph-envelope',
                    description: 'Customer inquiry forms, feedback forms, and contact requests.',
                    tags: ['Customer Service', 'Sales', 'Support']
                },
                {
                    name: 'Survey Forms',
                    icon: 'ph-chart-line',
                    description: 'Employee surveys, customer satisfaction, and feedback collection.',
                    tags: ['HR', 'Customer Success', 'Marketing']
                },
                {
                    name: 'Registration Forms',
                    icon: 'ph-user-plus',
                    description: 'Event registration, account creation, and user onboarding.',
                    tags: ['Events', 'Marketing', 'Operations']
                },
                {
                    name: 'Application Forms',
                    icon: 'ph-file-text',
                    description: 'Job applications, program applications, and request forms.',
                    tags: ['HR', 'Recruiting', 'Operations']
                },
                {
                    name: 'Order Forms',
                    icon: 'ph-shopping-cart',
                    description: 'Product orders, service requests, and purchase forms.',
                    tags: ['Sales', 'E-commerce', 'Operations']
                },
                {
                    name: 'Feedback Forms',
                    icon: 'ph-chat-circle-dots',
                    description: 'Product feedback, service reviews, and suggestion forms.',
                    tags: ['Product', 'Customer Success', 'Quality']
                }
            ];

            createCardGrid(container, formTypes, 'Form');
        }

        // Documents Management
        function openDocumentsSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Documents';

                // Hide all content sections
                hideAllContentSections();

                // Show documents content
                document.getElementById('documentsContent').style.display = 'block';
                loadDocumentTypeCards();
            });
        }

        function loadDocumentTypeCards() {
            const container = document.getElementById('documentsContainer');

            const documentTypes = [
                {
                    name: 'Proposals',
                    icon: 'ph-file-text',
                    description: 'Business proposals, project bids, and RFP responses.',
                    tags: ['Business', 'Sales', 'Contracts']
                },
                {
                    name: 'Contracts',
                    icon: 'ph-file-doc',
                    description: 'Legal agreements, NDAs, and service contracts.',
                    tags: ['Legal', 'Compliance', 'Business']
                },
                {
                    name: 'Presentations',
                    icon: 'ph-presentation',
                    description: 'Slide decks, pitch presentations, and meeting materials.',
                    tags: ['Marketing', 'Sales', 'Internal']
                },
                {
                    name: 'Policies',
                    icon: 'ph-book',
                    description: 'Company policies, procedures, and guidelines.',
                    tags: ['HR', 'Compliance', 'Operations']
                },
                {
                    name: 'Manuals',
                    icon: 'ph-notebook',
                    description: 'User guides, training materials, and documentation.',
                    tags: ['Training', 'Support', 'Operations']
                },
                {
                    name: 'Invoices',
                    icon: 'ph-receipt',
                    description: 'Billing documents, invoices, and payment records.',
                    tags: ['Finance', 'Accounting', 'Business']
                }
            ];

            createCardGrid(container, documentTypes, 'Document');
        }

        // Reports Management
        function openReportsSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Reports';

                // Hide all content sections
                hideAllContentSections();

                // Show reports content
                document.getElementById('reportsContent').style.display = 'block';
                loadReportTypeCards();
            });
        }

        function loadReportTypeCards() {
            const container = document.getElementById('reportsContainer');

            const reportTypes = [
                {
                    name: 'Sales Dashboard',
                    icon: 'ph-chart-line',
                    description: 'Revenue tracking, pipeline analysis, and sales performance metrics.',
                    tags: ['Sales', 'Revenue', 'KPIs']
                },
                {
                    name: 'Financial Reports',
                    icon: 'ph-currency-dollar',
                    description: 'P&L statements, balance sheets, and cash flow analysis.',
                    tags: ['Finance', 'Accounting', 'Executive']
                },
                {
                    name: 'Project Status',
                    icon: 'ph-kanban',
                    description: 'Project timelines, milestone tracking, and resource utilization.',
                    tags: ['Projects', 'Operations', 'Management']
                },
                {
                    name: 'Customer Analytics',
                    icon: 'ph-users-three',
                    description: 'Customer behavior, retention rates, and satisfaction scores.',
                    tags: ['Customer Success', 'Analytics', 'Marketing']
                },
                {
                    name: 'Performance Metrics',
                    icon: 'ph-gauge',
                    description: 'Team performance, productivity tracking, and OKR progress.',
                    tags: ['HR', 'Management', 'Operations']
                },
                {
                    name: 'Marketing Analytics',
                    icon: 'ph-megaphone',
                    description: 'Campaign performance, lead generation, and conversion rates.',
                    tags: ['Marketing', 'Analytics', 'Sales']
                }
            ];

            createCardGrid(container, reportTypes, 'Report');
        }

        // Templates Management
        function openTemplatesSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Templates';

                // Hide all content sections
                hideAllContentSections();

                // Show templates content
                document.getElementById('templatesContent').style.display = 'block';
                loadTemplateTypeCards();
            });
        }

        function loadTemplateTypeCards() {
            const container = document.getElementById('templatesContainer');

            const templateTypes = [
                {
                    name: 'Email Templates',
                    icon: 'ph-envelope',
                    description: 'Pre-written emails for common business communications.',
                    tags: ['Communication', 'Sales', 'Support']
                },
                {
                    name: 'Meeting Agendas',
                    icon: 'ph-calendar-check',
                    description: 'Structured agendas for meetings and planning sessions.',
                    tags: ['Meetings', 'Operations', 'Management']
                },
                {
                    name: 'Report Templates',
                    icon: 'ph-file-chart',
                    description: 'Standardized formats for recurring reports and analysis.',
                    tags: ['Reporting', 'Analytics', 'Executive']
                },
                {
                    name: 'Onboarding Checklists',
                    icon: 'ph-user-plus',
                    description: 'Step-by-step guides for employee onboarding processes.',
                    tags: ['HR', 'Training', 'Operations']
                },
                {
                    name: 'Project Plans',
                    icon: 'ph-folder-notch',
                    description: 'Project planning templates with timelines and deliverables.',
                    tags: ['Projects', 'Management', 'Operations']
                },
                {
                    name: 'SOP Documents',
                    icon: 'ph-list-checks',
                    description: 'Standard operating procedure templates for processes.',
                    tags: ['Operations', 'Compliance', 'Training']
                }
            ];

            createCardGrid(container, templateTypes, 'Template');
        }

        // Pipelines Management
        function openPipelinesSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'ML Pipelines';

                // Hide all content sections
                hideAllContentSections();

                // Show pipelines content
                document.getElementById('pipelinesContent').style.display = 'block';
                loadPipelineCards();
            });
        }

        function loadPipelineCards() {
            const container = document.getElementById('pipelinesContainer');

            const pipelineTypes = [
                {
                    name: 'Cleansheet Content Pipeline',
                    icon: 'ph-flow-arrow',
                    description: 'AI-powered content transformation from corpus to multi-format, multi-language delivery with interactive NL interfaces.',
                    tags: ['Content', 'ML Processing', 'Multi-format']
                },
                {
                    name: 'Document Intelligence Pipeline',
                    icon: 'ph-file-magnifying-glass',
                    description: 'Extract, analyze, and classify documents using OCR, NLP, and entity recognition for automated processing.',
                    tags: ['OCR', 'NLP', 'Classification']
                },
                {
                    name: 'Customer Analytics Pipeline',
                    icon: 'ph-chart-line-up',
                    description: 'Real-time customer behavior analysis with sentiment detection, churn prediction, and recommendation generation.',
                    tags: ['Analytics', 'Prediction', 'Real-time']
                },
                {
                    name: 'Image Recognition Pipeline',
                    icon: 'ph-image',
                    description: 'Computer vision pipeline for object detection, facial recognition, and automated image tagging and categorization.',
                    tags: ['Computer Vision', 'Detection', 'Tagging']
                },
                {
                    name: 'Voice Processing Pipeline',
                    icon: 'ph-microphone',
                    description: 'Speech-to-text transcription, voice authentication, and natural language understanding for voice applications.',
                    tags: ['Speech', 'Transcription', 'NLU']
                }
            ];

            createCardGrid(container, pipelineTypes, 'Pipeline');
        }

        // Pipeline Wizard Functions
        let currentWizardStep = 1;
        let selectedSource = null;

        function openPipelineWizard() {
            const modal = document.getElementById('pipelineWizardModal');
            currentWizardStep = 1;
            selectedSource = null;

            // Reset form
            document.getElementById('pipelineName').value = '';
            document.getElementById('pipelineType').value = '';
            document.getElementById('pipelineDescription').value = '';
            document.getElementById('pipelineTags').value = '';
            document.getElementById('llmProvider').value = '';
            document.getElementById('processingFrequency').value = 'realtime';
            document.getElementById('batchSize').value = '100';
            document.getElementById('errorHandling').value = 'retry';
            document.getElementById('enableLogging').checked = true;
            document.getElementById('enableMetrics').checked = true;
            document.getElementById('customParams').value = '';
            document.getElementById('outputFormat').value = 'json';
            document.getElementById('notificationEmails').value = '';

            // Clear output checkboxes
            document.querySelectorAll('.output-destination').forEach(cb => cb.checked = false);

            // Clear source selection
            document.querySelectorAll('.source-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('sourceDetails').style.display = 'none';

            updateWizardStep(1);
            modal.classList.add('active');
        }

        function closePipelineWizard() {
            const modal = document.getElementById('pipelineWizardModal');
            modal.classList.remove('active');
        }

        function updateWizardStep(step) {
            currentWizardStep = step;

            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach((stepEl, index) => {
                const stepNum = index + 1;
                if (stepNum < step) {
                    stepEl.classList.add('completed');
                    stepEl.classList.remove('active');
                } else if (stepNum === step) {
                    stepEl.classList.add('active');
                    stepEl.classList.remove('completed');
                } else {
                    stepEl.classList.remove('active', 'completed');
                }
            });

            // Update step content visibility
            document.querySelectorAll('.wizard-step-content').forEach((content, index) => {
                if (index + 1 === step) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            // Update button visibility
            const prevBtn = document.getElementById('wizardPrevBtn');
            const nextBtn = document.getElementById('wizardNextBtn');
            const finishBtn = document.getElementById('wizardFinishBtn');

            prevBtn.style.display = step === 1 ? 'none' : 'block';

            if (step === 4) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                finishBtn.style.display = 'none';
            }
        }

        function nextWizardStep() {
            // Basic validation
            if (currentWizardStep === 1) {
                const name = document.getElementById('pipelineName').value.trim();
                const type = document.getElementById('pipelineType').value;

                if (!name || !type) {
                    alert('Please fill in all required fields (Pipeline Name and Type)');
                    return;
                }
            }

            if (currentWizardStep === 2) {
                if (!selectedSource) {
                    alert('Please select an input source');
                    return;
                }
            }

            if (currentWizardStep === 4) {
                const outputDestinations = document.querySelectorAll('.output-destination:checked');
                if (outputDestinations.length === 0) {
                    alert('Please select at least one output destination');
                    return;
                }
            }

            if (currentWizardStep < 4) {
                updateWizardStep(currentWizardStep + 1);
            }
        }

        function previousWizardStep() {
            if (currentWizardStep > 1) {
                updateWizardStep(currentWizardStep - 1);
            }
        }

        function selectSource(sourceType) {
            selectedSource = sourceType;

            // Update visual selection
            document.querySelectorAll('.source-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.source-option').classList.add('selected');

            // Show source-specific configuration
            const detailsDiv = document.getElementById('sourceDetails');
            detailsDiv.style.display = 'block';

            let configHTML = '';

            switch(sourceType) {
                case 'file':
                    configHTML = `
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">File Service</label>
                            <select style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                                <option value="">Select service...</option>
                                <option value="dropbox">Dropbox</option>
                                <option value="onedrive">OneDrive</option>
                                <option value="googledrive">Google Drive</option>
                                <option value="box">Box</option>
                                <option value="sharepoint">SharePoint</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Folder Path</label>
                            <input type="text" placeholder="/pipelines/input" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    `;
                    break;
                case 'database':
                    configHTML = `
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Database Type</label>
                            <select style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                                <option value="">Select type...</option>
                                <option value="sql">Azure SQL Database</option>
                                <option value="cosmos">Cosmos DB</option>
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mongodb">MongoDB</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Connection String</label>
                            <input type="password" placeholder="Server=..." style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    `;
                    break;
                case 'api':
                    configHTML = `
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">API Endpoint URL</label>
                            <input type="url" placeholder="https://api.example.com/data" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Authentication</label>
                            <select style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                                <option value="none">None</option>
                                <option value="apikey">API Key</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="oauth">OAuth 2.0</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'stream':
                    configHTML = `
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Stream Type</label>
                            <select style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px; cursor: pointer;">
                                <option value="">Select type...</option>
                                <option value="eventhub">Azure Event Hub</option>
                                <option value="kafka">Apache Kafka</option>
                                <option value="iothub">IoT Hub</option>
                                <option value="servicebus">Service Bus</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 6px;">Connection String</label>
                            <input type="password" placeholder="Endpoint=..." style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    `;
                    break;
            }

            detailsDiv.innerHTML = configHTML;
        }

        function finishPipelineWizard() {
            // Validate final step
            const outputDestinations = document.querySelectorAll('.output-destination:checked');
            if (outputDestinations.length === 0) {
                alert('Please select at least one output destination');
                return;
            }

            // Collect all form data
            const pipelineData = {
                name: document.getElementById('pipelineName').value,
                type: document.getElementById('pipelineType').value,
                description: document.getElementById('pipelineDescription').value,
                tags: document.getElementById('pipelineTags').value.split(',').map(t => t.trim()).filter(t => t),
                source: selectedSource,
                llmProvider: document.getElementById('llmProvider').value,
                processingFrequency: document.getElementById('processingFrequency').value,
                batchSize: parseInt(document.getElementById('batchSize').value),
                errorHandling: document.getElementById('errorHandling').value,
                enableLogging: document.getElementById('enableLogging').checked,
                enableMetrics: document.getElementById('enableMetrics').checked,
                customParams: document.getElementById('customParams').value,
                outputFormat: document.getElementById('outputFormat').value,
                outputDestinations: Array.from(outputDestinations).map(cb => cb.value),
                notificationEmails: document.getElementById('notificationEmails').value.split(',').map(e => e.trim()).filter(e => e),
                createdAt: new Date().toISOString()
            };

            console.log('Pipeline created:', pipelineData);

            // Show success message
            alert(`Pipeline "${pipelineData.name}" created successfully!`);

            // Close wizard
            closePipelineWizard();

            // Reload pipeline cards to show the new pipeline
            // In production, this would make an API call to save the pipeline
            loadPipelineCards();
        }

        // Close wizard when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const wizardModal = document.getElementById('pipelineWizardModal');
            if (wizardModal) {
                wizardModal.addEventListener('click', function(e) {
                    if (e.target === wizardModal) {
                        closePipelineWizard();
                    }
                });
            }

            // Close simple wizard when clicking outside
            const simpleWizardModal = document.getElementById('simplePipelineWizardModal');
            if (simpleWizardModal) {
                simpleWizardModal.addEventListener('click', function(e) {
                    if (e.target === simpleWizardModal) {
                        closeSimplePipelineWizard();
                    }
                });
            }
        });

        // Simple Pipeline Wizard Functions
        let currentSimpleStep = 1;
        let selectedTemplate = null;
        let selectedSimpleSourceType = null;
        let selectedFrequencyType = 'manual';

        function openSimplePipelineWizard() {
            const modal = document.getElementById('simplePipelineWizardModal');
            currentSimpleStep = 1;
            selectedTemplate = null;
            selectedSimpleSourceType = null;
            selectedFrequencyType = 'manual';

            // Reset form
            document.getElementById('simplePipelineName').value = '';
            document.querySelectorAll('.template-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.simple-source-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('scheduleOptions').style.display = 'none';
            document.getElementById('simpleSourceHelp').style.display = 'none';

            // Show modal first
            modal.classList.add('active');

            // Then update step with a small delay to ensure DOM is ready
            setTimeout(() => {
                updateSimpleWizardStep(1);
            }, 10);
        }

        function closeSimplePipelineWizard() {
            const modal = document.getElementById('simplePipelineWizardModal');
            modal.classList.remove('active');
        }

        function updateSimpleWizardStep(step) {
            currentSimpleStep = step;

            try {
                // Update progress bar
                const progressPercent = (step / 4) * 100;
                const progressFill = document.getElementById('simpleProgressFill');
                const progressText = document.getElementById('simpleProgressText');

                if (progressFill) progressFill.style.width = progressPercent + '%';
                if (progressText) progressText.textContent = `Step ${step} of 4`;

                // Update step content visibility - be more explicit about which modal
                const modal = document.getElementById('simplePipelineWizardModal');
                if (modal) {
                    const stepContents = modal.querySelectorAll('.simple-wizard-step-content');
                    stepContents.forEach((content, index) => {
                        if (index + 1 === step) {
                            content.style.display = 'block';
                            content.classList.add('active');
                        } else {
                            content.style.display = 'none';
                            content.classList.remove('active');
                        }
                    });
                }

                // Update button visibility
                const backBtn = document.getElementById('simpleWizardBackBtn');
                const continueBtn = document.getElementById('simpleWizardContinueBtn');
                const createBtn = document.getElementById('simpleWizardCreateBtn');

                if (backBtn) backBtn.style.display = step === 1 ? 'none' : 'block';

                if (step === 4) {
                    if (continueBtn) continueBtn.style.display = 'none';
                    if (createBtn) createBtn.style.display = 'flex';
                    // Update review summary
                    updateReviewSummary();
                } else {
                    if (continueBtn) continueBtn.style.display = 'flex';
                    if (createBtn) createBtn.style.display = 'none';
                }

                console.log(`Simple wizard step ${step} updated - found ${modal?.querySelectorAll('.simple-wizard-step-content').length} step elements`);

            } catch (error) {
                console.error('Error in updateSimpleWizardStep:', error);
            }
        }

        function selectTemplate(template) {
            selectedTemplate = template;

            // Update visual selection
            document.querySelectorAll('.template-card').forEach(card => {
                if (card.dataset.template === template) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        function selectFrequency(frequency) {
            selectedFrequencyType = frequency;

            // Show/hide schedule options
            if (frequency === 'automatic') {
                document.getElementById('scheduleOptions').style.display = 'block';
            } else {
                document.getElementById('scheduleOptions').style.display = 'none';
            }
        }

        function selectSimpleSource(source) {
            selectedSimpleSourceType = source;

            // Update visual selection
            document.querySelectorAll('.simple-source-card').forEach(card => {
                if (card.dataset.source === source) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            // Show helpful text
            const helpDiv = document.getElementById('simpleSourceHelp');
            const helpText = document.getElementById('simpleSourceHelpText');
            helpDiv.style.display = 'block';

            const helpMessages = {
                'dropbox': 'After creating your pipeline, you\'ll connect your Dropbox account and choose which folder to monitor.',
                'onedrive': 'After creating your pipeline, you\'ll sign in to Microsoft and select your OneDrive folder.',
                'googledrive': 'After creating your pipeline, you\'ll connect your Google account and choose the folder to watch.',
                'computer': 'After creating your pipeline, you\'ll be able to upload files directly from your computer.'
            };

            helpText.textContent = helpMessages[source] || '';
        }

        function nextSimpleWizardStep() {
            // Validation for each step
            if (currentSimpleStep === 1) {
                if (!selectedTemplate) {
                    alert('Please choose a pipeline template to continue');
                    return;
                }
            }

            if (currentSimpleStep === 2) {
                const name = document.getElementById('simplePipelineName').value.trim();
                if (!name) {
                    alert('Please give your pipeline a name');
                    return;
                }
            }

            if (currentSimpleStep === 3) {
                if (!selectedSimpleSourceType) {
                    alert('Please choose where your data is stored');
                    return;
                }
            }

            if (currentSimpleStep < 4) {
                updateSimpleWizardStep(currentSimpleStep + 1);
            }
        }

        function previousSimpleWizardStep() {
            if (currentSimpleStep > 1) {
                updateSimpleWizardStep(currentSimpleStep - 1);
            }
        }

        function updateReviewSummary() {
            // Template
            const templateNames = {
                'content': 'Content Transformation',
                'data': 'Data Analysis',
                'image': 'Image Processing'
            };
            document.getElementById('reviewTemplate').textContent = templateNames[selectedTemplate] || 'Not selected';

            // Name
            document.getElementById('reviewName').textContent = document.getElementById('simplePipelineName').value || 'Unnamed Pipeline';

            // Schedule
            let scheduleText = 'Manual (you start it when needed)';
            if (selectedFrequencyType === 'automatic') {
                const schedule = document.getElementById('simpleSchedule').value;
                const scheduleTexts = {
                    'hourly': 'Automatic - Every hour',
                    'daily': 'Automatic - Once a day',
                    'weekly': 'Automatic - Once a week'
                };
                scheduleText = scheduleTexts[schedule] || 'Automatic';
            }
            document.getElementById('reviewSchedule').textContent = scheduleText;

            // Source
            const sourceNames = {
                'dropbox': 'Dropbox',
                'onedrive': 'Microsoft OneDrive',
                'googledrive': 'Google Drive',
                'computer': 'My Computer (manual upload)'
            };
            document.getElementById('reviewSource').textContent = sourceNames[selectedSimpleSourceType] || 'Not selected';
        }

        function finishSimplePipelineWizard() {
            // Collect all form data
            const pipelineData = {
                template: selectedTemplate,
                name: document.getElementById('simplePipelineName').value,
                frequency: selectedFrequencyType,
                schedule: selectedFrequencyType === 'automatic' ? document.getElementById('simpleSchedule').value : null,
                source: selectedSimpleSourceType,
                guided: true,
                createdAt: new Date().toISOString()
            };

            console.log('Simple Pipeline created:', pipelineData);

            // Show success message with encouragement
            alert(`🎉 Success! Your pipeline "${pipelineData.name}" has been created!\n\nNext steps:\n1. Connect to your ${pipelineData.source === 'computer' ? 'data source' : sourceNames[pipelineData.source]}\n2. Test your pipeline with sample data\n3. Start processing!`);

            // Close wizard
            closeSimplePipelineWizard();

            // Reload pipeline cards
            loadPipelineCards();
        }

        const sourceNames = {
            'dropbox': 'Dropbox',
            'onedrive': 'OneDrive',
            'googledrive': 'Google Drive',
            'computer': 'computer'
        };

        // Workflows Management
        function openWorkflowsSlideout() {
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');

                titleEl.textContent = 'Workflows';

                // Hide all content sections
                hideAllContentSections();

                // Show workflows content
                document.getElementById('workflowsContent').style.display = 'block';
                loadWorkflowTypeCards();
            });
        }

        function loadWorkflowTypeCards() {
            const container = document.getElementById('workflowsContainer');

            const workflowTypes = [
                {
                    name: 'Approval Workflows',
                    icon: 'ph-check-circle',
                    description: 'Multi-level approval processes for documents and requests.',
                    tags: ['Operations', 'Management', 'Compliance']
                },
                {
                    name: 'Onboarding Automation',
                    icon: 'ph-users',
                    description: 'Automated employee onboarding with task assignments.',
                    tags: ['HR', 'Operations', 'Automation']
                },
                {
                    name: 'Lead Routing',
                    icon: 'ph-arrow-circle-right',
                    description: 'Automatic lead assignment based on criteria and availability.',
                    tags: ['Sales', 'Marketing', 'Automation']
                },
                {
                    name: 'Issue Escalation',
                    icon: 'ph-warning-circle',
                    description: 'Automatic escalation of issues based on severity and time.',
                    tags: ['Support', 'Operations', 'Management']
                },
                {
                    name: 'Document Review',
                    icon: 'ph-file-magnifying-glass',
                    description: 'Collaborative document review and feedback collection.',
                    tags: ['Collaboration', 'Operations', 'Quality']
                },
                {
                    name: 'Inventory Alerts',
                    icon: 'ph-package',
                    description: 'Automated notifications for low stock and reorder points.',
                    tags: ['Inventory', 'Operations', 'Automation']
                }
            ];

            createCardGrid(container, workflowTypes, 'Workflow');
        }

        // Shared card creation function
        function createCardGrid(container, items, typeName) {
            container.innerHTML = '';

            items.forEach(item => {
                const card = document.createElement('div');
                card.style.cssText = 'padding: 20px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px;';

                card.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="ph ${item.icon}" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${item.name}</div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="event.stopPropagation(); editItem('${item.name}')" title="Edit" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-pencil-simple" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteItem('${item.name}')" title="Delete" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                            </button>
                            <button onclick="event.stopPropagation(); shareItem('${item.name}')" title="Share" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                        </div>
                    </div>
                    <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">
                        ${item.description}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${item.tags.map(tag => `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${tag}</span>`).join('')}
                    </div>
                    <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">SHARED WITH</div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: var(--color-primary-blue);">AM</div>
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #f3e5f5; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: #7b1fa2;">JS</div>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">+ 3 others</span>
                        </div>
                    </div>
                `;

                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = 'var(--color-primary-blue)';
                    card.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.15)';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = 'var(--color-neutral-border)';
                    card.style.boxShadow = 'none';
                });

                card.addEventListener('click', () => {
                    alert(`${item.name} ${typeName.toLowerCase()} functionality coming soon!`);
                });

                container.appendChild(card);
            });
        }

        // Workflow Creation Functions
        let workflowStates = [];
        let workflowTags = [];

        function openNewWorkflowModal() {
            const modal = document.getElementById('workflowCreationModal');
            modal.style.display = 'block';

            // Reset form
            document.getElementById('workflowForm').reset();
            workflowStates = [];
            workflowTags = [];
            document.getElementById('workflowVersion').value = '1.0.0';
            updateWorkflowStatesList();
            updateWorkflowTagsList();
        }

        function closeWorkflowCreationModal() {
            const modal = document.getElementById('workflowCreationModal');
            modal.style.display = 'none';
        }

        function addWorkflowState() {
            const nameInput = document.getElementById('newStateName');
            const typeSelect = document.getElementById('newStateType');

            const stateName = nameInput.value.trim();
            const stateType = typeSelect.value;

            if (!stateName) {
                alert('Please enter a state name');
                return;
            }

            // Check if state already exists
            if (workflowStates.find(s => s.name.toLowerCase() === stateName.toLowerCase())) {
                alert('A state with this name already exists');
                return;
            }

            const state = {
                id: generateUUID(),
                name: stateName,
                type: stateType,
                description: `${stateName} state in the workflow`
            };

            workflowStates.push(state);
            nameInput.value = '';
            typeSelect.value = 'active';

            updateWorkflowStatesList();
        }

        function removeWorkflowState(stateId) {
            workflowStates = workflowStates.filter(s => s.id !== stateId);
            updateWorkflowStatesList();
        }

        function updateWorkflowStatesList() {
            const container = document.getElementById('workflowStatesList');

            if (workflowStates.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text); text-align: center; padding: 20px; background: var(--color-neutral-background); border-radius: 6px;">No states added yet. Add your first workflow state above.</p>';
                return;
            }

            container.innerHTML = workflowStates.map(state => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px;">
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${state.name}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="padding: 2px 8px; background: ${getStateTypeColor(state.type)}; color: white; border-radius: 12px; font-family: var(--font-family-body); font-size: 11px; font-weight: 500; text-transform: uppercase;">${state.type}</span>
                        </div>
                    </div>
                    <button onclick="removeWorkflowState('${state.id}')" style="padding: 6px; background: #fee; color: #d32f2f; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Remove state">
                        <i class="ph ph-trash" style="font-size: 14px;"></i>
                    </button>
                </div>
            `).join('');
        }

        function getStateTypeColor(type) {
            const colors = {
                initial: '#10b981',
                active: '#0066cc',
                waiting: '#f59e0b',
                completed: '#22c55e',
                cancelled: '#6b7280',
                failed: '#ef4444',
                terminal: '#8b5cf6'
            };
            return colors[type] || '#6b7280';
        }

        function handleTagKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addWorkflowTag();
            }
        }

        function addWorkflowTag() {
            const input = document.getElementById('newWorkflowTag');
            const tagName = input.value.trim();

            if (!tagName) return;

            // Check if tag already exists
            if (workflowTags.find(t => t.toLowerCase() === tagName.toLowerCase())) {
                alert('This tag already exists');
                return;
            }

            workflowTags.push(tagName);
            input.value = '';
            updateWorkflowTagsList();
        }

        function removeWorkflowTag(tag) {
            workflowTags = workflowTags.filter(t => t !== tag);
            updateWorkflowTagsList();
        }

        function updateWorkflowTagsList() {
            const container = document.getElementById('workflowTagsList');

            if (workflowTags.length === 0) {
                container.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text-light); font-style: italic;">No tags added yet</p>';
                return;
            }

            container.innerHTML = workflowTags.map(tag => `
                <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #e3f2fd; border-radius: 16px;">
                    <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-primary-blue); font-weight: 500;">${tag}</span>
                    <button onclick="removeWorkflowTag('${tag}')" style="background: none; border: none; color: var(--color-primary-blue); cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center;" title="Remove tag">
                        <i class="ph ph-x" style="font-size: 12px;"></i>
                    </button>
                </div>
            `).join('');
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function createWorkflow(event) {
            event.preventDefault();

            // Collect form data
            const formData = {
                workflowId: generateUUID(),
                workflowName: document.getElementById('workflowName').value.trim(),
                workflowVersion: document.getElementById('workflowVersion').value.trim(),
                category: document.getElementById('workflowCategory').value,
                type: document.getElementById('workflowType').value,
                description: document.getElementById('workflowDescription').value.trim(),
                isActive: true,
                states: workflowStates.map(state => ({
                    stateId: state.id,
                    stateName: state.name,
                    stateType: state.type,
                    description: state.description,
                    isTerminal: state.type === 'terminal' || state.type === 'completed',
                    allowedRoles: [],
                    entryActions: [],
                    exitActions: [],
                    metadata: {}
                })),
                transitions: [], // Would be defined in a more advanced editor
                initialStateId: workflowStates.length > 0 ? workflowStates[0].id : null,
                variables: {
                    required: [],
                    schema: {}
                },
                roles: [],
                sla: {
                    expectedDuration: document.getElementById('expectedDuration').value.trim(),
                    maxDuration: document.getElementById('maxDuration').value.trim(),
                    businessHoursOnly: document.getElementById('businessHoursOnly').value === 'true'
                },
                metadata: {
                    createdBy: {
                        actorId: generateUUID(),
                        actorType: 'user',
                        actorName: 'Current User',
                        actorEmail: 'user@example.com'
                    },
                    createdAt: new Date().toISOString(),
                    updatedBy: null,
                    updatedAt: null,
                    tags: workflowTags
                }
            };

            // Validation
            if (!formData.workflowName) {
                alert('Please enter a workflow name');
                return;
            }

            if (!formData.category) {
                alert('Please select a category');
                return;
            }

            if (!formData.type) {
                alert('Please select a workflow type');
                return;
            }

            if (workflowStates.length === 0) {
                alert('Please add at least one workflow state');
                return;
            }

            // Save workflow definition to localStorage
            const workflowKey = `workflow_def_${formData.workflowName.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
            localStorage.setItem(workflowKey, JSON.stringify(formData));

            // Show success message
            alert(`✅ Success! Workflow "${formData.workflowName}" has been created!\n\nWorkflow Details:\n• Category: ${formData.category.replace('_', ' ')}\n• Type: ${formData.type.replace('_', ' ')}\n• States: ${workflowStates.length}\n• Tags: ${workflowTags.length}\n\nNext steps:\n1. Define state transitions\n2. Configure approval rules\n3. Set up notifications\n4. Test with sample data`);

            console.log('Workflow created:', formData);

            // Close modal
            closeWorkflowCreationModal();

            // Refresh workflow cards if needed
            if (document.getElementById('workflowsContent').style.display !== 'none') {
                loadWorkflowTypeCards();
            }
        }

        function editItem(itemName) {
            // Check if it's a pipeline based on known pipeline names
            const pipelineNames = ['Cleansheet Content Pipeline', 'Document Intelligence Pipeline', 'Customer Analytics Pipeline', 'Image Recognition Pipeline', 'Voice Processing Pipeline'];

            // Check if it's a report (dashboard) based on known report names
            const reportNames = ['Sales Dashboard', 'Financial Reports', 'Project Status', 'Customer Analytics', 'Performance Metrics', 'Marketing Analytics'];

            if (pipelineNames.includes(itemName)) {
                // Open ML Pipeline Management in modal
                openPipelineMgmtModal(itemName);
            } else if (reportNames.includes(itemName)) {
                openDashboardBuilder(itemName);
            } else {
                openTableEditor(itemName);
            }
        }

        function openPipelineMgmtModal(pipelineName) {
            const modal = document.getElementById('pipelineMgmtModal');
            const titleEl = document.getElementById('pipelineTitle');
            const frame = document.getElementById('pipelineMgmtFrame');

            titleEl.textContent = pipelineName || 'Pipeline Management';
            frame.src = 'ml-pipeline-mgmt.html';

            modal.classList.add('active');
        }

        function closePipelineMgmtModal() {
            const modal = document.getElementById('pipelineMgmtModal');
            const frame = document.getElementById('pipelineMgmtFrame');

            modal.classList.remove('active');

            // Clear iframe src after a short delay to allow fade out
            setTimeout(() => {
                frame.src = '';
            }, 300);
        }

        // Close pipeline modal when clicking outside the content area
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('pipelineMgmtModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePipelineMgmtModal();
                    }
                });
            }
        });

        function deleteItem(itemName) {
            if (confirm(`Are you sure you want to delete ${itemName}?`)) {
                alert(`Delete ${itemName} functionality coming soon!`);
            }
        }

        function shareItem(itemName) {
            alert(`Share ${itemName} functionality coming soon!`);
        }

        // Table Editor Functionality
        let currentTableName = '';
        let currentTableData = [];
        let currentTableColumns = [];
        let currentTableColumnTypes = {}; // Store column types { columnName: type }
        let currentTableIcon = 'ph-table';
        let currentTableViews = { 'default': { name: 'Default View', filters: [], sorts: [], groupBy: null } };
        let currentViewName = 'default';
        let filterConditionId = 0;
        let sortConditionId = 0;

        // PostgreSQL-aligned column types
        const POSTGRES_COLUMN_TYPES = [
            { value: 'text', label: 'Text', icon: 'ph-text-aa' },
            { value: 'varchar', label: 'VARCHAR', icon: 'ph-text-aa' },
            { value: 'integer', label: 'Integer', icon: 'ph-hash' },
            { value: 'bigint', label: 'Big Integer', icon: 'ph-hash' },
            { value: 'numeric', label: 'Numeric', icon: 'ph-number-square-one' },
            { value: 'decimal', label: 'Decimal', icon: 'ph-number-square-one' },
            { value: 'real', label: 'Real', icon: 'ph-number-square-one' },
            { value: 'double', label: 'Double Precision', icon: 'ph-number-square-one' },
            { value: 'boolean', label: 'Boolean', icon: 'ph-check-square' },
            { value: 'date', label: 'Date', icon: 'ph-calendar-blank' },
            { value: 'timestamp', label: 'Timestamp', icon: 'ph-clock' },
            { value: 'timestamptz', label: 'Timestamp with TZ', icon: 'ph-clock' },
            { value: 'time', label: 'Time', icon: 'ph-clock' },
            { value: 'interval', label: 'Interval', icon: 'ph-timer' },
            { value: 'json', label: 'JSON', icon: 'ph-brackets-curly' },
            { value: 'jsonb', label: 'JSONB', icon: 'ph-brackets-curly' },
            { value: 'uuid', label: 'UUID', icon: 'ph-fingerprint' },
            { value: 'array', label: 'Array', icon: 'ph-list' },
            { value: 'bytea', label: 'Bytea', icon: 'ph-file-code' }
        ];

        function openTableEditor(tableName) {
            currentTableName = tableName;

            // Find table definition
            const tableTypes = [
                { name: 'Contacts', icon: 'ph-address-book', columns: ['Name', 'Email', 'Phone', 'Company', 'Role', 'Location', 'Notes'] },
                { name: 'Customers', icon: 'ph-users', columns: ['Customer ID', 'Name', 'Email', 'Account Type', 'Status', 'Created Date', 'Lifetime Value'] },
                { name: 'Projects', icon: 'ph-folder', columns: ['Project Name', 'Status', 'Start Date', 'End Date', 'Budget', 'Team', 'Priority'] },
                { name: 'Tasks', icon: 'ph-check-square', columns: ['Task Name', 'Assigned To', 'Due Date', 'Status', 'Priority', 'Tags', 'Progress'] },
                { name: 'Inventory', icon: 'ph-package', columns: ['Item Name', 'SKU', 'Quantity', 'Location', 'Supplier', 'Cost', 'Last Updated'] },
                { name: 'Vendors', icon: 'ph-handshake', columns: ['Vendor Name', 'Contact', 'Services', 'Contract Start', 'Contract End', 'Rating', 'Notes'] },
                { name: 'Events', icon: 'ph-calendar', columns: ['Event Name', 'Date', 'Time', 'Location', 'Attendees', 'Status', 'Budget'] },
                { name: 'Assets', icon: 'ph-briefcase', columns: ['Asset Name', 'Type', 'Owner', 'Location', 'Purchase Date', 'Value', 'Status'] },
                { name: 'Issues', icon: 'ph-warning', columns: ['Issue ID', 'Title', 'Severity', 'Status', 'Assigned To', 'Created Date', 'Resolved Date'] },
                { name: 'Expenses', icon: 'ph-receipt', columns: ['Date', 'Category', 'Amount', 'Vendor', 'Payment Method', 'Status', 'Receipt'] }
            ];

            const tableDefinition = tableTypes.find(t => t.name === tableName);
            if (!tableDefinition) return;

            currentTableColumns = tableDefinition.columns;
            currentTableIcon = tableDefinition.icon;

            // Load or initialize table data and column types from localStorage
            const storageKey = `table_${tableName.toLowerCase().replace(/\s+/g, '_')}`;
            const typesKey = `table_types_${tableName.toLowerCase().replace(/\s+/g, '_')}`;

            const savedData = localStorage.getItem(storageKey);
            const savedTypes = localStorage.getItem(typesKey);

            if (savedData) {
                currentTableData = JSON.parse(savedData);
            } else {
                // Initialize with sample data
                currentTableData = generateSampleData(tableName, currentTableColumns);
                localStorage.setItem(storageKey, JSON.stringify(currentTableData));
            }

            if (savedTypes) {
                currentTableColumnTypes = JSON.parse(savedTypes);
            } else {
                // Initialize column types based on column names
                currentTableColumnTypes = inferColumnTypes(currentTableColumns);
                localStorage.setItem(typesKey, JSON.stringify(currentTableColumnTypes));
            }

            // Update modal UI
            document.getElementById('tableEditorTitle').textContent = tableName;
            document.getElementById('tableIcon').innerHTML = `<i class="ph ${currentTableIcon}" style="font-size: 20px; color: var(--color-primary-blue);"></i>`;
            updateRowCount();

            // Populate group by dropdown
            const groupBySelect = document.getElementById('groupByColumn');
            groupBySelect.innerHTML = '<option value="">No Grouping</option>';
            currentTableColumns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                groupBySelect.appendChild(option);
            });

            // Render table
            renderTableGrid();

            // Show modal
            document.getElementById('tableEditorModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function inferColumnTypes(columns) {
            const types = {};
            columns.forEach(col => {
                const lower = col.toLowerCase();

                if (lower.includes('id') || lower.includes('quantity') || lower.includes('progress')) {
                    types[col] = 'integer';
                } else if (lower.includes('email') || lower.includes('name') || lower.includes('title') || lower.includes('location') || lower.includes('notes') || lower.includes('description')) {
                    types[col] = 'text';
                } else if (lower.includes('date') && !lower.includes('time')) {
                    types[col] = 'date';
                } else if (lower.includes('time') || lower.includes('timestamp')) {
                    types[col] = 'timestamp';
                } else if (lower.includes('amount') || lower.includes('budget') || lower.includes('cost') || lower.includes('value') || lower.includes('price')) {
                    types[col] = 'numeric';
                } else if (lower.includes('rating')) {
                    types[col] = 'decimal';
                } else if (lower.includes('status') || lower.includes('priority') || lower.includes('type') || lower.includes('category')) {
                    types[col] = 'varchar';
                } else if (lower.includes('active') || lower.includes('enabled') || lower.includes('verified')) {
                    types[col] = 'boolean';
                } else if (lower.includes('tags') || lower.includes('items')) {
                    types[col] = 'array';
                } else if (lower.includes('data') || lower.includes('config') || lower.includes('metadata')) {
                    types[col] = 'jsonb';
                } else {
                    types[col] = 'text'; // Default
                }
            });
            return types;
        }

        function closeTableEditor() {
            // Save data and types before closing
            const storageKey = `table_${currentTableName.toLowerCase().replace(/\s+/g, '_')}`;
            const typesKey = `table_types_${currentTableName.toLowerCase().replace(/\s+/g, '_')}`;

            localStorage.setItem(storageKey, JSON.stringify(currentTableData));
            localStorage.setItem(typesKey, JSON.stringify(currentTableColumnTypes));

            document.getElementById('tableEditorModal').style.display = 'none';
            document.body.style.overflow = '';

            // Reset state
            currentTableName = '';
            currentTableData = [];
            currentTableColumns = [];
            currentTableColumnTypes = {};
        }

        // Function to handle column clicks from ERD
        function openColumnEditor(tableName, tableId, columnName) {
            // First open the table editor to get the table context
            openTableEditor(tableName);

            // Wait a moment for the table editor to fully load, then open column type editor
            setTimeout(() => {
                if (document.getElementById('tableEditorModal').style.display !== 'none') {
                    openColumnTypeEditor(columnName);
                }
            }, 100);

            // Show a toast notification to indicate what's happening
            showToast(`Opening ${tableName}.${columnName} editor`, 'info');
        }

        function generateSampleData(tableName, columns) {
            const samples = [];
            const sampleCount = 15;

            for (let i = 0; i < sampleCount; i++) {
                const row = { id: Date.now() + i };
                columns.forEach(col => {
                    row[col] = generateSampleValue(col, i);
                });
                samples.push(row);
            }

            return samples;
        }

        function generateSampleValue(columnName, index) {
            const lower = columnName.toLowerCase();

            if (lower.includes('name')) return `Sample ${index + 1}`;
            if (lower.includes('email')) return `user${index + 1}@example.com`;
            if (lower.includes('phone')) return `(555) ${String(index + 100).padStart(3, '0')}-${String(index * 11).padStart(4, '0')}`;
            if (lower.includes('date')) return new Date(2025, 0, index + 1).toLocaleDateString();
            if (lower.includes('status')) return ['Active', 'Pending', 'Completed', 'On Hold'][index % 4];
            if (lower.includes('priority')) return ['High', 'Medium', 'Low'][index % 3];
            if (lower.includes('amount') || lower.includes('budget') || lower.includes('cost') || lower.includes('value')) return `$${(Math.random() * 10000 + 100).toFixed(2)}`;
            if (lower.includes('quantity') || lower.includes('progress')) return Math.floor(Math.random() * 100);
            if (lower.includes('rating')) return (Math.random() * 5).toFixed(1);

            return `Data ${index + 1}`;
        }

        function renderTableGrid() {
            const grid = document.getElementById('tableDataGrid');

            // Create table HTML with sticky headers
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-family: var(--font-family-body); font-size: 13px;">
                    <thead style="position: sticky; top: 0; background: var(--color-neutral-background); z-index: 10;">
                        <tr style="border-bottom: 2px solid var(--color-neutral-border);">
                            <th style="padding: 12px; text-align: left; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; width: 40px;">
                                <input type="checkbox" onchange="toggleAllRows(this.checked)" style="cursor: pointer;">
                            </th>
            `;

            // Add column headers with type indicators
            currentTableColumns.forEach(col => {
                const colType = currentTableColumnTypes[col] || 'text';
                const typeInfo = POSTGRES_COLUMN_TYPES.find(t => t.value === colType) || POSTGRES_COLUMN_TYPES[0];

                html += `
                    <th style="padding: 12px; text-align: left; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); min-width: 180px;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="text-transform: uppercase;">${escapeHtml(col)}</span>
                                <i class="ph ph-caret-up-down" style="font-size: 12px; color: var(--color-neutral-text-light); cursor: pointer;" onclick="quickSort('${col}')"></i>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px; cursor: pointer;" onclick="openColumnTypeEditor('${col}')">
                                <i class="ph ${typeInfo.icon}" style="font-size: 11px; color: var(--color-primary-blue);"></i>
                                <span style="font-size: 10px; color: var(--color-primary-blue); font-weight: 500; text-transform: none;">${typeInfo.label}</span>
                                <i class="ph ph-caret-down" style="font-size: 10px; color: var(--color-primary-blue);"></i>
                            </div>
                        </div>
                    </th>
                `;
            });

            html += `
                            <th style="padding: 12px; width: 80px; text-align: center; font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Add data rows
            currentTableData.forEach((row, rowIndex) => {
                html += `
                    <tr style="border-bottom: 1px solid var(--color-neutral-border); transition: background 0.2s;" onmouseenter="this.style.background='#f8f9fa'" onmouseleave="this.style.background='white'">
                        <td style="padding: 12px;">
                            <input type="checkbox" style="cursor: pointer;">
                        </td>
                `;

                currentTableColumns.forEach(col => {
                    const value = row[col] || '';
                    html += `
                        <td style="padding: 12px;">
                            <input type="text" value="${escapeHtml(String(value))}" onchange="updateCellValue(${rowIndex}, '${col}', this.value)" style="width: 100%; border: 1px solid transparent; padding: 4px 8px; border-radius: 4px; font-family: var(--font-family-body); font-size: 13px; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--color-primary-blue)'" onblur="this.style.borderColor='transparent'">
                        </td>
                    `;
                });

                html += `
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="deleteRow(${rowIndex})" style="padding: 4px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; color: #dc2626; transition: all 0.2s;" onmouseenter="this.style.borderColor='#dc2626'; this.style.background='#fef2f2'" onmouseleave="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white'">
                                <i class="ph ph-trash" style="font-size: 14px;"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            grid.innerHTML = html;
        }

        function updateRowCount() {
            const count = currentTableData.length;
            document.getElementById('tableRowCount').textContent = `${count} row${count !== 1 ? 's' : ''}`;
        }

        function updateCellValue(rowIndex, columnName, value) {
            currentTableData[rowIndex][columnName] = value;
            // Auto-save
            const storageKey = `table_${currentTableName.toLowerCase().replace(/\s+/g, '_')}`;
            localStorage.setItem(storageKey, JSON.stringify(currentTableData));
        }

        function addNewRow() {
            const newRow = { id: Date.now() };
            currentTableColumns.forEach(col => {
                newRow[col] = '';
            });
            currentTableData.unshift(newRow);
            renderTableGrid();
            updateRowCount();
        }

        function deleteRow(rowIndex) {
            if (confirm('Delete this row?')) {
                currentTableData.splice(rowIndex, 1);
                renderTableGrid();
                updateRowCount();
            }
        }

        function toggleAllRows(checked) {
            const checkboxes = document.querySelectorAll('#tableDataGrid tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
        }

        function quickSort(columnName) {
            currentTableData.sort((a, b) => {
                const aVal = String(a[columnName] || '');
                const bVal = String(b[columnName] || '');
                return aVal.localeCompare(bVal);
            });
            renderTableGrid();
        }

        // Filter Panel Functions
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const btn = document.getElementById('filterBtn');
            const isVisible = panel.style.display !== 'none';

            panel.style.display = isVisible ? 'none' : 'block';
            btn.style.background = isVisible ? 'white' : '#e3f2fd';
        }

        function addFilterCondition() {
            const container = document.getElementById('filterConditions');
            const conditionId = filterConditionId++;

            const div = document.createElement('div');
            div.id = `filter-${conditionId}`;
            div.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 8px;';

            div.innerHTML = `
                <select style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                    ${currentTableColumns.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
                <select style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                    <option value="contains">Contains</option>
                    <option value="equals">Equals</option>
                    <option value="starts">Starts with</option>
                    <option value="ends">Ends with</option>
                </select>
                <input type="text" placeholder="Value..." style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; flex: 1;">
                <button onclick="removeFilterCondition(${conditionId})" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; color: #dc2626;">
                    <i class="ph ph-x"></i>
                </button>
            `;

            container.appendChild(div);
        }

        function removeFilterCondition(conditionId) {
            const element = document.getElementById(`filter-${conditionId}`);
            if (element) element.remove();
        }

        // Sort Panel Functions
        function toggleSortPanel() {
            const panel = document.getElementById('sortPanel');
            const btn = document.getElementById('sortBtn');
            const isVisible = panel.style.display !== 'none';

            panel.style.display = isVisible ? 'none' : 'block';
            btn.style.background = isVisible ? 'white' : '#e3f2fd';
        }

        function addSortCondition() {
            const container = document.getElementById('sortConditions');
            const conditionId = sortConditionId++;

            const div = document.createElement('div');
            div.id = `sort-${conditionId}`;
            div.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 8px;';

            div.innerHTML = `
                <select style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; flex: 1;">
                    ${currentTableColumns.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
                <select style="padding: 6px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
                <button onclick="removeSortCondition(${conditionId})" style="padding: 6px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; color: #dc2626;">
                    <i class="ph ph-x"></i>
                </button>
            `;

            container.appendChild(div);
        }

        function removeSortCondition(conditionId) {
            const element = document.getElementById(`sort-${conditionId}`);
            if (element) element.remove();
        }

        // Group Panel Functions
        function toggleGroupPanel() {
            const panel = document.getElementById('groupPanel');
            const btn = document.getElementById('groupBtn');
            const isVisible = panel.style.display !== 'none';

            panel.style.display = isVisible ? 'none' : 'block';
            btn.style.background = isVisible ? 'white' : '#e3f2fd';
        }

        function applyGrouping() {
            const groupByColumn = document.getElementById('groupByColumn').value;
            if (!groupByColumn) {
                renderTableGrid();
                return;
            }

            // Group rows by selected column
            alert(`Grouping by ${groupByColumn} - Full implementation coming soon!`);
        }

        // View Management
        function switchTableView() {
            const viewName = document.getElementById('viewSelector').value;
            currentViewName = viewName;
            // Load view settings
            alert(`Switching to view: ${viewName} - Full implementation coming soon!`);
        }

        function saveCurrentView() {
            const viewName = prompt('Enter name for this view:');
            if (!viewName) return;

            currentTableViews[viewName] = {
                name: viewName,
                filters: [],
                sorts: [],
                groupBy: null
            };

            // Add to view selector
            const selector = document.getElementById('viewSelector');
            const option = document.createElement('option');
            option.value = viewName;
            option.textContent = viewName;
            selector.appendChild(option);
            selector.value = viewName;

            alert(`View "${viewName}" saved successfully!`);
        }

        // Column Type Editor Functions
        let currentEditingColumn = '';
        let selectedColumnType = '';

        function openColumnTypeEditor(columnName) {
            currentEditingColumn = columnName;
            selectedColumnType = currentTableColumnTypes[columnName] || 'text';

            // Update modal header
            document.getElementById('columnTypeEditorColumnName').textContent = `Column: ${columnName}`;

            // Render type options
            const container = document.getElementById('columnTypeOptions');
            container.innerHTML = '';

            POSTGRES_COLUMN_TYPES.forEach(type => {
                const isSelected = type.value === selectedColumnType;
                const button = document.createElement('button');
                button.style.cssText = `
                    padding: 12px;
                    background: ${isSelected ? '#e3f2fd' : 'white'};
                    border: 2px solid ${isSelected ? 'var(--color-primary-blue)' : 'var(--color-neutral-border)'};
                    border-radius: 6px;
                    font-family: var(--font-family-body);
                    font-size: 12px;
                    color: var(--color-dark);
                    cursor: pointer;
                    text-align: left;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;

                button.innerHTML = `
                    <i class="ph ${type.icon}" style="font-size: 16px; color: ${isSelected ? 'var(--color-primary-blue)' : 'var(--color-neutral-text)'}; flex-shrink: 0;"></i>
                    <span style="font-weight: ${isSelected ? '600' : '400'};">${type.label}</span>
                `;

                button.onclick = () => selectColumnType(type.value);

                button.onmouseenter = () => {
                    if (!isSelected) {
                        button.style.borderColor = 'var(--color-primary-blue)';
                        button.style.background = '#f8f9fa';
                    }
                };

                button.onmouseleave = () => {
                    if (!isSelected) {
                        button.style.borderColor = 'var(--color-neutral-border)';
                        button.style.background = 'white';
                    }
                };

                container.appendChild(button);
            });

            // Show modal
            document.getElementById('columnTypeEditorModal').style.display = 'flex';
        }

        function selectColumnType(typeValue) {
            selectedColumnType = typeValue;
            // Re-render to show selection
            openColumnTypeEditor(currentEditingColumn);
        }

        function applyColumnType() {
            if (selectedColumnType && currentEditingColumn) {
                currentTableColumnTypes[currentEditingColumn] = selectedColumnType;

                // Save to localStorage
                const typesKey = `table_types_${currentTableName.toLowerCase().replace(/\s+/g, '_')}`;
                localStorage.setItem(typesKey, JSON.stringify(currentTableColumnTypes));

                // Re-render table to show new type
                renderTableGrid();

                closeColumnTypeEditor();
            }
        }

        function closeColumnTypeEditor() {
            document.getElementById('columnTypeEditorModal').style.display = 'none';
            currentEditingColumn = '';
            selectedColumnType = '';
        }

        // Form Designer Functions
        let currentFormIndex = null;
        let currentFormFields = [];
        let professionalForms = [];

        // Load forms from localStorage
        function loadProfessionalForms() {
            const saved = localStorage.getItem('professionalForms');
            if (saved) {
                professionalForms = JSON.parse(saved);
            }
        }

        // Update loadFormTypeCards to show user-created forms
        function loadFormTypeCards() {
            loadProfessionalForms();
            const container = document.getElementById('formsContainer');
            container.innerHTML = '';

            if (professionalForms.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-file-dotted" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No forms created yet. Click "+ New Form" to get started.</p>
                    </div>
                `;
                return;
            }

            professionalForms.forEach((form, index) => {
                const card = document.createElement('div');
                card.style.cssText = 'padding: 20px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px;';

                // Determine icon based on form type or use default
                const formIcon = 'ph-clipboard-text';

                // Generate tags from form fields or status
                const tags = [];
                if (form.status === 'open') tags.push('Open');
                if (form.status === 'shared') tags.push('Shared');
                if (form.fields?.length) tags.push(`${form.fields.length} Fields`);

                const description = form.fields?.length
                    ? `Form with ${form.fields.length} field${form.fields.length !== 1 ? 's' : ''}. Last modified ${new Date(form.lastModified).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}.`
                    : 'Empty form. Click to add fields and configure.';

                card.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="ph ${formIcon}" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${form.title || 'Untitled Form'}</div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="event.stopPropagation(); openFormDesigner(${index})" title="Edit" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-pencil-simple" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteForm(${index})" title="Delete" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                            </button>
                            <button onclick="event.stopPropagation(); shareForm(${index})" title="Share" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                                <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                            </button>
                        </div>
                    </div>
                    <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">
                        ${description}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${tags.map(tag => `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${tag}</span>`).join('')}
                    </div>
                    <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">SHARED WITH</div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: var(--color-primary-blue);">AM</div>
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: #f3e5f5; display: flex; align-items: center; justify-content: center; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; color: #7b1fa2;">JS</div>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">+ 3 others</span>
                        </div>
                    </div>
                `;

                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = 'var(--color-primary-blue)';
                    card.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.15)';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = 'var(--color-neutral-border)';
                    card.style.boxShadow = 'none';
                });

                card.addEventListener('click', () => {
                    openFormDesigner(index);
                });

                container.appendChild(card);
            });
        }

        function shareForm(index) {
            alert(`Share form functionality coming soon!`);
        }

        function openFormDesigner(formIndex = null) {
            currentFormIndex = formIndex;

            if (formIndex !== null && professionalForms[formIndex]) {
                // Edit existing form
                const form = professionalForms[formIndex];
                document.getElementById('formTitle').value = form.title || '';
                currentFormFields = JSON.parse(JSON.stringify(form.fields || []));
            } else {
                // New form
                document.getElementById('formTitle').value = '';
                currentFormFields = [];
            }

            renderFormFields();
            document.getElementById('formDesignerModal').style.display = 'flex';
        }

        function closeFormDesigner() {
            document.getElementById('formDesignerModal').style.display = 'none';
            currentFormIndex = null;
            currentFormFields = [];
        }

        function addFormField(type) {
            const field = {
                id: Date.now() + Math.random(),
                type: type,
                label: getDefaultLabel(type),
                placeholder: '',
                required: false,
                linkedTable: '',
                linkedColumn: '',
                options: type === 'dropdown' || type === 'radio' || type === 'checkbox' ? ['Option 1', 'Option 2'] : []
            };

            // Add scale-specific properties
            if (type === 'scale') {
                field.scaleMin = 1;
                field.scaleMax = 10;
                field.scaleMinLabel = 'Not at all';
                field.scaleMaxLabel = 'Extremely';
            }

            // Add likert-specific properties
            if (type === 'likert') {
                field.likertOptions = ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
            }

            currentFormFields.push(field);
            renderFormFields();
        }

        function getDefaultLabel(type) {
            const labels = {
                'text': 'Text Input',
                'textarea': 'Text Area',
                'email': 'Email Address',
                'number': 'Number',
                'phone': 'Phone Number',
                'date': 'Date',
                'time': 'Time',
                'dropdown': 'Select Option',
                'radio': 'Choose One',
                'checkbox': 'Select All That Apply',
                'file': 'Upload File',
                'picture': 'Picture',
                'scale': 'Rating Scale',
                'likert': 'Likert Scale Question',
                'section': 'Section Header'
            };
            return labels[type] || 'Field';
        }

        function renderFormFields() {
            const container = document.getElementById('formFieldsContainer');
            container.innerHTML = '';

            if (currentFormFields.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-cursor-click" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p style="font-size: 16px;">Click a field type on the left to add it to your form</p>
                    </div>
                `;
                return;
            }

            currentFormFields.forEach((field, index) => {
                const fieldEl = document.createElement('div');
                fieldEl.style.cssText = `
                    background: white;
                    border: 1px solid var(--color-neutral-border);
                    border-radius: 8px;
                    padding: 20px;
                    margin-bottom: 16px;
                    position: relative;
                `;

                if (field.type === 'section') {
                    fieldEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <input type="text" value="${field.label}" onchange="updateFieldLabel(${index}, this.value)"
                                style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Questrial', sans-serif; font-size: 18px; font-weight: 600;">
                            <button onclick="removeFormField(${index})" style="margin-left: 12px; padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                        <div style="height: 2px; background: var(--color-primary-blue);"></div>
                    `;
                } else {
                    const linkedTableOptions = getAvailableTablesForLinking();
                    const linkedColumnOptions = field.linkedTable ? getColumnsForTable(field.linkedTable) : [];

                    fieldEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Field Label
                                </label>
                                <input type="text" value="${field.label}" onchange="updateFieldLabel(${index}, this.value)"
                                    style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                            </div>
                            <button onclick="removeFormField(${index})" style="margin-left: 12px; padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>

                        ${field.type !== 'file' && field.type !== 'picture' && field.type !== 'scale' && field.type !== 'likert' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Placeholder
                            </label>
                            <input type="text" value="${field.placeholder}" onchange="updateFieldPlaceholder(${index}, this.value)"
                                style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                        </div>
                        ` : ''}

                        ${field.type === 'picture' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Image URL or Upload
                            </label>
                            <input type="text" value="${field.imageUrl || ''}" onchange="updateFieldImageUrl(${index}, this.value)" placeholder="https://example.com/image.jpg"
                                style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                            <div style="margin-top: 8px; font-size: 12px; color: var(--color-neutral-text-muted);">Enter an image URL to display in the form</div>
                        </div>
                        ` : ''}

                        ${field.type === 'scale' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Scale Range
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--color-neutral-text);">Minimum</label>
                                    <input type="number" value="${field.scaleMin || 1}" onchange="updateScaleMin(${index}, this.value)"
                                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--color-neutral-text);">Maximum</label>
                                    <input type="number" value="${field.scaleMax || 10}" onchange="updateScaleMax(${index}, this.value)"
                                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Scale Labels
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--color-neutral-text);">Min Label</label>
                                    <input type="text" value="${field.scaleMinLabel || ''}" onchange="updateScaleMinLabel(${index}, this.value)" placeholder="e.g., Not at all"
                                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--color-neutral-text);">Max Label</label>
                                    <input type="text" value="${field.scaleMaxLabel || ''}" onchange="updateScaleMaxLabel(${index}, this.value)" placeholder="e.g., Extremely"
                                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        ${field.type === 'likert' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Likert Options (one per line)
                            </label>
                            <textarea onchange="updateLikertOptions(${index}, this.value)"
                                style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px; min-height: 120px;">${(field.likertOptions || []).join('\n')}</textarea>
                            <div style="margin-top: 8px; font-size: 12px; color: var(--color-neutral-text-muted);">Typical: Strongly Disagree, Disagree, Neutral, Agree, Strongly Agree</div>
                        </div>
                        ` : ''}

                        ${field.type === 'dropdown' || field.type === 'radio' || field.type === 'checkbox' ? `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                Options (one per line)
                            </label>
                            <textarea onchange="updateFieldOptions(${index}, this.value)"
                                style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px; min-height: 80px;">${field.options.join('\n')}</textarea>
                        </div>
                        ` : ''}

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Link to Table
                                </label>
                                <select onchange="updateFieldLinkedTable(${index}, this.value)"
                                    style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;">
                                    <option value="">None</option>
                                    ${linkedTableOptions.map(table => `<option value="${table}" ${field.linkedTable === table ? 'selected' : ''}>${table}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-family: 'Questrial', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    Link to Column
                                </label>
                                <select onchange="updateFieldLinkedColumn(${index}, this.value)"
                                    style="width: 100%; padding: 8px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px;" ${!field.linkedTable ? 'disabled' : ''}>
                                    <option value="">None</option>
                                    ${linkedColumnOptions.map(col => `<option value="${col}" ${field.linkedColumn === col ? 'selected' : ''}>${col}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-family: 'Barlow', sans-serif; font-weight: 300; font-size: 14px; color: var(--color-neutral-text);">
                                <input type="checkbox" ${field.required ? 'checked' : ''} onchange="updateFieldRequired(${index}, this.checked)"
                                    style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                                Required field
                            </label>
                            <button onclick="alert('Logic builder coming soon! This will allow you to show/hide fields based on other field values.')" style="padding: 6px 12px; background: white; border: 1px solid var(--color-primary-blue); color: var(--color-primary-blue); border-radius: 6px; font-family: 'Questrial', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <i class="ph ph-git-branch"></i> Logic
                            </button>
                        </div>
                    `;
                }

                container.appendChild(fieldEl);
            });
        }

        function updateFieldLabel(index, value) {
            currentFormFields[index].label = value;
        }

        function updateFieldPlaceholder(index, value) {
            currentFormFields[index].placeholder = value;
        }

        function updateFieldOptions(index, value) {
            currentFormFields[index].options = value.split('\n').filter(o => o.trim());
        }

        function updateFieldRequired(index, value) {
            currentFormFields[index].required = value;
        }

        function updateFieldLinkedTable(index, value) {
            // Handle "Create New Table" option
            if (value === '+ Create New Table') {
                // Open the table wizard to create a new table
                openTableWizard();
                // Reset to no selection for now
                currentFormFields[index].linkedTable = '';
                currentFormFields[index].linkedColumn = '';
                showToast('Opening table wizard. After creating your table, return here to link it.', 'info');
            } else {
                currentFormFields[index].linkedTable = value;
                currentFormFields[index].linkedColumn = ''; // Reset column when table changes
            }
            renderFormFields(); // Re-render to update column dropdown
        }

        function updateFieldLinkedColumn(index, value) {
            currentFormFields[index].linkedColumn = value;
        }

        function updateFieldImageUrl(index, value) {
            if (!currentFormFields[index].imageUrl) {
                currentFormFields[index].imageUrl = '';
            }
            currentFormFields[index].imageUrl = value;
        }

        function updateScaleMin(index, value) {
            currentFormFields[index].scaleMin = parseInt(value) || 1;
        }

        function updateScaleMax(index, value) {
            currentFormFields[index].scaleMax = parseInt(value) || 10;
        }

        function updateScaleMinLabel(index, value) {
            currentFormFields[index].scaleMinLabel = value;
        }

        function updateScaleMaxLabel(index, value) {
            currentFormFields[index].scaleMaxLabel = value;
        }

        function updateLikertOptions(index, value) {
            currentFormFields[index].likertOptions = value.split('\n').filter(o => o.trim());
        }

        function removeFormField(index) {
            if (confirm('Remove this field?')) {
                currentFormFields.splice(index, 1);
                renderFormFields();
            }
        }

        function getAvailableTablesForLinking() {
            const tables = [];

            // Add default table types from the system
            const defaultTables = [
                'Contacts', 'Customers', 'Projects', 'Tasks', 'Inventory',
                'Vendors', 'Events', 'Assets', 'Issues', 'Expenses'
            ];

            defaultTables.forEach(tableName => {
                if (!tables.includes(tableName)) {
                    tables.push(tableName);
                }
            });

            // Get all custom table definitions from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('table_def_')) {
                    const tableName = key.replace('table_def_', '').replace(/_/g, ' ');
                    if (!tables.includes(tableName)) {
                        tables.push(tableName);
                    }
                }
            }

            // Add "Create New Table" option at the end
            tables.push('+ Create New Table');

            return tables.sort((a, b) => {
                // Keep "Create New Table" at the end
                if (a === '+ Create New Table') return 1;
                if (b === '+ Create New Table') return -1;
                return a.localeCompare(b);
            });
        }

        function getColumnsForTable(tableName) {
            // First check for default table columns
            const defaultTableColumns = {
                'Contacts': ['ID', 'Name', 'Email', 'Phone', 'Company', 'Role', 'Location', 'Notes'],
                'Customers': ['Customer_ID', 'Name', 'Email', 'Account_Type', 'Status', 'Contact_ID', 'Created_Date', 'Lifetime_Value'],
                'Projects': ['Project_ID', 'Project_Name', 'Status', 'Start_Date', 'End_Date', 'Customer_ID', 'Budget', 'Team', 'Priority'],
                'Tasks': ['Task_ID', 'Task_Name', 'Assigned_To_ID', 'Due_Date', 'Status', 'Project_ID', 'Priority', 'Tags', 'Progress'],
                'Inventory': ['Item_ID', 'Item_Name', 'SKU', 'Quantity', 'Location', 'Supplier_ID', 'Cost', 'Last_Updated'],
                'Vendors': ['Vendor_ID', 'Vendor_Name', 'Contact', 'Services', 'Contract_Start', 'Contract_End', 'Rating', 'Notes'],
                'Events': ['Event_ID', 'Event_Name', 'Date', 'Time', 'Location', 'Project_ID', 'Attendees', 'Status', 'Budget'],
                'Assets': ['Asset_ID', 'Asset_Name', 'Type', 'Owner_ID', 'Location', 'Vendor_ID', 'Purchase_Date', 'Value', 'Status'],
                'Issues': ['Issue_ID', 'Title', 'Severity', 'Status', 'Assigned_To_ID', 'Project_ID', 'Created_Date', 'Resolved_Date'],
                'Expenses': ['Expense_ID', 'Date', 'Category', 'Amount', 'Vendor_ID', 'Project_ID', 'Submitted_By_ID', 'Payment_Method', 'Status', 'Receipt']
            };

            // Check if it's a default table
            if (defaultTableColumns[tableName]) {
                return defaultTableColumns[tableName];
            }

            // Check for custom table definition in localStorage
            const key = `table_def_${tableName.toLowerCase().replace(/\s+/g, '_')}`;
            const saved = localStorage.getItem(key);
            if (saved) {
                const def = JSON.parse(saved);
                return def.columns || [];
            }

            return [];
        }

        function togglePublishMenu() {
            const menu = document.getElementById('publishMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('publishMenu');
            const publishBtn = event.target.closest('[onclick="togglePublishMenu()"]');
            if (menu && menu.style.display === 'block' && !publishBtn && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        function publishFormAs(type) {
            const title = document.getElementById('formTitle').value.trim();
            if (!title) {
                alert('Please enter a form title before publishing.');
                return;
            }

            if (currentFormFields.length === 0) {
                alert('Please add at least one field before publishing.');
                return;
            }

            const form = {
                title: title,
                fields: currentFormFields,
                status: type,
                lastModified: new Date().toISOString(),
                createdDate: currentFormIndex !== null ? professionalForms[currentFormIndex].createdDate : new Date().toISOString()
            };

            if (currentFormIndex !== null) {
                professionalForms[currentFormIndex] = form;
            } else {
                professionalForms.push(form);
            }

            localStorage.setItem('professionalForms', JSON.stringify(professionalForms));

            let message = '';
            if (type === 'open') {
                message = 'Form published as Open Form. Anyone with the link can submit responses.';
            } else if (type === 'specific') {
                message = 'Form published to specific users. Only invited users can submit responses.';
            }

            alert(message);
            togglePublishMenu();
            closeFormDesigner();
            loadFormTypeCards();
        }

        function shareFormWithEditors() {
            const title = document.getElementById('formTitle').value.trim();
            if (!title) {
                alert('Please enter a form title before sharing.');
                return;
            }

            if (currentFormFields.length === 0) {
                alert('Please add at least one field before sharing.');
                return;
            }

            const form = {
                title: title,
                fields: currentFormFields,
                status: 'shared',
                lastModified: new Date().toISOString(),
                createdDate: currentFormIndex !== null ? professionalForms[currentFormIndex].createdDate : new Date().toISOString()
            };

            if (currentFormIndex !== null) {
                professionalForms[currentFormIndex] = form;
            } else {
                professionalForms.push(form);
            }

            localStorage.setItem('professionalForms', JSON.stringify(professionalForms));

            alert('Form shared with editors. Collaborators can now edit this form.');
            togglePublishMenu();
            closeFormDesigner();
            loadFormTypeCards();
        }

        function saveFormDesign() {
            const title = document.getElementById('formTitle').value.trim();
            if (!title) {
                alert('Please enter a form title.');
                return;
            }

            const form = {
                title: title,
                fields: currentFormFields,
                status: currentFormIndex !== null && professionalForms[currentFormIndex].status ? professionalForms[currentFormIndex].status : 'draft',
                lastModified: new Date().toISOString(),
                createdDate: currentFormIndex !== null ? professionalForms[currentFormIndex].createdDate : new Date().toISOString()
            };

            if (currentFormIndex !== null) {
                professionalForms[currentFormIndex] = form;
            } else {
                professionalForms.push(form);
            }

            localStorage.setItem('professionalForms', JSON.stringify(professionalForms));

            alert('Form saved successfully!');
            closeFormDesigner();
            loadFormTypeCards();
        }

        function deleteForm(index) {
            if (confirm('Are you sure you want to delete this form? This cannot be undone.')) {
                professionalForms.splice(index, 1);
                localStorage.setItem('professionalForms', JSON.stringify(professionalForms));
                loadFormTypeCards();
            }
        }

        // Form Preview Functions
        function openFormPreview() {
            const title = document.getElementById('formTitle').value.trim() || 'Untitled Form';
            const container = document.getElementById('formPreviewContent');

            if (currentFormFields.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-file-dotted" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No fields added to preview. Add fields to see the form preview.</p>
                    </div>
                `;
            } else {
                let html = `<h2 style="font-family: var(--font-family-ui); font-size: 24px; font-weight: 600; color: var(--color-dark); margin: 0 0 24px 0;">${title}</h2>`;

                currentFormFields.forEach(field => {
                    if (field.type === 'section') {
                        html += `
                            <div style="margin: 32px 0 16px 0;">
                                <h3 style="font-family: var(--font-family-ui); font-size: 18px; font-weight: 600; color: var(--color-dark); margin: 0 0 8px 0;">${field.label}</h3>
                                <div style="height: 2px; background: var(--color-primary-blue);"></div>
                            </div>
                        `;
                    } else if (field.type === 'picture') {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">
                                    ${field.label}${field.required ? ' <span style="color: #ef4444;">*</span>' : ''}
                                </label>
                                ${field.imageUrl ? `<img src="${field.imageUrl}" alt="${field.label}" style="max-width: 100%; border-radius: 8px; border: 1px solid var(--color-neutral-border);">` : `<div style="padding: 40px; background: var(--color-neutral-background); border: 1px solid var(--color-neutral-border); border-radius: 8px; text-align: center; color: var(--color-neutral-text-muted);">No image URL provided</div>`}
                            </div>
                        `;
                    } else {
                        html += `<div style="margin-bottom: 20px;">`;
                        html += `<label style="display: block; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-dark);">${field.label}${field.required ? ' <span style="color: #ef4444;">*</span>' : ''}</label>`;

                        if (field.type === 'textarea') {
                            html += `<textarea placeholder="${field.placeholder}" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px; min-height: 100px;" disabled></textarea>`;
                        } else if (field.type === 'dropdown') {
                            html += `<select style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;" disabled>`;
                            html += `<option>${field.placeholder || 'Select an option...'}</option>`;
                            field.options.forEach(opt => {
                                html += `<option>${opt}</option>`;
                            });
                            html += `</select>`;
                        } else if (field.type === 'radio') {
                            field.options.forEach((opt, i) => {
                                html += `<div style="display: flex; align-items: center; margin-bottom: 8px;"><input type="radio" name="preview_${field.id}" id="preview_${field.id}_${i}" style="margin-right: 8px;" disabled><label for="preview_${field.id}_${i}" style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text);">${opt}</label></div>`;
                            });
                        } else if (field.type === 'checkbox') {
                            field.options.forEach((opt, i) => {
                                html += `<div style="display: flex; align-items: center; margin-bottom: 8px;"><input type="checkbox" id="preview_${field.id}_${i}" style="margin-right: 8px;" disabled><label for="preview_${field.id}_${i}" style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text);">${opt}</label></div>`;
                            });
                        } else if (field.type === 'file') {
                            html += `<input type="file" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;" disabled>`;
                        } else if (field.type === 'scale') {
                            const min = field.scaleMin || 1;
                            const max = field.scaleMax || 10;
                            html += `<div style="display: flex; align-items: center; gap: 12px; margin: 20px 0;">`;
                            html += `<span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); min-width: 100px;">${field.scaleMinLabel || min}</span>`;
                            html += `<div style="flex: 1; display: flex; gap: 8px; justify-content: space-between;">`;
                            for (let i = min; i <= max; i++) {
                                html += `<label style="display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="radio" name="preview_scale_${field.id}" value="${i}" style="cursor: pointer;" disabled>
                                    <span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">${i}</span>
                                </label>`;
                            }
                            html += `</div>`;
                            html += `<span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text); min-width: 100px; text-align: right;">${field.scaleMaxLabel || max}</span>`;
                            html += `</div>`;
                        } else if (field.type === 'likert') {
                            const options = field.likertOptions || ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
                            options.forEach((opt, i) => {
                                html += `<div style="display: flex; align-items: center; margin-bottom: 8px;"><input type="radio" name="preview_likert_${field.id}" id="preview_likert_${field.id}_${i}" style="margin-right: 8px;" disabled><label for="preview_likert_${field.id}_${i}" style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text);">${opt}</label></div>`;
                            });
                        } else {
                            const inputType = field.type === 'email' ? 'email' : field.type === 'number' ? 'number' : field.type === 'phone' ? 'tel' : field.type === 'date' ? 'date' : field.type === 'time' ? 'time' : 'text';
                            html += `<input type="${inputType}" placeholder="${field.placeholder}" style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 14px;" disabled>`;
                        }
                        html += `</div>`;
                    }
                });

                html += `<div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--color-neutral-border);"><button style="padding: 12px 24px; background: var(--color-primary-blue); color: white; border: none; border-radius: 6px; font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; cursor: not-allowed; opacity: 0.6;">Submit (Preview Only)</button></div>`;

                container.innerHTML = html;
            }

            document.getElementById('formPreviewModal').style.display = 'flex';
        }

        function closeFormPreview() {
            document.getElementById('formPreviewModal').style.display = 'none';
        }

        // Dashboard Builder Functions
        let currentDashboardName = '';
        let dashboardVisualizations = [];

        function openDashboardBuilder(dashboardName) {
            currentDashboardName = dashboardName;
            document.getElementById('dashboardTitle').value = dashboardName;

            // Load existing visualizations if any
            const saved = localStorage.getItem(`dashboard_${dashboardName.toLowerCase().replace(/\s+/g, '_')}`);
            if (saved) {
                dashboardVisualizations = JSON.parse(saved);
            } else {
                dashboardVisualizations = [];
            }

            renderDashboardCanvas();
            document.getElementById('dashboardBuilderModal').style.display = 'flex';
        }

        function closeDashboardBuilder() {
            document.getElementById('dashboardBuilderModal').style.display = 'none';
            currentDashboardName = '';
            dashboardVisualizations = [];
        }

        function addVisualization(type) {
            const viz = {
                id: Date.now() + Math.random(),
                type: type,
                title: getVisualizationTitle(type),
                dataSource: 'Sample Data',
                width: type === 'kpi-card' ? 33 : 50, // % of container width
                tables: [], // Array of selected tables
                columns: [] // Array of selected columns
            };

            dashboardVisualizations.push(viz);
            renderDashboardCanvas();
        }

        function getVisualizationTitle(type) {
            const titles = {
                'bar-chart': 'Bar Chart',
                'line-chart': 'Line Chart',
                'pie-chart': 'Pie Chart',
                'area-chart': 'Area Chart',
                'scatter-plot': 'Scatter Plot',
                'gauge': 'Performance Gauge',
                'kpi-card': 'KPI Metric',
                'table': 'Data Table',
                'heatmap': 'Heatmap',
                'funnel': 'Conversion Funnel'
            };
            return titles[type] || 'Visualization';
        }

        function renderDashboardCanvas() {
            const canvas = document.getElementById('dashboardCanvas');

            if (dashboardVisualizations.length === 0) {
                canvas.innerHTML = `
                    <div style="text-align: center; padding: 80px 20px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-chart-line" style="font-size: 64px; margin-bottom: 16px;"></i>
                        <p style="font-size: 16px;">Click a visualization type to add it to your dashboard</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: flex; flex-wrap: wrap; gap: 20px;">';

            dashboardVisualizations.forEach((viz, index) => {
                const widthStyle = `width: calc(${viz.width}% - 10px);`;

                html += `
                    <div style="${widthStyle} background: white; border: 1px solid var(--color-neutral-border); border-radius: 12px; padding: 20px; min-height: 300px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0;">${viz.title}</h3>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="configureVisualization(${index})" style="padding: 6px 12px; background: white; border: 1px solid var(--color-primary-blue); color: var(--color-primary-blue); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600;">
                                    <i class="ph ph-gear" style="font-size: 14px;"></i> Configure
                                </button>
                                <button onclick="removeVisualization(${index})" style="padding: 6px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer;">
                                    <i class="ph ph-trash" style="font-size: 14px; color: #dc2626;"></i>
                                </button>
                            </div>
                        </div>
                        ${viz.tables.length > 0 ? `
                            <div style="margin-bottom: 12px; padding: 8px 12px; background: #e3f2fd; border-radius: 6px; font-family: var(--font-family-body); font-size: 12px; color: var(--color-primary-blue);">
                                <i class="ph ph-database"></i> Tables: ${viz.tables.join(', ')}
                            </div>
                        ` : ''}
                        <div style="display: flex; align-items: center; justify-content: center; height: 240px; background: var(--color-neutral-background); border-radius: 8px;">
                            ${renderVisualizationPlaceholder(viz.type, viz.tables.length > 0)}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            canvas.innerHTML = html;
        }

        function renderVisualizationPlaceholder(type, hasData) {
            const icons = {
                'bar-chart': 'ph-chart-bar',
                'line-chart': 'ph-chart-line',
                'pie-chart': 'ph-chart-pie-slice',
                'area-chart': 'ph-chart-line-up',
                'scatter-plot': 'ph-scatter-chart',
                'gauge': 'ph-gauge',
                'kpi-card': 'ph-number-square-one',
                'table': 'ph-table',
                'heatmap': 'ph-grid-four',
                'funnel': 'ph-funnel'
            };

            const icon = icons[type] || 'ph-chart-line';

            if (type === 'kpi-card' && hasData) {
                return `
                    <div style="text-align: center;">
                        <div style="font-family: var(--font-family-ui); font-size: 48px; font-weight: 700; color: var(--color-primary-blue); margin-bottom: 8px;">
                            $24.5K
                        </div>
                        <div style="font-family: var(--font-family-body); font-size: 14px; color: var(--color-neutral-text);">
                            <i class="ph ph-trend-up" style="color: #10b981;"></i> +12.5% from last month
                        </div>
                    </div>
                `;
            }

            if (hasData) {
                return `
                    <div style="text-align: center; color: var(--color-neutral-text);">
                        <i class="ph ${icon}" style="font-size: 48px; color: var(--color-primary-blue); margin-bottom: 12px;"></i>
                        <p style="font-size: 13px; font-weight: 600;">Ready to display data</p>
                        <p style="font-size: 11px; color: var(--color-neutral-text-muted);">Visualization configured</p>
                    </div>
                `;
            }

            return `
                <div style="text-align: center; color: var(--color-neutral-text-muted);">
                    <i class="ph ${icon}" style="font-size: 48px; margin-bottom: 12px;"></i>
                    <p style="font-size: 13px;">Data visualization placeholder</p>
                    <p style="font-size: 11px;">Click Configure to select tables</p>
                </div>
            `;
        }

        function removeVisualization(index) {
            dashboardVisualizations.splice(index, 1);
            renderDashboardCanvas();
        }

        function saveDashboard() {
            const title = document.getElementById('dashboardTitle').value.trim();
            if (!title) {
                alert('Please enter a dashboard title.');
                return;
            }

            const key = `dashboard_${title.toLowerCase().replace(/\s+/g, '_')}`;
            localStorage.setItem(key, JSON.stringify(dashboardVisualizations));

            alert('Dashboard saved successfully!');
        }

        // Visualization Configuration Functions
        let currentConfigIndex = null;

        function configureVisualization(index) {
            currentConfigIndex = index;
            const viz = dashboardVisualizations[index];

            // Set title
            document.getElementById('vizConfigTitle').value = viz.title;

            // Load available tables and render checkboxes
            renderTableSelection(viz.tables);

            // Show modal
            document.getElementById('vizConfigModal').style.display = 'flex';
        }

        function renderTableSelection(selectedTables) {
            const container = document.getElementById('tableSelectionList');
            const availableTables = getAvailableTablesFromLocalStorage();

            if (availableTables.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--color-neutral-text-muted);">
                        <i class="ph ph-database" style="font-size: 32px; margin-bottom: 8px;"></i>
                        <p style="font-size: 13px;">No tables found</p>
                        <p style="font-size: 11px;">Create tables first to use in visualizations</p>
                    </div>
                `;
                return;
            }

            let html = '';
            availableTables.forEach((table, index) => {
                const isChecked = selectedTables.includes(table);
                html += `
                    <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                        <input type="checkbox" value="${table}" ${isChecked ? 'checked' : ''} onchange="updateTableSelection()" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-family-ui); font-size: 14px; color: var(--color-dark);">
                                <i class="ph ph-database" style="color: var(--color-primary-blue); margin-right: 4px;"></i>
                                ${table}
                            </div>
                        </div>
                    </label>
                `;
            });

            container.innerHTML = html;
        }

        function getAvailableTablesFromLocalStorage() {
            const tables = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('table_def_')) {
                    const tableName = key.replace('table_def_', '').replace(/_/g, ' ');
                    // Capitalize first letter of each word
                    const formattedName = tableName.split(' ').map(word =>
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    tables.push(formattedName);
                }
            }
            return tables.sort();
        }

        function updateTableSelection() {
            // This is called when checkboxes change - no action needed, just for UI feedback
        }

        function saveVizConfig() {
            if (currentConfigIndex === null) return;

            const viz = dashboardVisualizations[currentConfigIndex];

            // Update title
            viz.title = document.getElementById('vizConfigTitle').value.trim() || viz.title;

            // Get selected tables
            const checkboxes = document.querySelectorAll('#tableSelectionList input[type="checkbox"]');
            viz.tables = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    viz.tables.push(checkbox.value);
                }
            });

            closeVizConfig();
            renderDashboardCanvas();
        }

        function closeVizConfig() {
            document.getElementById('vizConfigModal').style.display = 'none';
            currentConfigIndex = null;
        }

        // Initialize demo forms if none exist
        function initializeDemoForms() {
            const existing = localStorage.getItem('professionalForms');
            if (existing) return; // Don't overwrite existing forms

            const demoForms = [
                {
                    title: 'Customer Feedback Survey',
                    status: 'open',
                    lastModified: new Date('2025-10-05').toISOString(),
                    createdDate: new Date('2025-09-20').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'About You', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Full Name', placeholder: 'Enter your full name', required: true, linkedTable: 'Customer Contacts', linkedColumn: 'Name', options: [] },
                        { id: 3, type: 'email', label: 'Email Address', placeholder: 'your.email@company.com', required: true, linkedTable: 'Customer Contacts', linkedColumn: 'Email', options: [] },
                        { id: 4, type: 'text', label: 'Company Name', placeholder: 'Your company', required: true, linkedTable: 'Customer Contacts', linkedColumn: 'Company', options: [] },
                        { id: 5, type: 'section', label: 'Your Experience', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 6, type: 'radio', label: 'How satisfied are you with our product?', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Very Satisfied', 'Satisfied', 'Neutral', 'Dissatisfied', 'Very Dissatisfied'] },
                        { id: 7, type: 'checkbox', label: 'Which features do you use most?', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: ['Dashboard', 'Reports', 'API Integration', 'Mobile App', 'Analytics', 'Collaboration Tools'] },
                        { id: 8, type: 'textarea', label: 'What improvements would you like to see?', placeholder: 'Share your suggestions...', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 9, type: 'dropdown', label: 'How likely are you to recommend us?', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['10 - Extremely Likely', '9', '8', '7', '6', '5', '4', '3', '2', '1', '0 - Not at all likely'] }
                    ]
                },
                {
                    title: 'Job Application Form',
                    status: 'open',
                    lastModified: new Date('2025-10-03').toISOString(),
                    createdDate: new Date('2025-09-15').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Personal Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'First Name', placeholder: 'First name', required: true, linkedTable: 'Job Candidates', linkedColumn: 'First Name', options: [] },
                        { id: 3, type: 'text', label: 'Last Name', placeholder: 'Last name', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Last Name', options: [] },
                        { id: 4, type: 'email', label: 'Email', placeholder: 'your.email@example.com', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Email', options: [] },
                        { id: 5, type: 'phone', label: 'Phone Number', placeholder: '(555) 123-4567', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Phone', options: [] },
                        { id: 6, type: 'section', label: 'Position Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 7, type: 'dropdown', label: 'Position Applying For', placeholder: '', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Position', options: ['Senior Software Engineer', 'Product Manager', 'UX Designer', 'DevOps Engineer', 'Data Scientist', 'Marketing Manager'] },
                        { id: 8, type: 'dropdown', label: 'Years of Experience', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['0-2 years', '3-5 years', '6-10 years', '10+ years'] },
                        { id: 9, type: 'date', label: 'Available Start Date', placeholder: '', required: true, linkedTable: 'Job Candidates', linkedColumn: 'Start Date', options: [] },
                        { id: 10, type: 'section', label: 'Additional Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 11, type: 'textarea', label: 'Why do you want to work with us?', placeholder: 'Tell us about your interest in this position...', required: true, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 12, type: 'file', label: 'Upload Resume (PDF)', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 13, type: 'checkbox', label: 'I confirm that all information provided is accurate', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Yes, I confirm'] }
                    ]
                },
                {
                    title: 'Event Registration',
                    status: 'specific',
                    lastModified: new Date('2025-10-04').toISOString(),
                    createdDate: new Date('2025-09-25').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Attendee Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Full Name', placeholder: 'Your full name', required: true, linkedTable: 'Event Attendees', linkedColumn: 'Name', options: [] },
                        { id: 3, type: 'email', label: 'Email Address', placeholder: 'email@example.com', required: true, linkedTable: 'Event Attendees', linkedColumn: 'Email', options: [] },
                        { id: 4, type: 'text', label: 'Organization', placeholder: 'Company or organization', required: false, linkedTable: 'Event Attendees', linkedColumn: 'Organization', options: [] },
                        { id: 5, type: 'text', label: 'Job Title', placeholder: 'Your role', required: false, linkedTable: 'Event Attendees', linkedColumn: 'Title', options: [] },
                        { id: 6, type: 'section', label: 'Event Preferences', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 7, type: 'radio', label: 'Attendance Type', placeholder: '', required: true, linkedTable: 'Event Attendees', linkedColumn: 'Attendance Type', options: ['In-Person', 'Virtual'] },
                        { id: 8, type: 'checkbox', label: 'Which sessions are you interested in?', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: ['Keynote Address', 'Technical Workshop', 'Panel Discussion', 'Networking Session', 'Product Demo'] },
                        { id: 9, type: 'dropdown', label: 'Dietary Restrictions (In-Person Only)', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: ['None', 'Vegetarian', 'Vegan', 'Gluten-Free', 'Dairy-Free', 'Other'] },
                        { id: 10, type: 'textarea', label: 'Special Accommodations', placeholder: 'Please let us know if you need any special accommodations', required: false, linkedTable: '', linkedColumn: '', options: [] }
                    ]
                },
                {
                    title: 'Product Support Ticket',
                    status: 'open',
                    lastModified: new Date('2025-10-06').toISOString(),
                    createdDate: new Date('2025-10-01').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Contact Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Your Name', placeholder: 'Full name', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Customer Name', options: [] },
                        { id: 3, type: 'email', label: 'Email', placeholder: 'support@yourcompany.com', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Email', options: [] },
                        { id: 4, type: 'text', label: 'Account ID or Customer Number', placeholder: 'CUST-12345', required: false, linkedTable: 'Support Tickets', linkedColumn: 'Account ID', options: [] },
                        { id: 5, type: 'section', label: 'Issue Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 6, type: 'dropdown', label: 'Priority Level', placeholder: '', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Priority', options: ['Low - General Question', 'Medium - Minor Issue', 'High - Significant Impact', 'Critical - Service Down'] },
                        { id: 7, type: 'dropdown', label: 'Category', placeholder: '', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Category', options: ['Technical Issue', 'Billing Question', 'Feature Request', 'Account Access', 'Other'] },
                        { id: 8, type: 'text', label: 'Subject', placeholder: 'Brief description of the issue', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Subject', options: [] },
                        { id: 9, type: 'textarea', label: 'Detailed Description', placeholder: 'Please describe the issue in detail, including steps to reproduce...', required: true, linkedTable: 'Support Tickets', linkedColumn: 'Description', options: [] },
                        { id: 10, type: 'file', label: 'Attach Screenshot or Log File', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] }
                    ]
                },
                {
                    title: 'Employee Onboarding Form',
                    status: 'shared',
                    lastModified: new Date('2025-10-02').toISOString(),
                    createdDate: new Date('2025-09-10').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Personal Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Legal First Name', placeholder: 'First name', required: true, linkedTable: 'Employees', linkedColumn: 'First Name', options: [] },
                        { id: 3, type: 'text', label: 'Legal Last Name', placeholder: 'Last name', required: true, linkedTable: 'Employees', linkedColumn: 'Last Name', options: [] },
                        { id: 4, type: 'email', label: 'Personal Email', placeholder: 'personal.email@example.com', required: true, linkedTable: 'Employees', linkedColumn: 'Personal Email', options: [] },
                        { id: 5, type: 'phone', label: 'Mobile Phone', placeholder: '(555) 123-4567', required: true, linkedTable: 'Employees', linkedColumn: 'Phone', options: [] },
                        { id: 6, type: 'date', label: 'Date of Birth', placeholder: '', required: true, linkedTable: 'Employees', linkedColumn: 'DOB', options: [] },
                        { id: 7, type: 'section', label: 'Employment Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 8, type: 'text', label: 'Job Title', placeholder: 'Your position', required: true, linkedTable: 'Employees', linkedColumn: 'Job Title', options: [] },
                        { id: 9, type: 'dropdown', label: 'Department', placeholder: '', required: true, linkedTable: 'Employees', linkedColumn: 'Department', options: ['Engineering', 'Product', 'Sales', 'Marketing', 'Customer Success', 'Operations', 'HR', 'Finance'] },
                        { id: 10, type: 'date', label: 'Start Date', placeholder: '', required: true, linkedTable: 'Employees', linkedColumn: 'Start Date', options: [] },
                        { id: 11, type: 'dropdown', label: 'Employment Type', placeholder: '', required: true, linkedTable: 'Employees', linkedColumn: 'Employment Type', options: ['Full-Time', 'Part-Time', 'Contract', 'Intern'] },
                        { id: 12, type: 'section', label: 'Equipment & Access', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 13, type: 'checkbox', label: 'Required Equipment', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Laptop', 'Monitor', 'Keyboard & Mouse', 'Headset', 'Mobile Phone'] },
                        { id: 14, type: 'textarea', label: 'Additional Notes or Requirements', placeholder: 'Any special requests or accommodations', required: false, linkedTable: '', linkedColumn: '', options: [] }
                    ]
                },
                {
                    title: 'Vendor Information Form',
                    status: 'draft',
                    lastModified: new Date('2025-09-28').toISOString(),
                    createdDate: new Date('2025-09-28').toISOString(),
                    fields: [
                        { id: 1, type: 'section', label: 'Company Information', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 2, type: 'text', label: 'Company Legal Name', placeholder: 'Full legal business name', required: true, linkedTable: 'Vendors', linkedColumn: 'Company Name', options: [] },
                        { id: 3, type: 'text', label: 'Tax ID / EIN', placeholder: 'XX-XXXXXXX', required: true, linkedTable: 'Vendors', linkedColumn: 'Tax ID', options: [] },
                        { id: 4, type: 'email', label: 'Primary Contact Email', placeholder: 'contact@vendor.com', required: true, linkedTable: 'Vendors', linkedColumn: 'Email', options: [] },
                        { id: 5, type: 'phone', label: 'Business Phone', placeholder: '(555) 123-4567', required: true, linkedTable: 'Vendors', linkedColumn: 'Phone', options: [] },
                        { id: 6, type: 'text', label: 'Website', placeholder: 'https://www.vendor.com', required: false, linkedTable: 'Vendors', linkedColumn: 'Website', options: [] },
                        { id: 7, type: 'section', label: 'Service Details', placeholder: '', required: false, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 8, type: 'checkbox', label: 'Services Provided', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Software Development', 'Consulting', 'Cloud Services', 'Marketing', 'Legal Services', 'Accounting', 'HR Services'] },
                        { id: 9, type: 'textarea', label: 'Service Description', placeholder: 'Describe the services you provide', required: true, linkedTable: '', linkedColumn: '', options: [] },
                        { id: 10, type: 'dropdown', label: 'Insurance Coverage', placeholder: '', required: true, linkedTable: '', linkedColumn: '', options: ['Yes - General Liability', 'Yes - Professional Liability', 'Yes - Both', 'No Insurance'] }
                    ]
                }
            ];

            localStorage.setItem('professionalForms', JSON.stringify(demoForms));
        }

        // Initialize demo table relationships if none exist
        function initializeDemoTableRelationships() {
            // Check if relationships already exist - for now, let's always reinitialize to fix the table names
            const existingRelationships = localStorage.getItem('tableRelationships');

            // Temporarily always reinitialize to fix case mismatch issues
            // TODO: Remove this override after first successful load
            // if (existingRelationships && JSON.parse(existingRelationships).length > 0) return;

            // Define logical relationships between the 10 existing tables
            const demoRelationships = [
                {
                    sourceTable: 'customers',
                    targetTable: 'contacts',
                    sourceColumn: 'Contact_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Customer has primary contact'
                },
                {
                    sourceTable: 'projects',
                    targetTable: 'customers',
                    sourceColumn: 'Customer_ID',
                    targetColumn: 'Customer_ID',
                    type: 'many-to-one',
                    label: 'Projects belong to customers'
                },
                {
                    sourceTable: 'tasks',
                    targetTable: 'projects',
                    sourceColumn: 'Project_ID',
                    targetColumn: 'Project_ID',
                    type: 'many-to-one',
                    label: 'Tasks are part of projects'
                },
                {
                    sourceTable: 'tasks',
                    targetTable: 'contacts',
                    sourceColumn: 'Assigned_To_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Tasks assigned to team members'
                },
                {
                    sourceTable: 'inventory',
                    targetTable: 'vendors',
                    sourceColumn: 'Supplier_ID',
                    targetColumn: 'Vendor_ID',
                    type: 'many-to-one',
                    label: 'Inventory items sourced from vendors'
                },
                {
                    sourceTable: 'events',
                    targetTable: 'projects',
                    sourceColumn: 'Project_ID',
                    targetColumn: 'Project_ID',
                    type: 'many-to-one',
                    label: 'Project milestones and meetings'
                },
                {
                    sourceTable: 'assets',
                    targetTable: 'contacts',
                    sourceColumn: 'Owner_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Assets assigned to team members'
                },
                {
                    sourceTable: 'issues',
                    targetTable: 'projects',
                    sourceColumn: 'Project_ID',
                    targetColumn: 'Project_ID',
                    type: 'many-to-one',
                    label: 'Issues tracked by project'
                },
                {
                    sourceTable: 'issues',
                    targetTable: 'contacts',
                    sourceColumn: 'Assigned_To_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Issues assigned to team members'
                },
                {
                    sourceTable: 'expenses',
                    targetTable: 'projects',
                    sourceColumn: 'Project_ID',
                    targetColumn: 'Project_ID',
                    type: 'many-to-one',
                    label: 'Project-related expenses'
                },
                {
                    sourceTable: 'expenses',
                    targetTable: 'contacts',
                    sourceColumn: 'Submitted_By_ID',
                    targetColumn: 'ID',
                    type: 'many-to-one',
                    label: 'Expenses submitted by team members'
                },
                {
                    sourceTable: 'expenses',
                    targetTable: 'vendors',
                    sourceColumn: 'Vendor_ID',
                    targetColumn: 'Vendor_ID',
                    type: 'many-to-one',
                    label: 'Expenses paid to vendors'
                },
                {
                    sourceTable: 'assets',
                    targetTable: 'vendors',
                    sourceColumn: 'Vendor_ID',
                    targetColumn: 'Vendor_ID',
                    type: 'many-to-one',
                    label: 'Assets purchased from vendors'
                }
            ];

            localStorage.setItem('tableRelationships', JSON.stringify(demoRelationships));
        }

        // Initialize demo documents if none exist
        function initializeDemoDocuments() {
            // Check if any persona documents already exist
            const existingRetail = localStorage.getItem('retailManagerDocuments');
            const existingChemist = localStorage.getItem('researchChemistDocuments');
            const existingGraduate = localStorage.getItem('newGraduateDocuments');
            const existingAnalyst = localStorage.getItem('dataAnalystDocuments');

            // Temporarily disabled to force re-initialization with new multi-modal documents
            // if (existingRetail || existingChemist || existingGraduate || existingAnalyst) return;

            // RETAIL MANAGER DOCUMENTS
            const retailManagerDocuments = [
                {
                    title: 'Store Technology Rollout Plan - Phase 2',
                    lastModified: new Date('2025-10-30').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['CTO', 'IT', 'DM', 'AM'],
                    blocks: [
                        { id: 'tr1', type: 'header', level: 1, content: 'Store Technology Rollout Plan - Phase 2' },
                        { id: 'tr2', type: 'text', content: 'This document outlines the comprehensive plan for Phase 2 of our store technology modernization initiative, focusing on point-of-sale system upgrades, inventory management automation, and customer experience enhancements. Implementation timeline spans Q1-Q2 2026 across 47 store locations.' },

                        { id: 'tr3', type: 'header', level: 2, content: 'Executive Summary' },
                        { id: 'tr4', type: 'text', content: 'Phase 2 builds upon the successful completion of Phase 1 (network infrastructure) and introduces customer-facing technology improvements. Key deliverables include new POS terminals with contactless payment support, real-time inventory tracking systems, and digital signage integration. Total budget allocated: $2.4M with expected ROI of 18% within 24 months.' },

                        { id: 'tr5', type: 'header', level: 2, content: 'Technology Architecture' },
                        { id: 'tr6', type: 'mermaid', content: 'graph TD\n    A[Store Manager Dashboard] --> B[POS System]\n    A --> C[Inventory Management]\n    A --> D[Customer Analytics]\n    B --> E[Payment Processing]\n    B --> F[Receipt Management]\n    C --> G[RFID Scanners]\n    C --> H[Automated Reordering]\n    D --> I[Loyalty Program Integration]\n    D --> J[Digital Signage]\n    E --> K[Cloud Payment Gateway]\n    F --> L[Email/SMS Receipts]\n    style A fill:#e3f2fd\n    style K fill:#f3e5f5\n    style L fill:#f3e5f5' },

                        { id: 'tr7', type: 'header', level: 2, content: 'Implementation Timeline' },
                        { id: 'tr8', type: 'table', content: 'Phase,Duration,Stores,Key Activities,Budget\nPilot Testing,Jan 15 - Feb 15,3 stores,Hardware installation and staff training,$145K\nWave 1 Rollout,Feb 16 - Mar 31,12 stores,Full system deployment,$580K\nWave 2 Rollout,Apr 1 - May 15,16 stores,Continued deployment + optimization,$725K\nWave 3 Rollout,May 16 - Jun 30,16 stores,Final deployment phase,$950K\nTotal Project,,47 stores,Complete technology modernization,$2.4M' },

                        { id: 'tr9', type: 'header', level: 2, content: 'Technical Specifications' },
                        { id: 'tr10', type: 'header', level: 3, content: 'POS System Requirements' },
                        { id: 'tr11', type: 'code', content: '// POS Terminal Configuration\n{\n  "hardware": {\n    "processor": "Intel i5-12400 or AMD Ryzen 5",\n    "memory": "8GB DDR4",\n    "storage": "256GB NVMe SSD",\n    "display": "15.6\\" touchscreen, 1920x1080",\n    "connectivity": ["WiFi 6", "Gigabit Ethernet", "USB 3.2", "NFC"]\n  },\n  "software": {\n    "os": "Windows 11 IoT Enterprise LTSC",\n    "pos_app": "RetailPro v12.3",\n    "payment_gateway": "SecurePayments API v3.1",\n    "backup": "Real-time cloud sync every 30 seconds"\n  },\n  "security": {\n    "encryption": "AES-256 at rest, TLS 1.3 in transit",\n    "authentication": "Multi-factor with biometric support",\n    "compliance": ["PCI DSS Level 1", "SOX", "GDPR"]\n  }\n}' },

                        { id: 'tr12', type: 'header', level: 3, content: 'Network Infrastructure' },
                        { id: 'tr13', type: 'text', content: 'Each store requires dedicated fiber internet connection (minimum 100Mbps up/down) with backup 5G cellular failover. Internal network consists of managed switches supporting PoE+ for digital signage and RFID readers. WiFi 6 access points provide customer and staff connectivity with separate VLANs for security.' },

                        { id: 'tr14', type: 'header', level: 2, content: 'Training & Change Management' },
                        { id: 'tr15', type: 'text', content: 'Comprehensive training program developed for three staff levels: store managers, associate managers, and sales associates. Training includes 4-hour hands-on workshops, online certification modules, and ongoing support documentation. Change management strategy focuses on demonstrating efficiency gains and customer experience improvements.' },

                        { id: 'tr16', type: 'header', level: 3, content: 'Training Schedule by Role' },
                        { id: 'tr17', type: 'table', content: 'Role,Training Duration,Format,Certification Required,Support Level\nStore Manager,8 hours,In-person workshop + online,Yes - Advanced Certification,Direct IT contact\nAssociate Manager,6 hours,Hybrid (4h in-person + 2h online),Yes - Standard Certification,Store manager + help desk\nSales Associate,4 hours,In-person hands-on,Basic proficiency test,Associate manager support\nSeasonal Staff,2 hours,Online modules only,Quick competency check,Peer buddy system' },

                        { id: 'tr18', type: 'header', level: 2, content: 'Risk Assessment & Mitigation' },
                        { id: 'tr19', type: 'text', content: 'Primary risks include system downtime during peak shopping periods, staff resistance to new technology, and potential payment processing disruptions. Mitigation strategies include comprehensive testing protocols, backup payment methods, and dedicated support team during rollout phases.' },

                        { id: 'tr20', type: 'divider', content: '', dividerType: 'page' },

                        { id: 'tr21', type: 'header', level: 2, content: 'Success Metrics & KPIs' },
                        { id: 'tr22', type: 'latex', content: '\\text{Customer Satisfaction Score} = \\frac{\\sum_{i=1}^{n} \\text{Rating}_i}{n} \\geq 4.2\n\n\\text{Transaction Speed Improvement} = \\frac{\\text{Old Average Time} - \\text{New Average Time}}{\\text{Old Average Time}} \\times 100\\% \\geq 25\\%\n\n\\text{System Uptime} = \\frac{\\text{Total Operational Hours} - \\text{Downtime Hours}}{\\text{Total Operational Hours}} \\times 100\\% \\geq 99.5\\%' },

                        { id: 'tr23', type: 'text', content: 'Success will be measured through customer satisfaction surveys, transaction processing speed analysis, system uptime monitoring, and staff productivity metrics. Monthly reviews with district managers will track progress against these KPIs and identify areas for optimization.' }
                    ]
                },
                {
                    title: 'Q4 Holiday Staffing Plan',
                    lastModified: new Date('2025-10-15').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['DM', 'HR', 'AM'],
                    blocks: [
                        { id: 'r1', type: 'header', level: 1, content: 'Q4 Holiday Staffing Plan' },
                        { id: 'r2', type: 'text', content: 'This document outlines staffing requirements and scheduling strategy for the upcoming holiday season (November - December 2025). Based on historical sales data and projected foot traffic, we anticipate a 45% increase in customer volume during peak shopping periods.\n\nKey objectives: Ensure adequate floor coverage during peak hours, minimize labor costs while maintaining service quality, provide fair schedule distribution, and maintain compliance with labor regulations.' },
                        { id: 'r3', type: 'header', level: 2, content: 'Staffing Requirements' },
                        { id: 'r4', type: 'table', content: 'Week,Required Staff,Peak Hours,Estimated Sales\nNov 25-Dec 1,28,10am-8pm,$185K\nDec 2-Dec 8,22,11am-7pm,$142K\nDec 9-Dec 15,26,10am-9pm,$168K\nDec 16-Dec 22,32,9am-9pm,$225K\nDec 23-Dec 25,18,10am-6pm,$95K' },
                        { id: 'r5', type: 'header', level: 2, content: 'Schedule Timeline' },
                        { id: 'r6', type: 'mermaid', content: 'gantt\n    title Holiday Staffing Schedule\n    dateFormat  YYYY-MM-DD\n    section Black Friday\n    Peak Coverage :a1, 2025-11-28, 3d\n    section Mid-Season\n    Standard Coverage :a2, 2025-12-01, 14d\n    section Final Rush\n    Maximum Coverage :a3, 2025-12-15, 8d' },
                        { id: 'r7', type: 'header', level: 2, content: 'Coverage Analysis' },
                        { id: 'r8', type: 'text', content: 'Based on 2024 performance data, we need minimum 3 cashiers, 4 sales floor associates, 2 fitting room attendants, 1 stock clerk, and 1 manager on duty during peak hours. Weekend coverage requires 25% additional staff. Break schedules must comply with state labor laws (30min unpaid for shifts >6 hours).' }
                    ]
                },
                {
                    title: 'Inventory Management Report - October 2025',
                    lastModified: new Date('2025-10-12').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['DM', 'VM', 'PC'],
                    blocks: [
                        { id: 'i1', type: 'header', level: 1, content: 'Monthly Inventory Analysis - October 2025' },
                        { id: 'i2', type: 'text', content: 'This report analyzes current stock levels, identifies reorder needs, and highlights performance metrics for October 2025. Total inventory value: $485K across 2,847 unique SKUs. Critical attention needed for 47 items below safety stock levels.' },
                        { id: 'i3', type: 'header', level: 2, content: 'Low Stock Alert' },
                        { id: 'i4', type: 'table', content: 'SKU,Product,Current Stock,Min Level,Reorder Qty,Supplier\nWJ-001,Winter Jacket Blue M,3,15,50,North Coast\nBT-205,Leather Boots Size 9,2,10,25,Footwear Plus\nSW-089,Cashmere Sweater L,1,8,20,Premium Knits\nJN-445,Skinny Jeans 32x32,4,12,30,Denim Works\nAC-223,Silk Scarf Floral,0,5,15,Luxury Access' },
                        { id: 'i5', type: 'header', level: 2, content: 'Top Performers' },
                        { id: 'i6', type: 'table', content: 'Product Category,Units Sold,Revenue,Margin %\nWomen Outerwear,234,$28,450,65%\nFootwear,189,$31,200,58%\nAccessories,156,$12,800,72%\nMen Casual,143,$19,600,61%\nDresses,128,$22,100,68%' },
                        { id: 'i7', type: 'header', level: 2, content: 'Seasonal Recommendations' },
                        { id: 'i8', type: 'text', content: 'With holiday season approaching, recommend increasing winter apparel inventory by 40%. Focus on coat sizes M-XL, boots sizes 7-10, and gift accessories under $50. Monitor cashmere and wool items closely - demand typically peaks in November.' }
                    ]
                },
                {
                    title: 'Store Performance Review - Q3 2025',
                    lastModified: new Date('2025-10-08').toISOString(),
                    documentType: 'unstructured',
                    sharedWith: ['RM', 'DM'],
                    richTextContent: '<h1>Store Performance Review - Third Quarter 2025</h1><p>This quarterly review assesses overall store performance across key metrics including sales, customer satisfaction, team productivity, and operational efficiency. Q3 results show strong performance with several areas for continued focus and improvement.</p><h2>Sales Performance</h2><p><strong>Revenue:</strong> $847,000 (vs $785K target) - 8% over goal<br><strong>Transactions:</strong> 15,420 (average ticket $54.95)<br><strong>Conversion Rate:</strong> 68% (up from 64% in Q2)<br><strong>Return Rate:</strong> 8.2% (within acceptable range)</p><p>Notable achievements include successful back-to-school campaign driving 23% increase in August sales, effective cross-selling program boosting average transaction by $8, and improved inventory management reducing stockouts by 40%.</p><h2>Customer Experience</h2><p>Customer satisfaction scores averaged 4.3/5 (target: 4.2). Mystery shopper evaluations rated service at 87/100, with particular strength in product knowledge and greeting protocols. Areas for improvement include checkout speed during peak hours and fitting room maintenance.</p><p>Customer feedback themes: Excellent product selection (mentioned in 78% of positive reviews), friendly staff (mentioned in 65%), competitive pricing (mentioned in 52%). Primary complaint: long checkout lines during weekends.</p><h2>Team Performance</h2><p>Team of 18 associates maintained strong performance metrics. Attendance rate 94%, punctuality 97%. Three team members earned recognition for exceptional customer service. Sales per hour averaged $127 across the team, with top performer reaching $156/hour.</p><p><strong>Recommendations for Q4:</strong> Implement mobile checkout during peak periods, enhance weekend staffing, focus on winter merchandise presentation, and continue customer service excellence initiatives. Target Q4 revenue: $925,000.</p>'
                },
                {
                    title: 'Customer Loyalty Program Analysis',
                    lastModified: new Date('2025-11-02').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['MM', 'DM', 'CM'],
                    blocks: [
                        { id: 'cl1', type: 'header', level: 1, content: 'Customer Loyalty Program Performance Analysis' },
                        { id: 'cl2', type: 'text', content: 'This document analyzes our customer loyalty program performance over the past 6 months since launch. The "Style Rewards" program has enrolled 2,847 customers with strong engagement metrics and measurable impact on repeat purchase behavior.' },

                        { id: 'cl3', type: 'header', level: 2, content: 'Program Overview & Metrics' },
                        { id: 'cl4', type: 'table', content: 'Metric,Current Value,Target,Status\nTotal Enrolled Members,2847,2500,✓ Exceeded\nActive Members (90 days),1923,1800,✓ Exceeded\nAverage Points per Member,1240,1000,✓ Exceeded\nRedemption Rate,34%,25%,✓ Exceeded\nMember Retention Rate,78%,70%,✓ Exceeded\nIncremental Revenue,+$127K,+$100K,✓ Exceeded' },

                        { id: 'cl5', type: 'header', level: 2, content: 'Technical Implementation' },
                        { id: 'cl6', type: 'text', content: 'The loyalty system integrates with our existing POS infrastructure through a REST API connection. Real-time point calculation and tier status updates occur at transaction completion. Mobile app enrollment drives 68% of new sign-ups.' },

                        { id: 'cl7', type: 'code', content: '// Loyalty Points Calculation Logic\nfunction calculatePoints(transaction) {\n  const baseRate = 1; // 1 point per $1 spent\n  let multiplier = 1;\n  \n  // Tier bonuses\n  if (customer.tier === "Silver") multiplier = 1.25;\n  if (customer.tier === "Gold") multiplier = 1.5;\n  if (customer.tier === "Platinum") multiplier = 2.0;\n  \n  // Category bonuses\n  const categoryBonuses = {\n    "new-arrivals": 2.0,\n    "seasonal": 1.5,\n    "accessories": 1.25\n  };\n  \n  let totalPoints = 0;\n  transaction.items.forEach(item => {\n    const categoryMultiplier = categoryBonuses[item.category] || 1;\n    const itemPoints = item.price * baseRate * multiplier * categoryMultiplier;\n    totalPoints += Math.floor(itemPoints);\n  });\n  \n  return totalPoints;\n}' },

                        { id: 'cl8', type: 'header', level: 2, content: 'Member Engagement Analysis' },
                        { id: 'cl9', type: 'mermaid', content: 'pie title Member Distribution by Tier\n    "Bronze (0-499 pts)" : 1156\n    "Silver (500-1499 pts)" : 1024\n    "Gold (1500-2999 pts)" : 487\n    "Platinum (3000+ pts)" : 180' },

                        { id: 'cl10', type: 'header', level: 3, content: 'Purchase Behavior Insights' },
                        { id: 'cl11', type: 'table', content: 'Customer Segment,Avg Transaction,Visit Frequency,Favorite Categories\nPlatinum Members,$89.40,2.3x/month,Designer • Accessories • Shoes\nGold Members,$67.20,1.8x/month,Seasonal • Outerwear • Handbags\nSilver Members,$52.10,1.4x/month,Basic • Casual • Sale Items\nBronze Members,$41.80,0.9x/month,Essentials • Clearance • Basics' },

                        { id: 'cl12', type: 'divider', content: '' },

                        { id: 'cl13', type: 'header', level: 2, content: 'Success Metrics & ROI' },
                        { id: 'cl14', type: 'latex', content: '\\text{Program ROI} = \\frac{\\text{Incremental Revenue} - \\text{Program Costs}}{\\text{Program Costs}} \\times 100\\%\n\n\\text{Current ROI} = \\frac{\\$127,000 - \\$32,000}{\\$32,000} \\times 100\\% = 297\\%\n\n\\text{Customer Lifetime Value Increase} = \\frac{\\text{Member CLV} - \\text{Non-Member CLV}}{\\text{Non-Member CLV}} \\times 100\\% = +43\\%' },

                        { id: 'cl15', type: 'header', level: 2, content: 'Recommendations' },
                        { id: 'cl16', type: 'markdown', content: '**Immediate Actions (Next 30 days):**\n\n- [ ] Launch referral bonus program (500 points for successful referral)\n- [ ] Implement birthday month double points promotion\n- [ ] Add exclusive early access to sales for Gold+ members\n\n**Medium-term Initiatives (Next Quarter):**\n\n- [ ] Partner with local businesses for cross-promotional point earning\n- [ ] Develop personalized product recommendations based on purchase history\n- [ ] Create VIP shopping events for Platinum members\n\n**Long-term Strategy (6+ months):**\n\n- [ ] Expand program to include experiential rewards (styling sessions, events)\n- [ ] Integrate with social media for engagement-based point earning\n- [ ] Develop mobile app with gamification features' },

                        { id: 'cl17', type: 'text', content: 'The loyalty program has exceeded all initial targets and demonstrates strong potential for continued growth. Member satisfaction scores average 4.6/5, with 89% of surveyed members saying the program influences their shopping decisions. Recommend increasing marketing budget by 25% to accelerate enrollment growth.' }
                    ]
                }
            ];

            // RESEARCH CHEMIST DOCUMENTS
            const researchChemistDocuments = [
                {
                    title: 'Lab Safety Protocol - Chemical Handling',
                    lastModified: new Date('2025-10-18').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['LS', 'RC', 'PD'],
                    blocks: [
                        { id: 'c1', type: 'header', level: 1, content: 'Chemical Handling Safety Protocol' },
                        { id: 'c2', type: 'text', content: 'This document outlines mandatory safety procedures for handling hazardous chemicals in Laboratory B-12. All personnel must complete safety training before working with Class 3 or higher chemicals. Last updated following OSHA inspection recommendations.' },
                        { id: 'c3', type: 'header', level: 2, content: 'Personal Protective Equipment (PPE)' },
                        { id: 'c4', type: 'markdown', content: '**Required for all chemical work:**\n\n- [ ] Safety goggles (ANSI Z87.1 compliant)\n- [ ] Lab coat (flame-resistant, knee-length)\n- [ ] Closed-toe shoes (no sandals/heels)\n- [ ] Long pants (no shorts/skirts)\n\n**Additional PPE by hazard class:**\n- [ ] Nitrile gloves (Class 1-2 chemicals)\n- [ ] Butyl rubber gloves (Class 3+ chemicals)\n- [ ] Face shield (corrosive materials)\n- [ ] Respirator (volatile organics, as specified)' },
                        { id: 'c5', type: 'header', level: 2, content: 'Chemical Classifications' },
                        { id: 'c6', type: 'table', content: 'Class,Hazard Level,Examples,Storage Temp,Special Requirements\n1,Low,NaCl H₂O,Room Temp,Standard cabinet\n2,Moderate,Ethanol Acetone,Room Temp,Ventilated cabinet\n3,High,HCl NaOH,Room Temp,Locked acid/base cabinet\n4,Severe,Benzene CCl₄,4°C,Restricted access freezer\n5,Extreme,HF Osmium,4°C,Dual approval required' },
                        { id: 'c7', type: 'header', level: 2, content: 'Emergency Procedures' },
                        { id: 'c8', type: 'text', content: 'In case of spill: Evacuate area, activate emergency shower if skin contact, call Safety Office (x4911). Eye wash stations located at exits. Emergency shut-off valves are red-handled near each workbench. Spill kits contain neutralizing agents for acids/bases.' }
                    ]
                },
                {
                    title: 'Experiment Log - Polymer Synthesis #347',
                    lastModified: new Date('2025-10-22').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['PI', 'LT', 'RC'],
                    blocks: [
                        { id: 'e1', type: 'header', level: 1, content: 'Polymer Synthesis Experiment #347' },
                        { id: 'e2', type: 'text', content: 'Objective: Synthesize biodegradable polyester from renewable monomers using ring-opening polymerization. Target molecular weight: 15,000-25,000 g/mol. Expected yield: >85%. This experiment is part of the sustainable materials research project.' },
                        { id: 'e3', type: 'header', level: 2, content: 'Materials and Reagents' },
                        { id: 'e4', type: 'table', content: 'Chemical,CAS Number,Amount,Purity,Supplier\nL-Lactide,4511-42-6,5.0g,99.5%,Sigma-Aldrich\nTin(II) ethylhexanoate,301-10-0,50mg,95%,TCI Chemicals\nDodecanol,112-53-8,100mg,98%,Fisher Scientific\nToluene,108-88-3,50mL,99.8%,EMD Millipore\nMethanol,67-56-1,200mL,99.9%,Fisher Scientific' },
                        { id: 'e5', type: 'header', level: 2, content: 'Procedure' },
                        { id: 'e6', type: 'text', content: '1. Set up reaction under nitrogen atmosphere in flame-dried glassware\n2. Dissolve L-lactide (5.0g, 34.7 mmol) in anhydrous toluene (30 mL)\n3. Add dodecanol initiator (100 mg, 0.54 mmol) and Sn(Oct)₂ catalyst (50 mg)\n4. Heat to 130°C and monitor by ¹H NMR (aliquots at 2, 4, 8 hours)\n5. Cool to RT, precipitate in cold methanol, filter and dry under vacuum' },
                        { id: 'e7', type: 'header', level: 2, content: 'Results and Analysis' },
                        { id: 'e8', type: 'table', content: 'Time (h),Conversion (%),Mn (g/mol),PDI,Yield (%)\n2,45,8500,1.2,-\n4,78,18200,1.4,-\n8,92,22500,1.6,87' },
                        { id: 'e9', type: 'code', language: 'python', content: '# Molecular weight calculation\nimport numpy as np\n\n# GPC data analysis\nretention_times = [15.2, 16.8, 18.1, 19.4]\nmolecular_weights = [45000, 22500, 12000, 5000]\n\n# Calculate polydispersity\nMn = 22500  # Number average\nMw = 36000  # Weight average\nPDI = Mw / Mn\nprint(f"PDI: {PDI:.2f}")' }
                    ]
                },
                {
                    title: 'Research Proposal - Biodegradable Plastics Study',
                    lastModified: new Date('2025-10-20').toISOString(),
                    documentType: 'unstructured',
                    sharedWith: ['PI', 'DH', 'FO'],
                    richTextContent: '<h1>Research Proposal: Development of Marine-Degradable Plastic Alternatives</h1><h2>Abstract</h2><p>This proposal outlines a 18-month research project to develop novel biodegradable polymer materials specifically designed for marine environments. Current biodegradable plastics degrade poorly in saltwater conditions, contributing to ocean pollution. Our approach combines renewable monomers with marine-specific degradation pathways to create packaging materials that break down within 6 months in seawater.</p><h2>Research Objectives</h2><p><strong>Primary Goal:</strong> Synthesize and characterize biodegradable polymers with marine degradation rates <180 days</p><p><strong>Specific Aims:</strong></p><ul><li>Develop three polymer series based on alginate, chitosan, and PHA platforms</li><li>Optimize mechanical properties to match conventional plastic films</li><li>Conduct accelerated marine degradation testing per ASTM D6691</li><li>Evaluate eco-toxicity using standard marine organism bioassays</li><li>Scale synthesis to 100g batches for application testing</li></ul><h2>Literature Review</h2><p>Marine plastic pollution affects 700+ species and costs global economies $13B annually. Current biodegradable alternatives like PLA require industrial composting at 58°C, unsuitable for ocean environments. Recent advances in marine-degradable polymers show promise, with seaweed-based materials achieving 60% degradation in 90 days. However, mechanical properties remain insufficient for packaging applications.</p><h2>Methodology</h2><p>We will employ ring-opening polymerization and enzymatic catalysis to synthesize target polymers. Marine degradation testing will be conducted in artificial seawater at 15°C, 25°C, and 35°C to simulate global ocean conditions. Polymer characterization will include GPC, DSC, tensile testing, and FTIR analysis. Degradation products will be analyzed by LC-MS.</p><h2>Budget and Timeline</h2><p><strong>Total Budget:</strong> $185,000 over 18 months</p><p><strong>Phase 1</strong> (Months 1-6): Polymer synthesis and optimization - $65K<br><strong>Phase 2</strong> (Months 7-12): Marine degradation studies - $75K<br><strong>Phase 3</strong> (Months 13-18): Scale-up and application testing - $45K</p><p><strong>Expected Outcomes:</strong> 3 peer-reviewed publications, 2 patent applications, demonstration of commercial viability for marine-degradable packaging materials with potential market impact of $500M+ in sustainable packaging sector.</p>'
                },
                {
                    title: 'Spectroscopy Data Analysis - Compound X47B',
                    lastModified: new Date('2025-11-01').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['RC', 'PI', 'GS'],
                    blocks: [
                        { id: 'sp1', type: 'header', level: 1, content: 'Spectroscopic Characterization of Compound X47B' },
                        { id: 'sp2', type: 'text', content: 'Complete structural elucidation of novel heterocyclic compound X47B (C₁₅H₁₁NO₃S) synthesized via multi-step reaction sequence. Molecular weight confirmed at 285.32 g/mol by high-resolution mass spectrometry. All spectroscopic data consistent with proposed quinoline-thiophene structure.' },

                        { id: 'sp3', type: 'header', level: 2, content: 'Experimental Conditions' },
                        { id: 'sp4', type: 'table', content: 'Analysis,Instrument,Solvent,Temperature,Acquisition Parameters\n¹H NMR,Bruker 500 MHz,CDCl₃,25°C,32 scans 0.8 Hz resolution\n¹³C NMR,Bruker 125 MHz,CDCl₃,25°C,1024 scans proton-decoupled\nIR Spectroscopy,Perkin-Elmer FT-IR,KBr pellet,RT,4000-400 cm⁻¹ 2 cm⁻¹ resolution\nMS Analysis,Agilent Q-TOF,MeCN/H₂O,RT,ESI positive mode 50-800 m/z\nUV-Vis,Shimadzu UV-2600,EtOH,RT,200-800 nm 0.5 nm bandwidth' },

                        { id: 'sp5', type: 'header', level: 2, content: 'Molecular Structure' },
                        { id: 'sp6', type: 'image', content: 'https://via.placeholder.com/400x300/0066CC/FFFFFF?text=Compound+X47B+Structure' },

                        { id: 'sp7', type: 'header', level: 2, content: 'NMR Data Processing' },
                        { id: 'sp8', type: 'code', language: 'python', content: '# NMR Data Analysis Script\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom scipy.optimize import curve_fit\n\n# ¹H NMR chemical shifts (ppm) and integrations\nh_shifts = [8.92, 8.45, 7.89, 7.73, 7.42, 7.28, 6.95, 4.12, 1.45]\nh_integrals = [1, 1, 1, 2, 2, 1, 1, 2, 3]\nh_multiplicities = ["d", "d", "dd", "m", "m", "s", "s", "q", "t"]\n\n# Calculate theoretical vs experimental integrations\ntotal_protons = 11  # from molecular formula\ntheoretical = [h * total_protons / sum(h_integrals) for h in h_integrals]\nprint("Theoretical integrations:", theoretical)\n\n# ¹³C NMR data processing\nc_shifts = [162.4, 158.1, 149.3, 142.8, 135.7, 131.2, 128.9, 126.4, 125.1, 121.8, 118.6, 65.2, 14.8]\nprint(f"Carbon count: {len(c_shifts)} (Expected: 15)")' },

                        { id: 'sp9', type: 'header', level: 2, content: 'Spectral Assignments' },
                        { id: 'sp10', type: 'table', content: 'Position,¹H NMR (ppm),¹³C NMR (ppm),Assignment,COSY Correlations\nH-2,8.92 (d),149.3,Quinoline H-2,H-3\nH-3,8.45 (d),121.8,Quinoline H-3,H-2 H-4\nH-4,7.89 (dd),135.7,Quinoline H-4,H-3\nH-5/H-6,7.73 (m),131.2 128.9,Quinoline aromatics,Complex multipicity\nH-7/H-8,7.42 (m),126.4 125.1,Quinoline aromatics,Complex multicity\nH-thiophene,7.28 (s),142.8,Thiophene H-2,Isolated singlet\nH-aromatic,6.95 (s),118.6,Substituted aromatic,Isolated singlet\nOCH₂,4.12 (q),65.2,Ethyl ester CH₂,CH₃ triplet\nCH₃,1.45 (t),14.8,Ethyl ester CH₃,OCH₂ quartet' },

                        { id: 'sp11', type: 'header', level: 2, content: 'IR Spectroscopy Analysis' },
                        { id: 'sp12', type: 'mermaid', content: 'graph LR\n    A[4000 cm⁻¹] --> B[C-H Stretch<br>3045-3005 cm⁻¹]\n    A --> C[C=O Stretch<br>1725 cm⁻¹]\n    A --> D[C=N Stretch<br>1610 cm⁻¹]\n    A --> E[Aromatic C=C<br>1585 1495 cm⁻¹]\n    A --> F[C-O Stretch<br>1275 cm⁻¹]\n    A --> G[C-S Stretch<br>695 cm⁻¹]\n    style C fill:#ffcccc\n    style D fill:#ccffcc\n    style G fill:#ccccff' },

                        { id: 'sp13', type: 'divider', content: '' },

                        { id: 'sp14', type: 'header', level: 2, content: 'Quantum Chemical Calculations' },
                        { id: 'sp15', type: 'latex', content: '\\text{DFT Calculation Results (B3LYP/6-31G*):}\n\n\\text{Optimized Bond Lengths:}\n\nC-N_{quinoline} = 1.342 \\text{ Å} \\quad (\\text{literature: } 1.340 \\text{ Å})\n\nC-S_{thiophene} = 1.714 \\text{ Å} \\quad (\\text{literature: } 1.716 \\text{ Å})\n\n\\text{Calculated } ^1H \\text{ NMR shifts correlate with experimental data:}\n\n\\text{RMSD} = \\sqrt{\\frac{1}{n}\\sum_{i=1}^{n}(\\delta_{calc,i} - \\delta_{exp,i})^2} = 0.23 \\text{ ppm}' },

                        { id: 'sp16', type: 'header', level: 2, content: 'Conclusion' },
                        { id: 'sp17', type: 'markdown', content: '**Structural Confirmation:**\n\n✅ **Molecular Formula:** C₁₅H₁₁NO₃S confirmed by HRMS\n✅ **Functional Groups:** Quinoline, thiophene, ester functionalities identified\n✅ **Stereochemistry:** Single isomer confirmed by NMR\n✅ **Purity:** >95% by ¹H NMR integration\n\n**Key Findings:**\n\n- **Unique Chemical Shifts:** Quinoline H-2 (8.92 ppm) indicates electron-deficient system\n- **Coupling Patterns:** Complex aromatic region consistent with substitution pattern\n- **Conformational Analysis:** Restricted rotation observed between aromatic rings\n\n**Next Steps:**\n\n- [ ] Single crystal X-ray crystallography for absolute structure confirmation\n- [ ] Variable temperature NMR to study rotational dynamics\n- [ ] Biological activity screening against target enzyme panel' },

                        { id: 'sp18', type: 'text', content: 'All spectroscopic evidence supports the proposed structure of compound X47B. The synthesis pathway successfully produced the target heterocyclic system with excellent regioselectivity. Compound shows promising preliminary activity in initial screening assays.' }
                    ]
                }
            ];

            // NEW GRADUATE DOCUMENTS
            const newGraduateDocuments = [
                {
                    title: 'Job Application Tracker',
                    lastModified: new Date('2025-10-25').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['CV', 'MN'],
                    blocks: [
                        { id: 'j1', type: 'header', level: 1, content: 'Job Application Tracking - Fall 2025' },
                        { id: 'j2', type: 'text', content: 'Tracking all job applications submitted since graduation in May 2025. Target: 50 applications by end of November. Currently at 23 applications with 8 interviews scheduled. Focus areas: Software Engineering, Data Analysis, Product Management roles at tech companies.' },
                        { id: 'j3', type: 'header', level: 2, content: 'Application Status' },
                        { id: 'j4', type: 'table', content: 'Company,Position,Date Applied,Status,Next Step,Salary Range\nGoogle,Software Engineer,2025-09-15,Interview - Final,Onsite 10/28,$95K-$125K\nMicrosoft,PM Intern,2025-09-20,Rejected,N/A,$85K-$110K\nStartup Co,Full Stack Dev,2025-09-25,Phone Screen,Technical 10/30,$70K-$90K\nAmazon,Data Analyst,2025-10-01,Applied,Waiting,,$80K-$105K\nFacebook,Frontend Dev,2025-10-05,Phone Screen,Take-home,,$90K-$115K\nSpotify,Product Analyst,2025-10-10,Interview,Panel 11/01,$75K-$95K\nUber,Software Engineer,2025-10-12,Applied,Waiting,$85K-$115K\nAirbnb,Data Scientist,2025-10-15,Coding Test,Submit by 10/29,$90K-$120K' },
                        { id: 'j5', type: 'header', level: 2, content: 'Interview Preparation' },
                        { id: 'j6', type: 'markdown', content: '**Technical Skills to Review:**\n\n- [ ] Data structures and algorithms (LeetCode practice)\n- [ ] System design basics (distributed systems, caching)\n- [ ] SQL query optimization and database design\n- [ ] JavaScript/Python coding challenges\n- [ ] Behavioral interview questions (STAR method)\n\n**Companies with upcoming interviews:**\n- [ ] Google onsite (October 28) - Review distributed systems\n- [ ] Startup Co technical (October 30) - Full-stack project walkthrough\n- [ ] Spotify panel (November 1) - Product case study preparation' },
                        { id: 'j7', type: 'header', level: 2, content: 'Networking Contacts' },
                        { id: 'j8', type: 'table', content: 'Name,Company,Position,Connection,Last Contact\nSarah Kim,Google,Senior SWE,College alumna,10/20/25\nMike Chen,Microsoft,PM,LinkedIn,10/15/25\nAlex Rodriguez,Startup Co,CTO,Friend referral,10/22/25\nJenna Park,Amazon,Data Scientist,Career fair,10/18/25\nTom Wilson,Facebook,Engineering Manager,Professor introduction,10/25/25' }
                    ]
                },
                {
                    title: 'Career Development Plan - First Year',
                    lastModified: new Date('2025-10-28').toISOString(),
                    documentType: 'unstructured',
                    sharedWith: ['MN', 'CM'],
                    richTextContent: '<h1>Career Development Plan: First Year in Tech</h1><h2>Professional Goals</h2><p>As a recent computer science graduate entering the tech industry, my primary goal is to establish a strong foundation in software development while exploring different career paths. I aim to develop both technical expertise and professional skills that will position me for long-term success in technology roles.</p><h2>Short-term Objectives (0-6 months)</h2><p><strong>Technical Skills:</strong> Strengthen core programming abilities in Python and JavaScript, gain experience with modern frameworks (React, Node.js), and develop proficiency in cloud platforms (AWS or Azure). Complete at least 100 coding challenges and contribute to 2 open-source projects.</p><p><strong>Professional Development:</strong> Build effective communication skills through code reviews and technical presentations. Learn to work in agile development environments and understand CI/CD practices. Establish mentorship relationships with 2-3 senior engineers.</p><p><strong>Industry Knowledge:</strong> Stay current with technology trends through daily reading (Hacker News, tech blogs), attend local meetups and conferences, and build a professional network within the tech community.</p><h2>Medium-term Goals (6-12 months)</h2><p>Demonstrate impact through successful project deliveries and begin specializing in a particular domain (web development, data engineering, or mobile development). Seek increased responsibility such as leading small features or mentoring interns. Consider pursuing relevant certifications (AWS, Google Cloud) to validate cloud computing skills.</p><h2>Learning Plan</h2><p><strong>Technical Learning:</strong> Complete online courses in system design, database optimization, and software architecture patterns. Practice designing and implementing REST APIs, work with relational and NoSQL databases, and learn containerization with Docker.</p><p><strong>Soft Skills:</strong> Develop presentation abilities through internal tech talks, improve written communication through documentation and blog posts, and enhance collaboration skills through pair programming and code reviews.</p><h2>Success Metrics</h2><p>Track progress through quarterly performance reviews, peer feedback, and personal project portfolio growth. Measure technical advancement through successful completion of increasingly complex assignments and positive code review feedback. Monitor professional development through expanded network connections, speaking opportunities, and internal recognition.</p><p><strong>Year-end Target:</strong> Transition from junior to mid-level developer with specialized expertise, strong peer relationships, and clear direction for continued career growth in technology.</p>'
                },
                {
                    title: 'Technical Interview Preparation Guide',
                    lastModified: new Date('2025-11-03').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['MN', 'ST'],
                    blocks: [
                        { id: 'tp1', type: 'header', level: 1, content: 'Technical Interview Preparation Strategy' },
                        { id: 'tp2', type: 'text', content: 'Comprehensive preparation plan for technical interviews at top tech companies. Covers algorithms, system design, behavioral questions, and company-specific preparation. Target timeline: 8 weeks of intensive preparation before interview season.' },

                        { id: 'tp3', type: 'header', level: 2, content: 'Algorithm & Data Structure Roadmap' },
                        { id: 'tp4', type: 'table', content: 'Topic,Problems to Solve,Key Patterns,Time Allocation\nArrays & Strings,25 problems,Two pointers sliding window,Week 1\nLinked Lists,15 problems,Fast/slow pointers dummy nodes,Week 1\nTrees & Graphs,30 problems,DFS/BFS traversals,Week 2-3\nDynamic Programming,20 problems,Memoization bottom-up,Week 4\nHeaps & Priority Queues,15 problems,Top-K problems scheduling,Week 5\nBacktracking,12 problems,Permutations combinations,Week 5\nSystem Design,8 case studies,Scalability patterns,Week 6-7\nBehavioral Questions,15 scenarios,STAR method,Week 8' },

                        { id: 'tp5', type: 'header', level: 2, content: 'Coding Practice Schedule' },
                        { id: 'tp6', type: 'mermaid', content: 'gantt\n    title 8-Week Interview Prep Timeline\n    dateFormat  YYYY-MM-DD\n    section Fundamentals\n    Arrays & Linked Lists    :a1, 2025-11-04, 7d\n    Trees & Graph Basics     :a2, after a1, 7d\n    section Advanced Topics\n    Graph Algorithms         :b1, after a2, 7d\n    Dynamic Programming      :b2, after b1, 7d\n    section Specialized\n    Heaps & Backtracking     :c1, after b2, 7d\n    System Design Basics     :c2, after c1, 7d\n    section Integration\n    Mock Interviews          :d1, after c2, 14d' },

                        { id: 'tp7', type: 'header', level: 2, content: 'Sample Algorithm Implementation' },
                        { id: 'tp8', type: 'text', content: 'Here is a well-commented solution to a common interview problem that demonstrates clean coding practices and optimal time complexity:' },

                        { id: 'tp9', type: 'code', language: 'python', content: 'def longest_substring_without_repeating(s):\n    """\n    Find length of longest substring without repeating characters\n    Time: O(n), Space: O(min(m,n)) where m is charset size\n    \n    Algorithm: Sliding Window with HashMap\n    - Use two pointers (left, right) to maintain window\n    - Track character positions in HashMap\n    - Shrink window when duplicate found\n    """\n    if not s:\n        return 0\n    \n    char_map = {}  # character -> last seen index\n    max_length = 0\n    left = 0\n    \n    for right in range(len(s)):\n        current_char = s[right]\n        \n        # If character seen before and within current window\n        if current_char in char_map and char_map[current_char] >= left:\n            # Move left pointer past duplicate\n            left = char_map[current_char] + 1\n        \n        # Update character position\n        char_map[current_char] = right\n        \n        # Update max length if current window is larger\n        current_length = right - left + 1\n        max_length = max(max_length, current_length)\n    \n    return max_length\n\n# Test cases with expected outputs\ntest_cases = [\n    ("abcabcbb", 3),  # "abc"\n    ("bbbbb", 1),     # "b"\n    ("pwwkew", 3),    # "wke"\n    ("", 0),          # empty string\n    ("dvdf", 3)       # "vdf"\n]\n\nfor input_str, expected in test_cases:\n    result = longest_substring_without_repeating(input_str)\n    print(f"Input: \\"{input_str}\\" -> Output: {result} (Expected: {expected})"' },

                        { id: 'tp10', type: 'header', level: 2, content: 'System Design Study Plan' },
                        { id: 'tp11', type: 'markdown', content: '**Core Concepts to Master:**\n\n**Scalability Fundamentals:**\n- [ ] Horizontal vs Vertical Scaling\n- [ ] Load Balancers (Layer 4 vs Layer 7)\n- [ ] Database Partitioning & Sharding\n- [ ] Caching Strategies (Redis, Memcached)\n- [ ] Message Queues (Kafka, RabbitMQ)\n\n**Storage & Databases:**\n- [ ] SQL vs NoSQL trade-offs\n- [ ] CAP Theorem implications\n- [ ] Consistency patterns (Eventual, Strong)\n- [ ] Replication strategies (Master-Slave, Master-Master)\n\n**Practice Problems:**\n- [ ] Design URL Shortener (like bit.ly)\n- [ ] Design Chat System (like WhatsApp)\n- [ ] Design Social Media Feed (like Twitter)\n- [ ] Design Video Streaming (like YouTube)\n- [ ] Design Search Engine (like Google)\n- [ ] Design Ride Sharing (like Uber)\n- [ ] Design Key-Value Store (like DynamoDB)\n- [ ] Design Notification System' },

                        { id: 'tp12', type: 'divider', content: '' },

                        { id: 'tp13', type: 'header', level: 2, content: 'Company-Specific Preparation' },
                        { id: 'tp14', type: 'table', content: 'Company,Interview Focus,Preparation Strategy,Resources\nGoogle,Algorithm depth & optimization,LeetCode Hard problems,Google interview guide\nMeta,System design & architecture,Practice designing social features,Meta engineering blog\nAmazon,Leadership principles & coding,Behavioral examples + algorithms,Amazon LP guide\nMicrosoft,Problem-solving approach,Explain thought process clearly,Microsoft careers site\nApple,Attention to detail & quality,Clean well-tested code,Apple developer resources\nNetflix,Cultural fit & scaling,High-performance systems design,Netflix tech blog\nUber,Real-world problem solving,Location-based system design,Uber engineering blog\nAirbnb,Product thinking & engineering,User-focused system design,Airbnb engineering blog' },

                        { id: 'tp15', type: 'header', level: 2, content: 'Performance Tracking' },
                        { id: 'tp16', type: 'latex', content: '\\text{Weekly Progress Metrics:}\n\n\\text{Problem Solving Rate} = \\frac{\\text{Problems Solved Correctly}}{\\text{Total Problems Attempted}} \\times 100\\%\n\n\\text{Target: } \\geq 75\\% \\text{ by Week 4, } \\geq 85\\% \\text{ by Week 8}\n\n\\text{Time Efficiency} = \\frac{\\text{Optimal Solution Time}}{\\text{Actual Solution Time}}\n\n\\text{Target: } \\geq 0.8 \\text{ for Medium problems, } \\geq 0.6 \\text{ for Hard problems}' },

                        { id: 'tp17', type: 'header', level: 2, content: 'Mock Interview Schedule' },
                        { id: 'tp18', type: 'text', content: 'Final two weeks focus on realistic interview simulation with peers and mentors. Schedule 2-3 mock interviews per week covering different formats: phone screens, technical deep-dives, system design discussions, and behavioral interviews. Record sessions for review and improvement.' }
                    ]
                }
            ];

            // DATA ANALYST DOCUMENTS
            const dataAnalystDocuments = [
                {
                    title: 'Customer Churn Analysis - September 2025',
                    lastModified: new Date('2025-10-30').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['DS', 'PM', 'CS'],
                    blocks: [
                        { id: 'd1', type: 'header', level: 1, content: 'Customer Churn Analysis Report' },
                        { id: 'd2', type: 'text', content: 'Analysis of customer churn patterns for September 2025. Churn rate increased to 5.8% (vs 4.2% target), affecting 142 customers and $23,400 in monthly recurring revenue. Key findings: churn peaks in accounts 90+ days past renewal, correlates with reduced product usage, and concentrates in SMB segment.' },
                        { id: 'd3', type: 'header', level: 2, content: 'Data Query' },
                        { id: 'd4', type: 'code', language: 'sql', content: 'SELECT \n  DATE_TRUNC(\'month\', churn_date) as month,\n  COUNT(*) as churned_customers,\n  SUM(mrr) as lost_revenue,\n  AVG(days_since_last_login) as avg_days_inactive,\n  AVG(account_age_days) as avg_account_age\nFROM customer_churn \nWHERE churn_date >= \'2025-09-01\'\n  AND churn_date < \'2025-10-01\'\nGROUP BY DATE_TRUNC(\'month\', churn_date)\nORDER BY month;' },
                        { id: 'd5', type: 'header', level: 2, content: 'Churn Factors Analysis' },
                        { id: 'd6', type: 'table', content: 'Factor,Churned Group,Retained Group,Risk Ratio\nDays since last login,>45 days,<15 days,3.2x\nMonthly logins,<8 times,>25 times,2.8x\nSupport tickets,>5 per month,<2 per month,2.1x\nFeature adoption,<3 features,>7 features,2.4x\nAccount age,<6 months,>12 months,1.9x' },
                        { id: 'd7', type: 'header', level: 2, content: 'Predictive Model Results' },
                        { id: 'd8', type: 'code', language: 'python', content: 'import pandas as pd\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.metrics import classification_report\n\n# Model performance on test set\nrf_model = RandomForestClassifier(n_estimators=100, random_state=42)\nrf_model.fit(X_train, y_train)\n\ny_pred = rf_model.predict(X_test)\naccuracy = rf_model.score(X_test, y_test)\nprint(f"Model Accuracy: {accuracy:.3f}")\n\n# Feature importance\nfeature_importance = pd.DataFrame({\n    \'feature\': X_train.columns,\n    \'importance\': rf_model.feature_importances_\n}).sort_values(\'importance\', ascending=False)\n\nprint("\\nTop 5 Features:")\nprint(feature_importance.head())' },
                        { id: 'd9', type: 'header', level: 2, content: 'Recommendations' },
                        { id: 'd10', type: 'text', content: 'Implement proactive outreach for accounts with >30 days inactivity. Launch re-engagement email campaign targeting customers with declining usage. Develop onboarding improvements to increase feature adoption in first 60 days. Consider offering retention incentives to high-risk SMB accounts identified by the model.' }
                    ]
                },
                {
                    title: 'Executive Dashboard Requirements - KPI Metrics',
                    lastModified: new Date('2025-10-26').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['EX', 'PM', 'DE'],
                    blocks: [
                        { id: 'k1', type: 'header', level: 1, content: 'Executive Dashboard Requirements Document' },
                        { id: 'k2', type: 'text', content: 'Requirements for new executive dashboard providing real-time visibility into key business metrics. Dashboard will refresh every 15 minutes during business hours and display 12 core KPIs across 4 categories: Revenue, Customer, Product, and Operations. Target users: C-suite, VPs, Directors.' },
                        { id: 'k3', type: 'header', level: 2, content: 'Dashboard Mockup' },
                        { id: 'k4', type: 'image', content: 'https://via.placeholder.com/800x450/0066CC/FFFFFF?text=Executive+Dashboard+Wireframe' },
                        { id: 'k5', type: 'header', level: 2, content: 'KPI Definitions' },
                        { id: 'k6', type: 'table', content: 'KPI,Definition,Data Source,Update Frequency\nMonthly Recurring Revenue,Sum of all active subscriptions,Billing DB,Daily at 6 AM\nCustomer Acquisition Cost,Marketing spend / new customers,CRM + Finance,Weekly\nNet Promoter Score,Customer satisfaction survey average,Survey platform,Weekly\nDaily Active Users,Unique users with >1 action,Analytics DB,Hourly\nGross Revenue Retention,Revenue retained from existing customers,Billing DB,Monthly\nProduct Usage Rate,% of features used by active customers,Analytics DB,Daily\nSupport Ticket Volume,Number of open tickets,Support system,Real-time\nServer Uptime,% availability of core services,Monitoring tools,Real-time' },
                        { id: 'k7', type: 'header', level: 2, content: 'Technical Specifications' },
                        { id: 'k8', type: 'text', content: 'Dashboard built using Tableau connected to data warehouse via API. All metrics include month-over-month and year-over-year comparisons with color-coded trend indicators (green: positive, red: negative, yellow: neutral). Mobile-responsive design required for tablet viewing. Export functionality for PDF reports.' },
                        { id: 'k9', type: 'header', level: 2, content: 'Data Pipeline Architecture' },
                        { id: 'k10', type: 'mermaid', content: 'graph LR\n    A[CRM Database] --> D[Data Warehouse]\n    B[Analytics Database] --> D\n    C[Billing System] --> D\n    D --> E[ETL Process]\n    E --> F[Dashboard API]\n    F --> G[Tableau Dashboard]\n    G --> H[Executive Users]' }
                    ]
                },
                {
                    title: 'A/B Test Results - Checkout Flow Optimization',
                    lastModified: new Date('2025-10-29').toISOString(),
                    documentType: 'unstructured',
                    sharedWith: ['PM', 'UX', 'EN'],
                    richTextContent: '<h1>A/B Test Results: Checkout Flow Optimization</h1><h2>Executive Summary</h2><p>Our 4-week A/B test comparing the simplified checkout flow (Variant B) against the current 3-step process (Control A) shows significant improvements in conversion rates and user experience metrics. Variant B achieved an 18% increase in checkout completion rate and 12% increase in overall revenue per visitor.</p><h2>Test Design</h2><p><strong>Hypothesis:</strong> Reducing checkout steps from 3 to 2 will increase conversion by minimizing abandonment opportunities.</p><p><strong>Traffic Allocation:</strong> 50% Control A (3-step), 50% Variant B (2-step)<br><strong>Sample Size:</strong> 24,847 users (12,394 Control, 12,453 Variant)<br><strong>Test Duration:</strong> October 1-28, 2025<br><strong>Primary Metric:</strong> Checkout completion rate<br><strong>Secondary Metrics:</strong> Revenue per visitor, time to complete checkout, user satisfaction score</p><h2>Results Analysis</h2><p><strong>Statistical Significance:</strong> All primary and secondary metrics achieved 95% confidence intervals with p-values < 0.05, indicating statistically significant results.</p><h3>Key Metrics Performance</h3><ul><li><strong>Checkout Completion Rate:</strong> Control 64.2% vs Variant 75.8% (+18.1% relative lift)</li><li><strong>Revenue per Visitor:</strong> Control $18.42 vs Variant $20.63 (+12.0% relative lift)</li><li><strong>Average Time to Complete:</strong> Control 4:23 vs Variant 2:47 (-36.8% reduction)</li><li><strong>User Satisfaction Score:</strong> Control 3.4/5 vs Variant 4.1/5 (+20.6% improvement)</li></ul><h2>Segment Analysis</h2><p>Improvement was consistent across user segments, with particularly strong performance in mobile users (+24% completion rate lift) and new customers (+21% lift). Returning customers showed smaller but still significant improvement (+14% lift).</p><p>Geographic analysis revealed stronger lift in international markets (avg +22%) compared to domestic (+16%), likely due to reduced form complexity benefiting non-native English speakers.</p><h2>Implementation Recommendation</h2><p><strong>Recommendation:</strong> Implement Variant B (2-step checkout) for 100% of traffic based on strong statistical evidence and positive user feedback.</p><p><strong>Expected Annual Impact:</strong> $2.1M additional revenue based on current traffic projections, with improved customer satisfaction leading to higher retention rates.</p><p><strong>Implementation Timeline:</strong> 2 weeks for full rollout, including monitoring dashboards and rollback capability. Monitor closely for first 30 days post-launch to ensure sustained performance gains.</p>'
                },
                {
                    title: 'Sales Forecasting Model - Q1 2026 Predictions',
                    lastModified: new Date('2025-11-04').toISOString(),
                    documentType: 'structured',
                    sharedWith: ['FP', 'VP', 'DS'],
                    blocks: [
                        { id: 'sf1', type: 'header', level: 1, content: 'Q1 2026 Sales Forecasting Model' },
                        { id: 'sf2', type: 'text', content: 'Advanced time series forecasting model combining ARIMA, Prophet, and ensemble methods to predict Q1 2026 sales performance. Model incorporates seasonal patterns, external economic indicators, and promotional calendar effects. Forecast confidence intervals: 80% and 95%.' },

                        { id: 'sf3', type: 'header', level: 2, content: 'Model Architecture & Data Sources' },
                        { id: 'sf4', type: 'mermaid', content: 'graph TB\n    A[Historical Sales Data<br>36 months] --> D[Feature Engineering]\n    B[Economic Indicators<br>GDP, CPI, Unemployment] --> D\n    C[Marketing Calendar<br>Campaigns, Promotions] --> D\n    D --> E[ARIMA Model<br>Trend + Seasonality]\n    D --> F[Prophet Model<br>Holiday Effects]\n    D --> G[Random Forest<br>External Factors]\n    E --> H[Ensemble Combining<br>Weighted Average]\n    F --> H\n    G --> H\n    H --> I[Final Predictions<br>with Confidence Intervals]\n    style H fill:#e3f2fd\n    style I fill:#e8f5e8' },

                        { id: 'sf5', type: 'header', level: 2, content: 'Feature Engineering Pipeline' },
                        { id: 'sf6', type: 'code', language: 'python', content: 'import pandas as pd\nimport numpy as np\nfrom sklearn.ensemble import RandomForestRegressor\nfrom statsmodels.tsa.arima.model import ARIMA\nfrom prophet import Prophet\nfrom sklearn.metrics import mean_absolute_percentage_error\n\n# Feature engineering pipeline\ndef create_features(df):\n    """\n    Generate time series features for sales forecasting\n    """\n    df = df.copy()\n    \n    # Temporal features\n    df[\'month\'] = df[\'date\'].dt.month\n    df[\'quarter\'] = df[\'date\'].dt.quarter\n    df[\'day_of_year\'] = df[\'date\'].dt.dayofyear\n    df[\'week_of_year\'] = df[\'date\'].dt.isocalendar().week\n    \n    # Lag features (previous periods)\n    for lag in [1, 3, 6, 12]:  # 1, 3, 6, 12 months ago\n        df[f\'sales_lag_{lag}\'] = df[\'sales\'].shift(lag)\n    \n    # Rolling statistics\n    for window in [3, 6, 12]:\n        df[f\'sales_rolling_mean_{window}\'] = df[\'sales\'].rolling(window).mean()\n        df[f\'sales_rolling_std_{window}\'] = df[\'sales\'].rolling(window).std()\n    \n    # Economic indicators (external data)\n    df[\'gdp_growth_rate\'] = df[\'gdp\'].pct_change(periods=12) * 100\n    df[\'unemployment_change\'] = df[\'unemployment\'].diff()\n    df[\'consumer_confidence_ma\'] = df[\'consumer_confidence\'].rolling(3).mean()\n    \n    # Promotional effects\n    df[\'promo_intensity\'] = df[\'promo_spend\'] / df[\'promo_spend\'].rolling(12).mean()\n    df[\'days_since_last_promo\'] = (df[\'date\'] - df[\'last_promo_date\']).dt.days\n    \n    return df\n\n# Model ensemble weights (optimized via cross-validation)\nmodel_weights = {\n    \'arima\': 0.35,      # Strong for trend/seasonality\n    \'prophet\': 0.40,    # Excellent for holidays/events  \n    \'rf\': 0.25         # Good for external factors\n}\n\nprint("Feature engineering pipeline ready for Q1 2026 forecast generation")' },

                        { id: 'sf7', type: 'header', level: 2, content: 'Historical Model Performance' },
                        { id: 'sf8', type: 'table', content: 'Model,MAPE (%),RMSE ($K),MAE ($K),Training Period\nARIMA(2,1,1),8.4%,245K,185K,2022-2024\nProphet with holidays,7.2%,218K,162K,2022-2024\nRandom Forest,9.1%,267K,201K,2022-2024\nEnsemble Model,6.8%,198K,148K,2022-2024\nNaive (last year),15.3%,425K,342K,Baseline comparison\nLinear Trend,12.1%,356K,278K,Simple baseline' },

                        { id: 'sf9', type: 'header', level: 2, content: 'Q1 2026 Forecast Results' },
                        { id: 'sf10', type: 'table', content: 'Month,Point Forecast ($K),80% CI Lower ($K),80% CI Upper ($K),95% CI Lower ($K),95% CI Upper ($K),Key Drivers\nJan 2026,2847,2654,3040,2543,3151,New Year promotions post-holiday recovery\nFeb 2026,2653,2471,2835,2368,2938,Valentine\'s Day campaigns seasonal dip\nMar 2026,2912,2714,3110,2605,3219,Spring launch strong economic indicators\nQ1 Total,8412,7839,8985,7716,9308,Ensemble prediction with confidence bands' },

                        { id: 'sf11', type: 'header', level: 2, content: 'Statistical Analysis' },
                        { id: 'sf12', type: 'latex', content: '\\text{Forecast Accuracy Metrics:}\n\n\\text{MAPE} = \\frac{1}{n} \\sum_{t=1}^{n} \\left| \\frac{A_t - F_t}{A_t} \\right| \\times 100\\% = 6.8\\%\n\n\\text{Prediction Intervals:}\n\n80\\% \\text{ CI: } \\hat{y} \\pm 1.28 \\times \\sigma_{forecast}\n\n95\\% \\text{ CI: } \\hat{y} \\pm 1.96 \\times \\sigma_{forecast}\n\n\\text{Where } \\sigma_{forecast} = \\sqrt{\\sigma_{model}^2 + \\sigma_{residual}^2}\n\n\\text{Ensemble Variance:}\n\n\\text{Var}(\\hat{y}_{ensemble}) = \\sum_{i=1}^{3} w_i^2 \\text{Var}(\\hat{y}_i) + 2\\sum_{i<j} w_i w_j \\text{Cov}(\\hat{y}_i, \\hat{y}_j)' },

                        { id: 'sf13', type: 'divider', content: '', dividerType: 'page' },

                        { id: 'sf14', type: 'header', level: 2, content: 'Risk Factors & Scenario Analysis' },
                        { id: 'sf15', type: 'markdown', content: '**Economic Risk Factors:**\n\n🔴 **High Risk:**\n- [ ] Recession indicators (yield curve inversion)\n- [ ] Inflation above 4% (current: 3.2%)\n- [ ] Consumer confidence below 90 (current: 98.4)\n\n🟡 **Medium Risk:**\n- [ ] Supply chain disruptions (geopolitical)\n- [ ] Competitive product launches\n- [ ] Seasonal demand shifts due to weather\n\n🟢 **Low Risk:**\n- [ ] Interest rate changes (gradual adjustments expected)\n- [ ] Currency fluctuations (hedging in place)\n- [ ] Technology platform issues (robust infrastructure)\n\n**Scenario Planning:**\n\n- **Bull Case (+15%):** Strong consumer spending, successful product launches\n- **Base Case (0%):** Current economic trajectory continues\n- **Bear Case (-12%):** Economic slowdown, reduced consumer spending' },

                        { id: 'sf16', type: 'header', level: 2, content: 'Model Monitoring & Updates' },
                        { id: 'sf17', type: 'table', content: 'Monitoring Metric,Current Value,Alert Threshold,Action Required\nWeekly MAPE,7.2%,>10%,Retrain ensemble weights\nResidual Autocorrelation,0.08,>0.20,Add lag features or seasonal terms\nFeature Importance Drift,3.4%,>15%,Update feature engineering pipeline\nPrediction Bias,-1.8%,±5%,Adjust model calibration\nData Quality Score,94.2%,<90%,Investigate data pipeline issues\nModel Staleness,12 days,>30 days,Schedule model refresh' },

                        { id: 'sf18', type: 'header', level: 2, content: 'Business Recommendations' },
                        { id: 'sf19', type: 'text', content: 'Q1 2026 forecast of $8.41M represents 7.3% YoY growth, slightly below company target of 10%. Recommend increasing marketing spend in March (+$150K) to capitalize on spring demand surge. Monitor January performance closely as economic headwinds may impact consumer discretionary spending. Model suggests 73% probability of meeting quarterly revenue target of $8.2M.' }
                    ]
                }
            ];

            // Save persona-specific documents to localStorage
            localStorage.setItem('retailManagerDocuments', JSON.stringify(retailManagerDocuments));
            localStorage.setItem('researchChemistDocuments', JSON.stringify(researchChemistDocuments));
            localStorage.setItem('newGraduateDocuments', JSON.stringify(newGraduateDocuments));
            localStorage.setItem('dataAnalystDocuments', JSON.stringify(dataAnalystDocuments));
        }

        // Documents Slideout Functions
        function openDocumentsSlideout() {
            const slideout = document.getElementById('interviewSlideout');
            const titleEl = document.getElementById('slideoutTitle');

            titleEl.textContent = 'Documents';

            // Hide all content sections
            hideAllContentSections();

            // Show documents content
            document.getElementById('documentsContent').style.display = 'block';
            loadDocuments();

            slideout.classList.add('active');
        }

        function loadDocuments() {
            const container = document.getElementById('documentsContainer');
            container.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 16px;';

            // Get persona-specific documents
            const personaStorageKeys = {
                'retail-manager': 'retailManagerDocuments',
                'chemist': 'researchChemistDocuments',
                'new-graduate': 'newGraduateDocuments',
                'data-analyst': 'dataAnalystDocuments'
            };

            const storageKey = personaStorageKeys[currentPersona] || 'retailManagerDocuments';
            const documents = JSON.parse(localStorage.getItem(storageKey) || '[]');

            if (documents.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: var(--color-neutral-text);"><i class="ph ph-file-text" style="font-size: 48px; color: var(--color-neutral-border); display: block; margin-bottom: 12px;"></i>No documents yet. Click "+ New Document" to create one.</div>';
                return;
            }

            container.innerHTML = '';
            documents.forEach((doc, index) => {
                const card = createDocumentCard(doc, index);
                container.appendChild(card);
            });
        }

        function createDocumentCard(doc, index) {
            const card = document.createElement('div');
            card.style.cssText = 'padding: 20px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px;';

            const lastModified = new Date(doc.lastModified).toLocaleDateString();
            const isStructured = doc.documentType === 'structured' || doc.blocks;
            const isUnstructured = doc.documentType === 'unstructured' || doc.richTextContent;

            let wordCount = 0;
            let charCount = 0;
            let blockCount = 0;
            const blockTypes = {};

            if (isUnstructured) {
                // Calculate word and character counts from rich text
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = doc.richTextContent || '';
                const text = tempDiv.textContent || '';
                wordCount = text.trim().split(/\s+/).filter(w => w.length > 0).length;
                charCount = text.length;
            } else {
                // Count blocks for structured documents
                blockCount = doc.blocks ? doc.blocks.length : 0;
                if (doc.blocks) {
                    doc.blocks.forEach(block => {
                        blockTypes[block.type] = (blockTypes[block.type] || 0) + 1;
                        // Also count words from text blocks
                        if (block.type === 'text' || block.type === 'header') {
                            const text = block.content || '';
                            wordCount += text.trim().split(/\s+/).filter(w => w.length > 0).length;
                        }
                    });
                }
            }

            // Calculate reading time (200 words per minute)
            const readingTime = Math.max(1, Math.ceil(wordCount / 200));

            // Determine icon based on content type
            let icon = 'ph-file-text';
            if (isUnstructured) {
                icon = 'ph-article';
            } else if (blockTypes.code || blockTypes.markdown) {
                icon = 'ph-code';
            } else if (blockTypes.image) {
                icon = 'ph-file-image';
            } else if (blockTypes.table) {
                icon = 'ph-table';
            }

            card.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="ph ${icon}" style="font-size: 24px; color: var(--color-primary-blue);"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">${escapeHtml(doc.title || 'Untitled Document')}</div>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button onclick="event.stopPropagation(); openDocumentEditor(${index})" title="Edit" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-pencil-simple" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteDocument(${index})" title="Delete" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-trash" style="font-size: 16px; color: #dc2626;"></i>
                        </button>
                        <button onclick="event.stopPropagation(); shareDocument(${index})" title="Share" style="padding: 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--color-primary-blue)'; this.style.background='#e3f2fd';" onmouseout="this.style.borderColor='var(--color-neutral-border)'; this.style.background='white';">
                            <i class="ph ph-share-network" style="font-size: 16px; color: var(--color-primary-blue);"></i>
                        </button>
                    </div>
                </div>
                <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); line-height: 1.5;">
                    ${getDocumentPreview(doc)}
                </div>
                <div style="margin-top: 4px;">
                    <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); text-transform: uppercase; margin-bottom: 8px;">
                        ${isUnstructured ? 'Statistics' : 'Content'}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${isUnstructured ? `
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${wordCount.toLocaleString()} Words</span>
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${charCount.toLocaleString()} Characters</span>
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);"><i class="ph ph-clock" style="margin-right: 2px;"></i>${readingTime} min read</span>
                        ` : `
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockCount} Block${blockCount !== 1 ? 's' : ''}</span>
                            ${blockTypes.header ? `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockTypes.header} Section${blockTypes.header !== 1 ? 's' : ''}</span>` : ''}
                            ${blockTypes.image ? `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockTypes.image} Image${blockTypes.image !== 1 ? 's' : ''}</span>` : ''}
                            ${blockTypes.code ? `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockTypes.code} Code</span>` : ''}
                            ${blockTypes.table ? `<span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);">${blockTypes.table} Table${blockTypes.table !== 1 ? 's' : ''}</span>` : ''}
                            <span style="padding: 4px 8px; background: #f5f5f7; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);"><i class="ph ph-clock" style="margin-right: 2px;"></i>${readingTime} min read</span>
                        `}
                    </div>
                </div>
                ${doc.sharedWith && doc.sharedWith.length > 0 ? `
                    <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                        <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">SHARED WITH</div>
                        <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                            ${doc.sharedWith.map(initials => `
                                <div style="width: 28px; height: 28px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: var(--color-primary-blue); font-family: var(--font-family-ui);">${initials}</div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-neutral-border);">
                    <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px;">LAST MODIFIED</div>
                    <div style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">
                        <i class="ph ph-calendar-blank" style="margin-right: 4px;"></i>
                        ${lastModified}
                    </div>
                </div>
            `;

            card.addEventListener('mouseenter', () => {
                card.style.borderColor = 'var(--color-primary-blue)';
                card.style.boxShadow = '0 2px 8px rgba(0, 102, 204, 0.15)';
            });

            card.addEventListener('mouseleave', () => {
                card.style.borderColor = 'var(--color-neutral-border)';
                card.style.boxShadow = 'none';
            });

            card.addEventListener('click', () => {
                openDocumentEditor(index);
            });

            return card;
        }

        function getDocumentPreview(doc) {
            // Handle unstructured documents
            if (doc.documentType === 'unstructured' || doc.richTextContent) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = doc.richTextContent || '';
                const text = tempDiv.textContent || '';
                const preview = text.trim().substring(0, 150);
                return escapeHtml(preview) + (text.length > 150 ? '...' : '');
            }

            // Handle structured documents
            if (!doc.blocks || doc.blocks.length === 0) return 'Empty document';

            // Find first text or header block for preview
            const previewBlock = doc.blocks.find(b => b.type === 'text' || b.type === 'header');
            if (previewBlock && previewBlock.content) {
                const preview = previewBlock.content.substring(0, 150);
                return escapeHtml(preview) + (previewBlock.content.length > 150 ? '...' : '');
            }

            return `Document contains ${doc.blocks.length} block${doc.blocks.length !== 1 ? 's' : ''}`;
        }

        function shareDocument(index) {
            alert('Share functionality coming soon!\n\nYou will be able to:\n• Export as PDF\n• Share via email\n• Generate shareable link');
        }

        // Document Editor Functions
        let currentDocumentIndex = null;
        let currentDocumentBlocks = [];
        let currentBlockId = 0;

        let quillEditor = null;
        let currentDocumentView = 'structured'; // 'structured' or 'unstructured'

        function openDocumentEditor(documentIndex = null) {
            currentDocumentIndex = documentIndex;
            openModal('documentEditorModal');
        }

        function initializeQuillEditor() {
            if (quillEditor) {
                quillEditor = null;
            }

            const editorContainer = document.getElementById('quillEditor');
            editorContainer.innerHTML = ''; // Clear previous instance

            quillEditor = new Quill('#quillEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, 4, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'align': [] }],
                        ['link', 'image', 'code-block'],
                        ['clean']
                    ]
                },
                placeholder: 'Start writing your document...'
            });
        }

        function toggleDocumentView(view) {
            currentDocumentView = view;

            const structuredView = document.getElementById('structuredView');
            const unstructuredView = document.getElementById('unstructuredView');
            const structuredBtn = document.getElementById('structuredViewBtn');
            const unstructuredBtn = document.getElementById('unstructuredViewBtn');

            if (view === 'structured') {
                // Show structured view
                structuredView.style.display = 'flex';
                unstructuredView.style.display = 'none';

                // Update button styles
                structuredBtn.style.background = 'var(--color-primary-blue)';
                structuredBtn.style.color = 'white';
                unstructuredBtn.style.background = 'transparent';
                unstructuredBtn.style.color = 'var(--color-dark)';

                // Sync from Quill to blocks if switching from unstructured
                if (quillEditor) {
                    syncQuillToBlocks();
                }
            } else {
                // Show unstructured view
                structuredView.style.display = 'none';
                unstructuredView.style.display = 'flex';

                // Update button styles
                structuredBtn.style.background = 'transparent';
                structuredBtn.style.color = 'var(--color-dark)';
                unstructuredBtn.style.background = 'var(--color-primary-blue)';
                unstructuredBtn.style.color = 'white';

                // Sync from blocks to Quill if switching from structured
                syncBlocksToQuill();
            }
        }

        function syncBlocksToQuill() {
            if (!quillEditor) return;

            let html = '';

            // Process blocks in hierarchical order
            currentDocumentBlocks.forEach((block, index) => {
                switch (block.type) {
                    case 'header':
                        // Add spacing before headers (except first element)
                        if (index > 0) {
                            html += '<br>';
                        }
                        html += `<h${block.level}>${escapeHtml(block.content || '')}</h${block.level}>`;
                        break;

                    case 'text':
                        // Split text into paragraphs and clean up
                        const paragraphs = (block.content || '').split('\n').filter(p => p.trim());
                        paragraphs.forEach(para => {
                            // Check if it's a bullet point
                            if (para.trim().startsWith('•') || para.trim().startsWith('*')) {
                                html += `<li>${escapeHtml(para.replace(/^[•*]\s*/, ''))}</li>`;
                            } else {
                                html += `<p>${escapeHtml(para)}</p>`;
                            }
                        });
                        break;

                    case 'image':
                        if (block.content) {
                            html += `<p><img src="${block.content}" style="max-width: 100%; height: auto; display: block; margin: 12px 0;"></p>`;
                        }
                        break;

                    case 'code':
                        html += `<pre>${escapeHtml(block.content || '')}</pre>`;
                        break;

                    case 'table':
                        // Convert CSV-like table data to actual table
                        const tableContent = block.content || '';
                        if (tableContent.trim()) {
                            const rows = tableContent.split('\n').filter(r => r.trim());
                            if (rows.length > 0) {
                                html += '<table style="border-collapse: collapse; width: 100%; margin: 12px 0;">';
                                rows.forEach((row, rowIndex) => {
                                    const cells = row.split(',');
                                    html += '<tr>';
                                    cells.forEach(cell => {
                                        const tag = rowIndex === 0 ? 'th' : 'td';
                                        html += `<${tag} style="border: 1px solid #ddd; padding: 8px;">${escapeHtml(cell.trim())}</${tag}>`;
                                    });
                                    html += '</tr>';
                                });
                                html += '</table>';
                            }
                        }
                        break;

                    case 'markdown':
                    case 'latex':
                    case 'mermaid':
                        // Show these as formatted pre blocks with labels
                        const typeLabels = {
                            'markdown': 'Markdown Content',
                            'latex': 'KaTeX Math',
                            'mermaid': 'Mermaid Diagram'
                        };
                        html += `<p><em>${typeLabels[block.type]}:</em></p>`;
                        html += `<pre>${escapeHtml(block.content || '')}</pre>`;
                        break;
                }
            });

            const delta = quillEditor.clipboard.convert(html);
            quillEditor.setContents(delta);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function syncQuillToBlocks() {
            if (!quillEditor) return;

            // Convert Quill content to blocks
            const delta = quillEditor.getContents();
            const newBlocks = [];
            let currentTextBlock = null;

            delta.ops.forEach(op => {
                if (op.insert) {
                    if (typeof op.insert === 'string') {
                        const text = op.insert;

                        if (op.attributes && op.attributes.header) {
                            // Header block
                            const level = op.attributes.header;
                            newBlocks.push({
                                id: `block-${Date.now()}-${Math.random()}`,
                                type: 'header',
                                level: level,
                                content: text.trim()
                            });
                            currentTextBlock = null;
                        } else if (op.attributes && op.attributes['code-block']) {
                            // Code block
                            newBlocks.push({
                                id: `block-${Date.now()}-${Math.random()}`,
                                type: 'code',
                                language: 'javascript',
                                content: text
                            });
                            currentTextBlock = null;
                        } else {
                            // Regular text
                            if (!currentTextBlock) {
                                currentTextBlock = {
                                    id: `block-${Date.now()}-${Math.random()}`,
                                    type: 'text',
                                    content: ''
                                };
                                newBlocks.push(currentTextBlock);
                            }
                            currentTextBlock.content += text;
                        }
                    } else if (op.insert.image) {
                        // Image block
                        newBlocks.push({
                            id: `block-${Date.now()}-${Math.random()}`,
                            type: 'image',
                            content: op.insert.image
                        });
                        currentTextBlock = null;
                    }
                }
            });

            currentDocumentBlocks = newBlocks;
            renderDocumentBlocks();
        }

        function closeProfessionalDocumentEditor() {
            closeModal('documentEditorModal');
            currentDocumentIndex = null;
            currentDocumentBlocks = [];
        }

        function addBlock(type) {
            const blockId = `block-${Date.now()}-${currentBlockId++}`;
            const block = {
                id: blockId,
                type: type,
                content: '',
                level: type === 'header' ? 1 : null,
                language: type === 'code' ? 'javascript' : null
            };

            currentDocumentBlocks.push(block);
            renderDocumentBlocks();
        }

        function renderDocumentBlocks() {
            const container = document.getElementById('documentBlocks');
            container.innerHTML = '';

            if (currentDocumentBlocks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--color-neutral-text); padding: 60px 20px;"><i class="ph ph-cursor-text" style="font-size: 48px; color: var(--color-neutral-border); margin-bottom: 16px;"></i><p style="font-family: var(--font-family-body); font-size: 14px;">Click a block type to start building your document</p></div>';
                return;
            }

            // Build hierarchical structure
            let i = 0;
            while (i < currentDocumentBlocks.length) {
                const block = currentDocumentBlocks[i];
                if (block.type === 'header') {
                    // Find all children (blocks until next header of same or higher level)
                    const children = [];
                    let j = i + 1;
                    while (j < currentDocumentBlocks.length) {
                        const nextBlock = currentDocumentBlocks[j];
                        if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                            break; // Found a header at same or higher level
                        }
                        children.push({ block: nextBlock, index: j });
                        j++;
                    }

                    // Create header container with children
                    const headerContainer = createHeaderContainer(block, i, children);
                    container.appendChild(headerContainer);
                    i = j; // Skip to next section
                } else {
                    // Orphan block (not under a header)
                    const blockEl = createBlockElement(block, i);
                    container.appendChild(blockEl);
                    i++;
                }
            }
        }

        function createHeaderContainer(headerBlock, headerIndex, children) {
            const container = document.createElement('div');
            container.style.cssText = 'margin-bottom: 20px; border: 2px solid var(--color-neutral-border); border-radius: 8px; overflow: hidden;';

            // Determine container background based on level
            const levelColors = {
                1: '#e3f2fd', // Light blue for H1
                2: '#f3e5f5', // Light purple for H2
                3: '#fff3e0', // Light orange for H3
                4: '#f1f8e9'  // Light green for H4
            };
            const bgColor = levelColors[headerBlock.level] || '#f5f5f5';

            // Header section with controls
            const headerSection = document.createElement('div');
            headerSection.style.cssText = `background: ${bgColor}; padding: 16px; border-bottom: 1px solid var(--color-neutral-border);`;

            headerSection.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="flex: 1;">
                        <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <select onchange="updateBlockLevel(${headerIndex}, this.value)" style="padding: 6px 10px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 13px; font-weight: 600; background: white;">
                                <option value="1" ${headerBlock.level === 1 ? 'selected' : ''}>H1</option>
                                <option value="2" ${headerBlock.level === 2 ? 'selected' : ''}>H2</option>
                                <option value="3" ${headerBlock.level === 3 ? 'selected' : ''}>H3</option>
                                <option value="4" ${headerBlock.level === 4 ? 'selected' : ''}>H4</option>
                            </select>
                            <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); text-transform: uppercase; letter-spacing: 0.5px;">${children.length} block${children.length !== 1 ? 's' : ''} in section</span>
                        </div>
                        <input type="text" value="${headerBlock.content || ''}" onchange="updateBlockContent(${headerIndex}, this.value)" placeholder="Enter header text..." style="width: 100%; border: none; font-family: var(--font-family-ui); font-size: ${28 - (headerBlock.level * 4)}px; font-weight: 600; color: var(--color-dark); outline: none; background: transparent;">
                    </div>
                    <div style="display: flex; gap: 4px;">
                        <button onclick="moveBlockUp(${headerIndex})" ${headerIndex === 0 ? 'disabled' : ''} style="padding: 6px 10px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; font-size: 14px;" title="Move section up">
                            <i class="ph ph-arrow-up"></i>
                        </button>
                        <button onclick="moveBlockDown(${headerIndex})" style="padding: 6px 10px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; font-size: 14px;" title="Move section down">
                            <i class="ph ph-arrow-down"></i>
                        </button>
                        <button onclick="deleteBlock(${headerIndex})" style="padding: 6px 10px; background: white; border: 1px solid #d32f2f; color: #d32f2f; border-radius: 4px; cursor: pointer; font-size: 14px;" title="Delete section">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(headerSection);

            // Children container
            if (children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.style.cssText = 'padding: 16px; background: white;';

                children.forEach(({ block, index }) => {
                    const childEl = createBlockElement(block, index, true);
                    childrenContainer.appendChild(childEl);
                });

                container.appendChild(childrenContainer);
            }

            return container;
        }

        function createBlockElement(block, index, isChild = false) {
            const blockEl = document.createElement('div');
            blockEl.className = 'document-block';
            blockEl.style.cssText = 'position: relative; margin-bottom: 20px; padding: 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white;';

            let contentHTML = '';

            switch (block.type) {
                case 'text':
                    contentHTML = `
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter text (supports rich formatting)..." style="width: 100%; min-height: 150px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: var(--font-family-body); font-size: 14px; color: var(--color-dark); resize: vertical; outline: none; line-height: 1.6;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'table':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-table"></i> Table editor (coming soon)
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter table data (CSV format)..." style="width: 100%; min-height: 120px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 12px; resize: vertical; line-height: 1.5;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'image':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-image"></i> Image
                        </div>
                        <input type="text" value="${block.content || ''}" onchange="updateBlockContent(${index}, this.value)" placeholder="Enter image URL..." style="width: 100%; padding: 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-body); font-size: 13px;">
                        ${block.content ? `<img src="${block.content}" style="max-width: 100%; margin-top: 12px; border-radius: 4px;" onerror="this.style.display='none'">` : ''}
                    `;
                    break;

                case 'markdown':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-markdown-logo"></i> Markdown (with LaTeX support)
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter markdown content (LaTeX: $inline$ or $$block$$)..." style="width: 100%; min-height: 180px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 12px; resize: vertical; line-height: 1.6;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'latex':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-function"></i> KaTeX Math
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter KaTeX math expressions...\n\nExamples:\n$inline: a^2 + b^2 = c^2$\n$$display block: \\int_0^\\infty e^{-x^2} dx = \\frac{\\sqrt{\\pi}}{2}$$" style="width: 100%; min-height: 180px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 12px; resize: vertical; line-height: 1.6;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'mermaid':
                    contentHTML = `
                        <div style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin-bottom: 8px;">
                            <i class="ph ph-flow-arrow"></i> Mermaid Diagram
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter Mermaid syntax..." style="width: 100%; min-height: 180px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 12px; resize: vertical; line-height: 1.6;">${block.content || 'graph TD\n    A[Start] --> B[Process]\n    B --> C[End]'}</textarea>
                    `;
                    break;

                case 'code':
                    contentHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <i class="ph ph-code" style="color: var(--color-neutral-text);"></i>
                            <select onchange="updateBlockLanguage(${index}, this.value)" style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 12px;">
                                <option value="javascript" ${block.language === 'javascript' ? 'selected' : ''}>JavaScript</option>
                                <option value="python" ${block.language === 'python' ? 'selected' : ''}>Python</option>
                                <option value="java" ${block.language === 'java' ? 'selected' : ''}>Java</option>
                                <option value="csharp" ${block.language === 'csharp' ? 'selected' : ''}>C#</option>
                                <option value="cpp" ${block.language === 'cpp' ? 'selected' : ''}>C++</option>
                                <option value="sql" ${block.language === 'sql' ? 'selected' : ''}>SQL</option>
                                <option value="html" ${block.language === 'html' ? 'selected' : ''}>HTML</option>
                                <option value="css" ${block.language === 'css' ? 'selected' : ''}>CSS</option>
                            </select>
                            <span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">Code block (with linting)</span>
                        </div>
                        <textarea onchange="updateBlockContent(${index}, this.value)" placeholder="Enter code..." style="width: 100%; min-height: 220px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 13px; background: #f8f8f8; resize: vertical; line-height: 1.6;">${block.content || ''}</textarea>
                    `;
                    break;

                case 'divider':
                    const dividerType = block.dividerType || 'visual';
                    const isPageDivider = dividerType === 'page';
                    contentHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <i class="ph ph-minus" style="color: var(--color-neutral-text);"></i>
                            <select onchange="updateBlockDividerType(${index}, this.value)" style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 12px;">
                                <option value="visual" ${dividerType === 'visual' ? 'selected' : ''}>Visual Divider</option>
                                <option value="page" ${dividerType === 'page' ? 'selected' : ''}>Page Divider</option>
                            </select>
                            <span style="font-family: var(--font-family-body); font-size: 12px; color: var(--color-neutral-text);">
                                ${isPageDivider ? 'Creates a page break in exports' : 'Visual separator only'}
                            </span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${isPageDivider ?
                                `<div style="flex: 1; height: 3px; background: repeating-linear-gradient(45deg, var(--color-primary-blue), var(--color-primary-blue) 8px, transparent 8px, transparent 16px); border-radius: 1px;"></div>
                                 <div style="background: var(--color-primary-blue); color: white; padding: 4px 8px; border-radius: 12px; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; text-transform: uppercase;">PAGE BREAK</div>
                                 <div style="flex: 1; height: 3px; background: repeating-linear-gradient(45deg, var(--color-primary-blue), var(--color-primary-blue) 8px, transparent 8px, transparent 16px); border-radius: 1px;"></div>` :
                                `<div style="flex: 1; height: 2px; background: var(--color-neutral-border); border-radius: 1px;"></div>`
                            }
                        </div>
                    `;
                    break;
            }

            blockEl.innerHTML = `
                <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                    ${!isChild ? `
                        <button onclick="moveBlockUp(${index})" ${index === 0 ? 'disabled' : ''} style="padding: 4px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; font-size: 14px;" title="Move up">
                            <i class="ph ph-arrow-up"></i>
                        </button>
                        <button onclick="moveBlockDown(${index})" ${index === currentDocumentBlocks.length - 1 ? 'disabled' : ''} style="padding: 4px 8px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 4px; cursor: pointer; font-size: 14px;" title="Move down">
                            <i class="ph ph-arrow-down"></i>
                        </button>
                    ` : ''}
                    <button onclick="deleteBlock(${index})" style="padding: 4px 8px; background: white; border: 1px solid #d32f2f; color: #d32f2f; border-radius: 4px; cursor: pointer; font-size: 14px;" title="Delete block">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
                ${contentHTML}
            `;

            return blockEl;
        }

        function updateBlockContent(index, content) {
            currentDocumentBlocks[index].content = content;
        }

        function updateBlockLevel(index, level) {
            currentDocumentBlocks[index].level = parseInt(level);
            renderDocumentBlocks();
        }

        function updateBlockLanguage(index, language) {
            currentDocumentBlocks[index].language = language;
        }

        function updateBlockDividerType(index, dividerType) {
            currentDocumentBlocks[index].dividerType = dividerType;
            renderDocumentBlocks();
        }

        function moveBlockUp(index) {
            const block = currentDocumentBlocks[index];

            if (block.type === 'header') {
                // Moving a section - find all its children
                const children = [];
                let j = index + 1;
                while (j < currentDocumentBlocks.length) {
                    const nextBlock = currentDocumentBlocks[j];
                    if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                        break;
                    }
                    children.push(nextBlock);
                    j++;
                }

                const sectionLength = 1 + children.length; // header + children

                if (index === 0) return; // Can't move first section up

                // Find the previous section
                let prevSectionStart = index - 1;
                while (prevSectionStart > 0 && currentDocumentBlocks[prevSectionStart].type !== 'header') {
                    prevSectionStart--;
                }

                // Extract current section
                const section = currentDocumentBlocks.splice(index, sectionLength);

                // Insert before previous section
                currentDocumentBlocks.splice(prevSectionStart, 0, ...section);
            } else {
                // Moving a non-header block
                if (index > 0) {
                    [currentDocumentBlocks[index - 1], currentDocumentBlocks[index]] = [currentDocumentBlocks[index], currentDocumentBlocks[index - 1]];
                }
            }

            renderDocumentBlocks();
        }

        function moveBlockDown(index) {
            const block = currentDocumentBlocks[index];

            if (block.type === 'header') {
                // Moving a section - find all its children
                const children = [];
                let j = index + 1;
                while (j < currentDocumentBlocks.length) {
                    const nextBlock = currentDocumentBlocks[j];
                    if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                        break;
                    }
                    children.push(nextBlock);
                    j++;
                }

                const sectionLength = 1 + children.length;
                const sectionEnd = index + sectionLength;

                if (sectionEnd >= currentDocumentBlocks.length) return; // Can't move last section down

                // Find the next section
                let nextSectionEnd = sectionEnd + 1;
                while (nextSectionEnd < currentDocumentBlocks.length) {
                    const nextBlock = currentDocumentBlocks[nextSectionEnd];
                    if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                        break;
                    }
                    nextSectionEnd++;
                }

                // Extract current section
                const section = currentDocumentBlocks.splice(index, sectionLength);

                // Insert after next section
                const insertPos = Math.min(nextSectionEnd - sectionLength, currentDocumentBlocks.length);
                currentDocumentBlocks.splice(insertPos, 0, ...section);
            } else {
                // Moving a non-header block
                if (index < currentDocumentBlocks.length - 1) {
                    [currentDocumentBlocks[index], currentDocumentBlocks[index + 1]] = [currentDocumentBlocks[index + 1], currentDocumentBlocks[index]];
                }
            }

            renderDocumentBlocks();
        }

        function deleteBlock(index) {
            const block = currentDocumentBlocks[index];

            if (block.type === 'header') {
                // Deleting a section - find all its children
                const children = [];
                let j = index + 1;
                while (j < currentDocumentBlocks.length) {
                    const nextBlock = currentDocumentBlocks[j];
                    if (nextBlock.type === 'header' && nextBlock.level <= block.level) {
                        break;
                    }
                    children.push(nextBlock);
                    j++;
                }

                const sectionLength = 1 + children.length;
                const message = children.length > 0
                    ? `Delete this section and its ${children.length} child block${children.length !== 1 ? 's' : ''}?`
                    : 'Delete this header?';

                if (confirm(message)) {
                    currentDocumentBlocks.splice(index, sectionLength);
                    renderDocumentBlocks();
                }
            } else {
                // Deleting a regular block
                if (confirm('Delete this block?')) {
                    currentDocumentBlocks.splice(index, 1);
                    renderDocumentBlocks();
                }
            }
        }

        function toggleWorkBreakdownNumbering() {
            const enabled = document.getElementById('wbnToggle').checked;
            alert(`Work Breakdown Numbering ${enabled ? 'enabled' : 'disabled'}. This feature will automatically number headers in the exported document.`);
        }

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function exportDocument(format) {
            const title = document.getElementById('docTitle').value || 'Untitled Document';
            toggleExportMenu();
            alert(`Export to ${format.toUpperCase()} coming soon!\n\nDocument: ${title}\nBlocks: ${currentDocumentBlocks.length}`);
        }

        function saveDocument() {
            // TODO: Implement save functionality after modal content is populated
            alert('Document saved!');
            closeProfessionalDocumentEditor();
        }

        function shareDocument() {
            // Nonfunctional placeholder for sharing entire document
            const docTitle = document.getElementById('docTitle').value || 'Untitled Document';
            alert(`Sharing functionality coming soon!\n\nThis will allow you to share "${docTitle}" with others.`);
        }

        function editDocument(index) {
            openDocumentEditor(index);
        }

        function deleteDocument(index) {
            if (confirm('Are you sure you want to delete this document?')) {
                const documents = JSON.parse(localStorage.getItem('professionalDocuments') || '[]');
                documents.splice(index, 1);
                localStorage.setItem('professionalDocuments', JSON.stringify(documents));
                loadDocuments();
            }
        }

        // Close export menu when clicking outside
        document.addEventListener('click', function(event) {
            const exportMenu = document.getElementById('exportMenu');
            if (exportMenu && !event.target.closest('[onclick*="toggleExportMenu"]') && !event.target.closest('#exportMenu')) {
                exportMenu.style.display = 'none';
            }
        });

        function loadNotesCards(searchTerm = '') {
            const container = document.getElementById('notesContainer');

            let filteredNotes = userNotes;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredNotes = userNotes.filter(note =>
                    note.title.toLowerCase().includes(term) ||
                    note.content.toLowerCase().includes(term) ||
                    (note.tags && note.tags.toLowerCase().includes(term))
                );
            }

            if (filteredNotes.length === 0) {
                const message = searchTerm
                    ? `<p style="color: #666; text-align: center; padding: 40px 20px; grid-column: 1/-1;">No notes found matching "${searchTerm}"</p>`
                    : '<p style="color: #666; text-align: center; padding: 40px 20px; grid-column: 1/-1;">No notes yet. Click Add Note to create your first note.</p>';
                container.innerHTML = message;
                return;
            }

            container.innerHTML = filteredNotes.map((note, index) => {
                const actualIndex = userNotes.indexOf(note);
                const categoryStyle = categoryColors[note.category] || categoryColors['general'];
                const tags = note.tags ? note.tags.split(',').map(t => t.trim()).filter(t => t) : [];
                const contentPreview = note.content.length > 200 ? note.content.substring(0, 200) + '...' : note.content;

                return `
                    <div class="story-card" style="cursor: default; border-left: 4px solid ${categoryStyle.color};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="background: ${categoryStyle.bg}; color: ${categoryStyle.color}; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                        <i class="${categoryStyle.icon}" style="font-size: 14px;"></i>
                                        ${note.category.charAt(0).toUpperCase() + note.category.slice(1)}
                                    </span>
                                    <span style="color: #999; font-size: 11px;">${note.date}</span>
                                </div>
                                <h4 style="margin: 0 0 12px 0; color: #1a1a1a; font-size: 16px; font-weight: 600;">${note.title}</h4>
                                <p style="margin: 0 0 12px 0; color: #666; font-size: 13px; line-height: 1.6; white-space: pre-wrap;">
                                    ${contentPreview}
                                </p>
                                ${tags.length > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${tags.map(tag => `
                                            <span style="background: #f5f5f5; color: #666; padding: 3px 8px; border-radius: 10px; font-size: 10px;">
                                                #${tag}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px; margin-left: 12px;">
                                <button onclick="editNote(${actualIndex})" style="padding: 6px 10px; background: #f5f5f7; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #666; font-weight: 600;">
                                    <i class="ph ph-pencil"></i> Edit
                                </button>
                                <button onclick="deleteNote(${actualIndex})" style="padding: 6px 10px; background: #fee; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; color: #c33; font-weight: 600;">
                                    <i class="ph ph-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchNotes() {
            const searchTerm = document.getElementById('notesSearchInput').value;
            loadNotesCards(searchTerm);
        }

        function addNote() {
            document.getElementById('noteFormModal').classList.add('active');
            document.getElementById('noteForm').reset();
            document.getElementById('noteFormTitle').textContent = 'Add Note';
            document.getElementById('noteForm').dataset.editIndex = '';
        }

        function editNote(index) {
            const note = userNotes[index];
            document.getElementById('noteFormModal').classList.add('active');
            document.getElementById('noteFormTitle').textContent = 'Edit Note';

            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteCategory').value = note.category;
            document.getElementById('noteTags').value = note.tags || '';
            document.getElementById('noteContent').value = note.content;

            document.getElementById('noteForm').dataset.editIndex = index;
        }

        function closeNoteForm() {
            document.getElementById('noteFormModal').classList.remove('active');
        }

        function saveNote(event) {
            event.preventDefault();

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            const noteData = {
                title: document.getElementById('noteTitle').value,
                category: document.getElementById('noteCategory').value,
                tags: document.getElementById('noteTags').value,
                content: document.getElementById('noteContent').value,
                date: dateStr,
                timestamp: now.getTime()
            };

            const editIndex = document.getElementById('noteForm').dataset.editIndex;

            if (editIndex !== '') {
                noteData.date = userNotes[parseInt(editIndex)].date; // Keep original date
                noteData.editedDate = dateStr; // Track edit date
                userNotes[parseInt(editIndex)] = noteData;
            } else {
                userNotes.unshift(noteData); // Add to beginning (most recent first)
            }

            saveUserNotes();
            loadNotesCards();
            updateBadgesOnly();
            closeNoteForm();
        }

        function deleteNote(index) {
            if (confirm('Are you sure you want to delete this note?')) {
                userNotes.splice(index, 1);
                saveUserNotes();
                loadNotesCards();
                updateBadgesOnly();
            }
        }

        // Skills & Competencies Management
        let userSkillsCompetencies = [];

        function loadUserSkillsCompetencies() {
            const stored = localStorage.getItem(`skillsCompetencies_${currentPersona}`);
            userSkillsCompetencies = stored ? JSON.parse(stored) : [];
        }

        function saveUserSkillsCompetencies() {
            localStorage.setItem(`skillsCompetencies_${currentPersona}`, JSON.stringify(userSkillsCompetencies));
        }

        function openSkillsCompetenciesSlideout() {
            loadUserSkillsCompetencies();
            animateSlideoutTransition(() => {
                const titleEl = document.getElementById('slideoutTitle');
                const skillsCompetenciesContent = document.getElementById('skillsCompetenciesContent');

                titleEl.textContent = 'Goals';

                // Hide all content sections
                hideAllContentSections();

                // Show skills content
                skillsCompetenciesContent.style.display = 'flex';
                loadSkillsCompetencies();
            });
        }

        // Example goals data with realistic current levels and improvement areas per persona
        const exampleGoalsData = {
            'retail-manager': {
                improvementGoals: ['Python Programming', 'Power BI Advanced Features', 'SQL Query Optimization'],
                skills: [
                    { name: 'Excel', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Power BI', currentLevel: 2, desiredLevel: 4 },
                    { name: 'SQL', currentLevel: 2, desiredLevel: 4 },
                    { name: 'Python', currentLevel: 1, desiredLevel: 3 },
                    { name: 'Data Analysis', currentLevel: 3, desiredLevel: 4 }
                ],
                competencies: [
                    { name: 'Leadership', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Operations Management', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Problem Solving', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Communication', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Strategic Thinking', currentLevel: 2, desiredLevel: 4 }
                ]
            },
            'field-engineer': {
                improvementGoals: ['Azure Cloud Architecture', 'Kubernetes', 'Infrastructure as Code'],
                skills: [
                    { name: 'Networking', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Windows Server', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Active Directory', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Azure', currentLevel: 2, desiredLevel: 4 },
                    { name: 'PowerShell', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Kubernetes', currentLevel: 1, desiredLevel: 3 },
                    { name: 'Terraform', currentLevel: 1, desiredLevel: 3 }
                ],
                competencies: [
                    { name: 'Technical Troubleshooting', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Customer Service', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Documentation', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Project Management', currentLevel: 2, desiredLevel: 3 },
                    { name: 'Cloud Architecture', currentLevel: 2, desiredLevel: 4 }
                ]
            },
            'business-analyst': {
                improvementGoals: ['Machine Learning Fundamentals', 'Advanced Python', 'Data Engineering'],
                skills: [
                    { name: 'SQL', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Excel', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Tableau', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Python', currentLevel: 2, desiredLevel: 4 },
                    { name: 'R', currentLevel: 2, desiredLevel: 3 },
                    { name: 'Machine Learning', currentLevel: 1, desiredLevel: 3 },
                    { name: 'Data Engineering', currentLevel: 1, desiredLevel: 3 }
                ],
                competencies: [
                    { name: 'Data Analysis', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Business Acumen', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Communication', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Statistical Analysis', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Stakeholder Management', currentLevel: 3, desiredLevel: 4 }
                ]
            },
            'devops-engineer': {
                improvementGoals: ['Security Best Practices', 'Cost Optimization', 'SRE Practices'],
                skills: [
                    { name: 'Docker', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Kubernetes', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Terraform', currentLevel: 4, desiredLevel: 4 },
                    { name: 'AWS', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Python', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Security', currentLevel: 2, desiredLevel: 4 },
                    { name: 'Cost Optimization', currentLevel: 2, desiredLevel: 4 }
                ],
                competencies: [
                    { name: 'Automation', currentLevel: 4, desiredLevel: 5 },
                    { name: 'System Design', currentLevel: 4, desiredLevel: 4 },
                    { name: 'Troubleshooting', currentLevel: 4, desiredLevel: 5 },
                    { name: 'Collaboration', currentLevel: 3, desiredLevel: 4 },
                    { name: 'Site Reliability', currentLevel: 3, desiredLevel: 4 }
                ]
            }
        };

        function extractSkillsFromExperience() {
            // Return example goals data for demo
            const goalsData = exampleGoalsData[currentPersona] || { skills: [], competencies: [], improvementGoals: [] };

            return {
                skills: goalsData.skills.map(s => ({ ...s, name: s.name, type: 'skill', fromExperience: true })),
                competencies: goalsData.competencies.map(c => ({ ...c, name: c.name, type: 'competency', fromExperience: true })),
                improvementGoals: goalsData.improvementGoals || []
            };
        }

        function loadSkillsCompetencies() {
            const container = document.getElementById('skillsCompetenciesContainer');
            const pillsContainer = document.getElementById('improvementGoalsPills');
            const extracted = extractSkillsFromExperience();

            // Display improvement goals pills
            if (extracted.improvementGoals && extracted.improvementGoals.length > 0) {
                let pillsHtml = '';
                extracted.improvementGoals.forEach(goal => {
                    pillsHtml += `<div style="background: linear-gradient(135deg, #ff9800 0%, #ff6b35 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(255, 152, 0, 0.2);">
                        <i class="ph ph-target" style="font-size: 14px;"></i>
                        ${escapeHtml(goal)}
                    </div>`;
                });
                pillsContainer.innerHTML = pillsHtml;
            } else {
                pillsContainer.innerHTML = '<p style="color: #999; font-size: 12px; margin: 0;">No improvement goals set</p>';
            }

            // Use example data directly (no user override for demo)
            const skills = extracted.skills;
            const competencies = extracted.competencies;

            if (skills.length === 0 && competencies.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px 20px;">No skills or competencies found. Add career experience or manually add skills to get started.</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">';

            // Skills column
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            html += '<h3 style="margin: 0 0 8px 0; font-size: 16px; color: #1a1a1a; font-weight: 600; border-bottom: 2px solid #0066CC; padding-bottom: 8px;">Skills</h3>';
            if (skills.length > 0) {
                skills.forEach((item, index) => {
                    html += renderSkillCompetencyCard(item, index, 'skill');
                });
            } else {
                html += '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">No skills yet</p>';
            }
            html += '</div>';

            // Competencies column
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            html += '<h3 style="margin: 0 0 8px 0; font-size: 16px; color: #1a1a1a; font-weight: 600; border-bottom: 2px solid #004C99; padding-bottom: 8px;">Competencies</h3>';
            if (competencies.length > 0) {
                competencies.forEach((item, index) => {
                    html += renderSkillCompetencyCard(item, index + skills.length, 'competency');
                });
            } else {
                html += '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">No competencies yet</p>';
            }
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;
        }

        function renderSkillCompetencyCard(item, index, type) {
            const currentLevel = item.currentLevel || 1;
            const desiredLevel = item.desiredLevel || 1;
            const gap = desiredLevel - currentLevel;
            const gapColor = gap > 0 ? '#ff9800' : gap < 0 ? '#666' : '#4caf50';

            return `
                <div style="background: white; border: 1px solid #e5e5e7; border-radius: 8px; padding: 12px; position: relative;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #1a1a1a;">${escapeHtml(item.name)}</h4>
                            ${item.fromExperience ? '<span style="background: #e3f2fd; color: #0066CC; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600;">From Experience</span>' : '<span style="background: #f5f5f7; color: #666; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600;">Custom</span>'}
                        </div>
                    </div>

                    <!-- Non-interactive visual slider -->
                    <div style="position: relative; padding: 20px 0;">
                        <!-- Scale markers -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 0 10px;">
                            <span style="font-size: 10px; color: #999; font-weight: 600;">1</span>
                            <span style="font-size: 10px; color: #999; font-weight: 600;">2</span>
                            <span style="font-size: 10px; color: #999; font-weight: 600;">3</span>
                            <span style="font-size: 10px; color: #999; font-weight: 600;">4</span>
                            <span style="font-size: 10px; color: #999; font-weight: 600;">5</span>
                        </div>

                        <!-- Track (non-interactive) -->
                        <div style="position: relative; height: 8px; background: #e5e5e7; border-radius: 4px; margin: 0 10px;">
                            <!-- Current position circle (blue) -->
                            <div style="position: absolute; top: 50%; left: ${(currentLevel - 1) * 25}%; transform: translate(-50%, -50%); width: 20px; height: 20px; background: #0066CC; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 2;"></div>

                            <!-- Target position circle (orange) -->
                            <div style="position: absolute; top: 50%; left: ${(desiredLevel - 1) * 25}%; transform: translate(-50%, -50%); width: 20px; height: 20px; background: #ff9800; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 1;"></div>
                        </div>

                        <!-- Legend and values -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding: 0 10px;">
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div style="width: 12px; height: 12px; background: #0066CC; border-radius: 50%;"></div>
                                    <span style="font-size: 10px; color: #666;">Current: <strong>${currentLevel}</strong></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div style="width: 12px; height: 12px; background: #ff9800; border-radius: 50%;"></div>
                                    <span style="font-size: 10px; color: #666;">Target: <strong>${desiredLevel}</strong></span>
                                </div>
                            </div>
                            ${gap !== 0 ? `<div style="font-size: 10px; color: ${gapColor}; font-weight: 600;">Gap: ${gap > 0 ? '+' : ''}${gap}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Removed initializeSlider() - sliders are now non-interactive for demo

        function updateSkillLevel(name, type, levelType, value) {
            loadUserSkillsCompetencies();

            let item = userSkillsCompetencies.find(s => s.name === name && s.type === type);

            if (!item) {
                // Create new entry
                item = {
                    name: name,
                    type: type,
                    fromExperience: true,
                    currentLevel: 1,
                    desiredLevel: 1
                };
                userSkillsCompetencies.push(item);
            }

            if (levelType === 'current') {
                item.currentLevel = parseInt(value);
            } else {
                item.desiredLevel = parseInt(value);
            }

            saveUserSkillsCompetencies();
            loadSkillsCompetencies();
            updateBadgesOnly();
        }

        function syncFromExperience() {
            loadSkillsCompetencies();
            alert('Skills and competencies synced from your career experience!');
        }

        function addCustomSkill() {
            const name = prompt('Enter skill or competency name:');
            if (!name || name.trim() === '') return;

            const type = confirm('Is this a Skill?\n\nClick OK for Skill, Cancel for Competency') ? 'skill' : 'competency';

            loadUserSkillsCompetencies();

            // Check if already exists
            const exists = userSkillsCompetencies.find(s => s.name === name.trim() && s.type === type);
            if (exists) {
                alert('This ' + type + ' already exists!');
                return;
            }

            userSkillsCompetencies.push({
                name: name.trim(),
                type: type,
                fromExperience: false,
                currentLevel: 1,
                desiredLevel: 1
            });

            saveUserSkillsCompetencies();
            loadSkillsCompetencies();
            updateBadgesOnly();
        }

        function deleteSkillCompetency(name, type) {
            if (confirm(`Are you sure you want to delete this ${type}?`)) {
                loadUserSkillsCompetencies();
                userSkillsCompetencies = userSkillsCompetencies.filter(s => !(s.name === name && s.type === type));
                saveUserSkillsCompetencies();
                loadSkillsCompetencies();
                updateBadgesOnly();
            }
        }

        // Modal functions (Pipeline Edit Pattern)
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Export Menu Functions
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Close export menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('exportMenu');
            const exportButton = event.target.closest('button[onclick="toggleExportMenu()"]');

            if (menu && menu.style.display === 'block' && !exportButton && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        function exportDocument(format) {
            // Close the export menu
            document.getElementById('exportMenu').style.display = 'none';

            // Get document data
            const title = document.getElementById('docTitle').value || 'Untitled Document';
            const canvas = document.getElementById('documentCanvas');
            const blocks = canvas.querySelectorAll('.document-block');

            let content = '';

            // Build content from blocks
            blocks.forEach(block => {
                // Use data-block-type attribute (new structure) or fall back to label (old structure)
                const blockType = block.getAttribute('data-block-type') || block.querySelector('.block-type-label')?.textContent.toLowerCase();

                if (blockType === 'header' || blockType === 'heading') {
                    const input = block.querySelector('input');
                    const wbsSpan = block.querySelector('.wbs-number');
                    if (input && input.value) {
                        // Include WBS number if present
                        const wbsPrefix = wbsSpan ? `${wbsSpan.textContent} ` : '';
                        content += `# ${wbsPrefix}${input.value}\n\n`;
                    }
                } else if (blockType === 'paragraph' || blockType === 'text') {
                    const textarea = block.querySelector('textarea');
                    if (textarea && textarea.value) {
                        content += `${textarea.value}\n\n`;
                    }
                } else if (blockType === 'markdown') {
                    const textarea = block.querySelector('.markdown-input');
                    if (textarea && textarea.value) {
                        content += `${textarea.value}\n\n`;
                    }
                } else if (blockType === 'quote') {
                    const textarea = block.querySelector('textarea');
                    if (textarea && textarea.value) {
                        content += `> ${textarea.value}\n\n`;
                    }
                } else if (blockType === 'code') {
                    const textarea = block.querySelector('textarea');
                    const lang = block.querySelector('select')?.value || '';
                    if (textarea && textarea.value) {
                        content += `\`\`\`${lang}\n${textarea.value}\n\`\`\`\n\n`;
                    }
                } else if (blockType === 'list') {
                    const textarea = block.querySelector('textarea');
                    if (textarea && textarea.value) {
                        const items = textarea.value.split('\n').filter(item => item.trim());
                        items.forEach(item => {
                            content += `- ${item}\n`;
                        });
                        content += '\n';
                    }
                } else if (blockType === 'picture') {
                    const img = block.querySelector('.picture-preview img');
                    const altText = block.querySelector('.image-alt-text');
                    if (img && img.src) {
                        const alt = altText?.value || 'Image';
                        content += `![${alt}](${img.src})\n\n`;
                    }
                } else if (blockType === 'mermaid') {
                    const textarea = block.querySelector('.mermaid-edit-area textarea');
                    if (textarea && textarea.value) {
                        content += `\`\`\`mermaid\n${textarea.value}\n\`\`\`\n\n`;
                    }
                } else if (blockType === 'katex' || blockType === 'latex') {
                    const textarea = block.querySelector('.latex-edit-area textarea');
                    if (textarea && textarea.value) {
                        content += `$$\n${textarea.value}\n$$\n\n`;
                    }
                } else if (blockType === 'diagram') {
                    const diagramData = block.querySelector('.diagram-data')?.value;
                    if (diagramData) {
                        // For diagrams, we'll embed the SVG if available
                        const preview = block.querySelector('.diagram-preview svg');
                        if (preview) {
                            content += `<!-- Draw.io Diagram -->\n${preview.outerHTML}\n\n`;
                        } else {
                            content += `<!-- Draw.io Diagram (data stored but not rendered) -->\n\n`;
                        }
                    }
                } else if (blockType === 'toc') {
                    // Generate TOC for export
                    content += `## Table of Contents\n\n`;
                    const tocEntries = block.querySelectorAll('.toc-content > div[style*="margin-left"]');
                    if (tocEntries.length > 0) {
                        tocEntries.forEach(entry => {
                            const text = entry.textContent.trim();
                            const indent = entry.style.marginLeft ? parseInt(entry.style.marginLeft) / 20 : 0;
                            const prefix = '  '.repeat(indent);
                            content += `${prefix}- ${text}\n`;
                        });
                    } else {
                        content += `*No headers found in document*\n`;
                    }
                    content += `\n`;
                } else if (blockType === 'divider') {
                    const dividerType = block.getAttribute('data-divider-type') || 'visual';
                    if (dividerType === 'page') {
                        // Add page break marker for different formats
                        if (format === 'docx' || format === 'pdf') {
                            content += `<div style="page-break-before: always;"></div>\n\n`;
                        } else if (format === 'markdown') {
                            content += `\n<!-- PAGE BREAK -->\n\\newpage\n\n`;
                        } else {
                            content += `\n---\n\n`; // Fallback for other formats
                        }
                    } else {
                        // Visual divider only
                        content += `\n---\n\n`;
                    }
                }
            });

            // Export based on format
            if (format === 'markdown') {
                downloadFile(`# ${title}\n\n${content}`, `${title}.md`, 'text/markdown');
            } else if (format === 'html') {
                const htmlContent = convertMarkdownToHTML(content);
                const fullHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; }
        h1, h2, h3 { color: #1a1a1a; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; }
        pre { background: #f5f5f5; padding: 16px; border-radius: 8px; overflow-x: auto; }
        blockquote { border-left: 4px solid #0066CC; padding-left: 16px; color: #666; margin: 16px 0; }
    </style>
</head>
<body>
    <h1>${title}</h1>
    ${htmlContent}
</body>
</html>`;
                downloadFile(fullHTML, `${title}.html`, 'text/html');
            } else if (format === 'docx') {
                alert('Word export coming soon! For now, you can export as HTML and open in Word.');
            } else if (format === 'pdf') {
                alert('PDF export coming soon! For now, you can export as HTML and print to PDF from your browser.');
            }
        }

        function convertMarkdownToHTML(markdown) {
            let html = markdown;

            // Headers
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');

            // Blockquotes
            html = html.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');

            // Code blocks
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

            // Lists
            html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';

            // Clean up
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[1-6]>)/g, '$1');
            html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<blockquote>)/g, '$1');
            html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            html = html.replace(/<p>(<pre>)/g, '$1');
            html = html.replace(/(<\/pre>)<\/p>/g, '$1');

            // Final two-column layout processing for CV documents
            if (isCV && html.includes('<!-- BEGIN_PARACOL -->')) {
                console.log('Processing two-column layout for CV document');

                // Extract column ratio if specified
                let leftRatio = 70; // Default left column percentage
                let rightRatio = 30; // Default right column percentage

                const ratioMatch = html.match(/<!-- COLUMN_RATIO:([^,]+),([^>]+) -->/);
                if (ratioMatch) {
                    leftRatio = parseFloat(ratioMatch[1]);
                    rightRatio = parseFloat(ratioMatch[2]);
                    console.log('Using custom column ratios:', leftRatio + '%', rightRatio + '%');
                }

                // Find the paracol content
                const paracolRegex = /<!-- BEGIN_PARACOL -->([\s\S]*?)<!-- END_PARACOL -->/;
                const paracolMatch = html.match(paracolRegex);

                if (paracolMatch) {
                    const paracolContent = paracolMatch[1];

                    // Split content by column switches
                    const columns = paracolContent.split('<!-- SWITCH_COLUMN -->');
                    const leftColumn = columns[0] ? columns[0].trim() : '';
                    const rightColumn = columns[1] ? columns[1].trim() : '';

                    console.log('Left column content length:', leftColumn.length);
                    console.log('Right column content length:', rightColumn.length);

                    // Create two-column HTML layout
                    const twoColumnHTML = `
                        <div style="display: flex; gap: 2em; margin: 1em 0; align-items: flex-start;">
                            <div style="flex: 0 0 ${leftRatio}%; min-width: 0;">
                                ${leftColumn}
                            </div>
                            <div style="flex: 0 0 ${rightRatio}%; min-width: 0;">
                                ${rightColumn}
                            </div>
                        </div>
                    `;

                    // Replace the paracol block with the formatted columns
                    html = html.replace(paracolRegex, twoColumnHTML);

                    // Clean up any remaining column ratio comments
                    html = html.replace(/<!-- COLUMN_RATIO:[^>]+ -->/g, '');

                    console.log('Two-column layout processing completed');
                } else {
                    console.warn('BEGIN_PARACOL found but no matching END_PARACOL');
                }
            }

            return html;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Picture Upload Functions
        function triggerPictureUpload(blockId) {
            const fileInput = document.getElementById(`fileInput-${blockId}`);
            fileInput.click();
        }

        function handlePictureFileSelect(event, blockId) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                loadPictureToBlock(file, blockId);
            }
        }

        function handlePictureDragOver(event, blockId) {
            event.preventDefault();
            event.stopPropagation();
            const zone = event.currentTarget;
            zone.style.borderColor = 'var(--color-primary-blue)';
            zone.style.background = 'rgba(0, 102, 204, 0.05)';
        }

        function handlePictureDragLeave(event, blockId) {
            event.preventDefault();
            event.stopPropagation();
            const zone = event.currentTarget;
            zone.style.borderColor = 'var(--color-neutral-border)';
            zone.style.background = 'var(--color-neutral-background)';
        }

        function handlePictureDrop(event, blockId) {
            event.preventDefault();
            event.stopPropagation();

            const zone = event.currentTarget;
            zone.style.borderColor = 'var(--color-neutral-border)';
            zone.style.background = 'var(--color-neutral-background)';

            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                loadPictureToBlock(files[0], blockId);
            }
        }

        function loadPictureToBlock(file, blockId) {
            const reader = new FileReader();

            reader.onload = function(e) {
                const block = document.getElementById(blockId);
                const uploadZone = block.querySelector('.picture-upload-zone');
                const previewZone = block.querySelector('.picture-preview');
                const img = previewZone.querySelector('img');

                // Hide upload zone, show preview
                uploadZone.style.display = 'none';
                previewZone.style.display = 'block';

                // Set image source
                img.src = e.target.result;
                img.alt = file.name;

                // Store the image data in a data attribute for export
                block.setAttribute('data-image-src', e.target.result);
            };

            reader.readAsDataURL(file);
        }

        function removePicture(blockId) {
            const block = document.getElementById(blockId);
            const uploadZone = block.querySelector('.picture-upload-zone');
            const previewZone = block.querySelector('.picture-preview');
            const img = previewZone.querySelector('img');
            const altInput = block.querySelector('.image-alt-text');

            // Clear image
            img.src = '';
            img.alt = '';
            altInput.value = '';
            block.removeAttribute('data-image-src');

            // Show upload zone, hide preview
            uploadZone.style.display = 'block';
            previewZone.style.display = 'none';

            // Reset file input
            const fileInput = document.getElementById(`fileInput-${blockId}`);
            if (fileInput) {
                fileInput.value = '';
            }
        }

        // Global paste handler for images
        document.addEventListener('paste', function(event) {
            const items = event.clipboardData?.items;
            if (!items) return;

            // Check if we're focused on a picture block
            const activeElement = document.activeElement;
            const pictureBlock = activeElement?.closest('.document-block');

            if (!pictureBlock) return;

            const blockType = pictureBlock.querySelector('.block-type-label')?.textContent;
            if (blockType !== 'Picture') return;

            // Look for image in clipboard
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    event.preventDefault();
                    const blob = items[i].getAsFile();
                    const blockId = pictureBlock.id;
                    loadPictureToBlock(blob, blockId);
                    break;
                }
            }
        });

        // Make picture blocks focusable for paste support
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for dynamically added picture blocks
            document.addEventListener('click', function(event) {
                const uploadZone = event.target.closest('.picture-upload-zone');
                if (uploadZone) {
                    // Make the block focusable
                    const block = uploadZone.closest('.document-block');
                    if (block) {
                        block.tabIndex = 0;
                        block.focus();
                    }
                }
            });
        });

        // Code Linting Functions
        function updateCodeLanguage(blockId, language) {
            const block = document.getElementById(blockId);
            block.setAttribute('data-language', language);
        }

        function lintCode(blockId) {
            const block = document.getElementById(blockId);
            const textarea = block.querySelector('.code-textarea');
            const resultsDiv = block.querySelector('.lint-results');
            const language = block.querySelector('.code-language-select').value;
            const code = textarea.value;

            if (!code.trim()) {
                resultsDiv.style.display = 'none';
                return;
            }

            const issues = performLinting(code, language);

            if (issues.length === 0) {
                resultsDiv.style.display = 'block';
                resultsDiv.style.background = '#ecfdf5';
                resultsDiv.style.border = '1px solid #6ee7b7';
                resultsDiv.style.color = '#065f46';
                resultsDiv.innerHTML = '<i class="ph ph-check-circle" style="color: #10b981; margin-right: 6px;"></i>No issues found!';
            } else {
                resultsDiv.style.display = 'block';
                resultsDiv.style.background = '#fef2f2';
                resultsDiv.style.border = '1px solid #fca5a5';
                resultsDiv.style.color = '#991b1b';
                resultsDiv.innerHTML = '<div style="margin-bottom: 8px; font-weight: 600;"><i class="ph ph-warning-circle" style="color: #ef4444; margin-right: 6px;"></i>Found ' + issues.length + ' issue(s):</div>' +
                    issues.map(issue => `<div style="margin-left: 24px; margin-bottom: 4px;">• Line ${issue.line}: ${issue.message}</div>`).join('');
            }
        }

        function performLinting(code, language) {
            const issues = [];
            const lines = code.split('\n');

            switch (language) {
                case 'javascript':
                case 'typescript':
                    // Check for common JS/TS issues
                    lines.forEach((line, index) => {
                        // Missing semicolons
                        if (line.trim() && !line.trim().endsWith(';') && !line.trim().endsWith('{') && !line.trim().endsWith('}') && !line.trim().endsWith(',') && !line.trim().startsWith('//') && !line.trim().startsWith('*') && !line.trim().startsWith('/*') && !line.trim().startsWith('import') && !line.trim().startsWith('export')) {
                            issues.push({ line: index + 1, message: 'Missing semicolon' });
                        }
                        // Console.log statements
                        if (line.includes('console.log(')) {
                            issues.push({ line: index + 1, message: 'console.log() statement found (consider removing for production)' });
                        }
                        // var usage
                        if (line.includes('var ')) {
                            issues.push({ line: index + 1, message: 'Use let or const instead of var' });
                        }
                        // == instead of ===
                        if (line.includes('==') && !line.includes('===') && !line.includes('!==')) {
                            issues.push({ line: index + 1, message: 'Use === instead of == for comparison' });
                        }
                    });
                    break;

                case 'python':
                    lines.forEach((line, index) => {
                        // Mixed tabs and spaces
                        if (line.match(/^\t/) && code.includes('    ')) {
                            issues.push({ line: index + 1, message: 'Mixed tabs and spaces for indentation' });
                        }
                        // Print statements without parentheses (Python 2 style)
                        if (line.match(/print\s+[^(]/)) {
                            issues.push({ line: index + 1, message: 'Use print() with parentheses (Python 3 syntax)' });
                        }
                        // Import * statements
                        if (line.includes('from') && line.includes('import *')) {
                            issues.push({ line: index + 1, message: 'Avoid wildcard imports (import *)' });
                        }
                    });
                    break;

                case 'java':
                case 'csharp':
                    lines.forEach((line, index) => {
                        // Missing semicolons
                        if (line.trim() && !line.trim().endsWith(';') && !line.trim().endsWith('{') && !line.trim().endsWith('}') && !line.trim().startsWith('//') && !line.trim().startsWith('*') && !line.trim().startsWith('/*') && !line.trim().startsWith('@') && line.includes('=')) {
                            issues.push({ line: index + 1, message: 'Missing semicolon' });
                        }
                        // System.out.println (Java)
                        if (language === 'java' && line.includes('System.out.println(')) {
                            issues.push({ line: index + 1, message: 'Consider using a logging framework instead of System.out.println()' });
                        }
                    });
                    break;

                case 'sql':
                    lines.forEach((line, index) => {
                        // SELECT *
                        if (line.toUpperCase().includes('SELECT *')) {
                            issues.push({ line: index + 1, message: 'Avoid SELECT *, specify column names explicitly' });
                        }
                        // Missing WHERE in UPDATE/DELETE
                        if ((line.toUpperCase().includes('UPDATE') || line.toUpperCase().includes('DELETE')) && !code.toUpperCase().includes('WHERE')) {
                            issues.push({ line: index + 1, message: 'UPDATE/DELETE without WHERE clause can be dangerous' });
                        }
                    });
                    break;

                case 'html':
                    lines.forEach((line, index) => {
                        // Missing alt attribute on images
                        if (line.includes('<img') && !line.includes('alt=')) {
                            issues.push({ line: index + 1, message: 'Missing alt attribute on <img> tag' });
                        }
                        // Inline styles
                        if (line.includes('style=') && !line.includes('style="')) {
                            issues.push({ line: index + 1, message: 'Consider using CSS classes instead of inline styles' });
                        }
                    });
                    break;

                case 'css':
                    lines.forEach((line, index) => {
                        // !important usage
                        if (line.includes('!important')) {
                            issues.push({ line: index + 1, message: 'Avoid using !important' });
                        }
                        // Missing semicolons
                        if (line.includes(':') && !line.includes(';') && !line.trim().endsWith('{') && !line.trim().endsWith('}') && line.trim() !== '') {
                            issues.push({ line: index + 1, message: 'Missing semicolon' });
                        }
                    });
                    break;

                case 'json':
                    try {
                        JSON.parse(code);
                    } catch (e) {
                        issues.push({ line: 1, message: 'Invalid JSON: ' + e.message });
                    }
                    break;

                case 'yaml':
                    lines.forEach((line, index) => {
                        // Mixed tabs and spaces
                        if (line.match(/^\t/)) {
                            issues.push({ line: index + 1, message: 'Use spaces for indentation in YAML, not tabs' });
                        }
                    });
                    break;
            }

            return issues.slice(0, 10); // Limit to 10 issues
        }

        // Document block management
        function addDocumentBlock(blockType) {
            const canvas = document.getElementById('documentCanvas');

            // Remove empty state if present
            const emptyState = canvas.querySelector('[style*="text-align: center"]');
            if (emptyState) {
                canvas.innerHTML = '';
            }

            // Create block element
            const blockId = `block-${Date.now()}`;
            const block = document.createElement('div');
            block.id = blockId;
            block.className = 'document-block';
            block.setAttribute('data-block-type', blockType);
            block.setAttribute('tabindex', '0');
            block.style.cssText = 'margin-bottom: 16px; padding: 16px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; position: relative;';

            // Add block content based on type
            let blockContent = '';
            switch(blockType) {
                case 'header':
                    blockContent = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <select onchange="changeHeaderLevel('${blockId}', this.value)" style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 11px; color: var(--color-neutral-text); background: white; cursor: pointer;">
                                <option value="1">H1</option>
                                <option value="2">H2</option>
                                <option value="3" selected>H3</option>
                                <option value="4">H4</option>
                                <option value="5">H5</option>
                                <option value="6">H6</option>
                            </select>
                        </div>
                        <div class="header-input-container" style="display: flex; align-items: center; gap: 8px;">
                            <input type="text" placeholder="Enter header text..." class="header-input" data-level="3" oninput="updateTableOfContents()" style="width: 100%; border: none; font-family: var(--font-family-ui); font-size: 20px; font-weight: 600; color: var(--color-dark); outline: none;">
                        </div>
                    `;
                    break;
                case 'richtext':
                    blockContent = `<div class="quill-container-${blockId}" style="background: white; margin-top: 32px; resize: both; overflow: auto; min-height: 200px; max-width: 100%;"></div>`;
                    break;
                case 'markdown':
                    blockContent = `
                        <div class="markdown-editor" style="padding-top: 32px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="display: flex; flex-direction: column;">
                                <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px; padding-left: 4px;">MARKDOWN</div>
                                <textarea class="markdown-input" placeholder="Enter markdown content..." style="width: 100%; min-height: 300px; max-height: 500px; border: 1px solid var(--color-neutral-border); border-radius: 4px; padding: 12px; font-family: monospace; font-size: 13px; color: var(--color-dark); outline: none; resize: vertical; line-height: 1.5; overflow-y: auto;"># Technical Documentation

## Overview

This document provides a **comprehensive guide** to using markdown for technical writing.

### Key Features

- **Easy to read** and write
- Supports *inline formatting*
- Code blocks with syntax highlighting
- Tables and lists

### Code Example

\`\`\`javascript
function greet(name) {
    return \`Hello, \${name}!\`;
}
\`\`\`

### Quick Reference

| Element | Syntax |
|---------|--------|
| Bold | \`**text**\` |
| Italic | \`*text*\` |
| Link | \`[text](url)\` |

> **Note:** This is a blockquote for important callouts.</textarea>
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <div style="font-family: var(--font-family-ui); font-size: 11px; font-weight: 600; color: var(--color-neutral-text); margin-bottom: 6px; padding-left: 4px;">PREVIEW</div>
                                <div class="markdown-preview" style="width: 100%; min-height: 300px; max-height: 500px; padding: 12px; border: 1px solid var(--color-neutral-border); border-radius: 4px; background: white; font-family: var(--font-family-body); font-size: 14px; line-height: 1.6; overflow-y: auto;"></div>
                            </div>
                        </div>
                    `;
                    break;
                case 'picture':
                    blockContent = `
                        <div class="picture-upload-zone"
                             onclick="triggerPictureUpload('${blockId}')"
                             ondrop="handlePictureDrop(event, '${blockId}')"
                             ondragover="handlePictureDragOver(event, '${blockId}')"
                             ondragleave="handlePictureDragLeave(event, '${blockId}')"
                             style="text-align: center; padding: 40px; background: var(--color-neutral-background); border: 2px dashed var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <i class="ph ph-image" style="font-size: 48px; color: var(--color-neutral-text-light);"></i>
                            <p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text); margin: 8px 0 4px 0;">Click to upload image</p>
                            <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text-light); margin: 0;">or drag & drop</p>
                            <input type="file" id="fileInput-${blockId}" accept="image/*" style="display: none;" onchange="handlePictureFileSelect(event, '${blockId}')">
                        </div>
                        <div class="picture-preview" style="display: none;">
                            <img style="max-width: 100%; height: auto; border-radius: 8px;" />
                            <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: center;">
                                <input type="text" placeholder="Alt text (optional)" style="flex: 1; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;" class="image-alt-text">
                                <button onclick="removePicture('${blockId}')" style="padding: 8px 12px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); cursor: pointer; transition: all 0.2s;">
                                    <i class="ph ph-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    `;
                    break;
                case 'table':
                    blockContent = `
                        <div style="display: flex; gap: 12px; padding: 20px;">
                            <!-- Create Cleansheet Table -->
                            <div onclick="createCleansheetTable('${blockId}')" style="flex: 1; text-align: center; padding: 24px 16px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-plus-circle" style="font-size: 32px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                <p style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Create Cleansheet Table</p>
                                <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin: 0;">Build a new table from scratch</p>
                            </div>

                            <!-- Connect Cleansheet Table -->
                            <div onclick="connectCleansheetTable('${blockId}')" style="flex: 1; text-align: center; padding: 24px 16px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-link" style="font-size: 32px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                <p style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Connect Cleansheet Table</p>
                                <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin: 0;">Link to existing table</p>
                            </div>

                            <!-- Connect Data Source -->
                            <div onclick="connectDataSource('${blockId}')" style="flex: 1; text-align: center; padding: 24px 16px; background: white; border: 2px solid var(--color-neutral-border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <i class="ph ph-database" style="font-size: 32px; color: var(--color-primary-blue); margin-bottom: 8px;"></i>
                                <p style="font-family: var(--font-family-ui); font-size: 13px; font-weight: 600; color: var(--color-dark); margin: 0 0 4px 0;">Connect Data Source</p>
                                <p style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); margin: 0;">Import from external source</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'code':
                    blockContent = `
                        <div style="margin-top: 32px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 8px; padding: 8px 12px; background: var(--color-neutral-background); border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="ph ph-code" style="font-size: 16px; color: var(--color-neutral-text);"></i>
                                    <select class="code-language-select" onchange="updateCodeLanguage('${blockId}', this.value)" style="padding: 4px 8px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-family: var(--font-family-ui); font-size: 12px; background: white; cursor: pointer;">
                                        <option value="javascript">JavaScript</option>
                                        <option value="python">Python</option>
                                        <option value="java">Java</option>
                                        <option value="csharp">C#</option>
                                        <option value="cpp">C++</option>
                                        <option value="typescript">TypeScript</option>
                                        <option value="go">Go</option>
                                        <option value="rust">Rust</option>
                                        <option value="php">PHP</option>
                                        <option value="ruby">Ruby</option>
                                        <option value="sql">SQL</option>
                                        <option value="html">HTML</option>
                                        <option value="css">CSS</option>
                                        <option value="json">JSON</option>
                                        <option value="yaml">YAML</option>
                                        <option value="bash">Bash</option>
                                    </select>
                                </div>
                                <button onclick="lintCode('${blockId}')" title="Lint code" style="padding: 6px 12px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--color-neutral-text); font-family: var(--font-family-ui); font-size: 12px; transition: all 0.2s;">
                                    <i class="ph ph-checks" style="font-size: 14px;"></i>
                                    Lint
                                </button>
                            </div>
                            <textarea placeholder="Enter code..." class="code-textarea" style="width: 100%; min-height: 120px; border: none; font-family: monospace; font-size: 13px; color: var(--color-dark); background: #f8f8f8; outline: none; resize: vertical; padding: 12px; line-height: 1.5;"></textarea>
                            <div class="lint-results" style="display: none; margin-top: 8px; padding: 12px; border-radius: 6px; font-family: var(--font-family-body); font-size: 12px;"></div>
                        </div>
                    `;
                    break;
                case 'diagram':
                    blockContent = `
                        <div style="margin-top: 32px;">
                            <div class="diagram-container" style="position: relative;">
                                <div style="display: flex; gap: 8px; margin-bottom: 12px; padding: 8px; background: var(--color-neutral-background); border-radius: 6px;">
                                    <button onclick="openDrawioEditor('${blockId}')" style="padding: 6px 12px; border-radius: 4px; background: var(--color-primary-blue); color: white; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; font-family: var(--font-family-ui); font-size: 12px; transition: all 0.2s;">
                                        <i class="ph ph-pencil-simple" style="font-size: 14px;"></i>
                                        Edit Diagram
                                    </button>
                                    <button onclick="clearDiagram('${blockId}')" style="padding: 6px 12px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--color-neutral-text); font-family: var(--font-family-ui); font-size: 12px; transition: all 0.2s;">
                                        <i class="ph ph-trash" style="font-size: 14px;"></i>
                                        Clear
                                    </button>
                                </div>
                                <div class="diagram-preview" style="min-height: 300px; border: 1px solid var(--color-neutral-border); border-radius: 8px; background: white; display: flex; align-items: center; justify-content: center; padding: 20px;">
                                    <div style="text-align: center; color: var(--color-neutral-text-light);">
                                        <i class="ph ph-flow-arrow" style="font-size: 48px;"></i>
                                        <p style="font-family: var(--font-family-body); font-size: 13px; margin: 12px 0 0 0;">No diagram yet. Click "Edit Diagram" to create one.</p>
                                    </div>
                                </div>
                                <input type="hidden" class="diagram-data" value="">
                            </div>
                        </div>
                    `;
                    break;
                case 'divider':
                    blockContent = `
                        <div style="margin-top: 16px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <select onchange="updateDividerType('${blockId}', this.value)" class="divider-type-select" style="padding: 6px 10px; border: 1px solid var(--color-neutral-border); border-radius: 4px; font-size: 12px; font-family: var(--font-family-body); background: white; cursor: pointer;">
                                    <option value="visual">Visual Divider</option>
                                    <option value="page">Page Divider</option>
                                </select>
                                <span style="font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text); flex: 1;">
                                    <span class="divider-description">Visual separator only</span>
                                </span>
                            </div>
                            <div class="divider-visual" style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; height: 2px; background: var(--color-neutral-border); border-radius: 1px;"></div>
                            </div>
                        </div>
                    `;
                    break;
                case 'mermaid':
                    blockContent = `
                        <div style="margin-top: 32px;">
                            <div class="mermaid-edit-area">
                                <textarea placeholder="graph TD&#10;    A[Start] --> B[Process]&#10;    B --> C[End]" style="width: 100%; min-height: 160px; border: none; font-family: monospace; font-size: 13px; color: var(--color-dark); background: #f0f9ff; outline: none; resize: vertical; padding: 12px; line-height: 1.5;">graph LR
    A[Client] --> B[Load Balancer]
    B --> C[Server 1]
    B --> D[Server 2]
    B --> E[Server 3]
    C --> F[Database]
    D --> F
    E --> F</textarea>
                                <div style="margin-top: 8px; padding: 8px; background: #e0f2fe; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);"><i class="ph ph-info" style="margin-right: 4px;"></i>Mermaid diagram syntax</div>
                            </div>
                            <div class="mermaid-preview-area" style="display: none;">
                                <div class="mermaid-render" style="padding: 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; min-height: 160px; display: flex; align-items: center; justify-content: center;"></div>
                            </div>
                        </div>
                    `;
                    break;
                case 'latex':
                    blockContent = `
                        <div style="margin-top: 32px;">
                            <div class="latex-edit-area">
                                <textarea placeholder="\\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}" style="width: 100%; min-height: 120px; border: none; font-family: monospace; font-size: 13px; color: var(--color-dark); background: #fef3c7; outline: none; resize: vertical; padding: 12px; line-height: 1.5;">\\begin{aligned}
E &= mc^2 \\\\
F &= ma \\\\
\\Delta x &= v_0t + \\frac{1}{2}at^2 \\\\
\\int_{a}^{b} f(x)dx &= F(b) - F(a)
\\end{aligned}</textarea>
                                <div style="margin-top: 8px; padding: 8px; background: #fde68a; border-radius: 4px; font-family: var(--font-family-body); font-size: 11px; color: var(--color-neutral-text);"><i class="ph ph-info" style="margin-right: 4px;"></i>KaTeX mathematical notation</div>
                            </div>
                            <div class="latex-preview-area" style="display: none;">
                                <div class="latex-render" style="padding: 20px; background: white; border: 1px solid var(--color-neutral-border); border-radius: 8px; min-height: 120px; display: flex; align-items: center; justify-content: center; font-size: 18px;"></div>
                            </div>
                        </div>
                    `;
                    break;
                case 'toc':
                    blockContent = `
                        <div class="toc-container" style="margin-top: 32px; padding: 20px; background: var(--color-neutral-background); border: 1px solid var(--color-neutral-border); border-radius: 8px;">
                            <h3 style="font-family: var(--font-family-ui); font-size: 16px; font-weight: 600; color: var(--color-dark); margin: 0 0 16px 0;">
                                <i class="ph ph-list-numbers" style="margin-right: 8px; color: var(--color-primary-blue);"></i>
                                Table of Contents
                            </h3>
                            <div class="toc-content" style="font-family: var(--font-family-body); font-size: 14px; line-height: 1.8; color: var(--color-neutral-text);">
                                <div style="padding: 20px; text-align: center; color: var(--color-neutral-text-light);">
                                    <i class="ph ph-file-dashed" style="font-size: 32px; margin-bottom: 8px;"></i>
                                    <p style="margin: 0; font-size: 13px;">Add headers to your document to generate the table of contents</p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }

            // Add control buttons and drag handle (except for divider)
            if (blockType !== 'divider') {
                block.setAttribute('draggable', 'true');

                // Add preview toggle button for mermaid and latex blocks (markdown shows live split view)
                const previewButton = blockType === 'mermaid'
                    ? `<button onclick="toggleMermaidPreview('${blockId}')" title="Toggle preview" class="block-control-btn mermaid-preview-btn" data-mode="edit" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-eye" style="font-size: 14px;"></i>
                        </button>`
                    : blockType === 'latex'
                    ? `<button onclick="toggleLatexPreview('${blockId}')" title="Toggle preview" class="block-control-btn latex-preview-btn" data-mode="edit" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-eye" style="font-size: 14px;"></i>
                        </button>`
                    : '';

                block.innerHTML = `
                    <div class="drag-handle" title="Drag to reorder | Keyboard: Ctrl+Shift+↑/↓" style="position: absolute; top: 8px; left: 8px; width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: grab; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s; opacity: 0;">
                        <i class="ph ph-dots-six-vertical" style="font-size: 16px;"></i>
                    </div>
                    <div class="block-controls" style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                        ${previewButton}
                        <button onclick="shareBlock('${blockId}')" title="Share block" class="block-control-btn" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-share-network" style="font-size: 14px;"></i>
                        </button>
                        <button onclick="moveBlockUp('${blockId}')" title="Move up" class="block-control-btn" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-arrow-up" style="font-size: 14px;"></i>
                        </button>
                        <button onclick="moveBlockDown('${blockId}')" title="Move down" class="block-control-btn" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-arrow-down" style="font-size: 14px;"></i>
                        </button>
                        <button onclick="removeDocumentBlock('${blockId}')" title="Delete block" class="block-control-btn" style="width: 24px; height: 24px; border-radius: 4px; background: white; border: 1px solid var(--color-neutral-border); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-neutral-text); transition: all 0.2s;">
                            <i class="ph ph-x" style="font-size: 14px;"></i>
                        </button>
                    </div>
                    ${blockContent}
                `;
            } else {
                block.innerHTML = blockContent;
            }

            canvas.appendChild(block);

            // Initialize Quill editor for richtext blocks
            if (blockType === 'richtext') {
                const quillContainer = block.querySelector(`.quill-container-${blockId}`);
                if (quillContainer) {
                    new Quill(quillContainer, {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'align': [] }],
                                ['link', 'image'],
                                ['clean']
                            ]
                        },
                        placeholder: 'Enter rich text content...'
                    });
                }
            }

            // Initialize live preview and scroll synchronization for markdown blocks
            if (blockType === 'markdown') {
                const input = block.querySelector('.markdown-input');
                const preview = block.querySelector('.markdown-preview');

                if (input && preview) {
                    // Initial preview render
                    preview.innerHTML = parseMarkdown(input.value);

                    let isInputScrolling = false;
                    let isPreviewScrolling = false;

                    // Live preview update as you type
                    input.addEventListener('input', () => {
                        preview.innerHTML = parseMarkdown(input.value);
                    });

                    // Sync preview scroll when input scrolls
                    input.addEventListener('scroll', () => {
                        if (isPreviewScrolling) return;
                        isInputScrolling = true;

                        const scrollPercentage = input.scrollTop / (input.scrollHeight - input.clientHeight);
                        preview.scrollTop = scrollPercentage * (preview.scrollHeight - preview.clientHeight);

                        setTimeout(() => { isInputScrolling = false; }, 100);
                    });

                    // Sync input scroll when preview scrolls
                    preview.addEventListener('scroll', () => {
                        if (isInputScrolling) return;
                        isPreviewScrolling = true;

                        const scrollPercentage = preview.scrollTop / (preview.scrollHeight - preview.clientHeight);
                        input.scrollTop = scrollPercentage * (input.scrollHeight - input.clientHeight);

                        setTimeout(() => { isPreviewScrolling = false; }, 100);
                    });
                }
            }

            // Setup drag and drop for non-divider blocks
            if (blockType !== 'divider') {
                setupBlockDragAndDrop(block);
                setupBlockKeyboardShortcuts(block);
            }

            // Update control button states
            updateBlockControlStates();

            // Refresh WBS numbers if enabled
            refreshWBS();

            // Update table of contents if present
            updateTableOfContents();
        }

        function removeDocumentBlock(blockId) {
            const block = document.getElementById(blockId);
            if (block && confirm('Remove this block?')) {
                block.remove();
                // Update control button states after removal
                updateBlockControlStates();
                // Refresh WBS numbers if enabled
                refreshWBS();
            }
        }

        function shareBlock(blockId) {
            // Nonfunctional placeholder for sharing individual blocks
            const block = document.getElementById(blockId);
            if (block) {
                const blockType = block.getAttribute('data-block-type');
                alert(`Sharing functionality coming soon!\n\nThis will allow you to share this ${blockType} block with others.`);
            }
        }

        function changeHeaderLevel(blockId, level) {
            const block = document.getElementById(blockId);
            const headerInput = block.querySelector('.header-input');

            if (headerInput) {
                // Update data attribute
                headerInput.setAttribute('data-level', level);

                // Font size mapping for different header levels
                const fontSizes = {
                    '1': '32px',  // H1
                    '2': '28px',  // H2
                    '3': '20px',  // H3
                    '4': '18px',  // H4
                    '5': '16px',  // H5
                    '6': '14px'   // H6
                };

                headerInput.style.fontSize = fontSizes[level];

                // Refresh WBS numbers if enabled
                refreshWBS();
            }
        }

        function updateDividerType(blockId, dividerType) {
            const block = document.getElementById(blockId);
            const visualDiv = block.querySelector('.divider-visual');
            const descriptionSpan = block.querySelector('.divider-description');

            // Store divider type as data attribute
            block.setAttribute('data-divider-type', dividerType);

            if (dividerType === 'page') {
                visualDiv.innerHTML = `
                    <div style="flex: 1; height: 3px; background: repeating-linear-gradient(45deg, var(--color-primary-blue), var(--color-primary-blue) 8px, transparent 8px, transparent 16px); border-radius: 1px;"></div>
                    <div style="background: var(--color-primary-blue); color: white; padding: 4px 8px; border-radius: 12px; font-family: var(--font-family-ui); font-size: 10px; font-weight: 600; text-transform: uppercase;">PAGE BREAK</div>
                    <div style="flex: 1; height: 3px; background: repeating-linear-gradient(45deg, var(--color-primary-blue), var(--color-primary-blue) 8px, transparent 8px, transparent 16px); border-radius: 1px;"></div>
                `;
                descriptionSpan.textContent = 'Creates a page break in exports';

                // Update the select dropdown
                const select = block.querySelector('.divider-type-select');
                if (select) select.value = 'page';
            } else {
                visualDiv.innerHTML = `
                    <div style="flex: 1; height: 2px; background: var(--color-neutral-border); border-radius: 1px;"></div>
                `;
                descriptionSpan.textContent = 'Visual separator only';

                // Update the select dropdown
                const select = block.querySelector('.divider-type-select');
                if (select) select.value = 'visual';
            }
        }

        // Block reordering functions
        function moveBlockUp(blockId) {
            const canvas = document.getElementById('documentCanvas');
            const block = document.getElementById(blockId);
            const previousBlock = block.previousElementSibling;

            if (previousBlock && previousBlock.classList.contains('document-block')) {
                canvas.insertBefore(block, previousBlock);

                // Smooth scroll to keep block visible
                block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Update button states
                updateBlockControlStates();

                // Refresh WBS numbers if enabled
                refreshWBS();
            }
        }

        function moveBlockDown(blockId) {
            const canvas = document.getElementById('documentCanvas');
            const block = document.getElementById(blockId);
            const nextBlock = block.nextElementSibling;

            if (nextBlock && nextBlock.classList.contains('document-block')) {
                canvas.insertBefore(nextBlock, block);

                // Smooth scroll to keep block visible
                block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Update button states
                updateBlockControlStates();

                // Refresh WBS numbers if enabled
                refreshWBS();
            }
        }

        function updateBlockControlStates() {
            const canvas = document.getElementById('documentCanvas');
            const blocks = canvas.querySelectorAll('.document-block');

            blocks.forEach((block, index) => {
                const controls = block.querySelector('.block-controls');
                if (!controls) return;

                const upBtn = controls.querySelector('[onclick*="moveBlockUp"]');
                const downBtn = controls.querySelector('[onclick*="moveBlockDown"]');

                // Disable up button on first block
                if (upBtn) {
                    upBtn.disabled = (index === 0);
                }

                // Disable down button on last block
                if (downBtn) {
                    downBtn.disabled = (index === blocks.length - 1);
                }
            });
        }

        // Drag and drop functionality
        let draggedBlock = null;

        function setupBlockDragAndDrop(block) {
            block.addEventListener('dragstart', handleDragStart);
            block.addEventListener('dragend', handleDragEnd);
            block.addEventListener('dragover', handleDragOver);
            block.addEventListener('drop', handleDrop);
            block.addEventListener('dragleave', handleDragLeave);
        }

        // Keyboard shortcuts functionality
        function setupBlockKeyboardShortcuts(block) {
            block.addEventListener('keydown', function(e) {
                // Only handle keyboard shortcuts when block is focused
                // and input/textarea elements are not focused
                const activeElement = document.activeElement;
                if (activeElement.tagName === 'INPUT' ||
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.classList.contains('ql-editor')) {
                    return;
                }

                // Ctrl+Shift+Up Arrow - Move block up
                if (e.ctrlKey && e.shiftKey && e.key === 'ArrowUp') {
                    e.preventDefault();
                    moveBlockUp(block.id);
                }

                // Ctrl+Shift+Down Arrow - Move block down
                if (e.ctrlKey && e.shiftKey && e.key === 'ArrowDown') {
                    e.preventDefault();
                    moveBlockDown(block.id);
                }

                // Ctrl+Shift+Home - Move to top
                if (e.ctrlKey && e.shiftKey && e.key === 'Home') {
                    e.preventDefault();
                    moveBlockToPosition(block.id, 0);
                }

                // Ctrl+Shift+End - Move to bottom
                if (e.ctrlKey && e.shiftKey && e.key === 'End') {
                    e.preventDefault();
                    const canvas = document.getElementById('documentCanvas');
                    const blocks = canvas.querySelectorAll('.document-block');
                    moveBlockToPosition(block.id, blocks.length - 1);
                }
            });
        }

        function moveBlockToPosition(blockId, targetIndex) {
            const canvas = document.getElementById('documentCanvas');
            const block = document.getElementById(blockId);
            const allBlocks = Array.from(canvas.querySelectorAll('.document-block'));

            if (targetIndex < 0 || targetIndex >= allBlocks.length) return;

            // Remove block from current position
            block.remove();

            // Insert at target position
            if (targetIndex === 0) {
                canvas.insertBefore(block, allBlocks[0]);
            } else if (targetIndex >= allBlocks.length - 1) {
                canvas.appendChild(block);
            } else {
                canvas.insertBefore(block, allBlocks[targetIndex]);
            }

            // Smooth scroll and focus
            block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            block.focus();

            // Update button states
            updateBlockControlStates();

            // Refresh WBS numbers if enabled
            refreshWBS();
        }

        // Markdown preview toggle
        function toggleMarkdownPreview(blockId) {
            const block = document.getElementById(blockId);
            const editor = block.querySelector('.markdown-editor');
            const input = editor.querySelector('.markdown-input');
            const preview = editor.querySelector('.markdown-preview');
            const toggleBtn = block.querySelector('.markdown-preview-btn');
            const icon = toggleBtn.querySelector('i');

            const currentMode = toggleBtn.getAttribute('data-mode');

            if (currentMode === 'edit') {
                // Switch to preview mode
                const markdownText = input.value;

                // Save current scroll position as percentage
                const scrollPercentage = input.scrollTop / (input.scrollHeight - input.clientHeight);

                // Parse markdown using built-in parser
                preview.innerHTML = parseMarkdown(markdownText);

                input.style.display = 'none';
                preview.style.display = 'block';

                // Restore scroll position after content renders
                setTimeout(() => {
                    preview.scrollTop = scrollPercentage * (preview.scrollHeight - preview.clientHeight);
                }, 50);

                toggleBtn.setAttribute('data-mode', 'preview');
                toggleBtn.setAttribute('title', 'Back to edit');
                icon.className = 'ph ph-pencil-simple';
            } else {
                // Switch back to edit mode
                const scrollPercentage = preview.scrollTop / (preview.scrollHeight - preview.clientHeight);

                input.style.display = 'block';
                preview.style.display = 'none';

                // Restore scroll position
                setTimeout(() => {
                    input.scrollTop = scrollPercentage * (input.scrollHeight - input.clientHeight);
                }, 50);

                toggleBtn.setAttribute('data-mode', 'edit');
                toggleBtn.setAttribute('title', 'Toggle preview');
                icon.className = 'ph ph-eye';
            }
        }

        // Toggle Mermaid preview
        function toggleMermaidPreview(blockId) {
            const block = document.getElementById(blockId);
            const editArea = block.querySelector('.mermaid-edit-area');
            const previewArea = block.querySelector('.mermaid-preview-area');
            const textarea = editArea.querySelector('textarea');
            const renderDiv = previewArea.querySelector('.mermaid-render');
            const toggleBtn = block.querySelector('.mermaid-preview-btn');
            const icon = toggleBtn.querySelector('i');

            const currentMode = toggleBtn.getAttribute('data-mode');

            if (currentMode === 'edit') {
                // Switch to preview mode
                const mermaidText = textarea.value;

                // Check if Mermaid is loaded
                if (typeof mermaid !== 'undefined') {
                    // Clear previous diagram
                    renderDiv.innerHTML = '';

                    // Generate unique ID for this diagram
                    const diagramId = 'mermaid-' + blockId + '-' + Date.now();

                    try {
                        // Render the mermaid diagram
                        mermaid.render(diagramId, mermaidText).then(result => {
                            renderDiv.innerHTML = result.svg;
                        }).catch(error => {
                            renderDiv.innerHTML = `<div style="color: red; font-family: var(--font-family-body); font-size: 13px; padding: 20px;">
                                <i class="ph ph-warning-circle" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                                <strong>Diagram Error:</strong><br>${error.message || 'Invalid Mermaid syntax'}
                            </div>`;
                        });
                    } catch (error) {
                        renderDiv.innerHTML = `<div style="color: red; font-family: var(--font-family-body); font-size: 13px; padding: 20px;">
                            <i class="ph ph-warning-circle" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                            <strong>Diagram Error:</strong><br>${error.message || 'Invalid Mermaid syntax'}
                        </div>`;
                    }
                } else {
                    renderDiv.innerHTML = '<p style="color: red; font-family: var(--font-family-body); font-size: 13px;">Mermaid library not loaded</p>';
                }

                editArea.style.display = 'none';
                previewArea.style.display = 'block';
                toggleBtn.setAttribute('data-mode', 'preview');
                toggleBtn.setAttribute('title', 'Back to edit');
                icon.className = 'ph ph-pencil-simple';
            } else {
                // Switch back to edit mode
                editArea.style.display = 'block';
                previewArea.style.display = 'none';
                toggleBtn.setAttribute('data-mode', 'edit');
                toggleBtn.setAttribute('title', 'Toggle preview');
                icon.className = 'ph ph-eye';
            }
        }

        // Toggle KaTeX preview
        function toggleLatexPreview(blockId) {
            const block = document.getElementById(blockId);
            const editArea = block.querySelector('.latex-edit-area');
            const previewArea = block.querySelector('.latex-preview-area');
            const textarea = editArea.querySelector('textarea');
            const renderDiv = previewArea.querySelector('.latex-render');
            const toggleBtn = block.querySelector('.latex-preview-btn');
            const icon = toggleBtn.querySelector('i');

            const currentMode = toggleBtn.getAttribute('data-mode');

            if (currentMode === 'edit') {
                // Switch to preview mode
                const latexText = textarea.value;

                // Check if KaTeX is loaded
                if (typeof katex !== 'undefined') {
                    try {
                        // Render the LaTeX using KaTeX
                        renderDiv.innerHTML = '';
                        katex.render(latexText, renderDiv, {
                            throwOnError: false,
                            displayMode: true,
                            output: 'html',
                            trust: false
                        });
                    } catch (error) {
                        renderDiv.innerHTML = `<div style="color: red; font-family: var(--font-family-body); font-size: 13px; padding: 20px;">
                            <i class="ph ph-warning-circle" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                            <strong>KaTeX Error:</strong><br>${error.message || 'Invalid KaTeX syntax'}
                        </div>`;
                    }
                } else {
                    renderDiv.innerHTML = '<p style="color: red; font-family: var(--font-family-body); font-size: 13px;">KaTeX library not loaded</p>';
                }

                editArea.style.display = 'none';
                previewArea.style.display = 'block';
                toggleBtn.setAttribute('data-mode', 'preview');
                toggleBtn.setAttribute('title', 'Back to edit');
                icon.className = 'ph ph-pencil-simple';
            } else {
                // Switch back to edit mode
                editArea.style.display = 'block';
                previewArea.style.display = 'none';
                toggleBtn.setAttribute('data-mode', 'edit');
                toggleBtn.setAttribute('title', 'Toggle preview');
                icon.className = 'ph ph-eye';
            }
        }

        // Draw.io diagram functions
        function openDrawioEditor(blockId) {
            const block = document.getElementById(blockId);
            const diagramData = block.querySelector('.diagram-data').value;

            // Create modal for draw.io editor
            const modal = document.createElement('div');
            modal.id = 'drawio-modal-' + blockId;
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const editorContainer = document.createElement('div');
            editorContainer.style.cssText = `
                width: 90%;
                height: 90%;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            `;

            // Header with save/cancel buttons
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 16px;
                background: var(--color-dark);
                color: white;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            header.innerHTML = `
                <h3 style="margin: 0; font-family: var(--font-family-ui); font-size: 16px;">Edit Diagram</h3>
                <div style="display: flex; gap: 8px;">
                    <button onclick="saveDrawioDiagram('${blockId}')" style="padding: 8px 16px; background: var(--color-primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-family: var(--font-family-ui); font-size: 13px;">
                        <i class="ph ph-check" style="margin-right: 4px;"></i>Save
                    </button>
                    <button onclick="closeDrawioEditor('${blockId}')" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: var(--font-family-ui); font-size: 13px;">
                        <i class="ph ph-x" style="margin-right: 4px;"></i>Cancel
                    </button>
                </div>
            `;

            // Draw.io iframe with embed mode
            const iframe = document.createElement('iframe');
            iframe.id = 'drawio-iframe-' + blockId;
            iframe.style.cssText = 'flex: 1; border: none;';

            // Use draw.io embed mode with simplified UI
            let drawioUrl = 'https://embed.diagrams.net/?embed=1&ui=min&spin=1&proto=json';

            // If we have existing diagram data, load it
            if (diagramData) {
                drawioUrl += '&xml=' + encodeURIComponent(diagramData);
            }

            iframe.src = drawioUrl;

            editorContainer.appendChild(header);
            editorContainer.appendChild(iframe);
            modal.appendChild(editorContainer);
            document.body.appendChild(modal);

            // Listen for messages from draw.io
            window.addEventListener('message', function drawioMessageHandler(evt) {
                if (evt.data.length > 0) {
                    try {
                        const msg = JSON.parse(evt.data);

                        // Handle different draw.io events
                        if (msg.event === 'init') {
                            // Draw.io is ready
                            iframe.contentWindow.postMessage(JSON.stringify({action: 'load', autosave: 1}), '*');
                        } else if (msg.event === 'export') {
                            // Diagram exported, store the data
                            const dataInput = block.querySelector('.diagram-data');
                            dataInput.value = msg.data;
                        }
                    } catch (e) {
                        // Ignore non-JSON messages
                    }
                }
            });
        }

        function saveDrawioDiagram(blockId) {
            const block = document.getElementById(blockId);
            const modal = document.getElementById('drawio-modal-' + blockId);
            const iframe = document.getElementById('drawio-iframe-' + blockId);

            // Request export from draw.io
            iframe.contentWindow.postMessage(JSON.stringify({
                action: 'export',
                format: 'xmlsvg',
                xml: true,
                spin: 'Saving diagram...'
            }), '*');

            // Wait a bit for the export, then close and update preview
            setTimeout(() => {
                const diagramData = block.querySelector('.diagram-data').value;

                if (diagramData) {
                    // Update preview with SVG
                    const preview = block.querySelector('.diagram-preview');

                    // Extract SVG from the XML data
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(diagramData, 'text/xml');
                    const svgElement = xmlDoc.querySelector('svg');

                    if (svgElement) {
                        preview.innerHTML = svgElement.outerHTML;
                        preview.querySelector('svg').style.maxWidth = '100%';
                        preview.querySelector('svg').style.height = 'auto';
                    } else {
                        preview.innerHTML = '<p style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-neutral-text);">Diagram saved successfully.</p>';
                    }
                }

                closeDrawioEditor(blockId);
            }, 1000);
        }

        function closeDrawioEditor(blockId) {
            const modal = document.getElementById('drawio-modal-' + blockId);
            if (modal) {
                modal.remove();
            }
        }

        function clearDiagram(blockId) {
            if (confirm('Are you sure you want to clear this diagram?')) {
                const block = document.getElementById(blockId);
                const dataInput = block.querySelector('.diagram-data');
                const preview = block.querySelector('.diagram-preview');

                dataInput.value = '';
                preview.innerHTML = `
                    <div style="text-align: center; color: var(--color-neutral-text-light);">
                        <i class="ph ph-flow-arrow" style="font-size: 48px;"></i>
                        <p style="font-family: var(--font-family-body); font-size: 13px; margin: 12px 0 0 0;">No diagram yet. Click "Edit Diagram" to create one.</p>
                    </div>
                `;
            }
        }

        // WBS toggle function
        let wbsEnabled = false;

        function toggleWBS() {
            wbsEnabled = !wbsEnabled;
            const toggle = document.getElementById('wbs-toggle');
            const toggleSwitch = toggle.querySelector('div');

            if (wbsEnabled) {
                // Turn on WBS view
                toggle.style.background = 'var(--color-primary-blue)';
                toggleSwitch.style.left = '18px';

                // Update WBS numbers on all headers
                updateWBSNumbers();
            } else {
                // Turn off WBS view
                toggle.style.background = '#ccc';
                toggleSwitch.style.left = '2px';

                // Remove WBS numbers from all headers
                removeWBSNumbers();
            }
        }

        function updateWBSNumbers() {
            const canvas = document.getElementById('documentCanvas');
            const blocks = canvas.querySelectorAll('.document-block');

            // Track counters for each level
            const counters = [0, 0, 0, 0, 0, 0]; // Support up to 6 levels (h1-h6)

            blocks.forEach(block => {
                const blockType = block.getAttribute('data-block-type');

                if (blockType === 'header') {
                    const select = block.querySelector('select');
                    const input = block.querySelector('input[type="text"]');

                    if (select && input) {
                        const level = parseInt(select.value);

                        // Increment counter for this level
                        counters[level - 1]++;

                        // Reset all deeper level counters
                        for (let i = level; i < counters.length; i++) {
                            counters[i] = 0;
                        }

                        // Build WBS number string (e.g., "1.2.3")
                        let wbsNumber = '';
                        for (let i = 0; i < level; i++) {
                            if (counters[i] > 0) {
                                wbsNumber += (wbsNumber ? '.' : '') + counters[i];
                            }
                        }

                        // Add or update WBS number span
                        let wbsSpan = block.querySelector('.wbs-number');
                        if (!wbsSpan) {
                            wbsSpan = document.createElement('span');
                            wbsSpan.className = 'wbs-number';
                            wbsSpan.style.cssText = `
                                display: inline-block;
                                margin-right: 8px;
                                padding: 2px 8px;
                                background: var(--color-primary-blue);
                                color: white;
                                border-radius: 4px;
                                font-family: var(--font-family-ui);
                                font-size: 11px;
                                font-weight: 600;
                                flex-shrink: 0;
                            `;

                            // Insert before the input field in the container
                            const container = block.querySelector('.header-input-container');
                            if (container) {
                                container.insertBefore(wbsSpan, input);
                            }
                        }

                        wbsSpan.textContent = wbsNumber;
                    }
                }
            });
        }

        function removeWBSNumbers() {
            const canvas = document.getElementById('documentCanvas');
            const wbsNumbers = canvas.querySelectorAll('.wbs-number');

            wbsNumbers.forEach(span => {
                span.remove();
            });
        }

        // Update WBS numbers when blocks are added, moved, or removed
        function refreshWBS() {
            if (wbsEnabled) {
                updateWBSNumbers();
            }
            updateTableOfContents();
        }

        // Table of Contents generation
        function updateTableOfContents() {
            const canvas = document.getElementById('documentCanvas');
            const tocBlocks = canvas.querySelectorAll('[data-block-type="toc"]');

            // If no TOC blocks, exit early
            if (tocBlocks.length === 0) return;

            // Gather all headers from the document
            const headerBlocks = canvas.querySelectorAll('[data-block-type="header"]');
            const headers = [];

            headerBlocks.forEach(block => {
                const select = block.querySelector('select');
                const input = block.querySelector('input[type="text"]');
                const wbsSpan = block.querySelector('.wbs-number');

                if (select && input && input.value.trim()) {
                    const level = parseInt(select.value);
                    const text = input.value.trim();
                    const wbsNumber = wbsSpan ? wbsSpan.textContent : '';

                    headers.push({
                        level: level,
                        text: text,
                        wbsNumber: wbsNumber
                    });
                }
            });

            // Update all TOC blocks
            tocBlocks.forEach(tocBlock => {
                const tocContent = tocBlock.querySelector('.toc-content');

                if (headers.length === 0) {
                    // Show empty state
                    tocContent.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--color-neutral-text-light);">
                            <i class="ph ph-file-dashed" style="font-size: 32px; margin-bottom: 8px;"></i>
                            <p style="margin: 0; font-size: 13px;">Add headers to your document to generate the table of contents</p>
                        </div>
                    `;
                } else {
                    // Generate TOC entries
                    let tocHTML = '';
                    headers.forEach((header, index) => {
                        const indent = (header.level - 1) * 20;
                        const prefix = wbsEnabled && header.wbsNumber ? `${header.wbsNumber} ` : '';

                        tocHTML += `
                            <div style="margin-left: ${indent}px; margin-bottom: 8px; cursor: pointer; transition: color 0.2s;"
                                 onmouseover="this.style.color='var(--color-primary-blue)'"
                                 onmouseout="this.style.color='var(--color-neutral-text)'">
                                <span style="font-weight: ${header.level <= 2 ? '600' : '400'};">
                                    ${prefix}${header.text}
                                </span>
                            </div>
                        `;
                    });

                    tocContent.innerHTML = tocHTML;
                }
            });
        }

        // Table creation functions
        function createCleansheetTable(blockId) {
            alert('Create Cleansheet Table functionality coming soon!\n\nThis will allow you to build a new table from scratch with custom columns and rows.');
            // TODO: Implement table creation interface
        }

        function connectCleansheetTable(blockId) {
            alert('Connect Cleansheet Table functionality coming soon!\n\nThis will allow you to link to an existing Cleansheet table in your workspace.');
            // TODO: Implement table connection interface
        }

        function connectDataSource(blockId) {
            // Store the block ID for later use when connection is established
            window.currentTableBlockId = blockId;

            // Open the data source selection modal
            const modal = document.getElementById('dataSourceModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeDataSourceModal() {
            const modal = document.getElementById('dataSourceModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function toggleDataSourceCategory(category) {
            const content = document.getElementById(`${category}-content`);
            const caret = document.getElementById(`${category}-caret`);

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                caret.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                caret.style.transform = 'rotate(0deg)';
            }
        }

        function selectDataSource(category, source) {
            // Store selected source for configuration
            window.selectedDataSource = { category, source };

            // Close selection modal and open configuration modal
            closeDataSourceModal();
            openDataSourceConfig(category, source);
        }

        function openDataSourceConfig(category, source) {
            const modal = document.getElementById('dataSourceConfigModal');
            const titleEl = document.getElementById('dataSourceConfigTitle');
            const formEl = document.getElementById('dataSourceConfigForm');

            titleEl.textContent = `Configure ${source}`;

            // Generate form fields based on category and source
            formEl.innerHTML = getDataSourceConfigFields(category, source);

            modal.style.display = 'flex';
        }

        function closeDataSourceConfig() {
            const modal = document.getElementById('dataSourceConfigModal');
            modal.style.display = 'none';
        }

        function getDataSourceConfigFields(category, source) {
            let fields = '';

            // Common authentication section
            fields += '<div style="margin-bottom: 24px;">';
            fields += '<h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.5px;">Authentication</h3>';

            // Category-specific authentication fields
            if (category === 'CRM & ERP') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Authentication Method</label>
                        <select id="authMethod" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="oauth">OAuth 2.0</option>
                            <option value="apikey">API Key</option>
                            <option value="credentials">Username/Password</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Instance URL</label>
                        <input type="text" id="instanceUrl" placeholder="https://your-instance.salesforce.com" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Client ID</label>
                        <input type="text" id="clientId" placeholder="Enter client ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Client Secret</label>
                        <input type="password" id="clientSecret" placeholder="Enter client secret" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Data Services') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Authentication Method</label>
                        <select id="authMethod" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="serviceaccount">Service Account</option>
                            <option value="accesskey">Access Key</option>
                            <option value="connectionstring">Connection String</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Account/Project ID</label>
                        <input type="text" id="accountId" placeholder="Enter account or project ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Region</label>
                        <input type="text" id="region" placeholder="us-east-1, us-central1, etc." style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Access Key / Credentials</label>
                        <textarea id="credentials" placeholder="Paste credentials JSON or access key" style="width: 100%; min-height: 80px; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    </div>
                `;
            } else if (category === 'File Services') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Authentication Method</label>
                        <select id="authMethod" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="oauth">OAuth 2.0</option>
                            <option value="token">Access Token</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Access Token</label>
                        <input type="password" id="accessToken" placeholder="Enter access token" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Finance') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">API Key</label>
                        <input type="password" id="apiKey" placeholder="Enter API key" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Terminal ID / User ID</label>
                        <input type="text" id="terminalId" placeholder="Enter terminal or user ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Payments') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Environment</label>
                        <select id="environment" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="sandbox">Sandbox (Test)</option>
                            <option value="live">Live (Production)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">API Key</label>
                        <input type="password" id="apiKey" placeholder="Enter API key" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Secret Key</label>
                        <input type="password" id="secretKey" placeholder="Enter secret key" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Healthcare') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">FHIR Base URL</label>
                        <input type="text" id="fhirUrl" placeholder="https://fhir.example.com/api/FHIR/R4" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Client ID</label>
                        <input type="text" id="clientId" placeholder="Enter client ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Client Secret</label>
                        <input type="password" id="clientSecret" placeholder="Enter client secret" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Practice ID</label>
                        <input type="text" id="practiceId" placeholder="Enter practice ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Retail & Ecommerce') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Store URL</label>
                        <input type="text" id="storeUrl" placeholder="https://your-store.myshopify.com" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">API Key / Access Token</label>
                        <input type="password" id="apiKey" placeholder="Enter API key or access token" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">API Version</label>
                        <input type="text" id="apiVersion" placeholder="2024-01" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            } else if (category === 'Insurance') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Environment URL</label>
                        <input type="text" id="environmentUrl" placeholder="https://api.example.com" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Tenant ID</label>
                        <input type="text" id="tenantId" placeholder="Enter tenant ID" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Username</label>
                        <input type="text" id="username" placeholder="Enter username" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Password</label>
                        <input type="password" id="password" placeholder="Enter password" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                `;
            }

            fields += '</div>'; // End authentication section

            // Query/Data Selection section
            fields += '<div style="margin-bottom: 24px;">';
            fields += '<h3 style="font-family: var(--font-family-ui); font-size: 14px; font-weight: 600; color: var(--color-dark); margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.5px;">Data Selection</h3>';

            if (category === 'CRM & ERP') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Object/Entity Name</label>
                        <input type="text" id="objectName" placeholder="Account, Contact, Opportunity, etc." style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Fields to Import</label>
                        <input type="text" id="fields" placeholder="Id, Name, Email, Phone (comma-separated)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Filter Criteria (SOQL WHERE clause)</label>
                        <textarea id="filterCriteria" placeholder="CreatedDate > 2024-01-01" style="width: 100%; min-height: 60px; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    </div>
                `;
            } else if (category === 'Data Services') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Database/Schema</label>
                        <input type="text" id="database" placeholder="Enter database and schema name" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Query Type</label>
                        <select id="queryType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="table">Table/View</option>
                            <option value="sql">SQL Query</option>
                            <option value="file">File Path</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Table Name or SQL Query</label>
                        <textarea id="query" placeholder="SELECT * FROM table WHERE..." style="width: 100%; min-height: 80px; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    </div>
                `;
            } else if (category === 'File Services') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Folder Path</label>
                        <input type="text" id="folderPath" placeholder="/Documents/Data" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">File Name Pattern</label>
                        <input type="text" id="filePattern" placeholder="*.xlsx, sales_*.csv" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Search Recursively</label>
                        <input type="checkbox" id="recursive" style="margin-right: 8px;">
                        <span style="font-family: var(--font-family-body); font-size: 13px; color: var(--color-dark);">Include subfolders</span>
                    </div>
                `;
            } else if (category === 'Finance') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Security Identifiers</label>
                        <input type="text" id="securities" placeholder="AAPL, MSFT, GOOGL (comma-separated)" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Data Fields</label>
                        <input type="text" id="dataFields" placeholder="PX_LAST, VOLUME, HIGH, LOW" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Frequency</label>
                        <select id="frequency" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                `;
            } else if (category === 'Payments') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Transaction Type</label>
                        <select id="transactionType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="all">All Transactions</option>
                            <option value="charges">Charges</option>
                            <option value="refunds">Refunds</option>
                            <option value="payouts">Payouts</option>
                            <option value="disputes">Disputes</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Status Filter</label>
                        <select id="statusFilter" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="all">All</option>
                            <option value="succeeded">Succeeded</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                `;
            } else if (category === 'Healthcare') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">FHIR Resource Type</label>
                        <select id="resourceType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="Patient">Patient</option>
                            <option value="Observation">Observation</option>
                            <option value="Encounter">Encounter</option>
                            <option value="Condition">Condition</option>
                            <option value="MedicationRequest">MedicationRequest</option>
                            <option value="DiagnosticReport">DiagnosticReport</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Patient ID (Optional)</label>
                        <input type="text" id="patientId" placeholder="Leave blank for all patients" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                `;
            } else if (category === 'Retail & Ecommerce') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Resource Type</label>
                        <select id="resourceType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="orders">Orders</option>
                            <option value="products">Products</option>
                            <option value="customers">Customers</option>
                            <option value="inventory">Inventory</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Status Filter</label>
                        <select id="statusFilter" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="all">All</option>
                            <option value="open">Open</option>
                            <option value="closed">Closed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                `;
            } else if (category === 'Insurance') {
                fields += `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Query Type</label>
                        <select id="queryType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="policies">Policies</option>
                            <option value="claims">Claims</option>
                            <option value="quotes">Quotes</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Line of Business</label>
                        <select id="lineOfBusiness" style="width: 100%; padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <option value="all">All</option>
                            <option value="personal">Personal Auto</option>
                            <option value="commercial">Commercial Auto</option>
                            <option value="property">Property</option>
                            <option value="workers">Workers Comp</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-family: var(--font-family-ui); font-size: 12px; font-weight: 600; color: var(--color-dark); margin-bottom: 4px;">Date Range</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="date" id="startDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                            <input type="date" id="endDate" style="padding: 8px 10px; border: 1px solid var(--color-neutral-border); border-radius: 6px; font-family: var(--font-family-body); font-size: 13px;">
                        </div>
                    </div>
                `;
            }

            fields += '</div>'; // End data selection section

            return fields;
        }

        function saveDataSourceConfig() {
            const config = {
                source: window.selectedDataSource,
                // Collect all form values - in real implementation, gather all field values
                timestamp: new Date().toISOString()
            };

            console.log('Data Source Configuration:', config);
            alert('Connection configured successfully!\n\nConfiguration has been saved. Data will be imported into your table.');

            closeDataSourceConfig();

            // TODO: Actually save configuration and initiate data import
        }

        function handleDragStart(e) {
            draggedBlock = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');

            // Remove drag-over class from all blocks
            const canvas = document.getElementById('documentCanvas');
            const blocks = canvas.querySelectorAll('.document-block');
            blocks.forEach(block => block.classList.remove('drag-over'));

            draggedBlock = null;
            updateBlockControlStates();
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            if (this !== draggedBlock) {
                this.classList.add('drag-over');
            }

            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedBlock !== this) {
                const canvas = document.getElementById('documentCanvas');
                const allBlocks = Array.from(canvas.querySelectorAll('.document-block'));
                const draggedIndex = allBlocks.indexOf(draggedBlock);
                const targetIndex = allBlocks.indexOf(this);

                if (draggedIndex < targetIndex) {
                    // Insert after target
                    canvas.insertBefore(draggedBlock, this.nextSibling);
                } else {
                    // Insert before target
                    canvas.insertBefore(draggedBlock, this);
                }

                // Smooth scroll to moved block
                draggedBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Update button states and WBS numbers
                updateBlockControlStates();
                refreshWBS();
            }

            this.classList.remove('drag-over');
            return false;
        }

        // Canvas UI Tour with Driver.js + Audio Integration
        class CanvasTour {
            constructor() {
                this.driver = null;
                this.isActive = false;
                this.currentStep = 0;
            }

            async initTour() {
                // Preload audio files
                console.log('Preloading tour audio files...');
                await audioTourManager.preloadAllAudio();

                // Configure Driver.js tour steps
                this.driver = new Driver({
                    showProgress: true,
                    allowClose: true,
                    overlayClickNext: false,
                    doneBtnText: 'Finish Tour',
                    nextBtnText: 'Next',
                    prevBtnText: 'Previous',
                    onHighlightStarted: (element) => {
                        // Enhanced step tracking with multiple identification methods
                        const stepId = this.getCurrentStepId(element);
                        if (stepId) {
                            console.log(`Highlighting element for step: ${stepId}`);
                            audioTourManager.playNarration(stepId);
                        }
                    },
                    onNext: (element) => {
                        // Track step progression
                        this.currentStep = Math.min(this.currentStep + 1, this.tourSteps.length - 1);
                        this.onStepChanged(this.currentStep);
                    },
                    onPrevious: (element) => {
                        // Track step regression
                        this.currentStep = Math.max(this.currentStep - 1, 0);
                        this.onStepChanged(this.currentStep);
                    },
                    onDeselected: () => {
                        // Clean up on tour end
                        audioTourManager.stopAudio();
                        this.isActive = false;
                        this.currentStep = 0;
                        console.log('Tour ended, audio stopped');
                    }
                });

                this.defineSteps();
            }

            defineSteps() {
                const steps = [
                    {
                        element: '.canvas-modal-header',
                        popover: {
                            title: 'Welcome to Cleansheet Canvas',
                            description: 'This is your personal workspace for managing job search, professional projects, and career development. Let\'s take a quick tour of the key features!',
                            position: 'bottom'
                        },
                        stepId: 'welcome'
                    },
                    {
                        element: '[data-view="seeker"]',
                        popover: {
                            title: 'View Mode Selector',
                            description: 'Switch between different workspace modes: Job Seeker (job search focus), Learner (skill development), and Professional (work management).',
                            position: 'bottom'
                        },
                        stepId: 'view-modes'
                    },
                    {
                        element: '#canvas-mindmap',
                        popover: {
                            title: 'Interactive Mindmap',
                            description: 'Navigate your workspace using this interactive mindmap. Click on any node to expand sections like Job Opportunities, Career Experience, Goals, and Portfolio.',
                            position: 'right'
                        },
                        stepId: 'mindmap-navigation'
                    },
                    {
                        element: '.calendar-widget',
                        popover: {
                            title: 'Upcoming Events',
                            description: 'Track important dates like interviews, application deadlines, and networking events. Sync with your Outlook calendar for seamless integration.',
                            position: 'left'
                        },
                        stepId: 'calendar-widget'
                    },
                    {
                        element: '.ai-assistant-widget',
                        popover: {
                            title: 'AI Assistant',
                            description: 'Get personalized career advice, application tips, and skill development recommendations powered by AI insights.',
                            position: 'left'
                        },
                        stepId: 'ai-assistant'
                    },
                    {
                        element: '#jobSearchView',
                        popover: {
                            title: 'Job Search View',
                            description: 'Aggregate and filter job opportunities from multiple sources. Set up alerts, track applications, and manage your job search pipeline.',
                            position: 'center'
                        },
                        stepId: 'job-search-view'
                    },
                    {
                        element: '#projects-view',
                        popover: {
                            title: 'Professional Projects',
                            description: 'Organize documents, create forms, build reports, and manage workflows. Perfect for demonstrating your professional capabilities.',
                            position: 'center'
                        },
                        stepId: 'projects-view'
                    },
                    {
                        element: '.panel-collapse-toggle',
                        popover: {
                            title: 'Panel Controls',
                            description: 'Collapse or expand the side panel to focus on the mindmap or maximize your workspace area.',
                            position: 'left'
                        },
                        stepId: 'panel-controls'
                    }
                ];

                // Convert steps to Driver.js format
                const driverSteps = steps.map(step => ({
                    element: step.element,
                    popover: step.popover
                }));

                this.driver.defineSteps(driverSteps);
                this.tourSteps = steps;
            }

            getCurrentStepId(element) {
                if (!this.tourSteps || !element) return null;

                // Try multiple approaches to identify the current step
                let stepIndex = -1;

                // Method 1: Match by element selector
                for (let i = 0; i < this.tourSteps.length; i++) {
                    const stepElement = document.querySelector(this.tourSteps[i].element);
                    if (stepElement === element || stepElement?.contains(element)) {
                        stepIndex = i;
                        break;
                    }
                }

                // Method 2: Match by Driver.js step index if available
                if (stepIndex === -1 && this.driver.getCurrentStep) {
                    stepIndex = this.driver.getCurrentStep();
                }

                // Method 3: Use step counter as fallback
                if (stepIndex === -1) {
                    stepIndex = this.currentStep;
                }

                // Ensure valid index
                if (stepIndex >= 0 && stepIndex < this.tourSteps.length) {
                    return this.tourSteps[stepIndex].stepId;
                }

                return null;
            }

            // Enhanced step tracking
            onStepChanged(stepIndex) {
                this.currentStep = stepIndex;
                const stepId = this.tourSteps[stepIndex]?.stepId;

                if (stepId) {
                    console.log(`Tour step changed to: ${stepId} (${stepIndex + 1}/${this.tourSteps.length})`);
                    // Trigger audio playback
                    audioTourManager.playNarration(stepId);

                    // Update tour controls progress
                    if (tourControls.isVisible) {
                        tourControls.updateProgress();
                    }
                }
            }

            async startTour() {
                if (!this.driver) {
                    await this.initTour();
                }

                if (this.driver) {
                    this.isActive = true;
                    this.driver.start();
                    console.log('Canvas tour started');
                }
            }

            stopTour() {
                if (this.driver && this.isActive) {
                    audioTourManager.stopAudio();
                    this.driver.reset();
                    this.isActive = false;
                    this.currentStep = 0;
                    console.log('Canvas tour stopped');
                }
            }

            // Jump to specific step (useful for dynamic navigation)
            goToStep(stepIndex) {
                if (!this.driver || !this.isActive) return false;

                if (stepIndex >= 0 && stepIndex < this.tourSteps.length) {
                    this.currentStep = stepIndex;
                    // Driver.js doesn't have a direct goToStep method, but we can track manually
                    this.onStepChanged(stepIndex);
                    return true;
                }
                return false;
            }

            // Get current tour progress
            getProgress() {
                return {
                    currentStep: this.currentStep,
                    totalSteps: this.tourSteps?.length || 0,
                    stepId: this.tourSteps?.[this.currentStep]?.stepId || null,
                    isActive: this.isActive,
                    progressPercent: this.tourSteps ? Math.round((this.currentStep / (this.tourSteps.length - 1)) * 100) : 0
                };
            }

            // Validate tour step elements exist in DOM
            validateSteps() {
                if (!this.tourSteps) return { valid: false, errors: ['No steps defined'] };

                const errors = [];
                let validSteps = 0;

                this.tourSteps.forEach((step, index) => {
                    const element = document.querySelector(step.element);
                    if (!element) {
                        errors.push(`Step ${index + 1} (${step.stepId}): Element '${step.element}' not found`);
                    } else {
                        validSteps++;
                    }
                });

                return {
                    valid: errors.length === 0,
                    validSteps,
                    totalSteps: this.tourSteps.length,
                    errors
                };
            }
        }

        // Simple Guidance Tooltip System
        //
        // This system provides basic explanatory tooltips to guide users throughout the UI.
        // Example: "Opportunities you are pursuing appear here"
        //
        // Usage:
        // 1. Call addGuidanceTooltip(selector, text) to add tooltip to any element
        // 2. Tooltips automatically show on hover and hide on mouse leave
        // 3. Uses dark background with white text for clear visibility
        // 4. Positions automatically to stay within viewport bounds
        //
        // Pattern for expanding throughout the UI:
        // addGuidanceTooltip('#elementId', 'Helpful explanation text');
        // addGuidanceTooltip('.className', 'What this section does');
        //
        class GuidanceTooltip {
            constructor() {
                this.tooltip = null;
                this.createTooltip();
            }

            createTooltip() {
                this.tooltip = document.createElement('div');
                this.tooltip.id = 'guidance-tooltip';
                this.tooltip.style.cssText = `
                    position: absolute;
                    background: var(--color-dark);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-family: var(--font-family-body);
                    font-size: 12px;
                    line-height: 1.4;
                    max-width: 250px;
                    z-index: 10000;
                    pointer-events: none;
                    opacity: 0;
                    transform: translateY(-4px);
                    transition: opacity 0.2s ease, transform 0.2s ease;
                    display: none;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                `;

                document.body.appendChild(this.tooltip);
            }

            show(text, x, y) {
                console.log('Tooltip show() called with:', { text, x, y });
                console.log('Tooltip element exists:', !!this.tooltip);

                if (!this.tooltip || !text) {
                    console.warn('Tooltip show() early return - tooltip or text missing');
                    return;
                }

                this.tooltip.textContent = text;
                this.tooltip.style.display = 'block';
                console.log('Tooltip display set to block, content set');

                // Position tooltip
                const rect = this.tooltip.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                let tooltipX = x + 10;
                let tooltipY = y - 35;

                // Keep tooltip within viewport bounds
                if (tooltipX + rect.width > viewportWidth) {
                    tooltipX = x - rect.width - 10;
                }

                if (tooltipY < 0) {
                    tooltipY = y + 20;
                }

                this.tooltip.style.left = `${tooltipX}px`;
                this.tooltip.style.top = `${tooltipY}px`;
                console.log('Tooltip positioned at:', { tooltipX, tooltipY });

                // Animate in
                requestAnimationFrame(() => {
                    this.tooltip.style.opacity = '1';
                    this.tooltip.style.transform = 'translateY(0)';
                    console.log('Tooltip animation applied - should be visible now');
                });
            }

            hide() {
                if (!this.tooltip) return;

                this.tooltip.style.opacity = '0';
                this.tooltip.style.transform = 'translateY(-4px)';

                setTimeout(() => {
                    this.tooltip.style.display = 'none';
                }, 200);
            }
        }

        // Initialize simple guidance tooltip system
        const guidanceTooltip = new GuidanceTooltip();

        // Debug: Test tooltip functionality
        console.log('Guidance tooltip system initialized:', guidanceTooltip);

        // Helper function to add guidance tooltips to any element
        function addGuidanceTooltip(selector, text) {
            console.log('Adding guidance tooltip to:', selector, 'with text:', text);
            const element = document.querySelector(selector);

            if (!element) {
                console.warn('Element not found for selector:', selector);
                return;
            }

            console.log('Element found:', element);

            element.addEventListener('mouseenter', (event) => {
                console.log('Mouse entered element, showing tooltip:', text);
                guidanceTooltip.show(text, event.pageX, event.pageY);
            });

            element.addEventListener('mouseleave', () => {
                console.log('Mouse left element, hiding tooltip');
                guidanceTooltip.hide();
            });

            // Update cursor to indicate tooltip
            element.style.cursor = 'help';
            console.log('Tooltip event listeners added successfully');
        }

        // Example: Add tooltips to other UI elements (can be expanded throughout the app)
        function initializeUIGuidance() {
            // Test with a simple element first
            setTimeout(() => {
                console.log('Initializing UI Guidance...');

                // Simple test - add tooltip to canvas header title
                addGuidanceTooltip('.canvas-modal-header h2', 'This is your personal workspace for career management');

                // View mode and persona selectors have been removed

                console.log('UI Guidance initialization completed');
            }, 1000);
        }

        // Initialize tour manager
        const canvasTour = new CanvasTour();

        // Tour Controls UI Component
        class TourControls {
            constructor() {
                this.controlsContainer = null;
                this.isVisible = false;
            }

            create() {
                if (this.controlsContainer) return;

                this.controlsContainer = document.createElement('div');
                this.controlsContainer.id = 'tourControls';
                this.controlsContainer.className = 'tour-controls';
                this.controlsContainer.innerHTML = `
                    <div class="tour-controls-header">
                        <div class="tour-progress">
                            <span class="tour-step-counter">Step 1 of 8</span>
                            <div class="tour-progress-bar">
                                <div class="tour-progress-fill"></div>
                            </div>
                        </div>
                        <button class="tour-minimize-btn" onclick="tourControls.toggle()">
                            <i class="ph ph-caret-down"></i>
                        </button>
                    </div>
                    <div class="tour-controls-body">
                        <div class="audio-controls">
                            <button id="audioPlayPause" class="audio-btn" onclick="tourControls.toggleAudio()">
                                <i class="ph ph-pause"></i>
                            </button>
                            <button id="audioStop" class="audio-btn" onclick="tourControls.stopAudio()">
                                <i class="ph ph-stop"></i>
                            </button>
                            <div class="volume-control">
                                <i class="ph ph-speaker-simple-high"></i>
                                <input type="range" id="volumeSlider" min="0" max="100" value="80"
                                       oninput="tourControls.setVolume(this.value)">
                            </div>
                        </div>
                        <div class="tour-navigation">
                            <button id="tourPrev" class="nav-btn" onclick="tourControls.previousStep()">
                                <i class="ph ph-caret-left"></i> Previous
                            </button>
                            <button id="tourNext" class="nav-btn" onclick="tourControls.nextStep()">
                                Next <i class="ph ph-caret-right"></i>
                            </button>
                            <button id="tourEnd" class="end-btn" onclick="tourControls.endTour()">
                                End Tour
                            </button>
                        </div>
                    </div>
                `;

                // Add styles
                const style = document.createElement('style');
                style.textContent = `
                    .tour-controls {
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                        border: 1px solid var(--color-neutral-border);
                        width: 320px;
                        z-index: 10100;
                        font-family: var(--font-family-ui);
                        transition: all 0.3s ease;
                    }

                    .tour-controls.minimized .tour-controls-body {
                        display: none;
                    }

                    .tour-controls.minimized .tour-minimize-btn i {
                        transform: rotate(180deg);
                    }

                    .tour-controls-header {
                        padding: 12px 16px;
                        border-bottom: 1px solid var(--color-neutral-border);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 12px;
                    }

                    .tour-progress {
                        flex: 1;
                    }

                    .tour-step-counter {
                        font-size: 11px;
                        font-weight: 600;
                        color: var(--color-neutral-text);
                        display: block;
                        margin-bottom: 4px;
                    }

                    .tour-progress-bar {
                        width: 100%;
                        height: 4px;
                        background: var(--color-neutral-border);
                        border-radius: 2px;
                        overflow: hidden;
                    }

                    .tour-progress-fill {
                        height: 100%;
                        background: var(--color-primary-blue);
                        transition: width 0.3s ease;
                        width: 12.5%;
                    }

                    .tour-minimize-btn {
                        background: none;
                        border: none;
                        color: var(--color-neutral-text);
                        cursor: pointer;
                        padding: 4px;
                        border-radius: 4px;
                        font-size: 16px;
                        transition: all 0.2s ease;
                    }

                    .tour-minimize-btn:hover {
                        background: var(--color-neutral-background);
                    }

                    .tour-controls-body {
                        padding: 16px;
                    }

                    .audio-controls {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 16px;
                        padding-bottom: 16px;
                        border-bottom: 1px solid var(--color-neutral-border);
                    }

                    .audio-btn {
                        width: 32px;
                        height: 32px;
                        border-radius: 6px;
                        border: 1px solid var(--color-neutral-border);
                        background: white;
                        color: var(--color-neutral-text);
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        transition: all 0.2s ease;
                    }

                    .audio-btn:hover {
                        border-color: var(--color-primary-blue);
                        color: var(--color-primary-blue);
                    }

                    .volume-control {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex: 1;
                    }

                    .volume-control i {
                        color: var(--color-neutral-text);
                        font-size: 16px;
                    }

                    #volumeSlider {
                        flex: 1;
                        height: 4px;
                        background: var(--color-neutral-border);
                        border-radius: 2px;
                        outline: none;
                        cursor: pointer;
                    }

                    .tour-navigation {
                        display: flex;
                        gap: 8px;
                    }

                    .nav-btn, .end-btn {
                        padding: 8px 12px;
                        border-radius: 6px;
                        border: 1px solid var(--color-neutral-border);
                        background: white;
                        color: var(--color-neutral-text);
                        font-family: var(--font-family-ui);
                        font-size: 12px;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                        transition: all 0.2s ease;
                    }

                    .nav-btn:hover {
                        border-color: var(--color-primary-blue);
                        color: var(--color-primary-blue);
                    }

                    .end-btn {
                        background: #dc2626;
                        border-color: #dc2626;
                        color: white;
                        margin-left: auto;
                    }

                    .end-btn:hover {
                        background: #b91c1c;
                        border-color: #b91c1c;
                    }
                `;

                document.head.appendChild(style);
                document.body.appendChild(this.controlsContainer);
            }

            show() {
                if (!this.controlsContainer) this.create();
                this.controlsContainer.style.display = 'block';
                this.isVisible = true;
                this.updateProgress();
            }

            hide() {
                if (this.controlsContainer) {
                    this.controlsContainer.style.display = 'none';
                    this.isVisible = false;
                }
            }

            toggle() {
                if (this.controlsContainer) {
                    this.controlsContainer.classList.toggle('minimized');
                }
            }

            updateProgress() {
                if (!this.controlsContainer) return;

                const progress = canvasTour.getProgress();
                const counter = this.controlsContainer.querySelector('.tour-step-counter');
                const progressFill = this.controlsContainer.querySelector('.tour-progress-fill');

                if (counter) {
                    counter.textContent = `Step ${progress.currentStep + 1} of ${progress.totalSteps}`;
                }

                if (progressFill) {
                    progressFill.style.width = `${progress.progressPercent}%`;
                }
            }

            toggleAudio() {
                const btn = document.getElementById('audioPlayPause');
                const icon = btn.querySelector('i');

                if (audioTourManager.isAudioPlaying()) {
                    audioTourManager.stopAudio();
                    icon.className = 'ph ph-play';
                } else {
                    const progress = canvasTour.getProgress();
                    if (progress.stepId) {
                        audioTourManager.playNarration(progress.stepId);
                        icon.className = 'ph ph-pause';
                    }
                }
            }

            stopAudio() {
                audioTourManager.stopAudio();
                const btn = document.getElementById('audioPlayPause');
                const icon = btn.querySelector('i');
                icon.className = 'ph ph-play';
            }

            setVolume(value) {
                const volume = value / 100;
                audioTourManager.setVolume(volume);
            }

            previousStep() {
                // Driver.js handles the actual navigation
                if (canvasTour.driver && canvasTour.isActive) {
                    canvasTour.driver.movePrevious();
                }
            }

            nextStep() {
                // Driver.js handles the actual navigation
                if (canvasTour.driver && canvasTour.isActive) {
                    canvasTour.driver.moveNext();
                }
            }

            endTour() {
                canvasTour.stopTour();
                this.hide();
            }
        }

        // Initialize tour controls
        const tourControls = new TourControls();

        // Global functions for manual tour control (available in browser console)
        window.startCanvasTour = function() {
            console.log('Manual tour start requested');
            canvasTour.startTour();
            tourControls.show();
        };

        window.addTourButtonManually = function() {
            console.log('Manual button addition requested');
            addTourButton();
        };

        window.debugTourState = function() {
            console.log('Tour Debug Info:');
            console.log('- Canvas Tour:', canvasTour);
            console.log('- Audio Manager:', audioTourManager);
            console.log('- Tour Controls:', tourControls);
            console.log('- Tour Button Exists:', !!document.getElementById('startTourBtn'));
            console.log('- Canvas Header Elements:', document.querySelectorAll('[class*="header"]'));

            const validation = canvasTour.validateSteps?.() || { valid: false, errors: ['Tour not initialized'] };
            console.log('- Step Validation:', validation);
        };

        // Global function for adding guidance tooltips anywhere in the UI
        window.addGuidanceTooltip = addGuidanceTooltip;

        // Debug function to test tooltip manually
        window.testTooltip = function(x = 200, y = 200) {
            console.log('Manual tooltip test starting...');
            guidanceTooltip.show('Test tooltip - this should be visible!', x, y);

            setTimeout(() => {
                console.log('Hiding test tooltip...');
                guidanceTooltip.hide();
            }, 3000);
        };

        // Debug function to show tooltip at current mouse position
        window.showTooltipAtMouse = function(event) {
            const x = event?.pageX || 300;
            const y = event?.pageY || 300;
            console.log('Showing tooltip at mouse position:', x, y);
            guidanceTooltip.show('Mouse position tooltip test', x, y);
        };

        // Add tour control button to canvas header
        function addTourButton() {
            console.log('Attempting to add tour button...');

            // Try multiple selectors to find the header
            const selectors = ['.canvas-modal-header', '.canvas-header'];
            let canvasHeader = null;

            for (const selector of selectors) {
                canvasHeader = document.querySelector(selector);
                if (canvasHeader) {
                    console.log(`Found canvas header using selector: ${selector}`);
                    break;
                }
            }

            if (!canvasHeader) {
                console.error('Canvas header not found! Available elements:', document.querySelectorAll('[class*="header"]'));
                return;
            }

            if (document.getElementById('startTourBtn')) {
                console.log('Tour button already exists');
                return;
            }

            console.log('Creating tour button...');
            const tourButton = document.createElement('button');
            tourButton.id = 'startTourBtn';
            tourButton.className = 'tour-btn';
            tourButton.innerHTML = '<i class="ph ph-play"></i> Start Tour';
            tourButton.style.cssText = `
                padding: 8px 12px;
                background: var(--color-primary-blue);
                color: white;
                border: none;
                border-radius: 6px;
                font-family: var(--font-family-ui);
                font-size: 12px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 4px;
                cursor: pointer;
                margin-left: 12px;
                white-space: nowrap;
            `;

            tourButton.addEventListener('click', () => {
                console.log('Tour button clicked!');
                canvasTour.startTour();
                tourControls.show();
            });

            canvasHeader.appendChild(tourButton);
            console.log('Tour button added successfully!');
        }

        // ============================
        // ONBOARDING TOUR SYSTEM
        // ============================

        let tourState = {
            currentStep: 0,
            totalSteps: 10,
            isActive: false,
            completedOnce: localStorage.getItem('cleansheet_tour_completed') === 'true'
        };

        const tourSteps = [
            // Step 1: Welcome
            {
                title: 'Welcome to Cleansheet',
                icon: 'ph-hand-waving',
                content: 'Your interactive career management workspace. Let\'s take a quick tour to get you started. You can explore example profiles later from the Quick Start button.',
                highlightElement: null,
                position: 'center',
                onNext: () => {
                    return true;
                }
            },
            // Step 2: Quick Start
            {
                title: 'Set Up Your Profile',
                icon: 'ph-lightning',
                content: 'Click Quick Start to get started. You can browse example profiles to see how Career Canvas works, start building your own profile, or request a professionally crafted Cleansheet profile.',
                highlightElement: '#rapidOnboardingBtn',
                position: 'bottom-left',
                onNext: () => {
                    return true;
                }
            },
            // Step 3: Career Experience Node
            {
                title: 'Explore Your Canvas',
                icon: 'ph-tree-structure',
                content: 'This is your career mindmap with five main sections. Click on Career Experience to add your work history, Interview Prep to practice questions, Goals to set objectives, Portfolio to showcase projects, and Job Opportunities to manage applications.',
                highlightElement: null, // Will be set dynamically to highlight all child nodes
                position: 'center',
                mindmapNode: 'AllChildNodes',
                onNext: () => {
                    return true;
                }
            },
            // Step 4: Paths Tab
            {
                title: 'Career Paths',
                icon: 'ph-path',
                content: 'Explore guided career paths tailored to different roles and industries. Each path shows the skills, experiences, and milestones you need to reach your career goals.',
                highlightElement: '.main-menu-item:nth-of-type(2)',
                position: 'bottom-left',
                onNext: () => {
                    return true;
                }
            },
            // Step 5: Industry Tab





            {
                title: 'Industry Insights',
                icon: 'ph-buildings',
                content: 'Discover industry-specific information, trends, and role requirements. Learn about different sectors and understand what employers are looking for in each field.',
                highlightElement: '.main-menu-item:nth-of-type(3)',
                position: 'bottom-left',
                onNext: () => {
                    return true;
                }
            },
            // Step 6: Library Tab
            {
                title: 'Curated Library',
                icon: 'ph-books',
                content: 'Access our curated collection of articles, guides, and resources. Search by topic, career path, or skill level to find content that helps you grow professionally.',
                highlightElement: '.main-menu-item:nth-of-type(4)',
                position: 'bottom-left',
                onNext: () => {
                    return true;
                }
            },
            // Step 7: Subscription Preview
            {
                title: 'Free Preview Access',
                icon: 'ph-gift',
                content: 'All features are available for free during the preview period. No credit card or email required! Explore everything Cleansheet has to offer and decide which subscription tier fits your needs later.',
                highlightElement: '#subscriptionTierBadge',
                position: 'bottom-right',
                onNext: () => {
                    return true;
                }
            },
            // Step 8: Data Management
            {
                title: 'Data Management',
                icon: 'ph-database',
                content: 'During the preview, all your data is stored locally in your browser. Nothing is shared with Cleansheet servers. Use "Data Management" to backup, restore, or update your profile data. Regular backups help avoid losing data if you clear your browser cache.',
                highlightElement: '.profile-dropdown-item:nth-child(3)',
                position: 'bottom-left',
                onEnter: () => {
                    // Auto-open profile dropdown
                    const dropdown = document.getElementById('profileDropdown');
                    if (dropdown) {
                        dropdown.classList.add('active');

                        // Re-highlight the Data Management menu item specifically
                        setTimeout(() => {
                            highlightElement('.profile-dropdown-item:nth-child(3)', 'bottom-left');
                        }, 50);
                    }
                },
                onNext: () => {
                    // Close profile dropdown
                    const dropdown = document.getElementById('profileDropdown');
                    if (dropdown) {
                        dropdown.classList.remove('active');
                    }
                    return true;
                }
            },
            // Step 9: Install App
            {
                title: 'Install as Desktop App',
                icon: 'ph-download-simple',
                content: 'Career Canvas can be installed as an app on Windows and MacOS. Get quick access from your desktop, work offline, and enjoy a native app experience without the browser toolbar.',
                highlightElement: '.profile-dropdown-item:nth-child(6)',
                position: 'bottom-right',
                onEnter: () => {
                    // Auto-open profile dropdown
                    const dropdown = document.getElementById('profileDropdown');
                    if (dropdown) {
                        dropdown.classList.add('active');

                        // Re-highlight the Install App menu item specifically
                        setTimeout(() => {
                            highlightElement('.profile-dropdown-item:nth-child(6)', 'bottom-right');
                        }, 50);
                    }
                },
                onNext: () => {
                    // Close profile dropdown
                    const dropdown = document.getElementById('profileDropdown');
                    if (dropdown) {
                        dropdown.classList.remove('active');
                    }
                    return true;
                }
            },
            // Step 10: Finish
            {
                title: 'Finish',
                icon: 'ph-check-circle',
                content: '<strong>You\'re ready to start building your career canvas!</strong>\n\n<div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; margin: 16px 0; border-radius: 4px;">\n<strong style="color: #92400e;">Important: Your Data, Your Responsibility</strong>\n<p style="margin: 8px 0 0 0; font-size: 13px; line-height: 1.5; color: #92400e;">All data is stored locally in your browser. <strong>Cleansheet does not have access to your data.</strong> You are the sole steward of your information. Export your data regularly to prevent loss.</p>\n</div>\n\n<p style="margin: 16px 0 0 0; font-size: 14px; line-height: 1.6;">Click "Finish" to start exploring the Career Canvas.</p>',
                highlightElement: null,
                position: 'center',
                isLastStep: true,
                onNext: () => {
                    completeTour();
                    return true;
                }
            }
        ];

        function startTour() {
            // Check if user already completed tour
            if (tourState.completedOnce) {
                console.log('[Tour] Tour already completed, skipping auto-start');
                return; // Don't show tour again
            }

            tourState.currentStep = 0;
            tourState.isActive = true;

            // Track tour start
            if (window.appInsights) {
                appInsights.trackEvent({
                    name: 'Tour_Started',
                    properties: {
                        displayMode: getDisplayMode(),
                        autoStart: true,
                        timestamp: new Date().toISOString()
                    }
                });
            }

            console.log('[Tour] Starting tour for new user');
            showTourStep(0);
        }

        function showTourStep(stepIndex) {
            const step = tourSteps[stepIndex];
            if (!step) return;

            // Update tour state
            tourState.currentStep = stepIndex;

            // Update tour card content
            document.getElementById('tourStepIndicator').textContent = `Step ${stepIndex + 1} of ${tourState.totalSteps}`;
            document.getElementById('tourTitle').textContent = step.title;
            document.getElementById('tourIcon').className = `ph ${step.icon}`;

            // Format content with HTML support
            const content = step.content.replace(/\n/g, '<br>');
            document.getElementById('tourContent').innerHTML = content;

            // Update buttons
            const prevBtn = document.getElementById('tourPrevBtn');
            const nextBtn = document.getElementById('tourNextBtn');
            const skipBtn = document.getElementById('tourSkipBtn');

            // Show/hide previous button
            if (stepIndex === 0) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'block';
            }

            // Update next button text for last step
            if (step.isLastStep) {
                nextBtn.innerHTML = 'Finish <i class="ph ph-check" style="font-size: 16px;"></i>';
                skipBtn.style.display = 'none'; // Hide skip on last step
            } else {
                nextBtn.innerHTML = 'Next <i class="ph ph-arrow-right" style="font-size: 16px;"></i>';
                skipBtn.style.display = 'block';
            }

            // Show overlay and tour card
            document.getElementById('tourOverlay').style.display = 'block';
            document.getElementById('tourCard').style.display = 'block';

            // Hide spotlight initially to reset state
            document.getElementById('tourSpotlight').style.display = 'none';

            // Highlight element if specified
            if (step.highlightElement) {
                highlightElement(step.highlightElement, step.position);
            } else if (step.mindmapNode) {
                // Highlight mindmap nodes with a delay to ensure rendering is complete
                setTimeout(() => {
                    highlightMindmapNode(step.mindmapNode, step.position);
                }, 200);
            } else {
                // No highlight, center the tour card
                positionTourCard('center');
            }

            // Execute onEnter callback
            if (step.onEnter) {
                setTimeout(() => step.onEnter(), 300);
            }
        }

        function highlightElement(selector, position) {
            const element = document.querySelector(selector);
            if (!element) {
                console.warn('Tour: Element not found:', selector);
                positionTourCard('center');
                return;
            }

            let rect = element.getBoundingClientRect();
            const spotlight = document.getElementById('tourSpotlight');

            // Special handling for profile circle - include dropdown if open
            // (but not if we're highlighting a specific menu item)
            if (selector === '.profile-circle') {
                const dropdown = document.getElementById('profileDropdown');
                if (dropdown && dropdown.classList.contains('active')) {
                    const dropdownRect = dropdown.getBoundingClientRect();
                    const avatarRect = element.getBoundingClientRect();

                    // Calculate combined bounding box
                    const top = Math.min(avatarRect.top, dropdownRect.top);
                    const left = Math.min(avatarRect.left, dropdownRect.left);
                    const right = Math.max(avatarRect.right, dropdownRect.right);
                    const bottom = Math.max(avatarRect.bottom, dropdownRect.bottom);

                    rect = {
                        top: top,
                        left: left,
                        right: right,
                        bottom: bottom,
                        width: right - left,
                        height: bottom - top
                    };
                }
            }

            // Special handling for profile dropdown menu items - add extra emphasis
            let spotlightPadding = 8;
            if (selector.includes('.profile-dropdown-item')) {
                // Add extra padding for menu items to make them stand out
                spotlightPadding = 12;
            }

            // Position spotlight around element
            spotlight.style.top = (rect.top - spotlightPadding) + 'px';
            spotlight.style.left = (rect.left - spotlightPadding) + 'px';
            spotlight.style.width = (rect.width + (spotlightPadding * 2)) + 'px';
            spotlight.style.height = (rect.height + (spotlightPadding * 2)) + 'px';
            spotlight.style.display = 'block';

            // Position tour card relative to highlighted element
            positionTourCard(position, rect);
        }

        function highlightMindmapNode(nodeName, position) {
            // Find all child nodes in the mindmap (second-level nodes)
            // These are the main feature nodes: Career Experience, Interview Prep, Goals, Portfolio, Job Opportunities
            const allNodes = document.querySelectorAll('#canvas-mindmap g');
            const childNodeGroups = new Map(); // Use a Map to deduplicate

            console.log('Tour: Searching for mindmap nodes, found', allNodes.length, 'total nodes');

            // Find all second-level nodes (children of root)
            allNodes.forEach(node => {
                const textElements = node.querySelectorAll('text');
                textElements.forEach(textElement => {
                    const text = textElement.textContent.trim();
                    // Check if this is a child node (not root, has meaningful text)
                    if (text && !text.includes("Canvas") && !text.includes("(") && text.length > 3) {
                        // Look for main menu items - these contain "Career", "Interview", "Goals", "Portfolio", "Job"
                        if (text.includes("Career") || text.includes("Interview") || text.includes("Goals") ||
                            text.includes("Portfolio") || text.includes("Job")) {
                            // Find the parent group that contains the entire node (rect + text + badge)
                            const parentGroup = node.closest('g.node') || node;
                            if (!childNodeGroups.has(text)) {
                                childNodeGroups.set(text, parentGroup);
                                console.log('Tour: Found child node:', text);
                            }
                        }
                    }
                });
            });

            const childNodes = Array.from(childNodeGroups.values());

            if (childNodes.length === 0) {
                console.warn('Tour: Child nodes not found in mindmap');
                positionTourCard('center');
                return;
            }

            console.log('Tour: Highlighting', childNodes.length, 'unique child nodes');

            // Calculate combined bounding box for all child nodes and their links
            let minTop = Infinity, minLeft = Infinity;
            let maxBottom = -Infinity, maxRight = -Infinity;

            childNodes.forEach(node => {
                const rect = node.getBoundingClientRect();
                console.log('Tour: Node bounds:', rect);
                minTop = Math.min(minTop, rect.top);
                minLeft = Math.min(minLeft, rect.left);
                maxBottom = Math.max(maxBottom, rect.bottom);
                maxRight = Math.max(maxRight, rect.right);
            });

            // Also include the links/paths that connect to these nodes
            const links = document.querySelectorAll('#canvas-mindmap path.link');
            links.forEach(link => {
                const rect = link.getBoundingClientRect();
                if (rect.width > 0 && rect.height > 0) {
                    minTop = Math.min(minTop, rect.top);
                    minLeft = Math.min(minLeft, rect.left);
                    maxBottom = Math.max(maxBottom, rect.bottom);
                    maxRight = Math.max(maxRight, rect.right);
                }
            });

            console.log('Tour: Combined bounds - Top:', minTop, 'Left:', minLeft, 'Bottom:', maxBottom, 'Right:', maxRight);

            const combinedRect = {
                top: minTop,
                left: minLeft,
                bottom: maxBottom,
                right: maxRight,
                width: maxRight - minLeft,
                height: maxBottom - minTop
            };

            console.log('Tour: Combined rect dimensions - Width:', combinedRect.width, 'Height:', combinedRect.height);

            const spotlight = document.getElementById('tourSpotlight');

            // Position spotlight around all child nodes with generous padding
            const padding = 40; // Increased from 20 to 40 for better visibility
            spotlight.style.top = (combinedRect.top - padding) + 'px';
            spotlight.style.left = (combinedRect.left - padding) + 'px';
            spotlight.style.width = (combinedRect.width + (padding * 2)) + 'px';
            spotlight.style.height = (combinedRect.height + (padding * 2)) + 'px';
            spotlight.style.display = 'block';

            console.log('Tour: Spotlight positioned at:', spotlight.style.top, spotlight.style.left,
                        'Size:', spotlight.style.width, spotlight.style.height);

            // Position tour card
            positionTourCard(position, combinedRect);
        }

        function positionTourCard(position, targetRect = null) {
            const tourCard = document.getElementById('tourCard');
            const cardRect = tourCard.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            let top, left;

            if (position === 'center' || !targetRect) {
                // Center the card
                top = (windowHeight - cardRect.height) / 2;
                left = (windowWidth - cardRect.width) / 2;
            } else if (position === 'bottom-right') {
                // Position below and to the left of target
                top = targetRect.bottom + 20;
                left = targetRect.right - cardRect.width;

                // Adjust if off-screen
                if (top + cardRect.height > windowHeight - 20) {
                    top = targetRect.top - cardRect.height - 20;
                }
                if (left < 20) {
                    left = 20;
                }
            } else if (position === 'bottom-left') {
                top = targetRect.bottom + 20;
                left = targetRect.left;

                if (top + cardRect.height > windowHeight - 20) {
                    top = targetRect.top - cardRect.height - 20;
                }
                if (left + cardRect.width > windowWidth - 20) {
                    left = windowWidth - cardRect.width - 20;
                }
            }

            tourCard.style.top = top + 'px';
            tourCard.style.left = left + 'px';
        }

        function nextTourStep() {
            const currentStep = tourSteps[tourState.currentStep];

            // Execute onNext callback
            if (currentStep.onNext) {
                const canProceed = currentStep.onNext();
                if (canProceed === false) {
                    return; // Stay on current step
                }
            }

            // Move to next step
            if (tourState.currentStep < tourState.totalSteps - 1) {
                showTourStep(tourState.currentStep + 1);
            } else {
                completeTour();
            }
        }

        function previousTourStep() {
            if (tourState.currentStep > 0) {
                showTourStep(tourState.currentStep - 1);
            }
        }

        function skipTour() {
            // Mark tour as completed (dismissed) so it doesn't show again
            localStorage.setItem('cleansheet_tour_completed', 'true');
            tourState.completedOnce = true;

            // Track skip event
            if (window.appInsights) {
                appInsights.trackEvent({
                    name: 'Tour_Skipped',
                    properties: {
                        step: tourState.currentStep,
                        totalSteps: tourState.totalSteps,
                        displayMode: getDisplayMode(),
                        timestamp: new Date().toISOString()
                    }
                });
            }

            closeTour();
        }

        function completeTour() {
            // Mark tour as completed
            localStorage.setItem('cleansheet_tour_completed', 'true');
            tourState.completedOnce = true;

            // Track completion event
            if (window.appInsights) {
                appInsights.trackEvent({
                    name: 'Tour_Completed',
                    properties: {
                        displayMode: getDisplayMode(),
                        timestamp: new Date().toISOString()
                    }
                });
            }

            closeTour();
        }

        function closeTour() {
            // Mark tour as completed even if closed via X button
            // This prevents the tour from showing on every reload
            if (!tourState.completedOnce) {
                localStorage.setItem('cleansheet_tour_completed', 'true');
                tourState.completedOnce = true;

                // Track close event (dismissed via X button)
                if (window.appInsights) {
                    appInsights.trackEvent({
                        name: 'Tour_Closed',
                        properties: {
                            step: tourState.currentStep,
                            totalSteps: tourState.totalSteps,
                            displayMode: getDisplayMode(),
                            timestamp: new Date().toISOString()
                        }
                    });
                }
            }

            tourState.isActive = false;
            document.getElementById('tourOverlay').style.display = 'none';
            document.getElementById('tourCard').style.display = 'none';
            document.getElementById('tourSpotlight').style.display = 'none';

            // Close any modals/dropdowns that were opened by the tour
            closeProfileModal();

            // Close profile dropdown if open
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileDropdown) {
                profileDropdown.classList.remove('active');
            }
        }

        function restartTour() {
            // Close the profile dropdown menu
            document.getElementById('profileDropdown').classList.remove('active');

            // Clear the completion flag from localStorage so tour can be shown again
            localStorage.removeItem('cleansheet_tour_completed');

            // Track manual tour restart
            if (window.appInsights) {
                appInsights.trackEvent({
                    name: 'Tour_Restarted',
                    properties: {
                        displayMode: getDisplayMode(),
                        timestamp: new Date().toISOString()
                    }
                });
            }

            // Reset tour state and start from beginning
            tourState.completedOnce = false;
            tourState.currentStep = 0;
            tourState.isActive = true;
            console.log('[Tour] Tour manually restarted');
            showTourStep(0);
        }

        // Auto-open Canvas Tour on page load - simple version
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');

            // Initialize subscription tier to seeker if not set
            if (!localStorage.getItem('subscription_tier')) {
                localStorage.setItem('subscription_tier', 'seeker');
            }

            // Apply viewport settings based on subscription tier
            applyViewportForTier();

            openCanvasModal();

            // Check if this is first load (no saved profile) - if so, load Marcus Thompson example
            const hasExistingProfile = localStorage.getItem('cleansheet_currentPersona');
            if (!hasExistingProfile) {
                console.log('[Init] First load detected - loading Marcus Thompson example profile');
                loadExampleProfile('career-changer');
            }

            // Initialize profile display
            initializeProfile();

            // Load experiences and update count on mindmap
            loadUserExperiences();
            updateExperienceCount(userExperiences.length);

            // Load stories and update count on mindmap
            let storiesData = localStorage.getItem('cleansheet_stories');
            if (!storiesData) {
                storiesData = localStorage.getItem('behavioralStories');
            }
            const allStories = storiesData ? JSON.parse(storiesData) : [];
            updateStoryCount(allStories.length);

            // Load goals and update count on mindmap
            loadUserGoals();
            updateGoalsCount(userGoals.length);

            // Load portfolio and update count on mindmap
            loadUserPortfolio();
            updatePortfolioCount(userPortfolioProjects.length);

            // Load job opportunities and update count on mindmap (active jobs only)
            loadUserJobs();

            // Initialize UI guidance tooltips after modal is open
            setTimeout(() => {
                initializeUIGuidance();
            }, 500);

            // Start onboarding tour for new users (disabled - user can click tour button)
            // setTimeout(() => {
            //     startTour();
            // }, 1000);
        });

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('[PWA] Service Worker registered successfully:', registration.scope);

                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute

                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[PWA] New content available, please refresh');
                                    // Optionally show a notification to the user
                                    if (confirm('New version available! Refresh to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });

                // Handle controller change (new service worker activated)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('[PWA] New service worker activated');
                });
            });

            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                console.log('[PWA] Message from service worker:', event.data);
            });
        } else {
            console.warn('[PWA] Service Workers are not supported in this browser');
        }

        // EARLY PWA DETECTION - Set flag immediately if we detect standalone mode
        // This happens BEFORE any event handlers run
        (function earlyPWADetection() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isIOSStandalone = window.navigator.standalone === true;

            console.log('[PWA] Early detection:', {
                standalone: isStandalone,
                iOS: isIOSStandalone,
                existingFlag: localStorage.getItem('cleansheet_pwa_mode')
            });

            // If we're in standalone mode, immediately set the flag
            if (isStandalone || isIOSStandalone) {
                localStorage.setItem('cleansheet_pwa_mode', 'true');
                console.log('[PWA] Early detection: Set PWA flag (standalone mode detected)');
            }
        })();

        // Install prompt handling
        window.deferredPrompt = null;
        window.beforeInstallPromptFired = false;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Check if we're actually in standalone mode (PWA)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isIOSStandalone = window.navigator.standalone === true;

            console.log('[PWA] Install prompt event fired', {
                standalone: isStandalone,
                iOS: isIOSStandalone,
                currentPWAFlag: localStorage.getItem('cleansheet_pwa_mode')
            });

            // ONLY clear the PWA flag if we're actually in browser mode
            // If we're in standalone mode, this event shouldn't fire, but just in case...
            if (!isStandalone && !isIOSStandalone) {
                console.log('[PWA] Clearing PWA flag - app not installed (browser mode)');
                localStorage.removeItem('cleansheet_pwa_mode');
                window.beforeInstallPromptFired = true;
            } else {
                console.log('[PWA] WARNING: beforeinstallprompt fired in standalone mode - keeping PWA flag');
                // Keep the PWA flag and don't set beforeInstallPromptFired
                return; // Don't process the install prompt in PWA mode
            }

            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later (used by Install App modal in user menu)
            window.deferredPrompt = e;

            // Install prompt handler for Install App modal
            window.showInstallPrompt = () => {
                if (window.deferredPrompt) {
                    window.deferredPrompt.prompt();
                    window.deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('[PWA] User accepted the install prompt');
                            // Set PWA flag immediately after accepting
                            localStorage.setItem('cleansheet_pwa_mode', 'true');
                            console.log('[PWA] Set PWA flag - user accepted install');
                        } else {
                            console.log('[PWA] User dismissed the install prompt');
                        }
                        window.deferredPrompt = null;
                    });
                }
            };
        });

        // Track when app is installed
        window.addEventListener('appinstalled', (event) => {
            console.log('[PWA] App was installed successfully');

            // Set persistent PWA flag
            localStorage.setItem('cleansheet_pwa_mode', 'true');
            console.log('[PWA] Set PWA flag - app installed');

            // Track with analytics
            if (window.appInsights) {
                appInsights.trackEvent({
                    name: 'PWA_Installed',
                    properties: {
                        timestamp: new Date().toISOString(),
                        displayMode: getDisplayMode()
                    }
                });
            }
        });

        // Debug function to reset PWA detection (for testing)
        window.resetPWADetection = function() {
            localStorage.removeItem('cleansheet_pwa_mode');
            console.log('[PWA] PWA detection flag cleared - refresh to see install button');
            alert('PWA detection reset. Refresh the page to see the install button again.');
        };

        // PWA Detection and Install Button Management
        function isPWA() {
            // Check if running in standalone mode (installed PWA)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

            // iOS Safari specific check
            const isIOSStandalone = window.navigator.standalone === true;

            // Check if we've previously detected PWA mode (persistent flag)
            const pwaFlagSet = localStorage.getItem('cleansheet_pwa_mode') === 'true';

            // Check referrer - PWAs often have empty or same-origin referrer
            const referrer = document.referrer;
            const isSameOrigin = referrer === '' || referrer.startsWith(window.location.origin);

            // Check if beforeinstallprompt fired (it doesn't fire when already installed)
            const promptNotFired = window.beforeInstallPromptFired === false;

            // Combine checks
            const result = isStandalone || isIOSStandalone || pwaFlagSet;

            console.log(`[PWA] isPWA check:`, {
                standalone: isStandalone,
                iOS: isIOSStandalone,
                pwaFlag: pwaFlagSet,
                referrer: referrer,
                sameOrigin: isSameOrigin,
                promptFired: window.beforeInstallPromptFired,
                result: result
            });

            // If we detect PWA mode, persistently remember it
            if (result && !pwaFlagSet) {
                console.log('[PWA] Setting persistent PWA mode flag');
                localStorage.setItem('cleansheet_pwa_mode', 'true');
            }

            return result;
        }

        function getDisplayMode() {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return 'standalone';
            }
            if (window.navigator.standalone === true) {
                return 'standalone-ios';
            }
            if (window.matchMedia('(display-mode: fullscreen)').matches) {
                return 'fullscreen';
            }
            if (window.matchMedia('(display-mode: minimal-ui)').matches) {
                return 'minimal-ui';
            }
            return 'browser';
        }

        // Note: Install button removed from main menu bar
        // Install functionality still available via user menu → "Install App"

        // Track page view with display mode
        function trackPageViewWithDisplayMode() {
            if (window.appInsights) {
                const displayMode = getDisplayMode();

                appInsights.trackPageView({
                    name: 'Career Canvas',
                    properties: {
                        displayMode: displayMode,
                        isPWA: isPWA(),
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    }
                });

                console.log(`[Analytics] Display Mode: ${displayMode}, isPWA: ${isPWA()}`);
            }
        }

        // ================================
        // LaTeX Document Editor System
        // ================================

        let latexEditor = null;
        let currentLatexDocumentId = null;
        let latexAutoSaveTimeout = null;
        let swiftLatex = null;

        // Autocompile functionality
        let autoCompileEnabled = true; // Default enabled, will be loaded from localStorage
        let autoCompileTimeout = null;
        let autoCompileDelay = 2500; // Default 2.5 seconds, editable by user
        let hasInitialCompiled = false; // Flag to prevent double compilation on initial load


        // LaTeX Document localStorage schema
        function getLatexDocuments() {
            const key = `user_latex_documents_${currentPersona}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : [];
        }

        function saveLatexDocuments(documents) {
            const key = `user_latex_documents_${currentPersona}`;
            localStorage.setItem(key, JSON.stringify(documents));
        }

        // Register LaTeX language definition for Monaco Editor
        function registerLatexLanguage() {
            try {
                // Check if language already exists
                const languages = monaco.languages.getLanguages();
                const latexExists = languages.some(lang => lang.id === 'latex');

                if (latexExists) {
                    console.log('LaTeX language already registered, skipping...');
                    return;
                }

                // Register the language
                monaco.languages.register({ id: 'latex' });

            // Define syntax highlighting rules
            monaco.languages.setMonarchTokensProvider('latex', {
                tokenizer: {
                    root: [
                        // Comments (highest priority)
                        [/%.*$/, 'comment'],

                        // Math environments - display math
                        [/\\\[/, 'math-display', '@math_display'],
                        [/\$\$/, 'math-display', '@math_display_double'],

                        // Math environments - inline math
                        [/\$/, 'math-inline', '@math_inline'],

                        // Environment blocks (simplified to avoid complex capturing groups)
                        [/\\begin\{[^}]+\}/, 'environment-begin'],
                        [/\\end\{[^}]+\}/, 'environment-end'],

                        // LaTeX commands (simplified)
                        [/\\[a-zA-Z]+\*?/, 'command'],

                        // Special characters and escapes
                        [/\\\\/, 'line-break'],
                        [/\\[%$#{}_&]/, 'escape'],

                        // Braces and brackets
                        [/[{}]/, 'bracket'],
                        [/[\[\]]/, 'bracket-square'],

                        // Table separators
                        [/&/, 'table-separator'],
                        [/\\hline/, 'table-rule'],

                        // Arguments in braces
                        [/\{[^}]*\}/, 'command-argument'],

                        // Optional arguments in brackets
                        [/\[[^\]]*\]/, 'command-optional'],

                        // Regular text (catch-all)
                        [/./, 'text']
                    ],

                    math_inline: [
                        [/\$/, 'math-inline', '@pop'],
                        [/\\[a-zA-Z]+/, 'math-command'],
                        [/[{}]/, 'math-bracket'],
                        [/[^$\\{}]+/, 'math-content']
                    ],

                    math_display: [
                        [/\\\]/, 'math-display', '@pop'],
                        [/\\[a-zA-Z]+/, 'math-command'],
                        [/[{}]/, 'math-bracket'],
                        [/[^\\\]{}]+/, 'math-content']
                    ],

                    math_display_double: [
                        [/\$\$/, 'math-display', '@pop'],
                        [/\\[a-zA-Z]+/, 'math-command'],
                        [/[{}]/, 'math-bracket'],
                        [/[^$\\{}]+/, 'math-content']
                    ]
                }
            });

            // Define custom LaTeX color theme
            monaco.editor.defineTheme('latex-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    // Comments
                    { token: 'comment', foreground: '6A9955', fontStyle: 'italic' },

                    // LaTeX commands
                    { token: 'command', foreground: '569CD6', fontStyle: 'bold' },
                    { token: 'command-star', foreground: '569CD6' },
                    { token: 'command-optional', foreground: 'CE9178' },
                    { token: 'command-argument', foreground: 'CE9178' },

                    // Environments
                    { token: 'environment-begin', foreground: 'C586C0', fontStyle: 'bold' },
                    { token: 'environment-end', foreground: 'C586C0', fontStyle: 'bold' },
                    { token: 'environment-name', foreground: 'DCDCAA' },

                    // Math
                    { token: 'math-inline', foreground: '4EC9B0', fontStyle: 'bold' },
                    { token: 'math-display', foreground: '4EC9B0', fontStyle: 'bold' },
                    { token: 'math-command', foreground: '9CDCFE' },
                    { token: 'math-content', foreground: 'B5CEA8' },
                    { token: 'math-bracket', foreground: 'FFD700' },

                    // Structure
                    { token: 'bracket', foreground: 'FFD700' },
                    { token: 'bracket-square', foreground: 'FFD700' },
                    { token: 'line-break', foreground: 'FF6B6B', fontStyle: 'bold' },
                    { token: 'escape', foreground: 'FF6B6B' },

                    // Table elements
                    { token: 'table-separator', foreground: 'FF6B6B', fontStyle: 'bold' },
                    { token: 'table-rule', foreground: 'C586C0' },

                    // Regular text
                    { token: 'text', foreground: 'D4D4D4' }
                ],
                colors: {
                    'editor.background': '#1E1E1E',
                    'editor.foreground': '#D4D4D4'
                }
            });

            // Configure language features
            monaco.languages.setLanguageConfiguration('latex', {
                comments: {
                    lineComment: '%'
                },
                brackets: [
                    ['{', '}'],
                    ['[', ']'],
                    ['(', ')'],
                    ['\\(', '\\)'],
                    ['\\[', '\\]'],
                    ['$', '$']
                ],
                autoClosingPairs: [
                    { open: '{', close: '}' },
                    { open: '[', close: ']' },
                    { open: '(', close: ')' },
                    { open: '$', close: '$' },
                    { open: '$$', close: '$$' }
                ],
                surroundingPairs: [
                    { open: '{', close: '}' },
                    { open: '[', close: ']' },
                    { open: '(', close: ')' },
                    { open: '$', close: '$' }
                ]
            });

            // Add basic LaTeX command completions
            monaco.languages.registerCompletionItemProvider('latex', {
                provideCompletionItems: function(model, position) {
                    const suggestions = [
                        {
                            label: 'section',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'section{${1:Section Title}}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Create a section'
                        },
                        {
                            label: 'subsection',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'subsection{${1:Subsection Title}}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Create a subsection'
                        },
                        {
                            label: 'textbf',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'textbf{${1:bold text}}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Bold text'
                        },
                        {
                            label: 'textit',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'textit{${1:italic text}}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Italic text'
                        },
                        {
                            label: 'begin',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'begin{${1:environment}}\n\t${2}\n\\end{${1:environment}}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Begin environment'
                        },
                        {
                            label: 'equation',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'begin{equation}\n\t${1:E = mc^2}\n\\end{equation}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Equation environment'
                        },
                        {
                            label: 'itemize',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'begin{itemize}\n\t\\item ${1:First item}\n\t\\item ${2:Second item}\n\\end{itemize}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Bulleted list'
                        },
                        {
                            label: 'enumerate',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'begin{enumerate}\n\t\\item ${1:First item}\n\t\\item ${2:Second item}\n\\end{enumerate}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Numbered list'
                        },
                        {
                            label: 'table',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'begin{table}[h]\n\\centering\n\\begin{tabular}{|c|c|c|}\n\\hline\n${1:Header 1} & ${2:Header 2} & ${3:Header 3} \\\\ \\hline\n${4:Row 1} & ${5:Data 1} & ${6:Data 2} \\\\ \\hline\n\\end{tabular}\n\\caption{${7:Table caption}}\n\\end{table}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Table with 3 columns'
                        }
                    ];

                    return { suggestions: suggestions };
                }
            });

                console.log('LaTeX language and theme registered successfully');

            } catch (error) {
                console.error('Error registering LaTeX language:', error);
                // Fallback to vs-dark theme if custom theme fails
                throw error;
            }
        }

        // Prevent duplicate language registration
        let latexLanguageRegistered = false;

        // Initialize Monaco LaTeX Editor
        function initializeLatexEditor(callback) {
            const editorContainer = document.getElementById('latex-editor-container');
            if (!editorContainer) {
                console.error('LaTeX editor container not found');
                if (callback) callback(false);
                return;
            }

            // Use require to load Monaco, just like other editors
            require(['vs/editor/editor.main'], function() {
                try {
                    console.log('[LaTeX] Monaco loaded, creating editor');

                    // Register LaTeX language and syntax highlighting (only once)
                    if (!latexLanguageRegistered) {
                        try {
                            registerLatexLanguage();
                            latexLanguageRegistered = true;
                        } catch (error) {
                            console.error('LaTeX language registration failed, falling back to plaintext:', error);
                            // Continue with plaintext if LaTeX registration fails
                        }
                    }

                    // Clear any existing content
                    editorContainer.innerHTML = '';

                    // Determine language and theme based on registration success
                    const useLatexLanguage = latexLanguageRegistered;

                    latexEditor = monaco.editor.create(editorContainer, {
                        value: '',
                        language: useLatexLanguage ? 'latex' : 'plaintext',
                        theme: useLatexLanguage ? 'latex-dark' : 'vs-dark',
                        fontSize: 14,
                        fontFamily: 'Monaco, Menlo, "Ubuntu Mono", monospace',
                        lineNumbers: 'on',
                        minimap: { enabled: false },
                        wordWrap: 'on',
                        automaticLayout: true,
                        scrollBeyondLastLine: false
                    });

                    // Add change listener for auto-save and auto-compile
                    latexEditor.onDidChangeModelContent(() => {
                        if (currentLatexDocumentId) {
                            scheduleLaTexAutoSave();
                            scheduleAutoCompile();
                        }
                    });

                    console.log('LaTeX Monaco editor initialized successfully');
                    if (callback) callback(true);
                } catch (error) {
                    console.error('Failed to initialize LaTeX Monaco editor:', error);
                    if (callback) callback(false);
                }
            });
        }

        // Auto-save functionality
        function scheduleLaTexAutoSave() {
            if (latexAutoSaveTimeout) {
                clearTimeout(latexAutoSaveTimeout);
            }
            latexAutoSaveTimeout = setTimeout(saveLaTexDocumentSilently, 2000);
        }

        function saveLaTexDocumentSilently() {
            if (!currentLatexDocumentId || !latexEditor) return;

            const content = latexEditor.getValue();
            const documents = getLatexDocuments();
            const docIndex = documents.findIndex(d => d.id === currentLatexDocumentId);

            if (docIndex !== -1) {
                documents[docIndex].content = content;
                documents[docIndex].lastModified = new Date().toISOString();
                saveLatexDocuments(documents);
                console.log('LaTeX document auto-saved');
            }
        }

        // Autocompile functionality
        function scheduleAutoCompile() {
            console.log('scheduleAutoCompile called:', { autoCompileEnabled, currentLatexDocumentId: !!currentLatexDocumentId, latexEditor: !!latexEditor, hasInitialCompiled });

            if (!autoCompileEnabled || !currentLatexDocumentId || !latexEditor) return;

            // Don't schedule autocompile if we haven't done the initial compile yet
            // This prevents double compilation on document load
            if (!hasInitialCompiled) {
                console.log('Skipping autocompile - initial compile not yet completed');
                return;
            }

            // Clear any pending auto-compile
            if (autoCompileTimeout) {
                clearTimeout(autoCompileTimeout);
            }

            // Update status to show pending compile
            updateCompileStatus('pending');

            // Schedule new compile
            autoCompileTimeout = setTimeout(() => {
                compileLatexToPDF(true); // true indicates auto-compile
            }, autoCompileDelay);
        }

        function toggleAutoCompile() {
            const toggle = document.getElementById('autoCompileToggle');
            if (!toggle) return;

            autoCompileEnabled = toggle.checked;
            localStorage.setItem('latex_autocompile', autoCompileEnabled);

            if (autoCompileEnabled) {
                showToast('Auto-compile enabled', 'success');
                // Trigger immediate compile if we have content
                if (currentLatexDocumentId && latexEditor && latexEditor.getValue().trim()) {
                    scheduleAutoCompile();
                }
            } else {
                showToast('Auto-compile disabled', 'info');
                // Clear any pending compile
                if (autoCompileTimeout) {
                    clearTimeout(autoCompileTimeout);
                }
                updateCompileStatus('idle');
            }
        }

        function updateAutoCompileInterval() {
            const intervalInput = document.getElementById('autoCompileInterval');
            if (!intervalInput) return;

            const newInterval = parseFloat(intervalInput.value);
            if (isNaN(newInterval) || newInterval < 0.5 || newInterval > 30) {
                // Reset to previous valid value
                intervalInput.value = (autoCompileDelay / 1000).toFixed(1);
                showToast('Invalid interval. Must be between 0.5 and 30 seconds.', 'error');
                return;
            }

            autoCompileDelay = newInterval * 1000; // Convert to milliseconds
            localStorage.setItem('latex_autocompile_delay', autoCompileDelay);

            // If there's a pending autocompile, reschedule it with new delay
            if (autoCompileTimeout && autoCompileEnabled) {
                clearTimeout(autoCompileTimeout);
                scheduleAutoCompile();
            }

            showToast(`Auto-compile interval set to ${newInterval}s`, 'success');
        }


        function initializeAutoCompileToggle() {
            // Load preference from localStorage
            const savedPreference = localStorage.getItem('latex_autocompile');
            if (savedPreference !== null) {
                autoCompileEnabled = savedPreference === 'true';
            }

            // Load interval from localStorage
            const savedDelay = localStorage.getItem('latex_autocompile_delay');
            if (savedDelay !== null) {
                const delay = parseInt(savedDelay);
                if (!isNaN(delay) && delay >= 500 && delay <= 30000) {
                    autoCompileDelay = delay;
                }
            }

            // Set toggle state
            const toggle = document.getElementById('autoCompileToggle');
            if (toggle) {
                toggle.checked = autoCompileEnabled;
            }

            // Set interval input value
            const intervalInput = document.getElementById('autoCompileInterval');
            if (intervalInput) {
                intervalInput.value = (autoCompileDelay / 1000).toFixed(1);
            }
        }


        function updateCompileStatus(state) {
            const statusEl = document.getElementById('latexPreviewStatus');
            if (!statusEl) return;

            const states = {
                'idle': 'Click "Compile PDF" to preview',
                'pending': `Changes detected, will compile in ${autoCompileDelay/1000}s...`,
                'compiling': 'Auto-compiling...',
                'success': 'Preview up to date ✓',
                'error': 'Compilation error - check syntax'
            };

            statusEl.textContent = states[state] || states.idle;
        }

        // Core LaTeX Editor Functions
        function openLatexEditor(documentId = null) {
            console.log('=== OPENING LATEX EDITOR ===');
            console.log('Document ID:', documentId);

            // Initialize editor if not already done
            if (!latexEditor) {
                initializeLatexEditor((success) => {
                    if (success) {
                        // Editor initialized, continue with opening
                        continueOpeningLatexEditor(documentId);
                    } else {
                        alert('Failed to initialize LaTeX editor. Please refresh the page and try again.');
                    }
                });
                return;
            }

            // Editor already exists, continue directly
            continueOpeningLatexEditor(documentId);
        }

        function continueOpeningLatexEditor(documentId) {
            currentLatexDocumentId = documentId;
            // Reset initial compile flag for new document
            hasInitialCompiled = false;

            if (documentId) {
                // Load existing document
                const documents = getLatexDocuments();
                const latexDoc = documents.find(d => d.id === documentId);

                if (latexDoc) {
                    // Update editor content
                    latexEditor.setValue(latexDoc.content || '');

                    // Update header info
                    document.getElementById('latex-document-title').textContent = latexDoc.name || 'Untitled Document';
                    console.log('Loaded LaTeX document:', latexDoc.name);
                } else {
                    console.error('LaTeX document not found:', documentId);
                    return;
                }
            } else {
                // Create new document
                const newDoc = {
                    id: Date.now(),
                    name: 'New LaTeX Document',
                    description: '',
                    content: getDefaultLatexTemplate(),
                    tags: [],
                    linkedType: '',
                    linkedId: '',
                    lastModified: new Date().toISOString(),
                    // CV-specific fields (optional, only populated for CV documents)
                    type: 'latex', // 'latex' for regular documents, 'cv' for CV documents
                    cvTemplate: null, // 'altacv', 'moderncv', etc. for CV documents
                    personalInfo: null, // Object with name, email, phone, location, etc.
                    sections: null, // Array of CV sections with content
                    colorScheme: null // Object with CV color preferences
                };

                const documents = getLatexDocuments();
                documents.push(newDoc);
                saveLatexDocuments(documents);

                currentLatexDocumentId = newDoc.id;

                // Update editor content
                latexEditor.setValue(newDoc.content);

                // Update header info
                document.getElementById('latex-document-title').textContent = newDoc.name;

                console.log('Created new LaTeX document:', newDoc.id);
            }

            // Show the editor
            document.getElementById('latexEditor').style.display = 'flex';

            // Check if this is a CV document and show/hide CV toolbar commands
            const documents = getLatexDocuments();
            const currentDoc = documents.find(d => d.id === currentLatexDocumentId);
            const isCVDocument = currentDoc && currentDoc.type === 'cv';

            // Show/hide CV toolbar commands
            const cvCommands = document.querySelectorAll('.cv-command');
            const cvDivider = document.getElementById('cvToolbarDivider');

            cvCommands.forEach(button => {
                button.style.display = isCVDocument ? 'flex' : 'none';
            });

            if (cvDivider) {
                cvDivider.style.display = isCVDocument ? 'block' : 'none';
            }

            // Update document title to indicate CV vs LaTeX
            const titleEl = document.getElementById('latex-document-title');
            if (titleEl && currentDoc) {
                const prefix = isCVDocument ? '[CV] ' : '';
                titleEl.textContent = prefix + (currentDoc.name || 'Untitled Document');
            }

            console.log('CV document detected:', isCVDocument);

            // Initialize autocompile toggle
            initializeAutoCompileToggle();

            // Disable download button (needs compilation first)
            const downloadBtn = document.getElementById('downloadLatexPdfBtn');
            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.style.background = 'var(--color-neutral-border)';
                downloadBtn.style.color = 'var(--color-neutral-text)';
                downloadBtn.style.cursor = 'not-allowed';
                downloadBtn.title = 'Compile document first to enable download';
            }

            // Focus the editor and trigger immediate compile
            setTimeout(() => {
                if (latexEditor) {
                    latexEditor.focus();

                    // Trigger immediate compilation if document has content
                    const content = latexEditor.getValue();
                    console.log('Initial compile check:', { hasContent: !!content.trim(), contentLength: content.length });
                    if (content.trim()) {
                        console.log('Triggering immediate compile on document load');
                        compileLatexToPDF(true).then(() => {
                            // Mark that initial compile is complete to enable autocompile
                            console.log('Initial compile completed, enabling autocompile');
                            hasInitialCompiled = true;
                        }).catch(error => {
                            console.error('Initial compile failed:', error);
                            hasInitialCompiled = true; // Still enable autocompile even if initial compile failed
                        });
                    } else {
                        // No content, so mark initial compile as complete immediately
                        console.log('No content, marking initial compile as complete immediately');
                        hasInitialCompiled = true;
                    }
                }
            }, 100);
        }

        function closeLatexEditor() {
            console.log('=== CLOSING LATEX EDITOR ===');

            // Save current document
            if (currentLatexDocumentId) {
                saveLaTexDocumentSilently();
            }

            // Dispose of Monaco editor to free resources
            if (latexEditor) {
                latexEditor.dispose();
                latexEditor = null;
            }

            // Hide the editor
            document.getElementById('latexEditor').style.display = 'none';

            // Clear state
            currentLatexDocumentId = null;

            // Clear any pending auto-save
            if (latexAutoSaveTimeout) {
                clearTimeout(latexAutoSaveTimeout);
                latexAutoSaveTimeout = null;
            }

            // Refresh the assets list if we're in Interview Prep
            if (currentSlideout === 'interview-prep') {
                loadAllAssets();
            }
        }

        function editLatexMetadata() {
            if (!currentLatexDocumentId) return;

            const documents = getLatexDocuments();
            const latexDoc = documents.find(d => d.id === currentLatexDocumentId);

            if (latexDoc) {
                const newName = prompt('Document name:', latexDoc.name);
                if (newName && newName.trim()) {
                    latexDoc.name = newName.trim();
                    latexDoc.lastModified = new Date().toISOString();
                    saveLatexDocuments(documents);

                    // Update the header
                    document.getElementById('latex-document-title').textContent = latexDoc.name;
                }
            }
        }

        // LaTeX Command Insertion Functions
        function insertLatexCommand(command) {
            if (!latexEditor || !currentLatexDocumentId) return;

            const templates = {
                'section': '\\section{Section Title}\n',
                'subsection': '\\subsection{Subsection Title}\n',
                'bold': '\\textbf{bold text}',
                'italic': '\\textit{italic text}',
                'math-inline': '$x = y + z$',
                'math-display': '\n\\[\n    E = mc^2\n\\]\n',
                'itemize': '\n\\begin{itemize}\n    \\item First item\n    \\item Second item\n\\end{itemize}\n',
                'enumerate': '\n\\begin{enumerate}\n    \\item First item\n    \\item Second item\n\\end{enumerate}\n',
                'table': '\n\\begin{table}[h]\n\\centering\n\\begin{tabular}{|c|c|c|}\n\\hline\nHeader 1 & Header 2 & Header 3 \\\\ \\hline\nRow 1 & Data 1 & Data 2 \\\\ \\hline\nRow 2 & Data 3 & Data 4 \\\\ \\hline\n\\end{tabular}\n\\caption{Table caption}\n\\end{table}\n',
                'figure': '\n\\begin{figure}[h]\n\\centering\n% Insert figure here\n\\caption{Figure caption}\n\\label{fig:example}\n\\end{figure}\n',
                // CV-specific templates
                'cvsection': '\n\\cvsection{Section Title}\n\n',
                'cvevent': '\n\\cvevent{Job Title}{Company Name}{Month Year -- Present}{City, State}\n\\begin{itemize}\n\\item Achievement or responsibility that demonstrates impact\n\\item Quantifiable accomplishment with specific metrics\n\\item Technical or leadership accomplishment relevant to target role\n\\end{itemize}\n\n\\divider\n\n',
                'cvskill': '\\cvskill{Skill Name}{4}  % Skill level 1-5\n',
                'cvtag': '\\cvtag{Skill Tag}\n\\cvtag{Technology}\n\\cvtag{Framework}\n\n',
                'cvachievement': '\\cvachievement{\\faIcon{star}}{Achievement Title}{Brief description of the accomplishment and its impact}\n\n'
            };

            const template = templates[command];
            if (template) {
                // Insert at current cursor position
                const position = latexEditor.getPosition();
                const range = {
                    startLineNumber: position.lineNumber,
                    startColumn: position.column,
                    endLineNumber: position.lineNumber,
                    endColumn: position.column
                };

                latexEditor.executeEdits('insertLatexCommand', [{
                    range: range,
                    text: template,
                    forceMoveMarkers: true
                }]);

                latexEditor.focus();
                scheduleLaTexAutoSave();
            }
        }

        // PDF Compilation Functions
        let katexRetryCount = 0;

        async function compileLatexToPDF(isAutoCompile = false) {
            if (!currentLatexDocumentId || !latexEditor) {
                if (!isAutoCompile) {
                    alert('No LaTeX document is currently open');
                }
                return Promise.resolve();
            }

            const content = latexEditor.getValue();
            if (!content.trim()) {
                if (!isAutoCompile) {
                    alert('Please add some content to compile');
                }
                return Promise.resolve();
            }

            // Handle button state only for manual compiles
            let compileBtn, originalText;
            if (!isAutoCompile) {
                compileBtn = document.querySelector('button[onclick="compileLatexToPDF()"]');
                originalText = compileBtn.textContent;
                compileBtn.textContent = 'Compiling...';
                compileBtn.disabled = true;
            } else {
                // Update status for auto-compile
                updateCompileStatus('compiling');
            }

            try {
                console.log('Starting LaTeX compilation...');
                console.log('KaTeX available:', !!window.katex);

                // LaTeX processing function is available inline - no need to check for external library

                // Brief wait for KaTeX if it's not immediately available
                if (!window.katex && katexRetryCount < 2) {
                    console.log(`Waiting briefly for KaTeX... (attempt ${katexRetryCount + 1})`);
                    katexRetryCount++;
                    return new Promise(resolve => {
                        setTimeout(() => {
                            compileLatexToPDF(isAutoCompile).then(resolve).catch(resolve);
                        }, 250);
                    });
                }

                if (!window.katex) {
                    console.warn('KaTeX not available, using enhanced fallback rendering');
                }

                // Process LaTeX content to HTML using our full renderer
                console.log('Processing LaTeX content...');
                console.log('window.SimpleLatex available:', !!window.SimpleLatex);
                console.log('window.LaTeX available:', !!window.LaTeX);

                // Force the renderer to be available - if it's not created, there's a JS error we need to fix
                if (!window.LaTeX && !window.SimpleLatex) {
                    console.error('LaTeX renderer objects not created - this indicates a JavaScript syntax error in the SimpleLatex definition');
                    console.error('Check browser developer console for syntax errors in the script block starting around line 95');
                    throw new Error('LaTeX renderer could not be loaded due to JavaScript syntax error. Check browser console.');
                }

                // Use our full LaTeX renderer with all the enhancements
                const latexRenderer = window.LaTeX || window.SimpleLatex;
                const doc = latexRenderer.parse(content);
                const htmlOutput = latexRenderer.render(doc);
                console.log('Rendered HTML output with full LaTeX processor');

                // Create a styled HTML document
                const styledHtml = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            body {
                                font-family: 'Computer Modern', 'Times New Roman', serif;
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 40px 20px;
                                line-height: 1.6;
                                font-size: 12pt;
                            }
                            h1, h2, h3 { color: #333; margin-top: 2em; }
                            .katex { font-size: 1em !important; }
                            .math-inline {
                                font-style: italic;
                                font-family: 'Times New Roman', serif;
                                color: #333;
                            }
                            .math-display {
                                display: block;
                                text-align: center;
                                margin: 1em 0;
                                font-style: italic;
                                font-family: 'Times New Roman', serif;
                                font-size: 1.2em;
                                color: #333;
                            }
                            @media print {
                                body { margin: 0; padding: 20px; }
                                @page { margin: 1in; }
                            }
                        </style>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
                    </head>
                    <body>${htmlOutput}</body>
                    </html>
                `;

                // Show in preview iframe and hide placeholder
                const previewFrame = document.getElementById('latex-pdf-preview');
                const placeholder = document.getElementById('latexPreviewPlaceholder');

                previewFrame.srcdoc = styledHtml;
                previewFrame.style.display = 'block';
                if (placeholder) placeholder.style.display = 'none';

                // Store HTML for print/download
                window.currentLatexHTML = styledHtml;
                window.currentLatexPDF = null; // Clear any existing PDF

                console.log('LaTeX compilation to HTML successful');
                if (!isAutoCompile) {
                    showToast('Document compiled successfully! Use "Print as PDF" from the preview.', 'success');
                } else {
                    updateCompileStatus('success');
                }
                katexRetryCount = 0; // Reset retry count on successful compilation

                // Enable the download button
                const downloadBtn = document.getElementById('downloadLatexPdfBtn');
                console.log('Enabling download button:', !!downloadBtn);
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.style.background = 'var(--color-primary-blue)';
                    downloadBtn.style.color = 'white';
                    downloadBtn.style.cursor = 'pointer';
                    downloadBtn.title = 'Download as PDF or HTML';
                    console.log('Download button enabled successfully');
                } else {
                    console.error('Download button not found!');
                }

            } catch (error) {
                console.error('LaTeX compilation error:', error);

                // Disable the download button on error
                const downloadBtn = document.getElementById('downloadLatexPdfBtn');
                if (downloadBtn) {
                    downloadBtn.disabled = true;
                    downloadBtn.style.background = 'var(--color-neutral-border)';
                    downloadBtn.style.color = 'var(--color-neutral-text)';
                    downloadBtn.style.cursor = 'not-allowed';
                    downloadBtn.title = 'Fix compilation errors to enable download';
                }

                // Show detailed error information
                let errorMessage = 'Compilation failed: ' + error.message;
                if (error.name === 'ParseError') {
                    errorMessage += '\n\nCheck your LaTeX syntax. Common issues:\n- Missing \\end{} commands\n- Unclosed braces {}\n- Unknown commands';
                }

                if (!isAutoCompile) {
                    showToast(errorMessage, 'error');
                } else {
                    updateCompileStatus('error');
                }
            } finally {
                // Only update button state for manual compiles
                if (!isAutoCompile && compileBtn) {
                    compileBtn.textContent = originalText;
                    compileBtn.disabled = false;
                }
            }
        }

        function downloadLatexPDF() {
            console.log('=== DOWNLOAD BUTTON CLICKED ===');
            console.log('currentLatexHTML exists:', !!window.currentLatexHTML);

            if (!window.currentLatexHTML) {
                showToast('Please compile the document first', 'error');
                return;
            }

            console.log('Opening download modal...');
            const modal = document.getElementById('latexDownloadModal');
            console.log('Modal element found:', !!modal);

            if (modal) {
                modal.style.display = 'flex';
                modal.style.zIndex = '15000';  // Ensure it's above LaTeX editor
                setupLatexDownloadModalEvents();
                console.log('Modal opened successfully');
                console.log('Modal z-index:', modal.style.zIndex);
                console.log('Modal display:', modal.style.display);
            } else {
                console.error('Download modal not found in DOM');
                showToast('Download modal not found', 'error');
            }
        }

        // Modal management functions
        function closeLatexDownloadModal() {
            document.getElementById('latexDownloadModal').style.display = 'none';
        }

        // Add keyboard and click support for modal (set up when modal opens)
        function setupLatexDownloadModalEvents() {
            console.log('Setting up modal events...');
            const modal = document.getElementById('latexDownloadModal');
            if (!modal) {
                console.error('Modal not found in setupLatexDownloadModalEvents');
                return;
            }

            // Keyboard support (Escape to close)
            const handleKeydown = function(event) {
                if (event.key === 'Escape' && modal.style.display === 'flex') {
                    closeLatexDownloadModal();
                    document.removeEventListener('keydown', handleKeydown);
                }
            };
            document.addEventListener('keydown', handleKeydown);

            // Click outside to close
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeLatexDownloadModal();
                }
            });
        }

        // Download option handlers
        function handlePDFDownload() {
            closeLatexDownloadModal();

            const previewFrame = document.getElementById('latex-pdf-preview');
            if (previewFrame && previewFrame.contentWindow) {
                try {
                    previewFrame.contentWindow.print();
                    showToast('Print dialog opened. Select "Save as PDF" as destination.', 'success');
                } catch (error) {
                    console.error('Print error:', error);
                    showToast('Unable to open print dialog. Try downloading as HTML instead.', 'error');
                }
            } else {
                showToast('Preview not ready. Please wait for compilation to complete.', 'error');
            }
        }

        function handleHTMLDownload() {
            closeLatexDownloadModal();

            const documents = getLatexDocuments();
            const latexDoc = documents.find(d => d.id === currentLatexDocumentId);
            const baseFilename = latexDoc ? latexDoc.name.replace(/[^a-z0-9]/gi, '_') : 'latex-document';

            try {
                const blob = new Blob([window.currentLatexHTML], { type: 'text/html;charset=utf-8' });
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `${baseFilename}.html`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

                showToast(`Downloaded: ${baseFilename}.html`, 'success');
            } catch (error) {
                console.error('HTML download error:', error);
                showToast('Download failed. Please try again.', 'error');
            }
        }

        function handleLatexSourceDownload() {
            closeLatexDownloadModal();

            if (!latexEditor || !currentLatexDocumentId) {
                showToast('No LaTeX document is currently open', 'error');
                return;
            }

            const documents = getLatexDocuments();
            const latexDoc = documents.find(d => d.id === currentLatexDocumentId);
            const baseFilename = latexDoc ? latexDoc.name.replace(/[^a-z0-9]/gi, '_') : 'latex-document';
            const latexSource = latexEditor.getValue();

            try {
                const blob = new Blob([latexSource], { type: 'text/plain;charset=utf-8' });
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `${baseFilename}.tex`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

                showToast(`Downloaded: ${baseFilename}.tex`, 'success');
            } catch (error) {
                console.error('LaTeX source download error:', error);
                showToast('Download failed. Please try again.', 'error');
            }
        }

        // Debug function to test Quill document editor
        window.testQuillEditor = function() {
            console.log('=== TESTING QUILL DOCUMENT EDITOR ===');
            console.log('1. Quill editor initialized:', !!documentQuillEditor);
            console.log('2. Quill script loaded:', typeof Quill !== 'undefined');
            console.log('3. Current editing document ID:', currentEditingDocumentId);

            if (typeof Quill === 'undefined') {
                console.error('❌ Quill not loaded - check CDN connection');
                return;
            }

            if (documentQuillEditor) {
                console.log('4. Editor container:', documentQuillEditor.container);
                console.log('5. Editor theme:', documentQuillEditor.theme);
                console.log('6. Current content length:', documentQuillEditor.getLength());
                console.log('✅ Quill editor is working');

                // Test inserting content
                const testContent = [
                    { insert: 'Welcome to Quill Document Editor!\n', attributes: { header: 1 } },
                    { insert: '\nThis is a ' },
                    { insert: 'robust', attributes: { bold: true } },
                    { insert: ' rich text editor with:\n\n' },
                    { insert: 'Bold and italic text\n', attributes: { list: 'bullet' } },
                    { insert: 'Headers and formatting\n', attributes: { list: 'bullet' } },
                    { insert: 'Auto-save functionality\n', attributes: { list: 'bullet' } },
                    { insert: 'Keyboard shortcuts (Ctrl+S)\n', attributes: { list: 'bullet' } },
                    { insert: '\nTest completed! ✨\n', attributes: { italic: true } }
                ];

                documentQuillEditor.setContents(testContent);
                console.log('✅ Sample content inserted successfully');
            } else {
                console.log('ℹ️ Editor not initialized yet - create or open a document to test');
            }
        };

        // Debug function to test LaTeX syntax highlighting
        window.testLatexSyntax = function() {
            console.log('=== TESTING LATEX SYNTAX HIGHLIGHTING ===');
            console.log('Language registered:', latexLanguageRegistered);
            console.log('Editor language:', latexEditor?.getModel()?.getLanguageId());
            console.log('Editor theme:', 'latex-dark');

            if (latexEditor) {
                // Insert sample LaTeX code to test highlighting
                const sampleCode = `% This is a comment
\\documentclass{article}
\\usepackage{amsmath}

\\begin{document}
\\title{Sample Document}
\\maketitle

\\section{Introduction}
This is \\textbf{bold} and \\textit{italic} text.

\\subsection{Math Examples}
Inline math: $E = mc^2$ and display math:
\\[
\\int_0^\\infty e^{-x} dx = 1
\\]

\\begin{equation}
\\sum_{i=1}^n i = \\frac{n(n+1)}{2}
\\end{equation}

\\begin{table}[h]
\\centering
\\begin{tabular}{|c|c|}
\\hline
Header 1 & Header 2 \\\\ \\hline
Data 1 & Data 2 \\\\ \\hline
\\end{tabular}
\\caption{Sample Table}
\\end{table}

\\end{document}`;

                latexEditor.setValue(sampleCode);
                console.log('✅ Sample LaTeX code inserted - check editor for syntax highlighting');
            } else {
                console.log('❌ LaTeX editor not initialized');
            }
        };

        // Debug function to test LaTeX backup integration
        window.testLatexBackup = function() {
            console.log('=== TESTING LATEX BACKUP INTEGRATION ===');
            const latexJson = localStorage.getItem(`user_latex_documents_${currentPersona}`);
            const latex = latexJson ? JSON.parse(latexJson) : [];
            console.log('Current LaTeX documents:', latex.length);
            latex.forEach((doc, index) => {
                console.log(`  ${index + 1}. ${doc.name} (ID: ${doc.id})`);
            });

            // Test if export would include LaTeX
            if (latex.length > 0) {
                console.log('✅ LaTeX documents exist - will be included in backup');
            } else {
                console.log('ℹ️ No LaTeX documents found - create some to test backup');
            }
        };

        // Debug function to test modal and download functionality
        window.testLatexDownload = function() {
            console.log('=== TESTING LATEX DOWNLOAD SYSTEM ===');
            console.log('1. Download button exists:', !!document.getElementById('downloadLatexPdfBtn'));
            console.log('2. Download modal exists:', !!document.getElementById('latexDownloadModal'));
            console.log('3. downloadLatexPDF function exists:', typeof downloadLatexPDF);
            console.log('4. currentLatexHTML exists:', !!window.currentLatexHTML);
            console.log('5. Current LaTeX document ID:', currentLatexDocumentId);

            // Try to open modal directly
            console.log('6. Attempting to open modal...');
            try {
                const modal = document.getElementById('latexDownloadModal');
                if (modal) {
                    modal.style.display = 'flex';
                    console.log('   Modal opened successfully');
                    setTimeout(() => {
                        modal.style.display = 'none';
                        console.log('   Modal closed after test');
                    }, 2000);
                } else {
                    console.error('   Modal not found');
                }
            } catch (error) {
                console.error('   Error opening modal:', error);
            }
        };

        // Default LaTeX Template
        function getDefaultLatexTemplate() {
            return `\\documentclass{article}
\\usepackage{amsmath,amsthm,amssymb}
\\usepackage{graphicx}
\\usepackage{geometry}
\\geometry{margin=1in}

\\title{Document Title}
\\author{Your Name}
\\date{\\today}

\\begin{document}

\\maketitle

\\section{Introduction}
Write your content here...

\\subsection{Example Subsection}
This is an example of a subsection with some math: $E = mc^2$

\\section{Conclusion}
Summarize your work here.

\\end{document}`;
        }

        // AltaCV Template for Professional CVs
        function getAltaCVTemplate(personalInfo = {}) {
            const name = personalInfo.name || 'Your Name';
            const email = personalInfo.email || 'your.email@example.com';
            const phone = personalInfo.phone || '+1 (555) 123-4567';
            const location = personalInfo.location || 'Your City, State';
            const linkedin = personalInfo.linkedin || 'linkedin.com/in/yourprofile';
            const website = personalInfo.website || 'yourwebsite.com';

            return `\\documentclass{altacv}

% Define colors for professional appearance
\\definecolor{VividPurple}{HTML}{3E0097}
\\definecolor{SlateGrey}{HTML}{2E2E2E}
\\definecolor{LightGrey}{HTML}{666666}
\\definecolor{DarkGrey}{HTML}{333333}
\\definecolor{AccentColor}{HTML}{8F0D0D}
\\definecolor{RuleColor}{HTML}{E7D192}

% Color scheme setup
\\colorlet{name}{DarkGrey}
\\colorlet{tagline}{AccentColor}
\\colorlet{heading}{SlateGrey}
\\colorlet{headingrule}{RuleColor}
\\colorlet{subheading}{AccentColor}
\\colorlet{accent}{AccentColor}
\\colorlet{emphasis}{DarkGrey}
\\colorlet{body}{LightGrey}

% Page layout
\\geometry{left=1.25cm,right=1.25cm,top=1.5cm,bottom=1.5cm,columnsep=1.2cm}
\\usepackage{paracol}

\\begin{document}
\\name{${name}}
\\tagline{Professional Title or Tagline}

% Contact information
\\personalinfo{%
    \\email{${email}}
    \\phone{${phone}}
    \\location{${location}}
    \\linkedin{${linkedin}}
    \\homepage{${website}}
}

\\makecvheader
\\AtBeginEnvironment{itemize}{\\small}

% Two column layout
\\columnratio{0.6}
\\begin{paracol}{2}

%% LEFT COLUMN %%
\\cvsection{Experience}

\\cvevent{Job Title}{Company Name}{Month 2023 -- Present}{City, State}
\\begin{itemize}
\\item Achievement or responsibility that demonstrates impact
\\item Quantifiable accomplishment with specific metrics
\\item Technical or leadership accomplishment relevant to target role
\\item Collaborative project or team contribution
\\end{itemize}

\\divider

\\cvevent{Previous Job Title}{Previous Company}{Month 2021 -- Month 2023}{City, State}
\\begin{itemize}
\\item Key accomplishment with measurable results
\\item Process improvement or efficiency gain
\\item Technology implementation or optimization
\\item Cross-functional collaboration or leadership
\\end{itemize}

\\cvsection{Projects}

\\cvachievement{\\faIcon{code}}{Project Name}{Brief description of personal or professional project showcasing relevant skills}

\\cvachievement{\\faIcon{chart-line}}{Data Analysis Project}{Description of analytical work, tools used, and business impact}

%% RIGHT COLUMN %%
\\switchcolumn

\\cvsection{Skills}

\\cvtag{Programming Language}
\\cvtag{Technology}
\\cvtag{Framework}
\\cvtag{Tool} \\\\
\\cvtag{Methodology}
\\cvtag{Platform}
\\cvtag{Certification}

\\medskip

\\cvskill{Primary Skill Area}{5}
\\cvskill{Secondary Skill Area}{4}
\\cvskill{Third Skill Area}{4}
\\cvskill{Learning Area}{3}

\\cvsection{Education}

\\cvevent{Degree Name}{University Name}{Graduation Year}{City, State}
\\begin{itemize}
\\item Relevant coursework or academic projects
\\item GPA (if strong), honors, or achievements
\\end{itemize}

\\cvsection{Certifications}

\\cvachievement{\\faIcon{certificate}}{Certification Name}{Issuing Organization, Date}
\\cvachievement{\\faIcon{award}}{Professional Credential}{Details and validity period}

\\end{paracol}

\\end{document}`;
        }

        // Function to create a new CV document with AltaCV template
        function createNewCVDocument(personalInfo = {}) {
            const newDoc = {
                id: Date.now(),
                name: 'New Professional CV',
                description: 'Professional CV created with AltaCV template',
                content: getAltaCVTemplate(personalInfo),
                tags: ['cv', 'resume', 'professional'],
                linkedType: '',
                linkedId: '',
                lastModified: new Date().toISOString(),
                // CV-specific fields
                type: 'cv',
                cvTemplate: 'altacv',
                personalInfo: personalInfo,
                sections: ['experience', 'projects', 'skills', 'education', 'certifications'],
                colorScheme: {
                    primary: '#8F0D0D',
                    heading: '#2E2E2E',
                    accent: '#E7D192',
                    text: '#666666'
                }
            };

            const documents = getLatexDocuments();
            documents.push(newDoc);
            saveLatexDocuments(documents);

            return newDoc;
        }

        // Document type detection and migration function
        function detectAndMigrateDocumentType(document) {
            // Don't modify documents that already have explicit type
            if (document.type && document.type !== 'latex') {
                return document;
            }

            const content = document.content || '';

            // Detect CV documents by content patterns
            const isCVDocument =
                content.includes('\\documentclass{altacv}') ||
                content.includes('\\documentclass{moderncv}') ||
                content.includes('\\cvevent') ||
                content.includes('\\cvskill') ||
                content.includes('\\cvsection') ||
                content.includes('\\cvtag') ||
                content.includes('\\makecvheader') ||
                (document.tags && document.tags.some(tag =>
                    tag.toLowerCase().includes('cv') ||
                    tag.toLowerCase().includes('resume')
                ));

            if (isCVDocument) {
                // Migrate to CV document
                document.type = 'cv';

                // Detect CV template type
                if (content.includes('\\documentclass{altacv}')) {
                    document.cvTemplate = 'altacv';
                } else if (content.includes('\\documentclass{moderncv}')) {
                    document.cvTemplate = 'moderncv';
                } else {
                    document.cvTemplate = 'custom';
                }

                // Extract basic personal info from CV content
                const personalInfo = {};

                // Extract name from \name{} command
                const nameMatch = content.match(/\\name\{([^}]+)\}/);
                if (nameMatch) personalInfo.name = nameMatch[1];

                // Extract email from \email{} command
                const emailMatch = content.match(/\\email\{([^}]+)\}/);
                if (emailMatch) personalInfo.email = emailMatch[1];

                // Extract phone from \phone{} command
                const phoneMatch = content.match(/\\phone\{([^}]+)\}/);
                if (phoneMatch) personalInfo.phone = phoneMatch[1];

                // Extract location from \location{} command
                const locationMatch = content.match(/\\location\{([^}]+)\}/);
                if (locationMatch) personalInfo.location = locationMatch[1];

                document.personalInfo = Object.keys(personalInfo).length > 0 ? personalInfo : null;

                // Detect sections from \cvsection{} commands
                const sectionMatches = content.match(/\\cvsection\{([^}]+)\}/g);
                if (sectionMatches) {
                    document.sections = sectionMatches.map(match => {
                        const sectionMatch = match.match(/\\cvsection\{([^}]+)\}/);
                        return sectionMatch ? sectionMatch[1].toLowerCase() : null;
                    }).filter(section => section);
                } else {
                    document.sections = ['experience', 'education', 'skills'];
                }

                // Extract color scheme from color definitions
                const colorScheme = {};
                const colorMatches = content.match(/\\definecolor\{([^}]+)\}\{HTML\}\{([^}]+)\}/g);
                if (colorMatches) {
                    colorMatches.forEach(colorDef => {
                        const colorMatch = colorDef.match(/\\definecolor\{([^}]+)\}\{HTML\}\{([^}]+)\}/);
                        if (colorMatch) {
                            const colorName = colorMatch[1];
                            const hexValue = colorMatch[2];
                            if (colorName.toLowerCase().includes('accent')) {
                                colorScheme.primary = `#${hexValue}`;
                            }
                        }
                    });
                }
                document.colorScheme = Object.keys(colorScheme).length > 0 ? colorScheme : null;

                // Add CV tags if not already present
                if (!document.tags) document.tags = [];
                if (!document.tags.includes('cv')) document.tags.push('cv');

                console.log('Migrated document to CV type:', document.name, document.cvTemplate);
            } else {
                // Ensure regular LaTeX documents have proper type
                document.type = 'latex';
            }

            return document;
        }

        // Enhanced getLatexDocuments function with type detection
        function getLatexDocuments() {
            const key = `user_latex_documents_${currentPersona}`;
            const stored = localStorage.getItem(key);
            let documents = stored ? JSON.parse(stored) : [];

            // Detect and migrate document types for existing documents
            let migrationNeeded = false;
            documents = documents.map(doc => {
                const originalType = doc.type;
                const migratedDoc = detectAndMigrateDocumentType(doc);
                if (migratedDoc.type !== originalType) {
                    migrationNeeded = true;
                }
                return migratedDoc;
            });

            // Save migrated documents back to storage
            if (migrationNeeded) {
                console.log('Document type migration performed, saving updated documents');
                localStorage.setItem(key, JSON.stringify(documents));
            }

            return documents;
        }

        // Utility function to show toast messages
        function showToast(message, type = 'info') {
            // Subtle toast implementation for autocompile context
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                padding: 8px 14px;
                background: ${type === 'success' ? 'rgba(22, 163, 74, 0.9)' : type === 'error' ? 'rgba(220, 38, 38, 0.9)' : 'rgba(0, 102, 204, 0.9)'};
                color: white;
                border-radius: 4px;
                font-family: var(--font-family-ui);
                font-size: 12px;
                font-weight: 500;
                z-index: 11000;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                backdrop-filter: blur(4px);
                opacity: 0.95;
                transition: opacity 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Shorter duration for less intrusive experience
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 1500); // Reduced from 3000ms to 1500ms
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Track page view with display mode for analytics
            trackPageViewWithDisplayMode();
        });
    </script>
</body>
</html>

